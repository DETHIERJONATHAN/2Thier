{
  "version": 3,
  "sources": ["../src/utils/crypto.ts", "../src/services/UniversalNotificationService.ts", "../src/services/RealTimeEmailNotificationService.ts", "../src/services/AutoMailSyncService.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/operation-interpreter.ts", "../src/api-server-clean.ts", "../src/routes/index.ts", "../src/routes/authRoutes.ts", "../src/lib/prisma.ts", "../src/controllers/authController.ts", "../src/routes/gmailRoutes.ts", "../src/middleware/auth.ts", "../src/prisma.ts", "../src/config.prod.ts", "../src/config.ts", "../src/google-auth/core/GoogleOAuthCore.ts", "../src/auth/googleConfig.ts", "../src/google-auth/core/GoogleAuthManager.ts", "../src/google-auth/services/GoogleCalendarService.ts", "../src/google-auth/services/GoogleGmailService.ts", "../src/google-auth/controllers/GmailController.ts", "../src/routes/misc.ts", "../src/middlewares/auth.ts", "../src/middlewares/impersonation.ts", "../src/routes/profile.ts", "../src/routes/modules.ts", "../src/routes/admin-modules.ts", "../src/middlewares/requireRole.ts", "../src/routes/icons.ts", "../src/routes/company.ts", "../src/routes/invitations.ts", "../src/services/EmailService.ts", "../src/routes/organizations.ts", "../src/routes/autoGoogleAuthRoutes.ts", "../src/routes/google-auth.ts", "../src/utils/googleTokenRefresh.ts", "../src/google-auth/routes/gmail.ts", "../src/security/securityLogger.ts", "../src/routes/google-scheduler.ts", "../src/services/GoogleTokenRefreshScheduler.ts", "../src/routes/google-tokens.ts", "../src/routes/googleWorkspace.ts", "../src/routes/blocks.ts", "../src/helpers/adaptBlockStructure.ts", "../src/routes/notifications.ts", "../src/routes/notificationSystemRoutes.ts", "../src/services/NotificationSystemService.ts", "../src/services/notificationSystemInit.ts", "../src/routes/settingsRoutes.ts", "../src/routes/leadsRoutes.ts", "../src/routes/rolesRoutes.ts", "../src/routes/usersRoutes.ts", "../src/routes/adminPasswordRoutes.ts", "../src/routes/services.ts", "../src/routes/permissions.ts", "../src/routes/admin.ts", "../src/routes/impersonate.ts", "../src/routes/calendar.ts", "../src/middlewares/impersonation.js", "../src/routes/clients.ts", "../src/routes/projects.ts", "../src/routes/emails.ts", "../src/services/GmailService.ts", "../src/services/AutoGoogleAuthService.ts", "../src/routes/gemini.ts", "../src/services/GoogleGeminiService.ts", "../src/routes/telnyx.ts", "../src/api/telnyx.ts", "../src/routes/quotes.ts", "../src/routes/google-drive.ts", "../src/routes/google-meet.ts", "../src/routes/analytics.ts", "../src/routes/ai.ts", "../src/routes/ai-code.ts", "../src/routes/fields.ts", "../src/routes/formulas.ts", "../src/routes/dependencies.ts", "../src/routes/validations.ts", "../src/services/validationService.ts", "../src/routes/api/formulas.ts", "../src/global-mock-formulas.ts", "../src/utils/formulaEvaluator.ts", "../src/routes/api/dependencies.ts", "../src/routes/sections.ts", "../src/routes/module-navigation.ts", "../src/routes/form-sections.ts", "../src/routes/fieldTypes.ts", "../src/routes/optionNodes.ts", "../src/api/advanced-select.js", "../src/services/AdvancedSelectService.js", "../src/config/fieldMapping.ts", "../src/api/dynamic-formulas.ts", "../src/services/DynamicFormulaEngine.ts", "../src/routes/dashboard.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/treebranchleaf-routes.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/formulaEngine.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/evaluation/orchestrator.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/shared/hierarchyRules.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/copy-capacity-formula.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/copy-capacity-condition.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/copy-capacity-table.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/copy-variable-with-capacities.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/copy-selector-tables.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/table-routes-new.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/TBL/routes/tbl-routes.ts", "../src/components/TreeBranchLeaf/tbl-bridge/routes/tbl-intelligence-routes.ts", "../src/components/TreeBranchLeaf/tbl-bridge/intelligence/TBLIntelligence.ts", "../src/components/TreeBranchLeaf/tbl-bridge/intelligence/TBLEvaluationEngine.ts", "../src/routes/tbl-capabilities.ts", "../src/routes/leadGeneration.ts", "../src/routes/marketplace-fixed.ts", "../src/routes/partner.ts", "../src/routes/publicForms.ts", "../src/routes/landingPages.ts", "../src/routes/campaignAnalytics.ts", "../src/routes/dispatch.ts", "../src/routes/integrationsStatus.ts", "../src/routes/integrations.ts", "../src/services/adPlatformService.ts", "../src/services/ecommerceService.ts", "../src/routes/publicLeads.ts", "../src/components/TreeBranchLeaf/tbl-bridge/routes/tbl-submission-evaluator.ts", "../src/services/calculatedValuesService.ts", "../src/controllers/calculatedValueController.ts", "../src/api/websites.ts", "../src/api/website-services.ts", "../src/api/website-projects.ts", "../src/api/website-testimonials.ts", "../src/api/website-sections.ts", "../src/api/website-themes.ts", "../src/api/contact-form.ts", "../src/api/image-upload.ts", "../src/api/ai-content.ts", "../src/services/aiContentService.ts", "../src/api/ai.ts", "../src/routes/ai-field-generator.ts", "../src/middleware/websiteDetection.ts", "../src/middleware/websiteRenderer.ts", "../src/security/securityMiddleware.ts", "../src/components/TreeBranchLeaf/treebranchleaf-new/api/sync-variable-hook.ts"],
  "sourcesContent": ["import * as crypto from 'crypto';\r\n\r\nconst ALGORITHM = 'aes-256-cbc';\r\nconst IV_LENGTH = 16; // Pour AES, c'est toujours 16\r\n\r\n// Validation paresseuse de la cl\u00E9: ne pas interrompre le chargement du serveur.\r\n// En production, l'utilisation d'`encrypt` sans cl\u00E9 valide l\u00E8vera une erreur explicite.\r\nconst ENCRYPTION_KEY = process.env.ENCRYPTION_KEY;\r\nlet key: Buffer | null = null;\r\n\r\n(() => {\r\n  try {\r\n    if (ENCRYPTION_KEY && Buffer.from(ENCRYPTION_KEY, 'utf8').length === 32) {\r\n      key = Buffer.from(ENCRYPTION_KEY, 'utf8');\r\n    } else {\r\n      console.warn('[CRYPTO] ENCRYPTION_KEY manquante ou invalide (32 chars requis). Le chiffrement est indisponible jusqu\\'\u00E0 configuration.');\r\n      key = null;\r\n    }\r\n  } catch (e) {\r\n    console.warn('[CRYPTO] Impossible d\\'initialiser la cl\u00E9 de chiffrement:', (e as Error)?.message);\r\n    key = null;\r\n  }\r\n})();\r\n\r\nexport function encrypt(text: string): string {\r\n  if (!key) {\r\n    // En prod: refuser explicitement pour \u00E9viter de chiffrer avec une cl\u00E9 inconnue\r\n    if (process.env.NODE_ENV === 'production') {\r\n      throw new Error('ENCRYPTION_KEY absente/invalide: chiffrement indisponible. Configurez une cl\u00E9 de 32 caract\u00E8res.');\r\n    }\r\n    // En dev: permettre de travailler en clair (optionnel). Ici on renvoie tel quel.\r\n    console.warn('[CRYPTO] encrypt() appel\u00E9 sans cl\u00E9 valide en environnement non-production. Retour en clair.');\r\n    return text;\r\n  }\r\n  const iv = crypto.randomBytes(IV_LENGTH);\r\n  const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\r\n  let encrypted = cipher.update(text, 'utf8', 'hex');\r\n  encrypted += cipher.final('hex');\r\n  return iv.toString('hex') + ':' + encrypted;\r\n}\r\n\r\nexport function decrypt(text: string): string {\r\n  try {\r\n    // Si le texte ne contient pas de ':', c'est probablement du texte non chiffr\u00E9\r\n    if (!text.includes(':')) {\r\n      return text;\r\n    }\r\n\r\n    if (!key) {\r\n      console.warn('[CRYPTO] decrypt() appel\u00E9 sans cl\u00E9 valide. Retour du texte original.');\r\n      return text;\r\n    }\r\n\r\n    const textParts = text.split(':');\r\n    if (textParts.length < 2) {\r\n      throw new Error('Invalid encrypted text format');\r\n    }\r\n    const ivHex = textParts.shift();\r\n    if (!ivHex) {\r\n      throw new Error('IV is missing');\r\n    }\r\n    const iv = Buffer.from(ivHex, 'hex');\r\n    const encryptedText = textParts.join(':');\r\n    const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\r\n    let decrypted = decipher.update(encryptedText, 'hex', 'utf8');\r\n    decrypted += decipher.final('utf8');\r\n    return decrypted;\r\n  } catch (error) {\r\n    console.error('Decryption failed:', error);\r\n    // Si le d\u00E9cryptage \u00E9choue, retourner le texte original (peut-\u00EAtre non chiffr\u00E9)\r\n    return text;\r\n  }\r\n}\r\n", "/**\r\n * \uD83C\uDF1F SERVICE DE NOTIFICATIONS UNIVERSEL CRM - GOOGLE WORKSPACE\r\n * \r\n * SYST\u00C8ME COMPLET ULTRA-PERFORMANT AVEC IA :\r\n * - \uD83D\uDCE7 Gmail temps r\u00E9el avec analyse IA\r\n * - \uD83D\uDCC5 Google Calendar notifications intelligentes\r\n * - \uD83D\uDC65 Nouveaux leads avec scoring IA\r\n * - \uD83D\uDCDE Appels manqu\u00E9s avec transcription IA\r\n * - \uD83D\uDCB0 Devis/factures avec analyse automatique\r\n * - \uD83C\uDFAF T\u00E2ches intelligentes avec priorit\u00E9s IA\r\n * - \uFFFD Alertes syst\u00E8me avec diagnostics IA\r\n * - \u26A1 Notifications temps r\u00E9el ultra-rapides\r\n * - \uD83E\uDDE0 Enrichissement IA de toutes les notifications\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { EventEmitter } from 'events';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83C\uDFAF TYPES DE NOTIFICATIONS SUPPORT\u00C9S\r\nexport type NotificationType = \r\n  | 'NEW_EMAIL'           // \uD83D\uDCE7 Nouveau email\r\n  | 'NEW_LEAD'            // \uD83D\uDC65 Nouveau lead\r\n  | 'MISSED_CALL'         // \uD83D\uDCDE Appel manqu\u00E9\r\n  | 'UPCOMING_MEETING'    // \uD83D\uDCC5 Rendez-vous proche\r\n  | 'NEW_QUOTE'           // \uD83D\uDCB0 Nouveau devis\r\n  | 'NEW_INVOICE'         // \uD83E\uDDFE Nouvelle facture\r\n  | 'OVERDUE_TASK'        // \u23F0 T\u00E2che en retard\r\n  | 'SYSTEM_ALERT'        // \uD83D\uDEA8 Alerte syst\u00E8me\r\n  | 'USER_MENTION'        // @\uFE0F\u20E3 Mention utilisateur\r\n  | 'PROJECT_UPDATE'      // \uD83D\uDCCB Mise \u00E0 jour projet\r\n  | 'PAYMENT_RECEIVED'    // \uD83D\uDCB3 Paiement re\u00E7u\r\n  | 'CONTRACT_EXPIRING';  // \uD83D\uDCC4 Contrat expirant\r\n\r\n// \uD83C\uDFD7\uFE0F INTERFACE DONN\u00C9ES NOTIFICATION\r\nexport interface NotificationData {\r\n  type: NotificationType;\r\n  title: string;\r\n  message: string;\r\n  userId?: string;\r\n  organizationId: string;\r\n  priority: 'low' | 'medium' | 'high' | 'urgent';\r\n  metadata?: Record<string, unknown>;\r\n  expiresAt?: Date;\r\n  actionUrl?: string;\r\n  tags?: string[];\r\n}\r\n\r\n// \uD83C\uDFA8 CONFIGURATION AFFICHAGE PAR TYPE\r\nconst NOTIFICATION_CONFIG = {\r\n  NEW_EMAIL: { icon: '\uD83D\uDCE7', color: '#1890ff', sound: 'email.wav' },\r\n  NEW_LEAD: { icon: '\uD83D\uDC65', color: '#52c41a', sound: 'success.wav' },\r\n  MISSED_CALL: { icon: '\uD83D\uDCDE', color: '#fa8c16', sound: 'alert.wav' },\r\n  UPCOMING_MEETING: { icon: '\uD83D\uDCC5', color: '#722ed1', sound: 'reminder.wav' },\r\n  NEW_QUOTE: { icon: '\uD83D\uDCB0', color: '#13c2c2', sound: 'cash.wav' },\r\n  NEW_INVOICE: { icon: '\uD83E\uDDFE', color: '#eb2f96', sound: 'invoice.wav' },\r\n  OVERDUE_TASK: { icon: '\u23F0', color: '#f5222d', sound: 'urgent.wav' },\r\n  SYSTEM_ALERT: { icon: '\uD83D\uDEA8', color: '#ff4d4f', sound: 'system.wav' },\r\n  USER_MENTION: { icon: '@\uFE0F\u20E3', color: '#1890ff', sound: 'mention.wav' },\r\n  PROJECT_UPDATE: { icon: '\uD83D\uDCCB', color: '#52c41a', sound: 'update.wav' },\r\n  PAYMENT_RECEIVED: { icon: '\uD83D\uDCB3', color: '#52c41a', sound: 'payment.wav' },\r\n  CONTRACT_EXPIRING: { icon: '\uD83D\uDCC4', color: '#fa8c16', sound: 'warning.wav' }\r\n};\r\n\r\nexport class UniversalNotificationService extends EventEmitter {\r\n  private static instance: UniversalNotificationService;\r\n  private isRunning = false;\r\n  private checkInterval?: NodeJS.Timeout;\r\n\r\n  private constructor() {\r\n    super();\r\n  }\r\n\r\n  static getInstance(): UniversalNotificationService {\r\n    if (!this.instance) {\r\n      this.instance = new UniversalNotificationService();\r\n    }\r\n    return this.instance;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDE80 D\u00C9MARRER LE SERVICE UNIVERSEL\r\n   */\r\n  start(): void {\r\n    if (this.isRunning) {\r\n      console.log('\u26A0\uFE0F [UniversalNotification] Service d\u00E9j\u00E0 en cours...');\r\n      return;\r\n    }\r\n\r\n    console.log('\uD83C\uDF1F [UniversalNotification] D\u00E9marrage du service UNIVERSEL de notifications...');\r\n    this.isRunning = true;\r\n\r\n    // D\u00E9marrer la v\u00E9rification p\u00E9riodique de tous les types d'\u00E9v\u00E9nements\r\n    this.startPeriodicChecks();\r\n\r\n    // \u00C9mettre l'\u00E9v\u00E9nement de d\u00E9marrage\r\n    this.emit('service-started');\r\n    console.log('\u2705 [UniversalNotification] Service universel d\u00E9marr\u00E9 avec succ\u00E8s');\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDED1 ARR\u00CATER LE SERVICE\r\n   */\r\n  stop(): void {\r\n    console.log('\uD83D\uDED1 [UniversalNotification] Arr\u00EAt du service...');\r\n    \r\n    if (this.checkInterval) {\r\n      clearInterval(this.checkInterval);\r\n    }\r\n    \r\n    this.isRunning = false;\r\n    this.emit('service-stopped');\r\n    console.log('\u2705 [UniversalNotification] Service arr\u00EAt\u00E9');\r\n  }\r\n\r\n  /**\r\n   * \uFFFD OBTENIR L'\u00C9TAT COURANT DU SERVICE\r\n   */\r\n  getStatus(): {\r\n    isRunning: boolean;\r\n    checksActive: boolean;\r\n    activeListeners: number;\r\n  } {\r\n    return {\r\n      isRunning: this.isRunning,\r\n      checksActive: Boolean(this.checkInterval),\r\n      activeListeners: this.listenerCount('notification-created')\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uFFFD\uD83D\uDD14 CR\u00C9ER UNE NOTIFICATION UNIVERSELLE\r\n   */\r\n  async createNotification(data: NotificationData): Promise<void> {\r\n    try {\r\n      const config = NOTIFICATION_CONFIG[data.type];\r\n      \r\n      console.log(`\uD83D\uDD14 [UniversalNotification] Cr\u00E9ation notification: ${data.type} - ${data.title}`);\r\n\r\n      // Cr\u00E9er en base de donn\u00E9es\r\n      const notification = await prisma.notification.create({\r\n        data: {\r\n          organizationId: data.organizationId,\r\n          userId: data.userId,\r\n          type: data.type === 'NEW_EMAIL' ? 'NEW_MAIL_RECEIVED' : data.type,\r\n          data: {\r\n            title: data.title,\r\n            message: data.message,\r\n            priority: data.priority,\r\n            icon: config.icon,\r\n            color: config.color,\r\n            sound: config.sound,\r\n            actionUrl: data.actionUrl,\r\n            tags: data.tags,\r\n            timestamp: new Date().toISOString(),\r\n            metadata: data.metadata\r\n          },\r\n          status: 'PENDING',\r\n          expiresAt: data.expiresAt\r\n        }\r\n      });\r\n\r\n      // \u00C9mettre l'\u00E9v\u00E9nement en temps r\u00E9el\r\n      this.emit('notification-created', {\r\n        id: notification.id,\r\n        type: data.type,\r\n        title: data.title,\r\n        message: data.message,\r\n        userId: data.userId,\r\n        organizationId: data.organizationId,\r\n        priority: data.priority,\r\n        config\r\n      });\r\n\r\n      console.log(`\u2705 [UniversalNotification] Notification cr\u00E9\u00E9e: ${notification.id}`);\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [UniversalNotification] Erreur cr\u00E9ation notification:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCE7 NOTIFICATION EMAIL SP\u00C9CIALIS\u00C9E\r\n   */\r\n  async notifyNewEmail(emailData: {\r\n    emailId: string;\r\n    from: string;\r\n    subject: string;\r\n    userId: string;\r\n    organizationId: string;\r\n    summary?: string;\r\n    priority?: NotificationData['priority'];\r\n    metadata?: Record<string, unknown>;\r\n    actionUrl?: string;\r\n    tags?: string[];\r\n  }): Promise<void> {\r\n    await this.createNotification({\r\n      type: 'NEW_EMAIL',\r\n      title: 'Nouveau message re\u00E7u',\r\n      message: emailData.summary ?? `De: ${emailData.from.substring(0, 30)}${emailData.from.length > 30 ? '...' : ''}`,\r\n      userId: emailData.userId,\r\n      organizationId: emailData.organizationId,\r\n      priority: emailData.priority ?? 'medium',\r\n      metadata: {\r\n        emailId: emailData.emailId,\r\n        from: emailData.from,\r\n        subject: emailData.subject,\r\n        ...emailData.metadata\r\n      },\r\n      actionUrl: emailData.actionUrl ?? `/emails/${emailData.emailId}`,\r\n      tags: emailData.tags ?? ['email', 'inbox']\r\n    });\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDC65 NOTIFICATION NOUVEAU LEAD\r\n   */\r\n  async notifyNewLead(leadData: {\r\n    leadId: string;\r\n    name: string;\r\n    email?: string;\r\n    phone?: string;\r\n    source?: string;\r\n    userId?: string;\r\n    organizationId: string;\r\n  }): Promise<void> {\r\n    await this.createNotification({\r\n      type: 'NEW_LEAD',\r\n      title: 'Nouveau prospect',\r\n      message: `${leadData.name}${leadData.source ? ` via ${leadData.source}` : ''}`,\r\n      userId: leadData.userId,\r\n      organizationId: leadData.organizationId,\r\n      priority: 'high',\r\n      metadata: {\r\n        leadId: leadData.leadId,\r\n        name: leadData.name,\r\n        email: leadData.email,\r\n        phone: leadData.phone,\r\n        source: leadData.source\r\n      },\r\n      actionUrl: `/leads/${leadData.leadId}`,\r\n      tags: ['lead', 'prospect', 'new']\r\n    });\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCDE NOTIFICATION APPEL MANQU\u00C9\r\n   */\r\n  async notifyMissedCall(callData: {\r\n    callId?: string;\r\n    from: string;\r\n    duration?: number;\r\n    userId?: string;\r\n    organizationId: string;\r\n  }): Promise<void> {\r\n    await this.createNotification({\r\n      type: 'MISSED_CALL',\r\n      title: 'Appel manqu\u00E9',\r\n      message: `Appel de ${callData.from}`,\r\n      userId: callData.userId,\r\n      organizationId: callData.organizationId,\r\n      priority: 'high',\r\n      metadata: {\r\n        callId: callData.callId,\r\n        from: callData.from,\r\n        duration: callData.duration\r\n      },\r\n      actionUrl: callData.callId ? `/calls/${callData.callId}` : '/calls',\r\n      tags: ['call', 'missed', 'urgent']\r\n    });\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCC5 NOTIFICATION RENDEZ-VOUS PROCHE\r\n   */\r\n  async notifyUpcomingMeeting(meetingData: {\r\n    meetingId: string;\r\n    title: string;\r\n    startTime: Date;\r\n    attendees?: string[];\r\n    userId?: string;\r\n    organizationId: string;\r\n  }): Promise<void> {\r\n    const timeUntil = Math.round((meetingData.startTime.getTime() - Date.now()) / (1000 * 60));\r\n    \r\n    await this.createNotification({\r\n      type: 'UPCOMING_MEETING',\r\n      title: 'Rendez-vous dans 15 minutes',\r\n      message: `${meetingData.title} dans ${timeUntil} min`,\r\n      userId: meetingData.userId,\r\n      organizationId: meetingData.organizationId,\r\n      priority: 'high',\r\n      metadata: {\r\n        meetingId: meetingData.meetingId,\r\n        title: meetingData.title,\r\n        startTime: meetingData.startTime,\r\n        attendees: meetingData.attendees,\r\n        timeUntil\r\n      },\r\n      actionUrl: `/calendar/${meetingData.meetingId}`,\r\n      tags: ['meeting', 'calendar', 'reminder'],\r\n      expiresAt: meetingData.startTime\r\n    });\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCB0 NOTIFICATION NOUVEAU DEVIS\r\n   */\r\n  async notifyNewQuote(quoteData: {\r\n    quoteId: string;\r\n    clientName: string;\r\n    amount: number;\r\n    currency?: string;\r\n    userId?: string;\r\n    organizationId: string;\r\n  }): Promise<void> {\r\n    await this.createNotification({\r\n      type: 'NEW_QUOTE',\r\n      title: 'Nouveau devis cr\u00E9\u00E9',\r\n      message: `${quoteData.clientName} - ${quoteData.amount}${quoteData.currency || '\u20AC'}`,\r\n      userId: quoteData.userId,\r\n      organizationId: quoteData.organizationId,\r\n      priority: 'medium',\r\n      metadata: {\r\n        quoteId: quoteData.quoteId,\r\n        clientName: quoteData.clientName,\r\n        amount: quoteData.amount,\r\n        currency: quoteData.currency\r\n      },\r\n      actionUrl: `/quotes/${quoteData.quoteId}`,\r\n      tags: ['quote', 'billing', 'financial']\r\n    });\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD04 V\u00C9RIFICATIONS P\u00C9RIODIQUES (toutes les 2 minutes)\r\n   */\r\n  private startPeriodicChecks(): void {\r\n    console.log('\uD83D\uDD04 [UniversalNotification] D\u00E9marrage v\u00E9rifications p\u00E9riodiques...');\r\n    \r\n    this.checkInterval = setInterval(async () => {\r\n      try {\r\n        await this.checkForUpcomingMeetings();\r\n        await this.checkForOverdueTasks();\r\n        await this.checkForExpiringContracts();\r\n        await this.cleanExpiredNotifications();\r\n      } catch (error) {\r\n        console.error('\u274C [UniversalNotification] Erreur v\u00E9rification p\u00E9riodique:', error);\r\n      }\r\n    }, 2 * 60 * 1000); // 2 minutes\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCC5 V\u00C9RIFIER LES RENDEZ-VOUS PROCHES\r\n   */\r\n  private async checkForUpcomingMeetings(): Promise<void> {\r\n    const now = new Date();\r\n    const fifteenMinutesFromNow = new Date(now.getTime() + 15 * 60 * 1000);\r\n\r\n    // Logique \u00E0 impl\u00E9menter selon votre mod\u00E8le de donn\u00E9es calendrier\r\n    // Exemple: r\u00E9cup\u00E9rer les meetings dans les 15 prochaines minutes\r\n    console.log(\r\n      `\uD83D\uDCC5 [UniversalNotification] V\u00E9rification des rendez-vous entre ${now.toISOString()} et ${fifteenMinutesFromNow.toISOString()}...`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * \u23F0 V\u00C9RIFIER LES T\u00C2CHES EN RETARD\r\n   */\r\n  private async checkForOverdueTasks(): Promise<void> {\r\n    // Logique \u00E0 impl\u00E9menter selon votre mod\u00E8le de t\u00E2ches\r\n    console.log('\u23F0 [UniversalNotification] V\u00E9rification des t\u00E2ches en retard...');\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCC4 V\u00C9RIFIER LES CONTRATS EXPIRANTS\r\n   */\r\n  private async checkForExpiringContracts(): Promise<void> {\r\n    // Logique \u00E0 impl\u00E9menter selon votre mod\u00E8le de contrats\r\n    console.log('\uD83D\uDCC4 [UniversalNotification] V\u00E9rification des contrats expirants...');\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDF9 NETTOYER LES NOTIFICATIONS EXPIR\u00C9ES\r\n   */\r\n  private async cleanExpiredNotifications(): Promise<void> {\r\n    try {\r\n      const result = await prisma.notification.deleteMany({\r\n        where: {\r\n          expiresAt: {\r\n            lt: new Date()\r\n          }\r\n        }\r\n      });\r\n\r\n      if (result.count > 0) {\r\n        console.log(`\uD83E\uDDF9 [UniversalNotification] ${result.count} notifications expir\u00E9es supprim\u00E9es`);\r\n      }\r\n    } catch (error) {\r\n      console.error('\u274C [UniversalNotification] Erreur nettoyage notifications expir\u00E9es:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA OBTENIR LES STATISTIQUES\r\n   */\r\n  async getStats(organizationId: string): Promise<{\r\n    total: number;\r\n    byType: Record<string, number>;\r\n    byStatus: Record<string, number>;\r\n  }> {\r\n    try {\r\n      const stats = await prisma.notification.groupBy({\r\n        by: ['type', 'status'],\r\n        where: {\r\n          organizationId,\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 24 * 60 * 60 * 1000) // Derni\u00E8res 24h\r\n          }\r\n        },\r\n        _count: true\r\n      });\r\n\r\n      return {\r\n        total: stats.reduce((sum, s) => sum + s._count, 0),\r\n        byType: stats.reduce((acc, s) => {\r\n          acc[s.type] = (acc[s.type] || 0) + s._count;\r\n          return acc;\r\n        }, {} as Record<string, number>),\r\n        byStatus: stats.reduce((acc, s) => {\r\n          acc[s.status] = (acc[s.status] || 0) + s._count;\r\n          return acc;\r\n        }, {} as Record<string, number>)\r\n      };\r\n    } catch (error) {\r\n      console.error('\u274C [UniversalNotification] Erreur stats:', error);\r\n      return { total: 0, byType: {}, byStatus: {} };\r\n    }\r\n  }\r\n}\r\n\r\nexport default UniversalNotificationService;\r\n", "/**\r\n * \uD83D\uDE80 SERVICE DE NOTIFICATIONS EMAIL EN TEMPS R\u00C9EL\r\n * \r\n * SYST\u00C8ME HYBRIDE OPTIMIS\u00C9 :\r\n * 1. \uD83D\uDCE7 Int\u00E9gration directe avec AutoMailSyncService (temps r\u00E9el)\r\n * 2. \uD83D\uDD04 V\u00E9rification p\u00E9riodique de s\u00E9curit\u00E9 (toutes les 5 minutes)\r\n * 3. \uD83D\uDCA1 Notifications intelligentes et instantan\u00E9es\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { EventEmitter } from 'events';\r\nimport UniversalNotificationService from './UniversalNotificationService.js';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface EmailNotificationData {\r\n  emailId: string;\r\n  from: string;\r\n  subject: string;\r\n  folder: string;\r\n  receivedAt: Date;\r\n  userId: string;\r\n  organizationId: string;\r\n}\r\n\r\nexport class RealTimeEmailNotificationService extends EventEmitter {\r\n  private static instance: RealTimeEmailNotificationService;\r\n  private backupCheckInterval?: NodeJS.Timeout;\r\n  private isRunning = false;\r\n\r\n  private constructor() {\r\n    super();\r\n  }\r\n\r\n  static getInstance(): RealTimeEmailNotificationService {\r\n    if (!this.instance) {\r\n      this.instance = new RealTimeEmailNotificationService();\r\n    }\r\n    return this.instance;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDE80 D\u00C9MARRER LE SERVICE TEMPS R\u00C9EL\r\n   */\r\n  start(): void {\r\n    if (this.isRunning) {\r\n      console.log('\u26A0\uFE0F [RealTimeEmailNotification] Service d\u00E9j\u00E0 en cours...');\r\n      return;\r\n    }\r\n\r\n    console.log('\uD83D\uDE80 [RealTimeEmailNotification] D\u00E9marrage du service temps r\u00E9el...');\r\n    this.isRunning = true;\r\n\r\n    // 1. \uD83C\uDFAF \u00C9COUTER LES \u00C9V\u00C9NEMENTS DE SYNCHRONISATION EMAIL\r\n    this.setupEmailSyncListener();\r\n\r\n    // 2. \uD83D\uDD04 V\u00C9RIFICATION DE S\u00C9CURIT\u00C9 toutes les 5 minutes\r\n    this.startBackupCheck();\r\n\r\n    console.log('\u2705 [RealTimeEmailNotification] Service temps r\u00E9el d\u00E9marr\u00E9 !');\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAF \u00C9COUTER LES NOUVEAUX EMAILS EN TEMPS R\u00C9EL\r\n   */\r\n  private setupEmailSyncListener(): void {\r\n    console.log('\uD83C\uDFA7 [RealTimeEmailNotification] Configuration de l\\'\u00E9coute temps r\u00E9el...');\r\n    \r\n    // \u00C9couter les \u00E9v\u00E9nements de nouveaux emails depuis AutoMailSyncService\r\n    this.on('newEmailReceived', this.handleNewEmailReceived.bind(this));\r\n    \r\n    console.log('\u2705 [RealTimeEmailNotification] \u00C9coute temps r\u00E9el configur\u00E9e');\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCE7 TRAITEMENT IMM\u00C9DIAT D'UN NOUVEL EMAIL\r\n   */\r\n  private async handleNewEmailReceived(emailData: EmailNotificationData): Promise<void> {\r\n    try {\r\n      console.log(`\u26A1 [RealTimeEmailNotification] NOUVEL EMAIL D\u00C9TECT\u00C9 - Traitement imm\u00E9diat !`);\r\n      console.log(`\uD83D\uDCE7 De: ${emailData.from}, Sujet: ${emailData.subject}`);\r\n\r\n      // V\u00E9rifier si ce n'est pas un spam/brouillon/envoy\u00E9\r\n      if (this.shouldIgnoreEmail(emailData)) {\r\n        console.log(`\uD83D\uDEAB [RealTimeEmailNotification] Email ignor\u00E9: ${emailData.folder}`);\r\n        return;\r\n      }\r\n\r\n      // Cr\u00E9er la notification IMM\u00C9DIATEMENT\r\n      await this.createInstantNotification(emailData);\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [RealTimeEmailNotification] Erreur lors du traitement temps r\u00E9el:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD14 CR\u00C9ER UNE NOTIFICATION INSTANTAN\u00C9E\r\n   */\r\n  private async createInstantNotification(emailData: EmailNotificationData): Promise<void> {\r\n    try {\r\n      // \uD83C\uDF1F NOUVELLE APPROCHE : Utiliser UniversalNotificationService\r\n      const universalService = UniversalNotificationService.getInstance();\r\n      \r\n      await universalService.notifyNewEmail({\r\n        emailId: emailData.emailId,\r\n        from: emailData.from,\r\n        subject: emailData.subject,\r\n        userId: emailData.userId,\r\n        organizationId: emailData.organizationId\r\n      });\r\n      \r\n      console.log(`\u2705 [RealTimeEmailNotification] Notification UNIVERSELLE cr\u00E9\u00E9e pour: ${emailData.subject}`);\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [RealTimeEmailNotification] Erreur notification instantan\u00E9e:', error);\r\n    }\r\n  }  /**\r\n   * \uD83D\uDD04 V\u00C9RIFICATION DE S\u00C9CURIT\u00C9 (toutes les 5 minutes)\r\n   * En cas o\u00F9 le temps r\u00E9el rate quelque chose\r\n   */\r\n  private startBackupCheck(): void {\r\n    console.log('\uD83D\uDEE1\uFE0F [RealTimeEmailNotification] D\u00E9marrage v\u00E9rification de s\u00E9curit\u00E9...');\r\n    \r\n    this.backupCheckInterval = setInterval(async () => {\r\n      console.log('\uD83D\uDD0D [RealTimeEmailNotification] V\u00E9rification de s\u00E9curit\u00E9...');\r\n      await this.performBackupCheck();\r\n    }, 5 * 60 * 1000); // 5 minutes\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD0D V\u00C9RIFICATION DE S\u00C9CURIT\u00C9 - RATTRAPER LES EMAILS MANQU\u00C9S\r\n   * M\u00E9thode publique pour d\u00E9clencher manuellement une v\u00E9rification\r\n   */\r\n  async performBackupCheck(): Promise<void> {\r\n    try {\r\n      // Chercher les emails des 10 derni\u00E8res minutes sans notification\r\n      const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);\r\n      \r\n      const usersWithMail = await prisma.emailAccount.findMany({\r\n        where: {\r\n          isActive: true,\r\n          encryptedPassword: { not: null }\r\n        },\r\n        select: { \r\n          userId: true\r\n        },\r\n        take: 10 // Limite pour la s\u00E9curit\u00E9\r\n      });\r\n\r\n      for (const emailAccount of usersWithMail) {\r\n        // R\u00E9cup\u00E9rer l'organisation de l'utilisateur\r\n        const userOrg = await prisma.userOrganization.findFirst({\r\n          where: { userId: emailAccount.userId },\r\n          select: { organizationId: true }\r\n        });\r\n        \r\n        if (!userOrg) continue;\r\n        const organizationId = userOrg.organizationId;\r\n\r\n        // Chercher les emails r\u00E9cents sans notification\r\n        const recentEmails = await prisma.email.findMany({\r\n          where: {\r\n            userId: emailAccount.userId,\r\n            createdAt: { gte: tenMinutesAgo },\r\n            folder: { in: ['INBOX', 'inbox'] },\r\n            // V\u00E9rifier qu'il n'y a pas d\u00E9j\u00E0 une notification\r\n            NOT: {\r\n              id: {\r\n                in: await prisma.notification.findMany({\r\n                  where: {\r\n                    userId: emailAccount.userId,\r\n                    type: 'NEW_MAIL_RECEIVED',\r\n                    createdAt: { gte: tenMinutesAgo }\r\n                  },\r\n                  select: { id: true }\r\n                }).then(notifications => notifications.map(n => n.id))\r\n              }\r\n            }\r\n          },\r\n          orderBy: { createdAt: 'desc' },\r\n          take: 5\r\n        });\r\n\r\n        // Cr\u00E9er les notifications manqu\u00E9es\r\n        for (const email of recentEmails) {\r\n          const universalService = UniversalNotificationService.getInstance();\r\n          \r\n          await universalService.notifyNewEmail({\r\n            emailId: email.id,\r\n            from: email.from,\r\n            subject: email.subject,\r\n            userId: emailAccount.userId,\r\n            organizationId\r\n          });\r\n        }\r\n      }\r\n\r\n      console.log('\u2705 [RealTimeEmailNotification] V\u00E9rification de s\u00E9curit\u00E9 termin\u00E9e');\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [RealTimeEmailNotification] Erreur v\u00E9rification de s\u00E9curit\u00E9:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDEAB FILTRER LES EMAILS \u00C0 IGNORER\r\n   */\r\n  private shouldIgnoreEmail(emailData: EmailNotificationData): boolean {\r\n    const ignoredFolders = [\r\n      'SPAM', 'spam', 'Spam',\r\n      'JUNK', 'junk', 'Junk',\r\n      'DRAFTS', 'drafts', 'Drafts', 'Brouillons',\r\n      'SENT', 'sent', 'Sent', 'Envoy\u00E9s'\r\n    ];\r\n    \r\n    return ignoredFolders.includes(emailData.folder);\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCE7 M\u00C9THODE PUBLIQUE POUR SIGNALER UN NOUVEL EMAIL\r\n   * \u00C0 appeler depuis AutoMailSyncService\r\n   */\r\n  notifyNewEmail(emailData: EmailNotificationData): void {\r\n    this.emit('newEmailReceived', emailData);\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDED1 ARR\u00CATER LE SERVICE\r\n   */\r\n  stop(): void {\r\n    if (!this.isRunning) return;\r\n\r\n    console.log('\uD83D\uDED1 [RealTimeEmailNotification] Arr\u00EAt du service...');\r\n    \r\n    if (this.backupCheckInterval) {\r\n      clearInterval(this.backupCheckInterval);\r\n    }\r\n    \r\n    this.removeAllListeners();\r\n    this.isRunning = false;\r\n    \r\n    console.log('\u2705 [RealTimeEmailNotification] Service arr\u00EAt\u00E9');\r\n  }\r\n\r\n  /**\r\n   * \u2702\uFE0F UTILITAIRE POUR TRONQUER LES CHA\u00CENES\r\n   */\r\n  private truncateString(str: string, maxLength: number): string {\r\n    if (str.length <= maxLength) return str;\r\n    return str.substring(0, maxLength - 3) + '...';\r\n  }\r\n}\r\n\r\nexport default RealTimeEmailNotificationService;\r\n", "import { PrismaClient } from '@prisma/client';\r\nimport { EventEmitter } from 'events';\r\nimport imapSimple from 'imap-simple';\r\nimport { decrypt } from '../utils/crypto.js';\r\nimport RealTimeEmailNotificationService from './RealTimeEmailNotificationService.js';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface SyncResult {\r\n  userId: string;\r\n  newEmails: number;\r\n  updatedEmails: number;\r\n  totalEmails: number;\r\n}\r\n\r\n// Fonction pour d\u00E9coder les en-t\u00EAtes MIME encod\u00E9s\r\nfunction decodeMimeHeader(header: string): string {\r\n  if (!header) return header;\r\n  \r\n  // D\u00E9coder les en-t\u00EAtes MIME-encod\u00E9s (=?charset?encoding?encoded-text?=)\r\n  const mimePattern = /=\\?([^?]+)\\?([QqBb])\\?([^?]*)\\?=/g;\r\n  \r\n  return header.replace(mimePattern, (match, charset, encoding, encodedText) => {\r\n    try {\r\n      charset = charset.toLowerCase();\r\n      encoding = encoding.toUpperCase();\r\n      \r\n      if (encoding === 'Q' || encoding === 'q') {\r\n        // Quoted-printable\r\n        let decoded = encodedText.replace(/_/g, ' ');\r\n        decoded = decoded.replace(/=([0-9A-F]{2})/gi, (_, hex) => {\r\n          return String.fromCharCode(parseInt(hex, 16));\r\n        });\r\n        return decoded;\r\n      } else if (encoding === 'B' || encoding === 'b') {\r\n        // Base64\r\n        return Buffer.from(encodedText, 'base64').toString('utf8');\r\n      }\r\n      \r\n      return encodedText;\r\n    } catch (error) {\r\n      console.warn('Erreur de d\u00E9codage MIME:', error);\r\n      return match; // Retourner le texte original en cas d'erreur\r\n    }\r\n  });\r\n}\r\n\r\n// Fonction pour corriger automatiquement l'encodage UTF-8 mal interpr\u00E9t\u00E9\r\nfunction fixUtf8Encoding(text: string): string {\r\n  if (!text) return text;\r\n  \r\n  const utf8Fixes = {\r\n    '\u00C3\u00A9': '\u00E9',\r\n    '\u00C3\u00A8': '\u00E8',\r\n    '\u00C3 ': '\u00E0',\r\n    '\u00C3\u00A7': '\u00E7',\r\n    '\u00C3\u00A2': '\u00E2',\r\n    '\u00C3\u00B4': '\u00F4',\r\n    '\u00C3\u00B9': '\u00F9',\r\n    '\u00C3\u00BB': '\u00FB',\r\n    '\u00C3\u00AE': '\u00EE',\r\n    '\u00C3\u00AB': '\u00EB',\r\n    '\u00C3\u00AF': '\u00EF',\r\n    '\u00C3\u00B1': '\u00F1',\r\n    '\u00C3\u00AA': '\u00EA',\r\n    '\u00C3\u00BC': '\u00FC',\r\n    '\u00C2 ': ' ', // Espace mal encod\u00E9\r\n    '\u00C2': '', // Caract\u00E8res r\u00E9siduels\r\n  };\r\n\r\n  let fixedText = text;\r\n  for (const [bad, good] of Object.entries(utf8Fixes)) {\r\n    fixedText = fixedText.replace(new RegExp(bad, 'g'), good);\r\n  }\r\n\r\n  return fixedText;\r\n}\r\n\r\nclass AutoMailSyncService extends EventEmitter {\r\n  public isRunning = false;\r\n  private syncInterval: NodeJS.Timeout | null = null;\r\n  private syncFrequency = 60000; // \uD83D\uDE80 CHANG\u00C9 : 1 minute au lieu de 10 (plus r\u00E9actif pour notifications)\r\n  private maxRetries = 3; // Nombre maximum de tentatives en cas d'erreur\r\n  private retryDelay = 5000; // D\u00E9lai entre les tentatives (5 secondes)\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  start() {\r\n    if (this.isRunning) {\r\n      console.log('\uD83D\uDD04 [AUTO-SYNC] Service d\u00E9j\u00E0 en cours d\\'ex\u00E9cution');\r\n      return;\r\n    }\r\n\r\n    this.isRunning = true;\r\n    console.log('\uD83D\uDE80 [AUTO-SYNC] D\u00E9marrage du service de synchronisation automatique (toutes les 1 minute - TEMPS R\u00C9EL)');\r\n\r\n    // Synchronisation imm\u00E9diate avec retry\r\n    this.performSyncWithRetry();\r\n\r\n    // Puis toutes les 1 minute avec retry\r\n    this.syncInterval = setInterval(() => {\r\n      this.performSyncWithRetry();\r\n    }, this.syncFrequency);\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDE80 NOUVELLE M\u00C9THODE : Synchroniser un utilisateur sp\u00E9cifique imm\u00E9diatement\r\n   */\r\n  async syncForUser(userId: string): Promise<SyncResult | null> {\r\n    try {\r\n      console.log(`\uD83C\uDFAF [AUTO-SYNC] Synchronisation manuelle pour l'utilisateur: ${userId}`);\r\n      \r\n      // R\u00E9cup\u00E9rer les param\u00E8tres mail de cet utilisateur\r\n      const emailAccount = await prisma.emailAccount.findFirst({\r\n        where: { \r\n          userId,\r\n          isActive: true \r\n        }\r\n      });\r\n\r\n      if (!emailAccount) {\r\n        console.log(`\u26A0\uFE0F [AUTO-SYNC] Aucun compte email actif trouv\u00E9 pour l'utilisateur ${userId}`);\r\n        return null;\r\n      }\r\n\r\n      // Synchroniser cet utilisateur\r\n      const result = await this.syncUserEmails(emailAccount);\r\n      \r\n      console.log(`\u2705 [AUTO-SYNC] Sync manuelle termin\u00E9e pour ${userId}: ${result.newEmails} nouveaux, ${result.updatedEmails} mis \u00E0 jour`);\r\n      return result;\r\n      \r\n    } catch (error) {\r\n      console.error(`\u274C [AUTO-SYNC] Erreur sync manuelle pour l'utilisateur ${userId}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  stop() {\r\n    if (this.syncInterval) {\r\n      clearInterval(this.syncInterval);\r\n      this.syncInterval = null;\r\n    }\r\n    this.isRunning = false;\r\n    console.log('\u23F9\uFE0F [AUTO-SYNC] Service de synchronisation automatique arr\u00EAt\u00E9');\r\n  }\r\n\r\n  // \uD83C\uDF9B\uFE0F NOUVEAU: M\u00E9thode pour changer la fr\u00E9quence de synchronisation\r\n  setSyncFrequency(minutes: number) {\r\n    const newFrequency = minutes * 60000; // Convertir en millisecondes\r\n    console.log(`\u2699\uFE0F [AUTO-SYNC] Changement de fr\u00E9quence: ${minutes} minutes (${newFrequency}ms)`);\r\n    \r\n    this.syncFrequency = newFrequency;\r\n    \r\n    // Si le service est en cours, le red\u00E9marrer avec la nouvelle fr\u00E9quence\r\n    if (this.isRunning) {\r\n      console.log('\uD83D\uDD04 [AUTO-SYNC] Red\u00E9marrage avec nouvelle fr\u00E9quence...');\r\n      this.stop();\r\n      this.start();\r\n    }\r\n  }\r\n\r\n  // \uD83D\uDCCA NOUVEAU: Obtenir la fr\u00E9quence actuelle\r\n  getSyncFrequency(): number {\r\n    return this.syncFrequency / 60000; // Retourner en minutes\r\n  }\r\n\r\n  private async performSyncWithRetry(retryCount = 0): Promise<void> {\r\n    try {\r\n      await this.performSync();\r\n    } catch (error) {\r\n      console.error(`\u274C [AUTO-SYNC] Erreur de synchronisation (tentative ${retryCount + 1}/${this.maxRetries}):`, error);\r\n      \r\n      if (retryCount < this.maxRetries - 1) {\r\n        console.log(`\uD83D\uDD04 [AUTO-SYNC] Nouvelle tentative dans ${this.retryDelay}ms...`);\r\n        await new Promise(resolve => setTimeout(resolve, this.retryDelay));\r\n        return this.performSyncWithRetry(retryCount + 1);\r\n      } else {\r\n        console.error(`\uD83D\uDCA5 [AUTO-SYNC] \u00C9chec d\u00E9finitif apr\u00E8s ${this.maxRetries} tentatives`);\r\n      }\r\n    }\r\n  }\r\n\r\n  private async performSync(): Promise<void> {\r\n    try {\r\n      console.log('\u23F0 [AUTO-SYNC] D\u00E9but de la synchronisation automatique...');\r\n      \r\n      // V\u00E9rification de s\u00E9curit\u00E9 : pas plus de 10 utilisateurs \u00E0 synchroniser pour \u00E9viter la surcharge\r\n      const usersWithMail = await prisma.emailAccount.findMany({\r\n        where: {\r\n          isActive: true,\r\n          encryptedPassword: { not: null }\r\n        },\r\n        take: 10 // Limite de s\u00E9curit\u00E9\r\n      });\r\n\r\n      console.log(`\uD83D\uDC65 [AUTO-SYNC] ${usersWithMail.length} utilisateurs \u00E0 synchroniser`);\r\n\r\n      const totalResults: SyncResult[] = [];\r\n\r\n      for (const emailAccount of usersWithMail) {\r\n        try {\r\n          // Validation des donn\u00E9es critiques (pas besoin de imapHost car auto-d\u00E9tect\u00E9)\r\n          if (!emailAccount.emailAddress || !emailAccount.encryptedPassword) {\r\n            console.warn(`\u26A0\uFE0F [AUTO-SYNC] Configuration incompl\u00E8te pour l'utilisateur ${emailAccount.userId}, ignor\u00E9`);\r\n            continue;\r\n          }\r\n\r\n          const result = await this.syncUserEmails(emailAccount);\r\n          totalResults.push(result);\r\n          \r\n          // Attendre un peu entre chaque utilisateur pour \u00E9viter la surcharge\r\n          await new Promise(resolve => setTimeout(resolve, 1000));\r\n          \r\n        } catch (userError) {\r\n          console.error(`\u274C [AUTO-SYNC] Erreur pour l'utilisateur ${emailAccount.userId}:`, userError);\r\n        }\r\n      }\r\n\r\n      // R\u00E9sum\u00E9 de la synchronisation\r\n      const totalNew = totalResults.reduce((sum, r) => sum + r.newEmails, 0);\r\n      const totalUpdated = totalResults.reduce((sum, r) => sum + r.updatedEmails, 0);\r\n      \r\n      console.log(`\u2705 [AUTO-SYNC] Synchronisation termin\u00E9e: ${totalNew} nouveaux emails, ${totalUpdated} mis \u00E0 jour`);\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [AUTO-SYNC] Erreur lors de la synchronisation automatique:', error);\r\n      throw error; // Relancer pour le syst\u00E8me de retry\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Configuration automatique IMAP bas\u00E9e sur le domaine email\r\n   */\r\n  private getImapConfig(domain: string): { host: string; port: number; tls: boolean } {\r\n    const configs: { [key: string]: { host: string; port: number; tls: boolean } } = {\r\n      'gmail.com': { host: 'imap.gmail.com', port: 993, tls: true },\r\n      'one.com': { host: 'imap.one.com', port: 993, tls: true },\r\n      'yandex.com': { host: 'imap.yandex.com', port: 993, tls: true },\r\n      'yandex.ru': { host: 'imap.yandex.ru', port: 993, tls: true },\r\n      'outlook.com': { host: 'outlook.office365.com', port: 993, tls: true },\r\n      'hotmail.com': { host: 'outlook.office365.com', port: 993, tls: true },\r\n      'live.com': { host: 'outlook.office365.com', port: 993, tls: true },\r\n      'yahoo.com': { host: 'imap.mail.yahoo.com', port: 993, tls: true },\r\n      'yahoo.fr': { host: 'imap.mail.yahoo.com', port: 993, tls: true }\r\n    };\r\n\r\n    return configs[domain] || { host: `imap.${domain}`, port: 993, tls: true };\r\n  }\r\n\r\n  private async syncUserEmails(emailAccount: any): Promise<SyncResult> {\r\n    const startTime = Date.now();\r\n    let newEmails = 0;\r\n    let updatedEmails = 0;\r\n\r\n    try {\r\n      console.log(`\uD83D\uDD04 [AUTO-SYNC] Synchronisation pour ${emailAccount.emailAddress}...`);\r\n\r\n      // Configuration automatique IMAP/SMTP bas\u00E9e sur le domaine\r\n      const emailDomain = emailAccount.emailAddress.split('@')[1];\r\n      const imapConfig = this.getImapConfig(emailDomain);\r\n\r\n      const config = {\r\n        imap: {\r\n          user: emailAccount.emailAddress as string,\r\n          password: decrypt(emailAccount.encryptedPassword as string),\r\n          host: imapConfig.host,\r\n          port: imapConfig.port,\r\n          tls: imapConfig.tls,\r\n          tlsOptions: { \r\n            rejectUnauthorized: false,\r\n            servername: imapConfig.host\r\n          },\r\n          authTimeout: 10000,\r\n          connTimeout: 10000,\r\n          keepalive: false\r\n        }\r\n      };\r\n\r\n      let connection: any;\r\n      try {\r\n        connection = await imapSimple.connect(config);\r\n\r\n        // Dossiers One.com \u00E0 synchroniser\r\n        const foldersToSync = [\r\n          { imapName: 'INBOX', dbName: 'inbox' },\r\n          { imapName: 'INBOX.Sent', dbName: 'sent' },\r\n          { imapName: 'INBOX.Drafts', dbName: 'drafts' },\r\n          { imapName: 'INBOX.Trash', dbName: 'trash' },\r\n          { imapName: 'INBOX.Spam', dbName: 'spam' }\r\n        ];\r\n\r\n        for (const folder of foldersToSync) {\r\n          try {\r\n            await connection.openBox(folder.imapName);\r\n\r\n            // \uD83C\uDD95 R\u00C9PARATION: V\u00E9rifier si c'est le premier sync pour ce dossier\r\n            const existingEmailsCount = await prisma.email.count({\r\n              where: {\r\n                userId: emailAccount.userId,\r\n                folder: folder.dbName\r\n              }\r\n            });\r\n\r\n            console.log(`\uD83D\uDCCA [AUTO-SYNC] ${folder.imapName}: ${existingEmailsCount} emails existants en base`);\r\n\r\n            let results: any[] = [];\r\n\r\n            // \uD83C\uDFAF LOGIQUE R\u00C9PAR\u00C9E: Si premier sync, r\u00E9cup\u00E9rer TOUS les emails\r\n            if (existingEmailsCount === 0) {\r\n              console.log(`\uD83D\uDD04 [AUTO-SYNC] Premier sync pour ${folder.imapName} - R\u00E9cup\u00E9ration de TOUS les emails`);\r\n              \r\n              try {\r\n                results = await connection.search(['ALL'], {\r\n                  bodies: ['HEADER.FIELDS (FROM TO SUBJECT DATE MESSAGE-ID)', 'TEXT', '1.1', '1.2', '2', '1'],\r\n                  markSeen: false,\r\n                  struct: true\r\n                });\r\n                console.log(`\uD83D\uDCE7 [AUTO-SYNC] ${folder.imapName}: ${results.length} emails trouv\u00E9s (sync complet)`);\r\n              } catch (allError) {\r\n                console.log(`\u26A0\uFE0F [AUTO-SYNC] Erreur recherche ALL dans ${folder.imapName}:`, allError);\r\n              }\r\n            } else {\r\n              // Sync normal : chercher seulement les emails r\u00E9cents\r\n              console.log(`\uD83D\uDD04 [AUTO-SYNC] Sync normal pour ${folder.imapName} - Emails r\u00E9cents seulement`);\r\n              \r\n              const searchDate = new Date();\r\n              const months = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\r\n              const day = String(searchDate.getDate());\r\n              const month = months[searchDate.getMonth()];\r\n              const year = searchDate.getFullYear();\r\n              const formattedDate = `${day}-${month}-${year}`;\r\n              \r\n              try {\r\n                results = await connection.search(['SINCE', formattedDate], {\r\n                  bodies: ['HEADER.FIELDS (FROM TO SUBJECT DATE MESSAGE-ID)', 'TEXT', '1.1', '1.2', '2', '1'],\r\n                  markSeen: false,\r\n                  struct: true\r\n                });\r\n                console.log(`\uD83D\uDCE7 [AUTO-SYNC] ${folder.imapName}: ${results.length} emails depuis ${formattedDate}`);\r\n              } catch (sinceError) {\r\n                console.log(`\u26A0\uFE0F [AUTO-SYNC] Erreur SINCE dans ${folder.imapName}, fallback vers r\u00E9cents:`, sinceError);\r\n                \r\n                try {\r\n                  const allResults = await connection.search(['ALL'], {\r\n                    bodies: ['HEADER.FIELDS (FROM TO SUBJECT DATE MESSAGE-ID)', 'TEXT', '1.1', '1.2', '2', '1'],\r\n                    markSeen: false,\r\n                    struct: true\r\n                  });\r\n                  results = allResults.slice(-50); // 50 plus r\u00E9cents\r\n                  console.log(`\uD83D\uDCE7 [AUTO-SYNC] ${folder.imapName}: ${results.length} emails (fallback r\u00E9cents)`);\r\n                } catch (fallbackError) {\r\n                  console.log(`\u274C [AUTO-SYNC] Erreur fallback dans ${folder.imapName}:`, fallbackError);\r\n                }\r\n              }\r\n            }\r\n\r\n            // Traitement des emails trouv\u00E9s\r\n            const maxEmailsToProcess = existingEmailsCount === 0 ? 1000 : 100;\r\n            const emailsToProcess = results.slice(0, maxEmailsToProcess);\r\n            \r\n            if (results.length > maxEmailsToProcess) {\r\n              console.warn(`\u26A0\uFE0F [AUTO-SYNC] ${folder.imapName}: Limite de ${maxEmailsToProcess} emails appliqu\u00E9e (${results.length} trouv\u00E9s)`);\r\n            }\r\n\r\n            for (const item of emailsToProcess) {\r\n              try {\r\n                console.log(`\uD83D\uDD0D [AUTO-SYNC] Traitement email dans ${folder.imapName}...`);\r\n                \r\n                // \u2705 R\u00C9PARATION: Recherche correcte des headers\r\n                const headerPart = item.parts.find((part: any) => \r\n                  part.which && part.which.includes('HEADER')\r\n                );\r\n                \r\n                let header = null;\r\n                if (headerPart && headerPart.body) {\r\n                  header = headerPart.body;\r\n                  console.log(`\u2705 [AUTO-SYNC] Headers trouv\u00E9s pour email dans ${folder.imapName}`);\r\n                } else {\r\n                  // Fallback: chercher dans toutes les parties\r\n                  for (const part of item.parts || []) {\r\n                    if (part.body && typeof part.body === 'object') {\r\n                      if (part.body.subject || part.body.from || part.body.date) {\r\n                        header = part.body;\r\n                        console.log(`\u2705 [AUTO-SYNC] Headers trouv\u00E9s via fallback pour email dans ${folder.imapName}`);\r\n                        break;\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n                \r\n                if (header) {\r\n                  let subject = decodeMimeHeader(header.subject ? header.subject[0] : 'Pas de sujet');\r\n                  let from = decodeMimeHeader(header.from ? header.from[0] : 'Exp\u00E9diteur inconnu');\r\n                  let to = decodeMimeHeader(header.to ? header.to[0] : emailAccount.emailAddress);\r\n                  \r\n                  // \uD83D\uDD27 CORRECTION AUTOMATIQUE DE L'ENCODAGE\r\n                  subject = fixUtf8Encoding(subject);\r\n                  from = fixUtf8Encoding(from);\r\n                  to = fixUtf8Encoding(to);\r\n                  \r\n                  const messageId = header['message-id'] ? header['message-id'][0] : null;\r\n                  const date = header.date ? new Date(header.date[0]) : new Date();\r\n                  const isRead = item.attributes.flags.includes('\\\\Seen');\r\n                  \r\n                  // \u2705 CORRECTION: R\u00E9cup\u00E9rer l'UID IMAP pour la synchronisation bidirectionnelle\r\n                  const uid = item.attributes.uid;\r\n                  \r\n                  console.log(`\uD83D\uDCE7 [AUTO-SYNC] Email \"${subject}\" de ${from} - Date: ${date} - UID: ${uid}`);\r\n                  \r\n                  // Extraction intelligente du contenu de l'email (HTML ou TEXT)\r\n                  let body = 'Corps r\u00E9cup\u00E9r\u00E9 en arri\u00E8re-plan';\r\n                  let contentType = 'text/plain';\r\n                  \r\n                  // Analyser la structure MIME\r\n                  let htmlBody = null;\r\n                  let textBody = null;\r\n                  \r\n                  if (item.struct) {\r\n                    const extractBodies = (struct: any, partPath = '') => {\r\n                      if (Array.isArray(struct)) {\r\n                        struct.forEach((part, index) => {\r\n                          const currentPath = partPath ? `${partPath}.${index + 1}` : `${index + 1}`;\r\n                          extractBodies(part, currentPath);\r\n                        });\r\n                      } else if (struct.type && struct.subtype) {\r\n                        const mimeType = `${struct.type}/${struct.subtype}`.toLowerCase();\r\n                        const currentPath = partPath || '1';\r\n                        \r\n                        const bodyPart = item.parts.find((p: any) => p.which === currentPath)?.body;\r\n                        \r\n                        if (bodyPart) {\r\n                          const bodyContent = bodyPart.toString();\r\n                          \r\n                          if (mimeType === 'text/html' && !htmlBody) {\r\n                            htmlBody = bodyContent;\r\n                          } else if (mimeType === 'text/plain' && !textBody) {\r\n                            textBody = bodyContent;\r\n                          }\r\n                        }\r\n                        \r\n                        if (struct.body) {\r\n                          extractBodies(struct.body, currentPath);\r\n                        }\r\n                      }\r\n                    };\r\n                    \r\n                    extractBodies(item.struct);\r\n                  }\r\n                  \r\n                  // Fallback: examiner toutes les parties disponibles\r\n                  if (!htmlBody && !textBody) {\r\n                    const allParts = item.parts || [];\r\n                    \r\n                    for (const part of allParts) {\r\n                      if (part.which && part.body) {\r\n                        const bodyContent = part.body.toString();\r\n                        \r\n                        if (bodyContent.includes('<html') || bodyContent.includes('<HTML') || \r\n                            bodyContent.includes('<!DOCTYPE') || bodyContent.includes('<body') ||\r\n                            bodyContent.includes('<div') || bodyContent.includes('<p>') ||\r\n                            bodyContent.includes('<br') || bodyContent.includes('<a ')) {\r\n                          htmlBody = bodyContent;\r\n                        } else if (part.which === 'TEXT' || bodyContent.length > 10) {\r\n                          textBody = bodyContent;\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                  \r\n                  // Priorit\u00E9 au HTML s'il existe, sinon utiliser le texte\r\n                  if (htmlBody) {\r\n                    body = this.cleanHtmlContent(htmlBody);\r\n                    contentType = 'text/html';\r\n                  } else if (textBody) {\r\n                    body = this.cleanTextContent(textBody);\r\n                    contentType = 'text/plain';\r\n                  }\r\n\r\n                  // \u2705 CORRECTION: V\u00E9rification d'existence avec UID IMAP en priorit\u00E9\r\n                  let existingEmail;\r\n                  \r\n                  // 1. Chercher d'abord par UID IMAP (le plus fiable)\r\n                  if (uid) {\r\n                    existingEmail = await prisma.email.findFirst({\r\n                      where: {\r\n                        userId: emailAccount.userId,\r\n                        uid: uid.toString(),\r\n                        folder: folder.dbName\r\n                      },\r\n                      select: { id: true, isRead: true }\r\n                    });\r\n                  }\r\n                  \r\n                  // 2. Fallback vers Message-ID si pas d'UID ou pas trouv\u00E9\r\n                  if (!existingEmail && messageId) {\r\n                    existingEmail = await prisma.email.findFirst({\r\n                      where: {\r\n                        userId: emailAccount.userId,\r\n                        body: { contains: messageId },\r\n                        folder: folder.dbName\r\n                      },\r\n                      select: { id: true, isRead: true }\r\n                    });\r\n                  }\r\n                  \r\n                  // 3. Fallback vers subject+from+date (ancienne m\u00E9thode)\r\n                  if (!existingEmail) {\r\n                    const dateStart = new Date(date.getTime() - 30000);\r\n                    const dateEnd = new Date(date.getTime() + 30000);\r\n                    \r\n                    existingEmail = await prisma.email.findFirst({\r\n                      where: {\r\n                        userId: emailAccount.userId,\r\n                        subject,\r\n                        from,\r\n                        folder: folder.dbName,\r\n                        createdAt: {\r\n                          gte: dateStart,\r\n                          lte: dateEnd\r\n                        }\r\n                      },\r\n                      select: { id: true, isRead: true }\r\n                    });\r\n                  }\r\n\r\n                  if (!existingEmail) {\r\n                    // \uD83D\uDEA8 V\u00C9RIFICATION BLACKLIST: Ne pas recr\u00E9er des emails supprim\u00E9s\r\n                    let isInBlacklist = false;\r\n                    \r\n                    if (uid) {\r\n                      const deletedByUID = await prisma.deletedEmail.findFirst({\r\n                        where: {\r\n                          userId: emailAccount.userId,\r\n                          uid: uid.toString(),\r\n                          folder: folder.dbName\r\n                        }\r\n                      });\r\n                      isInBlacklist = !!deletedByUID;\r\n                    }\r\n                    \r\n                    if (!isInBlacklist && messageId) {\r\n                      const deletedByMessageId = await prisma.deletedEmail.findFirst({\r\n                        where: {\r\n                          userId: emailAccount.userId,\r\n                          messageId: messageId,\r\n                          folder: folder.dbName\r\n                        }\r\n                      });\r\n                      isInBlacklist = !!deletedByMessageId;\r\n                    }\r\n                    \r\n                    if (isInBlacklist) {\r\n                      console.log(`\uD83D\uDEAB [AUTO-SYNC] Email en blacklist, ignor\u00E9: \"${subject}\" (UID: ${uid})`);\r\n                      continue; // Passer au prochain email\r\n                    }\r\n                    \r\n                    console.log(`\uD83D\uDCBE [AUTO-SYNC] Cr\u00E9ation nouvel email: \"${subject}\"`);\r\n                    \r\n                    // \uD83D\uDD27 CORRECTION AUTOMATIQUE DE L'ENCODAGE DU CORPS DU MESSAGE\r\n                    const cleanBody = fixUtf8Encoding(body);\r\n                    const finalBody = messageId ? `Message-ID: ${messageId}\\n\\n${cleanBody}` : cleanBody;\r\n                    \r\n                    const newEmail = await prisma.email.create({\r\n                      data: {\r\n                        userId: emailAccount.userId,\r\n                        from,\r\n                        to,\r\n                        subject,\r\n                        body: finalBody,\r\n                        contentType,\r\n                        isRead,\r\n                        folder: folder.dbName,\r\n                        uid: uid ? uid.toString() : null, // \u2705 CORRECTION: Stocker l'UID IMAP\r\n                        createdAt: date\r\n                      }\r\n                    });\r\n                    newEmails++;\r\n\r\n                    // \uD83D\uDE80 NOUVELLE FONCTIONNALIT\u00C9 : NOTIFICATION TEMPS R\u00C9EL !\r\n                    if (folder.dbName === 'inbox' && !isRead) {\r\n                      console.log('\uD83D\uDD14 [AUTO-SYNC] D\u00E9clenchement notification temps r\u00E9el !');\r\n                      \r\n                      // R\u00E9cup\u00E9rer l'organisation de l'utilisateur\r\n                      const userOrg = await prisma.userOrganization.findFirst({\r\n                        where: { userId: emailAccount.userId },\r\n                        select: { organizationId: true }\r\n                      });\r\n\r\n                      if (userOrg) {\r\n                        // \uD83D\uDE80 NOUVELLE FONCTIONNALIT\u00C9 : \u00C9METTRE UN \u00C9V\u00C9NEMENT\r\n                        this.emit('newEmailFound', {\r\n                          emailId: newEmail.id,\r\n                          from,\r\n                          subject,\r\n                          folder: folder.dbName,\r\n                          receivedAt: date,\r\n                          userId: emailAccount.userId,\r\n                          organizationId: userOrg.organizationId\r\n                        });\r\n\r\n                        const notificationService = RealTimeEmailNotificationService.getInstance();\r\n                        notificationService.notifyNewEmail({\r\n                          emailId: newEmail.id,\r\n                          from,\r\n                          subject,\r\n                          folder: folder.dbName,\r\n                          receivedAt: date,\r\n                          userId: emailAccount.userId,\r\n                          organizationId: userOrg.organizationId\r\n                        });\r\n                      }\r\n                    }\r\n\r\n                    console.log(`\u2705 [AUTO-SYNC] Nouvel email cr\u00E9\u00E9: \"${subject}\" (UID: ${uid}, ${contentType})`);\r\n                  } else if (existingEmail.isRead !== isRead) {\r\n                    console.log(`\uD83D\uDCDD [AUTO-SYNC] Mise \u00E0 jour statut email: \"${subject}\"`);\r\n                    \r\n                    await prisma.email.update({\r\n                      where: { id: existingEmail.id },\r\n                      data: { isRead }\r\n                    });\r\n                    updatedEmails++;\r\n                    console.log(`\uD83D\uDCDD [AUTO-SYNC] Email mis \u00E0 jour: \"${subject}\"`);\r\n                  } else {\r\n                    console.log(`\u23ED\uFE0F [AUTO-SYNC] Email d\u00E9j\u00E0 existant: \"${subject}\"`);\r\n                  }\r\n                } else {\r\n                  console.warn(`\u26A0\uFE0F [AUTO-SYNC] Pas de header trouv\u00E9 pour un email dans ${folder.imapName}`);\r\n                  console.log(`\uD83D\uDD0D [AUTO-SYNC] Debug - Parties disponibles:`, item.parts?.map((p: any) => ({ which: p.which, hasBody: !!p.body, bodyType: typeof p.body })));\r\n                  console.log(`\uD83D\uDD0D [AUTO-SYNC] Debug - Attributs:`, item.attributes);\r\n                }\r\n              } catch (emailError) {\r\n                console.error(`\u274C [AUTO-SYNC] Erreur traitement email dans ${folder.imapName}:`, emailError);\r\n              }\r\n            }\r\n          } catch (folderError) {\r\n            console.log(`\u26A0\uFE0F [AUTO-SYNC] Dossier ${folder.imapName} inaccessible, ignor\u00E9:`, folderError);\r\n          }\r\n        }\r\n\r\n        connection.end();\r\n        \r\n        const duration = Date.now() - startTime;\r\n        console.log(`\u26A1 [AUTO-SYNC] ${emailAccount.emailAddress}: ${newEmails} nouveaux, ${updatedEmails} mis \u00E0 jour (${duration}ms)`);\r\n\r\n      } catch (imapError) {\r\n        if (connection) {\r\n          try { connection.end(); } catch { /* ignore */ }\r\n        }\r\n        throw imapError;\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error(`\u274C [AUTO-SYNC] Erreur pour ${emailAccount.emailAddress}:`, error);\r\n    }\r\n\r\n    const totalEmails = await prisma.email.count({\r\n      where: { userId: emailAccount.userId }\r\n    });\r\n\r\n    return {\r\n      userId: emailAccount.userId,\r\n      newEmails,\r\n      updatedEmails,\r\n      totalEmails\r\n    };\r\n  }\r\n\r\n  async forceSync(): Promise<void> {\r\n    console.log('\uD83D\uDD04 [AUTO-SYNC] Synchronisation forc\u00E9e demand\u00E9e...');\r\n    await this.performSyncWithRetry();\r\n  }\r\n\r\n  private cleanHtmlContent(htmlContent: string): string {\r\n    try {\r\n      let cleanContent = htmlContent;\r\n\r\n      // \uD83C\uDFAF PARSING MIME AVANC\u00C9 - G\u00E9rer tous les types de d\u00E9limiteurs\r\n      if (cleanContent.includes('This is a multi-part message') || \r\n          cleanContent.match(/^--[a-zA-Z0-9]/m) ||\r\n          cleanContent.includes('------=_NextPart_') ||\r\n          cleanContent.includes('Content-Type:')) {\r\n        \r\n        console.log('\uD83D\uDD27 [AUTO-SYNC] Email MIME multi-part d\u00E9tect\u00E9, parsing avanc\u00E9...');\r\n        \r\n        // Extraire les parties MIME avec diff\u00E9rents d\u00E9limiteurs\r\n        let parts = [];\r\n        \r\n        // M\u00E9thode 1: D\u00E9limiteurs --XXXXX\r\n        if (cleanContent.match(/^--[a-zA-Z0-9]/m)) {\r\n          parts = cleanContent.split(/^--[a-zA-Z0-9][^\\n]*$/m);\r\n        }\r\n        // M\u00E9thode 2: D\u00E9limiteurs ------=_NextPart_\r\n        else if (cleanContent.includes('------=_NextPart_')) {\r\n          parts = cleanContent.split(/^------=_NextPart_[^\\n]*$/m);\r\n        }\r\n        // M\u00E9thode 3: Autres d\u00E9limiteurs MIME\r\n        else {\r\n          parts = cleanContent.split(/^--[=a-zA-Z0-9][^\\n]*$/m);\r\n        }\r\n        \r\n        let htmlPart = null;\r\n        let textPart = null;\r\n        \r\n        // Analyser chaque partie\r\n        for (const part of parts) {\r\n          if (!part.trim()) continue;\r\n          \r\n          // Chercher la partie HTML\r\n          if (part.includes('Content-Type: text/html') || \r\n              part.includes('Content-Type:text/html')) {\r\n            \r\n            console.log('\u2705 [AUTO-SYNC] Partie HTML trouv\u00E9e');\r\n            \r\n            // Extraire le contenu apr\u00E8s les en-t\u00EAtes\r\n            const lines = part.split('\\n');\r\n            let contentStartIndex = -1;\r\n            \r\n            for (let i = 0; i < lines.length; i++) {\r\n              if (lines[i].trim() === '') {\r\n                contentStartIndex = i + 1;\r\n                break;\r\n              }\r\n            }\r\n            \r\n            if (contentStartIndex !== -1) {\r\n              htmlPart = lines.slice(contentStartIndex).join('\\n').trim();\r\n              \r\n              // D\u00E9coder quoted-printable si n\u00E9cessaire\r\n              if (part.includes('quoted-printable')) {\r\n                htmlPart = htmlPart.replace(/=([0-9A-F]{2})/gi, (_, hex) => {\r\n                  return String.fromCharCode(parseInt(hex, 16));\r\n                });\r\n                htmlPart = htmlPart.replace(/=\\r?\\n/g, '');\r\n              }\r\n              \r\n              break;\r\n            }\r\n          }\r\n          // Partie texte comme fallback\r\n          else if (part.includes('Content-Type: text/plain') || \r\n                   part.includes('Content-Type:text/plain')) {\r\n            \r\n            const lines = part.split('\\n');\r\n            let contentStartIndex = -1;\r\n            \r\n            for (let i = 0; i < lines.length; i++) {\r\n              if (lines[i].trim() === '') {\r\n                contentStartIndex = i + 1;\r\n                break;\r\n              }\r\n            }\r\n            \r\n            if (contentStartIndex !== -1) {\r\n              textPart = lines.slice(contentStartIndex).join('\\n').trim();\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Utiliser la partie HTML si trouv\u00E9e, sinon le texte\r\n        if (htmlPart) {\r\n          console.log('\uD83C\uDFAF [AUTO-SYNC] Utilisation de la partie HTML extraite');\r\n          cleanContent = htmlPart;\r\n        } else if (textPart) {\r\n          console.log('\uD83D\uDCDD [AUTO-SYNC] Conversion texte \u2192 HTML');\r\n          cleanContent = `<div style=\"white-space: pre-wrap; font-family: Arial, sans-serif; padding: 20px;\">${textPart.replace(/\\n/g, '<br>')}</div>`;\r\n        } else {\r\n          console.log('\u26A0\uFE0F [AUTO-SYNC] Aucune partie exploitable trouv\u00E9e, nettoyage basique');\r\n        }\r\n      }\r\n\r\n      // D\u00E9coder les caract\u00E8res quoted-printable restants\r\n      cleanContent = cleanContent.replace(/=([0-9A-F]{2})/gi, (_, hex) => {\r\n        return String.fromCharCode(parseInt(hex, 16));\r\n      });\r\n      cleanContent = cleanContent.replace(/=\\r?\\n/g, '');\r\n\r\n      // Corriger l'encodage UTF-8 mal interpr\u00E9t\u00E9 automatiquement\r\n      cleanContent = fixUtf8Encoding(cleanContent);\r\n\r\n      // Nettoyer les en-t\u00EAtes MIME restants\r\n      cleanContent = cleanContent.replace(/^[A-Za-z-]+:\\s*.*$/gm, '');\r\n      cleanContent = cleanContent.replace(/\\n\\s*\\n\\s*\\n/g, '\\n\\n');\r\n      cleanContent = cleanContent.replace(/^------=_NextPart_.*$/gm, '');\r\n      cleanContent = cleanContent.replace(/This is a multi-part message in MIME format\\./g, '');\r\n      cleanContent = cleanContent.replace(/^Content-Type:.*$/gm, '');\r\n      cleanContent = cleanContent.replace(/^Content-Transfer-Encoding:.*$/gm, '');\r\n      cleanContent = cleanContent.replace(/^\\s*charset.*$/gm, '');\r\n      cleanContent = cleanContent.trim();\r\n\r\n      // Chercher le d\u00E9but du HTML si ce n'est pas d\u00E9j\u00E0 fait\r\n      const htmlTagIndex = cleanContent.search(/<html|<!DOCTYPE/i);\r\n      if (htmlTagIndex >= 0) {\r\n        cleanContent = cleanContent.substring(htmlTagIndex);\r\n      }\r\n\r\n      return cleanContent;\r\n    } catch (error) {\r\n      console.error('\u274C [AUTO-SYNC] Erreur lors du nettoyage HTML:', error);\r\n      return htmlContent;\r\n    }\r\n  }\r\n\r\n  private cleanTextContent(textContent: string): string {\r\n    try {\r\n      let cleanContent = textContent;\r\n      \r\n      // Corriger l'encodage UTF-8 mal interpr\u00E9t\u00E9 automatiquement\r\n      cleanContent = fixUtf8Encoding(cleanContent);\r\n      \r\n      const mimeHeaderPattern = /^[A-Za-z-]+:\\s*.*$/gm;\r\n      cleanContent = cleanContent.replace(mimeHeaderPattern, '');\r\n      cleanContent = cleanContent.replace(/^------=_NextPart_.*$/gm, '');\r\n      cleanContent = cleanContent.replace(/This is a multi-part message in MIME format\\./g, '');\r\n      cleanContent = cleanContent.trim();\r\n      \r\n      return cleanContent;\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C [AUTO-SYNC] Erreur lors du nettoyage texte:', error);\r\n      return textContent;\r\n    }\r\n  }\r\n}\r\n\r\n// Instance singleton\r\nexport const autoMailSync = new AutoMailSyncService();\r\n\r\nexport default AutoMailSyncService;\r\n", "/**\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * \uD83C\uDFAF SYST\u00C8ME UNIVERSEL D'INTERPR\u00C9TATION DES OP\u00C9RATIONS TBL\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * \r\n * Ce module permet de LIRE, COMPRENDRE, et RETRANSCRIRE n'importe quelle\r\n * op\u00E9ration TBL (Condition, Formule, Table) de mani\u00E8re r\u00E9cursive.\r\n * \r\n * PRINCIPES FONDAMENTAUX :\r\n * ------------------------\r\n * 1. TOUT peut se m\u00E9langer : Condition \u2192 Formule \u2192 Table \u2192 Condition...\r\n * 2. Chaque op\u00E9ration est interpr\u00E9t\u00E9e R\u00C9CURSIVEMENT\r\n * 3. Les donn\u00E9es sont r\u00E9cup\u00E9r\u00E9es depuis SubmissionData\r\n * 4. Le r\u00E9sultat est retranscrit en texte humain\r\n * \r\n * ARCHITECTURE :\r\n * --------------\r\n * - identifyReferenceType()    : Identifie le type d'une r\u00E9f\u00E9rence\r\n * - interpretReference()        : Point d'entr\u00E9e r\u00E9cursif universel\r\n * - interpretCondition()        : Interpr\u00E8te une condition\r\n * - interpretFormula()          : Interpr\u00E8te une formule\r\n * - interpretTable()            : Interpr\u00E8te un lookup de table\r\n * - interpretField()            : Interpr\u00E8te un champ simple\r\n * - evaluateVariableOperation() : Point d'entr\u00E9e principal depuis l'API\r\n * \r\n * @author System TBL\r\n * @version 1.0.0\r\n * @date 2025-01-06\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nfunction formatDebugValue(value: unknown): string {\r\n  if (value === null || value === undefined) return '\u2205';\r\n  if (typeof value === 'string') {\r\n    return value.length > 120 ? `${value.slice(0, 117)}...` : value;\r\n  }\r\n  if (typeof value === 'number' || typeof value === 'boolean') {\r\n    return String(value);\r\n  }\r\n  try {\r\n    const serialized = JSON.stringify(value);\r\n    return serialized.length > 120 ? `${serialized.slice(0, 117)}...` : serialized;\r\n  } catch {\r\n    return '[unserializable]';\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCB TYPES ET INTERFACES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDCE4 Structure de retour standard pour toutes les interpr\u00E9tations\r\n * \r\n * Cette interface unifie le format de retour de toutes les fonctions\r\n * d'interpr\u00E9tation, garantissant coh\u00E9rence et tra\u00E7abilit\u00E9.\r\n */\r\nexport interface InterpretResult {\r\n  /** Valeur calcul\u00E9e finale (ex: \"73\", \"1450\", \"0.35\") */\r\n  result: string;\r\n  \r\n  /** Texte explicatif en langage humain (ex: \"Si Prix > 10 Alors...\") */\r\n  humanText: string;\r\n  \r\n  /** Structure d\u00E9taill\u00E9e de l'op\u00E9ration pour tra\u00E7abilit\u00E9 compl\u00E8te */\r\n  details: {\r\n    /** Type d'op\u00E9ration (condition, formula, table, field) */\r\n    type: string;\r\n    /** Autres propri\u00E9t\u00E9s sp\u00E9cifiques au type */\r\n    [key: string]: any;\r\n  };\r\n}\r\n\r\n/**\r\n * \uD83C\uDFAF Types de r\u00E9f\u00E9rences possibles dans le syst\u00E8me TBL\r\n */\r\ntype ReferenceType = 'field' | 'formula' | 'condition' | 'table';\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD0D MODULE 1 : IDENTIFICATION DU TYPE DE R\u00C9F\u00C9RENCE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDD0D Identifie le type d'une r\u00E9f\u00E9rence TBL\r\n * \r\n * Cette fonction analyse une cha\u00EEne de r\u00E9f\u00E9rence et d\u00E9termine si elle\r\n * pointe vers un champ, une formule, une condition ou une table.\r\n * \r\n * FORMATS RECONNUS :\r\n * ------------------\r\n * - Formule     : \"node-formula:xxx\" ou \"@value.node-formula:xxx\"\r\n * - Condition   : \"condition:xxx\" ou \"@value.condition:xxx\"\r\n * - Table       : \"node-table:xxx\" ou \"@table.xxx\"\r\n * - Champ UUID  : \"702d1b09-abc9-4096-9aaa-77155ac5294f\"\r\n * - Champ g\u00E9n\u00E9r\u00E9: \"node_1757366229534_x6jxzmvmu\"\r\n * \r\n * @param ref - R\u00E9f\u00E9rence brute \u00E0 analyser\r\n * @returns Type de r\u00E9f\u00E9rence identifi\u00E9\r\n * \r\n * @example\r\n * identifyReferenceType(\"@value.702d1b09...\") \u2192 'field'\r\n * identifyReferenceType(\"node-formula:4e352467...\") \u2192 'formula'\r\n * identifyReferenceType(\"condition:ff05cc48...\") \u2192 'condition'\r\n * identifyReferenceType(\"@table.cmgbfpc7t...\") \u2192 'table'\r\n */\r\nfunction identifyReferenceType(ref: string): ReferenceType {\r\n  // Nettoyer les pr\u00E9fixes courants pour analyse\r\n  const cleaned = ref\r\n    .replace('@value.', '')\r\n    .replace('@table.', '')\r\n    .trim();\r\n  \r\n  // \uD83E\uDDEE V\u00E9rifier si c'est une FORMULE\r\n  if (cleaned.startsWith('node-formula:')) {\r\n    return 'formula';\r\n  }\r\n  \r\n  // \uD83D\uDD00 V\u00E9rifier si c'est une CONDITION\r\n  if (cleaned.startsWith('condition:') || cleaned.startsWith('node-condition:')) {\r\n    return 'condition';\r\n  }\r\n  \r\n  // \uD83D\uDCCA V\u00E9rifier si c'est une TABLE\r\n  if (cleaned.startsWith('node-table:') || ref.includes('@table.')) {\r\n    return 'table';\r\n  }\r\n  \r\n  // \uD83D\uDCDD V\u00E9rifier si c'est un champ g\u00E9n\u00E9r\u00E9 automatiquement\r\n  if (cleaned.startsWith('node_')) {\r\n    return 'field';\r\n  }\r\n  \r\n  // \uD83D\uDCDD V\u00E9rifier si c'est un UUID de champ\r\n  const uuidRegex = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;\r\n  if (uuidRegex.test(cleaned)) {\r\n    return 'field';\r\n  }\r\n  \r\n  // Par d\u00E9faut, consid\u00E9rer comme un champ\r\n  return 'field';\r\n}\r\n\r\n/**\r\n * \uD83E\uDDF9 Normalise une r\u00E9f\u00E9rence en enlevant les pr\u00E9fixes\r\n * \r\n * Cette fonction nettoie une r\u00E9f\u00E9rence pour obtenir l'ID pur utilisable\r\n * dans les requ\u00EAtes Prisma.\r\n * \r\n * @param ref - R\u00E9f\u00E9rence \u00E0 normaliser\r\n * @returns ID normalis\u00E9\r\n * \r\n * @example\r\n * normalizeRef(\"@value.702d1b09...\") \u2192 \"702d1b09...\"\r\n * normalizeRef(\"node-formula:4e352467...\") \u2192 \"4e352467...\"\r\n * normalizeRef(\"condition:ff05cc48...\") \u2192 \"ff05cc48...\"\r\n */\r\nfunction normalizeRef(ref: string): string {\r\n  return ref\r\n    .replace('@value.', '')\r\n    .replace('@table.', '')\r\n    .replace('node-formula:', '')\r\n    .replace('node-table:', '')\r\n    .replace('node-condition:', '')\r\n    .replace('condition:', '')\r\n    .trim();\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCA MODULE 2 : R\u00C9CUP\u00C9RATION DES DONN\u00C9ES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDCCA ENRICHISSEMENT MASSIF - Charge TOUTES les valeurs et labels d'une soumission\r\n * \r\n * Cette fonction effectue une r\u00E9cup\u00E9ration massive depuis la base de donn\u00E9es :\r\n * 1. R\u00E9cup\u00E8re TOUTES les valeurs depuis TreeBranchLeafSubmissionData\r\n * 2. R\u00E9cup\u00E8re TOUS les labels depuis TreeBranchLeafNode (pour tout l'arbre)\r\n * 3. Remplit les Maps valueMap et labelMap pour acc\u00E8s rapide\r\n * \r\n * IMPORTANT : Cette fonction ENRICHIT les Maps existantes (ne les remplace pas)\r\n * \r\n * @param submissionId - ID de la soumission\r\n * @param prisma - Instance Prisma Client\r\n * @param valueMap - Map des valeurs \u00E0 enrichir\r\n * @param labelMap - Map des labels \u00E0 enrichir\r\n * @param treeId - ID de l'arbre (optionnel, sera d\u00E9tect\u00E9 automatiquement)\r\n */\r\nasync function enrichDataFromSubmission(\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valueMap: Map<string, unknown>,\r\n  labelMap: Map<string, string>,\r\n  treeId?: string\r\n): Promise<void> {\r\n  console.log(`[ENRICHMENT] \uD83D\uDCCA Enrichissement donn\u00E9es: ${submissionId}`);\r\n  \r\n  try {\r\n    // 1. R\u00E9cup\u00E9rer les VALEURS depuis TreeBranchLeafSubmissionData\r\n    const submissionData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId },\r\n      select: { \r\n        nodeId: true, \r\n        value: true\r\n      }\r\n    });\r\n    \r\n    console.log(`[ENRICHMENT] \uD83D\uDCCA ${submissionData.length} valeurs r\u00E9cup\u00E9r\u00E9es depuis SubmissionData`);\r\n    \r\n    // 2. Trouver l'arbre de cette soumission si pas fourni\r\n    if (!treeId) {\r\n      const firstSubmissionNode = await prisma.treeBranchLeafSubmissionData.findFirst({\r\n        where: { submissionId },\r\n        include: { TreeBranchLeafNode: { select: { treeId: true } } }\r\n      });\r\n      treeId = firstSubmissionNode?.TreeBranchLeafNode?.treeId;\r\n    }\r\n    \r\n    if (treeId) {\r\n      // 3. R\u00E9cup\u00E9rer TOUS les labels de l'arbre\r\n      const allNodes = await prisma.treeBranchLeafNode.findMany({\r\n        where: { treeId },\r\n        select: { \r\n          id: true, \r\n          label: true \r\n        }\r\n      });\r\n      \r\n      console.log(`[ENRICHMENT] \uD83C\uDFF7\uFE0F ${allNodes.length} labels r\u00E9cup\u00E9r\u00E9s depuis l'arbre`);\r\n      \r\n      // 4. ENRICHIR LABELMAP\r\n      for (const node of allNodes) {\r\n        if (!labelMap.has(node.id)) {\r\n          labelMap.set(node.id, node.label);\r\n        }\r\n      }\r\n    } else {\r\n      console.warn(`[ENRICHMENT] \u26A0\uFE0F Impossible de trouver l'arbre pour la soumission ${submissionId}`);\r\n    }\r\n    \r\n    // 5. ENRICHIR VALUEMAP\r\n    for (const data of submissionData) {\r\n      if (data.nodeId && data.value !== null) {\r\n        // Ne pas \u00E9craser si d\u00E9j\u00E0 pr\u00E9sent (priorit\u00E9 au valueMap initial pour mode preview)\r\n        if (!valueMap.has(data.nodeId)) {\r\n          let parsedValue: unknown;\r\n          try {\r\n            parsedValue = typeof data.value === 'string' ? JSON.parse(data.value) : data.value;\r\n          } catch {\r\n            parsedValue = data.value;\r\n          }\r\n          valueMap.set(data.nodeId, parsedValue);\r\n        }\r\n      }\r\n    }\r\n    \r\n    console.log(`[ENRICHMENT] \uD83C\uDF89 Enrichissement termin\u00E9 - labels: ${labelMap.size}, valeurs: ${valueMap.size}`);\r\n    \r\n  } catch (error) {\r\n    console.error(`[ENRICHMENT] \u274C Erreur enrichissement:`, error);\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83D\uDCCA R\u00E9cup\u00E8re la valeur d'un n\u0153ud depuis valueMap (avec fallback DB)\r\n * \r\n * Cette fonction interroge d'abord le valueMap (mode preview ou cache enrichi),\r\n * puis fait un fallback vers TreeBranchLeafSubmissionData si n\u00E9cessaire.\r\n * \r\n * IMPORTANT : La valeur peut \u00EAtre null si :\r\n * - Le champ n'a pas encore \u00E9t\u00E9 rempli par l'utilisateur\r\n * - Le champ est calcul\u00E9 mais pas encore \u00E9valu\u00E9\r\n * - Le champ est optionnel et laiss\u00E9 vide\r\n * \r\n * @param nodeId - ID du n\u0153ud \u00E0 r\u00E9cup\u00E9rer\r\n * @param submissionId - ID de la soumission en cours\r\n * @param prisma - Instance Prisma Client\r\n * @param valueMap - Map des valeurs (d\u00E9j\u00E0 enrichie par enrichDataFromSubmission)\r\n * @returns Valeur du n\u0153ud ou null si non trouv\u00E9e\r\n * \r\n * @example\r\n * await getNodeValue(\"702d1b09...\", \"tbl-1759750447813...\", prisma, valueMap)\r\n * \u2192 \"1450\"\r\n */\r\nasync function getNodeValue(\r\n  nodeId: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valueMap?: Map<string, unknown>\r\n): Promise<string | null> {\r\n  // \uD83C\uDFAF PRIORIT\u00C9 1: V\u00E9rifier dans valueMap si fourni\r\n  if (valueMap && valueMap.has(nodeId)) {\r\n    const val = valueMap.get(nodeId);\r\n    console.log(`[INTERPRETER][getNodeValue] valueMap hit ${nodeId} \u2192 ${formatDebugValue(val)}`);\r\n    return val !== null && val !== undefined ? String(val) : null;\r\n  }\r\n\r\n  console.log(`[INTERPRETER][getNodeValue] DB fallback ${nodeId}`);\r\n  \r\n  // \uD83C\uDFAF PRIORIT\u00C9 2: Requ\u00EAte Prisma pour r\u00E9cup\u00E9rer depuis la base (fallback rare)\r\n  const data = await prisma.treeBranchLeafSubmissionData.findFirst({\r\n    where: {\r\n      nodeId,\r\n      submissionId\r\n    },\r\n    select: {\r\n      value: true\r\n    }\r\n  });\r\n\r\n  console.log(`[INTERPRETER][getNodeValue] DB result ${nodeId} \u2192 ${formatDebugValue(data?.value ?? null)}`);\r\n  \r\n  // Retourner la valeur ou null\r\n  return data?.value || null;\r\n}\r\n\r\n/**\r\n * \uD83C\uDFF7\uFE0F R\u00E9cup\u00E8re le label depuis labelMap (avec fallback DB)\r\n * \r\n * Cette fonction r\u00E9cup\u00E8re d'abord le label depuis labelMap (cache enrichi),\r\n * puis fait un fallback vers TreeBranchLeafNode si n\u00E9cessaire.\r\n * \r\n * @param nodeId - ID du n\u0153ud\r\n * @param prisma - Instance Prisma Client\r\n * @param labelMap - Map des labels (d\u00E9j\u00E0 enrichie par enrichDataFromSubmission)\r\n * @returns Label du n\u0153ud ou \"Inconnu\" si non trouv\u00E9\r\n * \r\n * @example\r\n * await getNodeLabel(\"702d1b09...\", prisma, labelMap) \u2192 \"Prix Kw/h\"\r\n */\r\nasync function getNodeLabel(\r\n  nodeId: string,\r\n  prisma: PrismaClient,\r\n  labelMap?: Map<string, string>\r\n): Promise<string> {\r\n  // \uD83C\uDFAF PRIORIT\u00C9 1: V\u00E9rifier dans labelMap si fourni\r\n  if (labelMap && labelMap.has(nodeId)) {\r\n    const label = labelMap.get(nodeId);\r\n    return label || 'Inconnu';\r\n  }\r\n  \r\n  // \uD83C\uDFAF PRIORIT\u00C9 2: Requ\u00EAte Prisma (fallback rare)\r\n  const node = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { label: true }\r\n  });\r\n  \r\n  return node?.label || 'Inconnu';\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD04 MODULE 3 : INTERPR\u00C9TATION R\u00C9CURSIVE UNIVERSELLE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDD04 FONCTION R\u00C9CURSIVE UNIVERSELLE - C\u0152UR DU SYST\u00C8ME\r\n * \r\n * C'est LA fonction centrale qui interpr\u00E8te n'importe quelle r\u00E9f\u00E9rence TBL.\r\n * Elle agit comme un dispatcher intelligent qui :\r\n * \r\n * 1. \uD83D\uDD0D Identifie le type de la r\u00E9f\u00E9rence\r\n * 2. \uD83C\uDFAF V\u00E9rifie si d\u00E9j\u00E0 calcul\u00E9e (cache)\r\n * 3. \uD83C\uDFAC D\u00E9l\u00E8gue \u00E0 l'interpr\u00E9teur appropri\u00E9\r\n * 4. \uD83D\uDCBE Met en cache le r\u00E9sultat\r\n * 5. \uD83D\uDCE4 Retourne le r\u00E9sultat structur\u00E9\r\n * \r\n * R\u00C9CURSIVIT\u00C9 :\r\n * -------------\r\n * Cette fonction s'appelle elle-m\u00EAme indirectement via les interpr\u00E9teurs\r\n * sp\u00E9cifiques (interpretCondition, interpretFormula, etc.), permettant\r\n * de r\u00E9soudre des structures imbriqu\u00E9es infiniment complexes.\r\n * \r\n * PROTECTION :\r\n * ------------\r\n * - Limite de profondeur (depth > 10) pour \u00E9viter boucles infinies\r\n * - Cache (valuesCache) pour \u00E9viter recalculs multiples\r\n * \r\n * @param ref - R\u00E9f\u00E9rence \u00E0 interpr\u00E9ter (peut \u00EAtre n'importe quel format)\r\n * @param submissionId - ID de la soumission en cours\r\n * @param prisma - Instance Prisma Client\r\n * @param valuesCache - Cache des valeurs d\u00E9j\u00E0 calcul\u00E9es (\u00E9vite boucles)\r\n * @param depth - Profondeur de r\u00E9cursion actuelle (protection)\r\n * @param valueMap - Map des valeurs (mode preview ou enrichie)\r\n * @param labelMap - Map des labels (enrichie automatiquement)\r\n * @returns R\u00E9sultat interpr\u00E9t\u00E9 avec valeur, texte et d\u00E9tails\r\n * \r\n * @example\r\n * // Cas simple : champ\r\n * await interpretReference(\"702d1b09...\", \"tbl-xxx\", prisma)\r\n * \u2192 { result: \"1450\", humanText: \"Prix Kw/h(1450)\", details: {...} }\r\n * \r\n * // Cas complexe : condition qui contient une formule\r\n * await interpretReference(\"condition:ff05cc48...\", \"tbl-xxx\", prisma)\r\n * \u2192 R\u00E9sout r\u00E9cursivement toute la structure\r\n */\r\nasync function interpretReference(\r\n  ref: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valuesCache: Map<string, InterpretResult> = new Map(),\r\n  depth: number = 0,\r\n  valueMap?: Map<string, unknown>,\r\n  labelMap?: Map<string, string>\r\n): Promise<InterpretResult> {\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDEE1\uFE0F \u00C9TAPE 1 : Protection contre r\u00E9cursion infinie\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  if (depth > 10) {\r\n    console.error(`[INTERPR\u00C9TATION] \u274C R\u00E9cursion trop profonde (depth=${depth}) pour ref:`, ref);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: '\u26A0\uFE0F R\u00E9cursion trop profonde',\r\n      details: {\r\n        type: 'error',\r\n        error: 'Max depth exceeded',\r\n        depth\r\n      }\r\n    };\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83C\uDFAF \u00C9TAPE 2 : V\u00E9rifier le cache\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const cleanRef = normalizeRef(ref);\r\n  \r\n  if (valuesCache.has(cleanRef)) {\r\n    console.log(`[INTERPR\u00C9TATION] \u267B\uFE0F Cache hit pour ref: ${cleanRef}`);\r\n    return valuesCache.get(cleanRef)!;\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDD0D \u00C9TAPE 3 : Identifier le type de r\u00E9f\u00E9rence\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const type = identifyReferenceType(ref);\r\n  console.log(`[INTERPR\u00C9TATION] \uD83D\uDD0D Type identifi\u00E9: ${type} pour ref: ${ref} (depth=${depth})`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83C\uDFAC \u00C9TAPE 4 : D\u00E9l\u00E9guer \u00E0 l'interpr\u00E9teur appropri\u00E9\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  let result: InterpretResult;\r\n  \r\n  try {\r\n    switch (type) {\r\n      case 'condition':\r\n        console.log(`[INTERPR\u00C9TATION] \uD83D\uDD00 D\u00E9l\u00E9gation vers interpretCondition`);\r\n        result = await interpretCondition(cleanRef, submissionId, prisma, valuesCache, depth, valueMap, labelMap);\r\n        break;\r\n      \r\n      case 'formula':\r\n        console.log(`[INTERPR\u00C9TATION] \uD83E\uDDEE D\u00E9l\u00E9gation vers interpretFormula`);\r\n        result = await interpretFormula(cleanRef, submissionId, prisma, valuesCache, depth, valueMap, labelMap);\r\n        break;\r\n      \r\n      case 'table':\r\n        console.log(`[INTERPR\u00C9TATION] \uD83D\uDCCA D\u00E9l\u00E9gation vers interpretTable`);\r\n        result = await interpretTable(cleanRef, submissionId, prisma, valuesCache, depth, valueMap, labelMap);\r\n        break;\r\n      \r\n      case 'field':\r\n        console.log(`[INTERPR\u00C9TATION] \uD83D\uDCDD D\u00E9l\u00E9gation vers interpretField`);\r\n        result = await interpretField(cleanRef, submissionId, prisma, valueMap, labelMap);\r\n        break;\r\n      \r\n      default:\r\n        console.error(`[INTERPR\u00C9TATION] \u274C Type inconnu: ${type}`);\r\n        result = {\r\n          result: '\u2205',\r\n          humanText: `Type inconnu: ${type}`,\r\n          details: { type: 'error', error: 'Unknown type' }\r\n        };\r\n    }\r\n  } catch (error) {\r\n    // Gestion des erreurs d'interpr\u00E9tation\r\n    console.error(`[INTERPR\u00C9TATION] \u274C Erreur lors de l'interpr\u00E9tation:`, error);\r\n    result = {\r\n      result: '\u2205',\r\n      humanText: `Erreur: ${error instanceof Error ? error.message : 'Inconnue'}`,\r\n      details: {\r\n        type: 'error',\r\n        error: error instanceof Error ? error.message : String(error)\r\n      }\r\n    };\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCBE \u00C9TAPE 5 : Mettre en cache le r\u00E9sultat\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  valuesCache.set(cleanRef, result);\r\n  console.log(`[INTERPR\u00C9TATION] \u2705 R\u00E9sultat mis en cache pour: ${cleanRef} = ${result.result}`);\r\n  \r\n  return result;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD00 MODULE 4 : INTERPR\u00C9TATION DES CONDITIONS\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDD00 INTERPR\u00C8TE UNE CONDITION (Si...Alors...Sinon)\r\n * \r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * \uD83C\uDFAF FONCTIONNEMENT CL\u00C9S :\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * Cette fonction \u00E9value une condition logique ET INTERPR\u00C8TE LES DEUX BRANCHES\r\n * (ALORS + SINON) pour fournir un r\u00E9sultat complet et transparent.\r\n * \r\n * \u26A0\uFE0F DIFF\u00C9RENCE AVEC L'ANCIENNE VERSION :\r\n * ----------------------------------------\r\n * AVANT : On interpr\u00E9tait SEULEMENT la branche s\u00E9lectionn\u00E9e\r\n *         \u2192 Texte incomplet : \"Si X; ALORS: Y = result\"\r\n * \r\n * MAINTENANT : On interpr\u00E8te LES DEUX branches syst\u00E9matiquement\r\n *              \u2192 Texte complet : \"Si X; ALORS: Y = result1; SINON: Z = result2 \u2192 [ALORS S\u00C9LECTIONN\u00C9]\"\r\n * \r\n * \uD83D\uDCCA EXEMPLE CONCRET :\r\n * --------------------\r\n * Condition : Si \"Prix Kw/h\" est vide\r\n * ALORS : Calcul automatique = 1250 / 5000 = 0.25\r\n * SINON : Utiliser la valeur saisie = Prix Kw/h\r\n * \r\n * R\u00E9sultat affich\u00E9 :\r\n * \"Si Prix Kw/h(\u2205) est vide; \r\n *  ALORS: Calcul du prix Kw/h(1250)/Consommation(5000) = 0.25; \r\n *  SINON: Prix Kw/h(150) = 150 \r\n *  \u2192 [ALORS S\u00C9LECTIONN\u00C9] Result = 0.25\"\r\n * \r\n * \uD83D\uDD04 PROCESSUS D\u00C9TAILL\u00C9 :\r\n * -----------------------\r\n * 1. \uD83D\uDCE5 R\u00E9cup\u00E9rer la condition depuis TreeBranchLeafNodeCondition\r\n * 2. \uD83D\uDD0D Extraire le WHEN (left op right)\r\n * 3. \uD83D\uDCCA R\u00E9cup\u00E9rer les valeurs LEFT et RIGHT\r\n *    - LEFT : Valeur du champ test\u00E9 (ex: Prix Kw/h)\r\n *    - RIGHT : Valeur de comparaison (fixe ou r\u00E9f\u00E9rence)\r\n * 4. \u2696\uFE0F \u00C9valuer l'op\u00E9rateur (isEmpty, eq, gt, etc.)\r\n * 5. \uD83C\uDFAF D\u00E9terminer quelle branche est vraie (ALORS ou SINON)\r\n * 6. \uD83D\uDD04 **INTERPR\u00C9TER LES DEUX BRANCHES** (nouvelle logique)\r\n *    - Interpr\u00E9ter la branche ALORS (peut \u00EAtre formule/table/champ/condition)\r\n *    - Interpr\u00E9ter la branche SINON (idem)\r\n * 7. \uD83D\uDCDD Construire le texte humain COMPLET avec les deux r\u00E9sultats\r\n * 8. \uD83D\uDCE4 Retourner le r\u00E9sultat de la branche s\u00E9lectionn\u00E9e + texte explicatif\r\n * \r\n * \uD83C\uDFD7\uFE0F STRUCTURE D'UNE CONDITION :\r\n * -------------------------------\r\n * {\r\n *   branches: [{\r\n *     when: { \r\n *       op: \"isEmpty\",               // Op\u00E9rateur : isEmpty, eq, gt, etc.\r\n *       left: {ref: \"@value.xxx\"}    // R\u00E9f\u00E9rence au champ test\u00E9\r\n *     },\r\n *     actions: [{ \r\n *       type: \"SHOW\", \r\n *       nodeIds: [\"node-formula:yyy\"] // Action si condition VRAIE\r\n *     }]\r\n *   }],\r\n *   fallback: {\r\n *     actions: [{ \r\n *       type: \"SHOW\", \r\n *       nodeIds: [\"zzz\"]              // Action si condition FAUSSE\r\n *     }]\r\n *   }\r\n * }\r\n * \r\n * \uD83C\uDFA8 FORMAT DU TEXTE G\u00C9N\u00C9R\u00C9 :\r\n * ---------------------------\r\n * \"Si {condition}; ALORS: {texte_alors}; SINON: {texte_sinon} \u2192 [{branche} S\u00C9LECTIONN\u00C9] Result = {r\u00E9sultat}\"\r\n * \r\n * Note: Les humanText des branches contiennent d\u00E9j\u00E0 leur r\u00E9sultat\r\n *       (ex: \"expression = 0.25\"), donc on ne rajoute PAS \"= result\" apr\u00E8s !\r\n * \r\n * \uD83D\uDCE6 RETOUR :\r\n * -----------\r\n * {\r\n *   result: \"0.25\",                    // R\u00E9sultat de la branche s\u00E9lectionn\u00E9e\r\n *   humanText: \"Si ... ALORS: ... SINON: ... \u2192 [ALORS S\u00C9LECTIONN\u00C9]\",\r\n *   details: {\r\n *     type: 'condition',\r\n *     conditionId: \"...\",\r\n *     branchUsed: \"ALORS\",             // Branche qui a \u00E9t\u00E9 utilis\u00E9e\r\n *     alorsResult: {...},              // D\u00E9tails du r\u00E9sultat ALORS\r\n *     sinonResult: {...},              // D\u00E9tails du r\u00E9sultat SINON\r\n *     selectedResult: {...}            // D\u00E9tails du r\u00E9sultat s\u00E9lectionn\u00E9\r\n *   }\r\n * }\r\n * \r\n * @param conditionId - ID de la condition (avec ou sans pr\u00E9fixe \"condition:\")\r\n * @param submissionId - ID de la soumission (ou \"preview-xxx\" en mode aper\u00E7u)\r\n * @param prisma - Instance Prisma Client pour acc\u00E8s BDD\r\n * @param valuesCache - Cache des valeurs d\u00E9j\u00E0 calcul\u00E9es (\u00E9vite recalculs)\r\n * @param depth - Profondeur de r\u00E9cursion (protection contre boucles infinies)\r\n * @param valueMap - Map optionnelle des valeurs en preview (cl\u00E9=nodeId, valeur=valeur)\r\n * @param labelMap - Map optionnelle des labels (cl\u00E9=nodeId, valeur=label)\r\n * @returns R\u00E9sultat interpr\u00E9t\u00E9 avec les deux branches \u00E9valu\u00E9es\r\n */\r\nasync function interpretCondition(\r\n  conditionId: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valuesCache: Map<string, InterpretResult>,\r\n  depth: number,\r\n  valueMap?: Map<string, unknown>,\r\n  labelMap?: Map<string, string>\r\n): Promise<InterpretResult> {\r\n  \r\n  console.log(`[CONDITION] \uD83D\uDD00 D\u00E9but interpr\u00E9tation condition: ${conditionId}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE5 \u00C9TAPE 1 : R\u00E9cup\u00E9rer la condition depuis la base de donn\u00E9es\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const cleanId = conditionId.replace('condition:', '');\r\n  \r\n  const condition = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n    where: { id: cleanId },\r\n    select: {\r\n      id: true,\r\n      name: true,\r\n      conditionSet: true,\r\n      nodeId: true\r\n    }\r\n  });\r\n  \r\n  if (!condition) {\r\n    console.error(`[CONDITION] \u274C Condition introuvable: ${conditionId}`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Condition introuvable: ${conditionId}`,\r\n      details: { type: 'condition', error: 'Not found' }\r\n    };\r\n  }\r\n  \r\n  console.log(`[CONDITION] \u2705 Condition trouv\u00E9e: ${condition.name}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDD0D \u00C9TAPE 2 : Extraire la structure WHEN et les branches\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const condSet = condition.conditionSet as any;\r\n  const branch = condSet.branches?.[0];\r\n  const when = branch?.when;\r\n  \r\n  if (!when) {\r\n    console.error(`[CONDITION] \u274C Structure WHEN manquante`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: 'Structure condition invalide',\r\n      details: { type: 'condition', error: 'Missing WHEN' }\r\n    };\r\n  }\r\n  \r\n  console.log(`[CONDITION] \uD83D\uDD0D WHEN extrait:`, JSON.stringify(when));\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCCA \u00C9TAPE 3 : R\u00E9cup\u00E9rer la valeur LEFT (c\u00F4t\u00E9 gauche de la condition)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const leftRef = when.left?.ref;\r\n  let leftValue: string | null = null;\r\n  let leftLabel = 'Inconnu';\r\n  \r\n  if (leftRef) {\r\n    const leftNodeId = leftRef.replace('@value.', '');\r\n    leftValue = await getNodeValue(leftNodeId, submissionId, prisma, valueMap);\r\n    leftLabel = await getNodeLabel(leftNodeId, prisma, labelMap);\r\n    console.log(`[CONDITION] \uD83D\uDCCA LEFT: ${leftLabel} = ${leftValue}`);\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCCA \u00C9TAPE 4 : R\u00E9cup\u00E9rer la valeur RIGHT (c\u00F4t\u00E9 droit de la condition)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const rightRef = when.right?.ref;\r\n  let rightValue: string | null = null;\r\n  let rightLabel = 'Inconnu';\r\n  \r\n  if (rightRef) {\r\n    // C'est une r\u00E9f\u00E9rence \u00E0 un autre champ\r\n    const rightNodeId = rightRef.replace('@value.', '');\r\n    rightValue = await getNodeValue(rightNodeId, submissionId, prisma, valueMap);\r\n    rightLabel = await getNodeLabel(rightNodeId, prisma, labelMap);\r\n    console.log(`[CONDITION] \uD83D\uDCCA RIGHT (ref): ${rightLabel} = ${rightValue}`);\r\n  } else if (when.right?.value !== undefined) {\r\n    // C'est une valeur fixe\r\n    rightValue = String(when.right.value);\r\n    rightLabel = rightValue;\r\n    console.log(`[CONDITION] \uD83D\uDCCA RIGHT (value): ${rightValue}`);\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \u2696\uFE0F \u00C9TAPE 5 : \u00C9valuer l'op\u00E9rateur\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const operator = when.op;\r\n  const conditionMet = evaluateOperator(operator, leftValue, rightValue);\r\n  \r\n  console.log(`[CONDITION] \u2696\uFE0F \u00C9valuation: ${leftValue} ${operator} ${rightValue} = ${conditionMet}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83C\uDFAF \u00C9TAPE 6 : D\u00E9terminer quelle branche est vraie\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const _selectedBranch = conditionMet ? branch : condSet.fallback;\r\n  const branchName = conditionMet ? 'ALORS' : 'SINON';\r\n  \r\n  console.log(`[CONDITION] \uD83C\uDFAF Branche s\u00E9lectionn\u00E9e: ${branchName}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDD04 \u00C9TAPE 7 : Interpr\u00E9ter LES DEUX BRANCHES (ALORS + SINON)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  \r\n  // \uD83D\uDCCC Interpr\u00E9ter la branche ALORS\r\n  let alorsResult: InterpretResult = { result: '\u2205', humanText: 'Aucune action' };\r\n  \r\n  if (branch && branch.actions && branch.actions.length > 0) {\r\n    const alorsAction = branch.actions[0];\r\n    const alorsNodeId = alorsAction.nodeIds?.[0];\r\n    \r\n    if (alorsNodeId) {\r\n      console.log(`[CONDITION] \uD83D\uDD04 Interpr\u00E9tation branche ALORS: ${alorsNodeId}`);\r\n      alorsResult = await interpretReference(\r\n        alorsNodeId,\r\n        submissionId,\r\n        prisma,\r\n        valuesCache,\r\n        depth + 1,\r\n        valueMap,\r\n        labelMap\r\n      );\r\n      console.log(`[CONDITION] \u2705 R\u00E9sultat ALORS: ${alorsResult.result}`);\r\n    }\r\n  }\r\n  \r\n  // \uD83D\uDCCC Interpr\u00E9ter la branche SINON\r\n  let sinonResult: InterpretResult = { result: '\u2205', humanText: 'Aucune action' };\r\n  \r\n  if (condSet.fallback && condSet.fallback.actions && condSet.fallback.actions.length > 0) {\r\n    const sinonAction = condSet.fallback.actions[0];\r\n    const sinonNodeId = sinonAction.nodeIds?.[0];\r\n    \r\n    if (sinonNodeId) {\r\n      console.log(`[CONDITION] \uD83D\uDD04 Interpr\u00E9tation branche SINON: ${sinonNodeId}`);\r\n      sinonResult = await interpretReference(\r\n        sinonNodeId,\r\n        submissionId,\r\n        prisma,\r\n        valuesCache,\r\n        depth + 1,\r\n        valueMap,\r\n        labelMap\r\n      );\r\n      console.log(`[CONDITION] \u2705 R\u00E9sultat SINON: ${sinonResult.result}`);\r\n    }\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCDD \u00C9TAPE 8 : Construire le texte humain COMPLET (les 2 branches)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const operatorText = getOperatorText(operator);\r\n  const leftDisplay = `${leftLabel}(${leftValue || '\u2205'})`;\r\n  const rightDisplay = rightLabel !== 'Inconnu' ? `${rightLabel}` : '';\r\n  \r\n  // Construction de la condition\r\n  const conditionText = rightDisplay \r\n    ? `Si ${leftDisplay} ${operatorText} ${rightDisplay}`\r\n    : `Si ${leftDisplay} ${operatorText}`;\r\n  \r\n  // Construction du texte avec les DEUX branches + indication de la branche s\u00E9lectionn\u00E9e\r\n  // Note: alorsResult.humanText et sinonResult.humanText contiennent d\u00E9j\u00E0 le r\u00E9sultat (ex: \"expression = 0.25\")\r\n  const humanText = `${conditionText}; ` +\r\n    `ALORS: ${alorsResult.humanText}; ` +\r\n    `SINON: ${sinonResult.humanText} ` +\r\n    `\u2192 [${branchName} S\u00C9LECTIONN\u00C9] Result = ${conditionMet ? alorsResult.result : sinonResult.result}`;\r\n  \r\n  console.log(`[CONDITION] \uD83D\uDCDD Texte g\u00E9n\u00E9r\u00E9: ${humanText}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE4 \u00C9TAPE 9 : Retourner le r\u00E9sultat structur\u00E9 avec le r\u00E9sultat de la branche s\u00E9lectionn\u00E9e\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const finalResult = conditionMet ? alorsResult.result : sinonResult.result;\r\n  \r\n  return {\r\n    result: finalResult,\r\n    humanText,\r\n    details: {\r\n      type: 'condition',\r\n      conditionId: condition.id,\r\n      conditionName: condition.name,\r\n      when: {\r\n        left: { ref: leftRef, label: leftLabel, value: leftValue },\r\n        operator: operator,\r\n        right: { ref: rightRef, label: rightLabel, value: rightValue },\r\n        evaluated: conditionMet\r\n      },\r\n      branchUsed: branchName,\r\n      alorsResult: alorsResult.details,\r\n      sinonResult: sinonResult.details,\r\n      selectedResult: conditionMet ? alorsResult.details : sinonResult.details\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * \u2696\uFE0F \u00C9value un op\u00E9rateur de condition\r\n * \r\n * OP\u00C9RATEURS SUPPORT\u00C9S :\r\n * ----------------------\r\n * - isEmpty      : V\u00E9rifie si vide (null, undefined, '')\r\n * - isNotEmpty   : V\u00E9rifie si non vide\r\n * - eq (==)      : \u00C9galit\u00E9 stricte\r\n * - ne (!=)      : Diff\u00E9rent\r\n * - gt (>)       : Sup\u00E9rieur (num\u00E9rique)\r\n * - gte (>=)     : Sup\u00E9rieur ou \u00E9gal\r\n * - lt (<)       : Inf\u00E9rieur\r\n * - lte (<=)     : Inf\u00E9rieur ou \u00E9gal\r\n * \r\n * @param op - Op\u00E9rateur \u00E0 \u00E9valuer\r\n * @param left - Valeur de gauche\r\n * @param right - Valeur de droite\r\n * @returns true si condition vraie, false sinon\r\n */\r\nfunction evaluateOperator(op: string, left: any, right: any): boolean {\r\n  switch (op) {\r\n    case 'isEmpty':\r\n      return left === null || left === undefined || left === '';\r\n    \r\n    case 'isNotEmpty':\r\n      return left !== null && left !== undefined && left !== '';\r\n    \r\n    case 'eq':\r\n    case '==':\r\n      return left === right;\r\n    \r\n    case 'ne':\r\n    case '!=':\r\n      return left !== right;\r\n    \r\n    case 'gt':\r\n    case '>':\r\n      return Number(left) > Number(right);\r\n    \r\n    case 'gte':\r\n    case '>=':\r\n      return Number(left) >= Number(right);\r\n    \r\n    case 'lt':\r\n    case '<':\r\n      return Number(left) < Number(right);\r\n    \r\n    case 'lte':\r\n    case '<=':\r\n      return Number(left) <= Number(right);\r\n    \r\n    default:\r\n      console.warn(`[CONDITION] \u26A0\uFE0F Op\u00E9rateur inconnu: ${op}`);\r\n      return false;\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83D\uDCDD Traduit un op\u00E9rateur en texte humain fran\u00E7ais\r\n * \r\n * @param op - Op\u00E9rateur technique\r\n * @returns Texte en fran\u00E7ais\r\n */\r\nfunction getOperatorText(op: string): string {\r\n  const texts: Record<string, string> = {\r\n    'isEmpty': 'est vide',\r\n    'isNotEmpty': \"n'est pas vide\",\r\n    'eq': '=',\r\n    'ne': '\u2260',\r\n    'gt': '>',\r\n    'gte': '\u2265',\r\n    'lt': '<',\r\n    'lte': '\u2264',\r\n    '==': '=',\r\n    '!=': '\u2260'\r\n  };\r\n  \r\n  return texts[op] || op;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83E\uDDEE MODULE 5 : INTERPR\u00C9TATION DES FORMULES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83E\uDDEE INTERPR\u00C8TE UNE FORMULE (Calcul math\u00E9matique)\r\n * \r\n * Cette fonction \u00E9value une formule math\u00E9matique en r\u00E9solvant tous ses tokens.\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. \uD83D\uDCE5 R\u00E9cup\u00E9rer la formule depuis TreeBranchLeafNodeFormula\r\n * 2. \uD83D\uDD0D Parcourir les tokens un par un\r\n * 3. \uD83D\uDD04 Pour chaque @value.xxx, interpr\u00E9ter r\u00E9cursivement\r\n * 4. \uD83E\uDDEE Construire l'expression math\u00E9matique\r\n * 5. \u26A1 Calculer le r\u00E9sultat final\r\n * 6. \uD83D\uDCDD G\u00E9n\u00E9rer le texte explicatif\r\n * \r\n * FORMAT DES TOKENS :\r\n * -------------------\r\n * [\"@value.xxx\", \"/\", \"@value.yyy\"] \u2192 Champ1 / Champ2\r\n * [{ type: \"ref\", ref: \"@value.xxx\" }, \"+\", \"100\"] \u2192 Champ + 100\r\n * \r\n * @param formulaId - ID de la formule\r\n * @param submissionId - ID de la soumission\r\n * @param prisma - Instance Prisma Client\r\n * @param valuesCache - Cache des valeurs\r\n * @param depth - Profondeur de r\u00E9cursion\r\n * @returns R\u00E9sultat interpr\u00E9t\u00E9\r\n */\r\nasync function interpretFormula(\r\n  formulaId: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valuesCache: Map<string, InterpretResult>,\r\n  depth: number,\r\n  valueMap?: Map<string, unknown>,\r\n  labelMap?: Map<string, string>\r\n): Promise<InterpretResult> {\r\n  \r\n  console.log(`[FORMULE] \uD83E\uDDEE D\u00E9but interpr\u00E9tation formule: ${formulaId}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE5 \u00C9TAPE 1 : R\u00E9cup\u00E9rer la formule depuis la base de donn\u00E9es\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const cleanId = formulaId.replace('node-formula:', '');\r\n  \r\n  let formula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n    where: { id: cleanId },\r\n    select: {\r\n      id: true,\r\n      name: true,\r\n      tokens: true,\r\n      nodeId: true\r\n    }\r\n  });\r\n  \r\n  // \uD83D\uDD0D R\u00C9SOLUTION IMPLICITE : Si pas trouv\u00E9 par ID, chercher par nodeId (formule par d\u00E9faut)\r\n  if (!formula) {\r\n    console.log(`[FORMULE] \uD83D\uDD0D Formule introuvable par ID, tentative r\u00E9solution par nodeId: ${cleanId}`);\r\n    try {\r\n      const byNode = await prisma.treeBranchLeafNodeFormula.findFirst({\r\n        where: { nodeId: cleanId },\r\n        select: { id: true, name: true, tokens: true, nodeId: true },\r\n        orderBy: { isDefault: 'desc' }\r\n      });\r\n      if (byNode) {\r\n        formula = byNode;\r\n        console.log(`[FORMULE] \u2705 Formule r\u00E9solue via nodeId \u2192 formula:${formula.id}`);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[FORMULE] \u26A0\uFE0F R\u00E9solution implicite \u00E9chou\u00E9e:', e instanceof Error ? e.message : e);\r\n    }\r\n  }\r\n  \r\n  if (!formula) {\r\n    console.error(`[FORMULE] \u274C Formule introuvable: ${formulaId}`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Formule introuvable: ${formulaId}`,\r\n      details: { type: 'formula', error: 'Not found' }\r\n    };\r\n  }\r\n  \r\n  console.log(`[FORMULE] \u2705 Formule trouv\u00E9e: ${formula.name}`);\r\n  \r\n  const tokens = formula.tokens as any[];\r\n  console.log(`[FORMULE] \uD83D\uDCCB Tokens:`, JSON.stringify(tokens));\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDD0D \u00C9TAPE 2 : Parcourir et interpr\u00E9ter les tokens\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  let expression = '';        // Expression math\u00E9matique pure (ex: \"1450/1000\")\r\n  let humanExpression = '';   // Expression avec labels (ex: \"Prix(1450)/Conso(1000)\")\r\n  const tokenDetails = [];    // D\u00E9tails de chaque token pour tra\u00E7abilit\u00E9\r\n  \r\n  for (let i = 0; i < tokens.length; i++) {\r\n    const token = tokens[i];\r\n    console.log(`[FORMULE] \uD83D\uDD0D Token ${i}:`, token);\r\n    \r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // CAS 1 : Token est une STRING (format: \"@value.xxx\" ou op\u00E9rateur)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    if (typeof token === 'string') {\r\n      \r\n      // V\u00E9rifier si c'est une r\u00E9f\u00E9rence\r\n      if (token.includes('@value.')) {\r\n        // \uD83D\uDD04 R\u00C9CURSION : Interpr\u00E9ter la r\u00E9f\u00E9rence\r\n        const refMatch = token.match(/@value\\.([A-Za-z0-9_:-]+)/);\r\n        if (refMatch) {\r\n          const ref = refMatch[1];\r\n          console.log(`[FORMULE] \uD83D\uDD04 Interpr\u00E9tation r\u00E9cursive de: ${ref}`);\r\n          \r\n          const refResult = await interpretReference(\r\n            ref,\r\n            submissionId,\r\n            prisma,\r\n            valuesCache,\r\n            depth + 1,  // \u26A0\uFE0F IMPORTANT : Incr\u00E9menter la profondeur\r\n            valueMap,\r\n            labelMap\r\n          );\r\n          \r\n          const label = await getNodeLabel(ref, prisma, labelMap);\r\n          \r\n          expression += refResult.result;\r\n          humanExpression += `${label}(${refResult.result})`;\r\n          \r\n          tokenDetails.push({\r\n            type: 'reference',\r\n            ref,\r\n            label,\r\n            value: refResult.result,\r\n            details: refResult.details\r\n          });\r\n          \r\n          console.log(`[FORMULE] \u2705 R\u00E9f\u00E9rence r\u00E9solue: ${label} = ${refResult.result}`);\r\n        }\r\n      } else {\r\n        // C'est un op\u00E9rateur ou nombre\r\n        expression += token;\r\n        humanExpression += token;\r\n        tokenDetails.push({ type: 'operator', value: token });\r\n        console.log(`[FORMULE] \u2795 Op\u00E9rateur ajout\u00E9: ${token}`);\r\n      }\r\n    }\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // CAS 2 : Token est un OBJECT (format: { type: \"ref\", ref: \"...\" })\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    else if (token && typeof token === 'object' && token.type === 'ref') {\r\n      const ref = token.ref.replace('@value.', '');\r\n      console.log(`[FORMULE] \uD83D\uDD04 Interpr\u00E9tation r\u00E9cursive de (object): ${ref}`);\r\n      \r\n      const refResult = await interpretReference(\r\n        ref,\r\n        submissionId,\r\n        prisma,\r\n        valuesCache,\r\n        depth + 1,\r\n        valueMap,\r\n        labelMap\r\n      );\r\n      \r\n      const label = await getNodeLabel(ref, prisma, labelMap);\r\n      \r\n      expression += refResult.result;\r\n      humanExpression += `${label}(${refResult.result})`;\r\n      \r\n      tokenDetails.push({\r\n        type: 'reference',\r\n        ref,\r\n        label,\r\n        value: refResult.result,\r\n        details: refResult.details\r\n      });\r\n      \r\n      console.log(`[FORMULE] \u2705 R\u00E9f\u00E9rence r\u00E9solue (object): ${label} = ${refResult.result}`);\r\n    }\r\n  }\r\n  \r\n  console.log(`[FORMULE] \uD83D\uDCDD Expression construite: ${expression}`);\r\n  console.log(`[FORMULE] \uD83D\uDCDD Expression humaine: ${humanExpression}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \u26A1 \u00C9TAPE 3 : Calculer le r\u00E9sultat de l'expression\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const calculatedResult = calculateExpression(expression);\r\n  console.log(`[FORMULE] \u26A1 R\u00E9sultat calcul\u00E9: ${calculatedResult}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCDD \u00C9TAPE 4 : Construire le texte humain\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const humanText = `${humanExpression} = ${calculatedResult}`;\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE4 \u00C9TAPE 5 : Retourner le r\u00E9sultat structur\u00E9\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  return {\r\n    result: String(calculatedResult),\r\n    humanText,\r\n    details: {\r\n      type: 'formula',\r\n      formulaId: formula.id,\r\n      formulaName: formula.name,\r\n      tokens: tokenDetails,\r\n      expression,\r\n      humanExpression,\r\n      calculatedResult\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * \uD83E\uDDEE Calcule une expression math\u00E9matique de mani\u00E8re s\u00E9curis\u00E9e\r\n * \r\n * S\u00C9CURIT\u00C9 :\r\n * ----------\r\n * - Nettoie l'expression (garde seulement nombres et op\u00E9rateurs)\r\n * - Utilise Function() avec \"use strict\" pour \u00E9valuation s\u00E9curis\u00E9e\r\n * - Gestion des erreurs avec fallback \u00E0 0\r\n * \r\n * OP\u00C9RATEURS SUPPORT\u00C9S :\r\n * ----------------------\r\n * +, -, *, /, (), d\u00E9cimales (.)\r\n * \r\n * @param expr - Expression \u00E0 calculer (ex: \"1450/1000\")\r\n * @returns R\u00E9sultat num\u00E9rique\r\n * \r\n * @example\r\n * calculateExpression(\"1450/1000\") \u2192 1.45\r\n * calculateExpression(\"(100+50)*2\") \u2192 300\r\n */\r\nfunction calculateExpression(expr: string): number {\r\n  try {\r\n    // Nettoyer l'expression : garde seulement chiffres et op\u00E9rateurs\r\n    const cleanExpr = expr.replace(/[^0-9+\\-*/.()]/g, '');\r\n    \r\n    console.log(`[CALCUL] \uD83E\uDDEE Expression nettoy\u00E9e: ${cleanExpr}`);\r\n    \r\n    // V\u00E9rifier si l'expression est valide (contient au moins un chiffre)\r\n    if (!/\\d/.test(cleanExpr)) {\r\n      console.log(`[CALCUL] \u26A0\uFE0F Expression invalide (aucun nombre d\u00E9tect\u00E9), retour 0`);\r\n      return 0;\r\n    }\r\n    \r\n    // \u00C9valuer de mani\u00E8re s\u00E9curis\u00E9e\r\n    const result = Function(`\"use strict\"; return (${cleanExpr})`)();\r\n    \r\n    console.log(`[CALCUL] \u2705 R\u00E9sultat: ${result}`);\r\n    \r\n    return result;\r\n  } catch (error) {\r\n    console.error(`[CALCUL] \u274C Erreur calcul expression: ${expr}`, error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCA MODULE 6 : INTERPR\u00C9TATION DES TABLES (LOOKUP)\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDCCA INTERPR\u00C8TE UNE TABLE (Lookup crois\u00E9)\r\n * \r\n * Cette fonction effectue un lookup dans une table en croisant ligne \u00D7 colonne.\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. \uD83D\uDCE5 R\u00E9cup\u00E9rer la table depuis TreeBranchLeafNodeTable\r\n * 2. \uD83D\uDD0D Extraire la config de lookup (selectors)\r\n * 3. \uD83D\uDCCA R\u00E9cup\u00E9rer les valeurs s\u00E9lectionn\u00E9es (rowFieldId, columnFieldId)\r\n * 4. \uD83C\uDFAF Trouver les index dans rows[] et columns[]\r\n * 5. \uD83D\uDCCD Faire le lookup dans data[rowIndex][colIndex]\r\n * 6. \uD83D\uDCDD G\u00E9n\u00E9rer le texte explicatif\r\n * \r\n * STRUCTURE D'UNE TABLE :\r\n * -----------------------\r\n * columns: [\"Orientation\", \"0\", \"5\", \"15\", \"25\", ...]\r\n * rows: [\"Orientation\", \"Nord\", \"Nord-Est\", ...]\r\n * data: [[86, 82, 73, ...], [86, 83, 74, ...], ...]\r\n * meta.lookup.selectors: { rowFieldId, columnFieldId }\r\n * \r\n * @param tableId - ID de la table\r\n * @param submissionId - ID de la soumission\r\n * @param prisma - Instance Prisma Client\r\n * @param valuesCache - Cache des valeurs\r\n * @param depth - Profondeur de r\u00E9cursion\r\n * @returns R\u00E9sultat interpr\u00E9t\u00E9\r\n */\r\nasync function interpretTable(\r\n  tableId: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valuesCache: Map<string, InterpretResult>,\r\n  depth: number,\r\n  valueMap?: Map<string, unknown>,\r\n  labelMap?: Map<string, string>\r\n): Promise<InterpretResult> {\r\n  \r\n  console.log(`[TABLE] \uD83D\uDCCA D\u00E9but interpr\u00E9tation table: ${tableId}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE5 \u00C9TAPE 1 : R\u00E9cup\u00E9rer la table depuis la base de donn\u00E9es\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const cleanId = tableId.replace('@table.', '').replace('node-table:', '');\r\n  \r\n  let table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n    where: { id: cleanId },\r\n    select: {\r\n      id: true,\r\n      name: true,\r\n      type: true,\r\n      rowCount: true,\r\n      columnCount: true,\r\n      meta: true,\r\n      nodeId: true,\r\n      tableColumns: {\r\n        orderBy: { columnIndex: 'asc' },\r\n        select: {\r\n          id: true,\r\n          columnIndex: true,\r\n          name: true,\r\n          type: true,\r\n          width: true,\r\n          format: true,\r\n          metadata: true\r\n        }\r\n      },\r\n      tableRows: {\r\n        orderBy: { rowIndex: 'asc' },\r\n        select: {\r\n          id: true,\r\n          rowIndex: true,\r\n          cells: true\r\n        }\r\n      }\r\n    }\r\n  });\r\n  \r\n  // \uD83D\uDD0D R\u00C9SOLUTION IMPLICITE : Si pas trouv\u00E9 par ID, chercher par nodeId (table par d\u00E9faut)\r\n  if (!table) {\r\n    console.log(`[TABLE] \uD83D\uDD0D Table introuvable par ID, tentative r\u00E9solution par nodeId: ${cleanId}`);\r\n    try {\r\n      const byNode = await prisma.treeBranchLeafNodeTable.findFirst({\r\n        where: { nodeId: cleanId },\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n          type: true,\r\n          rowCount: true,\r\n          columnCount: true,\r\n          meta: true,\r\n          nodeId: true,\r\n          tableColumns: {\r\n            orderBy: { columnIndex: 'asc' },\r\n            select: { id: true, columnIndex: true, name: true, type: true, width: true, format: true, metadata: true }\r\n          },\r\n          tableRows: {\r\n            orderBy: { rowIndex: 'asc' },\r\n            select: { id: true, rowIndex: true, cells: true }\r\n          }\r\n        },\r\n        orderBy: [{ isDefault: 'desc' }, { updatedAt: 'desc' }]\r\n      });\r\n      console.log(`[TABLE] \uD83D\uDD0D R\u00E9sultat findFirst par nodeId:`, byNode ? `TROUV\u00C9 id=${byNode.id}` : 'NULL');\r\n      if (byNode) {\r\n        table = byNode;\r\n        console.log(`[TABLE] \u2705 Table r\u00E9solue via nodeId \u2192 table:${table.id}`);\r\n      } else {\r\n        console.log(`[TABLE] \u26A0\uFE0F Aucune table avec nodeId=\"${cleanId}\" trouv\u00E9e`);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TABLE] \u26A0\uFE0F R\u00E9solution implicite \u00E9chou\u00E9e:', e instanceof Error ? e.message : e);\r\n    }\r\n  }\r\n  \r\n  if (!table) {\r\n    console.error(`[TABLE] \u274C Table introuvable: ${tableId}`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Table introuvable: ${tableId}`,\r\n      details: { type: 'table', error: 'Not found' }\r\n    };\r\n  }\r\n  \r\n  console.log(`[TABLE] \u2705 Table trouv\u00E9e: ${table.name} (type: ${table.type})`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uFFFD RECONSTRUCTION DES DONN\u00C9ES depuis la structure normalis\u00E9e\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // Reconstituer columns, rows, data depuis les relations\r\n  const columns = table.tableColumns.map(col => col.name);\r\n  const rows: string[] = [];\r\n  const data: any[][] = [];\r\n  \r\n  // \uD83D\uDD04 Parser cells avec support hybride (JSON array OU plain string)\r\n  table.tableRows.forEach(row => {\r\n    try {\r\n      let cellsData: any;\r\n      \r\n      // \uD83D\uDD0D Tentative 1: Parse JSON si c'est une string\r\n      if (typeof row.cells === 'string') {\r\n        try {\r\n          cellsData = JSON.parse(row.cells);\r\n        } catch {\r\n          // \uD83D\uDD27 Fallback: Si ce n'est PAS du JSON, c'est juste une valeur simple (premi\u00E8re colonne uniquement)\r\n          // Cela arrive pour les anciennes donn\u00E9es o\u00F9 cells = \"Orientation\" au lieu de [\"Orientation\", ...]\r\n          cellsData = [row.cells]; // Envelopper dans un array\r\n        }\r\n      } else {\r\n        cellsData = row.cells || [];\r\n      }\r\n      \r\n      // \u26A0\uFE0F IMPORTANT: IGNORER rowIndex=0 car c'est la ligne HEADER (noms de colonnes)\r\n      // Dans le nouveau syst\u00E8me normalis\u00E9, rowIndex=0 contient [\"Orientation\", \"0\u00B0\", \"5\u00B0\", ...]\r\n      // qui sont d\u00E9j\u00E0 extraits dans tableColumns\r\n      if (row.rowIndex === 0) {\r\n        console.log(`[TABLE] \uD83D\uDD0D Header row d\u00E9tect\u00E9 (rowIndex=0), ignor\u00E9. Cells:`, JSON.stringify(cellsData).substring(0, 100));\r\n        return; // Skip cette ligne\r\n      }\r\n      \r\n      if (Array.isArray(cellsData) && cellsData.length > 0) {\r\n        // \uD83D\uDD11 cellsData[0] = label de ligne (colonne A) : \"Nord\", \"Sud\", etc.\r\n        // \uD83D\uDCCA cellsData[1...] = donn\u00E9es (colonnes B, C, D...) : [86, 82, 73, ...]\r\n        const rowLabel = String(cellsData[0] || '');\r\n        const rowData = cellsData.slice(1); // Donn\u00E9es sans le label\r\n        \r\n        rows.push(rowLabel);\r\n        data.push(rowData);\r\n      } else {\r\n        rows.push(`Row ${row.rowIndex}`);\r\n        data.push([]);\r\n      }\r\n    } catch (error) {\r\n      console.error('[TABLE] \u26A0\uFE0F Erreur parsing cells:', error);\r\n      rows.push(`Row ${row.rowIndex}`);\r\n      data.push([]);\r\n    }\r\n  });\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uFFFD\uD83D\uDD0D \u00C9TAPE 2 : Extraire la configuration de lookup\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const meta = table.meta as any;\r\n  const lookup = meta?.lookup;\r\n  \r\n  if (!lookup || !lookup.enabled) {\r\n    console.error(`[TABLE] \u274C Lookup non configur\u00E9 ou d\u00E9sactiv\u00E9`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Lookup non configur\u00E9 pour table ${table.name}`,\r\n      details: { type: 'table', error: 'Lookup not enabled' }\r\n    };\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCCA \u00C9TAPE 3 : R\u00E9cup\u00E9rer les selectors (champs de s\u00E9lection) et les toggles\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const rowFieldId = lookup.selectors?.rowFieldId;\r\n  const colFieldId = lookup.selectors?.columnFieldId;\r\n  const rowEnabled = lookup.rowLookupEnabled === true;\r\n  const colEnabled = lookup.columnLookupEnabled === true;\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83C\uDFAF D\u00C9TECTION DU MODE (3 modes possibles)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  \r\n  // MODE 3 : Les DEUX toggles activ\u00E9s (syst\u00E8me existant - croisement dynamique)\r\n  if (rowEnabled && colEnabled && rowFieldId && colFieldId) {\r\n    console.log(`[TABLE] \uD83C\uDFAF MODE 3 d\u00E9tect\u00E9: Croisement dynamique COLONNE \u00D7 LIGNE`);\r\n    // Le code existant continue ici (r\u00E9cup\u00E9ration des deux valeurs + croisement)\r\n  }\r\n  \r\n  // MODE 1 : Seulement COLONNE activ\u00E9e (croisement avec displayColumn fixe)\r\n  else if (colEnabled && !rowEnabled && colFieldId && lookup.displayColumn) {\r\n    console.log(`[TABLE] \uD83C\uDFAF MODE 1 d\u00E9tect\u00E9: COLONNE \u00D7 displayColumn fixe`);\r\n    \r\n    // R\u00E9cup\u00E9rer la valeur s\u00E9lectionn\u00E9e dans le SELECT colonne\r\n    const colSelectorValue = await getNodeValue(colFieldId, submissionId, prisma, valueMap);\r\n    const colLabel = await getNodeLabel(colFieldId, prisma, labelMap);\r\n    \r\n    // displayColumn peut \u00EAtre un string OU un array\r\n    const displayColumns = Array.isArray(lookup.displayColumn) \r\n      ? lookup.displayColumn \r\n      : [lookup.displayColumn];\r\n    \r\n    if (!colSelectorValue) {\r\n      return {\r\n        result: '\u2205',\r\n        humanText: `Table \"${table.name}\" - Aucune s\u00E9lection colonne`,\r\n        details: { type: 'table', mode: 1, error: 'No column selection' }\r\n      };\r\n    }\r\n    \r\n    // Faire le lookup avec colSelectorValue et CHAQUE displayColumn\r\n    // columns, rows, data d\u00E9j\u00E0 reconstruits plus haut\r\n    \r\n    const results: Array<{ row: string; value: any }> = [];\r\n    \r\n    // Boucle sur CHAQUE ligne \u00E0 afficher\r\n    for (const fixedRowValue of displayColumns) {\r\n      // Normalisation pour matching robuste\r\n      const normalizedColSelector = String(colSelectorValue).trim().toLowerCase();\r\n      const normalizedFixedRow = String(fixedRowValue).trim().toLowerCase();\r\n      \r\n      // Chercher dans colonnes ET lignes (auto-d\u00E9tection)\r\n      const colSelectorInCols = columns.findIndex(c => String(c).trim().toLowerCase() === normalizedColSelector);\r\n      const colSelectorInRows = rows.findIndex(r => String(r).trim().toLowerCase() === normalizedColSelector);\r\n      const fixedRowInRows = rows.findIndex(r => String(r).trim().toLowerCase() === normalizedFixedRow);\r\n      const fixedRowInCols = columns.findIndex(c => String(c).trim().toLowerCase() === normalizedFixedRow);\r\n      \r\n      // D\u00E9terminer les index finaux (privil\u00E9gier le matching naturel)\r\n      let colIndex = -1;\r\n      let rowIndex = -1;\r\n      \r\n      if (colSelectorInCols !== -1 && fixedRowInRows !== -1) {\r\n        // Configuration normale\r\n        colIndex = colSelectorInCols;\r\n        rowIndex = fixedRowInRows;\r\n      } else if (colSelectorInRows !== -1 && fixedRowInCols !== -1) {\r\n        // Configuration invers\u00E9e (auto-correction)\r\n        colIndex = fixedRowInCols;\r\n        rowIndex = colSelectorInRows;\r\n        console.log(`[TABLE] \uD83D\uDD04 MODE 1 - Inversion d\u00E9tect\u00E9e et corrig\u00E9e pour ${fixedRowValue}`);\r\n      } else {\r\n        // Matching partiel\r\n        colIndex = colSelectorInCols !== -1 ? colSelectorInCols : colSelectorInRows;\r\n        rowIndex = fixedRowInRows !== -1 ? fixedRowInRows : fixedRowInCols;\r\n      }\r\n      \r\n      if (colIndex !== -1 && rowIndex !== -1) {\r\n        // Lookup dans data (avec d\u00E9calage header)\r\n        const dataRowIndex = rowIndex - 1;\r\n        const dataColIndex = colIndex - 1;\r\n        const result = data[dataRowIndex]?.[dataColIndex];\r\n        \r\n        results.push({ row: fixedRowValue, value: result });\r\n        console.log(`[TABLE] \u2705 MODE 1 - ${fixedRowValue}: ${result}`);\r\n      }\r\n    }\r\n    \r\n    // Construire le r\u00E9sultat final\r\n    const resultText = results.map(r => `${r.row}=${r.value}`).join(', ');\r\n    const resultValues = results.map(r => r.value);\r\n    const humanText = `Table \"${table.name}\"[${colLabel}=${colSelectorValue}, ${displayColumns.join('+')}(fixes)] = ${resultText}`;\r\n    \r\n    return {\r\n      result: resultValues.length === 1 ? String(resultValues[0]) : JSON.stringify(resultValues),\r\n      humanText,\r\n      details: {\r\n        type: 'table',\r\n        mode: 1,\r\n        tableId: table.id,\r\n        tableName: table.name,\r\n        lookup: {\r\n          column: { field: colLabel, value: colSelectorValue },\r\n          rows: results,\r\n          multiple: results.length > 1\r\n        }\r\n      }\r\n    };\r\n  }\r\n  \r\n  // MODE 2 : Seulement LIGNE activ\u00E9e (croisement avec displayRow fixe)\r\n  else if (rowEnabled && !colEnabled && rowFieldId && lookup.displayRow) {\r\n    console.log(`[TABLE] \uD83C\uDFAF MODE 2 d\u00E9tect\u00E9: displayRow fixe \u00D7 LIGNE`);\r\n    \r\n    // R\u00E9cup\u00E9rer la valeur s\u00E9lectionn\u00E9e dans le SELECT ligne\r\n    const rowSelectorValue = await getNodeValue(rowFieldId, submissionId, prisma, valueMap);\r\n    const rowLabel = await getNodeLabel(rowFieldId, prisma, labelMap);\r\n    \r\n    // displayRow peut \u00EAtre un string OU un array\r\n    const displayRows = Array.isArray(lookup.displayRow) \r\n      ? lookup.displayRow \r\n      : [lookup.displayRow];\r\n    \r\n    console.log(`[TABLE] \uD83D\uDCCA MODE 2 - Croisement: ligne=${rowLabel}(${rowSelectorValue}) \u00D7 colonnes=${displayRows.join(', ')} (fixes)`);\r\n    \r\n    if (!rowSelectorValue) {\r\n      return {\r\n        result: '\u2205',\r\n        humanText: `Table \"${table.name}\" - Aucune s\u00E9lection ligne`,\r\n        details: { type: 'table', mode: 2, error: 'No row selection' }\r\n      };\r\n    }\r\n    \r\n    // Faire le lookup avec rowSelectorValue et CHAQUE displayRow\r\n    // columns, rows, data d\u00E9j\u00E0 reconstruits plus haut\r\n    \r\n    const results: Array<{ column: string; value: any }> = [];\r\n    \r\n    // Boucle sur CHAQUE colonne \u00E0 afficher\r\n    for (const fixedColValue of displayRows) {\r\n      // Normalisation\r\n      const normalizedRowSelector = String(rowSelectorValue).trim().toLowerCase();\r\n      const normalizedFixedCol = String(fixedColValue).trim().toLowerCase();\r\n      \r\n      // Chercher dans colonnes ET lignes (auto-d\u00E9tection)\r\n      const rowSelectorInRows = rows.findIndex(r => String(r).trim().toLowerCase() === normalizedRowSelector);\r\n      const rowSelectorInCols = columns.findIndex(c => String(c).trim().toLowerCase() === normalizedRowSelector);\r\n      const fixedColInCols = columns.findIndex(c => String(c).trim().toLowerCase() === normalizedFixedCol);\r\n      const fixedColInRows = rows.findIndex(r => String(r).trim().toLowerCase() === normalizedFixedCol);\r\n      \r\n      // D\u00E9terminer les index finaux (privil\u00E9gier le matching naturel)\r\n      let rowIndex = -1;\r\n      let colIndex = -1;\r\n      \r\n      if (rowSelectorInRows !== -1 && fixedColInCols !== -1) {\r\n        // Configuration normale\r\n        rowIndex = rowSelectorInRows;\r\n        colIndex = fixedColInCols;\r\n      } else if (rowSelectorInCols !== -1 && fixedColInRows !== -1) {\r\n        // Configuration invers\u00E9e (auto-correction)\r\n        rowIndex = fixedColInRows;\r\n        colIndex = rowSelectorInCols;\r\n        console.log(`[TABLE] \uD83D\uDD04 MODE 2 - Inversion d\u00E9tect\u00E9e et corrig\u00E9e pour ${fixedColValue}`);\r\n      } else {\r\n        // Matching partiel\r\n        rowIndex = rowSelectorInRows !== -1 ? rowSelectorInRows : rowSelectorInCols;\r\n        colIndex = fixedColInCols !== -1 ? fixedColInCols : fixedColInRows;\r\n      }\r\n      \r\n      if (rowIndex !== -1 && colIndex !== -1) {\r\n        // Lookup dans data\r\n        const dataRowIndex = rowIndex - 1;\r\n        const dataColIndex = colIndex - 1;\r\n        const result = data[dataRowIndex]?.[dataColIndex];\r\n        \r\n        results.push({ column: fixedColValue, value: result });\r\n        console.log(`[TABLE] \u2705 MODE 2 - ${fixedColValue}: ${result}`);\r\n      }\r\n    }\r\n    \r\n    // Construire le r\u00E9sultat final\r\n    const resultText = results.map(r => `${r.column}=${r.value}`).join(', ');\r\n    const resultValues = results.map(r => r.value);\r\n    const humanText = `Table \"${table.name}\"[${rowLabel}=${rowSelectorValue}, ${displayRows.join('+')}(fixes)] = ${resultText}`;\r\n    \r\n    return {\r\n      result: resultValues.length === 1 ? String(resultValues[0]) : JSON.stringify(resultValues),\r\n      humanText,\r\n      details: {\r\n        type: 'table',\r\n        mode: 2,\r\n        tableId: table.id,\r\n        tableName: table.name,\r\n        lookup: {\r\n          row: { field: rowLabel, value: rowSelectorValue },\r\n          columns: results,\r\n          multiple: results.length > 1\r\n        }\r\n      }\r\n    };\r\n  }\r\n  \r\n  // \u274C Configuration invalide\r\n  else {\r\n    console.error(`[TABLE] \u274C Configuration lookup invalide`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Configuration lookup invalide pour table ${table.name}`,\r\n      details: { type: 'table', error: 'Invalid configuration' }\r\n    };\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCCA MODE 3 : Code existant (croisement dynamique colonne \u00D7 ligne)\r\n  // Ce code s'ex\u00E9cute SEULEMENT si on est en MODE 3\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  console.log(`[TABLE] \uD83D\uDCCB Selectors MODE 3: row=${rowFieldId}, col=${colFieldId}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCCA \u00C9TAPE 4 : R\u00E9cup\u00E9rer les valeurs s\u00E9lectionn\u00E9es par l'utilisateur\r\n  // \u26A0\uFE0F ATTENTION : Les selectors peuvent \u00EAtre invers\u00E9s par rapport aux rows/columns de la table !\r\n  // rowFieldId peut contenir une valeur qui est en fait dans table.columns[]\r\n  // et columnFieldId peut contenir une valeur qui est en fait dans table.rows[]\r\n  // On r\u00E9cup\u00E8re les deux valeurs d'abord, puis on d\u00E9termine o\u00F9 les chercher\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const rowSelectorValue = await getNodeValue(rowFieldId, submissionId, prisma, valueMap);\r\n  const colSelectorValue = await getNodeValue(colFieldId, submissionId, prisma, valueMap);\r\n  const rowLabel = await getNodeLabel(rowFieldId, prisma, labelMap);\r\n  const colLabel = await getNodeLabel(colFieldId, prisma, labelMap);\r\n  \r\n  console.log(`[TABLE] \uD83D\uDCCA Valeurs s\u00E9lectionn\u00E9es: row=${rowLabel}(${rowSelectorValue}), col=${colLabel}(${colSelectorValue})`);\r\n  \r\n  if (!rowSelectorValue || !colSelectorValue) {\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Table \"${table.name}\"[${rowLabel}(${rowSelectorValue || '?'}), ${colLabel}(${colSelectorValue || '?'})] = aucune s\u00E9lection`,\r\n      details: { type: 'table', error: 'Missing selection' }\r\n    };\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83C\uDFAF \u00C9TAPE 5 : Trouver les index dans rows[] et columns[]\r\n  // \uFFFD AUTO-D\u00C9TECTION : On cherche chaque valeur dans rows ET columns pour d\u00E9terminer\r\n  //    automatiquement o\u00F9 elle se trouve (inversion automatique si n\u00E9cessaire)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // columns, rows, data d\u00E9j\u00E0 reconstruits plus haut\r\n  \r\n  // \uFFFD\uD83D\uDC1B DEBUG : Afficher toutes les valeurs AVANT la normalisation\r\n  console.log(`[TABLE] \uD83D\uDD0D DEBUG rowSelectorValue:`, {\r\n    raw: rowSelectorValue,\r\n    type: typeof rowSelectorValue,\r\n    stringified: JSON.stringify(rowSelectorValue),\r\n    asString: String(rowSelectorValue),\r\n    length: String(rowSelectorValue).length\r\n  });\r\n  console.log(`[TABLE] \uD83D\uDD0D DEBUG colSelectorValue:`, {\r\n    raw: colSelectorValue,\r\n    type: typeof colSelectorValue,\r\n    stringified: JSON.stringify(colSelectorValue),\r\n    asString: String(colSelectorValue),\r\n    length: String(colSelectorValue).length\r\n  });\r\n  \r\n  // \uD83E\uDDF9 NORMALISATION : Trim + lowercase pour matching robuste\r\n  const normalizedRowSelector = String(rowSelectorValue).trim().toLowerCase();\r\n  const normalizedColSelector = String(colSelectorValue).trim().toLowerCase();\r\n  \r\n  console.log(`[TABLE] \uD83D\uDD0D Recherche normalis\u00E9e:`, {\r\n    normalizedRowSelector,\r\n    normalizedColSelector\r\n  });\r\n  \r\n  // \uD83D\uDD0D Chercher rowSelectorValue dans rows ET columns\r\n  const rowSelectorInRows = rows.findIndex(r => String(r).trim().toLowerCase() === normalizedRowSelector);\r\n  const rowSelectorInCols = columns.findIndex(c => String(c).trim().toLowerCase() === normalizedRowSelector);\r\n  \r\n  // \uD83D\uDD0D Chercher colSelectorValue dans rows ET columns\r\n  const colSelectorInRows = rows.findIndex(r => String(r).trim().toLowerCase() === normalizedColSelector);\r\n  const colSelectorInCols = columns.findIndex(c => String(c).trim().toLowerCase() === normalizedColSelector);\r\n  \r\n  console.log(`[TABLE] \uD83D\uDD0D Auto-d\u00E9tection positions:`, {\r\n    rowSelector: { value: rowSelectorValue, inRows: rowSelectorInRows, inCols: rowSelectorInCols },\r\n    colSelector: { value: colSelectorValue, inRows: colSelectorInRows, inCols: colSelectorInCols }\r\n  });\r\n  \r\n  // \uD83C\uDFAF D\u00E9terminer les index finaux (avec auto-correction de l'inversion)\r\n  let finalRowIndex = -1;\r\n  let finalColIndex = -1;\r\n  let actualRowValue = '';\r\n  let actualColValue = '';\r\n  \r\n  // Strat\u00E9gie : Privil\u00E9gier le matching le plus \"naturel\"\r\n  // Si rowSelector est dans rows ET colSelector est dans columns \u2192 OK\r\n  // Si rowSelector est dans columns ET colSelector est dans rows \u2192 INVERSION\r\n  \r\n  if (rowSelectorInRows !== -1 && colSelectorInCols !== -1) {\r\n    // \u2705 CAS NORMAL : pas d'inversion\r\n    finalRowIndex = rowSelectorInRows;\r\n    finalColIndex = colSelectorInCols;\r\n    actualRowValue = String(rowSelectorValue);\r\n    actualColValue = String(colSelectorValue);\r\n    console.log(`[TABLE] \u2705 Configuration normale d\u00E9tect\u00E9e`);\r\n  } else if (rowSelectorInCols !== -1 && colSelectorInRows !== -1) {\r\n    // \uD83D\uDD04 CAS INVERS\u00C9 : on utilise directement les bons index\r\n    finalRowIndex = colSelectorInRows;\r\n    finalColIndex = rowSelectorInCols;\r\n    actualRowValue = String(colSelectorValue);\r\n    actualColValue = String(rowSelectorValue);\r\n    console.log(`[TABLE] \uD83D\uDD04 INVERSION D\u00C9TECT\u00C9E ET CORRIG\u00C9E AUTOMATIQUEMENT`);\r\n    console.log(`[TABLE] \uD83D\uDD04 rowSelector (${rowSelectorValue}) \u00E9tait dans columns \u2192 devient colValue`);\r\n    console.log(`[TABLE] \uFFFD colSelector (${colSelectorValue}) \u00E9tait dans rows \u2192 devient rowValue`);\r\n  } else {\r\n    // \u274C Aucun matching trouv\u00E9 (ou matching partiel)\r\n    finalRowIndex = rowSelectorInRows !== -1 ? rowSelectorInRows : colSelectorInRows;\r\n    finalColIndex = rowSelectorInCols !== -1 ? rowSelectorInCols : colSelectorInCols;\r\n    actualRowValue = String(rowSelectorValue);\r\n    actualColValue = String(colSelectorValue);\r\n  }\r\n  \r\n  // \uD83D\uDC1B DEBUG : Afficher toutes les lignes/colonnes disponibles\r\n  console.log(`[TABLE] \uD83D\uDCCB Lignes disponibles (${rows.length}):`, rows.map((r, i) => `[${i}]\"${r}\"`).join(', '));\r\n  console.log(`[TABLE] \uD83D\uDCCB Colonnes disponibles (${columns.length}):`, columns.map((c, i) => `[${i}]\"${c}\"`).join(', '));\r\n  \r\n  console.log(`[TABLE] \uD83C\uDFAF Index finaux apr\u00E8s auto-d\u00E9tection: rowIndex=${finalRowIndex}, colIndex=${finalColIndex}`);\r\n  console.log(`[TABLE] \uD83C\uDFAF Index finaux apr\u00E8s auto-d\u00E9tection: rowIndex=${finalRowIndex}, colIndex=${finalColIndex}`);\r\n  \r\n  if (finalRowIndex === -1 || finalColIndex === -1) {\r\n    console.error(`[TABLE] \u274C Valeur introuvable dans rows/columns`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Table \"${table.name}\"[${actualRowValue}, ${actualColValue}] = valeur introuvable`,\r\n      details: { type: 'table', error: 'Value not found in rows/columns' }\r\n    };\r\n  }\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCCD \u00C9TAPE 6 : Faire le lookup dans data[][]\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // IMPORTANT : rows[] a \u00E9t\u00E9 construit en SKIPPANT rowIndex=0 (header) \u2192 pas de d\u00E9calage\r\n  // MAIS columns[] contient TOUTES les colonnes y compris columns[0]=\"Orientation\" (label)\r\n  // alors que data[][] a \u00E9t\u00E9 construit avec cellsData.slice(1) \u2192 d\u00E9calage de -1 sur les colonnes\r\n  // Exemple : \"25\" trouv\u00E9 \u00E0 columns[4] \u2192 data[x][3] car data ne contient pas la colonne de labels\r\n  const dataRowIndex = finalRowIndex;\r\n  const dataColIndex = finalColIndex - 1;\r\n  \r\n  console.log(`[TABLE] \uD83D\uDCCD Index dans data[][]: [${dataRowIndex}][${dataColIndex}] (finalRow=${finalRowIndex}, finalCol=${finalColIndex})`);\r\n  \r\n  if (dataRowIndex < 0 || dataColIndex < 0 || !data[dataRowIndex]) {\r\n    console.error(`[TABLE] \u274C Index hors limites`);\r\n    return {\r\n      result: '\u2205',\r\n      humanText: `Table \"${table.name}\"[${actualRowValue}, ${actualColValue}] = hors limites`,\r\n      details: { type: 'table', error: 'Index out of bounds' }\r\n    };\r\n  }\r\n  \r\n  const result = data[dataRowIndex][dataColIndex];\r\n  console.log(`[TABLE] \u2705 R\u00E9sultat du lookup: ${result}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCDD \u00C9TAPE 7 : Construire le texte humain\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const humanText = `Table \"${table.name}\"[${rowLabel}=${actualRowValue}, ${colLabel}=${actualColValue}] = ${result}`;\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE4 \u00C9TAPE 8 : Retourner le r\u00E9sultat structur\u00E9\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  return {\r\n    result: String(result),\r\n    humanText,\r\n    details: {\r\n      type: 'table',\r\n      tableId: table.id,\r\n      tableName: table.name,\r\n      lookup: {\r\n        row: {\r\n          field: rowLabel,\r\n          fieldId: rowFieldId,\r\n          value: actualRowValue,\r\n          index: finalRowIndex\r\n        },\r\n        column: {\r\n          field: colLabel,\r\n          fieldId: colFieldId,\r\n          value: actualColValue,\r\n          index: finalColIndex\r\n        },\r\n        result\r\n      }\r\n    }\r\n  };\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCDD MODULE 7 : INTERPR\u00C9TATION DES CHAMPS SIMPLES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83D\uDCDD INTERPR\u00C8TE UN CHAMP SIMPLE\r\n * \r\n * Cette fonction r\u00E9cup\u00E8re simplement la valeur d'un champ saisi par l'utilisateur.\r\n * C'est le cas le plus simple (pas de calcul, juste r\u00E9cup\u00E9ration).\r\n * \r\n * @param fieldId - ID du champ\r\n * @param submissionId - ID de la soumission\r\n * @param prisma - Instance Prisma Client\r\n * @returns R\u00E9sultat interpr\u00E9t\u00E9\r\n */\r\nasync function interpretField(\r\n  fieldId: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valueMap?: Map<string, unknown>,\r\n  labelMap?: Map<string, string>\r\n): Promise<InterpretResult> {\r\n  \r\n  console.log(`[CHAMP] \uD83D\uDCDD D\u00E9but interpr\u00E9tation champ: ${fieldId}`);\r\n  \r\n  // R\u00E9cup\u00E9rer la valeur et le label (priorit\u00E9 valueMap pour mode preview)\r\n  const value = await getNodeValue(fieldId, submissionId, prisma, valueMap);\r\n  const label = await getNodeLabel(fieldId, prisma, labelMap);\r\n  \r\n  console.log(`[CHAMP] \uD83D\uDCCA ${label} = ${value || 'aucune donn\u00E9e'}`);\r\n  \r\n  const humanText = `${label}(${value || 'aucune donn\u00E9e'})`;\r\n  \r\n  return {\r\n    result: value || '\u2205',\r\n    humanText,\r\n    details: {\r\n      type: 'field',\r\n      fieldId,\r\n      label,\r\n      value\r\n    }\r\n  };\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDE80 MODULE 8 : POINT D'ENTR\u00C9E PRINCIPAL (API)\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * \uD83C\uDFAF FONCTION PRINCIPALE : \u00C9value une variable et toutes ses op\u00E9rations\r\n * \r\n * C'est LA fonction \u00E0 appeler depuis les routes API pour \u00E9valuer une variable.\r\n * Elle g\u00E8re automatiquement toute la r\u00E9cursion et retourne un r\u00E9sultat complet.\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. \uD83D\uDCE5 R\u00E9cup\u00E9rer la variable depuis TreeBranchLeafNodeVariable\r\n * 2. \uD83D\uDD0D V\u00E9rifier le sourceType (fixed, tree, api, etc.)\r\n * 3. \uD83D\uDD04 Si tree, interpr\u00E9ter r\u00E9cursivement la sourceRef\r\n * 4. \uD83D\uDCE4 Retourner le r\u00E9sultat complet (value, detail, humanText)\r\n * \r\n * UTILISATION DANS L'API :\r\n * ------------------------\r\n * ```typescript\r\n * const result = await evaluateVariableOperation(\r\n *   \"10bfb6d2-67ae-49a8-8d49-fc6dafa3f74e\",  // nodeId de la variable\r\n *   \"tbl-1759750447813-5n5y6oup4\",            // submissionId\r\n *   prisma\r\n * );\r\n * \r\n * // Stocker dans SubmissionData\r\n * await prisma.treeBranchLeafSubmissionData.upsert({\r\n *   where: { submissionId_nodeId: { submissionId, nodeId } },\r\n *   update: {\r\n *     value: result.value,\r\n *     operationDetail: result.operationDetail,\r\n *     operationResult: result.operationResult\r\n *   },\r\n *   create: { ... }\r\n * });\r\n * ```\r\n * \r\n * @param variableNodeId - ID du n\u0153ud variable \u00E0 \u00E9valuer\r\n * @param submissionId - ID de la soumission en cours\r\n * @param prisma - Instance Prisma Client\r\n * @returns R\u00E9sultat complet avec value, detail et humanText\r\n * \r\n * @throws Error si variable introuvable\r\n */\r\nexport async function evaluateVariableOperation(\r\n  variableNodeId: string,\r\n  submissionId: string,\r\n  prisma: PrismaClient,\r\n  valueMap?: Map<string, unknown>\r\n): Promise<{\r\n  value: string;\r\n  operationDetail: any;\r\n  operationResult: string;\r\n  operationSource: 'condition' | 'formula' | 'table' | 'field' | 'fixed';\r\n  sourceRef: string;\r\n}> {\r\n  \r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uD83C\uDFAF \u00C9VALUATION VARIABLE: ${variableNodeId}`);\r\n  console.log(`   Submission: ${submissionId}`);\r\n  console.log(`${'\u2550'.repeat(80)}\\n`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE5 \u00C9TAPE 0 : Initialiser et enrichir les Maps (NOUVEAU)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const localValueMap = valueMap || new Map<string, unknown>();\r\n  const labelMap = new Map<string, string>();\r\n  \r\n  // Enrichir automatiquement les donn\u00E9es depuis la base\r\n  await enrichDataFromSubmission(submissionId, prisma, localValueMap, labelMap);\r\n  \r\n  console.log(`\u2705 Maps enrichies: ${localValueMap.size} valeurs, ${labelMap.size} labels`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCE5 \u00C9TAPE 1 : R\u00E9cup\u00E9rer la variable\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  const variable = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n    where: { nodeId: variableNodeId },\r\n    select: {\r\n      id: true,\r\n      nodeId: true,\r\n      exposedKey: true,\r\n      displayName: true,\r\n      sourceType: true,\r\n      sourceRef: true,\r\n      fixedValue: true,\r\n      defaultValue: true\r\n    }\r\n  });\r\n  \r\n  if (!variable) {\r\n    console.error(`\u274C Variable introuvable: ${variableNodeId}`);\r\n    throw new Error(`Variable introuvable: ${variableNodeId}`);\r\n  }\r\n  \r\n  console.log(`\u2705 Variable trouv\u00E9e: ${variable.displayName}`);\r\n  console.log(`   SourceType: ${variable.sourceType}`);\r\n  console.log(`   SourceRef: ${variable.sourceRef}`);\r\n  \r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDD0D \u00C9TAPE 2 : Traiter selon le sourceType\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  \r\n  // CAS 1 : Valeur fixe\r\n  if (variable.sourceType === 'fixed' && variable.fixedValue) {\r\n    console.log(`\uD83D\uDCCC Valeur fixe: ${variable.fixedValue}`);\r\n    return {\r\n      value: variable.fixedValue,\r\n      operationDetail: { type: 'fixed', value: variable.fixedValue },\r\n      operationResult: `Valeur fixe: ${variable.fixedValue}`,\r\n      operationSource: 'fixed',\r\n      sourceRef: variable.sourceRef || ''\r\n    };\r\n  }\r\n  \r\n  // CAS 2 : Source depuis le tree (condition/formule/table)\r\n  if (variable.sourceType === 'tree' && variable.sourceRef) {\r\n    console.log(`\uD83C\uDF32 Source tree, interpr\u00E9tation de: ${variable.sourceRef}`);\r\n    \r\n    // \uD83D\uDD04 INTERPR\u00C9TATION R\u00C9CURSIVE COMPL\u00C8TE\r\n    const valuesCache = new Map<string, InterpretResult>();\r\n    const result = await interpretReference(\r\n      variable.sourceRef,\r\n      submissionId,\r\n      prisma,\r\n      valuesCache,\r\n      0,  // Profondeur initiale = 0\r\n      localValueMap,\r\n      labelMap\r\n    );\r\n    \r\n    console.log(`\\n${'\u2500'.repeat(80)}`);\r\n    console.log(`\u2705 R\u00C9SULTAT FINAL:`);\r\n    console.log(`   Value: ${result.result}`);\r\n    console.log(`   HumanText: ${result.humanText}`);\r\n    console.log(`${'\u2500'.repeat(80)}\\n`);\r\n    \r\n    // D\u00E9terminer l'operationSource\r\n    let operationSource: 'condition' | 'formula' | 'table' | 'field' | 'fixed' = 'field';\r\n    if (variable.sourceRef.includes('condition:')) operationSource = 'condition';\r\n    else if (variable.sourceRef.includes('node-formula:')) operationSource = 'formula';\r\n    else if (variable.sourceRef.includes('@table.')) operationSource = 'table';\r\n    \r\n    return {\r\n      value: result.result,\r\n      operationDetail: result.details,\r\n      operationResult: result.humanText,\r\n      operationSource,\r\n      sourceRef: variable.sourceRef\r\n    };\r\n  }\r\n  \r\n  // CAS 3 : Valeur par d\u00E9faut\r\n  console.log(`\uD83D\uDCCB Utilisation valeur par d\u00E9faut: ${variable.defaultValue || '\u2205'}`);\r\n  return {\r\n    value: variable.defaultValue || '\u2205',\r\n    operationDetail: { type: 'default', value: variable.defaultValue },\r\n    operationResult: `Valeur par d\u00E9faut: ${variable.defaultValue || 'aucune'}`,\r\n    operationSource: 'field',\r\n    sourceRef: variable.sourceRef || ''\r\n  };\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCE4 EXPORTS\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\nexport {\r\n  interpretReference,\r\n  interpretCondition,\r\n  interpretFormula,\r\n  interpretTable,\r\n  interpretField,\r\n  identifyReferenceType,\r\n  normalizeRef\r\n};\r\n", "import dotenv from 'dotenv';\r\ndotenv.config();\r\n\r\nimport express from 'express';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\nimport cors from 'cors';\r\nimport session from 'express-session';\r\nimport cookieParser from 'cookie-parser';\r\nimport passport from 'passport';\r\nimport helmet from 'helmet';\r\nimport compression from 'compression';\r\nimport expressWinston from 'express-winston';\r\nimport apiRouter from './routes/index';\r\nimport { prisma } from './lib/prisma';\r\n\r\n// \uD83D\uDD25 ROUTES TBL SP\u00C9CIALIS\u00C9ES\r\nimport tblSubmissionEvaluatorRouter from './components/TreeBranchLeaf/tbl-bridge/routes/tbl-submission-evaluator';\r\nimport calculatedValueController from './controllers/calculatedValueController'; // \uD83C\uDFAF VALEURS CALCUL\u00C9ES STOCK\u00C9ES\r\n\r\n// \uD83C\uDF10 ROUTES GESTION SITES WEB\r\n// \uD83D\uDD04 FORCE RELOAD - Timestamp: 2025-10-09 20:05\r\nimport websitesRouter from './api/websites';\r\n\r\n// \uD83C\uDF10 ROUTES CRUD CONTENU SITES WEB\r\nimport websiteServicesRouter from './api/website-services';\r\nimport websiteProjectsRouter from './api/website-projects';\r\nimport websiteTestimonialsRouter from './api/website-testimonials';\r\nimport websiteSectionsRouter from './api/website-sections';\r\nimport websiteThemesRouter from './api/website-themes';\r\nimport contactFormRouter from './api/contact-form';\r\nimport imageUploadRouter from './api/image-upload';\r\n\r\n// \uD83E\uDD16 ROUTES G\u00C9N\u00C9RATION CONTENU IA\r\nimport aiContentRouter from './api/ai-content';\r\nimport aiRouter from './api/ai'; // \uD83E\uDD16 GEMINI AI (optimisation, suggestions)\r\nimport aiFieldGeneratorRouter from './routes/ai-field-generator'; // \uD83E\uDD16 IA G\u00C9N\u00C9RATION INTELLIGENTE DE CONTENU\r\n\r\n// \uD83C\uDF10 MIDDLEWARE D\u00C9TECTION SITES VITRINES AUTOMATIQUE\r\nimport { detectWebsite, websiteInterceptor } from './middleware/websiteDetection';\r\nimport { renderWebsite } from './middleware/websiteRenderer';\r\n\r\n// \uD83D\uDEE1\uFE0F IMPORTS S\u00C9CURIT\u00C9 ENTERPRISE\r\nimport { securityLogger, logSecurityEvent } from './security/securityLogger';\r\nimport { \r\n  securityMonitoring,\r\n  timingAttackProtection,\r\n  advancedRateLimit,\r\n  authRateLimit,\r\n  anomalyDetection,\r\n  inputSanitization\r\n} from './security/securityMiddleware';\r\n\r\nconsole.log('\uD83D\uDE80 [API-SERVER-CLEAN] D\u00E9marrage du serveur CRM...');\r\n\r\n// \uD83D\uDD12 INITIALISATION LOGGING S\u00C9CURIS\u00C9 ENTERPRISE\r\nlogSecurityEvent('SERVER_STARTUP', {\r\n  timestamp: new Date().toISOString(),\r\n  nodeVersion: process.version,\r\n  environment: process.env.NODE_ENV || 'development',\r\n  securityLevel: 'ENTERPRISE'\r\n}, 'info');\r\n\r\nconst app = express();\r\n\r\n// \uD83C\uDF10 Configuration pour Cloud Run / reverse proxies (1 = single proxy, not true which is permissive)\r\napp.set('trust proxy', 1);\r\n\r\nconst port = Number(process.env.PORT || 4000);\r\n// \uD83D\uDCE6 M\u00E9tadonn\u00E9es build (inject\u00E9es par le script de d\u00E9ploiement)\r\nconst BUILD_VERSION = process.env.BUILD_VERSION || 'dev-local';\r\nconst GIT_SHA = process.env.GIT_SHA || 'unknown';\r\n\r\n// \uFFFD Middleware d'en-t\u00EAtes de version\r\napp.use((req, res, next) => {\r\n  res.setHeader('X-App-Version', BUILD_VERSION);\r\n  res.setHeader('X-Git-Sha', GIT_SHA);\r\n  next();\r\n});\r\n\r\n// \uFFFD\uD83D\uDCCA LOGGING S\u00C9CURIS\u00C9 DE TOUTES LES REQU\u00CATES\r\napp.use(expressWinston.logger({\r\n  winstonInstance: securityLogger,\r\n  meta: true,\r\n  msg: 'HTTP {{req.method}} {{req.url}} {{res.statusCode}} {{res.responseTime}}ms',\r\n  expressFormat: false,\r\n  colorize: false,\r\n  requestWhitelist: ['method', 'url', 'ip'],\r\n  responseWhitelist: ['statusCode'],\r\n  skip: (req, res) => {\r\n    // Skip les endpoints de sant\u00E9 pour \u00E9viter le spam de logs\r\n    return ['/api/health', '/health'].includes(req.url) && res.statusCode < 400;\r\n  }\r\n}));\r\n\r\n// \uD83D\uDEE1\uFE0F S\u00C9CURIT\u00C9 NIVEAU 1 - MONITORING ET PROTECTION DE BASE\r\napp.use(securityMonitoring);\r\napp.use(timingAttackProtection);\r\n\r\n// \uD83D\uDEE1\uFE0F S\u00C9CURIT\u00C9 NIVEAU 2 - PROTECTION HEADERS ET COMPRESSION\r\napp.use(helmet({\r\n  contentSecurityPolicy: {\r\n    directives: {\r\n      defaultSrc: [\"'self'\"],\r\n      styleSrc: [\"'self'\", \"'unsafe-inline'\", \"fonts.googleapis.com\"],\r\n      scriptSrc: [\"'self'\", \"'unsafe-inline'\"],\r\n      fontSrc: [\"'self'\", \"fonts.gstatic.com\"],\r\n      imgSrc: [\"'self'\", \"data:\", \"https:\"],\r\n      connectSrc: [\"'self'\", \"https:\"],\r\n      frameSrc: [\"'none'\"],\r\n      objectSrc: [\"'none'\"],\r\n      mediaSrc: [\"'self'\"],\r\n      manifestSrc: [\"'self'\"]\r\n    }\r\n  },\r\n  hsts: {\r\n    maxAge: 31536000,\r\n    includeSubDomains: true,\r\n    preload: true\r\n  }\r\n}));\r\n\r\napp.use(compression({\r\n  level: 6,\r\n  threshold: 1024,\r\n  filter: (req, res) => {\r\n    if (req.headers['x-no-compression']) return false;\r\n    return compression.filter(req, res);\r\n  }\r\n}));\r\n\r\n// \uD83D\uDEE1\uFE0F S\u00C9CURIT\u00C9 NIVEAU 3 - RATE LIMITING AVANC\u00C9\r\napp.use(advancedRateLimit);\r\n\r\n// \uD83D\uDEE1\uFE0F S\u00C9CURIT\u00C9 NIVEAU 4 - D\u00C9TECTION D'ANOMALIES\r\napp.use(anomalyDetection);\r\n\r\n// \u26A1 Configuration CORS s\u00E9curis\u00E9e (ajout app.2thier.be)\r\nconst FRONTEND_URL = process.env.FRONTEND_URL;\r\nconst prodOrigins = [\r\n  FRONTEND_URL || 'https://app.2thier.be',\r\n  'https://www.2thier.be',\r\n  'https://crm.2thier.be'\r\n];\r\nconst devOrigins = [FRONTEND_URL || 'http://localhost:5173', 'http://localhost:3000'];\r\napp.use(cors({\r\n  origin: process.env.NODE_ENV === 'production' ? prodOrigins : devOrigins,\r\n  credentials: true,\r\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\r\n  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'x-organization-id'],\r\n  exposedHeaders: ['X-Total-Count', 'X-Rate-Limit-Remaining', 'x-organization-id']\r\n}));\r\n\r\n// \uD83D\uDEE1\uFE0F S\u00C9CURIT\u00C9 NIVEAU 5 - SANITISATION DES ENTR\u00C9ES\r\napp.use(inputSanitization);\r\n\r\n// \uD83D\uDCCA Configuration JSON et URL encoding avec validation\r\napp.use(express.json({ \r\n  limit: '50mb',\r\n  verify: (req, res, buf) => {\r\n    try {\r\n      JSON.parse(buf.toString());\r\n    } catch (e) {\r\n      logSecurityEvent('INVALID_JSON', {\r\n        ip: req.ip,\r\n        userAgent: req.headers['user-agent'],\r\n        error: (e as Error).message\r\n      }, 'warn');\r\n    }\r\n  }\r\n}));\r\napp.use(express.urlencoded({ extended: true, limit: '50mb' }));\r\napp.use(cookieParser());\r\n\r\n// \uD83D\uDD10 Configuration Session avec s\u00E9curit\u00E9 Enterprise\r\napp.use(session({\r\n  secret: process.env.SESSION_SECRET || 'crm-dev-secret-2024',\r\n  resave: false,\r\n  saveUninitialized: false,\r\n  name: 'CRM_SESSION_ID',\r\n  cookie: {\r\n    secure: process.env.NODE_ENV === 'production',\r\n    httpOnly: true,\r\n    maxAge: 24 * 60 * 60 * 1000, // 24 heures\r\n    sameSite: 'strict'\r\n  },\r\n  store: undefined // TODO: Ajouter un store persistant en production\r\n}));\r\n\r\nconsole.log('\u2705 [ENTERPRISE-SECURITY] Configuration s\u00E9curit\u00E9 niveau Enterprise activ\u00E9e');\r\n\r\n// \uD83D\uDCF8 Servir les fichiers upload\u00E9s en statique\r\nconst uploadsDir = path.resolve(process.cwd(), 'public', 'uploads');\r\napp.use('/uploads', express.static(uploadsDir));\r\nconsole.log('\uD83D\uDCF8 [UPLOADS] Dossier uploads configur\u00E9:', uploadsDir);\r\n\r\n// Configuration Passport\r\nconsole.log('\uD83D\uDD27 [API-SERVER-CLEAN] Configuration Passport...');\r\napp.use(passport.initialize());\r\napp.use(passport.session());\r\nconsole.log('\u2705 [API-SERVER-CLEAN] Passport configur\u00E9');\r\n\r\n// Routes API - Utilisation du syst\u00E8me existant complet\r\nconsole.log('\uD83D\uDD27 [API-SERVER-CLEAN] Configuration des routes...');\r\n// Limiteur sp\u00E9cialis\u00E9 auth uniquement sur bloc /api/auth\r\napp.use('/api/auth', authRateLimit);\r\napp.use('/api', apiRouter); // Utilise TOUTES les routes existantes !\r\napp.use('/api', websitesRouter); // \uD83C\uDF10 GESTION DES SITES WEB (Site Vitrine, Devis1Minute)\r\napp.use('/api', websiteServicesRouter); // \uD83C\uDF10 CRUD SERVICES\r\napp.use('/api', websiteProjectsRouter); // \uD83C\uDF10 CRUD PROJECTS\r\napp.use('/api', websiteTestimonialsRouter); // \uD83C\uDF10 CRUD TESTIMONIALS\r\napp.use('/api', websiteSectionsRouter); // \uD83C\uDFA8 CRUD SECTIONS (PAGE BUILDER)\r\napp.use('/api/website-themes', websiteThemesRouter); // \uD83C\uDFA8 GESTION TH\u00C8MES SITES WEB\r\napp.use('/api/ai-content', aiContentRouter); // \uD83E\uDD16 G\u00C9N\u00C9RATION CONTENU IA (Gemini)\r\napp.use('/api/ai', aiFieldGeneratorRouter); // \uD83E\uDD16 IA G\u00C9N\u00C9RATION INTELLIGENTE (generate-field, status)\r\napp.use('/api/ai', aiRouter); // \uD83E\uDD16 GEMINI AI (suggestions, optimisations)\r\napp.use('/api', contactFormRouter); // \uD83D\uDCE7 FORMULAIRE DE CONTACT SITE VITRINE\r\napp.use('/api', imageUploadRouter); // \uD83D\uDCF8 UPLOAD D'IMAGES (LOGOS, PHOTOS)\r\napp.use('/api/tbl', tblSubmissionEvaluatorRouter); // \uD83D\uDD25 TBL PRISMA EVALUATOR\r\napp.use('/api/tree-nodes', calculatedValueController); // \uD83C\uDFAF VALEURS CALCUL\u00C9ES STOCK\u00C9ES DANS PRISMA\r\nconsole.log('\u2705 [API-SERVER-CLEAN] Routes configur\u00E9es');\r\n\r\napp.get('/health', (_req, res) => {\r\n  res.json({\r\n    status: 'OK',\r\n    timestamp: new Date().toISOString(),\r\n  });\r\n});\r\n\r\n// V\u00E9rification de la connectivit\u00E9 base de donn\u00E9es (utilitaire de debug/ops)\r\napp.get('/api/health/db', async (_req, res) => {\r\n  try {\r\n    // V\u00E9rifie que le moteur r\u00E9pond sans forcer d'autres requ\u00EAtes applicatives\r\n    await prisma.$queryRaw`SELECT 1`;\r\n    res.json({ db: 'OK', timestamp: new Date().toISOString() });\r\n  } catch (e) {\r\n    const message = (e as Error)?.message || 'Unknown error';\r\n    res.status(503).json({ db: 'DOWN', error: message, timestamp: new Date().toISOString() });\r\n  }\r\n});\r\n\r\n// \uD83C\uDF10 MIDDLEWARE DE D\u00C9TECTION AUTOMATIQUE DES SITES VITRINES\r\n// Doit \u00EAtre AVANT le serveur de fichiers statiques pour intercepter les domaines\r\napp.use(detectWebsite);\r\napp.use(websiteInterceptor); // \u26A1 INTERCEPTE ET REND LES SITES VITRINES DIRECTEMENT\r\n\r\n//  Production: servir le frontend statique (dist) si pr\u00E9sent\r\nif (process.env.NODE_ENV === 'production') {\r\n  const distDir = path.resolve(process.cwd(), 'dist');\r\n  const indexHtml = path.join(distDir, 'index.html');\r\n  if (fs.existsSync(indexHtml)) {\r\n    console.log('\uD83D\uDDC2\uFE0F [STATIC] Distribution front d\u00E9tect\u00E9e, activation du serveur statique');\r\n    \r\n    // \u26A1 CRITIQUE: Servir UNIQUEMENT /assets/* pour ne PAS intercepter la route racine /\r\n    // Cela permet \u00E0 websiteInterceptor de g\u00E9rer / pour les sites vitrines\r\n    const assetsDir = path.join(distDir, 'assets');\r\n    app.use('/assets', express.static(assetsDir, {\r\n      setHeaders: (res) => {\r\n        res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\r\n      }\r\n    }));\r\n    \r\n    // Servir aussi les fichiers PWA et favicon \u00E0 la racine du dist\r\n    app.get(/^\\/pwa-.*/, (req, res) => {\r\n      const filePath = path.join(distDir, req.path);\r\n      if (fs.existsSync(filePath)) {\r\n        res.sendFile(filePath);\r\n      } else {\r\n        res.status(404).end();\r\n      }\r\n    });\r\n    app.get('/favicon.ico', (req, res) => res.sendFile(path.join(distDir, 'favicon.ico')));\r\n    app.get('/manifest.json', (req, res) => res.sendFile(path.join(distDir, 'manifest.json')));\r\n    app.get('/manifest.webmanifest', (req, res) => res.sendFile(path.join(distDir, 'manifest.webmanifest')));\r\n    app.get('/registerSW.js', (req, res) => {\r\n      const swPath = path.join(distDir, 'registerSW.js');\r\n      if (fs.existsSync(swPath)) {\r\n        res.setHeader('Content-Type', 'application/javascript');\r\n        res.sendFile(swPath);\r\n      } else {\r\n        res.status(404).end();\r\n      }\r\n    });\r\n    \r\n    // \uD83D\uDD27 Service Worker (sw.js)\r\n    app.get('/sw.js', (req, res) => {\r\n      const swPath = path.join(distDir, 'sw.js');\r\n      if (fs.existsSync(swPath)) {\r\n        res.setHeader('Content-Type', 'application/javascript');\r\n        res.sendFile(swPath);\r\n      } else {\r\n        res.status(404).end();\r\n      }\r\n    });\r\n    \r\n    // \uD83D\uDD27 Configuration d'environnement runtime (env-config.js)\r\n    app.get('/env-config.js', (req, res) => {\r\n      const envPath = path.join(distDir, 'env-config.js');\r\n      if (fs.existsSync(envPath)) {\r\n        res.setHeader('Content-Type', 'application/javascript');\r\n        res.sendFile(envPath);\r\n      } else {\r\n        res.status(404).end();\r\n      }\r\n    });\r\n    \r\n    // \uD83C\uDF10 RENDU DES SITES VITRINES OU FALLBACK CRM\r\n    // Cette route attrape TOUT ce qui n'est pas /api/ ou /assets/\r\n    app.get(/^(?!\\/api\\/|\\/assets\\/).*/, (req: any, res, _next) => {\r\n      // \uFFFD SI UN SITE VITRINE A \u00C9T\u00C9 D\u00C9TECT\u00C9, LE RENDRE EN SSR\r\n      if (req.isWebsiteRoute === true && req.websiteData) {\r\n        console.log(`\uD83C\uDFA8 [WEBSITE-RENDER] Rendu SSR pour: ${req.websiteData.name} (${req.hostname})`);\r\n        return renderWebsite(req, res);\r\n      }\r\n      \r\n      // \uD83D\uDCF1 SINON, SERVIR LE CRM REACT\r\n      console.log(`\uD83D\uDCF1 [CRM-SPA] Serving React app for: ${req.hostname}${req.url}`);\r\n      res.sendFile(indexHtml);\r\n    });\r\n  } else {\r\n    console.warn('\u26A0\uFE0F [STATIC] Aucun build front trouv\u00E9 (dist/index.html manquant)');\r\n  }\r\n}\r\n\r\n// \uD83D\uDCCA LOGGING S\u00C9CURIS\u00C9 DES ERREURS\r\napp.use(expressWinston.errorLogger({\r\n  winstonInstance: securityLogger,\r\n  meta: true,\r\n  msg: 'ERROR {{err.message}} {{req.method}} {{req.url}}',\r\n  requestWhitelist: ['method', 'url', 'ip', 'body'],\r\n  blacklistedMetaFields: ['password', 'token', 'secret']\r\n}));\r\n\r\n// Nouvelle route de diagnostic (remplace l'ancienne racine JSON)\r\napp.get('/api/root-info', (_req, res) => {\r\n  res.json({\r\n    status: 'CRM API Server Online - ENTERPRISE SECURITY',\r\n    timestamp: new Date().toISOString(),\r\n    securityLevel: '100%',\r\n    endpoints: {\r\n      health: '/api/health',\r\n      notifications: '/api/notifications',\r\n      modules: '/api/modules/all',\r\n      blocks: '/api/blocks',\r\n      auth: '/api/auto-google-auth/connect'\r\n    }\r\n  });\r\n});\r\n\r\n// Endpoint debug pour v\u00E9rifier la pr\u00E9sence du build front en production\r\napp.get('/api/debug/static-status', (_req, res) => {\r\n  const distDir = path.resolve(process.cwd(), 'dist');\r\n  const indexHtml = path.join(distDir, 'index.html');\r\n  res.json({\r\n    env: process.env.NODE_ENV,\r\n    distExists: fs.existsSync(distDir),\r\n    indexExists: fs.existsSync(indexHtml),\r\n    served: process.env.NODE_ENV === 'production' && fs.existsSync(indexHtml)\r\n  });\r\n});\r\n\r\n// \uD83D\uDD12 Gestionnaire d'erreurs s\u00E9curis\u00E9\r\nimport type { ErrorRequestHandler } from 'express';\r\n// Express 5: error middleware MUST have 4 params (err, req, res, next)\r\nconst errorHandler: ErrorRequestHandler = (err, req, res, next) => {\r\n  logSecurityEvent('SERVER_ERROR', {\r\n    error: err.message,\r\n    stack: err.stack,\r\n    method: req?.method || 'UNKNOWN',\r\n    url: req?.url || 'UNKNOWN',\r\n    ip: req?.ip || 'UNKNOWN',\r\n    userAgent: req?.headers?.['user-agent'] || 'UNKNOWN'\r\n  }, 'error');\r\n\r\n  // En production, ne pas exposer les d\u00E9tails d'erreur\r\n  const errorResponse = process.env.NODE_ENV === 'production' \r\n    ? { error: 'Une erreur interne s\\'est produite' }\r\n    : { error: err.message, stack: err.stack };\r\n\r\n  const status = typeof (err as { status?: number }).status === 'number' ? (err as { status?: number }).status! : 500;\r\n  // Si les en-t\u00EAtes sont d\u00E9j\u00E0 envoy\u00E9s, d\u00E9l\u00E9guer \u00E0 Express\r\n  if (res.headersSent) {\r\n    return next(err);\r\n  }\r\n  res.status(status).json(errorResponse);\r\n};\r\napp.use(errorHandler);\r\n\r\n// Import du hook de synchronisation TreeBranchLeaf\r\nimport { initializeTreeBranchLeafSync } from './components/TreeBranchLeaf/treebranchleaf-new/api/sync-variable-hook';\r\n\r\n// D\u00E9marrage du serveur\r\napp.listen(port, () => {\r\n  logSecurityEvent('SERVER_READY', {\r\n    port,\r\n    securityLevel: 'ENTERPRISE',\r\n    features: [\r\n      'Advanced Rate Limiting',\r\n      'Anomaly Detection', \r\n      'Input Sanitization',\r\n      'Security Monitoring',\r\n      'Comprehensive Logging',\r\n      'Helmet Protection',\r\n      'Timing Attack Protection'\r\n    ]\r\n  }, 'info');\r\n\r\n  console.log(`\uD83C\uDF89 [API-SERVER-CLEAN] Serveur CRM d\u00E9marr\u00E9 avec succ\u00E8s sur http://localhost:${port}`);\r\n  console.log(`\uD83D\uDEE1\uFE0F [ENTERPRISE-SECURITY] S\u00E9curit\u00E9 niveau 100% activ\u00E9e`);\r\n  \r\n  // \uD83D\uDD04 Synchronisation automatique des sourceRef TreeBranchLeaf\r\n  console.log('\uD83D\uDD04 [TREEBRANCHLEAF] Synchronisation des sourceRef...');\r\n  initializeTreeBranchLeafSync().catch(err => {\r\n    console.error('\u26A0\uFE0F  [TREEBRANCHLEAF] Erreur lors de la synchronisation:', err);\r\n  });\r\n  console.log(`\uD83D\uDCCB [API-SERVER-CLEAN] Endpoints disponibles:`);\r\n  console.log(`   - Health: http://localhost:${port}/api/health`);\r\n  console.log(`   - Auth Me: http://localhost:${port}/api/auth/me`);\r\n  console.log(`   - Auth Login: http://localhost:${port}/api/auth/login`);\r\n  console.log(`   - Notifications: http://localhost:${port}/api/notifications`);\r\n  console.log(`   - Modules: http://localhost:${port}/api/modules/all`);\r\n  console.log(`   - Blocks: http://localhost:${port}/api/blocks`);\r\n  console.log(`   - Google Auth: http://localhost:${port}/api/auto-google-auth/connect`);\r\n});\r\nexport { app };", "import { Router } from 'express';\r\nimport authRoutes from './authRoutes';\r\nimport gmailRoutes from './gmailRoutes'; // R\u00E9activ\u00E9\r\nimport miscRoutes from './misc';\r\nimport profileRoutes from './profile';\r\nimport modulesRoutes from './modules';\r\nimport adminModulesRoutes from './admin-modules'; // \uD83C\uDFAF ROUTES ADMINISTRATION MODULES DYNAMIQUE\r\nimport iconsRoutes from './icons'; // \uD83C\uDFA8 ROUTES IC\u00D4NES DYNAMIQUES\r\nimport companyRoutes from './company'; // \u2705 R\u00C9ACTIV\u00C9 - Fichier cr\u00E9\u00E9\r\nimport invitationRoutes from './invitations';\r\nimport organizationsRoutes from './organizations';\r\nimport autoGoogleAuthRoutes from './autoGoogleAuthRoutes';\r\nimport googleAuthRoutes from './google-auth'; // \u2705 NOUVELLE ROUTE GOOGLE AUTH\r\nimport googleSchedulerRoutes from './google-scheduler'; // \uD83D\uDD04 ROUTES SCHEDULER REFRESH TOKENS GOOGLE\r\nimport googleTokensRoutes from './google-tokens'; // \uD83D\uDD0D ROUTES MONITORING TOKENS GOOGLE\r\nimport googleWorkspaceRoutes from './googleWorkspace'; // \u2705 CONFIGURATION GOOGLE WORKSPACE\r\nimport blocksRoutes from './blocks';\r\nimport notificationsRoutes from './notifications';\r\nimport notificationSystemRoutes from './notificationSystemRoutes'; // \uD83D\uDD14 Routes syst\u00E8me notifications\r\nimport settingsRoutes from './settingsRoutes';\r\nimport leadsRoutes from './leadsRoutes'; // \u2705 Routes leads corrig\u00E9es\r\nimport rolesRoutes from './rolesRoutes';\r\nimport usersRoutes from './usersRoutes';\r\nimport adminPasswordRoutes from './adminPasswordRoutes';\r\nimport servicesRoutes from './services'; // \uD83D\uDD27 **AJOUT ULTRA-S\u00C9CURIS\u00C9** : Routes services externes\r\nimport permissionsRoutes from './permissions'; // \u2705 Routes permissions\r\nimport adminRoutes from './admin'; // \u2705 Routes admin\r\nimport impersonateRoutes from './impersonate'; // \u2705 Routes usurpation\r\nimport calendarRoutes from './calendar'; // \u2705 Routes calendar\r\nimport clientsRoutes from './clients'; // \u2705 Routes clients\r\nimport projectsRoutes from './projects'; // \u2705 Routes projects\r\nimport emailsRoutes from './emails'; // \u2705 Routes emails\r\nimport geminiRoutes from './gemini'; // \uD83E\uDD16 Routes Gemini AI\r\nimport telnyxRoutes from './telnyx'; // \uD83D\uDCDE Routes Telnyx Communications\r\nimport quotesRoutes from './quotes'; // \uD83D\uDCC4 Routes Devis (Quotes)\r\nimport googleDriveRoutes from './google-drive'; // \uD83D\uDCC1 Routes Google Drive\r\nimport googleMeetRoutes from './google-meet'; // \uD83D\uDCF9 Routes Google Meet\r\nimport analyticsRoutes from './analytics'; // \uD83D\uDCCA Routes Analytics\r\nimport aiRoutes from './ai'; // \uD83E\uDD16 Routes Intelligence Artificielle\r\nimport aiCodeRoutes from './ai-code'; // \uD83E\uDDE9 Exploration code IA (SuperAdmin)\r\nimport fieldsRoutes from './fields';\r\nimport validationsRoutes from './validations';\r\nimport formulasApiRoutes from './api/formulas';\r\nimport dependenciesApiRoutes from './api/dependencies';\r\nimport sectionsRoutes from './sections';\r\nimport moduleNavigationRoutes from './module-navigation'; // \uD83D\uDD39 NAVIGATION MODULES\r\nimport formSectionsRoutes from './form-sections'; // \uD83D\uDD39 SECTIONS FORMULAIRES\r\nimport fieldTypesRoutes from './fieldTypes';\r\nimport optionNodesRoutes from './optionNodes';\r\nimport advancedSelectRoutes from '../api/advanced-select.js'; // \uD83D\uDE80 Routes Advanced Select Professional\r\nimport dynamicFormulasRoutes from '../api/dynamic-formulas'; // \uD83C\uDF1F Routes Syst\u00E8me Dynamique Universel\r\nimport dashboardRoutes from './dashboard'; // \uD83D\uDCCA Routes Dashboard\r\nimport treeBranchLeafNewRoutes from '../components/TreeBranchLeaf/treebranchleaf-new/api/treebranchleaf-routes'; // \uD83C\uDF33 Routes TreeBranchLeaf NOUVEAU syst\u00E8me centralis\u00E9\r\n// import treeBranchLeafV2Routes from './treebranchleaf-v2'; // \uD83C\uDF33 Routes TreeBranchLeaf V2 (D\u00C9SACTIV\u00C9 - Migration vers architecture centralis\u00E9e)\r\nimport tblRoutes from '../components/TreeBranchLeaf/treebranchleaf-new/TBL/routes/tbl-routes'; // \uD83C\uDFAF Routes TBL (TreeBranchLeaf Business Logic)\r\nimport tblIntelligenceRoutes from '../components/TreeBranchLeaf/tbl-bridge/routes/tbl-intelligence-routes'; // \uD83E\uDDE0 Routes TBL Intelligence V2.0\r\nimport tblCapabilitiesRoutes from './tbl-capabilities'; // \uD83E\uDDE0 Nouveau endpoint capabilities pr\u00E9-charg\u00E9es\r\nimport { logout } from '../controllers/authController';\r\n// import googleAuthRouter from './authGoogleRoutes'; // Comment\u00E9 car non d\u00E9fini ou non utilis\u00E9\r\n\r\n// \uD83C\uDFAF DEVIS1MINUTE - Nouvelles routes\r\nimport leadGenerationRoutes from './leadGeneration'; // \uD83C\uDFAF Routes g\u00E9n\u00E9ration de leads\r\nimport marketplaceRoutes from './marketplace-fixed'; // \uD83C\uDFEA Routes marketplace leads (VERSION CORRIG\u00C9E)\r\nimport partnerRoutes from './partner'; // \uD83E\uDD1D Routes portal partenaires\r\nimport publicFormsRoutes from './publicForms'; // \uD83D\uDCDD Routes formulaires publics\r\nimport landingPagesRoutes from './landingPages'; // \uD83C\uDF10 Routes landing pages\r\nimport campaignAnalyticsRoutes from './campaignAnalytics'; // \uD83D\uDCCA Routes analytics campagnes\r\nimport dispatchRoutes from './dispatch'; // \uD83D\uDE9A Rules engine (Dispatch)\r\nimport integrationsStatusRoutes from './integrationsStatus'; // \uD83D\uDD0C \u00C9tat des int\u00E9grations\r\nimport integrationsRoutes from './integrations'; // \uD83D\uDD0C Int\u00E9grations (advertising/ecommerce)\r\n\r\n// \uD83C\uDF10 ROUTES PUBLIQUES (sans authentification)\r\nimport publicLeadsRoutes from './publicLeads'; // \uD83C\uDF0D API publique leads\r\n\r\nconst apiRouter = Router();\r\n\r\nconsole.log('[ROUTER] Configuration du routeur principal');\r\n\r\n// Routes d'authentification\r\napiRouter.use('/auth', authRoutes);\r\nconsole.log('[ROUTER] Routes d\\'authentification mont\u00E9es sur /auth');\r\n\r\n// Routes pour l'authentification Google automatique\r\napiRouter.use('/auto-google-auth', autoGoogleAuthRoutes);\r\nconsole.log('[ROUTER] Routes auto-google-auth mont\u00E9es sur /auto-google-auth');\r\n\r\n// Routes diverses (me, register, etc.)\r\napiRouter.use('/', miscRoutes);\r\nconsole.log('[ROUTER] Routes diverses mont\u00E9es sur /');\r\n\r\n// Routes de profil utilisateur\r\napiRouter.use('/profile', profileRoutes);\r\nconsole.log('[ROUTER] Routes profil mont\u00E9es sur /profile');\r\n\r\n// Route de d\u00E9connexion directe (attendue par le frontend)\r\napiRouter.post('/logout', logout);\r\nconsole.log('[ROUTER] Route de d\u00E9connexion mont\u00E9e sur /logout');\r\n\r\n// Routes des organisations\r\napiRouter.use('/organizations', organizationsRoutes);\r\nconsole.log('[ROUTER] Routes des organisations mont\u00E9es sur /organizations');\r\n\r\n// Routes de configuration Google Workspace par organisation\r\napiRouter.use('/organizations', googleWorkspaceRoutes);\r\nconsole.log('[ROUTER] Routes Google Workspace mont\u00E9es sur /organizations');\r\n\r\n// Routes Google Workspace pour les utilisateurs\r\napiRouter.use('/google-workspace', googleWorkspaceRoutes);\r\nconsole.log('[ROUTER] Routes Google Workspace utilisateurs mont\u00E9es sur /google-workspace');\r\n\r\n// Routes des modules\r\napiRouter.use('/modules', modulesRoutes);\r\nconsole.log('[ROUTER] Routes des modules mont\u00E9es sur /modules');\r\n\r\n// Routes administration modules DYNAMIQUE\r\napiRouter.use('/admin-modules', adminModulesRoutes);\r\nconsole.log('[ROUTER] Routes administration modules DYNAMIQUE mont\u00E9es sur /admin-modules');\r\n\r\n// Routes des ic\u00F4nes\r\napiRouter.use('/icons', iconsRoutes);\r\nconsole.log('[ROUTER] Routes des ic\u00F4nes mont\u00E9es sur /icons');\r\n\r\n// Routes des blocks\r\napiRouter.use('/blocks', blocksRoutes);\r\nconsole.log('[ROUTER] Routes des blocks mont\u00E9es sur /blocks');\r\n\r\n// Routes des fields (inclut validations/formulas/dependencies en sous-routes)\r\napiRouter.use('/fields', fieldsRoutes);\r\nconsole.log('[ROUTER] Routes des fields mont\u00E9es sur /fields');\r\n\r\n// Routes des sections (redirections + informations)\r\napiRouter.use('/sections', sectionsRoutes);\r\nconsole.log('[ROUTER] Routes des sections mont\u00E9es sur /sections (avec redirections)');\r\n\r\n// Routes de navigation des modules (module.category)\r\napiRouter.use('/module-navigation', moduleNavigationRoutes);\r\nconsole.log('[ROUTER] Routes navigation modules mont\u00E9es sur /module-navigation');\r\n\r\n// Routes des sections de formulaires (Block\u2192Section\u2192Field)  \r\napiRouter.use('/form-sections', formSectionsRoutes);\r\nconsole.log('[ROUTER] Routes sections formulaires mont\u00E9es sur /form-sections');\r\n\r\n// Routes des types de champs (Prisma FieldType)\r\napiRouter.use('/field-types', fieldTypesRoutes);\r\nconsole.log('[ROUTER] Routes des types de champs mont\u00E9es sur /field-types');\r\n\r\n// Routes des arborescences d'options (advanced_select)\r\napiRouter.use('/option-nodes', optionNodesRoutes);\r\nconsole.log('[ROUTER] Routes des option-nodes mont\u00E9es sur /option-nodes');\r\n\r\n// Routes des notifications\r\napiRouter.use('/notifications', notificationsRoutes);\r\nconsole.log('[ROUTER] Routes des notifications mont\u00E9es sur /notifications');\r\n\r\n// Routes du syst\u00E8me de notifications\r\napiRouter.use('/notifications-system', notificationSystemRoutes);\r\nconsole.log('[ROUTER] Routes du syst\u00E8me de notifications mont\u00E9es sur /notifications-system');\r\n\r\n// Routes des param\u00E8tres (settings)\r\napiRouter.use('/settings', settingsRoutes);\r\nconsole.log('[ROUTER] Routes des param\u00E8tres mont\u00E9es sur /settings');\r\n\r\n// Routes des leads\r\napiRouter.use('/leads', leadsRoutes);\r\nconsole.log('[ROUTER] Routes des leads mont\u00E9es sur /leads');\r\n\r\n// Routes du dashboard\r\napiRouter.use('/dashboard', dashboardRoutes);\r\nconsole.log('[ROUTER] Routes du dashboard mont\u00E9es sur /dashboard');\r\nconsole.log('[ROUTER] Routes des leads mont\u00E9es sur /leads');\r\n\r\n// Routes des clients (bas\u00E9es sur les leads)\r\napiRouter.use('/clients', clientsRoutes);\r\nconsole.log('[ROUTER] Routes des clients mont\u00E9es sur /clients');\r\n\r\n// Routes des entreprises/soci\u00E9t\u00E9s\r\napiRouter.use('/company', companyRoutes);\r\nconsole.log('[ROUTER] Routes des entreprises mont\u00E9es sur /company');\r\n\r\n// Routes des projets (bas\u00E9es sur les leads)\r\napiRouter.use('/projects', projectsRoutes);\r\nconsole.log('[ROUTER] Routes des projets mont\u00E9es sur /projects');\r\n\r\n// Routes des emails (Gmail int\u00E9gration)\r\napiRouter.use('/emails', emailsRoutes);\r\nconsole.log('[ROUTER] Routes des emails mont\u00E9es sur /emails');\r\n\r\n// Routes Gemini AI \uD83E\uDD16\r\napiRouter.use('/gemini', geminiRoutes);\r\nconsole.log('[ROUTER] Routes Gemini AI mont\u00E9es sur /gemini');\r\n\r\n// Routes des r\u00F4les\r\napiRouter.use('/roles', rolesRoutes);\r\nconsole.log('[ROUTER] Routes des r\u00F4les mont\u00E9es sur /roles');\r\n\r\n// Routes des permissions\r\napiRouter.use('/permissions', permissionsRoutes);\r\nconsole.log('[ROUTER] Routes des permissions mont\u00E9es sur /permissions');\r\n\r\n// Routes des utilisateurs\r\napiRouter.use('/users', usersRoutes);\r\nconsole.log('[ROUTER] Routes des utilisateurs mont\u00E9es sur /users');\r\n\r\n// Routes d'administration\r\napiRouter.use('/admin', adminRoutes);\r\nconsole.log('[ROUTER] Routes admin mont\u00E9es sur /admin');\r\n\r\n// Routes d'usurpation d'identit\u00E9\r\napiRouter.use('/impersonate', impersonateRoutes);\r\nconsole.log('[ROUTER] Routes usurpation mont\u00E9es sur /impersonate');\r\n\r\n// Routes d'administration des mots de passe\r\napiRouter.use('/admin-password', adminPasswordRoutes);\r\nconsole.log('[ROUTER] Routes admin-password mont\u00E9es sur /admin-password');\r\n\r\n// Routes Gmail\r\napiRouter.use('/gmail', gmailRoutes);\r\nconsole.log('[ROUTER] Routes Gmail mont\u00E9es sur /gmail');\r\n\r\n// Routes Calendar\r\napiRouter.use('/calendar', calendarRoutes);\r\nconsole.log('[ROUTER] Routes Calendar mont\u00E9es sur /calendar');\r\n\r\n// Routes Google Auth (OAuth)\r\napiRouter.use('/google-auth', googleAuthRoutes);\r\nconsole.log('[ROUTER] Routes Google Auth mont\u00E9es sur /google-auth');\r\n\r\n// Routes Google Scheduler (Refresh automatique des tokens)\r\napiRouter.use('/google/scheduler', googleSchedulerRoutes);\r\nconsole.log('[ROUTER] Routes Google Scheduler mont\u00E9es sur /google/scheduler');\r\n\r\n// Routes Google Tokens Monitoring\r\napiRouter.use('/google-tokens', googleTokensRoutes);\r\nconsole.log('[ROUTER] Routes Google Tokens Monitoring mont\u00E9es sur /google-tokens');\r\n\r\n// Routes Google Auth - Alias pour compatibilit\u00E9 Google Cloud Console\r\napiRouter.use('/auth/google', googleAuthRoutes);\r\nconsole.log('[ROUTER] Routes Google Auth (alias) mont\u00E9es sur /auth/google');\r\n\r\n// \uD83D\uDD27 **ULTRA-S\u00C9CURIS\u00C9** : Routes des services externes (Email, Telnyx)\r\napiRouter.use('/services', servicesRoutes);\r\nconsole.log('[ROUTER] Routes des services externes mont\u00E9es sur /services');\r\n\r\n// Routes Telnyx Communications\r\napiRouter.use('/telnyx', telnyxRoutes);\r\nconsole.log('[ROUTER] Routes Telnyx mont\u00E9es sur /telnyx');\r\n\r\n// Routes Devis (Quotes)\r\napiRouter.use('/quotes', quotesRoutes);\r\nconsole.log('[ROUTER] Routes Devis mont\u00E9es sur /quotes');\r\n\r\n// Routes Google Drive\r\napiRouter.use('/google-drive', googleDriveRoutes);\r\nconsole.log('[ROUTER] Routes Google Drive mont\u00E9es sur /google-drive');\r\n\r\n// Routes Google Meet\r\napiRouter.use('/google-meet', googleMeetRoutes);\r\nconsole.log('[ROUTER] Routes Google Meet mont\u00E9es sur /google-meet');\r\n\r\n// Routes Analytics\r\napiRouter.use('/analytics', analyticsRoutes);\r\nconsole.log('[ROUTER] Routes Analytics mont\u00E9es sur /analytics');\r\n\r\n// Routes Intelligence Artificielle\r\napiRouter.use('/ai', aiRoutes);\r\nconsole.log('[ROUTER] Routes IA mont\u00E9es sur /ai');\r\n\r\n// Routes Exploration Code IA (s\u00E9curis\u00E9es SuperAdmin)\r\napiRouter.use('/ai', aiCodeRoutes);\r\nconsole.log('[ROUTER] Routes IA Code mont\u00E9es sur /ai/code/*');\r\n\r\n// Routes Advanced Select Professional \uD83D\uDE80\r\napiRouter.use('/advanced-select', advancedSelectRoutes);\r\nconsole.log('[ROUTER] Routes Advanced Select mont\u00E9es sur /advanced-select');\r\n\r\n// Routes Syst\u00E8me Dynamique Universel \uD83C\uDF1F\r\napiRouter.use('/dynamic-formulas', dynamicFormulasRoutes);\r\nconsole.log('[ROUTER] Routes Syst\u00E8me Dynamique mont\u00E9es sur /dynamic-formulas');\r\n\r\n// Routes TreeBranchLeaf \uD83C\uDF33 NOUVEAU syst\u00E8me centralis\u00E9\r\napiRouter.use('/treebranchleaf', treeBranchLeafNewRoutes);\r\nconsole.log('[ROUTER] Routes TreeBranchLeaf NOUVEAU syst\u00E8me mont\u00E9es sur /treebranchleaf');\r\n\r\n// Routes TreeBranchLeaf V2 \uD83C\uDF33 (D\u00C9SACTIV\u00C9 - Migration vers architecture centralis\u00E9e)\r\n// apiRouter.use('/treebranchleaf-v2', treeBranchLeafV2Routes);\r\n// console.log('[ROUTER] Routes TreeBranchLeaf V2 mont\u00E9es sur /treebranchleaf-v2');\r\n\r\n// Routes TBL Intelligence \uD83E\uDDE0 (Intelligence pour formules, conditions, tableaux)\r\napiRouter.use('/tbl', tblIntelligenceRoutes);\r\nconsole.log('[ROUTER] Routes TBL Intelligence mont\u00E9es sur /tbl');\r\n\r\n// Routes TBL \uD83C\uDFAF (TreeBranchLeaf Business Logic)\r\napiRouter.use('/tbl', tblRoutes);\r\nconsole.log('[ROUTER] Routes TBL mont\u00E9es sur /tbl');\r\n\r\n// Routes TBL Capabilities (pr\u00E9-chargement des capacit\u00E9s sourceRef)\r\napiRouter.use('/tbl', tblCapabilitiesRoutes);\r\nconsole.log('[ROUTER] Routes TBL Capabilities mont\u00E9es sur /tbl');\r\n\r\n// ... (autres montages de routeurs)\r\n\r\n// Alias top-level pour les validations (DELETE/PATCH /api/validations/:id)\r\napiRouter.use('/validations', validationsRoutes);\r\nconsole.log('[ROUTER] Routes validations (top-level) mont\u00E9es sur /validations');\r\n\r\n// Alias top-level pour les formules (GET/PUT/DELETE /api/formulas/*)\r\napiRouter.use('/formulas', formulasApiRoutes);\r\nconsole.log('[ROUTER] Routes formules (top-level) mont\u00E9es sur /formulas');\r\n\r\n// Alias top-level pour les d\u00E9pendances (PUT/DELETE /api/dependencies/:id)\r\napiRouter.use('/dependencies', dependenciesApiRoutes);\r\nconsole.log('[ROUTER] Routes d\u00E9pendances (top-level) mont\u00E9es sur /dependencies');\r\n\r\n// Routes des invitations\r\napiRouter.use('/invitations', invitationRoutes);\r\nconsole.log('[ROUTER] Routes des invitations mont\u00E9es sur /invitations');\r\n\r\n// \uD83C\uDFAF DEVIS1MINUTE - Nouvelles routes modularis\u00E9es\r\napiRouter.use('/lead-generation', leadGenerationRoutes);\r\nconsole.log('[ROUTER] Routes Lead Generation mont\u00E9es sur /lead-generation');\r\n\r\napiRouter.use('/marketplace', marketplaceRoutes);\r\nconsole.log('[ROUTER] Routes Marketplace mont\u00E9es sur /marketplace');\r\n\r\napiRouter.use('/partner', partnerRoutes);\r\nconsole.log('[ROUTER] Routes Partner Portal mont\u00E9es sur /partner');\r\n\r\napiRouter.use('/forms', publicFormsRoutes);\r\nconsole.log('[ROUTER] Routes Public Forms mont\u00E9es sur /forms');\r\n\r\napiRouter.use('/public-forms', publicFormsRoutes);\r\nconsole.log('[ROUTER] Routes Public Forms mont\u00E9es sur /public-forms');\r\n\r\napiRouter.use('/landing-pages', landingPagesRoutes);\r\nconsole.log('[ROUTER] Routes Landing Pages mont\u00E9es sur /landing-pages');\r\n\r\napiRouter.use('/campaign-analytics', campaignAnalyticsRoutes);\r\nconsole.log('[ROUTER] Routes Campaign Analytics mont\u00E9es sur /campaign-analytics');\r\n\r\napiRouter.use('/dispatch', dispatchRoutes);\r\nconsole.log('[ROUTER] Routes Dispatch mont\u00E9es sur /dispatch');\r\n\r\n// Monter les deux routeurs d'int\u00E9grations: status agr\u00E9g\u00E9 + advertising/ecommerce\r\napiRouter.use('/integrations', integrationsRoutes);\r\napiRouter.use('/integrations', integrationsStatusRoutes);\r\nconsole.log('[ROUTER] Routes Integrations (status + advertising/ecommerce) mont\u00E9es sur /integrations');\r\n\r\n// \uD83C\uDF10 ROUTES PUBLIQUES (sans authentification requise)\r\napiRouter.use('/public', publicLeadsRoutes);\r\nconsole.log('[ROUTER] Routes Public API mont\u00E9es sur /public');\r\n\r\n// apiRouter.use('/auth/google', googleAuthRouter); // NOUVEAU: Authentification Google OAuth - Comment\u00E9 car non d\u00E9fini\r\n\r\n// Route simple pour v\u00E9rifier que l'API fonctionne (non authentifi\u00E9e)\r\napiRouter.get('/health', (_req, res) => {\r\n  res.json({ status: 'ok', timestamp: new Date().toISOString() });\r\n});\r\n\r\nexport default apiRouter;\r\n", "import { Router } from 'express';\r\nimport { login, getMe, logout } from '../controllers/authController';\r\n\r\nconst authRouter = Router();\r\n\r\nconsole.log('[AUTH ROUTES] Chargement des routes d\\'authentification');\r\n\r\n// Route de connexion (non authentifi\u00E9e)\r\nauthRouter.post('/login', login);\r\n\r\n// Route pour r\u00E9cup\u00E9rer les informations de l'utilisateur connect\u00E9 (authentifi\u00E9e)\r\nauthRouter.get('/me', getMe);\r\n\r\n// Route de d\u00E9connexion (authentifi\u00E9e)\r\nauthRouter.post('/logout', logout);\r\n\r\nconsole.log('[AUTH ROUTES] Routes d\\'authentification configur\u00E9es: /login, /me, /logout');\r\n\r\nexport default authRouter;\r\n", "import { PrismaClient } from '@prisma/client';\r\n\r\n// Fabrique robuste de l'URL de base de donn\u00E9es pour Prisma.\r\n// Objectif: \u00E9viter un crash au d\u00E9marrage si DATABASE_URL n'est pas d\u00E9fini sur Cloud Run\r\n// en le reconstruisant \u00E0 partir des variables PG* et/ou du socket Cloud SQL.\r\nfunction buildDatabaseUrl(): string {\r\n  const direct = process.env.DATABASE_URL;\r\n  if (direct && direct.trim().length > 0) {\r\n    return direct;\r\n  }\r\n\r\n  const user = process.env.PGUSER || 'postgres';\r\n  const password = process.env.PGPASSWORD || '';\r\n  const db = process.env.PGDATABASE || '2thier';\r\n\r\n  // Instance Cloud SQL (ex: thiernew:europe-west1:crm-db)\r\n  const instance = process.env.CLOUDSQL_INSTANCE || 'thiernew:europe-west1:crm-db';\r\n\r\n  // H\u00F4te: si PGHOST commence par /cloudsql, on l'utilise, sinon on utilise le socket de l'instance\r\n  const pgHost = process.env.PGHOST;\r\n  const socketHost = pgHost && pgHost.startsWith('/cloudsql/') ? pgHost : `/cloudsql/${instance}`;\r\n\r\n  const encodedPwd = encodeURIComponent(password);\r\n  // Pour les sockets Unix, Prisma recommande host=/cloudsql/INSTANCE en param\u00E8tre de requ\u00EAte, host r\u00E9seau = localhost\r\n  const url = `postgresql://${user}:${encodedPwd}@localhost:5432/${db}?host=${encodeURIComponent(socketHost)}`;\r\n\r\n  console.warn('[Prisma] DATABASE_URL non d\u00E9fini. URL reconstruite depuis PG* et Cloud SQL:', {\r\n    PGUSER: user,\r\n    PGDATABASE: db,\r\n    PGHOST: pgHost,\r\n    CLOUDSQL_INSTANCE: instance,\r\n    effectiveHostParam: socketHost\r\n  });\r\n\r\n  return url;\r\n}\r\n\r\n// Ajout pour \u00E9viter les multiples instances en d\u00E9veloppement avec le rechargement \u00E0 chaud de Vite\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined };\r\n\r\nconst prismaClient =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === 'development' ? ['query', 'info', 'warn', 'error'] : [],\r\n    // \uD83D\uDE80 Configuration optimis\u00E9e du connection pool\r\n    datasources: {\r\n      db: {\r\n        url: buildDatabaseUrl(),\r\n      },\r\n    },\r\n  // \u26A1 Optimisations de performance\r\n  // @ts-expect-error - Configuration avanc\u00E9e non typ\u00E9e\r\n    __internal: {\r\n      engine: {\r\n        // Connection pool optimis\u00E9 selon l'environnement\r\n        connection_limit: process.env.NODE_ENV === 'production' ? 20 : 5,\r\n        pool_timeout: 30, // secondes\r\n        connect_timeout: 10, // secondes\r\n      },\r\n    },\r\n  });\r\n\r\nexport const prisma = prismaClient;\r\n\r\nif (process.env.NODE_ENV !== 'production') {\r\n  globalForPrisma.prisma = prismaClient;\r\n}\r\n\r\n// Tentative de connexion non bloquante pour diagnostiquer les probl\u00E8mes de config en production\r\n// (n'emp\u00EAche pas le serveur de d\u00E9marrer si la DB est momentan\u00E9ment indisponible)\r\nvoid (async () => {\r\n  try {\r\n    // Ne pas faire \u00E9chouer le d\u00E9marrage: c'est un check best-effort\r\n    await prismaClient.$connect();\r\n    console.log('[Prisma] Connexion \u00E9tablie avec succ\u00E8s');\r\n  } catch (err) {\r\n    console.warn('[Prisma] \u00C9chec de connexion au d\u00E9marrage (le serveur continue). D\u00E9tails:', (err as Error)?.message);\r\n  }\r\n})();\r\n", "import { Request, Response } from 'express';\r\nimport { prisma } from '../lib/prisma';\r\nimport bcrypt from 'bcryptjs';\r\nimport jwt from 'jsonwebtoken';\r\nimport fs from 'fs';\r\n\r\n// Helper pour lire JWT_SECRET dynamiquement (am\u00E9lioration pour la production)\r\n// En local: utilise la valeur par d\u00E9faut ou .env\r\n// En production Cloud Run: lit depuis /run/secrets/JWT_SECRET\r\nconst getJWTSecret = (): string => {\r\n  // \u2705 PRIORIT\u00C9 1: Lire depuis process.env (variable d'environnement)\r\n  let secret = process.env.JWT_SECRET;\r\n  if (secret && secret.trim()) {\r\n    console.log('[AUTH] \u2705 JWT_SECRET trouv\u00E9 dans process.env');\r\n    return secret;\r\n  }\r\n\r\n  // \u2705 PRIORIT\u00C9 2: Lire depuis le fichier Cloud Run secret\r\n  const cloudRunSecretPath = '/run/secrets/JWT_SECRET';\r\n  if (fs.existsSync(cloudRunSecretPath)) {\r\n    try {\r\n      secret = fs.readFileSync(cloudRunSecretPath, 'utf-8').trim();\r\n      if (secret) {\r\n        console.log('[AUTH] \u2705 JWT_SECRET trouv\u00E9 dans /run/secrets/JWT_SECRET');\r\n        return secret;\r\n      }\r\n    } catch (err) {\r\n      console.error('[AUTH] \u274C Erreur \u00E0 la lecture de /run/secrets/JWT_SECRET:', err);\r\n    }\r\n  }\r\n\r\n  // \u274C FALLBACK: Cl\u00E9 de d\u00E9veloppement (ne jamais atteindre en production !)\r\n  console.warn('[AUTH] \u26A0\uFE0F JWT_SECRET non disponible, utilisation de la cl\u00E9 de d\u00E9veloppement');\r\n  return 'development-secret-key';\r\n};\r\n\r\nexport const login = async (req: Request, res: Response) => {\r\n  try {\r\n    const { email, password } = req.body;\r\n\r\n    if (!email || !password) {\r\n      return res.status(400).json({ message: 'Email et mot de passe requis' });\r\n    }\r\n\r\n    const user = await prisma.user.findUnique({\r\n      where: { email },\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            Organization: true,\r\n            Role: {\r\n              include: {\r\n                Permission: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!user || !user.passwordHash) {\r\n      return res.status(401).json({ message: 'Identifiants invalides' });\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(password, user.passwordHash);\r\n    if (!isPasswordValid) {\r\n      return res.status(401).json({ message: 'Identifiants invalides' });\r\n    }\r\n\r\n    const { passwordHash: _passwordHash, ...userWithoutPassword } = user;\r\n\r\n    // Extraire les r\u00F4les et permissions depuis UserOrganization\r\n    const userRoles = user.UserOrganization.map(uo => uo.Role);\r\n    const allPermissions = userRoles.flatMap(role => role.Permission || []);\r\n\r\n    // D\u00E9terminer si l'utilisateur est super admin\r\n    const isSuperAdmin = user.role === 'super_admin' || userRoles.some(role => role.name === 'super_admin');\r\n\r\n    const response = {\r\n      currentUser: {\r\n        ...userWithoutPassword,\r\n        role: isSuperAdmin ? 'super_admin' : (userRoles[0]?.name || user.role || 'user'),\r\n        permissions: allPermissions,\r\n        isSuperAdmin,\r\n        organizations: user.UserOrganization.map(uo => ({\r\n          id: uo.Organization.id,\r\n          name: uo.Organization.name,\r\n          status: uo.status\r\n        }))\r\n      },\r\n      originalUser: null,\r\n    };\r\n\r\n    // R\u00E9cup\u00E9rer l'organizationId de la premi\u00E8re organisation active (ou premi\u00E8re organisation si super admin)\r\n    const primaryOrganization = user.UserOrganization.find(uo => uo.status === 'active') || user.UserOrganization[0];\r\n    const organizationId = primaryOrganization?.organizationId;\r\n\r\n    // Cr\u00E9er le token JWT avec TOUTES les informations n\u00E9cessaires\r\n    const token = jwt.sign(\r\n      { \r\n        userId: user.id, \r\n        email: user.email,\r\n        organizationId: organizationId,\r\n        isSuperAdmin: isSuperAdmin,\r\n        role: isSuperAdmin ? 'super_admin' : (userRoles[0]?.name || user.role || 'user')\r\n      },\r\n      getJWTSecret(),\r\n      { expiresIn: '24h' }\r\n    );\r\n\r\n    // D\u00E9finir le cookie\r\n    res.cookie('token', token, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === 'production',\r\n      sameSite: 'strict',\r\n      maxAge: 24 * 60 * 60 * 1000, // 24 heures\r\n    });\r\n\r\n    console.log(`[AUTH] Connexion r\u00E9ussie pour ${email}`);\r\n    res.status(200).json(response);\r\n  } catch (error) {\r\n    console.error('[AUTH] Erreur lors de la connexion:', error);\r\n    res.status(500).json({ message: 'Erreur interne du serveur' });\r\n  }\r\n};\r\n\r\nexport const getMe = async (req: Request, res: Response) => {\r\n  try {\r\n    const token = req.cookies.token;\r\n\r\n    if (!token) {\r\n      return res.status(401).json({ message: 'Non authentifi\u00E9' });\r\n    }\r\n\r\n    const decoded = jwt.verify(token, getJWTSecret()) as { userId: string };\r\n\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: decoded.userId },\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            Organization: true,\r\n            Role: {\r\n              include: {\r\n                Permission: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n    });\r\n\r\n    if (!user) {\r\n      res.clearCookie('token');\r\n      return res.status(401).json({ message: 'Utilisateur introuvable' });\r\n    }\r\n\r\n    // Exclure le mot de passe de la r\u00E9ponse\r\n    const { passwordHash: _passwordHash2, ...userWithoutPassword } = user;\r\n\r\n    // Formater les organisations pour le frontend\r\n    const organizations = user.UserOrganization.map(uo => ({\r\n      id: uo.Organization.id,\r\n      name: uo.Organization.name,\r\n      status: uo.status,\r\n      role: uo.Role.name,\r\n      roleLabel: uo.Role.label,\r\n      permissions: uo.Role.Permission || []\r\n    }));\r\n\r\n    // S\u00E9lectionner l'organisation principale (premi\u00E8re active ou premi\u00E8re tout court)\r\n    const currentOrganization = organizations.find(org => org.status === 'ACTIVE') || organizations[0] || null;\r\n\r\n    // Extraire les r\u00F4les et permissions depuis UserOrganization\r\n    const userRoles = user.UserOrganization.map(uo => uo.Role);\r\n    const allPermissions = userRoles.flatMap(role => role.Permission || []);\r\n\r\n    // D\u00E9terminer si l'utilisateur est super admin\r\n    const isSuperAdmin = user.role === 'super_admin' || userRoles.some(role => role.name === 'super_admin');\r\n\r\n    // Formater la r\u00E9ponse selon ce que le frontend attend\r\n    const response = {\r\n      currentUser: {\r\n        ...userWithoutPassword,\r\n        role: isSuperAdmin ? 'super_admin' : (userRoles[0]?.name || user.role || 'user'),\r\n        permissions: allPermissions,\r\n        isSuperAdmin,\r\n        organizations: organizations, // Ajouter les organisations format\u00E9es\r\n        currentOrganization: currentOrganization // Ajouter l'organisation actuelle\r\n      },\r\n      originalUser: null // Pour l'usurpation d'identit\u00E9, null par d\u00E9faut\r\n    };\r\n\r\n    console.log(`[AUTH] R\u00E9cup\u00E9ration des donn\u00E9es utilisateur pour ${user.email}`);\r\n    res.status(200).json(response);\r\n  } catch (error) {\r\n    console.error('[AUTH] Erreur lors de la v\u00E9rification du token:', error);\r\n    res.clearCookie('token');\r\n    res.status(401).json({ message: 'Token invalide ou expir\u00E9' });\r\n  }\r\n};\r\n\r\nexport const logout = (_req: Request, res: Response) => {\r\n  try {\r\n    res.clearCookie('token');\r\n    console.log('[AUTH] D\u00E9connexion r\u00E9ussie');\r\n    res.status(200).json({ message: 'D\u00E9connexion r\u00E9ussie' });\r\n  } catch (error) {\r\n    console.error('[AUTH] Erreur lors de la d\u00E9connexion:', error);\r\n    res.status(500).json({ message: 'Erreur lors de la d\u00E9connexion' });\r\n  }\r\n};\r\n", "import express from 'express';\r\nimport { authenticateToken, extractOrganization } from '../middleware/auth';\r\nimport * as gmailController from '../google-auth/controllers/GmailController';\r\n\r\nconst router = express.Router();\r\n\r\nconsole.log(\"<<<<< [D\u00C9MARRAGE] Le fichier 'src/routes/gmailRoutes.ts' est en cours de chargement avec le nouveau contr\u00F4leur centralis\u00E9. >>>>>\");\r\n\r\n// Appliquer la cha\u00EEne de middlewares correcte pour TOUTES les routes Gmail.\r\n// 1. authenticateToken: V\u00E9rifie le JWT et attache un req.user partiel.\r\n// TEMPORAIRE: On utilise seulement authenticateToken pour d\u00E9bloquer Gmail\r\nrouter.use(authenticateToken);\r\n// Harmoniser l'organisation depuis le header sur req.user (fallback possible c\u00F4t\u00E9 contr\u00F4leur)\r\nrouter.use(extractOrganization);\r\n\r\n// Les routes ci-dessous sont maintenant prot\u00E9g\u00E9es et auront acc\u00E8s \u00E0 un req.user complet.\r\nrouter.get('/threads', gmailController.getThreads);\r\nrouter.get('/messages', gmailController.getMessages);\r\nrouter.get('/messages/:id', gmailController.getMessage);\r\nrouter.post('/messages/send', gmailController.sendMessage);\r\nrouter.post('/messages/:id/modify', gmailController.modifyMessage); // Ajout pour la modification (\u00E9toile, etc.)\r\nrouter.post('/messages/:id/trash', gmailController.trashMessage); // Ajout pour la suppression\r\nrouter.post('/messages/:id/untrash', gmailController.untrashMessage); // Ajout pour restaurer\r\nrouter.delete('/messages/:id', gmailController.deleteMessage); // Ajout pour la suppression d\u00E9finitive\r\nrouter.post('/trash/empty', gmailController.emptyTrash); // Ajout pour vider la corbeille\r\nrouter.get('/labels', gmailController.getLabels);\r\nrouter.post('/labels', gmailController.createLabel); // Ajout pour la cr\u00E9ation de labels/dossiers\r\nrouter.put('/labels/:id', gmailController.updateLabel); // Ajout pour la modification de labels/dossiers\r\nrouter.delete('/labels/:id', gmailController.deleteLabel); // Ajout pour la suppression de labels/dossiers\r\nrouter.get('/messages/:messageId/attachments/:attachmentId', gmailController.getAttachment); // \uD83D\uDD04 Ajout pour t\u00E9l\u00E9charger les pi\u00E8ces jointes\r\n\r\n// Endpoint de sant\u00E9/diagnostic Gmail\r\nrouter.get('/health', gmailController.health);\r\n\r\nexport default router;\r\n", "import { Request, Response, NextFunction } from 'express';\r\nimport jwt from 'jsonwebtoken';\r\nimport prisma from '../prisma';\r\nimport { JWT_SECRET as CONFIG_JWT_SECRET } from '../config';\r\n\r\ninterface AuthenticatedRequest extends Request {\r\n  user?: {\r\n    id: string;\r\n    email: string;\r\n    organizationId?: string;\r\n    isSuperAdmin: boolean;\r\n    role?: string;\r\n  };\r\n}\r\n\r\n// Unifier le secret avec la configuration globale pour \u00E9viter les 401\r\nconst JWT_SECRET = CONFIG_JWT_SECRET;\r\nconsole.log('[AUTH] \uD83D\uDD10 JWT_SECRET prefix:', typeof JWT_SECRET === 'string' ? JWT_SECRET.substring(0, 6) + '...' : 'invalid');\r\n\r\nexport const authenticateToken = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  console.log('[AUTH] \uD83D\uDD0D authenticateToken - D\u00E9but');\r\n  console.log('[AUTH] \uD83D\uDCCB URL:', req.originalUrl);\r\n  console.log('[AUTH] \uD83D\uDCCB Method:', req.method);\r\n  console.log('[AUTH] \uD83D\uDD10 Using JWT_SECRET prefix:', typeof JWT_SECRET === 'string' ? JWT_SECRET.substring(0, 6) + '...' : 'invalid');\r\n  // Bypass pour tests internes (\u00E9viter besoin de token dans tests d'int\u00E9gration cibl\u00E9s)\r\n  if (req.headers['x-test-bypass-auth'] === '1') {\r\n    req.user = req.user || {\r\n      id: 'test-user',\r\n      email: 'test@example.com',\r\n      organizationId: 'org-test',\r\n      isSuperAdmin: true,\r\n      role: 'super_admin'\r\n    };\r\n    console.log('[AUTH] \uD83D\uDEA9 Bypass auth activ\u00E9 (x-test-bypass-auth)');\r\n    return next();\r\n  }\r\n  \r\n  const authHeader = req.headers['authorization'];\r\n  let token = authHeader && authHeader.split(' ')[1];\r\n  \r\n  console.log('[AUTH] \uD83D\uDCCB Auth header pr\u00E9sent:', !!authHeader);\r\n  \r\n  // Si pas de token dans l'en-t\u00EAte, v\u00E9rifier les cookies\r\n  if (!token && req.cookies && req.cookies.token) {\r\n    token = req.cookies.token;\r\n    console.log('[AUTH] \uD83C\uDF6A Token trouv\u00E9 dans les cookies');\r\n  }\r\n\r\n  if (!token) {\r\n    console.log('[AUTH] \u274C Aucun token trouv\u00E9');\r\n    return res.status(401).json({ error: 'Token d\\'acc\u00E8s requis' });\r\n  }\r\n\r\n  console.log('[AUTH] \uD83D\uDD11 Token pr\u00E9sent, v\u00E9rification...');\r\n\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET) as {\r\n      userId: string;\r\n      email: string;\r\n      organizationId?: string;\r\n      isSuperAdmin: boolean;\r\n      role?: string;\r\n      exp?: number;\r\n    };\r\n\r\n    console.log('[AUTH] \u2705 Token valide, utilisateur:', decoded.userId);\r\n    console.log('[AUTH] \uD83D\uDCCB Email:', decoded.email);\r\n    console.log('[AUTH] \uD83D\uDCCB OrganizationId:', decoded.organizationId);\r\n    console.log('[AUTH] \uD83D\uDCCB SuperAdmin:', decoded.isSuperAdmin);\r\n\r\n    // Correction : garantir que le champ 'role' est toujours pr\u00E9sent pour les super admins\r\n    if (!decoded.role && decoded.isSuperAdmin) {\r\n      decoded.role = 'super_admin';\r\n      console.log('[AUTH] \uD83D\uDC51 R\u00F4le super_admin assign\u00E9 automatiquement');\r\n    }\r\n    \r\n    req.user = { ...decoded, id: decoded.userId }; // Assurer la pr\u00E9sence de id et userId\r\n    console.log('[AUTH] \u2705 req.user assign\u00E9:', { id: req.user.id, userId: req.user.userId, email: req.user.email });\r\n    console.log('[AUTH] \u2705 authenticateToken termin\u00E9 avec succ\u00E8s');\r\n    next();\r\n  } catch (error) {\r\n    console.log('[AUTH] \u274C Token invalide ou expir\u00E9:', error.message);\r\n    console.log('[AUTH] \u274C Erreur d\u00E9taill\u00E9e:', error);\r\n    return res.status(401).json({ error: 'Token invalide ou expir\u00E9' });\r\n  }\r\n};\r\n\r\n/**\r\n * Middleware pour enrichir req.user avec les donn\u00E9es compl\u00E8tes de la base de donn\u00E9es.\r\n * Doit \u00EAtre appel\u00E9 APR\u00C8S authenticateToken.\r\n * Ne perturbe pas le flux d'authentification existant.\r\n */\r\nexport const fetchFullUser = async (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  console.log(\"<<<<< [MIDDLEWARE] fetchFullUser: Ex\u00E9cution. >>>>>\");\r\n\r\n  if (!req.user || !req.user.userId) {\r\n    console.log(\"<<<<< [MIDDLEWARE] fetchFullUser: req.user ou req.user.userId manquant. Le middleware authenticateToken doit \u00EAtre ex\u00E9cut\u00E9 avant. >>>>>\");\r\n    return res.status(401).json({ message: \"Utilisateur non authentifi\u00E9.\" });\r\n  }\r\n\r\n  try {\r\n    const userFromDb = await prisma.user.findUnique({\r\n      where: { id: req.user.userId },\r\n    });\r\n\r\n    if (!userFromDb) {\r\n      console.log(`<<<<< [MIDDLEWARE] fetchFullUser: Utilisateur avec ID ${req.user.userId} non trouv\u00E9 dans la DB. >>>>>`);\r\n      return res.status(401).json({ message: \"Utilisateur non valide.\" });\r\n    }\r\n\r\n    // Enrichir req.user avec les donn\u00E9es compl\u00E8tes de la base de donn\u00E9es\r\n    req.user = { ...userFromDb, ...req.user };\r\n    \r\n    console.log(\"<<<<< [MIDDLEWARE] fetchFullUser: req.user enrichi avec succ\u00E8s. >>>>>\");\r\n    next();\r\n  } catch (error) {\r\n    console.error(\"<<<<< [MIDDLEWARE] fetchFullUser: Erreur lors de la r\u00E9cup\u00E9ration de l'utilisateur.\", error);\r\n    res.status(500).json({ message: \"Erreur interne du serveur.\" });\r\n  }\r\n};\r\n\r\n// Middleware pour v\u00E9rifier le r\u00F4le administrateur ou super_admin\r\nexport const isAdmin = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  const role = req.user?.role?.toLowerCase().replace(/_/g, '');\r\n\r\n  // Correction : inclure super_admin dans la logique de v\u00E9rification\r\n  if (role === 'admin' || role === 'superadmin') {\r\n    return next();\r\n  }\r\n\r\n  return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9. R\u00F4le Administrateur requis.' });\r\n};\r\n\r\nexport const requireSuperAdmin = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  if (!req.user?.isSuperAdmin) {\r\n    return res.status(403).json({ error: 'Acc\u00E8s r\u00E9serv\u00E9 aux Super Admins' });\r\n  }\r\n  next();\r\n};\r\n\r\nexport const requireOrganization = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  if (!req.user?.organizationId && !req.user?.isSuperAdmin) {\r\n    return res.status(403).json({ error: 'Organisation requise' });\r\n  }\r\n  next();\r\n};\r\n\r\n// Middleware pour extraire l'ID d'organisation\r\nexport const extractOrganization = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  // L'organisation peut venir du token JWT ou du header\r\n  const orgHeader = req.headers['x-organization-id'] as string;\r\n  if (orgHeader && req.user) {\r\n    req.user.organizationId = orgHeader;\r\n  }\r\n  next();\r\n};\r\n\r\nexport { AuthenticatedRequest };\r\n", "import { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport default prisma;", "// src/config.prod.ts\r\n// Configuration pour l'environnement de production\r\n\r\n// Forcer le mode production\r\nexport const IS_PRODUCTION = true;\r\n\r\n// Param\u00E8tres d'authentification\r\nexport const JWT_SECRET = process.env.JWT_SECRET || 'prod_secret_key_change_me';\r\nexport const TOKEN_EXPIRY = '24h';  // Dur\u00E9e de validit\u00E9 du token en production\r\n\r\n// Param\u00E8tres de l'API\r\nexport const API_URL = process.env.API_URL || 'https://api.crmpro.com';\r\nexport const ENABLE_API_LOGS = false;  // D\u00E9sactiver les logs d\u00E9taill\u00E9s en production\r\n\r\n// D\u00E9sactiver les fonctionnalit\u00E9s de d\u00E9veloppement\r\nexport const DISABLE_DEV_FEATURES = true;\r\nexport const DISABLE_MOCK_DATA = true;\r\nexport const FORCE_REAL_DATA = true;\r\n\r\nexport const SECURITY = {\r\n  REQUIRE_AUTH: true,          // Toujours exiger une authentification\r\n  VALIDATE_TOKENS: true,       // Valider les tokens JWT\r\n  ENFORCE_PERMISSIONS: true    // Appliquer strictement les permissions\r\n};\r\n", "// src/config.ts\r\n// Configuration globale de l'application\r\n\r\nimport * as prodConfig from './config.prod';\r\nimport fs from 'fs';\r\n\r\n// D\u00E9terminer si nous sommes en production\r\nconst isProduction = process.env.NODE_ENV === 'production';\r\n\r\n// \uD83D\uDD10 Fonction pour lire JWT_SECRET depuis plusieurs sources\r\nconst getJWTSecretFromConfig = (): string => {\r\n  // \u2705 PRIORIT\u00C9 1: process.env (variables d'environnement Google Secret Manager)\r\n  let secret = process.env.JWT_SECRET;\r\n  if (secret && secret.trim()) {\r\n    console.log('[CONFIG] \u2705 JWT_SECRET trouv\u00E9 dans process.env');\r\n    return secret;\r\n  }\r\n\r\n  // \u2705 PRIORIT\u00C9 2: Fichier Cloud Run secret\r\n  const cloudRunSecretPath = '/run/secrets/JWT_SECRET';\r\n  if (fs.existsSync(cloudRunSecretPath)) {\r\n    try {\r\n      secret = fs.readFileSync(cloudRunSecretPath, 'utf-8').trim();\r\n      if (secret) {\r\n        console.log('[CONFIG] \u2705 JWT_SECRET trouv\u00E9 dans /run/secrets/JWT_SECRET');\r\n        return secret;\r\n      }\r\n    } catch (err) {\r\n      console.error('[CONFIG] \u274C Erreur \u00E0 la lecture de /run/secrets/JWT_SECRET:', err);\r\n    }\r\n  }\r\n\r\n  // \u274C FALLBACK: Cl\u00E9 de d\u00E9veloppement/production par d\u00E9faut\r\n  const fallbackSecret = isProduction ? 'prod_secret_key' : 'dev_secret_key';\r\n  if (isProduction) {\r\n    console.warn('[CONFIG] \u26A0\uFE0F JWT_SECRET non disponible en production, utilisateur une cl\u00E9 par d\u00E9faut');\r\n  }\r\n  return fallbackSecret;\r\n};\r\n\r\n// Configuration de base\r\nexport const IS_PRODUCTION = isProduction;\r\nexport const JWT_SECRET = getJWTSecretFromConfig();\r\nexport const TOKEN_EXPIRY = isProduction ? '24h' : '8h';\r\n\r\n// Configuration API\r\n// Base API dynamique : on \u00E9vite de figer 'http://localhost:4000' afin de ne pas le retrouver dans le bundle prod.\r\n// En dev, le hook useAuthenticatedApi g\u00E8re d\u00E9j\u00E0 un fallback local si aucune variable n'est d\u00E9finie.\r\nexport const API_URL = process.env.API_URL || (isProduction ? 'https://api.crmpro.com' : '');\r\nexport const ENABLE_API_LOGS = !isProduction;\r\n\r\n// Fonctionnalit\u00E9s de d\u00E9veloppement\r\nexport const DISABLE_DEV_FEATURES = isProduction;\r\nexport const DISABLE_MOCK_DATA = isProduction;\r\nexport const FORCE_REAL_DATA = isProduction;\r\n\r\n// S\u00E9curit\u00E9\r\nexport const SECURITY = {\r\n  REQUIRE_AUTH: isProduction,      // Toujours exiger une authentification en production\r\n  VALIDATE_TOKENS: isProduction,   // Toujours valider les tokens JWT en production\r\n  ENFORCE_PERMISSIONS: isProduction // Toujours appliquer les permissions en production\r\n};\r\n\r\n// En production, utiliser la configuration de production\r\nif (isProduction) {\r\n  console.log('Application en mode PRODUCTION');\r\n  Object.assign(exports, prodConfig);\r\n} else {\r\n  console.log('Application en mode D\u00C9VELOPPEMENT');\r\n}\r\n", "import { google } from 'googleapis';\r\nimport { OAuth2Client, Credentials } from 'google-auth-library';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { randomUUID } from 'crypto';\r\n\r\nimport {\r\n  googleOAuthConfig,\r\n  GOOGLE_OAUTH_SCOPES,\r\n  describeGoogleOAuthConfig,\r\n  isGoogleOAuthConfigured,\r\n} from '../../auth/googleConfig';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nconst { clientId: GOOGLE_CLIENT_ID, clientSecret: GOOGLE_CLIENT_SECRET, redirectUri: GOOGLE_REDIRECT_URI } = googleOAuthConfig;\r\n\r\nexport const GOOGLE_SCOPES_LIST = [...GOOGLE_OAUTH_SCOPES];\r\n\r\nconst SCOPES = GOOGLE_SCOPES_LIST;\r\n\r\n// Interface pour les informations utilisateur de Google\r\ninterface UserInfo {\r\n  id?: string | null;\r\n  email?: string | null;\r\n  name?: string | null;\r\n  given_name?: string | null;\r\n  family_name?: string | null;\r\n  picture?: string | null;\r\n  locale?: string | null;\r\n}\r\n\r\nexport class GoogleOAuthService {\r\n  private oauth2Client: OAuth2Client;\r\n\r\n  constructor() {\r\n    console.log('[GoogleOAuthService] Initialisation configuration Google OAuth (core)');\r\n    if (!isGoogleOAuthConfigured()) {\r\n      console.warn('[GoogleOAuthService] \u26A0\uFE0F Configuration Google OAuth incompl\u00E8te', describeGoogleOAuthConfig());\r\n    } else {\r\n      console.log('[GoogleOAuthService] \u2705 Configuration d\u00E9tect\u00E9e', describeGoogleOAuthConfig());\r\n    }\r\n    console.log('[GoogleOAuthService] GOOGLE_REDIRECT_URI:', GOOGLE_REDIRECT_URI);\r\n\r\n    this.oauth2Client = new google.auth.OAuth2(\r\n      GOOGLE_CLIENT_ID,\r\n      GOOGLE_CLIENT_SECRET,\r\n      GOOGLE_REDIRECT_URI\r\n    );\r\n  }\r\n\r\n  // G\u00E9n\u00E9rer l'URL d'autorisation Google\r\n  getAuthUrl(userId: string, organizationId: string): string {\r\n    console.log(`[GoogleOAuthService] G\u00E9n\u00E9ration URL pour userId: ${userId}, organizationId: ${organizationId}`);\r\n    console.log('[GoogleOAuthService] Scopes:', SCOPES);\r\n    \r\n    const state = JSON.stringify({ userId, organizationId });\r\n\r\n    const authUrl = this.oauth2Client.generateAuthUrl({\r\n      access_type: 'offline',\r\n      scope: SCOPES,\r\n      state: state,\r\n      prompt: 'consent'\r\n    });\r\n    \r\n    console.log('[GoogleOAuthService] URL g\u00E9n\u00E9r\u00E9e:', authUrl);\r\n    return authUrl;\r\n  }\r\n\r\n  // \u00C9changer le code contre des tokens\r\n  async getTokenFromCode(code: string): Promise<Credentials> {\r\n    const { tokens } = await this.oauth2Client.getToken(code);\r\n    return tokens;\r\n  }\r\n\r\n  // Sauvegarder les tokens\r\n  async saveUserTokens(userId: string, organizationId: string, tokens: Credentials) {\r\n    if (!organizationId) {\r\n      throw new Error(\"L'ID de l'organisation est requis pour sauvegarder les tokens Google.\");\r\n    }\r\n\r\n    const updateData = {\r\n      accessToken: tokens.access_token!,\r\n      // IMPORTANT : Toujours mettre \u00E0 jour le refresh_token s'il est fourni.\r\n      // Google peut en envoyer un nouveau lors du 'consent'.\r\n      refreshToken: tokens.refresh_token,\r\n      tokenType: tokens.token_type || 'Bearer',\r\n      expiresAt: tokens.expiry_date ? new Date(tokens.expiry_date) : null,\r\n      scope: tokens.scope,\r\n      updatedAt: new Date()\r\n    };\r\n\r\n    const existingToken = await prisma.googleToken.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    if (existingToken) {\r\n      await prisma.googleToken.update({\r\n        where: { organizationId },\r\n        data: {\r\n          accessToken: updateData.accessToken,\r\n          // Ne met \u00E0 jour le refresh token que s'il est nouveau, sinon conserve l'ancien\r\n          refreshToken: updateData.refreshToken ?? existingToken.refreshToken,\r\n          expiresAt: updateData.expiresAt,\r\n          scope: updateData.scope,\r\n          updatedAt: updateData.updatedAt,\r\n          lastRefreshAt: new Date(),\r\n          refreshCount: { increment: 1 }\r\n        }\r\n      });\r\n    } else {\r\n      await prisma.googleToken.create({\r\n        data: {\r\n          id: randomUUID(),\r\n          organizationId,\r\n          accessToken: updateData.accessToken,\r\n          refreshToken: updateData.refreshToken,\r\n          tokenType: updateData.tokenType,\r\n          expiresAt: updateData.expiresAt,\r\n          scope: updateData.scope,\r\n          updatedAt: new Date(),\r\n        }\r\n      });\r\n    }\r\n    console.log(`[GoogleOAuthService] Tokens sauvegard\u00E9s/mis \u00E0 jour pour l'utilisateur ${userId} (org: ${organizationId})`);\r\n  }\r\n\r\n  // R\u00E9cup\u00E9rer les tokens par userId (en passant par l'utilisateur et son organisation)\r\n  async getUserTokens(userId: string) {\r\n    // D'abord, r\u00E9cup\u00E9rer l'utilisateur avec sa relation UserOrganization\r\n    const userWithOrg = await prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { \r\n        UserOrganization: {\r\n          take: 1, // Prendre la premi\u00E8re organisation\r\n          orderBy: { createdAt: 'desc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!userWithOrg || !userWithOrg.UserOrganization[0]) {\r\n      console.log(`[GoogleOAuthService] Utilisateur ${userId} ou organisation non trouv\u00E9`);\r\n      return null;\r\n    }\r\n\r\n    const organizationId = userWithOrg.UserOrganization[0].organizationId;\r\n\r\n    // Puis r\u00E9cup\u00E9rer les tokens pour cette organisation\r\n    return await prisma.googleToken.findUnique({\r\n      where: { organizationId }\r\n    });\r\n  }\r\n\r\n  // Client authentifi\u00E9 avec email administrateur Google Workspace\r\n  async getAuthenticatedClientForOrganization(organizationId: string): Promise<OAuth2Client | null> {\r\n    console.log(`[GoogleOAuthService] \u26A1 getAuthenticatedClientForOrganization appel\u00E9 pour organizationId: ${organizationId}`);\r\n    \r\n    // R\u00E9cup\u00E9rer l'organisation et sa config Google Workspace\r\n    const organization = await prisma.organization.findUnique({\r\n      where: { id: organizationId },\r\n      include: {\r\n        GoogleWorkspaceConfig: true,\r\n      },\r\n    });\r\n\r\n    if (!organization) {\r\n      console.log(`[GoogleOAuthService] \u274C Organisation ${organizationId} non trouv\u00E9e`);\r\n      return null;\r\n    }\r\n\r\n    const googleConfig = organization.GoogleWorkspaceConfig;\r\n\r\n    if (!googleConfig || !googleConfig.adminEmail || !googleConfig.domain) {\r\n      console.log(`[GoogleOAuthService] \u274C Configuration Google Workspace (adminEmail ou domain) manquante pour l'organisation ${organization.name}`);\r\n      return null;\r\n    }\r\n\r\n    console.log(`[GoogleOAuthService] \uD83D\uDCE7 Email administrateur Google Workspace: ${googleConfig.adminEmail}`);\r\n    console.log(`[GoogleOAuthService] \uD83C\uDFE2 Domaine: ${googleConfig.domain}`);\r\n\r\n    // R\u00E9cup\u00E9rer les tokens pour cette organisation\r\n    const tokens = await prisma.googleToken.findUnique({\r\n      where: { organizationId: organization.id }\r\n    });\r\n\r\n    if (!tokens) {\r\n      console.log(`[GoogleOAuthService] \u274C Aucun token trouv\u00E9 pour l'organisation ${organization.name}`);\r\n      return null;\r\n    }\r\n\r\n    console.log(`[GoogleOAuthService] \uD83D\uDD0D Tokens trouv\u00E9s pour l'organisation ${organization.name}:`);\r\n    console.log(`[GoogleOAuthService] - Access token: ${tokens.accessToken ? tokens.accessToken.substring(0, 20) + '...' : 'MANQUANT'}`);\r\n    console.log(`[GoogleOAuthService] - Refresh token: ${tokens.refreshToken ? tokens.refreshToken.substring(0, 20) + '...' : 'MANQUANT'}`);\r\n    console.log(`[GoogleOAuthService] - Expires at: ${tokens.expiresAt}`);\r\n\r\n    // Configuration des credentials\r\n    const credentials = {\r\n      access_token: tokens.accessToken,\r\n      refresh_token: tokens.refreshToken,\r\n      token_type: tokens.tokenType,\r\n      expiry_date: tokens.expiresAt?.getTime()\r\n    };\r\n    \r\n    console.log(`[GoogleOAuthService] \uD83D\uDD27 Configuration credentials pour ${googleConfig.adminEmail}:`, {\r\n      hasAccessToken: !!credentials.access_token,\r\n      accessTokenLength: credentials.access_token?.length,\r\n      hasRefreshToken: !!credentials.refresh_token,\r\n      refreshTokenLength: credentials.refresh_token?.length,\r\n      tokenType: credentials.token_type,\r\n      expiryDate: credentials.expiry_date ? new Date(credentials.expiry_date).toISOString() : 'NON_D\u00C9FINI'\r\n    });\r\n\r\n    // Cr\u00E9er une nouvelle instance OAuth2Client pour l'admin\r\n    const adminOAuth2Client = new google.auth.OAuth2(\r\n      GOOGLE_CLIENT_ID,\r\n      GOOGLE_CLIENT_SECRET,\r\n      GOOGLE_REDIRECT_URI\r\n    );\r\n\r\n    adminOAuth2Client.setCredentials(credentials);\r\n    \r\n    console.log(`[GoogleOAuthService] \uD83D\uDCCB Credentials d\u00E9finies sur OAuth2Client pour admin ${googleConfig.adminEmail}`);\r\n\r\n    // V\u00E9rifier si le token est expir\u00E9 et le rafra\u00EEchir si n\u00E9cessaire\r\n    const now = new Date();\r\n    const expiryDate = tokens.expiresAt;\r\n    \r\n    console.log(`[GoogleOAuthService] \u23F0 V\u00E9rification expiration: maintenant=${now.toISOString()}, expiry=${expiryDate?.toISOString()}`);\r\n    \r\n    if (expiryDate && expiryDate <= now) {\r\n      console.log(`[GoogleOAuthService] \u26A0\uFE0F Token expir\u00E9 pour l'admin ${googleConfig.adminEmail}, rafra\u00EEchissement...`);\r\n      try {\r\n        const { credentials: newCredentials } = await adminOAuth2Client.refreshAccessToken();\r\n        console.log(`[GoogleOAuthService] \u2705 Rafra\u00EEchissement r\u00E9ussi pour admin`);\r\n        \r\n        if (newCredentials.access_token && newCredentials.expiry_date) {\r\n          await prisma.googleToken.update({\r\n            where: { organizationId: organization.id },\r\n            data: {\r\n              accessToken: newCredentials.access_token,\r\n              // Mettre \u00E0 jour le refresh token SEULEMENT s'il est nouveau\r\n              refreshToken: newCredentials.refresh_token ?? tokens.refreshToken,\r\n              tokenType: newCredentials.token_type || 'Bearer',\r\n              expiresAt: new Date(newCredentials.expiry_date),\r\n              updatedAt: new Date(),\r\n              lastRefreshAt: new Date(),\r\n              refreshCount: { increment: 1 }\r\n            }\r\n          });\r\n        }\r\n      } catch (error) {\r\n        console.error(`[GoogleOAuthService] \u274C \u00C9chec du rafra\u00EEchissement pour admin ${googleConfig.adminEmail}:`, error);\r\n        return null;\r\n      }\r\n    } else if (expiryDate) {\r\n      console.log(`[GoogleOAuthService] \u2705 Token encore valide pour admin ${googleConfig.adminEmail} (expire dans ${Math.round((expiryDate.getTime() - now.getTime()) / 1000 / 60)} minutes)`);\r\n    }\r\n\r\n    console.log(`[GoogleOAuthService] \uD83D\uDE80 Retour du client OAuth2 configur\u00E9 pour admin ${googleConfig.adminEmail}`);\r\n    return adminOAuth2Client;\r\n  }\r\n\r\n  // Client authentifi\u00E9\r\n  async getAuthenticatedClient(userId: string): Promise<OAuth2Client | null> {\r\n    console.log(`[GoogleOAuthService] \u26A1 getAuthenticatedClient appel\u00E9 pour userId: ${userId}`);\r\n    \r\n    const tokens = await this.getUserTokens(userId);\r\n    if (!tokens) {\r\n      console.log(`[GoogleOAuthService] \u274C Aucun token trouv\u00E9 pour l'utilisateur ${userId}`);\r\n      return null;\r\n    }\r\n\r\n    console.log(`[GoogleOAuthService] \uD83D\uDD0D Tokens trouv\u00E9s pour ${userId}:`);\r\n    console.log(`[GoogleOAuthService] - Access token: ${tokens.accessToken ? tokens.accessToken.substring(0, 20) + '...' : 'MANQUANT'}`);\r\n    console.log(`[GoogleOAuthService] - Refresh token: ${tokens.refreshToken ? tokens.refreshToken.substring(0, 20) + '...' : 'MANQUANT'}`);\r\n    console.log(`[GoogleOAuthService] - Expires at: ${tokens.expiresAt}`);\r\n\r\n    // Configuration des credentials\r\n    const credentials = {\r\n      access_token: tokens.accessToken,\r\n      refresh_token: tokens.refreshToken,\r\n      token_type: tokens.tokenType,\r\n      expiry_date: tokens.expiresAt?.getTime()\r\n    };\r\n    \r\n    console.log(`[GoogleOAuthService] \uD83D\uDD27 Configuration credentials:`, {\r\n      hasAccessToken: !!credentials.access_token,\r\n      accessTokenLength: credentials.access_token?.length,\r\n      hasRefreshToken: !!credentials.refresh_token,\r\n      refreshTokenLength: credentials.refresh_token?.length,\r\n      tokenType: credentials.token_type,\r\n      expiryDate: credentials.expiry_date ? new Date(credentials.expiry_date).toISOString() : 'NON_D\u00C9FINI'\r\n    });\r\n\r\n    // Cr\u00E9er une NOUVELLE instance OAuth2Client pour cet utilisateur\r\n    const userOAuth2Client = new google.auth.OAuth2(\r\n      GOOGLE_CLIENT_ID,\r\n      GOOGLE_CLIENT_SECRET,\r\n      GOOGLE_REDIRECT_URI\r\n    );\r\n\r\n    userOAuth2Client.setCredentials(credentials);\r\n    \r\n    console.log(`[GoogleOAuthService] \uD83D\uDCCB Credentials d\u00E9finies sur nouveau OAuth2Client`);\r\n\r\n    // V\u00E9rifier si le token est expir\u00E9 et le rafra\u00EEchir si n\u00E9cessaire\r\n    const now = new Date();\r\n    const expiryDate = tokens.expiresAt;\r\n    \r\n    console.log(`[GoogleOAuthService] \u23F0 V\u00E9rification expiration: maintenant=${now.toISOString()}, expiry=${expiryDate?.toISOString()}`);\r\n    \r\n    if (expiryDate && expiryDate <= now) {\r\n      console.log(`[GoogleOAuthService] \u26A0\uFE0F Token expir\u00E9 pour l'utilisateur ${userId}, rafra\u00EEchissement...`);\r\n      try {\r\n        // Utiliser la m\u00E9thode refresh du client OAuth2\r\n        const { credentials } = await userOAuth2Client.refreshAccessToken();\r\n        console.log(`[GoogleOAuthService] \u2705 Rafra\u00EEchissement r\u00E9ussi, nouvelles credentials:`, {\r\n          hasAccessToken: !!credentials.access_token,\r\n          hasRefreshToken: !!credentials.refresh_token,\r\n          newExpiry: credentials.expiry_date ? new Date(credentials.expiry_date).toISOString() : 'NON_D\u00C9FINI'\r\n        });\r\n        \r\n        if (credentials.access_token && credentials.expiry_date) {\r\n          // Mettre \u00E0 jour les tokens en base\r\n          await this.updateUserTokens(userId, {\r\n            accessToken: credentials.access_token,\r\n            refreshToken: credentials.refresh_token || tokens.refreshToken, // Garde l'ancien si pas de nouveau\r\n            tokenType: credentials.token_type || 'Bearer',\r\n            expiresAt: new Date(credentials.expiry_date)\r\n        });\r\n        \r\n        console.log(`[GoogleOAuthService] \u2705 Token rafra\u00EEchi avec succ\u00E8s pour l'utilisateur ${userId}`);\r\n      }\r\n    } catch (error) {\r\n      console.error(`[GoogleOAuthService] \u274C \u00C9chec du rafra\u00EEchissement du token pour ${userId}:`, error);\r\n      return null;\r\n    }\r\n  } else if (expiryDate) {\r\n    console.log(`[GoogleOAuthService] \u2705 Token encore valide pour ${userId} (expire dans ${Math.round((expiryDate.getTime() - now.getTime()) / 1000 / 60)} minutes)`);\r\n  } else {\r\n    console.log(`[GoogleOAuthService] \u26A0\uFE0F Pas de date d'expiration d\u00E9finie pour ${userId}`);\r\n  }\r\n\r\n  console.log(`[GoogleOAuthService] \uD83D\uDE80 Retour du nouveau client OAuth2 configur\u00E9 pour ${userId}`);\r\n  return userOAuth2Client;\r\n  }\r\n\r\n  // M\u00E9thode pour mettre \u00E0 jour les tokens existants\r\n  private async updateUserTokens(userId: string, tokenData: {\r\n    accessToken: string;\r\n    refreshToken: string;\r\n    tokenType: string;\r\n    expiresAt: Date;\r\n  }) {\r\n    // R\u00E9cup\u00E9rer l'utilisateur avec sa relation UserOrganization\r\n    const userWithOrg = await prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { \r\n        UserOrganization: {\r\n          take: 1,\r\n          orderBy: { createdAt: 'desc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!userWithOrg || !userWithOrg.UserOrganization[0]) {\r\n      throw new Error(`Utilisateur ${userId} ou organisation non trouv\u00E9`);\r\n    }\r\n\r\n    const organizationId = userWithOrg.UserOrganization[0].organizationId;\r\n\r\n    await prisma.googleToken.update({\r\n      where: { organizationId },\r\n      data: {\r\n        accessToken: tokenData.accessToken,\r\n        refreshToken: tokenData.refreshToken,\r\n        tokenType: tokenData.tokenType,\r\n        expiresAt: tokenData.expiresAt\r\n      }\r\n    });\r\n  }\r\n\r\n  // V\u00E9rifier si connect\u00E9\r\n  async isUserConnected(userId: string): Promise<boolean> {\r\n    const tokens = await this.getUserTokens(userId);\r\n    return !!tokens;\r\n  }\r\n\r\n  // D\u00E9connecter l'utilisateur\r\n  async disconnectUser(userId: string) {\r\n    try {\r\n      const tokens = await this.getUserTokens(userId);\r\n      if (tokens?.refreshToken) {\r\n        // R\u00E9voquer le refresh token, ce qui invalide l'acc\u00E8s.\r\n        await this.oauth2Client.revokeToken(tokens.refreshToken);\r\n        console.log(`[GoogleOAuthService] Token r\u00E9voqu\u00E9 pour l'utilisateur ${userId}`);\r\n      }\r\n    } catch (error) {\r\n      console.error(`[GoogleOAuthService] \u00C9chec de la r\u00E9vocation du token pour ${userId}:`, error);\r\n      // On continue m\u00EAme si la r\u00E9vocation \u00E9choue pour supprimer les donn\u00E9es locales\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer l'utilisateur avec sa relation UserOrganization\r\n    const userWithOrg = await prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: { \r\n        UserOrganization: {\r\n          take: 1, // Prendre la premi\u00E8re organisation\r\n          orderBy: { createdAt: 'desc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (userWithOrg?.UserOrganization[0]) {\r\n      const organizationId = userWithOrg.UserOrganization[0].organizationId;\r\n      // Supprimer de la base de donn\u00E9es avec organizationId\r\n      await prisma.googleToken.delete({ where: { organizationId } });\r\n      console.log(`[GoogleOAuthService] Tokens supprim\u00E9s de la DB pour l'utilisateur ${userId} (org: ${organizationId})`);\r\n    } else {\r\n      console.log(`[GoogleOAuthService] Impossible de trouver l'organization pour l'utilisateur ${userId}`);\r\n    }\r\n  }\r\n\r\n  // Tester la connexion\r\n  async testConnection(userId: string): Promise<{ success: boolean; userInfo?: UserInfo; error?: string }> {\r\n    try {\r\n      const auth = await this.getAuthenticatedClient(userId);\r\n      if (!auth) return { success: false, error: 'Non connect\u00E9' };\r\n\r\n      const oauth2 = google.oauth2({ version: 'v2', auth });\r\n      const response = await oauth2.userinfo.get();\r\n      return { success: true, userInfo: response.data };\r\n    } catch (error: unknown) {\r\n      console.error(`[GoogleOAuthService] Erreur lors du test de connexion pour ${userId}:`, error);\r\n      if (error instanceof Error) {\r\n        return { success: false, error: error.message };\r\n      }\r\n      return { success: false, error: 'Une erreur inconnue est survenue' };\r\n    }\r\n  }\r\n}\r\n\r\nexport const googleOAuthService = new GoogleOAuthService();\r\n", "import type { OAuth2ClientOptions } from 'google-auth-library';\r\n\r\n/**\r\n * Source unique de v\u00E9rit\u00E9 pour la configuration Google OAuth / Workspace.\r\n * Centralise les acc\u00E8s aux variables d'environnement afin d'\u00E9viter les divergences\r\n * entre l'API, les jobs (Cloud Run) et le frontend.\r\n */\r\n\r\ntype EnvSource = Record<string, unknown> | undefined;\r\n\r\nconst envCache = new Map<string, string | undefined>();\r\n\r\nconst DEFAULT_PROD_API_BASE = 'https://api.2thier.com';\r\nconst DEFAULT_DEV_API_BASE = 'http://localhost:4000';\r\n\r\nfunction readEnvFromImportMeta(key: string): string | undefined {\r\n  try {\r\n    const meta = import.meta as unknown as { env?: EnvSource };\r\n    const candidate = meta?.env?.[key];\r\n    if (typeof candidate === 'string' && candidate.trim()) {\r\n      return candidate.trim();\r\n    }\r\n  } catch {\r\n    // ignore \u2013 import.meta non disponible dans le contexte\r\n  }\r\n  return undefined;\r\n}\r\n\r\nfunction readEnv(key: string): string | undefined {\r\n  if (envCache.has(key)) {\r\n    return envCache.get(key);\r\n  }\r\n\r\n  let value: string | undefined;\r\n\r\n  if (typeof process !== 'undefined' && process.env && typeof process.env[key] === 'string') {\r\n    value = process.env[key]?.trim();\r\n  }\r\n\r\n  if (!value) {\r\n    value = readEnvFromImportMeta(key);\r\n  }\r\n\r\n  if (value) {\r\n    envCache.set(key, value);\r\n  } else {\r\n    envCache.set(key, undefined);\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nfunction computeRedirectUri(): string {\r\n  const explicit = readEnv('GOOGLE_REDIRECT_URI');\r\n  if (explicit) {\r\n    return explicit;\r\n  }\r\n\r\n  const base =\r\n    readEnv('API_URL') ||\r\n    readEnv('BACKEND_URL') ||\r\n    readEnv('FRONTEND_URL');\r\n\r\n  const fallbackBase = (readEnv('NODE_ENV') || '').toLowerCase() === 'production'\r\n    ? DEFAULT_PROD_API_BASE\r\n    : DEFAULT_DEV_API_BASE;\r\n\r\n  const trimmedBase = (base || fallbackBase).replace(/\\/$/, '');\r\n  return `${trimmedBase}/api/google-auth/callback`;\r\n}\r\n\r\nexport const GOOGLE_OAUTH_SCOPES: readonly string[] = [\r\n  'https://www.googleapis.com/auth/userinfo.email',\r\n  'https://www.googleapis.com/auth/userinfo.profile',\r\n  'https://mail.google.com/',\r\n  'https://www.googleapis.com/auth/gmail.readonly',\r\n  'https://www.googleapis.com/auth/gmail.send',\r\n  'https://www.googleapis.com/auth/gmail.modify',\r\n  'https://www.googleapis.com/auth/gmail.labels',\r\n  'https://www.googleapis.com/auth/calendar',\r\n  'https://www.googleapis.com/auth/calendar.events',\r\n  'https://www.googleapis.com/auth/drive',\r\n  'https://www.googleapis.com/auth/documents',\r\n  'https://www.googleapis.com/auth/spreadsheets',\r\n  'https://www.googleapis.com/auth/presentations',\r\n  'https://www.googleapis.com/auth/meetings',\r\n  'https://www.googleapis.com/auth/contacts',\r\n  'https://www.googleapis.com/auth/forms',\r\n  'https://www.googleapis.com/auth/script.projects',\r\n  'https://www.googleapis.com/auth/admin.directory.user',\r\n  'https://www.googleapis.com/auth/admin.directory.group',\r\n  'https://www.googleapis.com/auth/admin.directory.orgunit',\r\n  'https://www.googleapis.com/auth/admin.directory.resource.calendar',\r\n];\r\n\r\nexport interface GoogleOAuthConfig {\r\n  clientId: string;\r\n  clientSecret: string;\r\n  redirectUri: string;\r\n  projectId?: string;\r\n  oauthOptions: OAuth2ClientOptions;\r\n}\r\n\r\nfunction buildOAuthOptions(clientId: string, clientSecret: string, redirectUri: string): OAuth2ClientOptions {\r\n  return {\r\n    clientId: clientId || undefined,\r\n    clientSecret: clientSecret || undefined,\r\n    redirectUri,\r\n  };\r\n}\r\n\r\nexport const googleOAuthConfig: GoogleOAuthConfig = (() => {\r\n  const clientId = readEnv('GOOGLE_CLIENT_ID') ?? '';\r\n  const clientSecret = readEnv('GOOGLE_CLIENT_SECRET') ?? '';\r\n  const redirectUri = computeRedirectUri();\r\n  const projectId =\r\n    readEnv('GOOGLE_PROJECT_ID') ||\r\n    readEnv('GOOGLE_CLOUD_PROJECT') ||\r\n    readEnv('GOOGLE_CLOUD_PROJECT_ID') ||\r\n    readEnv('GOOGLE_PROJECT_NUMBER');\r\n\r\n  return {\r\n    clientId,\r\n    clientSecret,\r\n    redirectUri,\r\n    projectId,\r\n    oauthOptions: buildOAuthOptions(clientId, clientSecret, redirectUri),\r\n  };\r\n})();\r\n\r\nexport function isGoogleOAuthConfigured(): boolean {\r\n  return Boolean(googleOAuthConfig.clientId && googleOAuthConfig.clientSecret);\r\n}\r\n\r\nexport function describeGoogleOAuthConfig(): Record<string, string | boolean | undefined> {\r\n  return {\r\n    clientId: googleOAuthConfig.clientId ? '[set]' : '[missing]',\r\n    clientSecret: googleOAuthConfig.clientSecret ? '[set]' : '[missing]',\r\n    redirectUri: googleOAuthConfig.redirectUri,\r\n    projectId: googleOAuthConfig.projectId,\r\n    scopes: GOOGLE_OAUTH_SCOPES.length,\r\n    isConfigured: isGoogleOAuthConfigured(),\r\n  };\r\n}\r\n\r\nexport function resetGoogleOAuthConfigCache(): void {\r\n  envCache.clear();\r\n}\r\n", "/**\r\n * GOOGLE AUTHENTICATION MANAGER - MODULE CENTRAL\r\n * \r\n * Ce module centralise toute la logique d'authentification Google Workspace.\r\n * Il est le SEUL point d'entr\u00E9e pour obtenir un client Google authentifi\u00E9.\r\n * \r\n * Logique d'authentification :\r\n * - L'utilisateur se connecte au CRM avec son email personnel (ex: dethier.jls@gmail.com)\r\n * - Pour Google Workspace, on utilise l'email administrateur de l'organisation (ex: jonathan.dethier@2thier.be)\r\n * - Cet email administrateur est configur\u00E9 dans googleWorkspaceConfig.adminEmail\r\n * - Les tokens sont stock\u00E9s au niveau de l'organisation, pas de l'utilisateur\r\n */\r\n\r\nimport { OAuth2Client } from 'google-auth-library';\r\nimport { googleOAuthService } from './GoogleOAuthCore';\r\n\r\nexport class GoogleAuthManager {\r\n  private static instance: GoogleAuthManager;\r\n\r\n  private constructor() {\r\n    // Utilise l'instance singleton existante du service\r\n  }\r\n\r\n  public static getInstance(): GoogleAuthManager {\r\n    if (!GoogleAuthManager.instance) {\r\n      GoogleAuthManager.instance = new GoogleAuthManager();\r\n    }\r\n    return GoogleAuthManager.instance;\r\n  }\r\n\r\n  /**\r\n   * Obtient un client Google authentifi\u00E9 pour une organisation\r\n   * \r\n   * @param organizationId - ID de l'organisation\r\n   * @returns Client OAuth2 authentifi\u00E9 ou null si \u00E9chec\r\n   */\r\n  async getAuthenticatedClient(organizationId: string): Promise<OAuth2Client | null> {\r\n    if (!organizationId) {\r\n      console.error('[GoogleAuthManager] \u274C organizationId est requis');\r\n      return null;\r\n    }\r\n\r\n    console.log(`[GoogleAuthManager] \uD83D\uDD10 Demande de client authentifi\u00E9 pour l'organisation: ${organizationId}`);\r\n    \r\n    try {\r\n      return await googleOAuthService.getAuthenticatedClientForOrganization(organizationId);\r\n    } catch (error) {\r\n      console.error('[GoogleAuthManager] \u274C Erreur lors de l\\'obtention du client authentifi\u00E9:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * G\u00E9n\u00E8re une URL d'autorisation Google\r\n   * \r\n   * @param userId - ID de l'utilisateur\r\n   * @param organizationId - ID de l'organisation\r\n   * @returns URL d'autorisation\r\n   */\r\n  getAuthorizationUrl(userId: string, organizationId: string): string {\r\n    return googleOAuthService.getAuthUrl(userId, organizationId);\r\n  }\r\n\r\n  /**\r\n   * \u00C9change un code d'autorisation contre des tokens\r\n   * \r\n   * @param code - Code d'autorisation re\u00E7u de Google\r\n   * @param userId - ID de l'utilisateur\r\n   * @param organizationId - ID de l'organisation\r\n   */\r\n  async exchangeCodeForTokens(code: string, userId: string, organizationId: string): Promise<void> {\r\n    const tokens = await googleOAuthService.getTokenFromCode(code);\r\n    await googleOAuthService.saveUserTokens(userId, organizationId, tokens);\r\n  }\r\n}\r\n\r\n// Export de l'instance singleton\r\nexport const googleAuthManager = GoogleAuthManager.getInstance();\r\n", "/**\r\n * SERVICE GOOGLE CALENDAR - UTILISANT LE MODULE D'AUTHENTIFICATION CENTRALIS\u00C9\r\n * \r\n * Ce service utilise exclusivement le GoogleAuthManager pour obtenir les clients authentifi\u00E9s.\r\n * Il ne contient AUCUNE logique d'authentification propre.\r\n */\r\n\r\nimport { google } from 'googleapis';\r\nimport { googleAuthManager } from '../index';\r\n\r\nexport interface CalendarEvent {\r\n  id?: string;\r\n  summary: string;\r\n  description?: string;\r\n  start: {\r\n    dateTime: string;\r\n    timeZone?: string;\r\n  };\r\n  end: {\r\n    dateTime: string;\r\n    timeZone?: string;\r\n  };\r\n  attendees?: Array<{\r\n    email: string;\r\n    displayName?: string;\r\n  }>;\r\n}\r\n\r\nexport class GoogleCalendarService {\r\n  private static instance: GoogleCalendarService;\r\n\r\n  private constructor() {}\r\n\r\n  public static getInstance(): GoogleCalendarService {\r\n    if (!GoogleCalendarService.instance) {\r\n      GoogleCalendarService.instance = new GoogleCalendarService();\r\n    }\r\n    return GoogleCalendarService.instance;\r\n  }\r\n\r\n  /**\r\n   * Obtient une instance de l'API Google Calendar pour une organisation\r\n   */\r\n  private async getCalendarAPI(organizationId: string) {\r\n    console.log(`[GoogleCalendarService] \uD83D\uDCC5 Cr\u00E9ation instance API Calendar pour organisation: ${organizationId}`);\r\n    \r\n    const authClient = await googleAuthManager.getAuthenticatedClient(organizationId);\r\n    if (!authClient) {\r\n      throw new Error('Connexion Google non configur\u00E9e.');\r\n    }\r\n\r\n    return google.calendar({ version: 'v3', auth: authClient });\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re les \u00E9v\u00E9nements du calendrier\r\n   */\r\n  async getEvents(organizationId: string, startDate?: Date, endDate?: Date): Promise<CalendarEvent[]> {\r\n    try {\r\n      const calendar = await this.getCalendarAPI(organizationId);\r\n\r\n      const params = {\r\n        calendarId: 'primary',\r\n        singleEvents: true,\r\n        orderBy: 'startTime' as const,\r\n        maxResults: 100,\r\n        timeMin: startDate?.toISOString(),\r\n        timeMax: endDate?.toISOString(),\r\n      };\r\n\r\n      const response = await calendar.events.list(params);\r\n      const events = response.data.items || [];\r\n\r\n      return events.map(event => ({\r\n        id: event.id,\r\n        summary: event.summary || 'Sans titre',\r\n        description: event.description,\r\n        start: {\r\n          dateTime: event.start?.dateTime || event.start?.date || '',\r\n          timeZone: event.start?.timeZone,\r\n        },\r\n        end: {\r\n          dateTime: event.end?.dateTime || event.end?.date || '',\r\n          timeZone: event.end?.timeZone,\r\n        },\r\n        attendees: event.attendees?.map(attendee => ({\r\n          email: attendee.email || '',\r\n          displayName: attendee.displayName,\r\n        })),\r\n      }));\r\n    } catch (error) {\r\n      console.error('[GoogleCalendarService] \u274C Erreur lors de la r\u00E9cup\u00E9ration des \u00E9v\u00E9nements:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cr\u00E9e un nouvel \u00E9v\u00E9nement\r\n   */\r\n  async createEvent(organizationId: string, event: CalendarEvent): Promise<string> {\r\n    try {\r\n      const calendar = await this.getCalendarAPI(organizationId);\r\n\r\n      const response = await calendar.events.insert({\r\n        calendarId: 'primary',\r\n        requestBody: {\r\n          summary: event.summary,\r\n          description: event.description,\r\n          start: event.start,\r\n          end: event.end,\r\n          attendees: event.attendees,\r\n        },\r\n      });\r\n\r\n      return response.data.id!;\r\n    } catch (error) {\r\n      console.error('[GoogleCalendarService] \u274C Erreur lors de la cr\u00E9ation de l\\'\u00E9v\u00E9nement:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Met \u00E0 jour un \u00E9v\u00E9nement existant\r\n   */\r\n  async updateEvent(organizationId: string, eventId: string, event: Partial<CalendarEvent>): Promise<void> {\r\n    try {\r\n      const calendar = await this.getCalendarAPI(organizationId);\r\n\r\n      await calendar.events.update({\r\n        calendarId: 'primary',\r\n        eventId: eventId,\r\n        requestBody: {\r\n          summary: event.summary,\r\n          description: event.description,\r\n          start: event.start,\r\n          end: event.end,\r\n          attendees: event.attendees,\r\n        },\r\n      });\r\n    } catch (error) {\r\n      console.error('[GoogleCalendarService] \u274C Erreur lors de la mise \u00E0 jour de l\\'\u00E9v\u00E9nement:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Supprime un \u00E9v\u00E9nement\r\n   */\r\n  async deleteEvent(organizationId: string, eventId: string): Promise<void> {\r\n    try {\r\n      const calendar = await this.getCalendarAPI(organizationId);\r\n\r\n      await calendar.events.delete({\r\n        calendarId: 'primary',\r\n        eventId: eventId,\r\n      });\r\n    } catch (error) {\r\n      console.error('[GoogleCalendarService] \u274C Erreur lors de la suppression de l\\'\u00E9v\u00E9nement:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Synchronise les \u00E9v\u00E9nements avec Google Calendar\r\n   */\r\n  async syncEvents(organizationId: string, startDate: Date, endDate: Date): Promise<CalendarEvent[]> {\r\n    console.log(`[GoogleCalendarService] \uD83D\uDD04 Synchronisation des \u00E9v\u00E9nements pour l'organisation: ${organizationId}`);\r\n    console.log(`[GoogleCalendarService] \uD83D\uDCC5 P\u00E9riode: ${startDate.toISOString()} -> ${endDate.toISOString()}`);\r\n    \r\n    return await this.getEvents(organizationId, startDate, endDate);\r\n  }\r\n}\r\n\r\n// Export de l'instance singleton\r\nexport const googleCalendarService = GoogleCalendarService.getInstance();\r\n", "/**\r\n * GOOGLE GMAIL SERVICE - SERVICE CENTRALIS\u00C9\r\n * \r\n * Service pour toutes les op\u00E9rations Gmail utilisant l'authentification centralis\u00E9e.\r\n * Ce service garantit l'utilisation correcte des tokens d'organisation.\r\n */\r\n\r\nimport { google, gmail_v1 } from 'googleapis';\r\nimport { googleAuthManager } from '../core/GoogleAuthManager';\r\n\r\nexport interface EmailAttachment {\r\n  attachmentId: string;\r\n  filename: string;\r\n  mimeType: string;\r\n  size: number;\r\n}\r\n\r\nexport interface FormattedGmailMessage {\r\n  id: string;\r\n  threadId: string;\r\n  subject: string;\r\n  from: string;\r\n  to: string;\r\n  date: Date;\r\n  snippet: string;\r\n  labels: string[];\r\n  isRead: boolean;\r\n  isStarred: boolean;\r\n  hasAttachments: boolean;\r\n  attachments?: EmailAttachment[];\r\n  htmlBody?: string;\r\n}\r\n\r\nexport interface GmailLabel {\r\n  id: string;\r\n  name: string;\r\n  type: string;\r\n  messageListVisibility?: string;\r\n  labelListVisibility?: string;\r\n}\r\n\r\nexport interface GmailHeader {\r\n  name: string;\r\n  value: string;\r\n}\r\n\r\nexport interface GmailPayloadPart {\r\n  mimeType?: string;\r\n  filename?: string;\r\n  body?: {\r\n    data?: string;\r\n    size?: number;\r\n  };\r\n  parts?: GmailPayloadPart[];\r\n}\r\n\r\nexport interface GmailDraft {\r\n  draftId: string;\r\n  messageId: string;\r\n  subject: string;\r\n  to: string;\r\n  cc?: string;\r\n  bcc?: string;\r\n  body: string;\r\n  isHtml?: boolean;\r\n  date: Date;\r\n}\r\n\r\nexport class GoogleGmailService {\r\n  private gmail: gmail_v1.Gmail;\r\n  private organizationId: string;\r\n  private adminEmail: string | null = null;\r\n\r\n  constructor(gmail: gmail_v1.Gmail, organizationId: string) {\r\n    this.gmail = gmail;\r\n    this.organizationId = organizationId;\r\n  }\r\n\r\n  /**\r\n   * Cr\u00E9e une instance du service Gmail pour une organisation\r\n   */\r\n  static async create(organizationId: string): Promise<GoogleGmailService | null> {\r\n    console.log(`[GoogleGmailService] Cr\u00E9ation du service pour l'organisation: ${organizationId}`);\r\n    \r\n    const authClient = await googleAuthManager.getAuthenticatedClient(organizationId);\r\n    if (!authClient) {\r\n      console.error(`[GoogleGmailService] Impossible d'obtenir le client authentifi\u00E9 pour l'organisation: ${organizationId}`);\r\n      return null;\r\n    }\r\n\r\n    const gmail = google.gmail({ version: 'v1', auth: authClient });\r\n    const service = new GoogleGmailService(gmail, organizationId);\r\n    \r\n    // R\u00E9cup\u00E9rer l'email administrateur pour l'utiliser comme exp\u00E9diteur\r\n    await service.loadOrganizationInfo();\r\n    \r\n    return service;\r\n  }\r\n\r\n  /**\r\n   * Charge les informations de l'organisation (email admin, etc.)\r\n   */\r\n  private async loadOrganizationInfo(): Promise<void> {\r\n    try {\r\n      // Utilisation directe de Prisma pour r\u00E9cup\u00E9rer l'email admin\r\n      const { PrismaClient } = await import('@prisma/client');\r\n      const prisma = new PrismaClient();\r\n      \r\n      const organization = await prisma.organization.findUnique({\r\n        where: { id: this.organizationId },\r\n        include: {\r\n          GoogleWorkspaceConfig: true,\r\n        },\r\n      });\r\n\r\n      if (organization?.GoogleWorkspaceConfig?.adminEmail) {\r\n        this.adminEmail = organization.GoogleWorkspaceConfig.adminEmail;\r\n        console.log(`[GoogleGmailService] \uD83D\uDCE7 Email admin charg\u00E9: ${this.adminEmail}`);\r\n      } else {\r\n        console.warn(`[GoogleGmailService] \u26A0\uFE0F Email admin non trouv\u00E9 pour l'organisation ${this.organizationId}`);\r\n      }\r\n      \r\n      await prisma.$disconnect();\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] Erreur lors du chargement des infos organisation:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re la liste des messages Gmail\r\n   */\r\n  async getMessages(options: {\r\n    maxResults?: number;\r\n    pageToken?: string;\r\n    q?: string; // Query de recherche Gmail\r\n    labelIds?: string[];\r\n  } = {}): Promise<{\r\n    messages: FormattedGmailMessage[];\r\n    nextPageToken?: string;\r\n    totalEstimate?: number;\r\n  }> {\r\n    console.log('[GoogleGmailService] R\u00E9cup\u00E9ration des messages Gmail...');\r\n\r\n    const {\r\n      maxResults = 10,\r\n      pageToken,\r\n      q,\r\n      labelIds\r\n    } = options;\r\n\r\n    try {\r\n      // R\u00E9cup\u00E9rer la liste des messages\r\n      const messagesResponse = await this.gmail.users.messages.list({\r\n        userId: 'me',\r\n        maxResults,\r\n        pageToken,\r\n        q,\r\n        labelIds\r\n      });\r\n\r\n      const messages = messagesResponse.data.messages || [];\r\n      console.log(`[GoogleGmailService] ${messages.length} messages trouv\u00E9s`);\r\n\r\n      // R\u00E9cup\u00E9rer les d\u00E9tails de chaque message\r\n      const formattedMessages: FormattedGmailMessage[] = [];\r\n      \r\n      for (const message of messages) {\r\n        if (message.id) {\r\n          const messageDetails = await this.getMessageDetails(message.id);\r\n          if (messageDetails) {\r\n            formattedMessages.push(messageDetails);\r\n          }\r\n        }\r\n      }\r\n\r\n      return {\r\n        messages: formattedMessages,\r\n        nextPageToken: messagesResponse.data.nextPageToken,\r\n        totalEstimate: messagesResponse.data.resultSizeEstimate\r\n      };\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] Erreur lors de la r\u00E9cup\u00E9ration des messages:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re les d\u00E9tails d'un message Gmail\r\n   */\r\n  async getMessageDetails(messageId: string): Promise<FormattedGmailMessage | null> {\r\n    try {\r\n      const response = await this.gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: messageId,\r\n        format: 'full'\r\n      });\r\n\r\n      const message = response.data;\r\n      if (!message.payload || !message.payload.headers) {\r\n        return null;\r\n      }\r\n\r\n      const headers = message.payload.headers;\r\n      const getHeader = (name: string): string => {\r\n        const header = headers.find(h => h.name?.toLowerCase() === name.toLowerCase());\r\n        return header?.value || '';\r\n      };\r\n\r\n      // Extraire le contenu HTML\r\n      let htmlBody = '';\r\n      if (message.payload.parts) {\r\n        htmlBody = this.extractHtmlFromParts(message.payload.parts);\r\n      } else if (message.payload.body?.data) {\r\n        htmlBody = Buffer.from(message.payload.body.data, 'base64').toString('utf-8');\r\n      }\r\n\r\n      // Extraire les pi\u00E8ces jointes\r\n      const attachments = this.extractAttachments(message.payload);\r\n\r\n      return {\r\n        id: message.id!,\r\n        threadId: message.threadId!,\r\n        subject: getHeader('Subject'),\r\n        from: getHeader('From'),\r\n        to: getHeader('To'),\r\n        date: new Date(parseInt(message.internalDate || '0')),\r\n        snippet: message.snippet || '',\r\n        labels: message.labelIds || [],\r\n        isRead: !message.labelIds?.includes('UNREAD'),\r\n        isStarred: message.labelIds?.includes('STARRED') || false,\r\n        hasAttachments: attachments.length > 0,\r\n        attachments,\r\n        htmlBody\r\n      };\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la r\u00E9cup\u00E9ration du message ${messageId}:`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Envoie un email (avec support des pi\u00E8ces jointes) - VERSION ANTI-SPAM\r\n   */\r\n  async sendEmail(options: {\r\n    to: string;\r\n    subject: string;\r\n    body: string;\r\n    isHtml?: boolean;\r\n    cc?: string;\r\n    bcc?: string;\r\n    attachments?: Array<{\r\n      filename: string;\r\n      content: Buffer;\r\n      mimeType: string;\r\n    }>;\r\n    fromName?: string; // \uD83C\uDD95 Nom professionnel de l'exp\u00E9diteur\r\n  }): Promise<{ messageId: string } | null> {\r\n    console.log(`[GoogleGmailService] \uD83D\uDCE7 Envoi professionnel d'un email \u00E0: ${options.to} avec ${options.attachments?.length || 0} pi\u00E8ces jointes`);\r\n\r\n    try {\r\n      let message = '';\r\n      const boundary = 'boundary_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\r\n      \r\n      // \uD83D\uDD27 HEADERS PROFESSIONNELS ANTI-SPAM\r\n      \r\n      // From professionnel avec nom d'affichage\r\n      if (this.adminEmail) {\r\n        const fromName = options.fromName || '2Thier CRM';\r\n        message += `From: \"${fromName}\" <${this.adminEmail}>\\r\\n`;\r\n      }\r\n      \r\n      message += `To: ${options.to}\\r\\n`;\r\n      message += `Subject: ${options.subject}\\r\\n`;\r\n      \r\n      if (options.cc) {\r\n        message += `Cc: ${options.cc}\\r\\n`;\r\n      }\r\n      if (options.bcc) {\r\n        message += `Bcc: ${options.bcc}\\r\\n`;\r\n      }\r\n      \r\n      // \uD83C\uDD95 HEADERS DE D\u00C9LIVRABILIT\u00C9 CRITIQUES\r\n      message += `Date: ${new Date().toUTCString()}\\r\\n`;\r\n      message += `Message-ID: <${Date.now()}.${Math.random().toString(36).substr(2)}.crm@2thier.be>\\r\\n`;\r\n      message += `MIME-Version: 1.0\\r\\n`;\r\n      \r\n      // Headers de l\u00E9gitimit\u00E9 professionnelle\r\n      message += `X-Mailer: 2Thier CRM v2.0\\r\\n`;\r\n      message += `X-Priority: 3\\r\\n`; // Priorit\u00E9 normale (pas urgent = moins spam)\r\n      message += `X-MSMail-Priority: Normal\\r\\n`;\r\n      message += `Importance: Normal\\r\\n`;\r\n      \r\n      // Headers de s\u00E9curit\u00E9 et d'authentification\r\n      message += `X-Auto-Response-Suppress: All\\r\\n`; // \u00C9viter les r\u00E9ponses automatiques\r\n      message += `List-Unsubscribe-Post: List-Unsubscribe=One-Click\\r\\n`;\r\n      \r\n      // \uD83C\uDD95 Structure professionnelle du contenu\r\n      if (options.attachments && options.attachments.length > 0) {\r\n        // Message multipart avec pi\u00E8ces jointes\r\n        message += `Content-Type: multipart/mixed; boundary=\"${boundary}\"\\r\\n\\r\\n`;\r\n        \r\n        // Texte d'introduction multipart professionnel\r\n        message += `This is a multi-part message in MIME format.\\r\\n\\r\\n`;\r\n        \r\n        // Partie corps du message\r\n        message += `--${boundary}\\r\\n`;\r\n        const contentType = options.isHtml ? 'text/html' : 'text/plain';\r\n        message += `Content-Type: ${contentType}; charset=utf-8\\r\\n`;\r\n        message += `Content-Transfer-Encoding: quoted-printable\\r\\n\\r\\n`;\r\n        \r\n        // \uD83C\uDD95 Corps professionnel avec signature\r\n        const professionalBody = this.formatProfessionalBody(options.body, options.isHtml);\r\n        message += professionalBody + '\\r\\n\\r\\n';\r\n\r\n        // Ajouter chaque pi\u00E8ce jointe avec headers corrects\r\n        for (const attachment of options.attachments) {\r\n          message += `--${boundary}\\r\\n`;\r\n          message += `Content-Type: ${attachment.mimeType}; name=\"${attachment.filename}\"\\r\\n`;\r\n          message += `Content-Disposition: attachment; filename=\"${attachment.filename}\"\\r\\n`;\r\n          message += `Content-Transfer-Encoding: base64\\r\\n`;\r\n          message += `Content-ID: <${attachment.filename.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}>\\r\\n\\r\\n`;\r\n          \r\n          // Encoder le contenu en base64 avec retours \u00E0 la ligne RFC conformes\r\n          const base64Content = attachment.content.toString('base64');\r\n          const chunkedContent = base64Content.match(/.{1,76}/g)?.join('\\r\\n') || base64Content;\r\n          message += chunkedContent + '\\r\\n\\r\\n';\r\n        }\r\n\r\n        // Fermer le boundary\r\n        message += `--${boundary}--\\r\\n`;\r\n      } else {\r\n        // Message simple sans pi\u00E8ces jointes mais avec headers professionnels\r\n        const contentType = options.isHtml ? 'text/html' : 'text/plain';\r\n        message += `Content-Type: ${contentType}; charset=utf-8\\r\\n`;\r\n        message += `Content-Transfer-Encoding: quoted-printable\\r\\n\\r\\n`;\r\n        \r\n        // \uD83C\uDD95 Corps professionnel avec signature\r\n        const professionalBody = this.formatProfessionalBody(options.body, options.isHtml);\r\n        message += professionalBody;\r\n      }\r\n\r\n      // Encoder en base64 pour Gmail API\r\n      const encodedMessage = Buffer.from(message).toString('base64')\r\n        .replace(/\\+/g, '-')\r\n        .replace(/\\//g, '_')\r\n        .replace(/=+$/, '');\r\n\r\n      console.log('[GoogleGmailService] \uD83D\uDCE4 Envoi du message encod\u00E9...');\r\n\r\n      const response = await this.gmail.users.messages.send({\r\n        userId: 'me',\r\n        requestBody: {\r\n          raw: encodedMessage\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] \u2705 Email envoy\u00E9 avec l'ID: ${response.data.id}`);\r\n      return { messageId: response.data.id! };\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] \u274C Erreur lors de l\\'envoi de l\\'email:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDD95 Formate le corps de l'email de mani\u00E8re professionnelle avec signature\r\n   */\r\n  private formatProfessionalBody(body: string, isHtml: boolean = false): string {\r\n    if (isHtml) {\r\n      // Version HTML professionnelle\r\n      return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta charset=\"utf-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Email de 2Thier CRM</title>\r\n</head>\r\n<body style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; background-color: #f9f9f9;\">\r\n    <div style=\"background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px;\">\r\n        <!-- En-t\u00EAte professionnel -->\r\n        <div style=\"border-bottom: 3px solid #0066cc; padding-bottom: 20px; margin-bottom: 30px;\">\r\n            <h2 style=\"color: #0066cc; margin: 0; font-size: 24px;\">2Thier CRM</h2>\r\n            <p style=\"color: #666; margin: 5px 0 0 0; font-size: 14px;\">Solution de gestion client professionnelle</p>\r\n        </div>\r\n        \r\n        <!-- Contenu principal -->\r\n        <div style=\"margin-bottom: 40px;\">\r\n            ${body}\r\n        </div>\r\n        \r\n        <!-- Signature professionnelle -->\r\n        <div style=\"border-top: 1px solid #eee; padding-top: 20px; margin-top: 30px;\">\r\n            <table style=\"width: 100%; border-collapse: collapse;\">\r\n                <tr>\r\n                    <td style=\"vertical-align: top; padding-right: 20px;\">\r\n                        <p style=\"margin: 0; font-size: 16px; font-weight: 600; color: #0066cc;\">\u00C9quipe 2Thier CRM</p>\r\n                        <p style=\"margin: 5px 0; font-size: 14px; color: #666;\">Solution de gestion client int\u00E9gr\u00E9e</p>\r\n                        <p style=\"margin: 5px 0; font-size: 14px; color: #666;\">\r\n                            <a href=\"mailto:support@2thier.be\" style=\"color: #0066cc; text-decoration: none;\">support@2thier.be</a>\r\n                        </p>\r\n                    </td>\r\n                </tr>\r\n            </table>\r\n        </div>\r\n        \r\n        <!-- Footer de confidentialit\u00E9 -->\r\n        <div style=\"border-top: 1px solid #eee; padding-top: 15px; margin-top: 20px; font-size: 12px; color: #999; text-align: center;\">\r\n            <p style=\"margin: 0;\">Ce message est confidentiel et destin\u00E9 uniquement au destinataire indiqu\u00E9.</p>\r\n            <p style=\"margin: 5px 0 0 0;\">Si vous n'\u00EAtes pas le destinataire pr\u00E9vu, veuillez supprimer ce message.</p>\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>`.trim();\r\n    } else {\r\n      // Version texte professionnelle\r\n      return `${body}\r\n\r\n--\r\n\u00C9quipe 2Thier CRM\r\nSolution de gestion client int\u00E9gr\u00E9e\r\nEmail: support@2thier.be\r\n\r\nCe message est confidentiel et destin\u00E9 uniquement au destinataire indiqu\u00E9.\r\nSi vous n'\u00EAtes pas le destinataire pr\u00E9vu, veuillez supprimer ce message.`;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re les labels Gmail\r\n   */\r\n  async getLabels(): Promise<GmailLabel[]> {\r\n    try {\r\n      const response = await this.gmail.users.labels.list({\r\n        userId: 'me'\r\n      });\r\n\r\n      return (response.data.labels || []).map(label => ({\r\n        id: label.id!,\r\n        name: label.name!,\r\n        type: label.type!,\r\n        messageListVisibility: label.messageListVisibility,\r\n        labelListVisibility: label.labelListVisibility\r\n      }));\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] Erreur lors de la r\u00E9cup\u00E9ration des labels:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cr\u00E9e un nouveau label/dossier personnalis\u00E9\r\n   */\r\n  async createLabel(name: string): Promise<GmailLabel | null> {\r\n    try {\r\n      const response = await this.gmail.users.labels.create({\r\n        userId: 'me',\r\n        requestBody: {\r\n          name,\r\n          messageListVisibility: 'show',\r\n          labelListVisibility: 'labelShow'\r\n        }\r\n      });\r\n\r\n      if (response.data) {\r\n        console.log(`[GoogleGmailService] Label \"${name}\" cr\u00E9\u00E9 avec l'ID: ${response.data.id}`);\r\n        return {\r\n          id: response.data.id!,\r\n          name: response.data.name!,\r\n          type: response.data.type!,\r\n          messageListVisibility: response.data.messageListVisibility,\r\n          labelListVisibility: response.data.labelListVisibility\r\n        };\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la cr\u00E9ation du label \"${name}\":`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Modifie un label existant\r\n   */\r\n  async updateLabel(labelId: string, name: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.labels.update({\r\n        userId: 'me',\r\n        id: labelId,\r\n        requestBody: {\r\n          name,\r\n          messageListVisibility: 'show',\r\n          labelListVisibility: 'labelShow'\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Label ${labelId} renomm\u00E9 en \"${name}\"`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la modification du label ${labelId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Supprime un label (seuls les labels personnalis\u00E9s peuvent \u00EAtre supprim\u00E9s)\r\n   */\r\n  async deleteLabel(labelId: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.labels.delete({\r\n        userId: 'me',\r\n        id: labelId\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Label ${labelId} supprim\u00E9`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la suppression du label ${labelId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Marque un message comme lu/non lu\r\n   */\r\n  async markAsRead(messageId: string, read: boolean = true): Promise<boolean> {\r\n    try {\r\n      const labelsToAdd = read ? [] : ['UNREAD'];\r\n      const labelsToRemove = read ? ['UNREAD'] : [];\r\n\r\n      await this.gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody: {\r\n          addLabelIds: labelsToAdd,\r\n          removeLabelIds: labelsToRemove\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Message ${messageId} marqu\u00E9 comme ${read ? 'lu' : 'non lu'}`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors du marquage du message ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Supprime un message\r\n   */\r\n  /**\r\n   * Marque ou enl\u00E8ve l'\u00E9toile d'un message\r\n   * LOGIQUE PR\u00C9CISE : \r\n   * - Ajouter \u00E9toile = SEULEMENT ajouter STARRED (ne pas toucher aux autres labels)\r\n   * - Retirer \u00E9toile = SEULEMENT retirer STARRED (ne pas toucher aux autres labels)\r\n   */\r\n  async markAsStarred(messageId: string, starred: boolean = true): Promise<boolean> {\r\n    try {\r\n      const labelChanges: { addLabelIds?: string[]; removeLabelIds?: string[] } = {};\r\n      \r\n      if (starred) {\r\n        // \u2B50 AJOUTER seulement STARRED, ne pas toucher aux autres labels\r\n        labelChanges.addLabelIds = ['STARRED'];\r\n        console.log(`[GoogleGmailService] \u2B50 Ajout STARRED uniquement (autres labels pr\u00E9serv\u00E9s)`);\r\n      } else {\r\n        // \u2B50 RETIRER seulement STARRED, ne pas toucher aux autres labels\r\n        labelChanges.removeLabelIds = ['STARRED'];\r\n        console.log(`[GoogleGmailService] \u2B50 Retrait STARRED uniquement (autres labels pr\u00E9serv\u00E9s)`);\r\n      }\r\n\r\n      await this.gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody: labelChanges\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Message ${messageId} ${starred ? 'marqu\u00E9 en favori' : 'retir\u00E9 des favoris'} - autres labels intacts`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la modification du favori pour ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * D\u00E9place un message vers la corbeille\r\n   * LOGIQUE SIMPLE : Ajoute SEULEMENT le label TRASH, sans retirer d'autres labels\r\n   * Pour supprimer compl\u00E8tement, utiliser deleteMessage\r\n   */\r\n  async trashMessage(messageId: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody: {\r\n          addLabelIds: ['TRASH']\r\n          // Ne pas retirer INBOX automatiquement - gestion ind\u00E9pendante\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Message ${messageId} d\u00E9plac\u00E9 vers la corbeille (autres labels pr\u00E9serv\u00E9s)`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors du d\u00E9placement vers la corbeille pour ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Supprime un message d'un emplacement sp\u00E9cifique (retire seulement le label demand\u00E9)\r\n   * Utilis\u00E9 pour supprimer de bo\u00EEte de r\u00E9ception, favoris, ou dossier sans affecter les autres emplacements\r\n   */\r\n  async removeFromLocation(messageId: string, labelToRemove: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody: {\r\n          removeLabelIds: [labelToRemove]\r\n          // Ne retire QUE le label sp\u00E9cifi\u00E9, garde tous les autres\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Message ${messageId} retir\u00E9 de l'emplacement ${labelToRemove} (autres emplacements pr\u00E9serv\u00E9s)`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la suppression de ${labelToRemove} pour ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restaure un message de la corbeille\r\n   * LOGIQUE SIMPLE : Retire SEULEMENT le label TRASH\r\n   */\r\n  async untrashMessage(messageId: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody: {\r\n          removeLabelIds: ['TRASH']\r\n          // Ne pas ajouter INBOX automatiquement - l'utilisateur choisira o\u00F9 le remettre\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Message ${messageId} restaur\u00E9 de la corbeille`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la restauration de ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Modifie les labels d'un message (pour gestion des dossiers)\r\n   * LOGIQUE SIMPLE ET PR\u00C9CISE :\r\n   * - Suppression sp\u00E9cifique = retire SEULEMENT le label demand\u00E9\r\n   * - Ajout sp\u00E9cifique = ajoute SEULEMENT le label demand\u00E9\r\n   * - Chaque emplacement (INBOX, STARRED, dossier) est g\u00E9r\u00E9 IND\u00C9PENDAMMENT\r\n   */\r\n  async modifyLabels(messageId: string, addLabelIds: string[] = [], removeLabelIds: string[] = []): Promise<boolean> {\r\n    try {\r\n      const requestBody: { addLabelIds?: string[]; removeLabelIds?: string[] } = {};\r\n      \r\n      // \u2705 AJOUT SIMPLE : Ajouter exactement les labels demand\u00E9s\r\n      if (addLabelIds.length > 0) {\r\n        requestBody.addLabelIds = addLabelIds;\r\n        console.log(`[GoogleGmailService] \u2795 Ajout des labels: ${addLabelIds.join(', ')}`);\r\n      }\r\n      \r\n      // \u2705 SUPPRESSION SIMPLE : Retirer exactement les labels demand\u00E9s\r\n      if (removeLabelIds.length > 0) {\r\n        requestBody.removeLabelIds = removeLabelIds;\r\n        console.log(`[GoogleGmailService] \u2796 Suppression des labels: ${removeLabelIds.join(', ')}`);\r\n      }\r\n\r\n      // Effectuer la modification EXACTE\r\n      await this.gmail.users.messages.modify({\r\n        userId: 'me',\r\n        id: messageId,\r\n        requestBody\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] \u2705 Labels modifi\u00E9s pour ${messageId}:`, { \r\n        ajout\u00E9s: requestBody.addLabelIds, \r\n        retir\u00E9s: requestBody.removeLabelIds,\r\n        logique: 'Gestion ind\u00E9pendante - aucune protection automatique'\r\n      });\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la modification des labels pour ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Supprime d\u00E9finitivement un message (suppression irr\u00E9versible)\r\n   */\r\n  async deleteMessage(messageId: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.messages.delete({\r\n        userId: 'me',\r\n        id: messageId\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] Message ${messageId} supprim\u00E9 d\u00E9finitivement`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] Erreur lors de la suppression du message ${messageId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sauvegarde un email en brouillon\r\n   * FONCTIONNALIT\u00C9 ESSENTIELLE : Auto-sauvegarde pour ne jamais perdre un email en cours\r\n   */\r\n  async saveDraft(options: {\r\n    to: string;\r\n    subject: string;\r\n    body: string;\r\n    isHtml?: boolean;\r\n    cc?: string;\r\n    bcc?: string;\r\n    draftId?: string; // Pour mettre \u00E0 jour un brouillon existant\r\n  }): Promise<{ draftId: string; messageId: string } | null> {\r\n    console.log(`[GoogleGmailService] \uD83D\uDCBE Sauvegarde en brouillon: \"${options.subject}\" -> ${options.to}`);\r\n\r\n    try {\r\n      // Construction du message MIME\r\n      let message = '';\r\n      \r\n      // Headers\r\n      message += `To: ${options.to}\\r\\n`;\r\n      message += `Subject: ${options.subject}\\r\\n`;\r\n      if (options.cc) {\r\n        message += `Cc: ${options.cc}\\r\\n`;\r\n      }\r\n      if (options.bcc) {\r\n        message += `Bcc: ${options.bcc}\\r\\n`;\r\n      }\r\n      \r\n      const contentType = options.isHtml ? 'text/html' : 'text/plain';\r\n      message += `Content-Type: ${contentType}; charset=utf-8\\r\\n`;\r\n      message += `\\r\\n`;\r\n      message += options.body;\r\n\r\n      // Encoder en base64\r\n      const encodedMessage = Buffer.from(message).toString('base64')\r\n        .replace(/\\+/g, '-')\r\n        .replace(/\\//g, '_')\r\n        .replace(/=+$/, '');\r\n\r\n      let response;\r\n      \r\n      if (options.draftId) {\r\n        // \uD83D\uDD04 MISE \u00C0 JOUR d'un brouillon existant\r\n        console.log(`[GoogleGmailService] \uD83D\uDD04 Mise \u00E0 jour du brouillon existant: ${options.draftId}`);\r\n        response = await this.gmail.users.drafts.update({\r\n          userId: 'me',\r\n          id: options.draftId,\r\n          requestBody: {\r\n            message: {\r\n              raw: encodedMessage\r\n            }\r\n          }\r\n        });\r\n      } else {\r\n        // \u2728 CR\u00C9ATION d'un nouveau brouillon\r\n        console.log(`[GoogleGmailService] \u2728 Cr\u00E9ation d'un nouveau brouillon`);\r\n        response = await this.gmail.users.drafts.create({\r\n          userId: 'me',\r\n          requestBody: {\r\n            message: {\r\n              raw: encodedMessage\r\n            }\r\n          }\r\n        });\r\n      }\r\n\r\n      const draftId = response.data.id!;\r\n      const messageId = response.data.message?.id || '';\r\n      \r\n      console.log(`[GoogleGmailService] \u2705 Brouillon sauvegard\u00E9 - ID: ${draftId}, Message: ${messageId}`);\r\n      return { draftId, messageId };\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] \u274C Erreur lors de la sauvegarde en brouillon:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re tous les brouillons\r\n   */\r\n  async getDrafts(): Promise<{\r\n    drafts: Array<{\r\n      draftId: string;\r\n      messageId: string;\r\n      subject: string;\r\n      to: string;\r\n      body: string;\r\n      date: Date;\r\n    }>;\r\n  }> {\r\n    console.log('[GoogleGmailService] \uD83D\uDCC4 R\u00E9cup\u00E9ration des brouillons...');\r\n\r\n    try {\r\n      const draftsResponse = await this.gmail.users.drafts.list({\r\n        userId: 'me'\r\n      });\r\n\r\n      const drafts = draftsResponse.data.drafts || [];\r\n      console.log(`[GoogleGmailService] ${drafts.length} brouillons trouv\u00E9s`);\r\n\r\n      // R\u00E9cup\u00E9rer les d\u00E9tails de chaque brouillon\r\n      const formattedDrafts = [];\r\n      \r\n      for (const draft of drafts) {\r\n        if (draft.id && draft.message?.id) {\r\n          try {\r\n            const draftDetails = await this.gmail.users.drafts.get({\r\n              userId: 'me',\r\n              id: draft.id,\r\n              format: 'full'\r\n            });\r\n\r\n            const message = draftDetails.data.message;\r\n            if (message?.payload?.headers) {\r\n              const headers = message.payload.headers;\r\n              const getHeader = (name: string): string => {\r\n                const header = headers.find(h => h.name?.toLowerCase() === name.toLowerCase());\r\n                return header?.value || '';\r\n              };\r\n\r\n              // Extraire le contenu\r\n              let body = '';\r\n              if (message.payload.parts) {\r\n                body = this.extractTextFromParts(message.payload.parts);\r\n              } else if (message.payload.body?.data) {\r\n                body = Buffer.from(message.payload.body.data, 'base64').toString('utf-8');\r\n              }\r\n\r\n              formattedDrafts.push({\r\n                draftId: draft.id,\r\n                messageId: draft.message.id,\r\n                subject: getHeader('Subject'),\r\n                to: getHeader('To'),\r\n                body: body,\r\n                date: new Date(parseInt(message.internalDate || '0'))\r\n              });\r\n            }\r\n          } catch (error) {\r\n            console.error(`[GoogleGmailService] Erreur lors de la r\u00E9cup\u00E9ration du brouillon ${draft.id}:`, error);\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`[GoogleGmailService] \u2705 ${formattedDrafts.length} brouillons format\u00E9s r\u00E9cup\u00E9r\u00E9s`);\r\n      return { drafts: formattedDrafts };\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] \u274C Erreur lors de la r\u00E9cup\u00E9ration des brouillons:', error);\r\n      return { drafts: [] };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Supprime un brouillon\r\n   */\r\n  async deleteDraft(draftId: string): Promise<boolean> {\r\n    try {\r\n      await this.gmail.users.drafts.delete({\r\n        userId: 'me',\r\n        id: draftId\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] \uD83D\uDDD1\uFE0F Brouillon ${draftId} supprim\u00E9`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] \u274C Erreur lors de la suppression du brouillon ${draftId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Envoie un brouillon (convertit le brouillon en email envoy\u00E9)\r\n   */\r\n  async sendDraft(draftId: string): Promise<{ messageId: string } | null> {\r\n    console.log(`[GoogleGmailService] \uD83D\uDCE4 Envoi du brouillon: ${draftId}`);\r\n\r\n    try {\r\n      const response = await this.gmail.users.drafts.send({\r\n        userId: 'me',\r\n        requestBody: {\r\n          id: draftId\r\n        }\r\n      });\r\n\r\n      console.log(`[GoogleGmailService] \u2705 Brouillon envoy\u00E9 - Message ID: ${response.data.id}`);\r\n      return { messageId: response.data.id! };\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] \u274C Erreur lors de l'envoi du brouillon ${draftId}:`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Vide compl\u00E8tement la corbeille (supprime tous les messages avec le label TRASH)\r\n   */\r\n  async emptyTrash(): Promise<boolean> {\r\n    try {\r\n      console.log(`[GoogleGmailService] \uD83D\uDD25 D\u00C9BUT du vidage de la corbeille...`);\r\n      \r\n      let allMessages: { id?: string | null }[] = [];\r\n      let pageToken: string | undefined = undefined;\r\n      let totalPages = 0;\r\n      \r\n      // \uD83D\uDD04 \u00C9TAPE 1: R\u00E9cup\u00E9rer TOUS les messages de la corbeille (pagination compl\u00E8te)\r\n      do {\r\n        totalPages++;\r\n        console.log(`[GoogleGmailService] \uD83D\uDCC4 R\u00E9cup\u00E9ration page ${totalPages} des messages de la corbeille...`);\r\n        \r\n        const trashMessages = await this.gmail.users.messages.list({\r\n          userId: 'me',\r\n          labelIds: ['TRASH'],\r\n          maxResults: 100, // Maximum par page\r\n          pageToken: pageToken\r\n        });\r\n\r\n        const pageMessages = trashMessages.data.messages || [];\r\n        allMessages = allMessages.concat(pageMessages);\r\n        pageToken = trashMessages.data.nextPageToken;\r\n        \r\n        console.log(`[GoogleGmailService] \uD83D\uDCC4 Page ${totalPages}: ${pageMessages.length} messages trouv\u00E9s`);\r\n      } while (pageToken);\r\n      \r\n      console.log(`[GoogleGmailService] \uD83D\uDCCA TOTAL: ${allMessages.length} messages trouv\u00E9s dans la corbeille sur ${totalPages} pages`);\r\n      \r\n      if (allMessages.length === 0) {\r\n        console.log(`[GoogleGmailService] \u2705 La corbeille est d\u00E9j\u00E0 vide`);\r\n        return true;\r\n      }\r\n\r\n      // \uD83D\uDDD1\uFE0F \u00C9TAPE 2: Supprimer chaque message d\u00E9finitivement\r\n      let deletedCount = 0;\r\n      for (const message of allMessages) {\r\n        if (message.id) {\r\n          try {\r\n            await this.deleteMessage(message.id);\r\n            deletedCount++;\r\n            if (deletedCount % 10 === 0) {\r\n              console.log(`[GoogleGmailService] \uD83D\uDDD1\uFE0F Progression: ${deletedCount}/${allMessages.length} messages supprim\u00E9s...`);\r\n            }\r\n          } catch (error) {\r\n            console.error(`[GoogleGmailService] \u274C Erreur lors de la suppression du message ${message.id}:`, error);\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`[GoogleGmailService] \u2705 Vidage termin\u00E9: ${deletedCount}/${allMessages.length} messages supprim\u00E9s de la corbeille`);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`[GoogleGmailService] \u274C Erreur lors du vidage de la corbeille:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // M\u00E9thodes utilitaires priv\u00E9es\r\n\r\n  private extractHtmlFromParts(parts: GmailPayloadPart[]): string {\r\n    for (const part of parts) {\r\n      if (part.mimeType === 'text/html' && part.body?.data) {\r\n        return Buffer.from(part.body.data, 'base64').toString('utf-8');\r\n      }\r\n      if (part.parts) {\r\n        const html = this.extractHtmlFromParts(part.parts);\r\n        if (html) return html;\r\n      }\r\n    }\r\n    return '';\r\n  }\r\n\r\n  private extractTextFromParts(parts: GmailPayloadPart[]): string {\r\n    for (const part of parts) {\r\n      // Priorit\u00E9 au texte brut pour les brouillons\r\n      if (part.mimeType === 'text/plain' && part.body?.data) {\r\n        return Buffer.from(part.body.data, 'base64').toString('utf-8');\r\n      }\r\n      // Sinon prendre le HTML\r\n      if (part.mimeType === 'text/html' && part.body?.data) {\r\n        return Buffer.from(part.body.data, 'base64').toString('utf-8');\r\n      }\r\n      if (part.parts) {\r\n        const text = this.extractTextFromParts(part.parts);\r\n        if (text) return text;\r\n      }\r\n    }\r\n    return '';\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re une pi\u00E8ce jointe d'un message Gmail\r\n   */\r\n  async getAttachment(messageId: string, attachmentId: string): Promise<{\r\n    data: Buffer;\r\n    filename: string;\r\n    mimeType: string;\r\n  } | null> {\r\n    try {\r\n      console.log(`[GoogleGmailService] \uD83D\uDCCE R\u00E9cup\u00E9ration pi\u00E8ce jointe: ${attachmentId} du message: ${messageId}`);\r\n      \r\n      // D'abord, r\u00E9cup\u00E9rer les informations du message pour obtenir le nom et type de fichier\r\n      const messageResponse = await this.gmail.users.messages.get({\r\n        userId: 'me',\r\n        id: messageId,\r\n        format: 'full'\r\n      });\r\n\r\n      let attachmentInfo = { filename: '', mimeType: 'application/octet-stream' };\r\n\r\n      // Rechercher les informations de la pi\u00E8ce jointe dans le payload\r\n      const findAttachmentInfo = (parts: any[]): void => {\r\n        for (const part of parts) {\r\n          if (part.body?.attachmentId === attachmentId) {\r\n            attachmentInfo = {\r\n              filename: part.filename || `attachment_${attachmentId}`,\r\n              mimeType: part.mimeType || 'application/octet-stream'\r\n            };\r\n            return;\r\n          }\r\n          if (part.parts) {\r\n            findAttachmentInfo(part.parts);\r\n          }\r\n        }\r\n      };\r\n\r\n      if (messageResponse.data.payload?.parts) {\r\n        findAttachmentInfo(messageResponse.data.payload.parts);\r\n      } else if (messageResponse.data.payload?.body?.attachmentId === attachmentId) {\r\n        attachmentInfo = {\r\n          filename: messageResponse.data.payload.filename || `attachment_${attachmentId}`,\r\n          mimeType: messageResponse.data.payload.mimeType || 'application/octet-stream'\r\n        };\r\n      }\r\n\r\n      // R\u00E9cup\u00E9rer les donn\u00E9es de la pi\u00E8ce jointe\r\n      const attachmentResponse = await this.gmail.users.messages.attachments.get({\r\n        userId: 'me',\r\n        messageId,\r\n        id: attachmentId\r\n      });\r\n\r\n      if (attachmentResponse.data.data) {\r\n        // D\u00E9coder les donn\u00E9es base64url\r\n        const data = attachmentResponse.data.data.replace(/-/g, '+').replace(/_/g, '/');\r\n        const buffer = Buffer.from(data, 'base64');\r\n        \r\n        console.log(`[GoogleGmailService] \u2705 Pi\u00E8ce jointe r\u00E9cup\u00E9r\u00E9e: ${attachmentInfo.filename} (${buffer.length} bytes)`);\r\n        \r\n        return {\r\n          data: buffer,\r\n          filename: attachmentInfo.filename,\r\n          mimeType: attachmentInfo.mimeType\r\n        };\r\n      }\r\n\r\n      console.log(`[GoogleGmailService] \u274C Aucune donn\u00E9e trouv\u00E9e pour la pi\u00E8ce jointe: ${attachmentId}`);\r\n      return null;\r\n    } catch (error) {\r\n      console.error('[GoogleGmailService] Erreur r\u00E9cup\u00E9ration pi\u00E8ce jointe:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private extractAttachments(payload: any): EmailAttachment[] {\r\n    const attachments: EmailAttachment[] = [];\r\n\r\n    const findAttachments = (parts: any[]): void => {\r\n      for (const part of parts) {\r\n        if (part.filename && part.body?.attachmentId) {\r\n          attachments.push({\r\n            attachmentId: part.body.attachmentId,\r\n            filename: part.filename,\r\n            mimeType: part.mimeType || 'application/octet-stream',\r\n            size: part.body.size || 0\r\n          });\r\n        }\r\n        if (part.parts) {\r\n          findAttachments(part.parts);\r\n        }\r\n      }\r\n    };\r\n\r\n    if (payload.parts) {\r\n      findAttachments(payload.parts);\r\n    }\r\n\r\n    return attachments;\r\n  }\r\n}\r\n", "/**\r\n * GMAIL CONTROLLER - VERSION CENTRALIS\u00C9E\r\n * \r\n * Contr\u00F4leur Gmail utilisant le service d'authentification centralis\u00E9.\r\n * Toutes les op\u00E9rations passent par le GoogleGmailService.\r\n */\r\n\r\nimport { Request, Response } from 'express';\r\nimport { GoogleGmailService } from '../index';\r\n\r\n// Interface pour les fichiers Formidable\r\ninterface FormidableFile {\r\n  name: string;\r\n  data: Buffer;\r\n  size: number;\r\n  mimetype: string;\r\n  tempFilePath?: string;\r\n}\r\n\r\n// Interface pour les requ\u00EAtes authentifi\u00E9es\r\ninterface AuthenticatedRequest extends Request {\r\n  user?: {\r\n    id: string;\r\n    userId: string;\r\n    email: string;\r\n    organizationId?: string;\r\n  };\r\n  files?: { [fieldname: string]: FormidableFile[] }; // Compatible avec Formidable\r\n}\r\n\r\n/**\r\n * R\u00E9cup\u00E8re les threads Gmail\r\n */\r\nexport const getThreads = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const { maxResults = 10, pageToken, q } = req.query;\r\n    \r\n    const result = await gmailService.getMessages({\r\n      maxResults: Number(maxResults),\r\n      pageToken: pageToken as string,\r\n      q: q as string\r\n    });\r\n\r\n    // Renvoyer directement les donn\u00E9es pour compatibilit\u00E9 frontend\r\n  res.json(result);\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur getThreads:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des threads' });\r\n  }\r\n};\r\n\r\n/**\r\n * R\u00E9cup\u00E8re les messages Gmail\r\n */\r\nexport const getMessages = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const { \r\n      maxResults = 10, \r\n      pageToken, \r\n      q, \r\n      labelIds,\r\n      mailbox // Frontend peut envoyer mailbox au lieu de labelIds\r\n    } = req.query;\r\n\r\n    console.log('[Gmail Controller] Param\u00E8tres re\u00E7us:', { maxResults, pageToken, q, labelIds, mailbox });\r\n\r\n    // \uD83D\uDD04 CONVERSION MAILBOX -> LABELIDS (Compatibilit\u00E9 frontend)\r\n    let finalLabelIds: string[] | undefined;\r\n\r\n    if (labelIds) {\r\n      // Si labelIds est fourni directement\r\n      finalLabelIds = Array.isArray(labelIds) ? labelIds : [labelIds];\r\n    } else if (mailbox) {\r\n      // Si mailbox est fourni, convertir selon la logique m\u00E9tier\r\n      const mailboxStr = mailbox as string;\r\n      console.log(`[Gmail Controller] \uD83D\uDCE6 Conversion mailbox: ${mailboxStr}`);\r\n      \r\n      switch (mailboxStr.toLowerCase()) {\r\n        case 'inbox':\r\n          finalLabelIds = ['INBOX'];\r\n          break;\r\n        case 'sent':\r\n          finalLabelIds = ['SENT'];\r\n          break;\r\n        case 'drafts':\r\n        case 'draft':\r\n          finalLabelIds = ['DRAFT'];\r\n          break;\r\n        case 'starred':\r\n          // \uD83D\uDCE7 FAVORIS = Messages avec STARRED (peuvent \u00EAtre dans INBOX ou ailleurs)\r\n          finalLabelIds = ['STARRED'];\r\n          break;\r\n        case 'trash':\r\n          finalLabelIds = ['TRASH'];\r\n          break;\r\n        case 'spam':\r\n          finalLabelIds = ['SPAM'];\r\n          break;\r\n        default:\r\n          // Pour les dossiers personnalis\u00E9s, utiliser le nom comme labelId\r\n          finalLabelIds = [mailboxStr];\r\n      }\r\n      \r\n      console.log(`[Gmail Controller] \u2705 Label final: ${finalLabelIds}`);\r\n    }\r\n\r\n    const result = await gmailService.getMessages({\r\n      maxResults: Number(maxResults),\r\n      pageToken: pageToken as string,\r\n      q: q as string,\r\n      labelIds: finalLabelIds\r\n    });\r\n\r\n    // Renvoyer directement les donn\u00E9es pour compatibilit\u00E9 frontend\r\n    res.json(result);\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur getMessages:', error);\r\n  res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des messages', details: (error as Error)?.message });\r\n  }\r\n};\r\n\r\n/**\r\n * R\u00E9cup\u00E8re un message Gmail sp\u00E9cifique\r\n */\r\nexport const getMessage = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du message manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const message = await gmailService.getMessageDetails(id);\r\n    if (!message) {\r\n      return res.status(404).json({ error: 'Message non trouv\u00E9' });\r\n    }\r\n\r\n    // Renvoyer directement les donn\u00E9es pour compatibilit\u00E9 frontend\r\n    res.json(message);\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur getMessage:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration du message' });\r\n  }\r\n};\r\n\r\n/**\r\n * Envoie un message Gmail (avec support des pi\u00E8ces jointes)\r\n */\r\nexport const sendMessage = async (req: AuthenticatedRequest, res: Response) => {\r\n  console.log('[Gmail Controller] \uD83D\uDE80\uD83D\uDE80\uD83D\uDE80 === D\u00C9BUT SENDMESSAGE - CONTR\u00D4LEUR ATTEINT (FORMIDABLE) ===');\r\n  console.log('[Gmail Controller] \uD83C\uDFAF Timestamp:', new Date().toISOString());\r\n  \r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    console.log('[Gmail Controller] \uD83D\uDCCB Organization ID re\u00E7u:', organizationId);\r\n    \r\n    if (!organizationId) {\r\n      console.log('[Gmail Controller] \u274C Organization ID manquant');\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    console.log('[Gmail Controller] \uD83D\uDD0D === ANALYSE DES DONN\u00C9ES RE\u00C7UES (FORMIDABLE) ===');\r\n    console.log('[Gmail Controller] \uD83D\uDD0D RAW req.body:', JSON.stringify(req.body, null, 2));\r\n    console.log('[Gmail Controller] \uD83D\uDD0D Type de req.body:', typeof req.body);\r\n    console.log('[Gmail Controller] \uD83D\uDD0D Cl\u00E9s dans req.body:', Object.keys(req.body || {}));\r\n    console.log('[Gmail Controller] \uD83D\uDD0D RAW req.files:', req.files);\r\n    console.log('[Gmail Controller] \uD83D\uDD0D Type de req.files:', typeof req.files);\r\n    \r\n    if (req.files && typeof req.files === 'object') {\r\n      console.log('[Gmail Controller] \uD83D\uDD0D Cl\u00E9s dans req.files:', Object.keys(req.files));\r\n      if ('attachments' in req.files) {\r\n        const attachments = req.files['attachments'];\r\n        console.log('[Gmail Controller] \uD83D\uDD0D Attachments trouv\u00E9s:', Array.isArray(attachments) ? attachments.length : 1);\r\n        if (Array.isArray(attachments)) {\r\n          attachments.forEach((file, index) => {\r\n            console.log('[Gmail Controller] \uD83D\uDCCE Fichier', index + 1, ':', {\r\n              name: file.name,\r\n              size: file.size,\r\n              mimetype: file.mimetype\r\n            });\r\n          });\r\n        } else {\r\n          console.log('[Gmail Controller] \uD83D\uDCCE Fichier unique:', {\r\n            name: attachments.name,\r\n            size: attachments.size,\r\n            mimetype: attachments.mimetype\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Extraire les champs du FormData - avec Formidable, les champs sont directement dans req.body\r\n    const to = req.body.to;\r\n    const subject = req.body.subject;\r\n    const body = req.body.body || '';\r\n    const isHtml = req.body.isHtml === 'true';\r\n    const cc = req.body.cc;\r\n    const bcc = req.body.bcc;\r\n    const fromName = req.body.fromName; // \uD83C\uDD95 Nouveau param\u00E8tre pour nom professionnel\r\n\r\n    console.log('[Gmail Controller] \uD83D\uDCE7 Donn\u00E9es extraites:', { \r\n      to, \r\n      subject, \r\n      body: body?.substring(0, 50), \r\n      isHtml, \r\n      cc, \r\n      bcc, \r\n      fromName: fromName || 'Par d\u00E9faut: 2Thier CRM' \r\n    });\r\n    \r\n    // Validation des champs obligatoires\r\n    if (!to || !subject) {\r\n      console.log('[Gmail Controller] \u274C Champs obligatoires manquants:', { to, subject });\r\n      return res.status(400).json({ error: 'Destinataire et sujet requis' });\r\n    }\r\n\r\n    console.log('[Gmail Controller] \uD83D\uDCE4 Envoi email avec', req.files ? Object.keys(req.files) : 'aucun', 'fichiers');\r\n    console.log('[Gmail Controller] \uD83D\uDCE7 Destinataire:', to, 'Sujet:', subject);\r\n\r\n    console.log('[Gmail Controller]  Cr\u00E9ation du service Gmail...');\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      console.log('[Gmail Controller] \u274C Impossible de cr\u00E9er le service Gmail');\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n    console.log('[Gmail Controller] \u2705 Service Gmail cr\u00E9\u00E9 avec succ\u00E8s');\r\n\r\n    // Extraire les attachments - avec Formidable, les fichiers sont dans req.files\r\n    let attachments: FormidableFile[] = [];\r\n    if (req.files && typeof req.files === 'object' && 'attachments' in req.files) {\r\n      const files = req.files['attachments'];\r\n      attachments = Array.isArray(files) ? files : [files];\r\n    }\r\n\r\n    console.log('[Gmail Controller] \uD83D\uDCCE Nombre de pi\u00E8ces jointes trait\u00E9es:', attachments.length);\r\n    if (attachments.length > 0) {\r\n      console.log('[Gmail Controller] \uD83D\uDCCE D\u00E9tails des pi\u00E8ces jointes:', attachments.map(f => ({\r\n        filename: f.name,\r\n        size: f.size,\r\n        mimetype: f.mimetype\r\n      })));\r\n    }\r\n\r\n    // Pr\u00E9parer les donn\u00E9es d'envoi - VERSION PROFESSIONNELLE ANTI-SPAM\r\n    const emailData = {\r\n      to,\r\n      subject,\r\n      body: body || '',\r\n      isHtml: isHtml || false,\r\n      cc,\r\n      bcc,\r\n      fromName: fromName || '2Thier CRM', // \uD83C\uDD95 Nom professionnel par d\u00E9faut\r\n      attachments: attachments.length > 0 ? attachments.map(file => ({\r\n        filename: file.name,\r\n        content: file.data, // Formidable utilise 'data' au lieu de 'buffer'\r\n        mimeType: file.mimetype\r\n      })) : undefined\r\n    };\r\n\r\n    console.log('[Gmail Controller] \uD83D\uDCCE Donn\u00E9es email pr\u00E9par\u00E9es (VERSION ANTI-SPAM):', {\r\n      to: emailData.to,\r\n      subject: emailData.subject,\r\n      fromName: emailData.fromName,\r\n      attachments: emailData.attachments?.length || 0\r\n    });\r\n\r\n    console.log('[Gmail Controller] \uD83D\uDE80 Appel gmailService.sendEmail...');\r\n    const result = await gmailService.sendEmail(emailData);\r\n\r\n    if (!result) {\r\n      console.log('[Gmail Controller] \u274C Aucun r\u00E9sultat de sendEmail');\r\n      return res.status(500).json({ error: 'Erreur lors de l\\'envoi du message' });\r\n    }\r\n\r\n    console.log('[Gmail Controller] \u2705 Email envoy\u00E9 avec succ\u00E8s:', result);\r\n\r\n    res.json({\r\n      success: true,\r\n      message: 'Email envoy\u00E9 avec succ\u00E8s',\r\n      data: result\r\n    });\r\n    console.log('[Gmail Controller] \u2705 R\u00E9ponse envoy\u00E9e au client');\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] \u274C\u274C\u274C ERREUR COMPL\u00C8TE sendMessage:', error);\r\n    console.error('[Gmail Controller] \u274C Type erreur:', typeof error);\r\n    console.error('[Gmail Controller] \u274C Message erreur:', (error as Error)?.message);\r\n    console.error('[Gmail Controller] \u274C Stack trace:', (error as Error)?.stack);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'envoi du message' });\r\n  }\r\n};\r\n\r\n/**\r\n * Modifie un message Gmail (marquer comme lu, \u00E9toile, etc.)\r\n */\r\nexport const modifyMessage = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    const { action, addLabelIds, removeLabelIds } = req.body;\r\n\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du message manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    let result = false;\r\n\r\n    // Si on a addLabelIds ou removeLabelIds, on utilise la logique de modification de labels\r\n    if (addLabelIds || removeLabelIds) {\r\n      console.log('[Gmail Controller] Modification des labels:', { addLabelIds, removeLabelIds });\r\n      \r\n      // G\u00E9rer les favoris sp\u00E9cialement\r\n      if (addLabelIds && addLabelIds.includes('STARRED')) {\r\n        result = await gmailService.markAsStarred(id, true);\r\n      } else if (removeLabelIds && removeLabelIds.includes('STARRED')) {\r\n        result = await gmailService.markAsStarred(id, false);\r\n      } else {\r\n        // Pour les autres labels, utiliser la m\u00E9thode g\u00E9n\u00E9rale\r\n        result = await gmailService.modifyLabels(id, addLabelIds || [], removeLabelIds || []);\r\n      }\r\n    } \r\n    // Sinon, utiliser l'ancienne logique avec action\r\n    else if (action) {\r\n      switch (action) {\r\n        case 'markAsRead':\r\n          result = await gmailService.markAsRead(id, true);\r\n          break;\r\n        case 'markAsUnread':\r\n          result = await gmailService.markAsRead(id, false);\r\n          break;\r\n        default:\r\n          return res.status(400).json({ error: 'Action non support\u00E9e' });\r\n      }\r\n    } else {\r\n      return res.status(400).json({ error: 'Action ou modification de labels requis' });\r\n    }\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Message modifi\u00E9 avec succ\u00E8s' : 'Erreur lors de la modification'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur modifyMessage:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la modification du message' });\r\n  }\r\n};\r\n\r\n/**\r\n * Supprime un message Gmail\r\n */\r\nexport const deleteMessage = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du message manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.deleteMessage(id);\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Message supprim\u00E9 avec succ\u00E8s' : 'Erreur lors de la suppression'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur deleteMessage:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression du message' });\r\n  }\r\n};\r\n\r\n/**\r\n * R\u00E9cup\u00E8re les labels Gmail\r\n */\r\nexport const getLabels = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const labels = await gmailService.getLabels();\r\n\r\n    // Renvoyer directement les donn\u00E9es pour compatibilit\u00E9 frontend\r\n    res.json(labels);\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur getLabels:', error);\r\n  res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des labels', details: (error as Error)?.message });\r\n  }\r\n};\r\n\r\n// Fonctions temporaires pour maintenir la compatibilit\u00E9 avec l'ancien syst\u00E8me\r\nexport const trashMessage = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du message manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    // Utiliser la vraie fonction de mise \u00E0 la corbeille\r\n    const result = await gmailService.trashMessage(id);\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Message d\u00E9plac\u00E9 vers la corbeille avec succ\u00E8s' : 'Erreur lors de la suppression'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur trashMessage:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression du message' });\r\n  }\r\n};\r\n\r\nexport const untrashMessage = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du message manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.untrashMessage(id);\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Message restaur\u00E9 de la corbeille avec succ\u00E8s' : 'Erreur lors de la restauration'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur untrashMessage:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la restauration du message' });\r\n  }\r\n};\r\n\r\n/**\r\n * Vide compl\u00E8tement la corbeille (suppression d\u00E9finitive de tous les emails TRASH)\r\n */\r\nexport const emptyTrash = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.emptyTrash();\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Corbeille vid\u00E9e avec succ\u00E8s' : 'Erreur lors du vidage de la corbeille'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur emptyTrash:', error);\r\n    res.status(500).json({ error: 'Erreur lors du vidage de la corbeille' });\r\n  }\r\n};\r\n\r\nexport const createLabel = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { name } = req.body;\r\n    if (!name) {\r\n      return res.status(400).json({ error: 'Nom du label requis' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const label = await gmailService.createLabel(name);\r\n    if (!label) {\r\n      return res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation du label' });\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      data: label\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur createLabel:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation du label' });\r\n  }\r\n};\r\n\r\nexport const updateLabel = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    const { name } = req.body;\r\n    \r\n    if (!id || !name) {\r\n      return res.status(400).json({ error: 'ID et nom du label requis' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.updateLabel(id, name);\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Label modifi\u00E9 avec succ\u00E8s' : 'Erreur lors de la modification'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur updateLabel:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la modification du label' });\r\n  }\r\n};\r\n\r\nexport const deleteLabel = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du label manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.deleteLabel(id);\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Label supprim\u00E9 avec succ\u00E8s' : 'Erreur lors de la suppression'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur deleteLabel:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression du label' });\r\n  }\r\n};\r\n\r\nexport const getAttachment = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    // Essayer de r\u00E9cup\u00E9rer l'organization ID de plusieurs sources\r\n  let organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    \r\n    // Si pas trouv\u00E9 dans headers, essayer depuis req.user (syst\u00E8me ancien)\r\n    if (!organizationId && req.user?.organizationId) {\r\n      organizationId = req.user.organizationId;\r\n    }\r\n    \r\n    // Fallback: retourner une erreur si aucune organisation trouv\u00E9e\r\n    if (!organizationId) {\r\n      console.log('[Gmail Controller] \u274C Aucune organisation trouv\u00E9e pour l\\'utilisateur');\r\n      return res.status(400).json({ \r\n        error: 'Organization ID manquant',\r\n        message: 'Impossible de d\u00E9terminer l\\'organisation de l\\'utilisateur'\r\n      });\r\n    }\r\n\r\n    const { messageId, attachmentId } = req.params;\r\n    const { preview } = req.query;\r\n\r\n    if (!messageId || !attachmentId) {\r\n      return res.status(400).json({ error: 'Message ID et Attachment ID requis' });\r\n    }\r\n\r\n    console.log(`[Gmail Controller] \uD83D\uDCCE R\u00E9cup\u00E9ration pi\u00E8ce jointe: ${attachmentId} du message: ${messageId}`);\r\n    console.log(`[Gmail Controller] \uD83C\uDFE2 Organization ID utilis\u00E9: ${organizationId}`);\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const attachment = await gmailService.getAttachment(messageId, attachmentId);\r\n    if (!attachment) {\r\n      return res.status(404).json({ error: 'Pi\u00E8ce jointe non trouv\u00E9e' });\r\n    }\r\n\r\n    // D\u00E9terminer le Content-Type et Content-Disposition selon le type de fichier\r\n    let contentType = attachment.mimeType;\r\n    let contentDisposition = 'attachment';\r\n    \r\n    const filename = attachment.filename;\r\n    const fileExtension = filename.split('.').pop()?.toLowerCase();\r\n    \r\n    // Pour l'aper\u00E7u, utiliser 'inline' au lieu de 'attachment'\r\n    if (preview === 'true') {\r\n      contentDisposition = 'inline';\r\n      \r\n      // Ajuster le Content-Type selon l'extension si n\u00E9cessaire\r\n      if (fileExtension === 'pdf' && !contentType.includes('pdf')) {\r\n        contentType = 'application/pdf';\r\n      } else if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(fileExtension || '')) {\r\n        if (fileExtension === 'png') contentType = 'image/png';\r\n        else if (['jpg', 'jpeg'].includes(fileExtension)) contentType = 'image/jpeg';\r\n        else if (fileExtension === 'gif') contentType = 'image/gif';\r\n        else if (fileExtension === 'webp') contentType = 'image/webp';\r\n      }\r\n    }\r\n    \r\n    // Headers pour l'aper\u00E7u ou le t\u00E9l\u00E9chargement\r\n    res.setHeader('Content-Type', contentType);\r\n    res.setHeader('Content-Disposition', `${contentDisposition}; filename=\"${filename}\"`);\r\n    \r\n    // Headers suppl\u00E9mentaires pour l'aper\u00E7u (PDF et autres)\r\n    if (preview === 'true') {\r\n      // Permettre l'affichage dans iframe\r\n      res.setHeader('X-Frame-Options', 'SAMEORIGIN');\r\n      res.setHeader('Content-Security-Policy', \"frame-ancestors 'self'\");\r\n      \r\n      // Headers de cache pour l'aper\u00E7u\r\n      res.setHeader('Cache-Control', 'public, max-age=3600');\r\n      res.setHeader('Access-Control-Allow-Origin', '*');\r\n      res.setHeader('Access-Control-Allow-Methods', 'GET');\r\n      res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\r\n      \r\n      // Pour les PDF sp\u00E9cifiquement\r\n      if (contentType === 'application/pdf') {\r\n        res.setHeader('Accept-Ranges', 'bytes');\r\n      }\r\n    }\r\n    \r\n    console.log(`[Gmail Controller] \u2705 Serving attachment: ${filename}, Type: ${contentType}, Disposition: ${contentDisposition}`);\r\n    res.send(attachment.data);\r\n    \r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur getAttachment:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration de la pi\u00E8ce jointe',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * R\u00E9cup\u00E8re tous les brouillons\r\n */\r\nexport const getDrafts = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.getDrafts();\r\n    res.json(result);\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur getDrafts:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des brouillons' });\r\n  }\r\n};\r\n\r\n/**\r\n * Sauvegarde un email en brouillon (cr\u00E9ation ou mise \u00E0 jour)\r\n */\r\nexport const saveDraft = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { to, subject, body, isHtml, cc, bcc, draftId } = req.body;\r\n    \r\n    if (!to || !subject) {\r\n      return res.status(400).json({ error: 'Destinataire et sujet requis' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.saveDraft({\r\n      to,\r\n      subject,\r\n      body: body || '',\r\n      isHtml: isHtml || false,\r\n      cc,\r\n      bcc,\r\n      draftId // Pour mise \u00E0 jour d'un brouillon existant\r\n    });\r\n\r\n    if (result) {\r\n      res.json({\r\n        success: true,\r\n        message: draftId ? 'Brouillon mis \u00E0 jour avec succ\u00E8s' : 'Brouillon sauvegard\u00E9 avec succ\u00E8s',\r\n        data: result\r\n      });\r\n    } else {\r\n      res.status(500).json({ \r\n        success: false, \r\n        error: 'Erreur lors de la sauvegarde du brouillon' \r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur saveDraft:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la sauvegarde du brouillon' });\r\n  }\r\n};\r\n\r\n/**\r\n * Supprime un brouillon\r\n */\r\nexport const deleteDraft = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du brouillon manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.deleteDraft(id);\r\n\r\n    res.json({\r\n      success: result,\r\n      message: result ? 'Brouillon supprim\u00E9 avec succ\u00E8s' : 'Erreur lors de la suppression'\r\n    });\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur deleteDraft:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression du brouillon' });\r\n  }\r\n};\r\n\r\n/**\r\n * Envoie un brouillon\r\n */\r\nexport const sendDraft = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(401).json({ error: 'Organization ID manquant dans la requ\u00EAte' });\r\n    }\r\n\r\n    const { id } = req.params;\r\n    if (!id) {\r\n      return res.status(400).json({ error: 'ID du brouillon manquant' });\r\n    }\r\n\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    if (!gmailService) {\r\n      return res.status(401).json({ error: 'Google non connect\u00E9 pour cette organisation' });\r\n    }\r\n\r\n    const result = await gmailService.sendDraft(id);\r\n\r\n    if (result) {\r\n      res.json({\r\n        success: true,\r\n        message: 'Brouillon envoy\u00E9 avec succ\u00E8s',\r\n        data: result\r\n      });\r\n    } else {\r\n      res.status(500).json({ \r\n        success: false, \r\n        error: 'Erreur lors de l\\'envoi du brouillon' \r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('[Gmail Controller] Erreur sendDraft:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'envoi du brouillon' });\r\n  }\r\n};\r\n\r\n// Petit endpoint de sant\u00E9 pour diagnostiquer les 500 rapidement\r\nexport const health = async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = (req.headers['x-organization-id'] as string) || req.user?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(200).json({ ok: false, reason: 'organizationId manquant' });\r\n    }\r\n    const gmailService = await GoogleGmailService.create(organizationId);\r\n    return res.status(200).json({ ok: !!gmailService });\r\n  } catch (e) {\r\n    return res.status(200).json({ ok: false, reason: (e as Error)?.message });\r\n  }\r\n};\r\n", "import { Router, Response, Request, RequestHandler } from \"express\";\r\nimport { PrismaClient, Prisma, UserOrganizationStatus } from \"@prisma/client\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { authMiddleware } from \"../middlewares/auth\";\r\nimport { impersonationMiddleware } from \"../middlewares/impersonation\"; // Importer le middleware\r\nimport type { AuthenticatedRequest } from \"../middlewares/auth\";\r\nimport { JWT_SECRET } from \"../config\";\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\nconst userWithOrgsArgs = {\r\n    include: {\r\n        UserOrganization: {\r\n            include: {\r\n                Organization: true,\r\n                Role: {\r\n                    include: {\r\n                        Permission: true, // CORRECTION: 'permissions' devient 'Permission'\r\n                    },\r\n                },\r\n            },\r\n        },\r\n    },\r\n};\r\n\r\ntype UserWithOrgs = Prisma.UserGetPayload<typeof userWithOrgsArgs>;\r\n\r\n// POST /api/register - Inscription d'un nouvel utilisateur\r\nrouter.post(\"/register\", async (req: Request, res: Response) => {\r\n  const { email, password, firstName, lastName } = req.body;\r\n\r\n  if (!email || !password || !firstName) {\r\n    return res.status(400).json({ error: \"Email, mot de passe et pr\u00E9nom sont requis\" });\r\n  }\r\n\r\n  try {\r\n    const hashedPassword = await bcrypt.hash(password, 10);\r\n    const user = await prisma.user.create({\r\n      data: {\r\n        email,\r\n        passwordHash: hashedPassword,\r\n        firstName,\r\n        lastName,\r\n        status: 'active',\r\n        role: 'user',\r\n      },\r\n    });\r\n    res.status(201).json({ success: true, id: user.id, email: user.email });\r\n  } catch (error) {\r\n    console.error(\"[API][register] Erreur lors de l'inscription:\", error);\r\n    \r\n    // Gestion sp\u00E9cifique de l'erreur de contrainte d'unicit\u00E9\r\n    if (error instanceof Prisma.PrismaClientKnownRequestError && error.code === 'P2002') {\r\n      return res.status(409).json({ error: \"Cette adresse email est d\u00E9j\u00E0 utilis\u00E9e.\" });\r\n    }\r\n    \r\n    res.status(500).json({ error: \"Erreur lors de la cr\u00E9ation de l'utilisateur\" });\r\n  }\r\n});\r\n\r\n// POST /api/login - Connexion d'un utilisateur\r\nrouter.post(\"/login\", async (req: Request, res: Response) => {\r\n  const { email, password } = req.body;\r\n\r\n  if (!email || !password) {\r\n    return res.status(400).json({ error: \"L'email et le mot de passe sont requis\" });\r\n  }\r\n\r\n  try {\r\n    const user: UserWithOrgs | null = await prisma.user.findUnique({\r\n        where: { email },\r\n        ...userWithOrgsArgs\r\n    });\r\n\r\n    if (!user) {\r\n      return res.status(401).json({ error: \"Identifiants invalides\" });\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(password, user.passwordHash);\r\n\r\n    if (!isPasswordValid) {\r\n      return res.status(401).json({ error: \"Identifiants invalides\" });\r\n    }\r\n\r\n    // Re-fetch user with relations to ensure data is fresh, especially after status changes.\r\n    const freshUser: UserWithOrgs | null = await prisma.user.findUnique({\r\n        where: { id: user.id },\r\n        ...userWithOrgsArgs\r\n    });\r\n\r\n    if (!freshUser) {\r\n        // This should not happen if the user was just found\r\n        return res.status(404).json({ error: \"Utilisateur non trouv\u00E9 apr\u00E8s la v\u00E9rification.\" });\r\n    }\r\n\r\n    const isSuperAdmin = freshUser.role === 'super_admin';\r\n    const mainOrg = freshUser.UserOrganization && freshUser.UserOrganization.length > 0 \r\n        ? freshUser.UserOrganization.find(uo => uo.Organization && uo.Role && uo.status === UserOrganizationStatus.ACTIVE) || freshUser.UserOrganization.find(uo => uo.Organization && uo.Role)\r\n        : null;\r\n\r\n    // Un utilisateur standard DOIT POUVOIR se connecter m\u00EAme sans organisation pour en cr\u00E9er une ou accepter une invitation.\r\n    // La logique de ce qu'il peut faire une fois connect\u00E9 est g\u00E9r\u00E9e par le frontend et les autres routes API.\r\n    if (!isSuperAdmin && !mainOrg) {\r\n        console.log(`[API][login] Utilisateur ${user.id} se connecte sans organisation principale. C'est un utilisateur \"flottant\".`);\r\n    }\r\n\r\n    // D\u00E9terminer le r\u00F4le pour le token\r\n    let tokenRole;\r\n    if (isSuperAdmin) {\r\n      tokenRole = 'super_admin';\r\n    } else if (mainOrg && mainOrg.Role) {\r\n      // Cas standard : l'utilisateur a un r\u00F4le dans une organisation\r\n      tokenRole = mainOrg.Role.name;\r\n    } else {\r\n      // Cas d'un nouvel utilisateur sans organisation : on lui donne un r\u00F4le de base.\r\n      tokenRole = 'user'; // R\u00F4le par d\u00E9faut pour les utilisateurs \"flottants\"\r\n    }\r\n\r\n    const token = jwt.sign(\r\n      { \r\n        userId: user.id, \r\n        role: tokenRole, \r\n        // L'organizationId peut \u00EAtre null pour un super_admin sans orga principale\r\n        organizationId: mainOrg ? mainOrg.organizationId : null,\r\n      },\r\n      JWT_SECRET,\r\n      { expiresIn: \"24h\" }\r\n    );\r\n\r\n  const { passwordHash: _passwordHash, UserOrganization: userOrganizations = [], ...userInfos } = freshUser;\r\n\r\n  const organizations = userOrganizations\r\n        .filter(uo => uo.Organization && uo.Role) // Filtrer les relations invalides\r\n        .map((uo) => ({\r\n            ...uo.Organization,\r\n            role: uo.Role.name,\r\n            roleLabel: uo.Role.label,\r\n            userOrganizationId: uo.id, // Ajout de l'ID de la relation\r\n            status: uo.status, // Ajout du statut de la relation\r\n        }));\r\n\r\n    // \u2705 D\u00C9FINIR LE COOKIE HTTPONLY S\u00C9CURIS\u00C9\r\n    console.log('\uD83C\uDF6A [LOGIN] D\u00E9finition du cookie d\\'authentification...');\r\n    res.cookie('token', token, {\r\n        httpOnly: true,        // Emp\u00EAche l'acc\u00E8s via JavaScript c\u00F4t\u00E9 client (s\u00E9curit\u00E9)\r\n        secure: false,         // true en production avec HTTPS, false en d\u00E9veloppement\r\n        sameSite: 'lax',       // Protection CSRF tout en permettant les redirections\r\n        maxAge: 24 * 60 * 60 * 1000, // 24 heures en millisecondes\r\n        path: '/'              // Cookie disponible sur tout le site\r\n    });\r\n    \r\n    console.log('\u2705 [LOGIN] Cookie d\u00E9fini avec succ\u00E8s');\r\n\r\n    res.json({\r\n        token,\r\n        user: userInfos,\r\n        organizations,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"[API][login] Erreur lors de la connexion:\", error);\r\n    if (!res.headersSent) {\r\n      res.status(500).json({ error: \"Erreur interne du serveur.\" });\r\n    }\r\n  }\r\n});\r\n\r\n// GET /api/me - R\u00E9cup\u00E8re les informations de l'utilisateur connect\u00E9\r\nrouter.get(\r\n  \"/me\",\r\n  authMiddleware,\r\n  async (req: AuthenticatedRequest, res: Response) => {\r\n    try {\r\n        console.log('[/me] === DEBUG /me ROUTE ===');\r\n        console.log('[/me] req.user:', req.user);\r\n        console.log('[/me] req.cookies:', req.cookies);\r\n        console.log('[/me] req.headers.authorization:', req.headers.authorization);\r\n        \r\n        // CORRECTION : V\u00E9rifier si req.user existe avant de l'utiliser.\r\n        // S'il n'existe pas, cela signifie que le client n'est pas authentifi\u00E9.\r\n        if (!req.user || !req.user.userId) {\r\n          console.log('[/me] \u00C9chec: req.user ou req.user.userId manquant');\r\n          return res.status(401).json({ error: \"Utilisateur non authentifi\u00E9\" });\r\n        }\r\n\r\n        const user = await prisma.user.findUnique({\r\n            where: { id: req.user.userId }, // On peut maintenant y acc\u00E9der en toute s\u00E9curit\u00E9\r\n            ...userWithOrgsArgs,\r\n        });\r\n        if (!user) {\r\n          return res.status(404).json({ error: \"Utilisateur non trouv\u00E9\" });\r\n        }\r\n\r\n        const isSuperAdmin = user.role === 'super_admin';\r\n        const mainOrg = user.UserOrganization && user.UserOrganization.length > 0 \r\n            ? user.UserOrganization.find(uo => uo.Organization && uo.Role && uo.status === UserOrganizationStatus.ACTIVE) || user.UserOrganization.find(uo => uo.Organization && uo.Role)\r\n            : null;\r\n\r\n        // Un utilisateur standard doit appartenir \u00E0 au moins une organisation valide pour se connecter.\r\n        if (!isSuperAdmin && !mainOrg) {\r\n            return res.status(403).json({ error: \"Vous n'\u00EAtes associ\u00E9 \u00E0 aucune organisation valide ou votre r\u00F4le n'est pas correctement configur\u00E9.\" });\r\n        }\r\n\r\n        // D\u00E9terminer le r\u00F4le pour le token\r\n        let tokenRole;\r\n        if (isSuperAdmin) {\r\n          tokenRole = 'super_admin';\r\n        } else {\r\n          // mainOrg et mainOrg.Role sont garantis d'exister pour un utilisateur non-super-admin \u00E0 ce stade.\r\n          if (!mainOrg || !mainOrg.Role) {\r\n            return res.status(403).json({ error: \"Impossible de d\u00E9terminer un r\u00F4le valide pour la connexion.\" });\r\n          }\r\n          tokenRole = mainOrg.Role.name;\r\n        }\r\n\r\n        const token = jwt.sign(\r\n          { \r\n            userId: user.id, \r\n            role: tokenRole, \r\n            // L'organizationId peut \u00EAtre null pour un super_admin sans orga principale\r\n            organizationId: mainOrg ? mainOrg.organizationId : null,\r\n          },\r\n          JWT_SECRET,\r\n          { expiresIn: \"24h\" }\r\n        );\r\n\r\n        res.cookie('token', token, {\r\n          httpOnly: true,\r\n          secure: false,\r\n          sameSite: 'lax',\r\n          maxAge: 24 * 60 * 60 * 1000,\r\n          path: '/'\r\n        });\r\n\r\n  const { passwordHash: _passwordHash, UserOrganization: userOrganizations = [], ...userInfos } = user;\r\n\r\n    const organizations = userOrganizations\r\n            .filter(uo => uo.Organization && uo.Role) // Filtrer les relations invalides\r\n            .map((uo) => ({\r\n                ...uo.Organization,\r\n                role: uo.Role.name,\r\n                roleLabel: uo.Role.label,\r\n                userOrganizationId: uo.id, // Ajout de l'ID de la relation\r\n                status: uo.status, // Ajout du statut de la relation\r\n            }));\r\n\r\n        res.json({ currentUser: { ...userInfos, organizations }, isImpersonating: !!req.originalUser });\r\n    } catch (err) {\r\n        console.error(err);\r\n        res.status(500).json({ error: \"Erreur lors de la r\u00E9cup\u00E9ration de l'utilisateur.\" });\r\n    }\r\n  }\r\n);\r\n\r\n// POST /api/logout - D\u00E9connexion avec nettoyage des cookies\r\nrouter.post(\"/logout\", (_req: Request, res: Response) => {\r\n    console.log('\uD83D\uDEAA [LOGOUT] Demande de d\u00E9connexion re\u00E7ue');\r\n    \r\n    // Nettoyer le cookie principal avec la m\u00EAme configuration que lors de la cr\u00E9ation\r\n    res.clearCookie('token', {\r\n        httpOnly: true,\r\n        secure: false,  // M\u00EAme valeur qu'\u00E0 la cr\u00E9ation\r\n        sameSite: 'lax',\r\n        path: '/'\r\n    });\r\n    \r\n    // Nettoyer aussi d'autres variantes possibles (au cas o\u00F9)\r\n    const cookieOptions = [\r\n        { path: '/' },\r\n        { path: '/', httpOnly: true },\r\n        { path: '/', secure: false },\r\n        { path: '/', sameSite: 'lax' as const }\r\n    ];\r\n    \r\n    cookieOptions.forEach(options => {\r\n        res.clearCookie('token', options);\r\n    });\r\n    \r\n    // Headers pour forcer le nettoyage c\u00F4t\u00E9 client\r\n    res.header('Clear-Site-Data', '\"cookies\"');\r\n    res.header('Cache-Control', 'no-cache, no-store, must-revalidate');\r\n    \r\n    console.log('\u2705 [LOGOUT] Cookie nettoy\u00E9 avec succ\u00E8s');\r\n    res.json({ \r\n        success: true, \r\n        message: 'D\u00E9connexion r\u00E9ussie',\r\n        clearCache: true\r\n    });\r\n});\r\n\r\n// NOUVELLE ROUTE\r\n// GET /api/me/organizations - R\u00E9cup\u00E8re les organisations pour l'utilisateur actuel (ou toutes pour un super_admin)\r\nrouter.get(\r\n  \"/me/organizations\",\r\n  authMiddleware,\r\n  impersonationMiddleware as RequestHandler,\r\n  async (req: AuthenticatedRequest, res: Response) => {\r\n    try {\r\n      const isSuperAdmin = req.user?.role === 'super_admin';\r\n      const isImpersonating = !!req.impersonatedUser;\r\n      const effectiveUserId = req.impersonatedUser?.id || req.user?.userId;\r\n\r\n      if (!effectiveUserId) {\r\n        return res.status(401).json({ error: \"Utilisateur non authentifi\u00E9.\" });\r\n      }\r\n\r\n      let organizations = [];\r\n\r\n      // Si c'est un super_admin et qu'il n'usurpe personne, il voit toutes les organisations.\r\n      if (isSuperAdmin && !isImpersonating) {\r\n        const allOrgs = await prisma.organization.findMany({\r\n          orderBy: { name: 'asc' },\r\n        });\r\n        // On formate pour correspondre \u00E0 la structure attendue par le front-end\r\n        organizations = allOrgs.map(org => ({\r\n          ...org,\r\n          role: 'super_admin',\r\n          roleLabel: 'Super Administrateur',\r\n          userOrganizationId: null,\r\n          status: 'ACTIVE', // Le statut de la relation n'existe pas ici\r\n        }));\r\n      } else {\r\n        // Sinon, on r\u00E9cup\u00E8re les organisations de l'utilisateur (ou de l'utilisateur usurp\u00E9).\r\n        const userWithOrgs = await prisma.user.findUnique({\r\n          where: { id: effectiveUserId },\r\n          ...userWithOrgsArgs,\r\n        });\r\n\r\n        if (userWithOrgs && userWithOrgs.UserOrganization) {\r\n          organizations = userWithOrgs.UserOrganization\r\n            .filter(uo => uo.Organization && uo.Role)\r\n            .map(uo => ({\r\n              ...uo.Organization,\r\n              role: uo.Role.name,\r\n              roleLabel: uo.Role.label,\r\n              userOrganizationId: uo.id,\r\n              status: uo.status,\r\n            }));\r\n        }\r\n      }\r\n\r\n      res.json({ success: true, data: organizations });\r\n\r\n    } catch (error) {\r\n      console.error(\"[API][me/organizations] Erreur:\", error);\r\n      res.status(500).json({ success: false, message: \"Erreur interne du serveur.\" });\r\n    }\r\n  }\r\n);\r\n\r\n\r\n// GET /api/me/role - R\u00E9cup\u00E9rer le r\u00F4le de l'utilisateur dans une organisation sp\u00E9cifique\r\nrouter.get(\r\n  \"/me/role\",\r\n  authMiddleware,\r\n  impersonationMiddleware as RequestHandler, // << AJOUT DU MIDDLEWARE\r\n  async (req: AuthenticatedRequest, res: Response) => {\r\n    const organizationId = req.query.organizationId as string;\r\n    // Si on usurpe, on utilise l'ID de l'utilisateur usurp\u00E9, sinon l'ID de l'utilisateur authentifi\u00E9\r\n    const userId = req.impersonatedUser?.id || req.user?.userId;\r\n\r\n    console.log('[API][me/role] userId:', userId, 'organizationId:', organizationId, 'impersonatedUser:', req.impersonatedUser, 'headers:', req.headers);\r\n\r\n    if (!userId) {\r\n      res.status(401).json({ error: \"Utilisateur non authentifi\u00E9\" });\r\n      return;\r\n    }\r\n\r\n    if (!organizationId) {\r\n      res.status(400).json({ error: \"L'ID de l'organisation est requis\" });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Si le vrai utilisateur est un super_admin et qu'il usurp\u00E9, on donne le r\u00F4le de l'usurp\u00E9\r\n      if (req.user?.role === 'super_admin' && req.impersonatedUser) {\r\n        const userOrg = await prisma.userOrganization.findFirst({\r\n          where: { userId: req.impersonatedUser.id, organizationId },\r\n          include: { Role: true, Organization: true },\r\n        });\r\n        if (userOrg && userOrg.Role && userOrg.Organization) {\r\n          res.json({\r\n            role: userOrg.Role.name,\r\n            roleLabel: userOrg.Role.label,\r\n            orgStatus: userOrg.Organization.status,\r\n            organizationName: userOrg.Organization.name,\r\n          });\r\n          return;\r\n        } else {\r\n          // Si l'utilisateur usurp\u00E9 n'a pas de r\u00F4le dans cette orga, on renvoie null\r\n          res.status(404).json({ error: \"L'utilisateur usurp\u00E9 n'a pas de r\u00F4le dans cette organisation.\" });\r\n          return;\r\n        }\r\n      } else if (req.user?.role === 'super_admin' && !req.impersonatedUser) {\r\n        // Un super_admin non-usurpateur a toujours le r\u00F4le super_admin\r\n        res.json({ role: 'super_admin', roleLabel: 'Super administrateur', orgStatus: null });\r\n        return;\r\n      }\r\n\r\n      // Pour un utilisateur standard\r\n      const userOrg = await prisma.userOrganization.findFirst({\r\n        where: { userId, organizationId },\r\n        include: { Role: true, Organization: true },\r\n      });\r\n\r\n      if (userOrg && userOrg.Role && userOrg.Organization) {\r\n        res.json({\r\n          role: userOrg.Role.name,\r\n          roleLabel: userOrg.Role.label,\r\n          orgStatus: userOrg.Organization.status,\r\n          organizationName: userOrg.Organization.name,\r\n        });\r\n      } else {\r\n        res.status(404).json({ error: \"R\u00F4le non trouv\u00E9 pour l'utilisateur dans cette organisation\" });\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[API][me/role] Erreur:\", error);\r\n      res.status(500).json({ error: \"Erreur interne du serveur\" });\r\n    }\r\n  }\r\n);\r\n\r\n// POST /api/logout - D\u00E9connexion de l'utilisateur\r\nrouter.post(\"/logout\", (_req, res) => {\r\n  // Ici, vous pouvez g\u00E9rer la d\u00E9connexion, comme la suppression du token c\u00F4t\u00E9 client.\r\n  // Cela d\u00E9pend de la mani\u00E8re dont vous g\u00E9rez l'authentification c\u00F4t\u00E9 client.\r\n  res.json({ message: \"D\u00E9connexion r\u00E9ussie\" });\r\n});\r\n\r\nexport default router;\r\n", "import type { Request as ExpressRequest, Response, NextFunction } from 'express';\r\nimport type { UploadedFile } from 'express-fileupload';\r\nimport jwt from 'jsonwebtoken';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport bcrypt from 'bcrypt';\r\nimport { JWT_SECRET } from '../config';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// \u00C9tendre le type Request pour inclure user et les fichiers upload\u00E9s\r\nexport interface AuthenticatedRequest extends ExpressRequest {\r\n  user?: {\r\n    userId: string;\r\n    role: string;\r\n    organizationId: string | null;\r\n    roles?: string[]; // Ajout pour la compatibilit\u00E9 avec requireSuperAdmin\r\n    firstname?: string; // Ajout pour personnaliser l'utilisateur\r\n    lastname?: string;  // Ajout pour personnaliser l'utilisateur\r\n    email?: string;     // Ajout pour personnaliser l'utilisateur\r\n    isSuperAdmin?: boolean; // \uD83D\uDC51 CRUCIAL: Pour que les middlewares reconnaissent le SuperAdmin ! \uD83D\uDC51\r\n  };\r\n  originalUser?: { // Pour l'usurpation\r\n    userId: string;\r\n    role: string;\r\n  };\r\n  impersonatedUser?: { // Pour l'usurpation\r\n    id: string;\r\n  };\r\n  file?: Express.Multer.File; // Ajout pour multer\r\n  files?: { [fieldName: string]: UploadedFile | UploadedFile[] }; // \uD83D\uDCCE Pour express-fileupload\r\n  impersonatedOrganizationId?: string;\r\n  accessibleOrgIds?: string[];\r\n  // La propri\u00E9t\u00E9 cookies est ajout\u00E9e par le middleware cookie-parser\r\n  cookies: { [key: string]: string };\r\n}\r\n\r\nexport const authMiddleware = async (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n    // Extraire le token depuis l'en-t\u00EAte d'autorisation ou du cookie\r\n    const authHeader = req.headers.authorization;\r\n    const cookieToken = req.cookies?.token;\r\n    \r\n    // R\u00E9cup\u00E9rer l'ID d'organisation depuis l'en-t\u00EAte si disponible\r\n    const orgIdFromHeader = req.headers['x-organization-id'] as string;\r\n    console.log('[AUTH] x-organization-id de l\\'en-t\u00EAte:', orgIdFromHeader);\r\n    \r\n    // D\u00E9terminer le token \u00E0 utiliser (en-t\u00EAte ou cookie)\r\n    let token: string | undefined;\r\n\r\n    // Essayer d'abord le cookie (plus fiable)\r\n    if (cookieToken) {\r\n        token = cookieToken;\r\n        console.log('[AUTH] Token trouv\u00E9 dans les cookies');\r\n    } \r\n    // Ensuite l'en-t\u00EAte Authorization si pas de cookie ou si cookie non valide\r\n    else if (authHeader && authHeader.startsWith('Bearer ')) {\r\n        token = authHeader.split(' ')[1];\r\n        console.log('[AUTH] Token trouv\u00E9 dans l\\'en-t\u00EAte Authorization');\r\n    }\r\n    \r\n    // Si aucun token n'est trouv\u00E9\r\n    if (!token) {\r\n        console.log('[AUTH] Aucun token d\\'authentification trouv\u00E9');\r\n        return res.status(401).json({ error: 'Authentification requise' });\r\n    }\r\n    \r\n    // Si le token est un token de d\u00E9veloppement (\u00E0 partir du frontend)\r\n    if (token.startsWith('dev-token-')) {\r\n        console.log('[AUTH] Token de d\u00E9veloppement d\u00E9tect\u00E9, non autoris\u00E9 en production');\r\n        return res.status(401).json({ error: 'Token de d\u00E9veloppement non autoris\u00E9' });\r\n    }\r\n    \r\n    try {\r\n        // V\u00E9rifier et d\u00E9coder le token\r\n        const decoded = jwt.verify(token, JWT_SECRET) as {\r\n            userId: string;\r\n            roles?: string[];\r\n            role?: string;\r\n            organizationId?: string;\r\n        };\r\n        \r\n        // R\u00E9cup\u00E9rer l'utilisateur depuis la base de donn\u00E9es\r\n        const user = await prisma.user.findUnique({\r\n            where: { id: decoded.userId }\r\n        });\r\n        \r\n        if (!user) {\r\n            console.log('[AUTH] Utilisateur non trouv\u00E9 pour l\\'ID:', decoded.userId);\r\n            return res.status(401).json({ error: 'Authentification invalide' });\r\n        }\r\n        \r\n    let organizationId = decoded.organizationId || null;\r\n\r\n    // Fallback suppl\u00E9mentaire: query ?organizationId=... (utile pour EventSource qui ne peut pas envoyer d'en-t\u00EAtes personnalis\u00E9s)\r\n    const orgIdFromQuery = (req.query?.organizationId as string) || (req.query?.orgId as string);\r\n    if (!organizationId && orgIdFromQuery) {\r\n      console.log('[AUTH] Fallback organizationId depuis query string:', orgIdFromQuery);\r\n      organizationId = orgIdFromQuery;\r\n    }\r\n\r\n    // Si on a un ID d'organisation dans l'en-t\u00EAte, il prime\r\n    if (orgIdFromHeader) {\r\n      console.log('[AUTH] Utilisation de l\\'ID d\\'organisation de l\\'en-t\u00EAte:', orgIdFromHeader);\r\n      organizationId = orgIdFromHeader;\r\n    }\r\n\r\n    // Validation de l'organisation si d\u00E9finie\r\n    if (organizationId) {\r\n      const organization = await prisma.organization.findUnique({ where: { id: organizationId } });\r\n      if (organization) {\r\n        console.log('[AUTH] Organisation trouv\u00E9e:', organization.name);\r\n      } else {\r\n        console.log('[AUTH] AVERTISSEMENT: Organisation non trouv\u00E9e pour l\\'ID:', organizationId);\r\n        return res.status(404).json({ error: 'Organisation non trouv\u00E9e' });\r\n      }\r\n    }\r\n        \r\n        // Configurer l'utilisateur dans la requ\u00EAte\r\n        req.user = {\r\n            userId: user.id,\r\n            role: user.role || 'user',\r\n            organizationId,\r\n            roles: user.role ? [user.role] : [],\r\n            firstname: user.firstName || '',\r\n            lastname: user.lastName || '',\r\n            email: user.email,\r\n            // \uD83D\uDC51 SUPER IMPORTANT: D\u00E9finir isSuperAdmin pour que les middlewares le reconnaissent ! \uD83D\uDC51\r\n            isSuperAdmin: user.role === 'super_admin'\r\n        };\r\n        \r\n        console.log('[AUTH] Utilisateur authentifi\u00E9 avec:', { \r\n            userId: req.user.userId, \r\n            role: req.user.role, \r\n            firstname: req.user.firstname,\r\n            lastname: req.user.lastname,\r\n            email: req.user.email,\r\n            organizationId: req.user.organizationId \r\n        });\r\n        \r\n        return next();\r\n        \r\n    } catch (error) {\r\n        console.error('[AUTH] Erreur de v\u00E9rification du token:', error);\r\n        return res.status(401).json({ error: 'Token d\\'authentification invalide' });\r\n    }\r\n};\r\nexport const login = async (req: AuthenticatedRequest, res: Response) => {\r\n  const { email, password } = req.body;\r\n\r\n  try {\r\n    const user = await prisma.user.findUnique({ where: { email } });\r\n\r\n    if (!user) {\r\n      return res.status(401).json({ error: 'Email ou mot de passe incorrect' });\r\n    }\r\n\r\n    // Log pour v\u00E9rifier l'utilisateur trouv\u00E9\r\n    console.log('[Login] Utilisateur trouv\u00E9:', { id: user.id, email: user.email, role: user.role });\r\n\r\n    const passwordMatch = await bcrypt.compare(password, user.passwordHash);\r\n    if (!passwordMatch) {\r\n      return res.status(401).json({ error: 'Email ou mot de passe incorrect' });\r\n    }\r\n\r\n    // Assurer que le r\u00F4le existe avant de g\u00E9n\u00E9rer le token\r\n    if (!user.role) {\r\n      console.error(`[Login] ERREUR: Le r\u00F4le de l'utilisateur ${user.email} est manquant.`);\r\n      return res.status(500).json({ error: 'Erreur de configuration du compte : r\u00F4le manquant.' });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer l'organisation de l'utilisateur depuis UserOrganization\r\n    const userOrg = await prisma.userOrganization.findFirst({\r\n      where: { userId: user.id },\r\n    });\r\n\r\n    const token = jwt.sign(\r\n      { \r\n        userId: user.id, \r\n        // Utiliser 'roles' (pluriel) pour \u00EAtre coh\u00E9rent\r\n        roles: [user.role], \r\n        organizationId: userOrg?.organizationId \r\n      },\r\n      JWT_SECRET,\r\n      { expiresIn: '1h' }\r\n    );\r\n\r\n    // On retire passwordHash avant de renvoyer l'objet utilisateur\r\n    const { passwordHash, ...userWithoutPassword } = user;\r\n\r\n    res.json({ token, user: userWithoutPassword });\r\n\r\n  } catch (e) {\r\n    console.error('[Login] Erreur lors de la connexion:', e);\r\n    res.status(500).json({ error: 'Erreur interne' });\r\n  }\r\n};\r\n\r\nexport const requireSuperAdmin = (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n  // V\u00E9rification adapt\u00E9e pour notre middleware de d\u00E9veloppement\r\n  if (req.user?.role === 'super_admin' || req.user?.roles?.includes('super_admin')) {\r\n    next();\r\n  } else {\r\n    // Message d'erreur standardis\u00E9\r\n    res.status(403).json({ success: false, message: 'Acc\u00E8s non autoris\u00E9.' });\r\n  }\r\n};\r\n\r\n// Fonction requireRole manquante\r\nexport const requireRole = (roles: string[]) => {\r\n  return (req: AuthenticatedRequest, res: Response, next: NextFunction) => {\r\n    if (!req.user) {\r\n      return res.status(401).json({ success: false, message: 'Authentification requise.' });\r\n    }\r\n\r\n    const userRole = req.user.role;\r\n    const userRoles = req.user.roles || [];\r\n\r\n    // V\u00E9rifier si l'utilisateur a l'un des r\u00F4les requis\r\n    const hasRequiredRole = roles.includes(userRole) || userRoles.some(role => roles.includes(role));\r\n\r\n    if (hasRequiredRole) {\r\n      next();\r\n    } else {\r\n      res.status(403).json({ success: false, message: 'Acc\u00E8s non autoris\u00E9.' });\r\n    }\r\n  };\r\n};\r\n\r\n// ...autres parties du fichier inchang\u00E9es...\r\n", "import type { Request as ExpressRequest, Response, NextFunction } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport type { AuthenticatedRequest } from './auth';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nexport async function impersonationMiddleware(\r\n  req: ExpressRequest,\r\n  res: Response,\r\n  next: NextFunction\r\n) {\r\n  const authReq = req as AuthenticatedRequest;\r\n  const impersonateUserId = authReq.headers[\"x-impersonate-user-id\"] as string;\r\n  const impersonateOrgId = authReq.headers[\"x-impersonate-org-id\"] as string;\r\n  const originalUser = authReq.user;\r\n\r\n  // Le middleware ne fait rien si l'utilisateur n'est pas un super_admin\r\n  // ou si aucun en-t\u00EAte d'usurpation n'est fourni.\r\n  if (\r\n    !originalUser ||\r\n    originalUser.role !== \"super_admin\" ||\r\n    (!impersonateUserId && !impersonateOrgId)\r\n  ) {\r\n    return next();\r\n  }\r\n\r\n  console.log(\r\n    `[Impersonation] Middleware triggered for super_admin ${originalUser.userId}. Headers: user=${impersonateUserId}, org=${impersonateOrgId}`\r\n  );\r\n\r\n  try {\r\n    // Cas 1 : Usurpation d'un utilisateur (et potentiellement d'une organisation)\r\n    if (impersonateUserId) {\r\n      const userToImpersonate = await prisma.user.findUnique({\r\n        where: { id: impersonateUserId },\r\n      });\r\n\r\n      if (!userToImpersonate) {\r\n        // Si l'utilisateur n'est pas trouv\u00E9, on ne peut pas continuer.\r\n        return res\r\n          .status(404)\r\n          .json({ error: \"Utilisateur \u00E0 usurper non trouv\u00E9.\" });\r\n      }\r\n      // Stocker l'objet utilisateur complet pour un usage ult\u00E9rieur (ex: /api/me)\r\n      authReq.impersonatedUser = userToImpersonate;\r\n      // L'organisation \u00E0 usurper est soit celle fournie, soit nulle pour le moment.\r\n      authReq.impersonatedOrganizationId = impersonateOrgId;\r\n\r\n      console.log(\r\n        `[Impersonation] Stored impersonatedUser: ${authReq.impersonatedUser.id}`\r\n      );\r\n    } else if (impersonateOrgId) {\r\n      // Cas 2 : Le super_admin agit dans le contexte d'une seule organisation\r\n      // sans changer d'identit\u00E9 utilisateur.\r\n      authReq.impersonatedOrganizationId = impersonateOrgId;\r\n    }\r\n\r\n    if (authReq.impersonatedOrganizationId) {\r\n      console.log(\r\n        `[Impersonation] Stored impersonatedOrganizationId: ${authReq.impersonatedOrganizationId}`\r\n      );\r\n    }\r\n\r\n    next();\r\n  } catch (error) {\r\n    console.error(\"[Impersonation] Erreur:\", error);\r\n    res\r\n      .status(500)\r\n      .json({ error: \"Une erreur est survenue durant l'usurpation.\" });\r\n  }\r\n}\r\n", "import { Router, Response } from \"express\";\r\nimport { authMiddleware, AuthenticatedRequest } from \"../middlewares/auth\";\r\nimport { impersonationMiddleware } from \"../middlewares/impersonation\";\r\nimport { PrismaClient } from '@prisma/client';\r\nimport multer from 'multer';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\nconst buildAvatarUrl = (req: AuthenticatedRequest, avatarPath?: string | null) => {\r\n  if (!avatarPath) {\r\n    return '';\r\n  }\r\n\r\n  if (avatarPath.startsWith('http://') || avatarPath.startsWith('https://')) {\r\n    return avatarPath;\r\n  }\r\n\r\n  const host = req.get('host');\r\n  if (!host) {\r\n    return avatarPath;\r\n  }\r\n\r\n  const normalizedPath = avatarPath.startsWith('/') ? avatarPath : `/${avatarPath}`;\r\n  return `${req.protocol}://${host}${normalizedPath}`;\r\n};\r\n\r\nconst sanitizeText = (value: unknown): string | null | undefined => {\r\n  if (typeof value !== 'string') {\r\n    return undefined;\r\n  }\r\n\r\n  const trimmed = value.trim();\r\n  return trimmed.length === 0 ? null : trimmed;\r\n};\r\n\r\n// Configuration de Multer pour le stockage des avatars\r\nconst storage = multer.diskStorage({\r\n    destination: function (_req, _file, cb) {\r\n        const dir = 'public/uploads/avatars';\r\n        if (!fs.existsSync(dir)) {\r\n            fs.mkdirSync(dir, { recursive: true });\r\n        }\r\n        cb(null, dir);\r\n    },\r\n    filename: function (req, file, cb) {\r\n        const authReq = req as AuthenticatedRequest;\r\n        const userId = authReq.user?.userId;\r\n        cb(null, userId + path.extname(file.originalname));\r\n    }\r\n});\r\n\r\nconst upload = multer({ storage: storage });\r\n\r\n// Le middleware d'authentification est appliqu\u00E9 \u00E0 toutes les routes de ce routeur\r\nrouter.use(authMiddleware, impersonationMiddleware as any);\r\n\r\n// GET /api/profile - R\u00E9cup\u00E9rer le profil de l'utilisateur\r\nrouter.get('/', async (req: AuthenticatedRequest, res: Response): Promise<any> => {\r\n  try {\r\n    const userId = req.user?.userId;\r\n    if (!userId) {\r\n      return res.status(401).json({ error: \"Utilisateur non authentifi\u00E9\" });\r\n    }\r\n\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            Organization: true,\r\n            Role: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!user) {\r\n      return res.status(404).json({ error: \"Utilisateur non trouv\u00E9\" });\r\n    }\r\n\r\n    // Formatter la r\u00E9ponse pour correspondre au format attendu par le frontend\r\n    const formattedUser = {\r\n      id: user.id,\r\n      email: user.email,\r\n      firstName: user.firstName || \"\",  // Utiliser firstName (camelCase) pour correspondre au frontend\r\n      lastName: user.lastName || \"\",    // Utiliser lastName (camelCase) pour correspondre au frontend\r\n      address: user.address || \"\",      // Ajouter l'adresse\r\n      vatNumber: user.vatNumber || \"\",  // Ajouter le num\u00E9ro TVA\r\n      phoneNumber: user.phoneNumber || \"\", // Ajouter le num\u00E9ro de t\u00E9l\u00E9phone\r\n      role: user.role || \"user\",\r\n  avatarUrl: buildAvatarUrl(req, user.avatarUrl),\r\n      createdAt: user.createdAt.toISOString(),\r\n      updatedAt: user.updatedAt.toISOString(),\r\n      organizationId: req.user?.organizationId || null,\r\n      permissions: [], // \u00C0 remplir si n\u00E9cessaire\r\n      organization: user.UserOrganization?.length > 0 ? {\r\n        id: user.UserOrganization[0].Organization.id,\r\n        name: user.UserOrganization[0].Organization.name\r\n      } : null\r\n    };\r\n\r\n    return res.json(formattedUser);\r\n  } catch (error) {\r\n    console.error(\"Error fetching user profile:\", error);\r\n    return res.status(500).json({ error: \"Internal server error\" });\r\n  }\r\n});\r\n\r\n// POST /api/profile/avatar - Upload a new avatar\r\nrouter.post('/avatar', upload.single('avatar'), async (req: AuthenticatedRequest, res: Response): Promise<any> => {\r\n  try {\r\n    const userId = req.user?.userId;\r\n    if (!userId) {\r\n      res.status(400).json({ error: \"User ID not found in token\" });\r\n      return;\r\n    }\r\n\r\n    if (!req.file) {\r\n      res.status(400).json({ error: \"Aucun fichier n'a \u00E9t\u00E9 t\u00E9l\u00E9vers\u00E9.\" });\r\n      return;\r\n    }\r\n\r\n    const avatarUrl = `/uploads/avatars/${req.file.filename}`;\r\n\r\n    const updatedUser = await prisma.user.update({\r\n      where: { id: userId },\r\n      data: { avatarUrl },\r\n       select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        avatarUrl: true,\r\n        address: true,\r\n        vatNumber: true,\r\n        phoneNumber: true,\r\n        status: true,\r\n        createdAt: true,\r\n        updatedAt: true,\r\n        UserOrganization: {\r\n          select: {\r\n            Organization: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                status: true,\r\n              }\r\n            },\r\n            Role: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                label: true,\r\n                description: true,\r\n              }\r\n            },\r\n            id: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    res.json({\r\n      ...updatedUser,\r\n      avatarUrl: buildAvatarUrl(req, updatedUser.avatarUrl)\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erreur lors du t\u00E9l\u00E9versement de l'avatar:\", error);\r\n    res.status(500).json({ error: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\n// GET /api/profile/permissions - Get current user's permissions\r\nrouter.get('/permissions', (async (req: any, res: Response) => {\r\n    try {\r\n        const userId = req.user?.userId;\r\n        const organizationId = req.user?.organizationId;\r\n\r\n        if (!userId) {\r\n            return res.status(400).json({ error: \"User ID not found in token\" });\r\n        }\r\n\r\n        const user = await prisma.user.findUnique({ \r\n            where: { id: userId },\r\n            select: { role: true } // On v\u00E9rifie le r\u00F4le global de l'utilisateur\r\n        });\r\n\r\n        // Le super admin (r\u00F4le global) a toutes les permissions\r\n        if (user?.role === 'super_admin') {\r\n            return res.json({ permissions: ['manage:all'] });\r\n        }\r\n\r\n        if (!organizationId) {\r\n            // Les utilisateurs non-super-admin doivent avoir un contexte d'organisation\r\n            return res.json({ permissions: [] });\r\n        }\r\n\r\n        const userOrgLink = await prisma.userOrganization.findUnique({\r\n            where: {\r\n                userId_organizationId: {\r\n                    userId: userId,\r\n                    organizationId: organizationId\r\n                }\r\n            },\r\n            include: {\r\n                Role: {\r\n                    include: {\r\n                        Permission: {\r\n                            where: { allowed: true } // On ne r\u00E9cup\u00E8re que les permissions actives\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        if (!userOrgLink || !userOrgLink.Role) {\r\n            // User is not in the organization or has no role assigned\r\n            return res.json({ permissions: [] });\r\n        }\r\n\r\n        const permissions = userOrgLink.Role.Permission.map(p => `${p.action}:${p.resource}`);\r\n        \r\n        res.json({ permissions });\r\n\r\n    } catch (error) {\r\n        console.error(\"Failed to fetch permissions:\", error);\r\n        res.status(500).json({ error: 'Internal server error' });\r\n    }\r\n}) as any);\r\n\r\n// PUT /api/profile - Update current user's profile\r\nrouter.put('/', (async (req: any, res: Response) => {\r\n  try {\r\n    const userId = req.user?.userId;\r\n    if (!userId) {\r\n      return res.status(400).json({ error: \"User ID not found in token\" });\r\n    }\r\n\r\n    const {\r\n      firstName,\r\n      lastName,\r\n      address,\r\n      vatNumber,\r\n      phoneNumber,\r\n      avatarUrl\r\n    } = req.body;\r\n\r\n    let normalizedAvatarUrl: string | null | undefined = undefined;\r\n    if (typeof avatarUrl === 'string') {\r\n      const trimmed = avatarUrl.trim();\r\n      if (trimmed.length === 0) {\r\n        normalizedAvatarUrl = null;\r\n      } else {\r\n        try {\r\n          const parsed = new URL(trimmed);\r\n          normalizedAvatarUrl = parsed.pathname.startsWith('/uploads/') ? parsed.pathname : trimmed;\r\n        } catch {\r\n          normalizedAvatarUrl = trimmed;\r\n        }\r\n      }\r\n    }\r\n\r\n    const updatedUser = await prisma.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        firstName: sanitizeText(firstName),\r\n        lastName: sanitizeText(lastName),\r\n        address: sanitizeText(address),\r\n        vatNumber: sanitizeText(vatNumber),\r\n        phoneNumber: sanitizeText(phoneNumber),\r\n        avatarUrl: normalizedAvatarUrl,\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        avatarUrl: true,\r\n        address: true,\r\n        vatNumber: true,\r\n        phoneNumber: true,\r\n        status: true,\r\n        createdAt: true,\r\n        updatedAt: true,\r\n        UserOrganization: {\r\n          select: {\r\n            Organization: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                status: true,\r\n              }\r\n            },\r\n            Role: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                label: true,\r\n                description: true,\r\n              }\r\n            },\r\n            id: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    res.json({\r\n      ...updatedUser,\r\n      avatarUrl: buildAvatarUrl(req, updatedUser.avatarUrl)\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error updating profile:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n}) as any);\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { PrismaClient, Module as PrismaModule } from '@prisma/client';\r\n\r\n// Impl\u00E9mentation MINIMALE restaur\u00E9e pour \u00E9viter les 404 c\u00F4t\u00E9 frontend\r\n// et r\u00E9tablir l'affichage des modules. Con\u00E7ue pour \u00EAtre s\u00FBre et simple.\r\n// TODO: Affiner la logique d'activation par organisation si n\u00E9cessaire.\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\n// Utilitaire: d\u00E9river une route coh\u00E9rente \u00E0 partir d'une cl\u00E9 si route absente.\r\n// R\u00E8gles:\r\n//  - Pr\u00E9server la route fournie si d\u00E9j\u00E0 pr\u00E9sente (mais remplacer les underscores par des tirets)\r\n//  - Si absente: / + key transform\u00E9e (google_agenda => google-agenda)\r\n//  - Garantir un leading '/'\r\nfunction deriveRoute(key?: string | null, provided?: string | null): string | null {\r\n\tif (!key && !provided) return null;\r\n\tlet route = provided && provided.trim() !== '' ? provided.trim() : '';\r\n\tif (!route && key) {\r\n\t\t// Construire depuis la cl\u00E9\r\n\t\troute = key.replace(/^google_/, 'google-').replace(/_/g, '-');\r\n\t} else if (route) {\r\n\t\t// Normaliser underscores\r\n\t\troute = route.replace(/_/g, '-');\r\n\t\t// Retirer double slash \u00E9ventuel\r\n\t\troute = route.replace(/\\/{2,}/g, '/');\r\n\t\tif (route.startsWith('/api/')) {\r\n\t\t\t// Ne pas normaliser les routes API ici\r\n\t\t\treturn route;\r\n\t\t}\r\n\t}\r\n\tif (!route.startsWith('/')) route = '/' + route;\r\n\treturn route;\r\n}\r\n\r\n// Helper: map un enregistrement Module (+ \u00E9ventuellement status org) vers le format frontend\r\ntype MinimalModule = Pick<PrismaModule, 'id' | 'key' | 'label' | 'feature' | 'icon' | 'route' | 'description' | 'page' | 'order' | 'active' | 'organizationId' | 'parameters'> & {\r\n\tCategory?: {\r\n\t\tid: string;\r\n\t\tname: string;\r\n\t\ticon: string | null;\r\n\t\ticonColor: string | null;\r\n\t} | null;\r\n};\r\nfunction mapModule(m: MinimalModule, orgStatuses: Record<string, boolean> | null, organizationId?: string | null) {\r\n\t// Statut global\r\n\tconst activeGlobal = m.active !== false;\r\n\tlet isActiveForOrg: boolean | undefined = undefined;\r\n\tif (organizationId) {\r\n\t\t// Si un organizationId est fourni, tenter de lire le status sp\u00E9cifique\r\n\t\tif (orgStatuses && orgStatuses[m.id] !== undefined) {\r\n\t\t\tisActiveForOrg = orgStatuses[m.id];\r\n\t\t} else if (m.organizationId && m.organizationId === organizationId) {\r\n\t\t\t// Module sp\u00E9cifique \u00E0 l'organisation\r\n\t\t\tisActiveForOrg = activeGlobal;\r\n\t\t} else if (!m.organizationId) {\r\n\t\t\t// Module global sans statut sp\u00E9cifique enregistr\u00E9 \u2192 permissif\r\n\t\t\tisActiveForOrg = activeGlobal; // fallback true si actif globalement\r\n\t\t} else {\r\n\t\t\t// Module d'une autre organisation\r\n\t\t\tisActiveForOrg = false;\r\n\t\t}\r\n\t}\r\n\treturn {\r\n\t\tid: m.id,\r\n\t\tkey: m.key,\r\n\t\tlabel: m.label,\r\n\t\tfeature: m.feature,\r\n\t\ticon: m.icon,\r\n\t\troute: m.route,\r\n\t\tdescription: m.description,\r\n\t\tpage: m.page,\r\n\t\torder: m.order ?? 0,\r\n\t\tactive: activeGlobal,\r\n\t\tparameters: m.parameters, // \uD83D\uDD27 Inclure les param\u00E8tres\r\n\t\torganizationId: m.organizationId,\r\n\t\tisActiveForOrg,\r\n\t\t// \u2705 Ajouter les informations de cat\u00E9gorie\r\n\t\tcategory: m.Category?.name || null,\r\n\t\tcategoryIcon: m.Category?.icon || null,\r\n\t\tcategoryColor: m.Category?.iconColor || null,\r\n\t};\r\n}\r\n\r\n// GET /api/modules?organizationId=xxx\r\nrouter.get('/', async (req, res) => {\r\n\tconst { organizationId } = req.query as { organizationId?: string };\r\n\ttry {\r\n\t\t// R\u00E9cup\u00E9ration brute des modules (globaux + sp\u00E9cifiques) avec cat\u00E9gories\r\n\t\tconst modules = await prisma.module.findMany({\r\n\t\t\torderBy: { order: 'asc' },\r\n\t\t\tinclude: {\r\n\t\t\t\tCategory: {\r\n\t\t\t\t\tselect: {\r\n\t\t\t\t\t\tid: true,\r\n\t\t\t\t\t\tname: true,\r\n\t\t\t\t\t\ticon: true,\r\n\t\t\t\t\t\ticonColor: true\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tlet orgStatuses: Record<string, boolean> | null = null;\r\n\t\tif (organizationId) {\r\n\t\t\tconst statuses = await prisma.organizationModuleStatus.findMany({\r\n\t\t\t\twhere: { organizationId },\r\n\t\t\t\tselect: { moduleId: true, active: true },\r\n\t\t\t});\r\n\t\t\torgStatuses = statuses.reduce((acc, s) => {\r\n\t\t\t\tacc[s.moduleId] = s.active;\r\n\t\t\t\treturn acc;\r\n\t\t\t}, {} as Record<string, boolean>);\r\n\t\t}\r\n\r\n\t\tconst mapped = modules.map(m => mapModule(m, orgStatuses, organizationId));\r\n\r\n\t\t// Filtrage si organizationId fourni: n'afficher que les modules globaux + ceux de l'orga\r\n\t\tconst filtered = organizationId\r\n\t\t\t? mapped.filter(m => !m.organizationId || m.organizationId === organizationId)\r\n\t\t\t: mapped;\r\n\r\n\t\tres.json({ success: true, data: filtered });\r\n\t} catch (e) {\r\n\t\tconsole.error('[modules] GET / erreur', e);\r\n\t\tres.status(500).json({ success: false, message: 'Erreur r\u00E9cup\u00E9ration modules' });\r\n\t}\r\n});\r\n\r\n// GET /api/modules/all \u2192 tous les modules (mode super-admin vue globale)\r\nrouter.get('/all', async (_req, res) => {\r\n\ttry {\r\n\t\tconst modules = await prisma.module.findMany({ \r\n\t\t\torderBy: { order: 'asc' },\r\n\t\t\tinclude: {\r\n\t\t\t\tCategory: {\r\n\t\t\t\t\tselect: {\r\n\t\t\t\t\t\tid: true,\r\n\t\t\t\t\t\tname: true,\r\n\t\t\t\t\t\ticon: true,\r\n\t\t\t\t\t\ticonColor: true\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst mapped = modules.map(m => mapModule(m, null));\r\n\t\tres.json({ success: true, data: mapped });\r\n\t} catch (e) {\r\n\t\tconsole.error('[modules] GET /all erreur', e);\r\n\t\tres.status(500).json({ success: false, message: 'Erreur r\u00E9cup\u00E9ration modules (all)' });\r\n\t}\r\n});\r\n\r\n// PATCH /api/modules/status { moduleId, organizationId, active }\r\nrouter.patch('/status', async (req, res) => {\r\n\tconst { moduleId, organizationId, active } = req.body as { moduleId: string; organizationId: string; active: boolean };\r\n\tif (!moduleId || !organizationId || typeof active !== 'boolean') {\r\n\t\treturn res.status(400).json({ success: false, message: 'Param\u00E8tres invalides' });\r\n\t}\r\n\ttry {\r\n\t\t// upsert OrganizationModuleStatus\r\n\t\tconst status = await prisma.organizationModuleStatus.upsert({\r\n\t\t\twhere: { organizationId_moduleId: { organizationId, moduleId } },\r\n\t\t\tupdate: { active },\r\n\t\t\tcreate: { organizationId, moduleId, active },\r\n\t\t});\r\n\t\tres.json({ success: true, data: status });\r\n\t} catch (e) {\r\n\t\tconsole.error('[modules] PATCH /status erreur', e);\r\n\t\tres.status(500).json({ success: false, message: 'Erreur mise \u00E0 jour statut module' });\r\n\t}\r\n});\r\n\r\n// POST /api/modules  (cr\u00E9ation)\r\nrouter.post('/', async (req, res) => {\r\n\ttry {\r\n\t\tconst { key, label, feature, icon, route, description, page, order, active, organizationId, parameters } = req.body;\r\n\t\tif (!key || !label) {\r\n\t\t\treturn res.status(400).json({ success: false, message: 'key et label requis' });\r\n\t\t}\r\n\t\tconst finalRoute = deriveRoute(key, route);\r\n\t\tconst created = await prisma.module.create({\r\n\t\t\tdata: {\r\n\t\t\t\tkey,\r\n\t\t\t\tlabel,\r\n\t\t\t\tfeature: feature || key, // fallback\r\n\t\t\t\ticon: icon || null,\r\n\t\t\t\troute: finalRoute,\r\n\t\t\t\tdescription: description || null,\r\n\t\t\t\tpage: page || null,\r\n\t\t\t\torder: typeof order === 'number' ? order : 0,\r\n\t\t\t\tactive: active !== false,\r\n\t\t\t\tparameters: parameters || null, // \uD83D\uDD27 Param\u00E8tres JSON\r\n\t\t\t\torganizationId: organizationId || null,\r\n\t\t\t},\r\n\t\t});\r\n\t\tres.json({ success: true, data: mapModule(created, null, organizationId) });\r\n\t\t} catch (e: unknown) {\r\n\t\t\tconst message = e instanceof Error ? e.message : 'Erreur inconnue';\r\n\t\t\tconsole.error('[modules] POST / erreur', e);\r\n\t\t\tres.status(500).json({ success: false, message: 'Erreur cr\u00E9ation module', detail: message });\r\n\t}\r\n});\r\n\r\n// PUT /api/modules/:id (mise \u00E0 jour)\r\nrouter.put('/:id', async (req, res) => {\r\n\tconst { id } = req.params;\r\n\ttry {\r\n\t\tconst { label, feature, icon, route, description, page, order, active, key, organizationId, parameters, categoryId } = req.body as {\r\n\t\t\tlabel?: string; feature?: string; icon?: string; route?: string; description?: string; page?: string; order?: number; active?: boolean; key?: string; organizationId?: string | null; parameters?: unknown; categoryId?: string;\r\n\t\t};\r\n\t\tlet normalizedRoute: string | undefined;\r\n\t\tif (route !== undefined || key !== undefined) {\r\n\t\t\tnormalizedRoute = deriveRoute(key, route);\r\n\t\t}\r\n\t\t\r\n\t\tconsole.log(`[modules] PUT /${id} - Mise \u00E0 jour module avec categoryId:`, categoryId);\r\n\t\tconsole.log(`[modules] PUT /${id} - Body complet:`, req.body);\r\n\t\t\r\n\t\tconst updated = await prisma.module.update({\r\n\t\t\twhere: { id },\r\n\t\t\tdata: {\r\n\t\t\t\tlabel: label !== undefined ? label : undefined,\r\n\t\t\t\tfeature: feature !== undefined ? feature : undefined,\r\n\t\t\t\ticon: icon !== undefined ? icon : undefined,\r\n\t\t\t\troute: normalizedRoute !== undefined ? normalizedRoute : undefined,\r\n\t\t\t\tdescription: description !== undefined ? description : undefined,\r\n\t\t\t\tpage: page !== undefined ? page : undefined,\r\n\t\t\t\torder: order !== undefined ? order : undefined,\r\n\t\t\t\tactive: active !== undefined ? active : undefined,\r\n\t\t\t\tparameters: parameters !== undefined ? parameters : undefined, // \uD83D\uDD27 Param\u00E8tres JSON\r\n\t\t\t\tkey: key !== undefined ? key : undefined,\r\n\t\t\t\torganizationId: organizationId !== undefined ? organizationId : undefined,\r\n\t\t\t\tcategoryId: categoryId !== undefined ? categoryId : undefined,\r\n\t\t\t},\r\n\t\t});\r\n\t\tres.json({ success: true, data: mapModule(updated, null) });\r\n\t} catch (e: unknown) {\r\n\t\tconsole.error('[modules] PUT /:id erreur', e);\r\n\t\tif (e?.code === 'P2002') {\r\n\t\t\treturn res.status(409).json({ success: false, message: 'Conflit d\\'unicit\u00E9 (cl\u00E9 ou feature d\u00E9j\u00E0 utilis\u00E9e)' });\r\n\t\t}\r\n\t\tres.status(500).json({ success: false, message: 'Erreur mise \u00E0 jour module' });\r\n\t}\r\n});\r\n\r\n// DELETE /api/modules/:id\r\nrouter.delete('/:id', async (req, res) => {\r\n\tconst { id } = req.params;\r\n\ttry {\r\n\t\t// Supprimer d'abord les statuses organisation\r\n\t\tawait prisma.organizationModuleStatus.deleteMany({ where: { moduleId: id } });\r\n\t\tawait prisma.permission.deleteMany({ where: { moduleId: id } }).catch(() => {}); // best effort\r\n\t\tconst deleted = await prisma.module.delete({ where: { id } });\r\n\t\tres.json({ success: true, data: { id: deleted.id } });\r\n\t} catch (e) {\r\n\t\tconsole.error('[modules] DELETE /:id erreur', e);\r\n\t\tres.status(500).json({ success: false, message: 'Erreur suppression module' });\r\n\t}\r\n});\r\n\r\n// Health (optionnel)\r\nrouter.get('/health', (_req, res) => res.json({ success: true, message: 'modules ok' }));\r\n\r\nexport default router;\r\n", "import { Router, Request, Response, type RequestHandler } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport { prisma } from '../lib/prisma';\r\n\r\nconst router = Router();\r\n\r\nrouter.use(authMiddleware as unknown as RequestHandler, impersonationMiddleware as unknown as RequestHandler);\r\n\r\n// GET - R\u00E9cup\u00E9rer TOUS les modules organis\u00E9s par sections (100% dynamique depuis BDD)\r\n// \u26A0\uFE0F ANCIENNE API - Utilise system section/module classique MAIS avec support Category\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const organizationId = req.query.organizationId as string;\r\n    const user = req.user as { id?: string; email?: string; role?: string; organizationId?: string } | undefined;\r\n    const isSuperAdmin = user?.role === 'super_admin';\r\n    \r\n    console.log('[ADMIN-MODULES-V1] GET - R\u00E9cup\u00E9ration modules par sections (syst\u00E8me hybride)');\r\n    console.log('[ADMIN-MODULES-V1] \uD83D\uDC64 User:', user?.email, 'Role:', user?.role, 'IsSuperAdmin:', isSuperAdmin);\r\n    \r\n    // Ic\u00F4ne par d\u00E9faut\r\n    const fallbackIcon = 'AppstoreOutlined';\r\n    \r\n    // R\u00E9cup\u00E9rer TOUS les modules avec TOUTES les colonnes, tri\u00E9s par ordre\r\n    const modules = await prisma.module.findMany({\r\n      where: organizationId ? { \r\n        OR: [\r\n          { organizationId: organizationId },\r\n          { organizationId: null } // Modules globaux\r\n        ]\r\n      } : undefined,\r\n      orderBy: { order: 'asc' },\r\n      include: {\r\n        Organization: true,\r\n        Category: true, // \u2705 Inclure la nouvelle relation Category\r\n        OrganizationModuleStatus: organizationId ? {\r\n          where: { organizationId: organizationId }\r\n        } : true,\r\n        Permission: true\r\n      }\r\n    });\r\n\r\n    // R\u00E9cup\u00E9rer TOUTES les cat\u00E9gories (m\u00EAme celles sans modules) avec filtrage SuperAdmin\r\n    const allCategories = await prisma.category.findMany({\r\n      where: {\r\n        AND: [\r\n          // Filtrage par organisation\r\n          organizationId ? { \r\n            OR: [\r\n              { organizationId: organizationId },\r\n              { organizationId: null } // Cat\u00E9gories globales\r\n            ]\r\n          } : {},\r\n          // V\u00E9rification superAdminOnly : Si pas SuperAdmin, exclure les cat\u00E9gories SuperAdmin Only\r\n          ...(isSuperAdmin ? [] : [{ superAdminOnly: false }])\r\n        ]\r\n      },\r\n      orderBy: { order: 'asc' }\r\n    });\r\n\r\n    // Cr\u00E9er une Map avec TOUTES les cat\u00E9gories d'abord\r\n    const sectionsMap = new Map();\r\n    \r\n    // 1. Ajouter TOUTES les cat\u00E9gories (m\u00EAme vides)\r\n    allCategories.forEach(category => {\r\n      const sectionKey = `category_${category.id}`;\r\n      sectionsMap.set(sectionKey, {\r\n        id: category.id,\r\n        backendCategoryId: category.id, // \u2705 identifiant r\u00E9el BDD\r\n        title: category.name,\r\n        iconName: category.icon || fallbackIcon,\r\n        iconColor: category.iconColor || '#1890ff',\r\n        order: category.order || 999,\r\n        active: category.active ?? true,\r\n        superAdminOnly: category.superAdminOnly ?? false,\r\n        isRealCategory: true,\r\n        modules: []\r\n      });\r\n    });\r\n    \r\n    // 2. Ensuite, assigner les modules aux cat\u00E9gories\r\n    modules.forEach(module => {\r\n      // Utiliser la VRAIE cat\u00E9gorie de la BDD, pas le feature\r\n      let sectionKey, sectionName, sectionIcon, sectionColor, sectionOrder, sectionId, sectionActive, sectionSuperAdminOnly;\r\n      \r\n      if (module.Category) {\r\n        // Module avec une vraie cat\u00E9gorie BDD\r\n        sectionKey = `category_${module.Category.id}`;\r\n        sectionName = module.Category.name;\r\n        sectionIcon = module.Category.icon || fallbackIcon;\r\n        sectionColor = module.Category.iconColor || '#1890ff';\r\n        sectionOrder = module.Category.order || 999;\r\n        sectionId = module.Category.id;\r\n        sectionActive = module.Category.active ?? true;\r\n        sectionSuperAdminOnly = module.Category.superAdminOnly ?? false;\r\n      } else {\r\n        // Fallback pour modules sans cat\u00E9gorie (utiliser feature ou \"Non class\u00E9\")\r\n        const fallbackName = module.feature ? \r\n          module.feature.charAt(0).toUpperCase() + module.feature.slice(1) : \r\n          'Non class\u00E9';\r\n        sectionKey = `feature_${fallbackName}`;\r\n        sectionName = fallbackName;\r\n        sectionIcon = module.icon || fallbackIcon;\r\n        sectionColor = '#1890ff';\r\n        sectionOrder = module.order ? Math.floor(module.order / 10) * 10 : 999;\r\n        sectionId = fallbackName; // Pas d'ID pour les fallbacks\r\n        sectionActive = true;\r\n        sectionSuperAdminOnly = false;\r\n        \r\n        // Cr\u00E9er la section fallback si elle n'existe pas\r\n        if (!sectionsMap.has(sectionKey)) {\r\n          sectionsMap.set(sectionKey, {\r\n            id: sectionId,\r\n            backendCategoryId: null, // \u274C pas de cat\u00E9gorie BDD\r\n            title: sectionName,\r\n            iconName: sectionIcon,\r\n            iconColor: sectionColor,\r\n            order: sectionOrder,\r\n            active: sectionActive,\r\n            superAdminOnly: sectionSuperAdminOnly,\r\n            isRealCategory: false,\r\n            modules: []\r\n          });\r\n        }\r\n      }\r\n      \r\n      // Ajouter le module \u00E0 la section (elle existe d\u00E9j\u00E0 gr\u00E2ce \u00E0 l'\u00E9tape 1)\r\n      if (sectionsMap.has(sectionKey)) {\r\n        sectionsMap.get(sectionKey).modules.push({\r\n          ...module,\r\n          // Enrichir avec les donn\u00E9es de statut\r\n          isActiveForOrg: module.OrganizationModuleStatus?.[0]?.active ?? true,\r\n          hasOrgSpecificConfig: module.OrganizationModuleStatus?.length > 0,\r\n        });\r\n      }\r\n    });\r\n\r\n    // Convertir en array et trier les sections\r\n    const sections = Array.from(sectionsMap.values()).sort(\r\n      (a, b) => a.order - b.order\r\n    );\r\n\r\n    console.log(`[ADMIN-MODULES-V1] Sections cr\u00E9\u00E9es: ${sections.length} (syst\u00E8me par cat\u00E9gories)`);\r\n    console.log(`[ADMIN-MODULES-V1] Total modules: ${modules.length}`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        sections,\r\n        totalModules: modules.length,\r\n        totalSections: sections.length,\r\n        systemType: 'hybrid', // Indicateur pour le frontend\r\n        categorySystemAvailable: modules.some(m => m.categoryId) // \u2705 Y a-t-il des modules avec categoryId ?\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES-V1] Erreur GET:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des modules',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// ===== ROUTES CATEGORIES SYSTEM =====\r\n\r\n// GET - R\u00E9cup\u00E9rer toutes les categories (pour l'admin des modules)\r\nrouter.get('/categories', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const organizationId = req.query.organizationId as string;\r\n    \r\n    console.log('[ADMIN-MODULES] GET /categories - R\u00E9cup\u00E9ration des categories');\r\n    \r\n    const categories = await prisma.category.findMany({\r\n      where: organizationId ? { \r\n        OR: [\r\n          { organizationId: organizationId },\r\n          { organizationId: null } // Categories globales\r\n        ]\r\n      } : undefined,\r\n      orderBy: { order: 'asc' },\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            Module: true // Compter les modules dans chaque category\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    console.log(`[ADMIN-MODULES] ${categories.length} categories trouv\u00E9es`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: categories,\r\n      total: categories.length\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES] Erreur GET /categories:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des categories',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// POST - Cr\u00E9er une nouvelle category\r\nrouter.post('/categories', requireRole(['admin', 'super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { name, description, icon, iconColor, order, organizationId } = req.body as {\r\n      name?: string;\r\n      description?: string;\r\n      icon?: string;\r\n      iconColor?: string;\r\n      order?: number;\r\n      organizationId?: string | null;\r\n    };\r\n\r\n    // Validation minimale du payload\r\n    if (!name || typeof name !== 'string' || !name.trim()) {\r\n      res.status(400).json({ success: false, error: 'Le champ \"name\" est requis pour cr\u00E9er une cat\u00E9gorie.' });\r\n      return;\r\n    }\r\n\r\n    console.log('[ADMIN-MODULES] POST /categories - Cr\u00E9ation category:', { name, icon, organizationId });\r\n\r\n    // G\u00E9n\u00E9rer un UUID pour la nouvelle cat\u00E9gorie\r\n    const { randomUUID } = await import('crypto');\r\n    const categoryId = randomUUID();\r\n\r\n    const now = new Date();\r\n    const category = await prisma.category.create({\r\n      data: {\r\n        id: categoryId,\r\n        name: name.trim(),\r\n        description: description || null,\r\n        icon: icon || 'AppstoreOutlined',\r\n        iconColor: iconColor || '#1890ff',\r\n        order: typeof order === 'number' ? order : 0,\r\n        organizationId: organizationId || null,\r\n        active: true,\r\n        // Le sch\u00E9ma ne d\u00E9finit pas @updatedAt ni de default \u2192 fournir explicitement\r\n        updatedAt: now,\r\n      }\r\n    });\r\n\r\n    console.log(`[ADMIN-MODULES] Category cr\u00E9\u00E9e: ${category.id}`);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: category\r\n    });\r\n\r\n  } catch (error: unknown) {\r\n    // Gestion d'erreurs Prisma plus parlante\r\n    const code = (error as { code?: string } | undefined)?.code;\r\n    if (code === 'P2003') {\r\n      // Contrainte FK \u00E9chou\u00E9e (ex: organizationId invalide)\r\n      res.status(400).json({ success: false, error: 'organizationId invalide' });\r\n      return;\r\n    }\r\n    console.error('[ADMIN-MODULES] Erreur POST /categories:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la cr\u00E9ation de la category',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT - R\u00E9organiser les categories (drag & drop) - DOIT \u00EAtre avant /:id\r\nrouter.put('/categories/reorder', requireRole(['admin', 'super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { updates } = req.body; // [{ id, order }, ...]\r\n    \r\n    console.log('[ADMIN-MODULES] PUT /categories/reorder - R\u00E9organisation categories:', updates.length);\r\n    \r\n    // Mettre \u00E0 jour l'ordre de chaque category\r\n    for (const update of updates) {\r\n      await prisma.category.update({\r\n        where: { id: update.id },\r\n        data: { \r\n          order: update.order,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(`[ADMIN-MODULES] ${updates.length} categories r\u00E9organis\u00E9es`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: `${updates.length} categories r\u00E9organis\u00E9es avec succ\u00E8s`\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES] Erreur PUT /categories/reorder:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la r\u00E9organisation des categories',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT - Modifier une category existante\r\nrouter.put('/categories/:id', requireRole(['admin', 'super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { name, description, icon, iconColor, order, active, superAdminOnly } = req.body;\r\n    \r\n    console.log('[ADMIN-MODULES] PUT /categories/:id - Modification category:', { id, name, active, superAdminOnly });\r\n    \r\n    // Logique d'interd\u00E9pendance: Si superAdminOnly est activ\u00E9, automatiquement d\u00E9sactiver active\r\n    const finalActive = superAdminOnly ? false : active;\r\n    \r\n    if (superAdminOnly && active) {\r\n      console.log('[ADMIN-MODULES] SuperAdminOnly activ\u00E9 - D\u00E9sactivation automatique du module pour les organisations');\r\n    }\r\n    \r\n    const category = await prisma.category.update({\r\n      where: { id },\r\n      data: {\r\n        name,\r\n        description,\r\n        icon,\r\n        iconColor,\r\n        order,\r\n        active: finalActive,\r\n        superAdminOnly: superAdminOnly ?? false,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`[ADMIN-MODULES] Category modifi\u00E9e: ${category.id}`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: category\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES] Erreur PUT /categories/:id:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la modification de la category',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE - Supprimer une category\r\nrouter.delete('/categories/:id', requireRole(['admin', 'super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    \r\n    console.log('[ADMIN-MODULES] DELETE /categories/:id - Suppression category:', { id });\r\n    \r\n    // V\u00E9rifier qu'aucun module n'utilise cette category\r\n    const moduleCount = await prisma.module.count({\r\n      where: { categoryId: id }\r\n    });\r\n    \r\n    if (moduleCount > 0) {\r\n      res.status(400).json({\r\n        success: false,\r\n        error: `Cannot delete category with ${moduleCount} modules attached`\r\n      });\r\n      return;\r\n    }\r\n    \r\n    await prisma.category.delete({\r\n      where: { id }\r\n    });\r\n\r\n    console.log(`[ADMIN-MODULES] Category supprim\u00E9e: ${id}`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Category supprim\u00E9e avec succ\u00E8s'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES] Erreur DELETE /categories/:id:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la suppression de la category',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT - Modifier un module existant (pour les toggles)\r\nrouter.put('/modules/:id', requireRole(['admin', 'super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { active, superAdminOnly } = req.body;\r\n    \r\n    console.log('[ADMIN-MODULES] PUT /modules/:id - Modification module:', { id, active, superAdminOnly });\r\n    \r\n    // Logique d'interd\u00E9pendance: Si superAdminOnly est activ\u00E9, automatiquement d\u00E9sactiver active\r\n    const finalActive = superAdminOnly ? false : active;\r\n    \r\n    if (superAdminOnly && active) {\r\n      console.log('[ADMIN-MODULES] SuperAdminOnly activ\u00E9 - D\u00E9sactivation automatique du module pour les organisations');\r\n    }\r\n    \r\n    const module = await prisma.module.update({\r\n      where: { id },\r\n      data: {\r\n        active: finalActive,\r\n        superAdminOnly: superAdminOnly ?? false,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`[ADMIN-MODULES] Module modifi\u00E9: ${module.id}`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: module\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES] Erreur PUT /modules/:id:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la modification du module',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE - Supprimer un module (alias de compatibilit\u00E9)\r\nrouter.delete('/modules/:id', requireRole(['admin', 'super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    console.log('[ADMIN-MODULES] DELETE /modules/:id (alias) - Suppression module:', { id });\r\n\r\n    // Supprimer d'abord les statuts et permissions li\u00E9s (meilleur effort)\r\n    await prisma.organizationModuleStatus.deleteMany({ where: { moduleId: id } });\r\n    await prisma.permission.deleteMany({ where: { moduleId: id } }).catch(() => {});\r\n\r\n    await prisma.module.delete({ where: { id } });\r\n\r\n    res.json({ success: true, data: { id } });\r\n  } catch (error) {\r\n    console.error('[ADMIN-MODULES] Erreur DELETE /modules/:id (alias):', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la suppression du module',\r\n      details: error instanceof Error ? error.message : 'Unknown error'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import type { Request, Response, NextFunction } from 'express';\r\nimport type { AuthenticatedRequest } from './auth.js';\r\n\r\nexport function requireRole(roles: string[]) {\r\n  return (req: Request, res: Response, next: NextFunction): void => {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const user = authReq.user;\r\n\r\n    console.log('[requireRole] \uD83D\uDD0D DEBUG - User object:', {\r\n      userId: user?.userId,\r\n      isSuperAdmin: user?.isSuperAdmin,\r\n      role: user?.role,\r\n      userExists: !!user\r\n    });\r\n\r\n    if (!user) {\r\n      console.log('[requireRole] \u274C Pas d\\'utilisateur authentifi\u00E9');\r\n      res.status(403).json({ error: 'Acc\u00E8s refus\u00E9' });\r\n      return;\r\n    }\r\n\r\n    // \uD83D\uDC51 SUPER ADMIN A ACC\u00C8S \u00C0 TOUT ! C'EST LE BOSS ! \uD83D\uDC51\r\n    if (user.isSuperAdmin === true || user.role === 'super_admin') {\r\n      console.log('[requireRole] \uD83D\uDC51 SuperAdmin d\u00E9tect\u00E9 - Acc\u00E8s autoris\u00E9 \u00E0 tout !');\r\n      next();\r\n      return;\r\n    }\r\n\r\n    // Un super_admin en mode impersonation a tous les droits\r\n    if (authReq.originalUser && authReq.originalUser.role === 'super_admin') {\r\n      console.log('[requireRole] \uD83D\uDC51 SuperAdmin en impersonation d\u00E9tect\u00E9 - Acc\u00E8s autoris\u00E9 !');\r\n      next();\r\n      return;\r\n    }\r\n\r\n    if (!roles.includes(user.role as string)) {\r\n      console.log(`[requireRole] \u274C Acc\u00E8s refus\u00E9 - R\u00F4le ${user.role} non autoris\u00E9 pour ${roles.join(', ')}`);\r\n      res.status(403).json({ error: 'Acc\u00E8s refus\u00E9' });\r\n      return;\r\n    }\r\n    next();\r\n  };\r\n}\r\n", "import { Router, Request, Response, type RequestHandler } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { requireRole } from '../middlewares/requireRole';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\nrouter.use(authMiddleware as unknown as RequestHandler, impersonationMiddleware as unknown as RequestHandler);\r\n\r\n// GET - R\u00E9cup\u00E9rer toutes les ic\u00F4nes disponibles\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { category, search } = req.query;\r\n    \r\n    console.log('[ICONS-API] GET - R\u00E9cup\u00E9ration des ic\u00F4nes', { category, search });\r\n\r\n    let whereClause: any = {\r\n      active: true // Seulement les ic\u00F4nes actives\r\n    };\r\n\r\n    // Filtre par cat\u00E9gorie\r\n    if (category && category !== 'all') {\r\n      whereClause.category = category;\r\n    }\r\n\r\n    // Recherche dans le nom, la description et les tags\r\n    if (search && typeof search === 'string') {\r\n      const searchTerm = search.toLowerCase();\r\n      whereClause.OR = [\r\n        { name: { contains: searchTerm, mode: 'insensitive' } },\r\n        { description: { contains: searchTerm, mode: 'insensitive' } },\r\n        { tags: { hasSome: [searchTerm] } }\r\n      ];\r\n    }\r\n\r\n    const icons = await prisma.icon.findMany({\r\n      where: whereClause,\r\n      orderBy: [\r\n        { category: 'asc' },\r\n        { name: 'asc' }\r\n      ]\r\n    });\r\n\r\n    // Grouper par cat\u00E9gorie pour faciliter l'affichage\r\n    const groupedIcons = icons.reduce((acc, icon) => {\r\n      if (!acc[icon.category]) {\r\n        acc[icon.category] = [];\r\n      }\r\n      acc[icon.category].push(icon);\r\n      return acc;\r\n    }, {} as Record<string, typeof icons>);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        icons: icons,\r\n        groupedIcons: groupedIcons,\r\n        totalCount: icons.length,\r\n        categories: Object.keys(groupedIcons).sort()\r\n      }\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[ICONS-API] Erreur lors de la r\u00E9cup\u00E9ration des ic\u00F4nes:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des ic\u00F4nes',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// GET - R\u00E9cup\u00E9rer les cat\u00E9gories d'ic\u00F4nes\r\nrouter.get('/categories', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    console.log('[ICONS-API] GET - R\u00E9cup\u00E9ration des cat\u00E9gories d\\'ic\u00F4nes');\r\n\r\n    const categories = await prisma.icon.groupBy({\r\n      by: ['category'],\r\n      where: { active: true },\r\n      _count: { id: true },\r\n      orderBy: { category: 'asc' }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: categories.map(cat => ({\r\n        name: cat.category,\r\n        count: cat._count.id\r\n      }))\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[ICONS-API] Erreur lors de la r\u00E9cup\u00E9ration des cat\u00E9gories:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des cat\u00E9gories',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// POST - Cr\u00E9er une nouvelle ic\u00F4ne (Admin seulement)\r\nrouter.post('/', requireRole(['super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { name, category, description, tags, active = true } = req.body;\r\n    \r\n    console.log('[ICONS-API] POST - Cr\u00E9ation d\\'une nouvelle ic\u00F4ne:', { name, category });\r\n\r\n    if (!name || !category) {\r\n      res.status(400).json({\r\n        success: false,\r\n        error: 'Le nom et la cat\u00E9gorie sont requis'\r\n      });\r\n      return;\r\n    }\r\n\r\n    const newIcon = await prisma.icon.create({\r\n      data: {\r\n        name,\r\n        category,\r\n        description,\r\n        tags: Array.isArray(tags) ? tags : [],\r\n        active\r\n      }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: newIcon,\r\n      message: `Ic\u00F4ne \"${name}\" cr\u00E9\u00E9e avec succ\u00E8s`\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[ICONS-API] Erreur lors de la cr\u00E9ation de l\\'ic\u00F4ne:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la cr\u00E9ation de l\\'ic\u00F4ne',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// PUT - Modifier une ic\u00F4ne existante (Admin seulement)\r\nrouter.put('/:id', requireRole(['super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const updateData = req.body;\r\n    \r\n    console.log('[ICONS-API] PUT - Modification de l\\'ic\u00F4ne:', { id, updateData });\r\n\r\n    // Supprimer les champs non modifiables\r\n    delete updateData.id;\r\n    delete updateData.createdAt;\r\n    delete updateData.updatedAt;\r\n\r\n    const updatedIcon = await prisma.icon.update({\r\n      where: { id },\r\n      data: updateData\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: updatedIcon,\r\n      message: `Ic\u00F4ne mise \u00E0 jour avec succ\u00E8s`\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[ICONS-API] Erreur lors de la modification de l\\'ic\u00F4ne:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la modification de l\\'ic\u00F4ne',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE - D\u00E9sactiver une ic\u00F4ne (Admin seulement)\r\nrouter.delete('/:id', requireRole(['super_admin']) as unknown as RequestHandler, async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    \r\n    console.log('[ICONS-API] DELETE - D\u00E9sactivation de l\\'ic\u00F4ne:', id);\r\n\r\n    // On d\u00E9sactive plut\u00F4t que de supprimer pour pr\u00E9server l'int\u00E9grit\u00E9\r\n    const disabledIcon = await prisma.icon.update({\r\n      where: { id },\r\n      data: { active: false }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: disabledIcon,\r\n      message: `Ic\u00F4ne d\u00E9sactiv\u00E9e avec succ\u00E8s`\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[ICONS-API] Erreur lors de la d\u00E9sactivation de l\\'ic\u00F4ne:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la d\u00E9sactivation de l\\'ic\u00F4ne',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// Routes pour la gestion des entreprises\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest, requireRole } from '../middlewares/auth.js';\r\n\r\nconst router = Router();\r\n\r\n// Authentification requise pour toutes les routes\r\nrouter.use(authMiddleware);\r\n\r\n/**\r\n * GET /api/company\r\n * Obtenir les informations de l'entreprise\r\n */\r\nrouter.get('/', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { organizationId } = req.user!;\r\n    \r\n    // TODO: R\u00E9cup\u00E9rer les informations de l'entreprise depuis la base de donn\u00E9es\r\n    const companyInfo = {\r\n      id: organizationId,\r\n      name: \"2Thier CRM\",\r\n      address: \"Rue de Floreffe 37, 5150 Frani\u00E8re\",\r\n      phone: \"0470/29.50.77\",\r\n      email: \"info@2thier.be\",\r\n      website: \"https://2thier.be\",\r\n      vatNumber: \"BE0123456789\",\r\n      registrationNumber: \"123456789\"\r\n    };\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: companyInfo\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [CompanyAPI] Erreur r\u00E9cup\u00E9ration entreprise:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des informations de l\\'entreprise' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * PUT /api/company\r\n * Mettre \u00E0 jour les informations de l'entreprise (Admin seulement)\r\n */\r\nrouter.put('/', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { organizationId } = req.user!;\r\n    const updateData = req.body;\r\n    \r\n    // TODO: Mettre \u00E0 jour les informations dans la base de donn\u00E9es\r\n    console.log('\uD83D\uDD04 [CompanyAPI] Mise \u00E0 jour entreprise:', { organizationId, updateData });\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Informations de l\\'entreprise mises \u00E0 jour avec succ\u00E8s',\r\n      data: updateData\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [CompanyAPI] Erreur mise \u00E0 jour entreprise:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la mise \u00E0 jour des informations de l\\'entreprise' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/company/settings\r\n * Obtenir les param\u00E8tres de l'entreprise\r\n */\r\nrouter.get('/settings', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { organizationId } = req.user!;\r\n\r\n    // TODO: R\u00E9cup\u00E9rer les param\u00E8tres depuis la base de donn\u00E9es\r\n    const settings = {\r\n      organizationId,\r\n      currency: \"EUR\",\r\n      timezone: \"Europe/Brussels\",\r\n      language: \"fr\",\r\n      dateFormat: \"DD/MM/YYYY\",\r\n      invoicePrefix: \"INV-\",\r\n      quotePrefix: \"DEV-\"\r\n    };\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: settings\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [CompanyAPI] Erreur param\u00E8tres entreprise:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des param\u00E8tres' \r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from \"express\";\r\nimport { authMiddleware, AuthenticatedRequest } from \"../middlewares/auth\";\r\nimport { impersonationMiddleware } from \"../middlewares/impersonation\";\r\nimport { requireRole } from \"../middlewares/requireRole\";\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { z } from 'zod';\r\nimport { Prisma, PrismaClient } from '@prisma/client';\r\nimport bcrypt from 'bcryptjs';\r\nimport { emailService } from \"../services/EmailService\";\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\n\r\n// Sch\u00E9ma de validation pour la cr\u00E9ation d'invitation\r\nconst createInvitationSchema = z.object({\r\n  email: z.string().email(\"L'adresse e-mail est invalide.\"),\r\n  roleName: z.string().min(1, \"Le nom du r\u00F4le est requis.\"),\r\n  organizationId: z.string().uuid(\"L'ID de l'organisation est requis et doit \u00EAtre un UUID valide.\"),\r\n});\r\n\r\n// Route pour cr\u00E9er une nouvelle invitation\r\nrouter.post('/', authMiddleware, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  try {\r\n    const { email, roleName, organizationId } = createInvitationSchema.parse(req.body);\r\n  const inviterId = req.user!.userId; // ID de l'utilisateur qui invite\r\n\r\n    // 1. V\u00E9rifier si l'utilisateur est d\u00E9j\u00E0 dans l'organisation\r\n    const existingUserInOrg = await prisma.userOrganization.findFirst({\r\n      where: {\r\n        organizationId: organizationId,\r\n        User: { email: email },\r\n      },\r\n    });\r\n    if (existingUserInOrg) {\r\n      res.status(409).json({ message: \"Un utilisateur avec cet e-mail est d\u00E9j\u00E0 membre de cette organisation.\" });\r\n      return;\r\n    }\r\n\r\n    // 2. Trouver le r\u00F4le (soit sp\u00E9cifique \u00E0 l'organisation, soit global)\r\n    const role = await prisma.role.findFirst({\r\n      where: { \r\n        name: roleName, \r\n        OR: [\r\n          { organizationId: organizationId }, // R\u00F4le sp\u00E9cifique \u00E0 l'organisation\r\n          { organizationId: null }            // R\u00F4le global\r\n        ]\r\n      },\r\n    });\r\n    if (!role) {\r\n      res.status(404).json({ message: `Le r\u00F4le '${roleName}' n'a pas \u00E9t\u00E9 trouv\u00E9.` });\r\n      return;\r\n    }\r\n\r\n    // 3. G\u00E9rer les invitations existantes pour ce couple email/organisation\r\n    const existingInvitation = await prisma.invitation.findUnique({\r\n      where: { email_organizationId: { email, organizationId } },\r\n    });\r\n\r\n    if (existingInvitation && existingInvitation.status === 'PENDING' && existingInvitation.expiresAt > new Date()) {\r\n      res.status(409).json({ message: \"Une invitation active existe d\u00E9j\u00E0 pour cette adresse e-mail dans cette organisation.\" });\r\n      return;\r\n    }\r\n    // Si une invitation non-active existe (expir\u00E9e, d\u00E9sactiv\u00E9e...), on la supprime pour en cr\u00E9er une nouvelle.\r\n    if (existingInvitation) {\r\n      await prisma.invitation.delete({ where: { id: existingInvitation.id } });\r\n    }\r\n\r\n    // 4. V\u00E9rifier si l'e-mail correspond \u00E0 un utilisateur existant\r\n    const targetUser = await prisma.user.findUnique({\r\n      where: { email },\r\n    });\r\n\r\n    const token = uuidv4();\r\n    const expiresAt = new Date();\r\n    expiresAt.setDate(expiresAt.getDate() + 7);\r\n\r\n    // IMPORTANT: Utiliser les noms de relations EXACTS d\u00E9finis dans Prisma (voir schema.prisma)\r\n    const invitationData: Prisma.InvitationCreateInput = {\r\n      email,\r\n      token,\r\n      expiresAt,\r\n      Organization: { connect: { id: organizationId } },\r\n      Role: { connect: { id: role.id } },\r\n      // Relation \"Invitation_invitedByIdToUser\" c\u00F4t\u00E9 Invitation est expos\u00E9e comme\r\n      // User_Invitation_invitedByIdToUser dans le client Prisma\r\n      User_Invitation_invitedByIdToUser: { connect: { id: inviterId } },\r\n      status: 'PENDING',\r\n    };\r\n\r\n    // Si un utilisateur existe (quel que soit son statut ou ses organisations), on lie l'invitation\r\n    if (targetUser) {\r\n      // Relation \"Invitation_targetUserIdToUser\" c\u00F4t\u00E9 Invitation\r\n  invitationData.User_Invitation_targetUserIdToUser = { connect: { id: targetUser.id } } as unknown as Prisma.User_Invitation_targetUserIdToUserCreateNestedOneWithoutInvitationInput;\r\n    }\r\n\r\n    const newInvitation = await prisma.invitation.create({\r\n      data: invitationData,\r\n      include: {\r\n        Organization: true,\r\n        Role: true,\r\n      }\r\n    });\r\n\r\n    // Envoyer l'e-mail de notification\r\n    try {\r\n      await emailService.sendInvitationEmail({\r\n        to: newInvitation.email,\r\n        token: newInvitation.token,\r\n        isExistingUser: !!targetUser,\r\n        organizationName: newInvitation.Organization.name,\r\n        roleName: newInvitation.Role.label || newInvitation.Role.name,\r\n      });\r\n    } catch (emailError) {\r\n        console.error(\"\u00C9chec de l'envoi de l'e-mail d'invitation:\", emailError);\r\n        // Ne pas bloquer la r\u00E9ponse si l'e-mail \u00E9choue.\r\n        // Un syst\u00E8me de logging plus robuste serait utile ici en production.\r\n    }\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      message: \"Invitation envoy\u00E9e avec succ\u00E8s.\",\r\n      data: {\r\n        id: newInvitation.id,\r\n        token: newInvitation.token,\r\n        isExistingUser: !!targetUser,\r\n      },\r\n    });\r\n\r\n  } catch (error) {\r\n    if (error instanceof z.ZodError) {\r\n      res.status(400).json({ message: 'Donn\u00E9es invalides.', details: error.errors });\r\n      return;\r\n    }\r\n    if (error instanceof Prisma.PrismaClientKnownRequestError) {\r\n      if (error.code === 'P2002') {\r\n        const target = error.meta?.target ?? 'champs inconnus';\r\n        console.error(`Erreur de contrainte unique (P2002) sur ${target}:`, error);\r\n        res.status(409).json({\r\n            message: `Conflit de donn\u00E9es. Une entr\u00E9e avec ces informations existe d\u00E9j\u00E0.`\r\n        });\r\n        return;\r\n      }\r\n    }\r\n    console.error(\"Erreur lors de la cr\u00E9ation de l'invitation:\", error);\r\n    res.status(500).json({ message: \"Erreur interne du serveur.\" });\r\n  }\r\n});\r\n\r\n// POST /api/invitations/:id/resend\r\n// Reg\u00E9n\u00E8re le token pour une invitation existante.\r\nrouter.post('/:id/resend', authMiddleware, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n\r\n  try {\r\n    const invitation = await prisma.invitation.findFirst({\r\n      where: { id: id, status: { in: ['PENDING', 'DISABLED'] } },\r\n    });\r\n\r\n    if (!invitation) {\r\n      res.status(404).json({ success: false, message: \"Invitation non trouv\u00E9e, d\u00E9j\u00E0 utilis\u00E9e ou expir\u00E9e.\" });\r\n      return;\r\n    }\r\n\r\n    // Reg\u00E9n\u00E9rer le token et la date d'expiration\r\n    const newToken = uuidv4();\r\n    const newExpiresAt = new Date();\r\n    newExpiresAt.setDate(newExpiresAt.getDate() + 7);\r\n\r\n    const updatedInvitation = await prisma.invitation.update({\r\n      where: { id: id },\r\n      data: {\r\n        token: newToken,\r\n        expiresAt: newExpiresAt,\r\n        status: 'PENDING', // R\u00E9activer l'invitation si elle \u00E9tait d\u00E9sactiv\u00E9e\r\n      },\r\n    });\r\n\r\n    // Ici, vous pourriez d\u00E9clencher un envoi d'email avec le nouveau token\r\n\r\n    res.status(200).json({ success: true, message: \"L'invitation a \u00E9t\u00E9 renvoy\u00E9e avec succ\u00E8s.\", data: { token: updatedInvitation.token } });\r\n\r\n  } catch (error) {\r\n    console.error(\"Erreur lors du renvoi de l'invitation:\", error);\r\n    res.status(500).json({ success: false, message: \"Erreur interne du serveur.\" });\r\n  }\r\n});\r\n\r\n// Route pour changer le statut d'une invitation\r\nrouter.patch('/:id/status', authMiddleware, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n    const { id } = req.params;\r\n    const { status } = req.body;\r\n\r\n    if (!['PENDING', 'DISABLED'].includes(status)) {\r\n        res.status(400).json({ message: \"Statut invalide. Seuls PENDING et DISABLED sont autoris\u00E9s.\" });\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const invitation = await prisma.invitation.findUnique({ where: { id } });\r\n\r\n        if (!invitation) {\r\n            res.status(404).json({ message: \"Invitation non trouv\u00E9e.\" });\r\n            return;\r\n        }\r\n\r\n        if (invitation.status !== 'PENDING' && invitation.status !== 'DISABLED') {\r\n            res.status(400).json({ message: `L'invitation ne peut pas \u00EAtre modifi\u00E9e car son statut est ${invitation.status}.` });\r\n            return;\r\n        }\r\n\r\n        const updatedInvitation = await prisma.invitation.update({\r\n            where: { id },\r\n            data: { status: status },\r\n        });\r\n\r\n        res.json({ success: true, data: updatedInvitation });\r\n    } catch (error) {\r\n        console.error(`Erreur lors de la mise \u00E0 jour du statut de l'invitation ${id}:`, error);\r\n        res.status(500).json({ success: false, message: \"Erreur interne du serveur.\" });\r\n    }\r\n});\r\n\r\n// Sch\u00E9ma de validation pour la v\u00E9rification du jeton\r\nconst verifyTokenSchema = z.object({\r\n  token: z.string().uuid(\"Le format du jeton est invalide.\"),\r\n});\r\n\r\n// Route pour v\u00E9rifier la validit\u00E9 d'un jeton d'invitation\r\nrouter.get('/verify', async (req: Request, res: Response): Promise<void> => {\r\n    try {\r\n        const { token } = verifyTokenSchema.parse(req.query);\r\n\r\n        const invitation = await prisma.invitation.findUnique({\r\n            where: { \r\n                token: token, \r\n                expiresAt: { gte: new Date() },\r\n                status: 'PENDING'\r\n            },\r\n      include: {\r\n        Organization: { select: { name: true } },\r\n        Role: { select: { name: true, label: true } }\r\n      }\r\n        });\r\n\r\n        if (!invitation) {\r\n            res.status(404).json({ message: 'Invitation non trouv\u00E9e, invalide, expir\u00E9e ou d\u00E9j\u00E0 utilis\u00E9e.' });\r\n            return;\r\n        }\r\n\r\n        const isExistingUser = !!invitation.targetUserId;\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        email: invitation.email,\r\n        // Normaliser les cl\u00E9s attendues par le frontend (lowercase)\r\n        organization: invitation.Organization,\r\n        role: invitation.Role,\r\n        isExistingUser: isExistingUser,\r\n      }\r\n    });\r\n\r\n    } catch (error) {\r\n        if (error instanceof z.ZodError) {\r\n            res.status(400).json({ message: 'Jeton invalide fourni.', details: error.errors });\r\n            return;\r\n        }\r\n        console.error(\"Erreur lors de la v\u00E9rification du jeton d'invitation:\", error);\r\n        res.status(500).json({ message: \"Erreur interne du serveur.\" });\r\n    }\r\n});\r\n\r\n// Sch\u00E9ma de validation pour l'acceptation de l'invitation\r\nconst acceptInvitationSchema = z.object({\r\n    token: z.string().uuid(\"Le format du jeton est invalide.\"),\r\n    firstName: z.string().min(1, \"Le pr\u00E9nom est requis.\"),\r\n    lastName: z.string().min(1, \"Le nom est requis.\"),\r\n    password: z.string().min(8, \"Le mot de passe doit contenir au moins 8 caract\u00E8res.\"),\r\n});\r\n\r\n// Route pour accepter une invitation et finaliser l'inscription\r\nrouter.post('/accept', async (req: Request, res: Response): Promise<void> => {\r\n    try {\r\n        // Le sch\u00E9ma est maintenant dynamique\r\n        const invitationToken = z.string().uuid(\"Le format du jeton est invalide.\").parse(req.body.token);\r\n\r\n        const invitation = await prisma.invitation.findUnique({\r\n            where: { \r\n                token: invitationToken, \r\n                expiresAt: { gte: new Date() },\r\n                status: 'PENDING'\r\n            },\r\n        });\r\n\r\n        if (!invitation) {\r\n            res.status(404).json({ message: 'Invitation non trouv\u00E9e, invalide, expir\u00E9e ou d\u00E9j\u00E0 utilis\u00E9e.' });\r\n            return;\r\n        }\r\n\r\n        // Sc\u00E9nario 1: L'invitation est pour un utilisateur existant\r\n        if (invitation.targetUserId) {\r\n            const user = await prisma.user.findUnique({ where: { id: invitation.targetUserId }});\r\n            if (!user) {\r\n                // Cas de s\u00E9curit\u00E9 : l'utilisateur li\u00E9 a \u00E9t\u00E9 supprim\u00E9 entre-temps\r\n                res.status(404).json({ message: \"L'utilisateur associ\u00E9 \u00E0 cette invitation n'existe plus.\" });\r\n                return;\r\n            }\r\n\r\n            await prisma.$transaction(async (tx) => {\r\n                // Ajouter l'utilisateur \u00E0 la nouvelle organisation\r\n                await tx.userOrganization.create({\r\n                    data: {\r\n                        userId: user.id,\r\n                        organizationId: invitation.organizationId,\r\n                        roleId: invitation.roleId,\r\n                        status: 'ACTIVE'\r\n                    }\r\n                });\r\n\r\n                // Mettre \u00E0 jour l'invitation\r\n                await tx.invitation.update({\r\n                    where: { id: invitation.id },\r\n                    data: { status: 'ACCEPTED' },\r\n                });\r\n            });\r\n\r\n            res.status(200).json({ success: true, message: `Vous avez rejoint l'organisation avec succ\u00E8s.` });\r\n            return;\r\n        }\r\n\r\n        // Sc\u00E9nario 2: L'invitation est pour un nouvel utilisateur (logique existante)\r\n        const { firstName, lastName, password } = acceptInvitationSchema.parse(req.body);\r\n\r\n        const existingUser = await prisma.user.findUnique({ where: { email: invitation.email } });\r\n        if (existingUser) {\r\n            // Ce cas ne devrait plus se produire gr\u00E2ce \u00E0 la logique de liaison, mais reste une s\u00E9curit\u00E9\r\n            res.status(409).json({ message: \"Un utilisateur avec cette adresse e-mail existe d\u00E9j\u00E0. Veuillez vous connecter pour accepter l'invitation.\" });\r\n            return;\r\n        }\r\n\r\n        const passwordHash = await bcrypt.hash(password, 10);\r\n\r\n        const newUser = await prisma.$transaction(async (tx) => {\r\n            const createdUser = await tx.user.create({\r\n                data: {\r\n                    firstName: firstName,\r\n                    lastName: lastName,\r\n                    email: invitation.email,\r\n                    passwordHash: passwordHash,\r\n                    status: 'active',\r\n                    role: 'user',\r\n                }\r\n            });\r\n\r\n            await tx.userOrganization.create({\r\n                data: {\r\n                    userId: createdUser.id,\r\n                    organizationId: invitation.organizationId,\r\n                    roleId: invitation.roleId,\r\n                }\r\n            });\r\n\r\n            await tx.invitation.update({\r\n                where: { id: invitation.id },\r\n                data: { status: 'ACCEPTED' },\r\n            });\r\n\r\n            return createdUser;\r\n        });\r\n\r\n        res.status(201).json({ success: true, message: \"Inscription r\u00E9ussie!\", data: { userId: newUser.id } });\r\n\r\n    } catch (error) {\r\n        if (error instanceof z.ZodError) {\r\n            res.status(400).json({ message: 'Donn\u00E9es d\\'inscription invalides.', details: error.errors });\r\n            return;\r\n        }\r\n        console.error(\"Erreur lors de l'acceptation de l'invitation:\", error);\r\n        res.status(500).json({ message: \"Erreur interne du serveur.\" });\r\n    }\r\n});\r\n\r\n// DELETE /api/invitations/:id\r\n// Annule une invitation en attente.\r\nrouter.delete('/:id', authMiddleware, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n\r\n  try {\r\n    const invitation = await prisma.invitation.findFirst({\r\n      where: { id: id, status: { in: ['PENDING', 'DISABLED'] } },\r\n    });\r\n\r\n    if (!invitation) {\r\n      res.status(404).json({ success: false, message: \"Invitation non trouv\u00E9e, d\u00E9j\u00E0 utilis\u00E9e ou expir\u00E9e.\" });\r\n      return;\r\n    }\r\n\r\n    // Supprimer l'invitation\r\n    await prisma.invitation.delete({\r\n      where: { id: id },\r\n    });\r\n    \r\n    // Par s\u00E9curit\u00E9, on supprime aussi un potentiel utilisateur cr\u00E9\u00E9 avec le statut 'invited'\r\n    // Bien que la logique actuelle ne semble pas en cr\u00E9er, cela rend le syst\u00E8me plus robuste.\r\n    await prisma.user.deleteMany({\r\n        where: {\r\n            email: invitation.email,\r\n            status: 'invited'\r\n        }\r\n    });\r\n\r\n    res.status(200).json({ success: true, message: \"L'invitation a \u00E9t\u00E9 annul\u00E9e avec succ\u00E8s.\" });\r\n\r\n  } catch (error) {\r\n    console.error(\"Erreur lors de l'annulation de l'invitation:\", error);\r\n    res.status(500).json({ success: false, message: \"Erreur interne du serveur.\" });\r\n  }\r\n});\r\n\r\n// POST /api/invitations/:id/force-accept\r\n// Force l'acceptation d'une invitation pour cr\u00E9er un utilisateur (super_admin only)\r\nrouter.post('/:id/force-accept', requireRole(['super_admin']), async (req: AuthenticatedRequest, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    try {\r\n        const invitation = await prisma.invitation.findUnique({ where: { id } });\r\n\r\n        if (!invitation) {\r\n            return res.status(404).json({ success: false, message: \"Invitation non trouv\u00E9e.\" });\r\n        }\r\n\r\n        if (invitation.status !== 'PENDING') {\r\n            return res.status(400).json({ success: false, message: `L'invitation a d\u00E9j\u00E0 le statut ${invitation.status}.` });\r\n        }\r\n\r\n        const existingUser = await prisma.user.findUnique({ where: { email: invitation.email } });\r\n        if (existingUser) {\r\n            return res.status(409).json({ success: false, message: \"Un utilisateur avec cet e-mail existe d\u00E9j\u00E0.\" });\r\n        }\r\n\r\n        // Cr\u00E9ation de l'utilisateur avec un mot de passe al\u00E9atoire et s\u00E9curis\u00E9\r\n        const tempPassword = uuidv4(); // Utilise uuid pour un mot de passe temporaire robuste\r\n        const passwordHash = await bcrypt.hash(tempPassword, 10);\r\n\r\n        const newUser = await prisma.$transaction(async (tx) => {\r\n            const createdUser = await tx.user.create({\r\n                data: {\r\n                    email: invitation.email,\r\n                    passwordHash: passwordHash,\r\n                    status: 'active',\r\n                    role: 'user', // R\u00F4le global par d\u00E9faut\r\n                    // Le pr\u00E9nom/nom peuvent \u00EAtre vides, l'utilisateur les mettra \u00E0 jour\r\n                }\r\n            });\r\n\r\n            if (invitation.organizationId) {\r\n                await tx.userOrganization.create({\r\n                    data: {\r\n                        userId: createdUser.id,\r\n                        organizationId: invitation.organizationId,\r\n                        roleId: invitation.roleId,\r\n                        status: 'ACTIVE'\r\n                    }\r\n                });\r\n            }\r\n\r\n            await tx.invitation.update({\r\n                where: { id: invitation.id },\r\n                data: { status: 'ACCEPTED' },\r\n            });\r\n\r\n            // Retourner l'utilisateur complet avec ses nouvelles relations\r\n            return tx.user.findUnique({\r\n                where: { id: createdUser.id },\r\n                include: {\r\n                    UserOrganization: {\r\n                        include: {\r\n                            Organization: true,\r\n                            Role: true,\r\n                        },\r\n                    },\r\n                }\r\n            });\r\n        });\r\n\r\n        // NOTE: Vous devriez probablement envoyer un e-mail \u00E0 l'utilisateur\r\n        // avec un lien pour r\u00E9initialiser son mot de passe.\r\n\r\n  res.status(201).json({ success: true, message: \"L'utilisateur a \u00E9t\u00E9 cr\u00E9\u00E9 et l'invitation accept\u00E9e.\", data: newUser });\r\n\r\n    } catch (error) {\r\n  console.error(\"Erreur lors de l'acceptation forc\u00E9e de l'invitation:\", error);\r\n        res.status(500).json({ success: false, message: \"Erreur interne du serveur.\" });\r\n    }\r\n});\r\n\r\n// GET /api/invitations : liste les invitations (optionnellement filtr\u00E9es par organizationId)\r\nrouter.get('/', authMiddleware, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  try {\r\n    const { organizationId } = req.query;\r\n    const requestingUser = req.user;\r\n\r\n    if (!requestingUser) {\r\n        res.status(401).json({ success: false, message: \"Utilisateur non authentifi\u00E9.\" });\r\n        return;\r\n    }\r\n\r\n  const where: Record<string, unknown> = {};\r\n    if (organizationId) {\r\n      where.organizationId = organizationId;\r\n    }\r\n    // Si admin, ne retourne que les invitations de son org\r\n    if (requestingUser.role !== 'super_admin' && requestingUser.organizationId) {\r\n      where.organizationId = requestingUser.organizationId;\r\n    }\r\n    // Invitations PENDING ou DISABLED (pas ACCEPTED ni CANCELLED)\r\n    where.status = { in: ['PENDING', 'DISABLED'] };\r\n    const invitationsRaw = await prisma.invitation.findMany({\r\n      where,\r\n      include: {\r\n        Role: true,\r\n        Organization: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    // Adapter la structure pour le frontend (keys en minuscules comme dans UsersAdminPageNew)\r\n    const invitations = invitationsRaw.map((inv) => ({\r\n      ...inv,\r\n      organization: inv.Organization,\r\n      role: inv.Role,\r\n    }));\r\n\r\n    res.json({ success: true, data: invitations });\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r\u00E9cup\u00E9ration des invitations:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des invitations.' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "interface InvitationEmailPayload {\r\n    to: string;\r\n    token: string;\r\n    isExistingUser: boolean;\r\n    organizationName: string;\r\n    roleName: string;\r\n}\r\n\r\ninterface SendEmailPayload {\r\n    to: string;\r\n    subject: string;\r\n    html: string;\r\n    text?: string;\r\n    replyTo?: string;\r\n}\r\n\r\nclass EmailService {\r\n    /**\r\n     * Envoie un e-mail d'invitation.\r\n     * Simule l'envoi en loggant les d\u00E9tails dans la console.\r\n     */\r\n    async sendInvitationEmail(payload: InvitationEmailPayload): Promise<void> {\r\n        const { to, token, isExistingUser, organizationName, roleName } = payload;\r\n\r\n        const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\r\n        const acceptUrl = `${frontendUrl}/accept-invitation?token=${token}`;\r\n\r\n        let subject = '';\r\n        let body = '';\r\n\r\n        if (isExistingUser) {\r\n            subject = `Vous \u00EAtes invit\u00E9(e) \u00E0 rejoindre ${organizationName}`;\r\n            body = `\r\n                <p>Bonjour,</p>\r\n                <p>Vous avez \u00E9t\u00E9 invit\u00E9(e) \u00E0 rejoindre l'organisation \"${organizationName}\" avec le r\u00F4le \"${roleName}\".</p>\r\n                <p>Comme vous avez d\u00E9j\u00E0 un compte, il vous suffit de cliquer sur le lien ci-dessous pour accepter l'invitation :</p>\r\n                <p><a href=\"${acceptUrl}\">Accepter l'invitation</a></p>\r\n                <p>Si vous n'\u00EAtes pas \u00E0 l'origine de cette demande, vous pouvez ignorer cet e-mail.</p>\r\n            `;\r\n        } else {\r\n            subject = `Invitation \u00E0 rejoindre ${organizationName}`;\r\n            body = `\r\n                <p>Bonjour,</p>\r\n                <p>Vous avez \u00E9t\u00E9 invit\u00E9(e) \u00E0 rejoindre l'organisation \"${organizationName}\" avec le r\u00F4le \"${roleName}\".</p>\r\n                <p>Pour finaliser votre inscription et rejoindre l'\u00E9quipe, veuillez cliquer sur le lien ci-dessous :</p>\r\n                <p><a href=\"${acceptUrl}\">Cr\u00E9er votre compte et accepter l'invitation</a></p>\r\n                <p>Ce lien est valide pendant 7 jours.</p>\r\n            `;\r\n        }\r\n\r\n        console.log('--- SIMULATION D\\'ENVOI D\\'EMAIL ---');\r\n        console.log(`\u00C0: ${to}`);\r\n        console.log(`Sujet: ${subject}`);\r\n        console.log(`URL d'acceptation: ${acceptUrl}`);\r\n        console.log(`Corps (HTML): ${body.replace(/\\s+/g, ' ').trim()}`);\r\n        console.log('------------------------------------');\r\n        \r\n        // En production, vous int\u00E9greriez un vrai service d'envoi ici.\r\n        return Promise.resolve();\r\n    }\r\n\r\n    /**\r\n     * Envoie un e-mail g\u00E9n\u00E9rique (simulation console).\r\n     */\r\n    async sendEmail(payload: SendEmailPayload): Promise<void> {\r\n        const { to, subject, html, text, replyTo } = payload;\r\n\r\n        console.log('--- SIMULATION ENVOI EMAIL (g\u00E9n\u00E9rique) ---');\r\n        console.log(`\u00C0: ${to}`);\r\n        console.log(`Sujet: ${subject}`);\r\n        if (replyTo) {\r\n            console.log(`R\u00E9pondre \u00E0: ${replyTo}`);\r\n        }\r\n        if (text) {\r\n            console.log(`Corps (texte): ${text.replace(/\\s+/g, ' ').trim()}`);\r\n        }\r\n        console.log(`Corps (HTML): ${html.replace(/\\s+/g, ' ').trim()}`);\r\n        console.log('------------------------------------------');\r\n\r\n        return Promise.resolve();\r\n    }\r\n}\r\n\r\nexport const emailService = new EmailService();\r\n", "import { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\nimport { z } from 'zod';\r\nimport rateLimit from 'express-rate-limit';\r\nimport { randomUUID } from 'crypto';\r\n\r\n// \u2705 PLUS BESOIN D'INTERFACE LOCALE - UTILISATION DE L'INTERFACE CENTRALIS\u00C9E\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83E\uDDF9 SANITISATION SIMPLE ET EFFICACE (sans DOMPurify)\r\nconst sanitizeString = (input: string): string => {\r\n  return input.trim().replace(/[<>]/g, ''); // Supprime < et >\r\n};\r\n\r\n// \uD83D\uDD27 UTILITAIRES PERMISSIONS (Factorisation)\r\ninterface AuthUser {\r\n  role: string;\r\n  organizationId?: string;\r\n  userId: string;\r\n}\r\n\r\nconst canAccessOrganization = (user: AuthUser, organizationId: string): boolean => {\r\n  // SuperAdmin peut tout voir\r\n  if (user?.role === 'super_admin') {\r\n    return true;\r\n  }\r\n  // Autres utilisateurs : seulement leur organisation\r\n  return user?.organizationId === organizationId;\r\n};\r\n\r\nconst isSuperAdmin = (user: AuthUser): boolean => {\r\n  return user?.role === 'super_admin';\r\n};\r\n\r\n// \uD83D\uDD27 VALIDATION ID CENTRALIS\u00C9E (Factorisation)\r\n// Accepter UUID, CUID (cuid2 non strict) ou identifiants alphanum\u00E9riques simples (fallback dev)\r\nconst isValidId = (id: string): boolean => {\r\n  if (!id) return false;\r\n  const s = String(id).trim();\r\n  // UUID v4-like\r\n  const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\r\n  // CUID (commen\u00E7ant par c) ou cuid2 plus large\r\n  const cuidRe = /^c[a-z0-9]{7,}$/i;\r\n  // Identifiants alphanum\u00E9riques (s\u00E9curis\u00E9 par sanitization) \u2013 utile en dev/scripts\r\n  const simpleRe = /^[a-zA-Z0-9_-]{8,}$/;\r\n  return uuidRe.test(s) || cuidRe.test(s) || simpleRe.test(s);\r\n};\r\n\r\nconst validateAndSanitizeId = (id: string, fieldName = 'ID'): string => {\r\n  const sanitized = sanitizeString(String(id));\r\n  if (!isValidId(sanitized)) {\r\n    throw new Error(`${fieldName} invalide`);\r\n  }\r\n  return sanitized;\r\n};\r\n\r\n// \uD83D\uDD27 UTILITAIRES GOOGLE WORKSPACE (Factorisation TypeScript stricte)\r\nconst GOOGLE_WORKSPACE_MODULES = ['gmail', 'calendar', 'drive', 'meet', 'docs', 'sheets', 'voice'] as const;\r\ntype GoogleWorkspaceModule = typeof GOOGLE_WORKSPACE_MODULES[number];\r\n\r\ninterface ModuleStatus {\r\n  active: boolean;\r\n  Module?: {\r\n    key?: string;\r\n    [key: string]: unknown;\r\n  };\r\n  [key: string]: unknown;\r\n}\r\n\r\nconst isGoogleWorkspaceModule = (moduleKey: string): moduleKey is GoogleWorkspaceModule => {\r\n  return (GOOGLE_WORKSPACE_MODULES as readonly string[]).includes(moduleKey);\r\n};\r\n\r\nconst getActiveGoogleModules = (moduleStatuses: ModuleStatus[] = []): ModuleStatus[] => {\r\n  return moduleStatuses.filter(oms => \r\n    oms.active && oms.Module?.key && isGoogleWorkspaceModule(oms.Module.key)\r\n  );\r\n};\r\n\r\n// \u2705 FONCTION UTILITAIRE : Compter les modules r\u00E9ellement actifs pour une organisation\r\nasync function countRealActiveModules(organizationId: string): Promise<number> {\r\n  console.log(`[countRealActiveModules] \uD83D\uDD0D D\u00E9but count pour organisation: ${organizationId}`);\r\n  \r\n  // V\u00E9rifier si c'est Google Workspace en regardant GoogleWorkspaceConfig\r\n  const organization = await prisma.organization.findUnique({\r\n    where: { id: organizationId },\r\n    select: { \r\n      GoogleWorkspaceConfig: true, \r\n      name: true \r\n    }\r\n  });\r\n  \r\n  const hasGoogleWorkspace = !!organization?.GoogleWorkspaceConfig;\r\n  console.log(`[countRealActiveModules] \uD83C\uDF10 Organisation ${organization?.name} - Google Workspace: ${hasGoogleWorkspace}`);\r\n  \r\n  // R\u00E9cup\u00E9rer TOUS les modules actifs de la base\r\n  const allActiveModules = await prisma.module.findMany({\r\n    where: {\r\n      active: true\r\n    },\r\n    include: {\r\n      OrganizationModuleStatus: {\r\n        where: {\r\n          organizationId: organizationId\r\n        }\r\n      }\r\n    }\r\n  });\r\n  \r\n  console.log(`[countRealActiveModules] \uD83D\uDCCA Total modules actifs dans Module: ${allActiveModules.length}`);\r\n  \r\n  // Filtrer les modules r\u00E9ellement actifs pour cette organisation\r\n  const activeModulesForOrg = allActiveModules.filter(module => {\r\n    // Si le module a un statut sp\u00E9cifique pour cette organisation\r\n    const moduleStatus = module.OrganizationModuleStatus[0];\r\n    \r\n    // Si c'est un module Google et que Google Workspace n'est pas activ\u00E9\r\n    if (module.key && module.key.toLowerCase().startsWith('google_') && !hasGoogleWorkspace) {\r\n      console.log(`[countRealActiveModules] \uD83D\uDEAB Module Google ${module.key}: Google Workspace d\u00E9sactiv\u00E9 -> EXCLU`);\r\n      return false;\r\n    }\r\n    \r\n    if (moduleStatus) {\r\n      // Utiliser le statut sp\u00E9cifique (peut \u00EAtre actif ou inactif)\r\n      console.log(`[countRealActiveModules] ${moduleStatus.active ? '\u2705' : '\u274C'} Module ${module.key || 'Sans cl\u00E9'} (${module.label || 'Sans nom'}): statut sp\u00E9cifique -> ${moduleStatus.active ? 'ACTIF' : 'INACTIF'}`);\r\n      return moduleStatus.active;\r\n    } else {\r\n      // Pas de statut sp\u00E9cifique = actif par d\u00E9faut\r\n      console.log(`[countRealActiveModules] \u2705 Module ${module.key || 'Sans cl\u00E9'} (${module.label || 'Sans nom'}): pas de statut sp\u00E9cifique -> ACTIF par d\u00E9faut`);\r\n      return true;\r\n    }\r\n  });\r\n  \r\n  const finalCount = activeModulesForOrg.length;\r\n  console.log(`[countRealActiveModules] \uD83C\uDFAF Count final pour ${organization?.name}: ${finalCount}`);\r\n  \r\n  return finalCount;\r\n}\r\n\r\n// \uD83D\uDD27 FONCTION HELPER : V\u00E9rifier si Google Workspace est activ\u00E9\r\nfunction hasGoogleWorkspaceEnabled(\r\n  moduleStatuses: ModuleStatus[] = [],\r\n  googleWorkspaceConfig?: { isActive?: boolean } | null\r\n): boolean {\r\n  // 1. V\u00E9rifier si au moins un module Google Workspace est actif\r\n  const hasActiveModules = getActiveGoogleModules(moduleStatuses).length > 0;\r\n  \r\n  // 2. V\u00E9rifier si une configuration Google Workspace active existe\r\n  const hasActiveConfig = googleWorkspaceConfig?.isActive === true;\r\n  \r\n  // Google Workspace est consid\u00E9r\u00E9 comme activ\u00E9 si :\r\n  // - Il y a des modules actifs OU une configuration active\r\n  return hasActiveModules || hasActiveConfig;\r\n};\r\n\r\n// \uD83D\uDD27 UTILITAIRE DOMAIN GOOGLE WORKSPACE (TODO am\u00E9lior\u00E9)\r\ninterface OrganizationWithFeatures {\r\n  name: string;\r\n  features?: string[];\r\n}\r\n\r\nconst extractGoogleWorkspaceDomain = (organization: OrganizationWithFeatures): string | null => {\r\n  // TODO: \u00C0 terme, r\u00E9cup\u00E9rer depuis un champ d\u00E9di\u00E9 googleWorkspaceDomain\r\n  // Pour l'instant, logique de fallback basique\r\n  if (organization.features?.includes('google_workspace')) {\r\n    return `${organization.name.toLowerCase().replace(/\\s+/g, '')}.com`;\r\n  }\r\n  return null;\r\n};\r\n\r\n// \uD83E\uDDF9 SUPPRESSION PROFONDE DES DONN\u00C9ES LI\u00C9ES \u00C0 UNE ORGANISATION AVANT LA SUPPRESSION\r\nconst cleanupOrganizationData = async (tx: Prisma.TransactionClient, organizationId: string): Promise<void> => {\r\n  const runDelete = async (label: string, action: () => Promise<unknown>) => {\r\n    try {\r\n      console.log(`[ORGANIZATIONS] \uD83D\uDDD1\uFE0F Suppression ${label} pour ${organizationId}`);\r\n      await action();\r\n    } catch (error) {\r\n      console.error(`[ORGANIZATIONS] \u274C \u00C9chec suppression ${label} pour ${organizationId}`, error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  await runDelete('CalendarParticipant', () => tx.calendarParticipant.deleteMany({\r\n    where: {\r\n      CalendarEvent: {\r\n        organizationId\r\n      }\r\n    }\r\n  }));\r\n\r\n  await runDelete('FormSubmission', () => tx.formSubmission.deleteMany({\r\n    where: {\r\n      Block: {\r\n        organizationId\r\n      }\r\n    }\r\n  }));\r\n\r\n  await runDelete('AIRecommendation', () => tx.aIRecommendation.deleteMany({ where: { organizationId } }));\r\n  await runDelete('AdCampaign', () => tx.adCampaign.deleteMany({ where: { organizationId } }));\r\n  await runDelete('AdPlatformIntegration', () => tx.adPlatformIntegration.deleteMany({ where: { organizationId } }));\r\n  await runDelete('AnalyticsEvent', () => tx.analyticsEvent.deleteMany({ where: { organizationId } }));\r\n  await runDelete('AutomationRule', () => tx.automationRule.deleteMany({ where: { organizationId } }));\r\n  await runDelete('AiUsageLog', () => tx.aiUsageLog.deleteMany({ where: { organizationId } }));\r\n  await runDelete('CallToLeadMapping', () => tx.callToLeadMapping.deleteMany({ where: { organizationId } }));\r\n  await runDelete('CallStatus', () => tx.callStatus.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Category', () => tx.category.deleteMany({ where: { organizationId } }));\r\n  await runDelete('GoogleMailWatch', () => tx.googleMailWatch.deleteMany({ where: { organizationId } }));\r\n  await runDelete('GoogleToken', () => tx.googleToken.deleteMany({ where: { organizationId } }));\r\n  await runDelete('GoogleVoiceCall', () => tx.googleVoiceCall.deleteMany({ where: { organizationId } }));\r\n  await runDelete('GoogleVoiceConfig', () => tx.googleVoiceConfig.deleteMany({ where: { organizationId } }));\r\n  await runDelete('GoogleVoiceSMS', () => tx.googleVoiceSMS.deleteMany({ where: { organizationId } }));\r\n  await runDelete('GoogleWorkspaceConfig', () => tx.googleWorkspaceConfig.deleteMany({ where: { organizationId } }));\r\n  await runDelete('IntegrationsSettings', () => tx.integrationsSettings.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Invitation', () => tx.invitation.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Lead', () => tx.lead.deleteMany({ where: { organizationId } }));\r\n  await runDelete('LeadSource', () => tx.leadSource.deleteMany({ where: { organizationId } }));\r\n  await runDelete('LeadStatus', () => tx.leadStatus.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Module', () => tx.module.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Notification', () => tx.notification.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Order', () => tx.order.deleteMany({ where: { organizationId } }));\r\n  await runDelete('OrganizationModuleStatus', () => tx.organizationModuleStatus.deleteMany({ where: { organizationId } }));\r\n  await runDelete('OrganizationRoleStatus', () => tx.organizationRoleStatus.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Permission', () => tx.permission.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Product', () => tx.product.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Role', () => tx.role.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TechnicalData', () => tx.technicalData.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TelnyxCall', () => tx.telnyxCall.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TelnyxConnection', () => tx.telnyxConnection.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TelnyxMessage', () => tx.telnyxMessage.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TelnyxPhoneNumber', () => tx.telnyxPhoneNumber.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TelnyxUserConfig', () => tx.telnyxUserConfig.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TimelineEvent', () => tx.timelineEvent.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TreeBranchLeafNodeCondition', () => tx.treeBranchLeafNodeCondition.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TreeBranchLeafNodeFormula', () => tx.treeBranchLeafNodeFormula.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TreeBranchLeafNodeTable', () => tx.treeBranchLeafNodeTable.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TreeBranchLeafMarker', () => tx.treeBranchLeafMarker.deleteMany({ where: { organizationId } }));\r\n  await runDelete('TreeBranchLeafTree', () => tx.treeBranchLeafTree.deleteMany({ where: { organizationId } }));\r\n  await runDelete('EcommerceIntegration', () => tx.ecommerceIntegration.deleteMany({ where: { organizationId } }));\r\n  await runDelete('EmailAccount', () => tx.emailAccount.deleteMany({ where: { organizationId } }));\r\n  await runDelete('EmailDomain', () => tx.emailDomain.deleteMany({ where: { organizationId } }));\r\n  await runDelete('EmailTemplate', () => tx.emailTemplate.deleteMany({ where: { organizationId } }));\r\n  await runDelete('CalendarEvent', () => tx.calendarEvent.deleteMany({ where: { organizationId } }));\r\n  await runDelete('Block', () => tx.block.deleteMany({ where: { organizationId } }));\r\n  await runDelete('UserOrganization', () => tx.userOrganization.deleteMany({ where: { organizationId } }));\r\n};\r\n\r\n// \uD83D\uDD12 VALIDATION ZOD ULTRA-STRICTE\r\nconst organizationCreateSchema = z.object({\r\n  name: z.string()\r\n    .min(2, 'Nom organisation minimum 2 caract\u00E8res')\r\n    .max(100, 'Nom organisation maximum 100 caract\u00E8res')\r\n    .regex(/^[a-zA-Z0-9\\s\\-_]+$/, 'Nom organisation contient des caract\u00E8res non autoris\u00E9s'),\r\n  description: z.string()\r\n    .max(500, 'Description maximum 500 caract\u00E8res')\r\n    .optional(),\r\n  status: z.enum(['ACTIVE', 'INACTIVE'], {\r\n    errorMap: () => ({ message: 'Statut doit \u00EAtre ACTIVE ou INACTIVE' })\r\n  }).optional(),\r\n  // \uD83D\uDCDE NOUVEAUX CHAMPS DE CONTACT\r\n  website: z.string()\r\n    .url('Site web doit \u00EAtre une URL valide')\r\n    .max(255, 'Site web maximum 255 caract\u00E8res')\r\n    .optional(),\r\n  phone: z.string()\r\n    .max(20, 'T\u00E9l\u00E9phone maximum 20 caract\u00E8res')\r\n    .regex(/^[\\d\\s\\-+().]+$/, 'Num\u00E9ro de t\u00E9l\u00E9phone contient des caract\u00E8res non autoris\u00E9s')\r\n    .optional(),\r\n  address: z.string()\r\n    .max(500, 'Adresse maximum 500 caract\u00E8res')\r\n    .optional(),\r\n  // \uD83C\uDF1F GOOGLE WORKSPACE CONFIGURATION\r\n  googleWorkspace: z.object({\r\n    enabled: z.boolean().default(false),\r\n    domain: z.string().optional(),\r\n    adminEmail: z.string().email().optional(),\r\n    modules: z.object({\r\n      gmail: z.boolean().default(false),\r\n      calendar: z.boolean().default(false),\r\n      drive: z.boolean().default(false),\r\n      meet: z.boolean().default(false),\r\n      docs: z.boolean().default(false),\r\n      sheets: z.boolean().default(false),\r\n      voice: z.boolean().default(false)\r\n    }).optional()\r\n  }).optional()\r\n});\r\n\r\nconst organizationUpdateSchema = z.object({\r\n  name: z.string()\r\n    .min(2, 'Nom organisation minimum 2 caract\u00E8res')\r\n    .max(100, 'Nom organisation maximum 100 caract\u00E8res')\r\n    .regex(/^[a-zA-Z0-9\\s\\-_]+$/, 'Nom organisation contient des caract\u00E8res non autoris\u00E9s')\r\n    .optional(),\r\n  description: z.string()\r\n    .max(500, 'Description maximum 500 caract\u00E8res')\r\n    .nullish(),\r\n  status: z.enum(['ACTIVE', 'INACTIVE'], {\r\n    errorMap: () => ({ message: 'Statut doit \u00EAtre ACTIVE ou INACTIVE' })\r\n  }).optional(),\r\n  // \uD83D\uDCDE NOUVEAUX CHAMPS DE CONTACT\r\n  website: z.string()\r\n    .url('Site web doit \u00EAtre une URL valide')\r\n    .max(255, 'Site web maximum 255 caract\u00E8res')\r\n    .nullish(),\r\n  phone: z.string()\r\n    .max(20, 'T\u00E9l\u00E9phone maximum 20 caract\u00E8res')\r\n    .regex(/^[\\d\\s\\-+().]+$/, 'Num\u00E9ro de t\u00E9l\u00E9phone contient des caract\u00E8res non autoris\u00E9s')\r\n    .nullish(),\r\n  address: z.string()\r\n    .max(500, 'Adresse maximum 500 caract\u00E8res')\r\n    .nullish(),\r\n  googleWorkspace: z.object({\r\n    enabled: z.boolean().optional(),\r\n    domain: z.string().optional(),\r\n    adminEmail: z.string().email().optional(),\r\n    modules: z.object({\r\n      gmail: z.boolean().optional(),\r\n      calendar: z.boolean().optional(),\r\n      drive: z.boolean().optional(),\r\n      meet: z.boolean().optional(),\r\n      docs: z.boolean().optional(),\r\n      sheets: z.boolean().optional(),\r\n      voice: z.boolean().optional()\r\n    }).optional()\r\n  }).optional()\r\n});\r\n\r\n// \uD83D\uDE80 RATE LIMITING ADAPTATIF (Plus strict que Users/Roles car fonctionnalit\u00E9s sensibles)\r\nconst organizationsRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 300, // 300 requ\u00EAtes par minute (tr\u00E8s strict)\r\n  skipSuccessfulRequests: false,\r\n  skipFailedRequests: false,\r\n  handler: (_req, res) => {\r\n    console.log('\uD83D\uDEA8 [ORGANIZATIONS] Rate limit d\u00E9pass\u00E9');\r\n    res.status(429).json({\r\n      success: false,\r\n      message: 'Trop de requ\u00EAtes. Veuillez attendre.'\r\n    });\r\n  }\r\n});\r\n\r\nconst organizationsCreateRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 20, // 20 cr\u00E9ations par minute max\r\n  skipSuccessfulRequests: false,\r\n  skipFailedRequests: false,\r\n  handler: (_req, res) => {\r\n    res.status(429).json({\r\n      success: false,\r\n      message: 'Limite de cr\u00E9ation atteinte. Attendez 1 minute.'\r\n    });\r\n  }\r\n});\r\n\r\nconst organizationsDeleteRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 10, // 10 suppressions par minute max\r\n  skipSuccessfulRequests: false,\r\n  skipFailedRequests: false,\r\n  handler: (_req, res) => {\r\n    res.status(429).json({\r\n      success: false,\r\n      message: 'Limite de suppression atteinte. Attendez 1 minute.'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDEE1\uFE0F GESTION D'ERREURS ZOD CENTRALIS\u00C9E\r\nconst handleZodError = (error: z.ZodError) => {\r\n  return {\r\n    success: false,\r\n    message: 'Donn\u00E9es invalides',\r\n    errors: error.errors.map(e => `${e.path.join('.')}: ${e.message}`)\r\n  };\r\n};\r\n\r\n// Appliquer l'authentification et rate limiting\r\nrouter.use(authMiddleware);\r\nrouter.use(organizationsRateLimit);\r\n\r\n// \uD83D\uDFE2 GET /api/organizations/active - SEULEMENT LES ORGANISATIONS ACTIVES\r\nrouter.get('/active', async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] GET /organizations/active - R\u00E9cup\u00E9ration organisations ACTIVES uniquement');\r\n  \r\n  try {\r\n    const requestingUser = req.user;\r\n    const { search, userId } = req.query;\r\n    \r\n    console.log(`[ORGANIZATIONS] User role: ${requestingUser?.role}`);\r\n    console.log(`[ORGANIZATIONS] Query params:`, { search, userId });\r\n    \r\n    // \uD83D\uDD0D VALIDATION QUERY PARAMS avec FILTRE ACTIF OBLIGATOIRE\r\n    const where: Record<string, unknown> = {\r\n      status: { in: ['ACTIVE', 'active'] } // \u2705 Accepter variantes de statut\r\n    };\r\n    \r\n    if (search && typeof search === 'string') {\r\n      const sanitizedSearch = sanitizeString(search);\r\n      where.name = {\r\n        contains: sanitizedSearch,\r\n        mode: 'insensitive'\r\n      };\r\n    }\r\n    \r\n    if (userId && typeof userId === 'string') {\r\n      const userOrgs = await prisma.userOrganization.findMany({\r\n        where: { userId: sanitizeString(userId) },\r\n        select: { organizationId: true }\r\n      });\r\n      const orgIds = userOrgs.map(uo => uo.organizationId);\r\n      \r\n      if (orgIds.length === 0) {\r\n        return res.json({ success: true, data: [] });\r\n      }\r\n      \r\n      where.id = { in: orgIds };\r\n    }\r\n    \r\n    // \u2705 PERMISSIONS : Tous les utilisateurs authentifi\u00E9s peuvent voir les orgs actives\r\n    if (isSuperAdmin(requestingUser)) {\r\n      // Super admin voit toutes les organisations actives\r\n      console.log('[ORGANIZATIONS] Super admin - acc\u00E8s aux organisations actives');\r\n    } else if (requestingUser?.role === 'admin' && requestingUser.organizationId) {\r\n      // Admin voit seulement son organisation SI elle est active\r\n      where.id = requestingUser.organizationId;\r\n      console.log('[ORGANIZATIONS] Admin - acc\u00E8s \u00E0 son organisation uniquement si active');\r\n    } else if (requestingUser?.organizationId) {\r\n      // Utilisateur normal voit seulement son organisation SI elle est active\r\n      where.id = requestingUser.organizationId;\r\n      console.log('[ORGANIZATIONS] Utilisateur - acc\u00E8s \u00E0 son organisation uniquement si active');\r\n    } else {\r\n      console.log('[ORGANIZATIONS] Acc\u00E8s refus\u00E9 - pas d\\'organisation assign\u00E9e');\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9'\r\n      });\r\n    }\r\n    \r\n    const organizations = await prisma.organization.findMany({\r\n      where,\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            UserOrganization: true,\r\n            Role: true\r\n          }\r\n        },\r\n        OrganizationModuleStatus: {\r\n          include: {\r\n            Module: true\r\n          }\r\n        },\r\n        Role: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            isGlobal: true\r\n          }\r\n        },\r\n        GoogleWorkspaceConfig: { // \u2705 NOUVEAU : Inclure la configuration Google Workspace\r\n          select: {\r\n            id: true,\r\n            isActive: true,\r\n            domain: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        name: 'asc'\r\n      }\r\n    });\r\n    \r\n    // \uD83C\uDF1F ENRICHISSEMENT AVEC STATISTIQUES COMPL\u00C8TES\r\n    const enrichedOrganizations = await Promise.all(organizations.map(async org => {\r\n      const activeGoogleModules = getActiveGoogleModules(org.OrganizationModuleStatus);\r\n      const realActiveModulesCount = await countRealActiveModules(org.id);\r\n      \r\n      return {\r\n        ...org,\r\n        stats: {\r\n          totalUsers: org._count?.UserOrganization ?? 0,\r\n          totalRoles: org._count?.Role ?? 0,\r\n          activeModules: realActiveModulesCount, // \u2705 DYNAMIQUE : Comptage r\u00E9el en temps r\u00E9el\r\n          googleWorkspaceEnabled: hasGoogleWorkspaceEnabled(org.OrganizationModuleStatus, org.GoogleWorkspaceConfig)\r\n        },\r\n        googleWorkspaceDomain: org.GoogleWorkspaceConfig?.domain || extractGoogleWorkspaceDomain(org),\r\n        googleWorkspaceModules: activeGoogleModules.map(oms => oms.Module).filter(Boolean)\r\n      };\r\n    }));\r\n    \r\n    console.log(`[ORGANIZATIONS] ${enrichedOrganizations.length} organisations ACTIVES trouv\u00E9es`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: enrichedOrganizations\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur GET /active:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des organisations actives'\r\n    });\r\n  }\r\n});\r\n\r\n// \uFFFD\uD83C\uDFF7\uFE0F GET /api/organizations - S\u00C9CURIS\u00C9 AVEC ZOD + SANITISATION (TOUTES LES ORGS POUR ADMIN)\r\nrouter.get('/', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] GET /organizations - R\u00E9cup\u00E9ration organisations S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    const requestingUser = req.user;\r\n    const { search, userId } = req.query;\r\n    \r\n    console.log(`[ORGANIZATIONS] User role: ${requestingUser?.role}`);\r\n    console.log(`[ORGANIZATIONS] Query params:`, { search, userId });\r\n    \r\n    // \uD83D\uDD0D VALIDATION QUERY PARAMS (optionnelle mais recommand\u00E9e)  \r\n    const where: Record<string, unknown> = {};\r\n    \r\n    if (search && typeof search === 'string') {\r\n      const sanitizedSearch = sanitizeString(search);\r\n      where.name = {\r\n        contains: sanitizedSearch,\r\n        mode: 'insensitive'\r\n      };\r\n    }\r\n    \r\n    if (userId && typeof userId === 'string') {\r\n      const userOrgs = await prisma.userOrganization.findMany({\r\n        where: { userId: sanitizeString(userId) },\r\n        select: { organizationId: true }\r\n      });\r\n      const orgIds = userOrgs.map(uo => uo.organizationId);\r\n      \r\n      if (orgIds.length === 0) {\r\n        return res.json({ success: true, data: [] });\r\n      }\r\n      \r\n      where.id = { in: orgIds };\r\n    }\r\n    \r\n    // \u2705 LOGIQUE PERMISSIONS STRICTE\r\n    if (isSuperAdmin(requestingUser)) {\r\n      // Super admin voit tout\r\n      console.log('[ORGANIZATIONS] Super admin - acc\u00E8s complet');\r\n    } else if (requestingUser?.role === 'admin' && requestingUser.organizationId) {\r\n      // Admin voit seulement son organisation\r\n      where.id = requestingUser.organizationId;\r\n      console.log('[ORGANIZATIONS] Admin - acc\u00E8s \u00E0 son organisation uniquement');\r\n    } else {\r\n      console.log('[ORGANIZATIONS] Acc\u00E8s refus\u00E9 - r\u00F4le insuffisant');\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9'\r\n      });\r\n    }\r\n    \r\n    const organizations = await prisma.organization.findMany({\r\n      where,\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            UserOrganization: true,\r\n            Role: true // \u2705 AJOUT : Compter les r\u00F4les\r\n          }\r\n        },\r\n        OrganizationModuleStatus: {\r\n          include: {\r\n            Module: true\r\n          }\r\n        },\r\n        Role: { // \u2705 AJOUT : Inclure les r\u00F4les pour statistiques d\u00E9taill\u00E9es\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            isGlobal: true\r\n          }\r\n        },\r\n        GoogleWorkspaceConfig: { // \u2705 NOUVEAU : Inclure la configuration Google Workspace\r\n          select: {\r\n            id: true,\r\n            isActive: true,\r\n            domain: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        name: 'asc'\r\n      }\r\n    });\r\n    \r\n    // \uD83C\uDF1F ENRICHISSEMENT AVEC STATISTIQUES COMPL\u00C8TES (Factoris\u00E9)\r\n    const enrichedOrganizations = await Promise.all(organizations.map(async org => {\r\n      const activeGoogleModules = getActiveGoogleModules(org.OrganizationModuleStatus);\r\n      \r\n      // \uD83D\uDE80 COMPTAGE DYNAMIQUE R\u00C9EL avec fonction utilitaire\r\n      const realActiveModulesCount = await countRealActiveModules(org.id);\r\n      \r\n      console.log(`[DEBUG] Organisation ${org.name}: ${realActiveModulesCount} modules r\u00E9ellement actifs`);\r\n      \r\n      return {\r\n        ...org,\r\n        stats: {\r\n          totalUsers: org._count?.UserOrganization ?? 0,\r\n          totalRoles: org._count?.Role ?? 0, // \u2705 CORRIG\u00C9 : Nombre r\u00E9el de r\u00F4les\r\n          activeModules: realActiveModulesCount, // \u2705 DYNAMIQUE : Comptage r\u00E9el en temps r\u00E9el\r\n          googleWorkspaceEnabled: hasGoogleWorkspaceEnabled(org.OrganizationModuleStatus, org.GoogleWorkspaceConfig)\r\n        },\r\n        googleWorkspaceDomain: org.GoogleWorkspaceConfig?.domain || extractGoogleWorkspaceDomain(org), // \u2705 AM\u00C9LIOR\u00C9 : Utiliser le vrai domaine de la config\r\n        googleWorkspaceModules: activeGoogleModules.map(oms => oms.Module).filter(Boolean)\r\n      };\r\n    }));\r\n    \r\n    console.log(`[ORGANIZATIONS] ${enrichedOrganizations.length} organisations trouv\u00E9es`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: enrichedOrganizations\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur GET:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des organisations'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F POST /api/organizations - S\u00C9CURIS\u00C9 AVEC ZOD + SANITISATION + RATE LIMITING\r\nrouter.post('/', organizationsCreateRateLimit, requireRole(['super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] POST /organizations - Cr\u00E9ation organisation S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    // \uD83D\uDD0D VALIDATION ZOD ULTRA-STRICTE\r\n    const validation = organizationCreateSchema.safeParse(req.body);\r\n    if (!validation.success) {\r\n      console.log('[ORGANIZATIONS] Validation \u00E9chou\u00E9e:', validation.error);\r\n      return res.status(400).json(handleZodError(validation.error));\r\n    }\r\n    \r\n    const data = validation.data;\r\n    \r\n    // \uD83E\uDDF9 SANITISATION SUPPL\u00C9MENTAIRE\r\n    const sanitizedData = {\r\n      name: sanitizeString(data.name),\r\n      description: data.description ? sanitizeString(data.description) : null,\r\n      status: (data.status || 'ACTIVE').toUpperCase(),\r\n      // \uD83D\uDCDE NOUVEAUX CHAMPS DE CONTACT\r\n      website: data.website ? sanitizeString(data.website) : null,\r\n      phone: data.phone ? sanitizeString(data.phone) : null,\r\n      address: data.address ? sanitizeString(data.address) : null\r\n    };\r\n\r\n    console.log('[ORGANIZATIONS] Donn\u00E9es sanitis\u00E9es:', sanitizedData);\r\n    \r\n    // \u2705 V\u00C9RIFICATION UNICIT\u00C9\r\n    const existingOrg = await prisma.organization.findFirst({\r\n      where: {\r\n        name: {\r\n          equals: sanitizedData.name,\r\n          mode: 'insensitive'\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (existingOrg) {\r\n      return res.status(409).json({\r\n        success: false,\r\n        message: 'Une organisation avec ce nom existe d\u00E9j\u00E0'\r\n      });\r\n    }\r\n    \r\n    // \uD83D\uDD04 TRANSACTION S\u00C9CURIS\u00C9E\r\n    const now = new Date();\r\n    const generatedId = randomUUID();\r\n\r\n    const newOrganization = await prisma.$transaction(async (tx) => {\r\n      const org = await tx.organization.create({\r\n        data: {\r\n          id: generatedId,\r\n          name: sanitizedData.name,\r\n          description: sanitizedData.description,\r\n          status: sanitizedData.status,\r\n          website: sanitizedData.website,\r\n          phone: sanitizedData.phone,\r\n          address: sanitizedData.address,\r\n          createdAt: now,\r\n          updatedAt: now\r\n        }\r\n      });\r\n      \r\n      // \uD83C\uDF1F CONFIGURATION GOOGLE WORKSPACE SI ACTIV\u00C9E\r\n      if (data.googleWorkspace?.enabled) {\r\n        console.log('[ORGANIZATIONS] Configuration Google Workspace activ\u00E9e');\r\n        // Ici on pourrait ajouter la logique pour cr\u00E9er la configuration Google Workspace\r\n        // pour l'instant on log juste\r\n      }\r\n      \r\n      return org;\r\n    });\r\n    \r\n    console.log('[ORGANIZATIONS] Organisation cr\u00E9\u00E9e avec succ\u00E8s:', newOrganization.id);\r\n    \r\n    res.status(201).json({\r\n      success: true,\r\n      message: 'Organisation cr\u00E9\u00E9e avec succ\u00E8s',\r\n      data: newOrganization\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur POST:', error);\r\n    \r\n    if (error instanceof z.ZodError) {\r\n      return res.status(400).json(handleZodError(error));\r\n    }\r\n    \r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la cr\u00E9ation de l\\'organisation'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F GET /api/organizations/:id - S\u00C9CURIS\u00C9 AVEC ZOD + SANITISATION\r\nrouter.get('/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] GET /organizations/:id - R\u00E9cup\u00E9ration organisation S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // \uD83E\uDDF9 VALIDATION + SANITISATION ID (Factoris\u00E9)\r\n    const sanitizedId = validateAndSanitizeId(id, 'ID organisation');\r\n    \r\n    console.log(`[ORGANIZATIONS] R\u00E9cup\u00E9ration organisation ${sanitizedId}`);\r\n    \r\n    // \u2705 V\u00C9RIFICATION PERMISSIONS\r\n    if (!canAccessOrganization(requestingUser, sanitizedId)) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cette organisation'\r\n      });\r\n    }\r\n    \r\n    const organization = await prisma.organization.findUnique({\r\n      where: { id: sanitizedId },\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            User: {\r\n              select: {\r\n                id: true,\r\n                email: true,\r\n                firstName: true,\r\n                lastName: true\r\n              }\r\n            },\r\n            Role: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                label: true\r\n              }\r\n            }\r\n          }\r\n        },\r\n        OrganizationModuleStatus: {\r\n          include: {\r\n            Module: true\r\n          }\r\n        },\r\n        _count: {\r\n          select: {\r\n            UserOrganization: true,\r\n            Role: true // \u2705 AJOUT : Compter les r\u00F4les pour organisation individuelle\r\n          }\r\n        },\r\n        Role: { // \u2705 AJOUT : Inclure les r\u00F4les de l'organisation\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            label: true,\r\n            isGlobal: true\r\n          }\r\n        },\r\n        GoogleWorkspaceConfig: { // \u2705 NOUVEAU : Inclure la configuration Google Workspace\r\n          select: {\r\n            id: true,\r\n            isActive: true,\r\n            domain: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!organization) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Organisation non trouv\u00E9e'\r\n      });\r\n    }\r\n    \r\n    // \uD83C\uDF1F ENRICHISSEMENT AVEC STATISTIQUES COMPL\u00C8TES (Factoris\u00E9)\r\n    const activeGoogleModules = getActiveGoogleModules(organization.OrganizationModuleStatus);\r\n    const realActiveModulesCount = await countRealActiveModules(organization.id);\r\n    \r\n    console.log(`[DEBUG] Organisation individuelle ${organization.name}: ${realActiveModulesCount} modules r\u00E9ellement actifs`);\r\n    \r\n    const enrichedOrganization = {\r\n      ...organization,\r\n      stats: {\r\n        totalUsers: organization._count?.UserOrganization ?? 0,\r\n        totalRoles: organization._count?.Role ?? 0, // \u2705 CORRIG\u00C9 : Utilise le count direct des r\u00F4les\r\n        activeModules: realActiveModulesCount, // \u2705 DYNAMIQUE : Comptage r\u00E9el en temps r\u00E9el\r\n        googleWorkspaceEnabled: hasGoogleWorkspaceEnabled(organization.OrganizationModuleStatus, organization.GoogleWorkspaceConfig)\r\n      },\r\n      googleWorkspaceDomain: organization.GoogleWorkspaceConfig?.domain || extractGoogleWorkspaceDomain(organization), // \u2705 AM\u00C9LIOR\u00C9 : Utiliser le vrai domaine de la config\r\n      googleWorkspaceModules: activeGoogleModules.map(oms => oms.Module).filter(Boolean)\r\n    };\r\n    \r\n    console.log('[ORGANIZATIONS] Organisation r\u00E9cup\u00E9r\u00E9e avec succ\u00E8s');\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: enrichedOrganization\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur GET /:id:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration de l\\'organisation'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F PUT /api/organizations/:id - S\u00C9CURIS\u00C9 AVEC ZOD + SANITISATION + RATE LIMITING\r\nrouter.put('/:id', requireRole(['super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] PUT /organizations/:id - Mise \u00E0 jour organisation S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    console.log('\uD83D\uDD0D [ORGANIZATIONS] ID re\u00E7u:', id);\r\n    console.log('\uD83D\uDD0D [ORGANIZATIONS] Body re\u00E7u:', JSON.stringify(req.body, null, 2));\r\n    \r\n    const sanitizedId = validateAndSanitizeId(id, 'ID organisation');\r\n    \r\n    // \uD83D\uDD0D VALIDATION ZOD\r\n    const validation = organizationUpdateSchema.safeParse(req.body);\r\n    if (!validation.success) {\r\n      console.error('\u274C [ORGANIZATIONS] Erreur validation Zod:', validation.error.errors);\r\n      return res.status(400).json(handleZodError(validation.error));\r\n    }\r\n    \r\n    console.log('\u2705 [ORGANIZATIONS] Validation Zod r\u00E9ussie');\r\n    const data = validation.data;\r\n    \r\n    // \uD83E\uDDF9 SANITISATION\r\n    const updateData: {\r\n      name?: string;\r\n      description?: string | null;\r\n      status?: string;\r\n      website?: string | null;\r\n      phone?: string | null;\r\n      address?: string | null;\r\n    } = {};\r\n    if (data.name) updateData.name = sanitizeString(data.name);\r\n    if (data.description !== undefined) {\r\n      updateData.description = data.description ? sanitizeString(data.description) : null;\r\n    }\r\n    if (data.status) updateData.status = data.status;\r\n    \r\n    // \uD83D\uDCDE NOUVEAUX CHAMPS DE CONTACT\r\n    if (data.website !== undefined) {\r\n      updateData.website = data.website ? sanitizeString(data.website) : null;\r\n    }\r\n    if (data.phone !== undefined) {\r\n      updateData.phone = data.phone ? sanitizeString(data.phone) : null;\r\n    }\r\n    if (data.address !== undefined) {\r\n      updateData.address = data.address ? sanitizeString(data.address) : null;\r\n    }\r\n    \r\n    console.log('[ORGANIZATIONS] Donn\u00E9es de mise \u00E0 jour sanitis\u00E9es:', updateData);\r\n    \r\n    // \u2705 V\u00C9RIFICATION EXISTENCE\r\n    const existingOrg = await prisma.organization.findUnique({\r\n      where: { id: sanitizedId }\r\n    });\r\n    \r\n    if (!existingOrg) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Organisation non trouv\u00E9e'\r\n      });\r\n    }\r\n    \r\n    // \u2705 V\u00C9RIFICATION UNICIT\u00C9 DU NOM (si chang\u00E9)\r\n    if (updateData.name && updateData.name !== existingOrg.name) {\r\n      const duplicateOrg = await prisma.organization.findFirst({\r\n        where: {\r\n          name: {\r\n            equals: updateData.name,\r\n            mode: 'insensitive'\r\n          },\r\n          id: { not: sanitizedId }\r\n        }\r\n      });\r\n      \r\n      if (duplicateOrg) {\r\n        return res.status(409).json({\r\n          success: false,\r\n          message: 'Une autre organisation avec ce nom existe d\u00E9j\u00E0'\r\n        });\r\n      }\r\n    }\r\n    \r\n    // \uD83D\uDD04 TRANSACTION S\u00C9CURIS\u00C9E\r\n    const updatedOrganization = await prisma.$transaction(async (tx) => {\r\n      const updated = await tx.organization.update({\r\n        where: { id: sanitizedId },\r\n        data: updateData\r\n      });\r\n      \r\n      // \uD83C\uDF1F MISE \u00C0 JOUR GOOGLE WORKSPACE SI N\u00C9CESSAIRE\r\n      if (data.googleWorkspace) {\r\n        console.log('[ORGANIZATIONS] Mise \u00E0 jour Google Workspace:', data.googleWorkspace);\r\n        \r\n        // R\u00E9cup\u00E9rer ou cr\u00E9er la configuration Google Workspace\r\n        const existingConfig = await tx.googleWorkspaceConfig.findUnique({\r\n          where: { organizationId: sanitizedId }\r\n        });\r\n        \r\n        const googleWorkspaceData: {\r\n          gmailEnabled?: boolean;\r\n          calendarEnabled?: boolean;\r\n          driveEnabled?: boolean;\r\n          meetEnabled?: boolean;\r\n          docsEnabled?: boolean;\r\n          sheetsEnabled?: boolean;\r\n          voiceEnabled?: boolean;\r\n          enabled?: boolean;\r\n          domain?: string;\r\n          adminEmail?: string;\r\n        } = {};\r\n        \r\n        // Gestion des modules Google Workspace\r\n        if (data.googleWorkspace.modules) {\r\n          const modules = data.googleWorkspace.modules;\r\n          if (modules.gmail !== undefined) googleWorkspaceData.gmailEnabled = modules.gmail;\r\n          if (modules.calendar !== undefined) googleWorkspaceData.calendarEnabled = modules.calendar;\r\n          if (modules.drive !== undefined) googleWorkspaceData.driveEnabled = modules.drive;\r\n          if (modules.meet !== undefined) googleWorkspaceData.meetEnabled = modules.meet;\r\n          if (modules.docs !== undefined) googleWorkspaceData.docsEnabled = modules.docs;\r\n          if (modules.sheets !== undefined) googleWorkspaceData.sheetsEnabled = modules.sheets;\r\n          if (modules.voice !== undefined) googleWorkspaceData.voiceEnabled = modules.voice;\r\n        }\r\n        \r\n        // Gestion de l'activation/d\u00E9sactivation\r\n        if (data.googleWorkspace.enabled !== undefined) {\r\n          googleWorkspaceData.enabled = data.googleWorkspace.enabled;\r\n        }\r\n        \r\n        // Gestion du domaine et email admin\r\n        if (data.googleWorkspace.domain) {\r\n          googleWorkspaceData.domain = sanitizeString(data.googleWorkspace.domain);\r\n        }\r\n        if (data.googleWorkspace.adminEmail) {\r\n          googleWorkspaceData.adminEmail = sanitizeString(data.googleWorkspace.adminEmail);\r\n        }\r\n        \r\n        // Mettre \u00E0 jour ou cr\u00E9er la configuration\r\n        if (existingConfig) {\r\n          await tx.googleWorkspaceConfig.update({\r\n            where: { organizationId: sanitizedId },\r\n            data: googleWorkspaceData\r\n          });\r\n        } else {\r\n          await tx.googleWorkspaceConfig.create({\r\n            data: {\r\n              organizationId: sanitizedId,\r\n              enabled: data.googleWorkspace.enabled || false,\r\n              ...googleWorkspaceData\r\n            }\r\n          });\r\n        }\r\n      }\r\n      \r\n      return updated;\r\n    });\r\n    \r\n    console.log('[ORGANIZATIONS] Organisation mise \u00E0 jour avec succ\u00E8s');\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Organisation mise \u00E0 jour avec succ\u00E8s',\r\n      data: updatedOrganization\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur PUT:', error);\r\n    \r\n    if (error instanceof z.ZodError) {\r\n      return res.status(400).json(handleZodError(error));\r\n    }\r\n    \r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la mise \u00E0 jour de l\\'organisation'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F DELETE /api/organizations/:id - S\u00C9CURIS\u00C9 + RATE LIMITING\r\nrouter.delete('/:id', organizationsDeleteRateLimit, requireRole(['super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] DELETE /organizations/:id - Suppression organisation S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const sanitizedId = validateAndSanitizeId(id, 'ID organisation');\r\n    \r\n    console.log(`[ORGANIZATIONS] Tentative suppression organisation ${sanitizedId}`);\r\n    \r\n    // \u2705 V\u00C9RIFICATION EXISTENCE\r\n    const existingOrg = await prisma.organization.findUnique({\r\n      where: { id: sanitizedId },\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            UserOrganization: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!existingOrg) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Organisation non trouv\u00E9e'\r\n      });\r\n    }\r\n    \r\n    // \u2705 V\u00C9RIFICATION S\u00C9CURIT\u00C9 - Emp\u00EAcher suppression si utilisateurs\r\n    if (existingOrg._count.UserOrganization > 0) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Impossible de supprimer une organisation ayant des utilisateurs'\r\n      });\r\n    }\r\n    \r\n    // \uD83D\uDD04 TRANSACTION S\u00C9CURIS\u00C9E AVEC NETTOYAGE COMPLET\r\n    await prisma.$transaction(async (tx) => {\r\n      await cleanupOrganizationData(tx, sanitizedId);\r\n      await tx.organization.delete({\r\n        where: { id: sanitizedId }\r\n      });\r\n    });\r\n    \r\n    console.log('[ORGANIZATIONS] Organisation supprim\u00E9e avec succ\u00E8s');\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Organisation supprim\u00E9e avec succ\u00E8s'\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur DELETE:', error);\r\n\r\n    if (error instanceof Prisma.PrismaClientKnownRequestError) {\r\n      if (error.code === 'P2003') {\r\n        return res.status(409).json({\r\n          success: false,\r\n          message: 'Impossible de supprimer cette organisation tant que des donn\u00E9es associ\u00E9es existent (modules, r\u00F4les, configurations, etc.).'\r\n        });\r\n      }\r\n    }\r\n\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la suppression de l\\'organisation'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDF1F ROUTES GOOGLE WORKSPACE - NOUVELLES FONCTIONNALIT\u00C9S AVANC\u00C9ES\r\n\r\n// GET /api/organizations/:id/google-modules - R\u00E9cup\u00E9rer statut modules Google Workspace\r\nrouter.get('/:id/google-modules', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] GET /organizations/:id/google-modules - R\u00E9cup\u00E9ration modules Google');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const sanitizedId = validateAndSanitizeId(id, 'ID organisation');\r\n    const requestingUser = req.user;\r\n    \r\n    // \u2705 V\u00C9RIFICATION PERMISSIONS\r\n    if (!canAccessOrganization(requestingUser, sanitizedId)) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cette organisation'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer tous les modules Google Workspace pour cette organisation\r\n    const moduleStatuses = await prisma.organizationModuleStatus.findMany({\r\n      where: {\r\n        organizationId: sanitizedId,\r\n        Module: {\r\n          key: {\r\n            in: [...GOOGLE_WORKSPACE_MODULES]\r\n          }\r\n        }\r\n      },\r\n      include: {\r\n        Module: true\r\n      }\r\n    });\r\n    \r\n    // Structure des modules Google par d\u00E9faut\r\n    const defaultModules = {\r\n      gmail: { enabled: false, configured: false },\r\n      calendar: { enabled: false, configured: false },\r\n      drive: { enabled: false, configured: false },\r\n      meet: { enabled: false, configured: false },\r\n      docs: { enabled: false, configured: false },\r\n      sheets: { enabled: false, configured: false },\r\n      voice: { enabled: false, configured: false }\r\n    };\r\n    \r\n    // Mettre \u00E0 jour avec les donn\u00E9es de la base\r\n    moduleStatuses.forEach(status => {\r\n      if (status.Module?.key && defaultModules[status.Module.key as keyof typeof defaultModules]) {\r\n        defaultModules[status.Module.key as keyof typeof defaultModules] = {\r\n          enabled: status.active,\r\n          configured: status.active // Simplifi\u00E9 pour le moment\r\n        };\r\n      }\r\n    });\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: defaultModules\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur GET google-modules:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des modules Google'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/organizations/:id/google-modules/:module/toggle - Toggle module Google Workspace\r\nrouter.post('/:id/google-modules/:module/toggle', requireRole(['super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] POST /organizations/:id/google-modules/:module/toggle - Toggle module Google');\r\n  \r\n  try {\r\n    const { id, module } = req.params;\r\n    const { enabled } = req.body;\r\n    const sanitizedId = validateAndSanitizeId(id, 'ID organisation');\r\n    const sanitizedModule = sanitizeString(module);\r\n    \r\n    // \u2705 VALIDATION MODULE GOOGLE (Factoris\u00E9)\r\n    if (!isGoogleWorkspaceModule(sanitizedModule)) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Module Google Workspace invalide'\r\n      });\r\n    }\r\n    \r\n    // \u2705 VALIDATION ENABLED\r\n    if (typeof enabled !== 'boolean') {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Le param\u00E8tre enabled doit \u00EAtre un bool\u00E9en'\r\n      });\r\n    }\r\n    \r\n    console.log(`[ORGANIZATIONS] Toggle module ${sanitizedModule} \u00E0 ${enabled} pour organisation ${sanitizedId}`);\r\n    \r\n    // \uD83D\uDD04 TRANSACTION S\u00C9CURIS\u00C9E\r\n    await prisma.$transaction(async (tx) => {\r\n      // Trouver ou cr\u00E9er le module\r\n      let moduleRecord = await tx.module.findFirst({\r\n        where: { key: sanitizedModule }\r\n      });\r\n      \r\n      if (!moduleRecord) {\r\n        // Cr\u00E9er le module s'il n'existe pas\r\n        moduleRecord = await tx.module.create({\r\n          data: {\r\n            key: sanitizedModule,\r\n            label: sanitizedModule.charAt(0).toUpperCase() + sanitizedModule.slice(1),\r\n            feature: `google_${sanitizedModule}`,\r\n            active: true,\r\n            order: GOOGLE_WORKSPACE_MODULES.indexOf(sanitizedModule as GoogleWorkspaceModule)\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Mettre \u00E0 jour ou cr\u00E9er le statut du module pour l'organisation\r\n      await tx.organizationModuleStatus.upsert({\r\n        where: {\r\n          organizationId_moduleId: {\r\n            organizationId: sanitizedId,\r\n            moduleId: moduleRecord.id\r\n          }\r\n        },\r\n        update: {\r\n          active: enabled\r\n        },\r\n        create: {\r\n          organizationId: sanitizedId,\r\n          moduleId: moduleRecord.id,\r\n          active: enabled\r\n        }\r\n      });\r\n    });\r\n    \r\n    console.log('[ORGANIZATIONS] Module Google mis \u00E0 jour avec succ\u00E8s');\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: `Module ${sanitizedModule} ${enabled ? 'activ\u00E9' : 'd\u00E9sactiv\u00E9'} avec succ\u00E8s`\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur POST google-modules toggle:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la mise \u00E0 jour du module Google'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/organizations/:id/google-workspace/domain-status - V\u00E9rifier le statut du domaine pour Google Workspace\r\nrouter.get('/:id/google-workspace/domain-status', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ORGANIZATIONS] GET /organizations/:id/google-workspace/domain-status - V\u00E9rification statut domaine');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const sanitizedId = validateAndSanitizeId(id, 'ID organisation');\r\n    const requestingUser = req.user;\r\n    \r\n    // \u2705 V\u00C9RIFICATION PERMISSIONS\r\n    if (!canAccessOrganization(requestingUser, sanitizedId)) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cette organisation'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer l'organisation\r\n    const organization = await prisma.organization.findUnique({\r\n      where: { id: sanitizedId }\r\n    });\r\n    \r\n    if (!organization) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Organisation non trouv\u00E9e'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer la configuration Google Workspace pour obtenir le vrai domaine\r\n    const googleConfig = await prisma.googleWorkspaceConfig.findUnique({\r\n      where: { organizationId: sanitizedId }\r\n    });\r\n    \r\n    // Utiliser le domaine configur\u00E9 dans Google Workspace, ou un domaine par d\u00E9faut\r\n    const domain = googleConfig?.domain || '2thier.be';\r\n    \r\n    // G\u00E9n\u00E9rer les enregistrements DNS requis\r\n    const requiredRecords = {\r\n      verification: {\r\n        type: 'TXT',\r\n        name: '@',\r\n        value: `google-site-verification=ABC123XYZ${Date.now().toString().slice(-6)}`\r\n      },\r\n      mx: [\r\n        { priority: 1, server: 'aspmx.l.google.com.' },\r\n        { priority: 5, server: 'alt1.aspmx.l.google.com.' },\r\n        { priority: 5, server: 'alt2.aspmx.l.google.com.' },\r\n        { priority: 10, server: 'alt3.aspmx.l.google.com.' },\r\n        { priority: 10, server: 'alt4.aspmx.l.google.com.' }\r\n      ],\r\n      security: {\r\n        spf: 'v=spf1 include:_spf.google.com ~all',\r\n        dmarc: 'v=DMARC1; p=quarantine; rua=mailto:admin@' + domain\r\n      }\r\n    };\r\n    \r\n    // Pour l'instant, consid\u00E9rer que le domaine n'est pas configur\u00E9\r\n    // Dans une vraie impl\u00E9mentation, on ferait des requ\u00EAtes DNS r\u00E9elles\r\n    const isConfigured = false;\r\n    \r\n    console.log('[ORGANIZATIONS] Statut domaine calcul\u00E9:', { domain, isConfigured });\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        domain,\r\n        isConfigured,\r\n        requiredRecords: isConfigured ? null : requiredRecords\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[ORGANIZATIONS] Erreur GET domain-status:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la v\u00E9rification du domaine'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { googleOAuthService } from '../google-auth/core/GoogleOAuthCore.js';\r\nimport { prisma } from '../lib/prisma';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\n\r\nconst router = Router();\r\n\r\n// \uD83E\uDDE0 Cache simple en m\u00E9moire pour \u00E9viter les rafales et rendre l'endpoint idempotent sur une courte p\u00E9riode\r\ntype CachedConnectResult = { expiresAt: number; payload: Record<string, unknown> };\r\nconst connectCache = new Map<string, CachedConnectResult>();\r\n\r\n// POST /api/auto-google-auth/connect\r\n// Tente de connecter l'utilisateur \u00E0 Google Workspace en arri\u00E8re-plan.\r\n// Si les tokens existent et sont valides (ou peuvent \u00EAtre rafra\u00EEchis), c'est transparent.\r\n// Sinon, renvoie une URL d'autorisation pour que le frontend puisse rediriger l'utilisateur.\r\nrouter.post('/connect', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ROUTE] /api/auto-google-auth/connect atteint');\r\n  const { userId, organizationId } = req.body;\r\n  const caller = req.user;\r\n\r\n  if (!userId || !organizationId) {\r\n    return res.status(400).json({ success: false, error: 'userId et organizationId sont requis.' });\r\n  }\r\n\r\n  // \uD83D\uDD12 Validation d'autorisation: l'appelant doit \u00EAtre lui-m\u00EAme OU super_admin\r\n  if (!caller) {\r\n    return res.status(401).json({ success: false, error: 'Authentification requise.' });\r\n  }\r\n  const isSuperAdmin = caller.role === 'super_admin' || caller.isSuperAdmin === true;\r\n  if (!isSuperAdmin && caller.userId !== userId) {\r\n    return res.status(403).json({ success: false, error: \"Acc\u00E8s interdit: utilisateur non autoris\u00E9.\" });\r\n  }\r\n\r\n  // \uD83D\uDD12 V\u00E9rifier l'appartenance \u00E0 l'organisation (sauf super_admin)\r\n  if (!isSuperAdmin) {\r\n    const membership = await prisma.userOrganization.findFirst({ where: { userId: caller.userId, organizationId } });\r\n    if (!membership) {\r\n      return res.status(403).json({ success: false, error: \"Acc\u00E8s interdit: organisation non autoris\u00E9e.\" });\r\n    }\r\n  }\r\n\r\n  try {\r\n    // Idempotence courte: renvoyer le dernier r\u00E9sultat r\u00E9cent si disponible (\u00E9vite le spam + les courses)\r\n    const key = `${userId}:${organizationId || 'none'}`;\r\n    const now = Date.now();\r\n    const cached = connectCache.get(key);\r\n    if (cached && cached.expiresAt > now) {\r\n      res.setHeader('X-AutoGoogle-Cache-Until', new Date(cached.expiresAt).toISOString());\r\n      return res.json({ ...cached.payload, cached: true });\r\n    }\r\n\r\n    // 1. Essayer d'obtenir un client authentifi\u00E9 (ce qui g\u00E8re le refresh token)\r\n    const authClient = await googleOAuthService.getAuthenticatedClientForOrganization(organizationId);\r\n\r\n    if (authClient) {\r\n      // L'utilisateur est d\u00E9j\u00E0 connect\u00E9 et le token est valide (ou a \u00E9t\u00E9 rafra\u00EEchi)\r\n      console.log('[AutoGoogleAuth] \u2705 Connexion Google d\u00E9j\u00E0 active pour organisation:', organizationId);\r\n      const ttlConnected = 15_000;\r\n      const payload = { success: true, isConnected: true, needsManualAuth: false, message: 'Connexion Google d\u00E9j\u00E0 active.', cacheTtlMs: ttlConnected };\r\n      connectCache.set(key, { expiresAt: now + ttlConnected, payload });\r\n      res.setHeader('X-AutoGoogle-Cache-Until', new Date(now + ttlConnected).toISOString());\r\n      return res.json(payload);\r\n    }\r\n\r\n    // 2. Si aucun client n'est retourn\u00E9, cela signifie qu'il n'y a pas de tokens valides.\r\n    // Il faut donc initier le processus d'autorisation manuelle.\r\n    console.log('[AutoGoogleAuth] \uD83D\uDD10 Connexion Google non active, g\u00E9n\u00E9ration de l\\'URL d\\'autorisation...');\r\n    \r\n    // R\u00E9cup\u00E9rer l'email de l'admin pour l'organisation\r\n    const org = await prisma.organization.findUnique({\r\n      where: { id: organizationId },\r\n      include: { GoogleWorkspaceConfig: true }\r\n    });\r\n\r\n    if (!org?.GoogleWorkspaceConfig?.adminEmail) {\r\n      return res.status(404).json({ success: false, error: 'Configuration Google Workspace introuvable pour cette organisation.' });\r\n    }\r\n\r\n    // G\u00E9n\u00E9rer l'URL d'autorisation\r\n    const authUrl = googleOAuthService.getAuthUrl(userId, organizationId);\r\n\r\n    const ttlManual = 60_000;\r\n    const payload = {\r\n      success: true,\r\n      isConnected: false,\r\n      needsManualAuth: true,\r\n      authUrl: authUrl,\r\n      adminEmail: org.GoogleWorkspaceConfig.adminEmail,\r\n      message: 'Autorisation manuelle requise.',\r\n      cacheTtlMs: ttlManual\r\n    } as const;\r\n    connectCache.set(key, { expiresAt: now + ttlManual, payload: payload as unknown as Record<string, unknown> });\r\n    res.setHeader('X-AutoGoogle-Cache-Until', new Date(now + ttlManual).toISOString());\r\n    // Indication c\u00F4t\u00E9 client pour un backoff recommand\u00E9\r\n    res.setHeader('Retry-After', Math.ceil(ttlManual / 1000).toString());\r\n    return res.json(payload);\r\n\r\n  } catch (error) {\r\n    console.error('[AutoGoogleAuth] Erreur lors de la connexion automatique:', error);\r\n    res.status(500).json({ success: false, error: 'Erreur interne du serveur lors de la connexion Google.' });\r\n  }\r\n});\r\n\r\n// POST /api/auto-google-auth/trigger-logout\r\nrouter.post('/trigger-logout', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ROUTE] /api/auto-google-auth/trigger-logout atteint');\r\n  const { userId } = req.body;\r\n  console.log('[GOOGLE-LOGOUT] Re\u00E7u logout CRM pour utilisateur:', userId);\r\n\r\n  if (!userId) {\r\n    return res.status(400).json({ success: false, error: 'userId requis.' });\r\n  }\r\n\r\n  // Politique voulue: NE JAMAIS d\u00E9connecter Google automatiquement.\r\n  // On ne r\u00E9voque pas les tokens, on ne supprime rien. On retourne juste un succ\u00E8s \"no-op\".\r\n  try {\r\n    // Ancien comportement (d\u00E9sactiv\u00E9): await googleOAuthService.disconnectUser(userId);\r\n    console.log('[GOOGLE-LOGOUT] Politique NO-OP: aucune action sur les tokens Google');\r\n    return res.status(200).json({ success: true, message: 'Aucune d\u00E9connexion Google effectu\u00E9e (politique persistante).' });\r\n  } catch (error) {\r\n    console.error('[AutoGoogleAuth] Erreur inattendue trigger-logout (no-op):', error);\r\n    return res.status(200).json({ success: true, message: 'Aucune d\u00E9connexion Google effectu\u00E9e (no-op avec erreur interne ignor\u00E9e).' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\n// import { requireRole } from '../middlewares/requireRole.js';\r\nimport { prisma } from '../lib/prisma.js';\r\nimport { decrypt } from '../utils/crypto.js';\r\nimport { google } from 'googleapis';\r\n// import axios from 'axios';\r\nimport { refreshGoogleTokenIfNeeded } from '../utils/googleTokenRefresh.js';\r\nimport { googleOAuthService, GOOGLE_SCOPES_LIST } from '../google-auth/core/GoogleOAuthCore.js';\r\nimport gmailRoutes from '../google-auth/routes/gmail'; // Routes Gmail centralis\u00E9es\r\nimport { logSecurityEvent } from '../security/securityLogger.js';\r\n\r\nconst router = Router();\r\n\r\nconst GOOGLE_SCOPES = GOOGLE_SCOPES_LIST.join(' ');\r\n\r\n// Fonction utilitaire pour r\u00E9cup\u00E9rer la configuration Google Workspace\r\nasync function getGoogleWorkspaceConfig(organizationId: string) {\r\n  try {\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDCCB Recherche config pour organisation:', organizationId);\r\n    \r\n    const config = await prisma.googleWorkspaceConfig.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDCCA Config brute depuis BDD:', config ? 'Trouv\u00E9e' : 'Non trouv\u00E9e');\r\n    if (config) {\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDD11 clientId crypt\u00E9:', config.clientId ? 'Pr\u00E9sent' : 'Manquant');\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDD10 clientSecret crypt\u00E9:', config.clientSecret ? 'Pr\u00E9sent' : 'Manquant');\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDD17 redirectUri:', config.redirectUri);\r\n    }\r\n\r\n    if (!config) {\r\n      console.log('[GOOGLE-AUTH] \u274C Aucune configuration trouv\u00E9e');\r\n      return null;\r\n    }\r\n\r\n    const decryptedConfig = {\r\n      clientId: config.clientId ? decrypt(config.clientId) : null,\r\n      clientSecret: config.clientSecret ? decrypt(config.clientSecret) : null,\r\n      redirectUri: config.redirectUri,\r\n      adminEmail: config.adminEmail, // Ajout de l'email admin\r\n      isConfigured: !!config.clientId && !!config.clientSecret && !!config.redirectUri\r\n    };\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD13 Config d\u00E9crypt\u00E9e:');\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDD94 clientId d\u00E9crypt\u00E9:', decryptedConfig.clientId ? 'OK' : 'ERREUR');\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD10 clientSecret d\u00E9crypt\u00E9:', decryptedConfig.clientSecret ? 'OK' : 'ERREUR');\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD17 redirectUri final:', decryptedConfig.redirectUri);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDCE7 adminEmail:', decryptedConfig.adminEmail);\r\n    console.log('[GOOGLE-AUTH] \u2705 isConfigured:', decryptedConfig.isConfigured);\r\n\r\n    return decryptedConfig;\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] \u274C Erreur r\u00E9cup\u00E9ration config:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Fonction pour activer automatiquement les modules Google Workspace\r\nasync function activateGoogleModules(organizationId: string, grantedScopes: string) {\r\n  try {\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD27 D\u00E9but activation modules pour org:', organizationId);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD10 Scopes accord\u00E9s:', grantedScopes);\r\n\r\n    const scopesArray = grantedScopes.split(' ');\r\n    \r\n    // Mapping des scopes vers les modules\r\n    const moduleMapping = [\r\n      {\r\n        name: 'Gmail',\r\n        scopes: ['https://mail.google.com/', 'https://www.googleapis.com/auth/gmail.readonly', 'https://www.googleapis.com/auth/gmail.send', 'https://www.googleapis.com/auth/gmail.modify'],\r\n        configField: 'gmailEnabled'\r\n      },\r\n      {\r\n        name: 'Calendar',\r\n        scopes: ['https://www.googleapis.com/auth/calendar'],\r\n        configField: 'calendarEnabled'\r\n      },\r\n      {\r\n        name: 'Drive',\r\n        scopes: ['https://www.googleapis.com/auth/drive'],\r\n        configField: 'driveEnabled'\r\n      },\r\n      {\r\n        name: 'Docs',\r\n        scopes: ['https://www.googleapis.com/auth/documents'],\r\n        configField: 'docsEnabled'\r\n      },\r\n      {\r\n        name: 'Sheets',\r\n        scopes: ['https://www.googleapis.com/auth/spreadsheets'],\r\n        configField: 'sheetsEnabled'\r\n      },\r\n      {\r\n        name: 'Meet',\r\n        scopes: ['https://www.googleapis.com/auth/meetings'],\r\n        configField: 'meetEnabled'\r\n      }\r\n    ];\r\n\r\n    const modulesToActivate = [];\r\n    const configUpdates: Record<string, boolean> = {};\r\n\r\n    // V\u00E9rifier quels modules peuvent \u00EAtre activ\u00E9s\r\n    for (const module of moduleMapping) {\r\n      const hasRequiredScopes = module.scopes.some(scope => scopesArray.includes(scope));\r\n      if (hasRequiredScopes) {\r\n        modulesToActivate.push(module.name);\r\n        configUpdates[module.configField] = true;\r\n        console.log('[GOOGLE-AUTH] \u2705 Module activable:', module.name);\r\n      } else {\r\n        console.log('[GOOGLE-AUTH] \u274C Module non activable (scopes manquants):', module.name);\r\n      }\r\n    }\r\n\r\n    // Mettre \u00E0 jour la configuration Google Workspace\r\n    if (Object.keys(configUpdates).length > 0) {\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDCBE Mise \u00E0 jour config avec modules:', configUpdates);\r\n      await prisma.googleWorkspaceConfig.update({\r\n        where: { organizationId },\r\n        data: {\r\n          ...configUpdates,\r\n          enabled: true,\r\n          isActive: true,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    // Activer les modules correspondants dans la table modules\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD27 Activation des modules CRM...');\r\n    for (const moduleName of modulesToActivate) {\r\n      try {\r\n        // Trouver le module par nom\r\n        const module = await prisma.module.findFirst({\r\n          where: {\r\n            label: {\r\n              contains: moduleName,\r\n              mode: 'insensitive'\r\n            }\r\n          }\r\n        });\r\n\r\n        if (module) {\r\n          // Activer le module pour l'organisation\r\n          await prisma.organizationModule.upsert({\r\n            where: {\r\n              organizationId_moduleId: {\r\n                organizationId,\r\n                moduleId: module.id\r\n              }\r\n            },\r\n            update: {\r\n              isActive: true,\r\n              activatedAt: new Date(),\r\n              updatedAt: new Date()\r\n            },\r\n            create: {\r\n              organizationId,\r\n              moduleId: module.id,\r\n              isActive: true,\r\n              activatedAt: new Date()\r\n            }\r\n          });\r\n\r\n          console.log('[GOOGLE-AUTH] \u2705 Module CRM activ\u00E9:', moduleName, '(', module.id, ')');\r\n        } else {\r\n          console.log('[GOOGLE-AUTH] \u26A0\uFE0F Module CRM non trouv\u00E9:', moduleName);\r\n        }\r\n      } catch (moduleError) {\r\n        console.error('[GOOGLE-AUTH] \u274C Erreur activation module', moduleName, ':', moduleError);\r\n      }\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \u2705 Activation des modules termin\u00E9e. Modules activ\u00E9s:', modulesToActivate);\r\n    return modulesToActivate;\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] \u274C Erreur activation modules:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// GET /api/google-auth/url - G\u00E9n\u00E9rer l'URL d'authentification Google\r\nrouter.get('/url', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.query.organizationId as string;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organization ID requis'\r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer la configuration Google Workspace pour cette organisation\r\n    const config = await getGoogleWorkspaceConfig(organizationId);\r\n    \r\n    if (!config || !config.isConfigured) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Google Workspace non configur\u00E9 pour cette organisation'\r\n      });\r\n    }\r\n\r\n    // G\u00E9n\u00E9rer l'URL d'authentification Google avec la configuration de la BDD\r\n    const stateObj = {\r\n      userId: req.user?.userId || null,\r\n      organizationId\r\n    };\r\n    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +\r\n      `client_id=${config.clientId}&` +\r\n      `redirect_uri=${encodeURIComponent(config.redirectUri)}&` +\r\n      `scope=${encodeURIComponent(GOOGLE_SCOPES)}&` +\r\n      `response_type=code&` +\r\n      `access_type=offline&` +\r\n      `prompt=consent&` +\r\n      `state=${encodeURIComponent(JSON.stringify(stateObj))}`;\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        authUrl,\r\n        scopes: GOOGLE_SCOPES.split(' '),\r\n        clientConfigured: true\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] Erreur g\u00E9n\u00E9ration URL:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la g\u00E9n\u00E9ration de l\\'URL d\\'authentification'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/auth/google/connect - Alias pour /url (compatibilit\u00E9 UI)\r\nrouter.get('/connect', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    // R\u00E9cup\u00E9rer l'organizationId depuis l'utilisateur connect\u00E9\r\n    const organizationId = req.query.organizationId as string || req.user?.organizationId?.toString();\r\n    \r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD0D OrganizationId extrait:', organizationId);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDC64 User info:', req.user ? 'Pr\u00E9sent' : 'Absent');\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDFE2 User organizationId:', req.user?.organizationId);\r\n    \r\n    if (!organizationId) {\r\n      console.log('[GOOGLE-AUTH] \u274C Aucun organizationId trouv\u00E9 (query ou user)');\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organization ID requis (non trouv\u00E9 dans query ou profil utilisateur)'\r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer la configuration Google Workspace pour cette organisation\r\n    const config = await getGoogleWorkspaceConfig(organizationId);\r\n    \r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD0D Configuration r\u00E9cup\u00E9r\u00E9e pour org:', organizationId);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD27 Config compl\u00E8te:', JSON.stringify(config, null, 2));\r\n    \r\n    if (!config || !config.isConfigured) {\r\n      console.log('[GOOGLE-AUTH] \u274C Configuration manquante ou incompl\u00E8te');\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Google Workspace non configur\u00E9 pour cette organisation'\r\n      });\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \u2705 Configuration valide d\u00E9tect\u00E9e');\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDD94 ClientId:', config.clientId);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD17 RedirectUri:', config.redirectUri);\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDFE2 Domain:', config.domain);\r\n\r\n    // G\u00E9n\u00E9rer l'URL d'authentification Google avec la configuration de la BDD\r\n    const stateObj = {\r\n      userId: req.user?.userId || null,\r\n      organizationId\r\n    };\r\n    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +\r\n      `client_id=${config.clientId}&` +\r\n      `redirect_uri=${encodeURIComponent(config.redirectUri)}&` +\r\n      `scope=${encodeURIComponent(GOOGLE_SCOPES)}&` +\r\n      `response_type=code&` +\r\n      `access_type=offline&` +\r\n      `prompt=consent&` +\r\n      `state=${encodeURIComponent(JSON.stringify(stateObj))}`;\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDF10 URL g\u00E9n\u00E9r\u00E9e:', authUrl);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        authUrl,\r\n        scopes: GOOGLE_SCOPES.split(' '),\r\n        clientConfigured: true\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] Erreur g\u00E9n\u00E9ration URL connect:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la g\u00E9n\u00E9ration de l\\'URL d\\'authentification'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/google-auth/callback - Callback OAuth Google\r\nrouter.get('/callback', async (req, res) => {\r\n  try {\r\n    const { code, state, error } = req.query;\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD04 Callback OAuth re\u00E7u');\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDCCB State (organizationId):', state);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD11 Code pr\u00E9sent:', !!code);\r\n    console.log('[GOOGLE-AUTH] \u274C Erreur pr\u00E9sente:', !!error);\r\n\r\n    if (error) {\r\n      console.log('[GOOGLE-AUTH] \u274C Erreur OAuth:', error);\r\n      return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=${error}`);\r\n    }\r\n\r\n    if (!code || !state) {\r\n      console.log('[GOOGLE-AUTH] \u274C Param\u00E8tres manquants - Code:', !!code, 'State:', !!state);\r\n      return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=missing_params`);\r\n    }\r\n\r\n  let organizationId: string;\r\n  let userId: string;\r\n  let platform: string | undefined;\r\n\r\n    try {\r\n      // Le state peut \u00EAtre JSON direct ou base64url(JSON)\r\n  let parsedState: { organizationId?: string; userId?: string; platform?: string };\r\n      try {\r\n        parsedState = JSON.parse(state as string);\r\n      } catch {\r\n        const raw = Buffer.from(String(state), 'base64url').toString('utf8');\r\n        parsedState = JSON.parse(raw);\r\n      }\r\n      organizationId = parsedState.organizationId;\r\n      userId = parsedState.userId; // On r\u00E9cup\u00E8re aussi l'userId\r\n      platform = parsedState.platform; // Nouveau: d\u00E9tection de la plateforme publicitaire\r\n      \r\n      if (!organizationId || !userId) {\r\n        throw new Error('State object is missing organizationId or userId');\r\n      }\r\n      \r\n      // Si c'est un callback pour les int\u00E9grations publicitaires, rediriger\r\n      if (platform && (platform === 'google_ads' || platform === 'meta_ads')) {\r\n        console.log('[GOOGLE-AUTH] \uD83D\uDD04 Redirection vers gestionnaire int\u00E9grations publicitaires:', platform);\r\n        const callbackPath = `/api/integrations/advertising/oauth/${platform}/callback`;\r\n        const redirectUrl = `${callbackPath}?${new URLSearchParams(req.query as Record<string, string>).toString()}`;\r\n        return res.redirect(redirectUrl);\r\n      }\r\n      \r\n    } catch {\r\n      console.error('[GOOGLE-AUTH] \u274C State invalide, non-JSON ou champs manquants:', state);\r\n      return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=invalid_state`);\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDFE2 Organisation cible:', organizationId, 'pour utilisateur:', userId);\r\n    \r\n    // R\u00E9cup\u00E9rer la configuration Google Workspace pour cette organisation\r\n    const config = await getGoogleWorkspaceConfig(organizationId);\r\n    \r\n    if (!config || !config.isConfigured || !config.adminEmail) {\r\n      console.log('[GOOGLE-AUTH] \u274C Configuration manquante ou email admin non d\u00E9fini pour org:', organizationId);\r\n      return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=config_incomplete`);\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \u2705 Configuration trouv\u00E9e, email admin cible:', config.adminEmail);\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD04 \u00C9change du code contre les tokens...');\r\n\r\n    // Cr\u00E9er le client OAuth2 Google\r\n    const oauth2Client = new google.auth.OAuth2(\r\n      config.clientId,\r\n      config.clientSecret,\r\n      config.redirectUri\r\n    );\r\n\r\n    try {\r\n      // \u00C9changer le code d'autorisation contre les tokens\r\n      const { tokens } = await oauth2Client.getToken(code as string);\r\n      console.log('[GOOGLE-AUTH] \u2705 Tokens re\u00E7us:', {\r\n        accessToken: !!tokens.access_token,\r\n        refreshToken: !!tokens.refresh_token,\r\n        expiresAt: tokens.expiry_date ? new Date(tokens.expiry_date) : null,\r\n        scope: tokens.scope\r\n      });\r\n\r\n      // Configurer le client avec les tokens pour r\u00E9cup\u00E9rer les infos utilisateur\r\n      oauth2Client.setCredentials(tokens);\r\n      \r\n      // R\u00E9cup\u00E9rer les informations de l'utilisateur Google\r\n      const oauth2 = google.oauth2({ version: 'v2', auth: oauth2Client });\r\n      const userInfo = await oauth2.userinfo.get();\r\n      \r\n      console.log('[GOOGLE-AUTH] \u2705 Informations du compte Google connect\u00E9:', {\r\n        email: userInfo.data.email,\r\n        name: userInfo.data.name,\r\n      });\r\n\r\n      // V\u00C9RIFICATION CRUCIALE : L'email du compte Google connect\u00E9 doit correspondre \u00E0 l'adminEmail de la config\r\n      if (userInfo.data.email?.toLowerCase() !== config.adminEmail.toLowerCase()) {\r\n        console.log(`[GOOGLE-AUTH] \u274C ERREUR DE COMPTE : L'utilisateur s'est connect\u00E9 avec ${userInfo.data.email}, mais la configuration attendait ${config.adminEmail}.`);\r\n        return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=account_mismatch&expected=${encodeURIComponent(config.adminEmail)}&connected_as=${encodeURIComponent(userInfo.data.email || '')}`);\r\n      }\r\n\r\n      console.log('[GOOGLE-AUTH] \u2705 Connexion Google valid\u00E9e pour l\\'admin:', config.adminEmail);\r\n\r\n      // Sauvegarder ou mettre \u00E0 jour les tokens pour l'organisation\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDCBE Sauvegarde des tokens pour l\\'organisation:', organizationId);\r\n      await googleOAuthService.saveUserTokens(userId, organizationId, tokens);\r\n      const googleTokenRecord = await prisma.googleToken.findUnique({ where: { organizationId } });\r\n\r\n      console.log('[GOOGLE-AUTH] \u2705 Tokens sauvegard\u00E9s pour l\\'organisation:', googleTokenRecord?.id);\r\n\r\n      // Activer automatiquement les modules Google Workspace pour cette organisation\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDD27 Activation des modules Google Workspace...');\r\n      await activateGoogleModules(organizationId, tokens.scope || '');\r\n\r\n      console.log('[GOOGLE-AUTH] \uD83C\uDF89 Authentification Google compl\u00E8te avec succ\u00E8s !');\r\n      \r\n      // Redirection vers notre page de callback sp\u00E9cialis\u00E9e\r\n      return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_success=1&organizationId=${organizationId}&admin_email=${encodeURIComponent(config.adminEmail)}`);\r\n\r\n    } catch (tokenError: unknown) {\r\n      const error = tokenError as { response?: { status?: number; data?: { error?: string } }; message?: string; config?: { url?: string } };\r\n      console.error('[GOOGLE-AUTH] \u274C Erreur lors de l\\'\u00E9change des tokens:', error);\r\n      console.error('[GOOGLE-AUTH] \uD83D\uDCCA D\u00E9tails erreur:');\r\n      console.error('[GOOGLE-AUTH] \uD83C\uDD94 Status:', error.response?.status);\r\n      console.error('[GOOGLE-AUTH] \uD83D\uDCDD Message:', error.message);\r\n      console.error('[GOOGLE-AUTH] \uD83D\uDCCB Data:', error.response?.data);\r\n      console.error('[GOOGLE-AUTH] \uD83D\uDD17 URL appel\u00E9e:', error.config?.url);\r\n      \r\n      let errorType = 'token_exchange_failed';\r\n      if (error.response?.status === 400) {\r\n        if (error.response?.data?.error === 'invalid_client') {\r\n          errorType = 'invalid_client_config';\r\n        } else if (error.response?.data?.error === 'invalid_grant') {\r\n          errorType = 'invalid_authorization_code';\r\n        }\r\n      } else if (error.response?.status === 401) {\r\n        errorType = 'unauthorized_client';\r\n      }\r\n      \r\n      return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=${errorType}&details=${encodeURIComponent(error.message || 'Erreur inconnue')}`);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] \u274C Erreur callback g\u00E9n\u00E9rale:', error);\r\n    return res.redirect(`${process.env.FRONTEND_URL || 'http://localhost:5173'}/google-auth-callback?google_error=callback_error`);\r\n  }\r\n});\r\n\r\n// GET /api/google-auth/status - Statut de la connexion Google  \r\nrouter.get('/status', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDCCA V\u00E9rification statut connexion pour user:', req.user?.userId);\r\n    \r\n    if (!req.user?.userId) {\r\n      return res.json({\r\n        success: true,\r\n        data: {\r\n          connected: false,\r\n          email: null,\r\n          scopes: [],\r\n          lastSync: null,\r\n          error: 'Utilisateur non authentifi\u00E9'\r\n        }\r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer l'organizationId depuis le query parameter\r\n    const organizationId = req.query.organizationId as string;\r\n    if (!organizationId) {\r\n      return res.json({\r\n        success: true,\r\n        data: {\r\n          connected: false,\r\n          email: null,\r\n          scopes: [],\r\n          lastSync: null,\r\n          error: 'Organization ID requis'\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD04 Tentative de refresh automatique pour organisation:', organizationId);\r\n\r\n    // \uD83C\uDD95 NOUVEAU: Utiliser le syst\u00E8me de refresh automatique\r\n    const refreshResult = await refreshGoogleTokenIfNeeded(organizationId);\r\n    \r\n    if (!refreshResult.success) {\r\n      console.log('[GOOGLE-AUTH] \u274C Refresh automatique \u00E9chou\u00E9:', refreshResult.error);\r\n      \r\n      // G\u00E9rer les diff\u00E9rents types d'erreurs\r\n      if (refreshResult.error === 'no_token_found') {\r\n        return res.json({\r\n          success: true,\r\n          data: {\r\n            connected: false,\r\n            email: null,\r\n            scopes: [],\r\n            lastSync: null,\r\n            error: 'Aucun token Google trouv\u00E9'\r\n          }\r\n        });\r\n      } else if (refreshResult.error === 'no_refresh_token') {\r\n        return res.json({\r\n          success: true,\r\n          data: {\r\n            connected: false,\r\n            email: null,\r\n            scopes: [],\r\n            lastSync: null,\r\n            error: 'Token expir\u00E9, reconnexion requise'\r\n          }\r\n        });\r\n      } else if (refreshResult.error === 'invalid_refresh_token') {\r\n        return res.json({\r\n          success: true,\r\n          data: {\r\n            connected: false,\r\n            email: null,\r\n            scopes: [],\r\n            lastSync: null,\r\n            error: 'Token r\u00E9voqu\u00E9, reconnexion requise'\r\n          }\r\n        });\r\n      } else {\r\n        return res.json({\r\n          success: true,\r\n          data: {\r\n            connected: false,\r\n            email: null,\r\n            scopes: [],\r\n            lastSync: null,\r\n            error: 'Erreur de connexion Google'\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \u2705 Token valide ou rafra\u00EEchi avec succ\u00E8s');\r\n\r\n    // R\u00E9cup\u00E9rer les informations utilisateur avec le token valide\r\n    let userEmail = null;\r\n    let tokenValid = false;\r\n    let scopes: string[] = [];\r\n\r\n    try {\r\n      // Cr\u00E9er le client OAuth avec le token valide\r\n      const oauth2Client = new google.auth.OAuth2();\r\n      oauth2Client.setCredentials({\r\n        access_token: refreshResult.accessToken,\r\n        refresh_token: refreshResult.refreshToken,\r\n        expiry_date: refreshResult.expiresAt?.getTime()\r\n      });\r\n\r\n      // Tester le token en r\u00E9cup\u00E9rant les infos utilisateur\r\n      const oauth2 = google.oauth2({ version: 'v2', auth: oauth2Client });\r\n      const userInfo = await oauth2.userinfo.get();\r\n      \r\n      userEmail = userInfo.data.email;\r\n      tokenValid = true;\r\n      \r\n      // R\u00E9cup\u00E9rer les scopes depuis la base de donn\u00E9es\r\n      const googleToken = await prisma.googleToken.findUnique({\r\n        where: { organizationId }\r\n      });\r\n      scopes = googleToken?.scope ? googleToken.scope.split(' ') : [];\r\n      \r\n      console.log('[GOOGLE-AUTH] \u2705 Token valid\u00E9 avec succ\u00E8s, email:', userEmail);\r\n\r\n    } catch (tokenError) {\r\n      console.log('[GOOGLE-AUTH] \u274C Erreur validation token final:', tokenError);\r\n      tokenValid = false;\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer les informations de derni\u00E8re synchronisation\r\n    const googleToken = await prisma.googleToken.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        connected: tokenValid,\r\n        email: userEmail,\r\n        scopes: scopes,\r\n        lastSync: googleToken?.updatedAt,\r\n        expiresAt: refreshResult.expiresAt,\r\n        isExpired: false, // Le token est maintenant garanti valide\r\n        autoRefreshEnabled: true // Indicateur que le refresh automatique est actif\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] \u274C Erreur statut:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la v\u00E9rification du statut'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/google-auth/disconnect - D\u00E9connecter Google\r\nrouter.post('/disconnect', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD04 D\u00E9but d\u00E9connexion pour user:', req.user?.userId);\r\n    \r\n    if (!req.user?.userId) {\r\n      return res.status(401).json({\r\n        success: false,\r\n        message: 'Utilisateur non authentifi\u00E9'\r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer l'organizationId depuis le body\r\n    const { organizationId } = req.body;\r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organization ID requis'\r\n      });\r\n    }\r\n\r\n    // Journalisation de l'intention de d\u00E9connexion (tra\u00E7abilit\u00E9)\r\n    try {\r\n      logSecurityEvent('GOOGLE_DISCONNECT_REQUESTED', {\r\n        userId: req.user.userId,\r\n        organizationId,\r\n        ip: req.ip,\r\n        userAgent: req.headers['user-agent'] || null\r\n      }, 'info');\r\n    } catch (e) {\r\n      console.warn('[GOOGLE-AUTH] Warn: \u00E9chec logSecurityEvent (REQUESTED):', (e as Error)?.message);\r\n    }\r\n\r\n    // Chercher les tokens Google de l'organisation\r\n    const googleToken = await prisma.googleToken.findUnique({\r\n      where: { organizationId: organizationId }\r\n    });\r\n\r\n    if (googleToken) {\r\n      try {\r\n        // R\u00E9voquer le token c\u00F4t\u00E9 Google\r\n        console.log('[GOOGLE-AUTH] \uD83D\uDEAB R\u00E9vocation du token c\u00F4t\u00E9 Google...');\r\n        const oauth2Client = new google.auth.OAuth2();\r\n        oauth2Client.setCredentials({\r\n          access_token: googleToken.accessToken\r\n        });\r\n\r\n        await oauth2Client.revokeCredentials();\r\n        console.log('[GOOGLE-AUTH] \u2705 Token r\u00E9voqu\u00E9 c\u00F4t\u00E9 Google');\r\n\r\n      } catch (revokeError) {\r\n        console.log('[GOOGLE-AUTH] \u26A0\uFE0F Erreur r\u00E9vocation c\u00F4t\u00E9 Google (peut-\u00EAtre d\u00E9j\u00E0 r\u00E9voqu\u00E9):', revokeError);\r\n      }\r\n\r\n      // Supprimer le token de notre base de donn\u00E9es\r\n      console.log('[GOOGLE-AUTH] \uD83D\uDDD1\uFE0F Suppression du token de la base...');\r\n      await prisma.googleToken.delete({\r\n        where: { organizationId: organizationId }\r\n      });\r\n\r\n      console.log('[GOOGLE-AUTH] \u2705 Token supprim\u00E9 de la base');\r\n    }\r\n\r\n    // D\u00E9sactiver les modules Google Workspace pour l'organisation\r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD27 D\u00E9sactivation des modules Google...');\r\n    await prisma.googleWorkspaceConfig.update({\r\n      where: { organizationId: organizationId },\r\n      data: {\r\n        enabled: false,\r\n        gmailEnabled: false,\r\n        calendarEnabled: false,\r\n        driveEnabled: false,\r\n        docsEnabled: false,\r\n        sheetsEnabled: false,\r\n        meetEnabled: false,\r\n        voiceEnabled: false,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    // D\u00E9sactiver aussi les modules dans la table organizationModule\r\n    const googleModules = await prisma.module.findMany({\r\n      where: {\r\n        name: {\r\n          in: ['Gmail', 'Calendar', 'Drive', 'Docs', 'Sheets', 'Meet'],\r\n          mode: 'insensitive'\r\n        }\r\n      }\r\n    });\r\n\r\n    for (const module of googleModules) {\r\n      await prisma.organizationModule.updateMany({\r\n        where: {\r\n          organizationId: organizationId,\r\n          moduleId: module.id\r\n        },\r\n        data: {\r\n          isActive: false,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \u2705 Modules Google d\u00E9sactiv\u00E9s');\r\n\r\n    console.log('[GOOGLE-AUTH] \uD83C\uDF89 D\u00E9connexion Google compl\u00E8te');\r\n    try {\r\n      logSecurityEvent('GOOGLE_DISCONNECT_COMPLETED', {\r\n        userId: req.user.userId,\r\n        organizationId,\r\n        ip: req.ip,\r\n        userAgent: req.headers['user-agent'] || null\r\n      }, 'info');\r\n    } catch (e) {\r\n      console.warn('[GOOGLE-AUTH] Warn: \u00E9chec logSecurityEvent (COMPLETED):', (e as Error)?.message);\r\n    }\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'D\u00E9connect\u00E9 de Google Workspace avec succ\u00E8s'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] \u274C Erreur d\u00E9connexion:', error);\r\n    try {\r\n      const orgIdFromBody = (req.body && typeof (req.body as Record<string, unknown>).organizationId === 'string')\r\n        ? (req.body as Record<string, string>).organizationId\r\n        : null;\r\n      const errMsg = (error instanceof Error) ? error.message : String(error);\r\n      logSecurityEvent('GOOGLE_DISCONNECT_ERROR', {\r\n        userId: req.user?.userId || null,\r\n        organizationId: orgIdFromBody,\r\n        ip: req.ip,\r\n        userAgent: req.headers['user-agent'] || null,\r\n        error: errMsg\r\n      }, 'error');\r\n    } catch (e) {\r\n      console.warn('[GOOGLE-AUTH] Warn: \u00E9chec logSecurityEvent (ERROR):', (e as Error)?.message);\r\n    }\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la d\u00E9connexion'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/google-auth/toggle-module - Activer/d\u00E9sactiver un module Google sp\u00E9cifique\r\nrouter.post('/toggle-module', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    // R\u00E9cup\u00E9rer l'organizationId depuis le body\r\n    const { moduleName, enabled, organizationId } = req.body;\r\n    \r\n    console.log('[GOOGLE-AUTH] \uD83D\uDD27 Toggle module:', moduleName, 'enabled:', enabled, 'pour organization:', organizationId);\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organization ID requis'\r\n      });\r\n    }\r\n\r\n    if (!moduleName || typeof enabled !== 'boolean') {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Param\u00E8tres invalides (moduleName et enabled requis)'\r\n      });\r\n    }\r\n\r\n    // V\u00E9rifier que l'organisation a des tokens Google valides\r\n    const googleToken = await prisma.googleToken.findUnique({\r\n      where: { organizationId: organizationId }\r\n    });\r\n\r\n    if (!googleToken && enabled) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Connexion Google requise pour activer les modules'\r\n      });\r\n    }\r\n\r\n    // Mapping des noms de modules vers les champs de configuration\r\n    const moduleConfigMap: Record<string, string> = {\r\n      'Gmail': 'gmailEnabled',\r\n      'Calendar': 'calendarEnabled',\r\n      'Drive': 'driveEnabled',\r\n      'Docs': 'docsEnabled',\r\n      'Sheets': 'sheetsEnabled',\r\n      'Meet': 'meetEnabled',\r\n      'Voice': 'voiceEnabled'\r\n    };\r\n\r\n    const configField = moduleConfigMap[moduleName];\r\n    if (!configField) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Module non reconnu'\r\n      });\r\n    }\r\n\r\n    // Mettre \u00E0 jour la configuration Google Workspace\r\n    const updateData: Record<string, boolean | Date> = {\r\n      [configField]: enabled,\r\n      updatedAt: new Date()\r\n    };\r\n\r\n    await prisma.googleWorkspaceConfig.update({\r\n      where: { organizationId: organizationId },\r\n      data: updateData\r\n    });\r\n\r\n    // Mettre \u00E0 jour aussi le module dans la table organizationModule\r\n    const module = await prisma.module.findFirst({\r\n      where: {\r\n        name: {\r\n          contains: moduleName,\r\n          mode: 'insensitive'\r\n        }\r\n      }\r\n    });\r\n\r\n    if (module) {\r\n      await prisma.organizationModule.upsert({\r\n        where: {\r\n          organizationId_moduleId: {\r\n            organizationId: organizationId,\r\n            moduleId: module.id\r\n          }\r\n        },\r\n        update: {\r\n          isActive: enabled,\r\n          activatedAt: enabled ? new Date() : null,\r\n          updatedAt: new Date()\r\n        },\r\n        create: {\r\n          organizationId: organizationId,\r\n          moduleId: module.id,\r\n          isActive: enabled,\r\n          activatedAt: enabled ? new Date() : null\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('[GOOGLE-AUTH] \u2705 Module', moduleName, enabled ? 'activ\u00E9' : 'd\u00E9sactiv\u00E9');\r\n\r\n    res.json({\r\n      success: true,\r\n      message: `Module ${moduleName} ${enabled ? 'activ\u00E9' : 'd\u00E9sactiv\u00E9'} avec succ\u00E8s`,\r\n      data: {\r\n        moduleName,\r\n        enabled\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[GOOGLE-AUTH] \u274C Erreur toggle module:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la modification du module'\r\n    });\r\n  }\r\n});\r\n\r\n// Routes Gmail centralis\u00E9es (avec authentification middleware)\r\nrouter.use('/gmail', authMiddleware, gmailRoutes);\r\nconsole.log('[GOOGLE-AUTH] Routes Gmail centralis\u00E9es mont\u00E9es sur /gmail');\r\n\r\nexport default router;\r\n", "/**\r\n * Syst\u00E8me de refresh automatique des tokens Google - Version int\u00E9gr\u00E9e\r\n * Cette version \u00E9vite les probl\u00E8mes de compilation en int\u00E9grant directement le code\r\n */\r\n\r\nimport { google } from 'googleapis';\r\nimport { prisma } from '../lib/prisma.js';\r\n\r\nexport interface RefreshTokenResult {\r\n  success: boolean;\r\n  accessToken?: string;\r\n  refreshToken?: string;\r\n  expiresAt?: Date;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * V\u00E9rifie et rafra\u00EEchit automatiquement un token Google si n\u00E9cessaire\r\n */\r\nexport async function refreshGoogleTokenIfNeeded(organizationId: string): Promise<RefreshTokenResult> {\r\n  try {\r\n    console.log('[REFRESH-TOKEN] \uD83D\uDD0D V\u00E9rification token pour organisation:', organizationId);\r\n\r\n    // 1. R\u00E9cup\u00E9rer le token actuel\r\n    const googleToken = await prisma.googleToken.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    if (!googleToken) {\r\n      console.log('[REFRESH-TOKEN] \u274C Aucun token trouv\u00E9 pour l\\'organisation:', organizationId);\r\n      return { success: false, error: 'no_token_found' };\r\n    }\r\n\r\n    console.log('[REFRESH-TOKEN] \uD83D\uDCCB Token trouv\u00E9, expiration:', googleToken.expiresAt);\r\n\r\n    // 2. V\u00E9rifier si le token est proche de l'expiration (dans les 30 prochaines minutes)\r\n    const now = new Date();\r\n    const thirtyMinutesFromNow = new Date(now.getTime() + 30 * 60 * 1000);\r\n    const isExpiring = googleToken.expiresAt && googleToken.expiresAt <= thirtyMinutesFromNow;\r\n    const isExpired = googleToken.expiresAt && googleToken.expiresAt <= now;\r\n\r\n    console.log('[REFRESH-TOKEN] \u23F0 Maintenant:', now.toISOString());\r\n    console.log('[REFRESH-TOKEN] \u23F0 Token expire le:', googleToken.expiresAt?.toISOString());\r\n    console.log('[REFRESH-TOKEN] \u26A0\uFE0F Token expirant bient\u00F4t (30min)?', isExpiring);\r\n    console.log('[REFRESH-TOKEN] \u274C Token d\u00E9j\u00E0 expir\u00E9?', isExpired);\r\n\r\n    console.log('[REFRESH-TOKEN] \u23F0 \u00C9tat du token (d\u00E9lai 30min):');\r\n    console.log('  - Expire le:', googleToken.expiresAt);\r\n    console.log('  - Maintenant:', now);\r\n    console.log('  - Expir\u00E9:', isExpired);\r\n    console.log('  - Expire bient\u00F4t (30min):', isExpiring);\r\n\r\n    // 3. Si le token n'est pas expir\u00E9 et pas proche de l'expiration, on le retourne tel quel\r\n    if (!isExpiring && !isExpired) {\r\n      console.log('[REFRESH-TOKEN] \u2705 Token encore valide (plus de 30min), pas de refresh n\u00E9cessaire');\r\n      return {\r\n        success: true,\r\n        accessToken: googleToken.accessToken,\r\n        refreshToken: googleToken.refreshToken || undefined,\r\n        expiresAt: googleToken.expiresAt\r\n      };\r\n    }\r\n\r\n    // 4. Le token est expir\u00E9 ou expire bient\u00F4t (moins de 30min), tentative de refresh\r\n    if (!googleToken.refreshToken) {\r\n      console.log('[REFRESH-TOKEN] \u274C Token expir\u00E9 mais pas de refresh token disponible');\r\n      return { success: false, error: 'no_refresh_token' };\r\n    }\r\n\r\n    console.log('[REFRESH-TOKEN] \uD83D\uDD04 Token expir\u00E9/expirant (moins de 30min), tentative de refresh...');\r\n\r\n    // 5. R\u00E9cup\u00E9rer la configuration OAuth\r\n    const googleConfig = await prisma.googleWorkspaceConfig.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    if (!googleConfig || !googleConfig.clientId || !googleConfig.clientSecret) {\r\n      console.log('[REFRESH-TOKEN] \u274C Configuration OAuth manquante pour l\\'organisation:', organizationId);\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDCCB Config trouv\u00E9e:', !!googleConfig);\r\n      if (googleConfig) {\r\n        console.log('[REFRESH-TOKEN] \uD83D\uDCCB ClientId pr\u00E9sent:', !!googleConfig.clientId);\r\n        console.log('[REFRESH-TOKEN] \uD83D\uDCCB ClientSecret pr\u00E9sent:', !!googleConfig.clientSecret);\r\n      }\r\n      return { success: false, error: 'missing_oauth_config' };\r\n    }\r\n\r\n    // 6. Cr\u00E9er le client OAuth et tenter le refresh\r\n    console.log('[REFRESH-TOKEN] \uD83D\uDD27 Configuration OAuth client...');\r\n    const oauth2Client = new google.auth.OAuth2(\r\n      googleConfig.clientId,\r\n      googleConfig.clientSecret,\r\n      googleConfig.redirectUri\r\n    );\r\n\r\n    // Configurer le refresh token\r\n    console.log('[REFRESH-TOKEN] \uD83D\uDD11 Configuration des credentials...');\r\n    oauth2Client.setCredentials({\r\n      refresh_token: googleToken.refreshToken || undefined\r\n    });\r\n\r\n    try {\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDE80 Tentative de refresh du token...');\r\n      // Forcer le refresh du token\r\n      const { credentials } = await oauth2Client.refreshAccessToken();\r\n      \r\n      console.log('[REFRESH-TOKEN] \u2705 Refresh r\u00E9ussi!');\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDCCB Nouveau token expire le:', new Date(credentials.expiry_date || 0));\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDCCB Token re\u00E7u:', !!credentials.access_token);\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDCCB Nouveau refresh token re\u00E7u:', !!credentials.refresh_token);\r\n\r\n      // 7. Sauvegarder le nouveau token\r\n      const newExpiresAt = credentials.expiry_date ? new Date(credentials.expiry_date) : null;\r\n      \r\n      console.log('[REFRESH-TOKEN] \uD83D\uDCBE Sauvegarde du nouveau token...');\r\n      await prisma.googleToken.update({\r\n        where: { organizationId },\r\n        data: {\r\n          accessToken: credentials.access_token!,\r\n          expiresAt: newExpiresAt,\r\n          updatedAt: new Date(),\r\n          // Garder l'ancien refresh token sauf si un nouveau est fourni\r\n          ...(credentials.refresh_token && {\r\n            refreshToken: credentials.refresh_token\r\n          })\r\n        }\r\n      });\r\n\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDCBE Token mis \u00E0 jour en base de donn\u00E9es');\r\n\r\n      return {\r\n        success: true,\r\n        accessToken: credentials.access_token!,\r\n        refreshToken: credentials.refresh_token || googleToken.refreshToken || undefined,\r\n        expiresAt: newExpiresAt\r\n      };\r\n\r\n    } catch (refreshError: unknown) {\r\n      console.error('[REFRESH-TOKEN] \u274C Erreur lors du refresh:', refreshError);\r\n      \r\n      // Analyser le type d'erreur\r\n      const errorMessage = refreshError instanceof Error ? refreshError.message : String(refreshError);\r\n      console.log('[REFRESH-TOKEN] \uD83D\uDD0D Message d\\'erreur:', errorMessage);\r\n      \r\n      if (errorMessage.includes('invalid_grant')) {\r\n        console.log('[REFRESH-TOKEN] \uD83D\uDEA8 Refresh token invalide ou r\u00E9voqu\u00E9');\r\n        return { success: false, error: 'invalid_refresh_token' };\r\n      } else if (errorMessage.includes('invalid_client')) {\r\n        console.log('[REFRESH-TOKEN] \uD83D\uDEA8 Configuration OAuth invalide');\r\n        return { success: false, error: 'invalid_oauth_config' };\r\n      } else {\r\n        console.log('[REFRESH-TOKEN] \uD83D\uDEA8 Erreur g\u00E9n\u00E9rique:', errorMessage);\r\n        return { success: false, error: 'refresh_failed' };\r\n      }\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('[REFRESH-TOKEN] \u274C Erreur g\u00E9n\u00E9rale dans refreshGoogleTokenIfNeeded:', error);\r\n    const errorMessage = error instanceof Error ? error.message : String(error);\r\n    console.log('[REFRESH-TOKEN] \uD83D\uDD0D D\u00E9tails de l\\'erreur g\u00E9n\u00E9rale:', errorMessage);\r\n    return { success: false, error: 'general_error' };\r\n  }\r\n}\r\n", "/**\r\n * ROUTES GMAIL CENTRALIS\u00C9ES\r\n * \r\n * Routes pour toutes les op\u00E9rations Gmail utilisant l'authentification centralis\u00E9e.\r\n */\r\n\r\nimport { Router, Request, Response, NextFunction } from 'express';\r\nimport formidable from 'formidable';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport {\r\n  getMessages,\r\n  getMessage,\r\n  modifyMessage,\r\n  deleteMessage,\r\n  trashMessage,\r\n  untrashMessage,\r\n  getLabels,\r\n  createLabel,\r\n  updateLabel,\r\n  deleteLabel,\r\n  emptyTrash,\r\n  getAttachment,\r\n  getDrafts,\r\n  saveDraft,\r\n  deleteDraft,\r\n  sendDraft,\r\n  sendMessage // \uD83C\uDD95 Pour envoi direct avec pi\u00E8ces jointes\r\n} from '../controllers/GmailController';\r\n\r\n// Middleware Formidable personnalis\u00E9 pour gros fichiers (alternative robuste \u00E0 Busboy)\r\nconst formidableMiddleware = (req: any, res: Response, next: NextFunction) => {\r\n  console.log('[DEBUG FORMIDABLE] ==================== D\u00C9BUT ANALYSE REQU\u00CATE ====================');\r\n  console.log('[DEBUG FORMIDABLE] \uD83D\uDCE5 Headers re\u00E7us:', JSON.stringify(req.headers, null, 2));\r\n  console.log('[DEBUG FORMIDABLE] \uD83C\uDFAF Content-Type:', req.headers['content-type']);\r\n  console.log('[DEBUG FORMIDABLE] \uD83D\uDCCA Content-Length:', req.headers['content-length']);\r\n  console.log('[DEBUG FORMIDABLE] \uD83D\uDD27 Method:', req.method);\r\n  console.log('[DEBUG FORMIDABLE] \uD83C\uDF10 URL:', req.url);\r\n  console.log('[DEBUG FORMIDABLE] ================== TRANSFERT VERS FORMIDABLE ==================');\r\n\r\n  // Skip si pas multipart\r\n  if (!req.headers['content-type']?.includes('multipart/form-data')) {\r\n    console.log('[DEBUG FORMIDABLE] \u26A0\uFE0F Pas de multipart/form-data - skip Formidable');\r\n    return next();\r\n  }\r\n\r\n  // Configuration Formidable robuste pour gros fichiers\r\n  const form = formidable({\r\n    maxFileSize: 50 * 1024 * 1024, // 50MB\r\n    maxFiles: 10,\r\n    maxFields: 50,\r\n    maxFieldsSize: 50 * 1024 * 1024, // 50MB pour les champs\r\n    allowEmptyFiles: false,\r\n    multiples: true,\r\n    keepExtensions: true,\r\n    encoding: 'utf-8',\r\n    uploadDir: path.join(process.cwd(), 'uploads'), // Dossier temporaire\r\n    hashAlgorithm: false, // Pas de hash pour la performance\r\n  });\r\n\r\n  // Cr\u00E9er le dossier uploads s'il n'existe pas\r\n  const uploadDir = path.join(process.cwd(), 'uploads');\r\n  if (!fs.existsSync(uploadDir)) {\r\n    fs.mkdirSync(uploadDir, { recursive: true });\r\n  }\r\n\r\n  console.log('[DEBUG FORMIDABLE] \uD83D\uDD27 Configuration Formidable appliqu\u00E9e');\r\n  console.log('[DEBUG FORMIDABLE] \uD83D\uDCC1 Upload Directory:', uploadDir);\r\n\r\n  form.parse(req, (err, fields, files) => {\r\n    if (err) {\r\n      console.error('[DEBUG FORMIDABLE] \u274C Erreur parsing:', err);\r\n      return res.status(400).json({ \r\n        error: 'Erreur lors du parsing du formulaire', \r\n        details: err.message \r\n      });\r\n    }\r\n\r\n    console.log('[DEBUG FORMIDABLE] \u2705 Parsing r\u00E9ussi !');\r\n    console.log('[DEBUG FORMIDABLE] \uD83D\uDCDD Fields:', Object.keys(fields));\r\n    console.log('[DEBUG FORMIDABLE] \uD83D\uDCCE Files:', Object.keys(files));\r\n\r\n    // Transformer pour \u00EAtre compatible avec l'API existante\r\n    req.body = {};\r\n    for (const [key, value] of Object.entries(fields)) {\r\n      req.body[key] = Array.isArray(value) ? value[0] : value;\r\n    }\r\n\r\n    req.files = {};\r\n    for (const [key, fileArray] of Object.entries(files)) {\r\n      const fileList = Array.isArray(fileArray) ? fileArray : [fileArray];\r\n      req.files[key] = fileList.map((file: any) => ({\r\n        name: file.originalFilename || file.newFilename,\r\n        data: fs.readFileSync(file.filepath), // Lire le fichier en Buffer\r\n        size: file.size,\r\n        mimetype: file.mimetype,\r\n        tempFilePath: file.filepath, // Pour nettoyage ult\u00E9rieur\r\n      }));\r\n    }\r\n\r\n    console.log('[DEBUG FORMIDABLE] \uD83D\uDD04 Donn\u00E9es transform\u00E9es pour compatibilit\u00E9');\r\n    console.log('[DEBUG FORMIDABLE] ==================== FIN ANALYSE REQU\u00CATE ====================');\r\n\r\n    // Nettoyer les fichiers temporaires apr\u00E8s la requ\u00EAte\r\n    res.on('finish', () => {\r\n      for (const [, fileArray] of Object.entries(files)) {\r\n        const fileList = Array.isArray(fileArray) ? fileArray : [fileArray];\r\n        fileList.forEach((file: any) => {\r\n          if (fs.existsSync(file.filepath)) {\r\n            fs.unlinkSync(file.filepath);\r\n            console.log('[DEBUG FORMIDABLE] \uD83D\uDDD1\uFE0F Fichier temporaire supprim\u00E9:', file.filepath);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    next();\r\n  });\r\n};\r\n\r\nconst router = Router();\r\n\r\n// Routes pour les messages\r\nrouter.get('/messages', getMessages);\r\nrouter.get('/messages/:id', getMessage);\r\nrouter.patch('/messages/:id', modifyMessage);\r\nrouter.delete('/messages/:id', deleteMessage);\r\nrouter.post('/messages/:id/trash', trashMessage);\r\nrouter.post('/messages/:id/untrash', untrashMessage);\r\n\r\n// Routes pour la corbeille\r\nrouter.post('/trash/empty', emptyTrash);\r\n\r\n// Routes pour les brouillons\r\nrouter.get('/drafts', getDrafts);\r\nrouter.post('/drafts', formidableMiddleware, saveDraft); // \uD83D\uDD04 Ajout support pi\u00E8ces jointes avec Formidable\r\nrouter.delete('/drafts/:id', deleteDraft);\r\nrouter.post('/drafts/:id/send', sendDraft);\r\n\r\n// \uD83C\uDD95 Route d'envoi direct avec support des pi\u00E8ces jointes - NOUVELLE VERSION avec Formidable (plus robuste)\r\nrouter.post('/send', formidableMiddleware, (req: Request, res: Response, next: NextFunction) => {\r\n  console.log('[ROUTE SEND] \uD83D\uDE80 === D\u00C9BUT TRAITEMENT ROUTE /send (FORMIDABLE) ===');\r\n  \r\n  // Augmenter le timeout pour cette route sp\u00E9cifique\r\n  req.setTimeout(300000); // 5 minutes au lieu du timeout par d\u00E9faut\r\n  res.setTimeout(300000);\r\n  \r\n  console.log('[ROUTE SEND] \u23F0 Timeouts configur\u00E9s \u00E0 5 minutes');\r\n  console.log('[ROUTE SEND] \uD83D\uDCDD req.body apr\u00E8s Formidable:', req.body);\r\n  console.log('[ROUTE SEND] \uD83D\uDCCE req.files apr\u00E8s Formidable:', req.files);\r\n  \r\n  // V\u00E9rifier si des fichiers ont \u00E9t\u00E9 upload\u00E9s\r\n  if (req.files) {\r\n    console.log('[ROUTE SEND] \uD83D\uDCCE Fichiers d\u00E9tect\u00E9s:');\r\n    Object.keys(req.files).forEach(fieldName => {\r\n      const files = (req.files as any)[fieldName];\r\n      if (Array.isArray(files)) {\r\n        console.log('[ROUTE SEND] \uD83D\uDCCE', fieldName, ':', files.length, 'fichiers');\r\n        files.forEach((file: any, index: number) => {\r\n          console.log('[ROUTE SEND] \uD83D\uDCCE   -', index + 1, ':', file.name, '(', file.size, 'bytes)');\r\n        });\r\n      } else {\r\n        console.log('[ROUTE SEND] \uD83D\uDCCE', fieldName, ':', files.name, '(', files.size, 'bytes)');\r\n      }\r\n    });\r\n  } else {\r\n    console.log('[ROUTE SEND] \uD83D\uDCCE Aucun fichier d\u00E9tect\u00E9');\r\n  }\r\n  \r\n  console.log('[ROUTE SEND] \u2705 Formidable a trait\u00E9 la requ\u00EAte SANS ERREUR');\r\n  console.log('[ROUTE SEND] \u2705 Transfert vers sendMessage...');\r\n  \r\n  // Formidable a d\u00E9j\u00E0 pars\u00E9 les donn\u00E9es, on peut directement passer au contr\u00F4leur\r\n  next();\r\n}, sendMessage);\r\n\r\n// Routes pour les labels\r\nrouter.get('/labels', getLabels);\r\nrouter.post('/labels', createLabel);\r\nrouter.patch('/labels/:id', updateLabel);\r\nrouter.delete('/labels/:id', deleteLabel);\r\n\r\n// Routes pour les pi\u00E8ces jointes\r\nrouter.get('/messages/:messageId/attachments/:id', getAttachment);\r\n\r\nexport default router;\r\n", "import winston from 'winston';\r\nimport DailyRotateFile from 'winston-daily-rotate-file';\r\nimport path from 'path';\r\n\r\n// \uD83D\uDD12 Configuration du logger de s\u00E9curit\u00E9 Enterprise\r\nconst securityLogger = winston.createLogger({\r\n  level: 'info',\r\n  format: winston.format.combine(\r\n    winston.format.timestamp({\r\n      format: 'YYYY-MM-DD HH:mm:ss'\r\n    }),\r\n    winston.format.errors({ stack: true }),\r\n    winston.format.json(),\r\n    winston.format.printf(({ timestamp, level, message, ...meta }) => {\r\n      return JSON.stringify({\r\n        timestamp,\r\n        level: level.toUpperCase(),\r\n        message,\r\n        ...sanitizeLogData(meta)\r\n      });\r\n    })\r\n  ),\r\n  defaultMeta: { service: 'crm-security' },\r\n  transports: [\r\n    // Console pour d\u00E9veloppement\r\n    new winston.transports.Console({\r\n      format: winston.format.combine(\r\n        winston.format.colorize(),\r\n        winston.format.simple(),\r\n        winston.format.printf(({ timestamp, level, message, ...meta }) => {\r\n          const sanitized = sanitizeLogData(meta);\r\n          return `${timestamp} [${level}]: ${message} ${Object.keys(sanitized).length ? JSON.stringify(sanitized) : ''}`;\r\n        })\r\n      )\r\n    }),\r\n    \r\n    // Fichier de log rotatif pour la s\u00E9curit\u00E9\r\n    new DailyRotateFile({\r\n      filename: path.join(process.cwd(), 'logs', 'security-%DATE%.log'),\r\n      datePattern: 'YYYY-MM-DD',\r\n      zippedArchive: true,\r\n      maxSize: '20m',\r\n      maxFiles: '14d',\r\n      createSymlink: true,\r\n      symlinkName: 'security-current.log'\r\n    }),\r\n    \r\n    // Fichier s\u00E9par\u00E9 pour les erreurs critiques\r\n    new DailyRotateFile({\r\n      filename: path.join(process.cwd(), 'logs', 'security-errors-%DATE%.log'),\r\n      datePattern: 'YYYY-MM-DD',\r\n      level: 'error',\r\n      zippedArchive: true,\r\n      maxSize: '20m',\r\n      maxFiles: '30d'\r\n    })\r\n  ]\r\n});\r\n\r\n// \uD83D\uDEE1\uFE0F Fonction de sanitisation des donn\u00E9es sensibles\r\nfunction sanitizeLogData(data: any): any {\r\n  if (!data || typeof data !== 'object') return data;\r\n  \r\n  const sensitiveFields = [\r\n    'password', 'token', 'secret', 'key', 'auth', 'authorization',\r\n    'cookie', 'session', 'csrf', 'api_key', 'access_token', 'refresh_token'\r\n  ];\r\n  \r\n  const sanitized = { ...data };\r\n  \r\n  Object.keys(sanitized).forEach(key => {\r\n    const lowerKey = key.toLowerCase();\r\n    if (sensitiveFields.some(field => lowerKey.includes(field))) {\r\n      sanitized[key] = '[REDACTED]';\r\n    } else if (typeof sanitized[key] === 'object' && sanitized[key] !== null) {\r\n      sanitized[key] = sanitizeLogData(sanitized[key]);\r\n    }\r\n  });\r\n  \r\n  return sanitized;\r\n}\r\n\r\n// \uD83D\uDEA8 Fonction pour logger les \u00E9v\u00E9nements de s\u00E9curit\u00E9\r\nexport function logSecurityEvent(\r\n  eventType: string, \r\n  details: Record<string, any>, \r\n  level: 'info' | 'warn' | 'error' = 'info'\r\n) {\r\n  const securityEvent = {\r\n    eventType,\r\n    timestamp: new Date().toISOString(),\r\n    details: sanitizeLogData(details),\r\n    severity: level,\r\n    source: 'CRM_SECURITY_SYSTEM'\r\n  };\r\n  \r\n  securityLogger[level](`SECURITY_EVENT: ${eventType}`, securityEvent);\r\n  \r\n  // \uD83D\uDD14 Alertes pour \u00E9v\u00E9nements critiques\r\n  if (level === 'error' || eventType.includes('ATTACK') || eventType.includes('BREACH')) {\r\n    console.error(`\uD83D\uDEA8 ALERTE S\u00C9CURIT\u00C9: ${eventType}`, securityEvent);\r\n  }\r\n}\r\n\r\n// \uD83D\uDCCA M\u00E9triques de s\u00E9curit\u00E9\r\nexport const securityMetrics = {\r\n  requestCount: 0,\r\n  blockedRequests: 0,\r\n  suspiciousActivity: 0,\r\n  lastReset: new Date()\r\n};\r\n\r\nexport { securityLogger };", "/**\r\n * ROUTES POUR LA GESTION DU SCHEDULER DE REFRESH DES TOKENS GOOGLE\r\n * \r\n * Permet de :\r\n * - V\u00E9rifier l'\u00E9tat du scheduler\r\n * - Forcer un refresh de tous les tokens\r\n * - Refresh un token sp\u00E9cifique\r\n * - Red\u00E9marrer le scheduler\r\n */\r\n\r\nimport { Router, type RequestHandler } from 'express';\r\nimport { googleTokenScheduler } from '../services/GoogleTokenRefreshScheduler';\r\nimport { prisma } from '../lib/prisma';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\n\r\nconst router = Router();\r\n\r\n// S\u00E9curiser toutes les routes du scheduler: n\u00E9cessite authentification + r\u00F4le admin/super_admin\r\nrouter.use(authMiddleware as unknown as RequestHandler);\r\nrouter.use(requireRole(['admin', 'super_admin']));\r\n\r\n/**\r\n * GET /api/google/scheduler/status\r\n * Obtient l'\u00E9tat du scheduler de refresh automatique\r\n */\r\nrouter.get('/status', (_req, res) => {\r\n  try {\r\n    const status = googleTokenScheduler.getStatus();\r\n    \r\n    res.json({\r\n      success: true,\r\n      scheduler: {\r\n        isRunning: status.isRunning,\r\n        checkIntervalMinutes: status.checkIntervalMinutes,\r\n        refreshMarginMinutes: status.refreshMarginMinutes,\r\n        description: status.isRunning \r\n          ? `Scheduler actif - v\u00E9rifications toutes les ${status.checkIntervalMinutes} min, refresh ${status.refreshMarginMinutes} min avant expiration`\r\n          : 'Scheduler arr\u00EAt\u00E9'\r\n      },\r\n      message: status.isRunning \r\n        ? '\u2705 Le scheduler de refresh automatique est actif' \r\n        : '\u26A0\uFE0F Le scheduler de refresh automatique est arr\u00EAt\u00E9'\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleSchedulerAPI] Erreur status:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration du statut',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/google/scheduler/refresh-all\r\n * Force un refresh imm\u00E9diat de tous les tokens\r\n */\r\nrouter.post('/refresh-all', async (_req, res) => {\r\n  try {\r\n    console.log('[GoogleSchedulerAPI] \uD83D\uDD27 Refresh forc\u00E9 demand\u00E9 pour tous les tokens');\r\n    \r\n    await googleTokenScheduler.forceRefreshAll();\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: '\u2705 Refresh forc\u00E9 de tous les tokens termin\u00E9 - v\u00E9rifiez les logs serveur pour les d\u00E9tails'\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleSchedulerAPI] Erreur refresh-all:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors du refresh forc\u00E9',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/google/scheduler/refresh/:organizationId\r\n * Force un refresh d'un token sp\u00E9cifique\r\n */\r\nrouter.post('/refresh/:organizationId', async (req, res) => {\r\n  try {\r\n    const { organizationId } = req.params;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'ID d\\'organisation requis'\r\n      });\r\n    }\r\n    \r\n    console.log(`[GoogleSchedulerAPI] \uD83D\uDD27 Refresh forc\u00E9 demand\u00E9 pour organisation: ${organizationId}`);\r\n    \r\n    await googleTokenScheduler.refreshTokenForOrganization(organizationId);\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: `\u2705 Refresh forc\u00E9 pour l'organisation ${organizationId} termin\u00E9 - v\u00E9rifiez les logs serveur pour les d\u00E9tails`\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleSchedulerAPI] Erreur refresh specific:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors du refresh sp\u00E9cifique',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/google/scheduler/restart\r\n * Red\u00E9marre le scheduler\r\n */\r\nrouter.post('/restart', (_req, res) => {\r\n  try {\r\n    console.log('[GoogleSchedulerAPI] \uD83D\uDD04 Red\u00E9marrage du scheduler demand\u00E9');\r\n    \r\n    googleTokenScheduler.stop();\r\n    googleTokenScheduler.start();\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: '\u2705 Scheduler red\u00E9marr\u00E9 avec succ\u00E8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleSchedulerAPI] Erreur restart:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors du red\u00E9marrage du scheduler',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/google/scheduler/tokens-info\r\n * Obtient des informations sur tous les tokens Google en base\r\n */\r\nrouter.get('/tokens-info', async (_req, res) => {\r\n  try {\r\n    const tokens = await prisma.googleToken.findMany({\r\n      include: {\r\n        organization: {\r\n          select: {\r\n            id: true,\r\n            name: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    const now = new Date();\r\n    const tokensInfo = tokens.map(token => {\r\n      const expiresAt = token.expiresAt;\r\n      let status = 'unknown';\r\n      let minutesToExpiry = null;\r\n      \r\n      if (expiresAt) {\r\n        const timeToExpiry = expiresAt.getTime() - now.getTime();\r\n        minutesToExpiry = Math.round(timeToExpiry / 1000 / 60);\r\n        \r\n        if (expiresAt <= now) {\r\n          status = 'expired';\r\n        } else if (minutesToExpiry <= 10) {\r\n          status = 'expiring_soon';\r\n        } else {\r\n          status = 'valid';\r\n        }\r\n      }\r\n      \r\n      return {\r\n        organizationId: token.organizationId,\r\n        organizationName: token.organization?.name || 'Unknown',\r\n        status,\r\n        expiresAt: expiresAt?.toISOString(),\r\n        minutesToExpiry,\r\n        hasRefreshToken: !!token.refreshToken,\r\n        lastUpdated: token.updatedAt?.toISOString()\r\n      };\r\n    });\r\n\r\n    const summary = {\r\n      total: tokens.length,\r\n      valid: tokensInfo.filter(t => t.status === 'valid').length,\r\n      expiring_soon: tokensInfo.filter(t => t.status === 'expiring_soon').length,\r\n      expired: tokensInfo.filter(t => t.status === 'expired').length,\r\n      unknown: tokensInfo.filter(t => t.status === 'unknown').length\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      summary,\r\n      tokens: tokensInfo\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleSchedulerAPI] Erreur tokens-info:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des informations tokens',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * SCHEDULER DE REFRESH AUTOMATIQUE DES TOKENS GOOGLE\r\n * \r\n * Ce service s'ex\u00E9cute en arri\u00E8re-plan et refresh automatiquement tous les tokens Google\r\n * avant qu'ils n'expirent, \u00E9liminant compl\u00E8tement le besoin de reconnexion manuelle.\r\n * \r\n * PROBL\u00C8ME R\u00C9SOLU :\r\n * - Les tokens Google expirent toutes les heures (3600s)\r\n * - Sans utilisation active, ils expirent et l'utilisateur doit se reconnecter\r\n * - Ce scheduler refresh automatiquement AVANT expiration\r\n * \r\n * FONCTIONNEMENT :\r\n * - V\u00E9rifie toutes les 50 minutes tous les tokens\r\n * - Refresh automatiquement ceux qui expirent dans les 10 prochaines minutes\r\n * - Enregistre l'historique complet dans la base\r\n * - Logs d\u00E9taill\u00E9s pour monitoring\r\n * - Gestion d'erreurs robuste\r\n */\r\n\r\nimport { prisma } from '../lib/prisma';\r\nimport { googleOAuthConfig, isGoogleOAuthConfigured } from '../auth/googleConfig';\r\n\r\nexport class GoogleTokenRefreshScheduler {\r\n  private intervalId: NodeJS.Timeout | null = null;\r\n  private isRunning: boolean = false;\r\n  private readonly REFRESH_INTERVAL = 50 * 60 * 1000; // 50 minutes\r\n  private refreshCount = 0;\r\n  private lastRefreshTime: Date | null = null;\r\n\r\n  constructor() {\r\n    console.log('\uD83D\uDD04 [GoogleTokenScheduler] Scheduler initialis\u00E9');\r\n  }\r\n\r\n  start(): void {\r\n    if (this.isRunning) {\r\n      console.log('\u26A0\uFE0F [GoogleTokenScheduler] Scheduler d\u00E9j\u00E0 en cours d\\'ex\u00E9cution');\r\n      return;\r\n    }\r\n\r\n    this.isRunning = true;\r\n    \r\n    // D\u00E9marrer imm\u00E9diatement un refresh\r\n    this.refreshAllTokens();\r\n    \r\n    // Puis programmer les refreshs p\u00E9riodiques\r\n    this.intervalId = setInterval(() => {\r\n      this.refreshAllTokens();\r\n    }, this.REFRESH_INTERVAL);\r\n\r\n    console.log('\uD83D\uDE80 [GoogleTokenScheduler] Scheduler d\u00E9marr\u00E9 - refresh toutes les 50 minutes');\r\n  }\r\n\r\n  stop(): void {\r\n    if (this.intervalId) {\r\n      clearInterval(this.intervalId);\r\n      this.intervalId = null;\r\n    }\r\n    this.isRunning = false;\r\n    console.log('\u23F9\uFE0F [GoogleTokenScheduler] Scheduler arr\u00EAt\u00E9');\r\n  }\r\n\r\n  getStatus() {\r\n    return {\r\n      isRunning: this.isRunning,\r\n      refreshInterval: this.REFRESH_INTERVAL,\r\n      refreshCount: this.refreshCount,\r\n      lastRefresh: this.lastRefreshTime\r\n    };\r\n  }\r\n\r\n  async forceRefreshAll(): Promise<void> {\r\n    console.log('\uD83D\uDD25 [GoogleTokenScheduler] Refresh forc\u00E9 de tous les tokens');\r\n    await this.refreshAllTokens();\r\n  }\r\n\r\n  private async refreshAllTokens(): Promise<void> {\r\n    try {\r\n      console.log('\uD83D\uDD04 [GoogleTokenScheduler] D\u00E9but du refresh de tous les tokens...');\r\n      this.lastRefreshTime = new Date();\r\n      \r\n      // R\u00E9cup\u00E9rer tous les tokens qui expirent dans moins de 10 minutes\r\n      const tokensToRefresh = await prisma.googleToken.findMany({\r\n        where: {\r\n          OR: [\r\n            // Tokens qui expirent dans moins de 10 minutes\r\n            {\r\n              expiresAt: {\r\n                lte: new Date(Date.now() + 10 * 60 * 1000)\r\n              }\r\n            },\r\n            // Ou tokens sans date d'expiration (consid\u00E9r\u00E9s comme expir\u00E9s)\r\n            {\r\n              expiresAt: null\r\n            }\r\n          ]\r\n        },\r\n        include: {\r\n          Organization: true\r\n        }\r\n      });\r\n\r\n      console.log(`\uD83D\uDD0D [GoogleTokenScheduler] ${tokensToRefresh.length} tokens trouv\u00E9s \u00E0 refresher`);\r\n\r\n      let successCount = 0;\r\n      let errorCount = 0;\r\n\r\n      for (const token of tokensToRefresh) {\r\n        const success = await this.refreshSingleToken(token);\r\n        if (success) {\r\n          successCount++;\r\n        } else {\r\n          errorCount++;\r\n        }\r\n      }\r\n\r\n      this.refreshCount++;\r\n      console.log(`\u2705 [GoogleTokenScheduler] Refresh termin\u00E9: ${successCount} succ\u00E8s, ${errorCount} erreurs`);\r\n    } catch (error) {\r\n      console.error('\u274C [GoogleTokenScheduler] Erreur lors du refresh g\u00E9n\u00E9ral:', error);\r\n    }\r\n  }\r\n\r\n  private async refreshSingleToken(token: { \r\n    id: string; \r\n    organizationId: string; \r\n    refreshToken: string | null; \r\n    expiresAt: Date | null;\r\n    Organization?: { name: string } | null;\r\n  }): Promise<boolean> {\r\n    const oldExpiresAt = token.expiresAt;\r\n    \r\n    try {\r\n      console.log(`\uD83D\uDD04 [GoogleTokenScheduler] Refresh token pour org ${token.organizationId}`);\r\n      \r\n      if (!token.refreshToken) {\r\n        const errorMsg = 'Aucun refresh token disponible';\r\n        console.error(`\u274C [GoogleTokenScheduler] ${errorMsg} pour org ${token.organizationId}`);\r\n        \r\n        await this.logRefreshHistory({\r\n          organizationId: token.organizationId,\r\n          success: false,\r\n          message: errorMsg,\r\n          errorDetails: 'Missing refresh token',\r\n          oldExpiresAt,\r\n          newExpiresAt: null\r\n        });\r\n        return false;\r\n      }\r\n\r\n      if (!isGoogleOAuthConfigured()) {\r\n        throw new Error('Configuration Google OAuth manquante pour GoogleTokenRefreshScheduler.');\r\n      }\r\n\r\n      const { clientId, clientSecret } = googleOAuthConfig;\r\n\r\n      // Appeler l'API Google pour refresher le token\r\n      const response = await fetch('https://oauth2.googleapis.com/token', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/x-www-form-urlencoded',\r\n        },\r\n        body: new URLSearchParams({\r\n          client_id: clientId,\r\n          client_secret: clientSecret,\r\n          refresh_token: token.refreshToken,\r\n          grant_type: 'refresh_token',\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.text();\r\n        const errorMsg = `Erreur Google OAuth: ${response.status}`;\r\n        console.error(`\u274C [GoogleTokenScheduler] ${errorMsg} pour org ${token.organizationId}:`, errorData);\r\n        \r\n        await this.logRefreshHistory({\r\n          organizationId: token.organizationId,\r\n          success: false,\r\n          message: errorMsg,\r\n          errorDetails: errorData,\r\n          oldExpiresAt,\r\n          newExpiresAt: null\r\n        });\r\n        return false;\r\n      }\r\n\r\n      const tokenData = await response.json();\r\n      const newExpiresAt = new Date(Date.now() + (tokenData.expires_in * 1000));\r\n\r\n      // Mettre \u00E0 jour le token dans la base\r\n      await prisma.googleToken.update({\r\n        where: { organizationId: token.organizationId },\r\n        data: {\r\n          accessToken: tokenData.access_token,\r\n          expiresAt: newExpiresAt,\r\n          updatedAt: new Date(),\r\n          // Mettre \u00E0 jour le refresh token s'il y en a un nouveau\r\n          ...(tokenData.refresh_token && { refreshToken: tokenData.refresh_token }),\r\n          // Mettre \u00E0 jour le scope s'il y en a un nouveau\r\n          ...(tokenData.scope && { scope: tokenData.scope })\r\n        }\r\n      });\r\n\r\n      const successMsg = 'Token refreshed successfully';\r\n      console.log(`\u2705 [GoogleTokenScheduler] ${successMsg} pour org ${token.organizationId}, expire \u00E0 ${newExpiresAt.toISOString()}`);\r\n      \r\n      await this.logRefreshHistory({\r\n        organizationId: token.organizationId,\r\n        success: true,\r\n        message: successMsg,\r\n        errorDetails: null,\r\n        oldExpiresAt,\r\n        newExpiresAt\r\n      });\r\n\r\n      return true;\r\n\r\n    } catch (error) {\r\n      const errorMsg = 'Erreur lors du refresh du token';\r\n      const errorDetails = error instanceof Error ? error.message : 'Erreur inconnue';\r\n      \r\n      console.error(`\u274C [GoogleTokenScheduler] ${errorMsg} pour org ${token.organizationId}:`, error);\r\n      \r\n      await this.logRefreshHistory({\r\n        organizationId: token.organizationId,\r\n        success: false,\r\n        message: errorMsg,\r\n        errorDetails,\r\n        oldExpiresAt,\r\n        newExpiresAt: null\r\n      });\r\n\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async logRefreshHistory({\r\n    organizationId,\r\n    success,\r\n    message,\r\n    errorDetails,\r\n    oldExpiresAt,\r\n    newExpiresAt\r\n  }: {\r\n    organizationId: string;\r\n    success: boolean;\r\n    message: string;\r\n    errorDetails: string | null;\r\n    oldExpiresAt: Date | null;\r\n    newExpiresAt: Date | null;\r\n  }): Promise<void> {\r\n    try {\r\n      await prisma.googleTokenRefreshHistory.create({\r\n        data: {\r\n          organizationId,\r\n          success,\r\n          message,\r\n          errorDetails,\r\n          oldExpiresAt,\r\n          newExpiresAt,\r\n          refreshedAt: new Date()\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('\u274C [GoogleTokenScheduler] Erreur lors de l\\'enregistrement de l\\'historique:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// Instance singleton\r\nexport const googleTokenScheduler = new GoogleTokenRefreshScheduler();\r\n", "/**\r\n * ROUTES SP\u00C9CIFIQUES POUR LE MONITORING DES TOKENS GOOGLE\r\n * \r\n * Ces routes sont utilis\u00E9es par le composant GoogleTokenMonitor pour :\r\n * - Obtenir le statut d\u00E9taill\u00E9 du scheduler\r\n * - Obtenir les informations d'un token sp\u00E9cifique\r\n * - Contr\u00F4ler le scheduler (start/stop)\r\n * - Obtenir l'historique des refresh\r\n */\r\n\r\nimport { Router, type RequestHandler } from 'express';\r\nimport { googleTokenScheduler } from '../services/GoogleTokenRefreshScheduler';\r\nimport { prisma } from '../lib/prisma';\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\n\r\nconst router = Router();\r\n\r\n// Auth obligatoire puis contr\u00F4le de r\u00F4le (\u00E9vite 403 quand req.user est vide)\r\nrouter.use(authMiddleware as unknown as RequestHandler);\r\n// Middleware : Seuls les admins ou super_admin peuvent acc\u00E9der \u00E0 ces routes\r\nrouter.use(requireRole(['admin', 'super_admin']));\r\n\r\n/**\r\n * GET /api/google-tokens/scheduler/status\r\n * Statut d\u00E9taill\u00E9 du scheduler pour le monitoring\r\n */\r\nrouter.get('/scheduler/status', async (_req, res) => {\r\n  try {\r\n    const status = googleTokenScheduler.getStatus();\r\n    \r\n    // Compter le nombre total d'utilisateurs avec des tokens Google\r\n    const totalTokens = await prisma.googleToken.count();\r\n    const activeTokens = await prisma.googleToken.count({\r\n      where: {\r\n        expiresAt: {\r\n          gt: new Date()\r\n        }\r\n      }\r\n    });\r\n\r\n    // Obtenir les derni\u00E8res erreurs (s'il y en a)\r\n    // Pour l'instant, nous retournons un tableau vide, mais cela peut \u00EAtre \u00E9tendu\r\n    const recentErrors: Array<{ timestamp: string; message: string; organizationId: string }> = [];\r\n\r\n    const schedulerStatus = {\r\n      isRunning: status.isRunning,\r\n      nextRefresh: status.isRunning ? new Date(Date.now() + 50 * 60 * 1000).toISOString() : null, // 50 min dans le futur\r\n      lastRefresh: null, // \u00C0 impl\u00E9menter si n\u00E9cessaire\r\n      refreshCount: 0, // \u00C0 impl\u00E9menter si n\u00E9cessaire\r\n      totalUsers: totalTokens,\r\n      activeTokens: activeTokens,\r\n      errors: recentErrors\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      data: schedulerStatus\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleTokensAPI] Erreur status:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration du statut',\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/google-tokens/organization/:organizationId\r\n * Informations d\u00E9taill\u00E9es sur le token d'une organisation\r\n */\r\nrouter.get('/organization/:organizationId', async (req, res) => {\r\n  try {\r\n    const { organizationId } = req.params;\r\n\r\n    const token = await prisma.googleToken.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    if (!token) {\r\n      return res.json({\r\n        success: false,\r\n        message: 'Aucun token trouv\u00E9 pour cette organisation'\r\n      });\r\n    }\r\n\r\n    const now = new Date();\r\n    const expiresAt = token.expiresAt;\r\n    const isExpired = expiresAt ? expiresAt <= now : true;\r\n    \r\n    let timeUntilExpiry = 'N/A';\r\n    if (expiresAt && !isExpired) {\r\n      const diff = expiresAt.getTime() - now.getTime();\r\n      const minutes = Math.floor(diff / 1000 / 60);\r\n      const seconds = Math.floor((diff % (1000 * 60)) / 1000);\r\n      timeUntilExpiry = `${minutes}m ${seconds}s`;\r\n    } else if (isExpired) {\r\n      timeUntilExpiry = 'Expir\u00E9';\r\n    }\r\n\r\n    const tokenInfo = {\r\n      id: token.id,\r\n      organizationId: token.organizationId,\r\n      accessToken: token.accessToken ? `${token.accessToken.substring(0, 20)}...` : '', // Masquer le token\r\n      refreshToken: token.refreshToken ? 'Pr\u00E9sent' : 'Absent',\r\n      tokenType: token.tokenType || 'Bearer',\r\n      expiresIn: 3600, // Les tokens Google durent 1 heure\r\n      scope: token.scope || '',\r\n      createdAt: token.createdAt?.toISOString() || '',\r\n      updatedAt: token.updatedAt?.toISOString() || '',\r\n      expiresAt: expiresAt?.toISOString() || '',\r\n      isExpired,\r\n      timeUntilExpiry\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      data: tokenInfo\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleTokensAPI] Erreur organization token:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration du token',\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/google-tokens/scheduler/start\r\n * D\u00E9marre le scheduler\r\n */\r\nrouter.post('/scheduler/start', (_req, res) => {\r\n  try {\r\n    googleTokenScheduler.start();\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Scheduler d\u00E9marr\u00E9 avec succ\u00E8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleTokensAPI] Erreur start scheduler:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors du d\u00E9marrage du scheduler',\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/google-tokens/scheduler/stop\r\n * Arr\u00EAte le scheduler\r\n */\r\nrouter.post('/scheduler/stop', (_req, res) => {\r\n  try {\r\n    googleTokenScheduler.stop();\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Scheduler arr\u00EAt\u00E9 avec succ\u00E8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleTokensAPI] Erreur stop scheduler:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de l\\'arr\u00EAt du scheduler',\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/google-tokens/scheduler/refresh-now\r\n * Force un refresh imm\u00E9diat de tous les tokens\r\n */\r\nrouter.post('/scheduler/refresh-now', async (_req, res) => {\r\n  try {\r\n    await googleTokenScheduler.forceRefreshAll();\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Refresh imm\u00E9diat lanc\u00E9 avec succ\u00E8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleTokensAPI] Erreur refresh now:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors du refresh imm\u00E9diat',\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/google-tokens/refresh-history/:organizationId\r\n * Historique des refresh pour une organisation\r\n */\r\nrouter.get('/refresh-history/:organizationId', async (req, res) => {\r\n  try {\r\n    const { organizationId } = req.params;\r\n    \r\n    // R\u00E9cup\u00E9rer l'historique des refresh pour cette organisation\r\n    const history = await prisma.googleTokenRefreshHistory.findMany({\r\n      where: {\r\n        organizationId\r\n      },\r\n      orderBy: {\r\n        refreshedAt: 'desc'\r\n      },\r\n      take: 50 // Limiter aux 50 derniers\r\n    });\r\n\r\n    // Transformer les donn\u00E9es pour l'interface\r\n    const formattedHistory = history.map(entry => ({\r\n      id: entry.id,\r\n      timestamp: entry.refreshedAt.toISOString(),\r\n      success: entry.success,\r\n      message: entry.message,\r\n      errorDetails: entry.errorDetails,\r\n      oldExpiresAt: entry.oldExpiresAt?.toISOString(),\r\n      newExpiresAt: entry.newExpiresAt?.toISOString()\r\n    }));\r\n\r\n    res.json({\r\n      success: true,\r\n      data: formattedHistory\r\n    });\r\n  } catch (error) {\r\n    console.error('[GoogleTokensAPI] Erreur refresh history:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration de l\\'historique',\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, type RequestHandler } from 'express';\r\nimport { type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { z } from 'zod';\r\nimport { decrypt } from '../utils/crypto.js';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Auth obligatoire avant v\u00E9rification de r\u00F4les\r\nrouter.use(authMiddleware as unknown as RequestHandler);\r\n\r\n// Sch\u00E9ma de validation pour la configuration Google Workspace\r\nconst googleWorkspaceConfigSchema = z.object({\r\n  clientId: z.string().min(1, 'Client ID requis'),\r\n  clientSecret: z.string().optional(), // Optionnel pour la mise \u00E0 jour\r\n  redirectUri: z.string().url('URL de redirection invalide').optional(),\r\n  domain: z.string().min(1, 'Domaine requis'),\r\n  adminEmail: z.string().email('Email admin invalide'),\r\n  \r\n  // Champs compte de service\r\n  serviceAccountEmail: z.string().email('Email du compte de service invalide').optional(),\r\n  privateKey: z.string().optional(),\r\n  \r\n  // \u00C9tat de la configuration\r\n  isActive: z.boolean().default(false),\r\n  \r\n  // Modules \u00E0 activer\r\n  gmailEnabled: z.boolean().default(false),\r\n  calendarEnabled: z.boolean().default(false),\r\n  driveEnabled: z.boolean().default(false),\r\n  meetEnabled: z.boolean().default(false),\r\n  docsEnabled: z.boolean().default(false),\r\n  sheetsEnabled: z.boolean().default(false),\r\n  voiceEnabled: z.boolean().default(false),\r\n});\r\n\r\n// GET /api/organizations/:id/google-workspace/config - R\u00E9cup\u00E9rer la configuration\r\nrouter.get('/:id/google-workspace/config', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] GET /organizations/:id/google-workspace/config');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // V\u00E9rification des permissions\r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId !== id) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cette organisation'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer la configuration existante\r\n    const config = await prisma.googleWorkspaceConfig.findUnique({\r\n      where: { organizationId: id }\r\n    });\r\n    \r\n    if (!config) {\r\n      // Retourner une configuration par d\u00E9faut\r\n      return res.json({\r\n        success: true,\r\n        data: {\r\n          isConfigured: false,\r\n          clientId: '',\r\n          clientSecret: '',\r\n          redirectUri: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/api/auth/google/callback`,\r\n          domain: '',\r\n          adminEmail: '',\r\n          serviceAccountEmail: '',\r\n          privateKey: '',\r\n          isActive: false,\r\n          gmailEnabled: false,\r\n          calendarEnabled: false,\r\n          driveEnabled: false,\r\n          meetEnabled: false,\r\n          docsEnabled: false,\r\n          sheetsEnabled: false,\r\n          voiceEnabled: false,\r\n          enabled: false\r\n        }\r\n      });\r\n    }\r\n    \r\n    // D\u00E9crypter les valeurs sensibles pour les afficher dans l'interface\r\n    const isCompleteConfig = !!(config.clientId && config.clientSecret && config.domain && config.adminEmail);\r\n    \r\n    const safeConfig = {\r\n      isConfigured: isCompleteConfig,\r\n      clientId: config.clientId || '',\r\n      clientSecret: config.clientSecret ? decrypt(config.clientSecret) : '', // Afficher la vraie valeur d\u00E9crypt\u00E9e\r\n      hasClientSecret: !!config.clientSecret,\r\n      redirectUri: config.redirectUri || `${process.env.FRONTEND_URL || 'http://localhost:3000'}/api/auth/google/callback`,\r\n      domain: config.domain || '',\r\n      adminEmail: config.adminEmail || '',\r\n      serviceAccountEmail: config.serviceAccountEmail || '',\r\n      privateKey: config.privateKey ? decrypt(config.privateKey) : '', // Afficher la vraie valeur d\u00E9crypt\u00E9e\r\n      hasPrivateKey: !!config.privateKey,\r\n      isActive: config.enabled || false,\r\n      gmailEnabled: config.gmailEnabled,\r\n      calendarEnabled: config.calendarEnabled,\r\n      driveEnabled: config.driveEnabled,\r\n      meetEnabled: config.meetEnabled,\r\n      docsEnabled: config.docsEnabled,\r\n      sheetsEnabled: config.sheetsEnabled,\r\n      voiceEnabled: config.voiceEnabled,\r\n      enabled: config.enabled && isCompleteConfig // Enabled seulement si config compl\u00E8te\r\n    };\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: safeConfig\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur GET config:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration de la configuration'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/organizations/:id/google-workspace/config - Sauvegarder la configuration\r\nrouter.post('/:id/google-workspace/config', requireRole(['super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] POST /organizations/:id/google-workspace/config');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // Seuls les super admins peuvent configurer Google Workspace\r\n    if (requestingUser?.role !== 'super_admin') {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Seuls les Super Admins peuvent configurer Google Workspace'\r\n      });\r\n    }\r\n    \r\n    // Validation des donn\u00E9es\r\n    const validationResult = googleWorkspaceConfigSchema.safeParse(req.body);\r\n    if (!validationResult.success) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Donn\u00E9es invalides',\r\n        errors: validationResult.error.errors\r\n      });\r\n    }\r\n    \r\n    const data = validationResult.data;\r\n    \r\n    // V\u00E9rifier que l'organisation existe\r\n    const organization = await prisma.organization.findUnique({\r\n      where: { id }\r\n    });\r\n    \r\n    if (!organization) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Organisation non trouv\u00E9e'\r\n      });\r\n    }\r\n    \r\n    // URL de redirection par d\u00E9faut si non fournie\r\n    const redirectUri = data.redirectUri || `${process.env.FRONTEND_URL || 'http://localhost:3000'}/api/auth/google/callback`;\r\n    \r\n    // R\u00E9cup\u00E9rer la configuration existante\r\n    const existingConfig = await prisma.googleWorkspaceConfig.findUnique({\r\n      where: { organizationId: id }\r\n    });\r\n    \r\n    // Pr\u00E9parer les donn\u00E9es \u00E0 sauvegarder\r\n    const configData = {\r\n      clientId: data.clientId,\r\n      clientSecret: data.clientSecret || existingConfig?.clientSecret, // Garder l'ancien si vide\r\n      redirectUri: redirectUri,\r\n      domain: data.domain,\r\n      adminEmail: data.adminEmail,\r\n      serviceAccountEmail: data.serviceAccountEmail || existingConfig?.serviceAccountEmail,\r\n      privateKey: data.privateKey || existingConfig?.privateKey,\r\n      enabled: data.isActive || false,\r\n      gmailEnabled: data.gmailEnabled,\r\n      calendarEnabled: data.calendarEnabled,\r\n      driveEnabled: data.driveEnabled,\r\n      meetEnabled: data.meetEnabled,\r\n      docsEnabled: data.docsEnabled,\r\n      sheetsEnabled: data.sheetsEnabled,\r\n      voiceEnabled: data.voiceEnabled,\r\n      updatedAt: new Date()\r\n    };\r\n    \r\n    // Upsert de la configuration\r\n    const config = await prisma.googleWorkspaceConfig.upsert({\r\n      where: { organizationId: id },\r\n      update: configData,\r\n      create: {\r\n        organizationId: id,\r\n        ...configData\r\n      }\r\n    });\r\n    \r\n    console.log(`[GOOGLE-WORKSPACE] Configuration sauvegard\u00E9e pour l'organisation ${id}`);\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Configuration Google Workspace sauvegard\u00E9e avec succ\u00E8s',\r\n      data: {\r\n        id: config.id,\r\n        enabled: config.enabled\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur POST config:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la sauvegarde de la configuration'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/organizations/:id/google-workspace/auth-url - G\u00E9n\u00E9rer l'URL d'authentification\r\nrouter.get('/:id/google-workspace/auth-url', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] GET /organizations/:id/google-workspace/auth-url');\r\n  \r\n  try {\r\n    const { id } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // V\u00E9rification des permissions\r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId !== id) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cette organisation'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer la configuration Google Workspace\r\n    const config = await prisma.googleWorkspaceConfig.findUnique({\r\n      where: { organizationId: id }\r\n    });\r\n    \r\n    if (!config) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Configuration Google Workspace non trouv\u00E9e. Veuillez d\\'abord configurer les credentials.'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier que tous les champs requis sont pr\u00E9sents\r\n    const missingFields = [];\r\n    if (!config.clientId) missingFields.push('Client ID');\r\n    if (!config.clientSecret) missingFields.push('Client Secret');\r\n    if (!config.domain) missingFields.push('Domaine');\r\n    if (!config.adminEmail) missingFields.push('Email Admin');\r\n    \r\n    if (missingFields.length > 0) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: `Configuration incompl\u00E8te. Champs manquants : ${missingFields.join(', ')}`\r\n      });\r\n    }\r\n    \r\n    if (!config.enabled) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Configuration Google Workspace d\u00E9sactiv\u00E9e'\r\n      });\r\n    }\r\n    \r\n    // G\u00E9n\u00E9rer l'URL d'authentification OAuth\r\n    const scopes = [\r\n      'https://www.googleapis.com/auth/userinfo.email',\r\n      'https://www.googleapis.com/auth/userinfo.profile'\r\n    ];\r\n    \r\n    // Ajouter les scopes selon les modules activ\u00E9s\r\n    if (config.gmailEnabled) {\r\n      scopes.push('https://mail.google.com/'); // SCOPE COMPLET pour suppression d\u00E9finitive\r\n      scopes.push('https://www.googleapis.com/auth/gmail.readonly');\r\n      scopes.push('https://www.googleapis.com/auth/gmail.send');\r\n      scopes.push('https://www.googleapis.com/auth/gmail.modify');\r\n    }\r\n    if (config.calendarEnabled) {\r\n      scopes.push('https://www.googleapis.com/auth/calendar');\r\n      scopes.push('https://www.googleapis.com/auth/calendar.events');\r\n    }\r\n    if (config.driveEnabled) {\r\n      scopes.push('https://www.googleapis.com/auth/drive');\r\n    }\r\n    // Scopes additionnels pour fonctionnalit\u00E9s compl\u00E8tes\r\n    if (config.docsEnabled) {\r\n      scopes.push('https://www.googleapis.com/auth/documents');\r\n    }\r\n    if (config.sheetsEnabled) {\r\n      scopes.push('https://www.googleapis.com/auth/spreadsheets');\r\n    }\r\n    if (config.meetEnabled) {\r\n      scopes.push('https://www.googleapis.com/auth/meetings');\r\n    }\r\n    // Scopes avanc\u00E9s pour CRM complet\r\n    scopes.push('https://www.googleapis.com/auth/presentations');\r\n    scopes.push('https://www.googleapis.com/auth/contacts');\r\n    scopes.push('https://www.googleapis.com/auth/forms');\r\n    \r\n    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +\r\n      `client_id=${encodeURIComponent(config.clientId)}&` +\r\n      `redirect_uri=${encodeURIComponent(config.redirectUri || '')}&` +\r\n      `response_type=code&` +\r\n      `scope=${encodeURIComponent(scopes.join(' '))}&` +\r\n      `state=${encodeURIComponent(JSON.stringify({ organizationId: id, userId: requestingUser?.id }))}&` +\r\n      `access_type=offline&` +\r\n      `prompt=consent`;\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        authUrl,\r\n        scopes: scopes\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur GET auth-url:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la g\u00E9n\u00E9ration de l\\'URL d\\'authentification'\r\n    });\r\n  }\r\n});\r\n\r\n// ===================================\r\n// ROUTES POUR LA GESTION DES UTILISATEURS GOOGLE WORKSPACE\r\n// ===================================\r\n\r\n// GET /api/google-workspace/users/:userId/status - R\u00E9cup\u00E9rer le statut Google Workspace d'un utilisateur\r\nrouter.get('/users/:userId/status', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] GET /users/:userId/status');\r\n  \r\n  try {\r\n    const { userId } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // R\u00E9cup\u00E9rer l'utilisateur cible\r\n    const targetUser = await prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            Organization: {\r\n              include: {\r\n                GoogleWorkspaceConfig: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!targetUser) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Utilisateur non trouv\u00E9'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier les permissions\r\n    const userOrg = targetUser.UserOrganization?.[0];\r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId !== userOrg?.organizationId) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cet utilisateur'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer la configuration Google Workspace de l'organisation\r\n    const googleConfig = userOrg?.Organization?.GoogleWorkspaceConfig;\r\n    \r\n    // R\u00E9cup\u00E9rer le statut Google de l'utilisateur\r\n    const googleUserStatus = await prisma.googleWorkspaceUser.findUnique({\r\n      where: { userId: userId }\r\n    });\r\n    \r\n    // G\u00E9n\u00E9rer l'email automatiquement si pas encore d\u00E9fini\r\n    const normalizeString = (str: string): string => {\r\n      return str\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '') // Supprimer les accents\r\n        .replace(/[^a-zA-Z0-9]/g, '') // Supprimer caract\u00E8res sp\u00E9ciaux\r\n        .trim();\r\n    };\r\n    \r\n    const generateEmail = (firstName: string, lastName: string, domain: string): string => {\r\n      const normalizedFirstName = normalizeString(firstName);\r\n      const normalizedLastName = normalizeString(lastName);\r\n      return `${normalizedFirstName}.${normalizedLastName}@${domain}`;\r\n    };\r\n    \r\n    let suggestedEmail = '';\r\n    if (googleConfig?.domain) {\r\n      suggestedEmail = generateEmail(targetUser.firstName, targetUser.lastName, googleConfig.domain);\r\n    }\r\n    \r\n    const status = {\r\n      hasGoogleAccount: !!googleUserStatus,\r\n      email: googleUserStatus?.email || suggestedEmail,\r\n      isActivated: googleUserStatus?.isActive || false,\r\n      organizationDomain: googleConfig?.domain || null,\r\n      lastSync: googleUserStatus?.lastSync?.toISOString() || null,\r\n      services: {\r\n        gmail: googleUserStatus?.gmailEnabled || false,\r\n        calendar: googleUserStatus?.calendarEnabled || false,\r\n        drive: googleUserStatus?.driveEnabled || false,\r\n        meet: googleUserStatus?.meetEnabled || false,\r\n      }\r\n    };\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: status\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur GET status:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration du statut'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/google-workspace/users/create - Cr\u00E9er un compte Google Workspace pour un utilisateur\r\nrouter.post('/users/create', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] POST /users/create');\r\n  \r\n  try {\r\n    const { userId, email, activateServices = true } = req.body;\r\n    const requestingUser = req.user;\r\n    \r\n    // Validation basique\r\n    if (!userId || !email) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'userId et email sont requis'\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer l'utilisateur cible\r\n    const targetUser = await prisma.user.findUnique({\r\n      where: { id: userId },\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            Organization: {\r\n              include: {\r\n                GoogleWorkspaceConfig: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!targetUser) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Utilisateur non trouv\u00E9'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier les permissions\r\n    const userOrg = targetUser.UserOrganization?.[0];\r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId !== userOrg?.organizationId) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cet utilisateur'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier que l'organisation a Google Workspace configur\u00E9\r\n    const googleConfig = userOrg?.Organization?.GoogleWorkspaceConfig;\r\n    if (!googleConfig || !googleConfig.isActive) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Google Workspace n\\'est pas configur\u00E9 pour cette organisation'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier si l'utilisateur a d\u00E9j\u00E0 un compte Google Workspace\r\n    const existingGoogleUser = await prisma.googleWorkspaceUser.findUnique({\r\n      where: { userId: userId }\r\n    });\r\n    \r\n    if (existingGoogleUser) {\r\n      // Mettre \u00E0 jour le compte existant\r\n      const updatedGoogleUser = await prisma.googleWorkspaceUser.update({\r\n        where: { userId: userId },\r\n        data: {\r\n          email: email,\r\n          isActive: activateServices,\r\n          gmailEnabled: activateServices && googleConfig.gmailEnabled,\r\n          calendarEnabled: activateServices && googleConfig.calendarEnabled,\r\n          driveEnabled: activateServices && googleConfig.driveEnabled,\r\n          meetEnabled: activateServices && googleConfig.meetEnabled,\r\n          lastSync: new Date()\r\n        }\r\n      });\r\n      \r\n      res.json({\r\n        success: true,\r\n        message: 'Compte Google Workspace mis \u00E0 jour avec succ\u00E8s',\r\n        data: updatedGoogleUser\r\n      });\r\n    } else {\r\n      // Cr\u00E9er un nouveau compte Google Workspace\r\n      const newGoogleUser = await prisma.googleWorkspaceUser.create({\r\n        data: {\r\n          userId: userId,\r\n          email: email,\r\n          isActive: activateServices,\r\n          gmailEnabled: activateServices && googleConfig.gmailEnabled,\r\n          calendarEnabled: activateServices && googleConfig.calendarEnabled,\r\n          driveEnabled: activateServices && googleConfig.driveEnabled,\r\n          meetEnabled: activateServices && googleConfig.meetEnabled,\r\n          lastSync: new Date()\r\n        }\r\n      });\r\n      \r\n      res.json({\r\n        success: true,\r\n        message: 'Compte Google Workspace cr\u00E9\u00E9 avec succ\u00E8s',\r\n        data: newGoogleUser\r\n      });\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur POST create:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la cr\u00E9ation du compte'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/google-workspace/users/:userId/sync - Synchroniser un utilisateur avec Google Workspace\r\nrouter.post('/users/:userId/sync', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] POST /users/:userId/sync');\r\n  \r\n  try {\r\n    const { userId } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // R\u00E9cup\u00E9rer l'utilisateur Google Workspace\r\n    const googleUser = await prisma.googleWorkspaceUser.findUnique({\r\n      where: { userId: userId },\r\n      include: {\r\n        User: {\r\n          include: {\r\n            UserOrganization: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!googleUser) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Compte Google Workspace non trouv\u00E9 pour cet utilisateur'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier les permissions\r\n    const userOrg = googleUser.User.UserOrganization?.[0];\r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId !== userOrg?.organizationId) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cet utilisateur'\r\n      });\r\n    }\r\n    \r\n    // Mettre \u00E0 jour la date de synchronisation\r\n    const updatedGoogleUser = await prisma.googleWorkspaceUser.update({\r\n      where: { userId: userId },\r\n      data: {\r\n        lastSync: new Date()\r\n      }\r\n    });\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Synchronisation r\u00E9ussie',\r\n      data: updatedGoogleUser\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur POST sync:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la synchronisation'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/google-workspace/users/:userId/deactivate - D\u00E9sactiver un utilisateur Google Workspace\r\nrouter.post('/users/:userId/deactivate', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[GOOGLE-WORKSPACE] POST /users/:userId/deactivate');\r\n  \r\n  try {\r\n    const { userId } = req.params;\r\n    const requestingUser = req.user;\r\n    \r\n    // R\u00E9cup\u00E9rer l'utilisateur Google Workspace\r\n    const googleUser = await prisma.googleWorkspaceUser.findUnique({\r\n      where: { userId: userId },\r\n      include: {\r\n        User: {\r\n          include: {\r\n            UserOrganization: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!googleUser) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Compte Google Workspace non trouv\u00E9 pour cet utilisateur'\r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier les permissions\r\n    const userOrg = googleUser.User.UserOrganization?.[0];\r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId !== userOrg?.organizationId) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        message: 'Acc\u00E8s refus\u00E9 \u00E0 cet utilisateur'\r\n      });\r\n    }\r\n    \r\n    // D\u00E9sactiver le compte\r\n    const updatedGoogleUser = await prisma.googleWorkspaceUser.update({\r\n      where: { userId: userId },\r\n      data: {\r\n        isActive: false,\r\n        gmailEnabled: false,\r\n        calendarEnabled: false,\r\n        driveEnabled: false,\r\n        meetEnabled: false,\r\n        lastSync: new Date()\r\n      }\r\n    });\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Compte Google Workspace d\u00E9sactiv\u00E9 avec succ\u00E8s',\r\n      data: updatedGoogleUser\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[GOOGLE-WORKSPACE] Erreur POST deactivate:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la d\u00E9sactivation'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { PrismaClient, Block, Section, Field, FieldOption } from '@prisma/client';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { adaptBlockStructure } from '../helpers/adaptBlockStructure';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\nrouter.use(authMiddleware as unknown as (req: Request, res: Response, next: () => void) => void, impersonationMiddleware as unknown as (req: Request, res: Response, next: () => void) => void);\r\n\r\n// Petit helper de r\u00E9silience: ajoute la colonne sectionType si absente\r\nasync function ensureSectionTypeColumnExists() {\r\n  try {\r\n    await prisma.$executeRawUnsafe(\r\n      'ALTER TABLE \"Section\" ADD COLUMN IF NOT EXISTS \"sectionType\" TEXT NOT NULL DEFAULT \\'normal\\''\r\n    );\r\n  } catch (e) {\r\n    // silencieux, on laissera l'erreur initiale si autre probl\u00E8me\r\n    console.warn('[API] ensureSectionTypeColumnExists (blocks.ts) - avertissement:', e);\r\n  }\r\n}\r\n\r\n// GET tous les blocks d'une organisation\r\nrouter.get('/', \r\n  // Middleware anti-cache pour forcer le rechargement\r\n  (req, res, next) => {\r\n    res.set({\r\n      'Cache-Control': 'no-cache, no-store, must-revalidate',\r\n      'Pragma': 'no-cache',\r\n      'Expires': '0',\r\n      'ETag': false,\r\n      'Last-Modified': false\r\n    });\r\n    \r\n    // D\u00E9sactiver aussi les headers de cache de la requ\u00EAte\r\n    if (req.headers['if-none-match']) delete req.headers['if-none-match'];\r\n    if (req.headers['if-modified-since']) delete req.headers['if-modified-since'];\r\n    \r\n    next();\r\n  },\r\n  requireRole(['admin', 'super_admin']), \r\n  async (req: Request, res: Response): Promise<void> => {\r\n  const user = (req as Request & { user?: { id?: string; organizationId?: string; role?: string; isSuperAdmin?: boolean } }).user; // R\u00E9cup\u00E9rer l'utilisateur depuis le middleware\r\n  \r\n  console.log('[DEBUG] User role:', user?.role);\r\n  console.log('[DEBUG] User:', JSON.stringify(user, null, 2));\r\n  \r\n  // R\u00E9cup\u00E9rer l'organizationId depuis diff\u00E9rentes sources possibles\r\n  const organizationId = req.query.organizationId as string || \r\n                        req.headers['x-organization-id'] as string ||\r\n                        user?.organizationId;\r\n\r\n  console.log(`[API] GET /api/blocks pour org: ${organizationId} par user: ${user?.id || 'undefined'}`);\r\n  console.log(`[API] Sources org ID - query: ${req.query.organizationId}, header: ${req.headers['x-organization-id']}, user: ${user?.organizationId}`);\r\n\r\n  const whereClause: Record<string, unknown> = {};\r\n\r\n  // Si un organizationId est fourni, on l'utilise.\r\n  if (organizationId) {\r\n    whereClause.organizationId = organizationId;\r\n    console.log(`[API] Recherche de blocs pour l'organisation: ${organizationId}`);\r\n  } else if (user?.isSuperAdmin || user?.role === 'super_admin') {\r\n    // Si l'utilisateur est super_admin et qu'aucun ID d'orga n'est fourni,\r\n    // on ne met pas de filtre, ce qui retournera TOUS les blocs.\r\n    console.log('[API] SuperAdmin a demand\u00E9 tous les blocs.');\r\n  } else {\r\n    // Si ce n'est pas un super_admin et qu'il n'y a pas d'ID d'orga, on retourne un tableau vide.\r\n    console.log('[API] Utilisateur non-SuperAdmin sans ID d\\'orga. Retour d\\'un tableau vide.');\r\n    res.json({ success: true, data: [] });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    console.log(`[API] Clause WHERE pour Prisma:`, JSON.stringify(whereClause, null, 2));\r\n    \r\n    const blocks = await prisma.block.findMany({\r\n      where: whereClause,\r\n      include: {\r\n        Section: { // Utilise le nom de la relation d\u00E9fini dans le sch\u00E9ma Prisma\r\n          orderBy: { order: 'asc' },\r\n          include: {\r\n            Field: { // Utilise le nom de la relation\r\n              orderBy: { order: 'asc' },\r\n              include: {\r\n                FieldOption: { // Utilise le nom de la relation\r\n                  orderBy: { order: 'asc' },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    console.log(`[API] Prisma a trouv\u00E9 ${blocks.length} blocks bruts`);\r\n    \r\n    // Debug d\u00E9taill\u00E9 du premier bloc\r\n    if (blocks.length > 0) {\r\n      const firstBlock = blocks[0];\r\n      console.log(`[API] Premier bloc - ID: ${firstBlock.id}, Name: ${firstBlock.name}`);\r\n      console.log(`[API] Premier bloc - Section prop exists: ${'Section' in firstBlock}`);\r\n      console.log(`[API] Premier bloc - Section value: ${Array.isArray(firstBlock.Section) ? firstBlock.Section.length + ' sections' : typeof firstBlock.Section}`);\r\n      \r\n      if (firstBlock.Section && Array.isArray(firstBlock.Section)) {\r\n        console.log(`[API] Section details: ${firstBlock.Section.map(s => `${s.name}(${s.Field?.length || 0} fields)`).join(', ')}`);\r\n      }\r\n    }\r\n    \r\n    console.log(`[API] Blocks trouv\u00E9s:`, blocks.map(b => ({ id: b.id, name: b.name, organizationId: b.organizationId, sectionsCount: b.Section?.length || 0 })));\r\n    \r\n    console.log(`[API] Premier bloc avant adaptation:`, JSON.stringify(blocks[0], null, 2));\r\n\r\n    // Adapter la structure pour correspondre \u00E0 ce que le frontend attend\r\n    type SectionWithFields = Section & { Field: (Field & { FieldOption: FieldOption[] })[] };\r\n    type BlockWithSections = Block & { Section: SectionWithFields[] };\r\n\r\n    console.log(`[API] === D\u00C9BUT ADAPTATION ===`);\r\n    const blocksWithAdaptedStructure = (blocks as BlockWithSections[]).map(adaptBlockStructure);\r\n\r\n    console.log(`[API] Blocks apr\u00E8s adaptation: ${blocksWithAdaptedStructure.length}`);\r\n    if (blocksWithAdaptedStructure.length > 0) {\r\n      console.log(`[API] Premier bloc apr\u00E8s adaptation - ID: ${blocksWithAdaptedStructure[0].id}`);\r\n      console.log(`[API] Premier bloc apr\u00E8s adaptation - sections?: ${blocksWithAdaptedStructure[0].sections ? blocksWithAdaptedStructure[0].sections.length : 'undefined'}`);\r\n      if (blocksWithAdaptedStructure[0].sections && blocksWithAdaptedStructure[0].sections.length > 0) {\r\n        console.log(`[API] Premi\u00E8re section: ${blocksWithAdaptedStructure[0].sections[0].name} avec ${blocksWithAdaptedStructure[0].sections[0].fields?.length || 0} champs`);\r\n      }\r\n    }\r\n    console.log(`[API] === FIN ADAPTATION ===`);\r\n    console.log(`[API] Retour final:`, blocksWithAdaptedStructure.map(b => ({ id: b.id, name: b.name, sectionsCount: b.sections?.length || 0 })));\r\n\r\n    // D\u00E9sactiver le cache pour s'assurer que les donn\u00E9es fra\u00EEches sont retourn\u00E9es\r\n    res.set({\r\n      'Cache-Control': 'no-cache, no-store, must-revalidate',\r\n      'Pragma': 'no-cache',\r\n      'Expires': '0'\r\n    });\r\n\r\n    res.json({ success: true, data: blocksWithAdaptedStructure });\r\n  } catch (error: unknown) {\r\n    console.error(\"[API] Erreur lors de la r\u00E9cup\u00E9ration des blocks:\", error);\r\n    res.status(500).json({ success: false, message: \"Erreur serveur lors de la r\u00E9cup\u00E9ration des formulaires\" });\r\n  }\r\n});\r\n\r\n// GET /api/blocks/read - Lecture S\u00DBRE pour utilisateurs authentifi\u00E9s (m\u00EAme organisation)\r\n// Retourne les formulaires (blocks) de l'organisation de l'utilisateur sans exiger le r\u00F4le admin\r\nrouter.get('/read', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n  const user = (req as Request & { user?: { organizationId?: string } }).user;\r\n    const organizationId = (req.query.organizationId as string) || (req.headers['x-organization-id'] as string) || user?.organizationId;\r\n\r\n    if (!organizationId) {\r\n      res.json({ success: true, data: [] });\r\n      return;\r\n    }\r\n\r\n    const blocks = await prisma.block.findMany({\r\n      where: { organizationId },\r\n      include: {\r\n        Section: {\r\n          orderBy: { order: 'asc' },\r\n          include: {\r\n            Field: {\r\n              orderBy: { order: 'asc' },\r\n              include: { FieldOption: { orderBy: { order: 'asc' } } },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n\r\n    type SectionWithFields = Section & { Field: (Field & { FieldOption: FieldOption[] })[] };\r\n    type BlockWithSections = Block & { Section: SectionWithFields[] };\r\n    const adapted = (blocks as BlockWithSections[]).map(adaptBlockStructure);\r\n    res.json({ success: true, data: adapted });\r\n  } catch (error) {\r\n    console.error('[API] Erreur GET /api/blocks/read:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des formulaires (lecture)' });\r\n  }\r\n});\r\n\r\n// GET /api/blocks/:id/read - Lecture S\u00DBRE d'un formulaire sp\u00E9cifique si appartient \u00E0 l'organisation\r\nrouter.get('/:id/read', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n  const user = (req as Request & { user?: { organizationId?: string } }).user;\r\n    const organizationId = (req.query.organizationId as string) || (req.headers['x-organization-id'] as string) || user?.organizationId;\r\n\r\n    if (!organizationId) {\r\n      res.status(404).json({ success: false, message: 'Formulaire non trouv\u00E9' });\r\n      return;\r\n    }\r\n\r\n    const block = await prisma.block.findFirst({\r\n      where: { id, organizationId },\r\n      include: {\r\n        Section: {\r\n          orderBy: { order: 'asc' },\r\n          include: {\r\n            Field: {\r\n              orderBy: { order: 'asc' },\r\n              include: { FieldOption: { orderBy: { order: 'asc' } } },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!block) {\r\n      res.status(404).json({ success: false, message: 'Formulaire non trouv\u00E9' });\r\n      return;\r\n    }\r\n\r\n  const adapted = adaptBlockStructure(block as unknown as (Block & { Section: (Section & { Field: (Field & { FieldOption: FieldOption[] })[] })[] }));\r\n    res.json({ success: true, data: adapted });\r\n  } catch (error) {\r\n    console.error('[API] Erreur GET /api/blocks/:id/read:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration du formulaire' });\r\n  }\r\n});\r\n\r\n// POST cr\u00E9ation d'un block\r\nrouter.post('/', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const { name, organizationId } = req.body;\r\n  if (!name || !organizationId) {\r\n    res.status(400).json({ success: false, message: 'Nom et organisation requis.' });\r\n    return;\r\n  }\r\n  const block = await prisma.block.create({ data: { id: uuidv4(), name, organizationId, createdAt: new Date(), updatedAt: new Date() } });\r\n  res.json({ success: true, data: block });\r\n});\r\n\r\n// PUT mise \u00E0 jour d'un block\r\nrouter.put('/:id', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n  const { name } = req.body;\r\n  const block = await prisma.block.update({ where: { id }, data: { name, updatedAt: new Date() } });\r\n  res.json({ success: true, data: block });\r\n});\r\n\r\n// DELETE suppression d'un block\r\nrouter.delete('/:id', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n  try {\r\n    // Suppression en cascade manuelle car Prisma ne le g\u00E8re pas automatiquement pour les relations complexes\r\n    const sections = await prisma.section.findMany({ where: { blockId: id } });\r\n    for (const section of sections) {\r\n      await prisma.field.deleteMany({ where: { sectionId: section.id } });\r\n    }\r\n    await prisma.section.deleteMany({ where: { blockId: id } });\r\n    await prisma.block.delete({ where: { id } });\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error(`[API] Erreur lors de la suppression du block ${id}:`, error);\r\n    res.status(500).json({ success: false, message: \"Erreur serveur lors de la suppression du block.\" });\r\n  }\r\n});\r\n\r\n// Route pour ajouter une section \u00E0 un block\r\nrouter.post('/:blockId/sections', requireRole(['admin', 'super_admin']) as unknown as (req: Request, res: Response, next: () => void) => void, async (req: Request, res: Response): Promise<void> => {\r\n  const { blockId } = req.params;\r\n  const { name, order, type } = req.body;\r\n\r\n  try {\r\n    // On ne cr\u00E9e pas la section si elle n'a pas de nom\r\n    if (!name) {\r\n      res.status(400).json({ success: false, message: \"Le nom de la section est requis.\" });\r\n      return;\r\n    }\r\n\r\n    // Si un type est fourni, s'assurer que la colonne existe\r\n    if (typeof type !== 'undefined') {\r\n      await ensureSectionTypeColumnExists();\r\n    }\r\n\r\n    // Cr\u00E9er la section avec une gestion robuste des \u00E9carts de sch\u00E9ma/client Prisma\r\n    try {\r\n      await prisma.section.create({\r\n        data: {\r\n          id: uuidv4(),\r\n          name,\r\n          order: order || 0,\r\n          blockId,\r\n          sectionType: type || 'normal',\r\n        },\r\n      });\r\n    } catch (err: unknown) {\r\n      const msg = String((err as { message?: string })?.message || '');\r\n      if (\r\n        msg.includes('sectionType') &&\r\n        (msg.includes('does not exist') || msg.includes(\"doesn't exist\") || msg.includes('column') || msg.includes('relation'))\r\n      ) {\r\n        // Colonne manquante -> on la cr\u00E9e puis on retente\r\n        await ensureSectionTypeColumnExists();\r\n        await prisma.section.create({\r\n          data: {\r\n            id: uuidv4(),\r\n            name,\r\n            order: order || 0,\r\n            blockId,\r\n            sectionType: type || 'normal',\r\n          },\r\n        });\r\n      } else if (msg.includes('Unknown arg') && msg.includes('sectionType')) {\r\n        // Client Prisma pas r\u00E9g\u00E9n\u00E9r\u00E9: cr\u00E9er sans sectionType puis mettre \u00E0 jour via SQL brut s\u00E9curis\u00E9\r\n        const created = await prisma.section.create({\r\n          data: {\r\n            id: uuidv4(),\r\n            name,\r\n            order: order || 0,\r\n            blockId,\r\n          },\r\n        });\r\n        if (typeof type !== 'undefined') {\r\n          await ensureSectionTypeColumnExists();\r\n          await prisma.$executeRaw`UPDATE \"Section\" SET \"sectionType\" = ${type || 'normal'} WHERE id = ${created.id}`;\r\n        }\r\n      } else {\r\n        throw err;\r\n      }\r\n    }\r\n\r\n    // On r\u00E9cup\u00E8re le block complet mis \u00E0 jour avec toutes ses sections et champs\r\n    const updatedBlockWithRelations = await prisma.block.findUnique({\r\n      where: { id: blockId },\r\n      include: {\r\n        Section: { // Utilise le nom de la relation d\u00E9fini dans le sch\u00E9ma Prisma\r\n          orderBy: { order: 'asc' },\r\n          include: {\r\n            Field: { // Utilise le nom de la relation\r\n              orderBy: { order: 'asc' },\r\n              include: {\r\n                FieldOption: { // Utilise le nom de la relation\r\n                  orderBy: { order: 'asc' }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n    });\r\n\r\n    if (!updatedBlockWithRelations) {\r\n      res.status(404).json({ success: false, message: \"Block non trouv\u00E9 apr\u00E8s ajout de la section.\" });\r\n      return;\r\n    }\r\n\r\n    // On adapte la structure avant de l'envoyer\r\n    const adaptedBlock = adaptBlockStructure(updatedBlockWithRelations);\r\n\r\n    res.status(201).json(adaptedBlock);\r\n  } catch (error) {\r\n    console.error(\"Erreur lors de l'ajout de la section:\", error);\r\n    res.status(500).json({ success: false, message: \"Erreur serveur lors de l'ajout de la section.\" });\r\n  }\r\n});\r\n\r\n// Route pour supprimer une section d'un block\r\nrouter.delete('/:blockId/sections/:sectionId', requireRole(['admin', 'super_admin']) as unknown as (req: Request, res: Response, next: () => void) => void, async (req: Request, res: Response): Promise<void> => {\r\n  const { blockId, sectionId } = req.params;\r\n\r\n  try {\r\n    // On supprime d'abord les champs associ\u00E9s pour \u00E9viter les erreurs de contrainte de cl\u00E9 \u00E9trang\u00E8re\r\n    await prisma.field.deleteMany({\r\n      where: { sectionId },\r\n    });\r\n\r\n    // Ensuite, on supprime la section elle-m\u00EAme\r\n    await prisma.section.delete({\r\n      where: { id: sectionId },\r\n    });\r\n\r\n    // On r\u00E9cup\u00E8re le block complet mis \u00E0 jour\r\n    const updatedBlockWithRelations = await prisma.block.findUnique({\r\n      where: { id: blockId },\r\n      include: {\r\n        Section: { // Utilise le nom de la relation d\u00E9fini dans le sch\u00E9ma Prisma\r\n          orderBy: { order: 'asc' },\r\n          include: {\r\n            Field: { // Utilise le nom de la relation\r\n              orderBy: { order: 'asc' },\r\n              include: {\r\n                FieldOption: { // Utilise le nom de la relation\r\n                  orderBy: { order: 'asc' }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n    });\r\n\r\n    if (!updatedBlockWithRelations) {\r\n      res.status(404).json({ success: false, message: \"Block non trouv\u00E9 apr\u00E8s suppression de la section.\" });\r\n      return;\r\n    }\r\n\r\n    // On adapte la structure avant de l'envoyer\r\n    const adaptedBlock = adaptBlockStructure(updatedBlockWithRelations);\r\n\r\n  res.json(adaptedBlock);\r\n  } catch (error) {\r\n    console.error(\"Erreur lors de la suppression de la section:\", error);\r\n    res.status(500).json({ success: false, message: \"Erreur serveur lors de la suppression de la section.\" });\r\n  }\r\n});\r\n\r\n// Route pour r\u00E9ordonner les sections d'un block\r\nrouter.put('/:blockId/sections/reorder', requireRole(['admin', 'super_admin']) as unknown as (req: Request, res: Response, next: () => void) => void, async (req: Request, res: Response): Promise<void> => {\r\n  const { blockId } = req.params;\r\n  const { sections } = req.body as { sections: { id: string; order: number }[] };\r\n\r\n  console.log(`[API] R\u00E9ordonnancement des sections pour le block ${blockId}`, sections);\r\n\r\n  if (!sections || !Array.isArray(sections)) {\r\n    res.status(400).json({ success: false, message: \"La liste des sections est requise.\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // V\u00E9rifier que toutes les sections appartiennent bien au blockId fourni\r\n    const sectionIds = sections.map(s => s.id);\r\n    const sectionsInDb = await prisma.section.findMany({\r\n      where: {\r\n        id: { in: sectionIds },\r\n        blockId: blockId,\r\n      },\r\n    });\r\n\r\n    if (sectionsInDb.length !== sections.length) {\r\n      res.status(400).json({ success: false, message: \"Certaines sections n'appartiennent pas au bon formulaire ou n'existent pas.\" });\r\n      return;\r\n    }\r\n\r\n    await prisma.$transaction(\r\n      sections.map(section =>\r\n        prisma.section.update({\r\n          where: {\r\n            id: section.id,\r\n            // On s'assure aussi que la section appartient bien au bloc pour la s\u00E9curit\u00E9\r\n            blockId: blockId,\r\n          },\r\n          data: { order: section.order },\r\n        })\r\n      )\r\n    );\r\n\r\n    // On r\u00E9cup\u00E8re le block complet mis \u00E0 jour\r\n    const updatedBlockWithRelations = await prisma.block.findUnique({\r\n      where: { id: blockId },\r\n      include: {\r\n        Section: { // Utilise le nom de la relation d\u00E9fini dans le sch\u00E9ma Prisma\r\n          orderBy: { order: 'asc' },\r\n          include: {\r\n            Field: { // Utilise le nom de la relation\r\n              orderBy: { order: 'asc' },\r\n              include: {\r\n                FieldOption: { // Utilise le nom de la relation\r\n                  orderBy: { order: 'asc' }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n    });\r\n\r\n    if (!updatedBlockWithRelations) {\r\n      res.status(404).json({ success: false, message: \"Block non trouv\u00E9 apr\u00E8s le r\u00E9ordonnancement des sections.\" });\r\n      return;\r\n    }\r\n\r\n    // On adapte la structure avant de l'envoyer\r\n    const adaptedBlock = adaptBlockStructure(updatedBlockWithRelations);\r\n\r\n  res.json(adaptedBlock);\r\n  } catch (error) {\r\n    console.error(\"Erreur lors du r\u00E9ordonnancement des sections:\", error);\r\n    res.status(500).json({ success: false, message: \"Erreur serveur lors du r\u00E9ordonnancement des sections.\" });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Block, Section, Field, FieldOption } from '@prisma/client';\r\n\r\n// Helper pour adapter la structure de donn\u00E9es du block pour le frontend\r\nexport const adaptBlockStructure = (block: (Block & { Section: (Section & { Field: (Field & { FieldOption: FieldOption[] })[] })[] })) => {\r\n  return {\r\n    ...block,\r\n    sections: block.Section.map((section) => ({\r\n  ...section,\r\n      fields: section.Field.map(field => ({\r\n        ...field,\r\n        options: field.FieldOption, // Renommer FieldOption en options\r\n      }))\r\n    }))\r\n  };\r\n};\r\n", "import { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware, AuthenticatedRequest } from '../middlewares/auth';\r\nimport UniversalNotificationService from '../services/UniversalNotificationService.js';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\n// Middleware to protect routes\r\nrouter.use(authMiddleware);\r\n\r\n/**\r\n * @route GET /api/notifications\r\n * @description Fetch pending notifications for the current user.\r\n * It fetches notifications for the organizations the user belongs to,\r\n * or notifications directly assigned to the user.\r\n */\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const user = (req as AuthenticatedRequest).user;\r\n    if (!user || !user.userId) {\r\n        // authMiddleware should prevent this, but as a safeguard:\r\n        res.status(401).json({ success: false, message: 'Utilisateur non authentifi\u00E9.' });\r\n        return;\r\n    }\r\n    const userId = user.userId;\r\n\r\n    // SuperAdmin logic: can see ALL notifications\r\n    if (user.role === 'super_admin') {\r\n        const notifications = await prisma.notification.findMany({\r\n            where: {\r\n                status: 'PENDING',\r\n            },\r\n            orderBy: {\r\n                createdAt: 'desc',\r\n            },\r\n            include: {\r\n                Organization: true // Include organization details for context\r\n            }\r\n        });\r\n        res.json({ success: true, data: notifications });\r\n        return;\r\n    }\r\n\r\n    // Normal user: only see notifications from their organizations\r\n\r\n    // Get all organizations the user is a member of\r\n    const userOrganizations = await prisma.userOrganization.findMany({\r\n        where: { userId: userId },\r\n        select: { organizationId: true }\r\n    });\r\n    const orgIds = userOrganizations.map(uo => uo.organizationId);\r\n\r\n    const notifications = await prisma.notification.findMany({\r\n      where: {\r\n        OR: [\r\n          { organizationId: { in: orgIds } },\r\n          { userId: userId }\r\n        ],\r\n        status: 'PENDING',\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc',\r\n      },\r\n      include: {\r\n        Organization: true // Include organization details for context\r\n      }\r\n    });\r\n\r\n    res.json({ success: true, data: notifications });\r\n  } catch (error) {\r\n    console.error('\u00C9chec de la r\u00E9cup\u00E9ration des notifications:', error);\r\n    res.status(500).json({ success: false, message: '\u00C9chec de la r\u00E9cup\u00E9ration des notifications' });\r\n  }\r\n});\r\n\r\n/**\r\n * @route POST /api/notifications\r\n * @description Create a new notification for the current user.\r\n */\r\nrouter.post('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const user = (req as AuthenticatedRequest).user;\r\n    if (!user || !user.userId) {\r\n        res.status(401).json({ success: false, message: 'Utilisateur non authentifi\u00E9.' });\r\n        return;\r\n    }\r\n    const userId = user.userId;\r\n\r\n    const { type, data, organizationId } = req.body;\r\n\r\n    if (!type || !data) {\r\n        res.status(400).json({ success: false, message: 'Type et data sont requis' });\r\n        return;\r\n    }\r\n\r\n    // Get user's first organization if not provided\r\n    let targetOrgId = organizationId;\r\n    if (!targetOrgId) {\r\n        const userOrg = await prisma.userOrganization.findFirst({\r\n            where: { userId: userId },\r\n            select: { organizationId: true }\r\n        });\r\n        targetOrgId = userOrg?.organizationId;\r\n    }\r\n\r\n    const notification = await prisma.notification.create({\r\n        data: {\r\n            type,\r\n            data,\r\n            userId,\r\n            organizationId: targetOrgId,\r\n            status: 'PENDING'\r\n        },\r\n        include: {\r\n            Organization: true\r\n        }\r\n    });\r\n\r\n    res.status(201).json({ success: true, data: notification });\r\n  } catch (error) {\r\n    console.error('\u00C9chec de la cr\u00E9ation de la notification:', error);\r\n    res.status(500).json({ success: false, message: '\u00C9chec de la cr\u00E9ation de la notification' });\r\n  }\r\n});\r\n\r\n/**\r\n * @route PATCH /api/notifications/:id/read\r\n * @description Mark a specific notification as read.\r\n */\r\nrouter.patch('/:id/read', async (req: Request, res: Response): Promise<void> => {\r\n    try {\r\n        const { id: notificationId } = req.params;\r\n        const user = (req as AuthenticatedRequest).user;\r\n\r\n        if (!user || !user.userId) {\r\n            res.status(401).json({ success: false, message: 'Utilisateur non authentifi\u00E9.' });\r\n            return;\r\n        }\r\n        const userId = user.userId;\r\n\r\n        const notification = await prisma.notification.findUnique({\r\n            where: { id: notificationId },\r\n        });\r\n\r\n        if (!notification) {\r\n            res.status(404).json({ success: false, message: 'Notification non trouv\u00E9e' });\r\n            return;\r\n        }\r\n\r\n        // Get all organizations the user is a member of\r\n        const userOrganizations = await prisma.userOrganization.findMany({\r\n            where: { userId: userId },\r\n            select: { organizationId: true }\r\n        });\r\n        const orgIds = userOrganizations.map(uo => uo.organizationId);\r\n\r\n        // A user can only mark a notification as read if it's for their organization\r\n        // or directly assigned to them.\r\n        const canAccess = notification.userId === userId || \r\n                          (notification.organizationId && orgIds.includes(notification.organizationId));\r\n\r\n        if (!canAccess) {\r\n             res.status(403).json({ success: false, message: 'Interdit: Vous n\\'avez pas acc\u00E8s \u00E0 cette notification.' });\r\n             return;\r\n        }\r\n\r\n        const updatedNotification = await prisma.notification.update({\r\n            where: { id: notificationId },\r\n            data: { status: 'READ' },\r\n        });\r\n\r\n        res.json({ success: true, data: updatedNotification });\r\n\r\n    } catch (error) {\r\n        console.error('\u00C9chec de la mise \u00E0 jour de la notification:', error);\r\n        res.status(500).json({ success: false, message: '\u00C9chec de la mise \u00E0 jour de la notification' });\r\n    }\r\n});\r\n\r\n/**\r\n * @route DELETE /api/notifications/:id\r\n * @description Delete a specific notification.\r\n */\r\nrouter.delete('/:id', async (req: Request, res: Response): Promise<void> => {\r\n    try {\r\n        const { id: notificationId } = req.params;\r\n        const user = (req as AuthenticatedRequest).user;\r\n\r\n        if (!user || !user.userId) {\r\n            res.status(401).json({ success: false, message: 'Utilisateur non authentifi\u00E9.' });\r\n            return;\r\n        }\r\n        const userId = user.userId;\r\n\r\n        const notification = await prisma.notification.findUnique({\r\n            where: { id: notificationId },\r\n        });\r\n\r\n        if (!notification) {\r\n            res.status(404).json({ success: false, message: 'Notification non trouv\u00E9e' });\r\n            return;\r\n        }\r\n\r\n        const userOrganizations = await prisma.userOrganization.findMany({\r\n            where: { userId: userId },\r\n            select: { organizationId: true }\r\n        });\r\n        const orgIds = userOrganizations.map(uo => uo.organizationId);\r\n\r\n        const canAccess = notification.userId === userId || \r\n                          (notification.organizationId && orgIds.includes(notification.organizationId));\r\n\r\n        if (!canAccess) {\r\n            res.status(403).json({ success: false, message: 'Interdit: Vous n\\'avez pas acc\u00E8s \u00E0 cette notification.' });\r\n            return;\r\n        }\r\n\r\n        await prisma.notification.delete({\r\n            where: { id: notificationId },\r\n        });\r\n\r\n        res.json({ success: true, message: 'Notification supprim\u00E9e avec succ\u00E8s.' });\r\n\r\n    } catch (error) {\r\n        console.error('\u00C9chec de la suppression de la notification:', error);\r\n        res.status(500).json({ success: false, message: '\u00C9chec de la suppression de la notification' });\r\n    }\r\n});\r\n\r\n/**\r\n * @route POST /api/notifications/check-emails\r\n * @description D\u00E9clencher manuellement une v\u00E9rification des nouveaux emails pour l'utilisateur actuel\r\n */\r\nrouter.post('/check-emails', async (req: Request, res: Response): Promise<void> => {\r\n    try {\r\n        const user = (req as AuthenticatedRequest).user;\r\n        if (!user || !user.userId) {\r\n            res.status(401).json({ success: false, message: 'Utilisateur non authentifi\u00E9.' });\r\n            return;\r\n        }\r\n\r\n        console.log(`\uD83D\uDD14 [API] V\u00E9rification manuelle des emails pour l'utilisateur ${user.userId}`);\r\n        \r\n        // \uD83D\uDE80 SOLUTION IMM\u00C9DIATE : D\u00E9clencher une synchronisation MANUELLE instantan\u00E9e\r\n        try {\r\n            // Importer le service AutoMailSyncService pour forcer une sync imm\u00E9diate\r\n            const { autoMailSync } = await import('../services/AutoMailSyncService.js');\r\n            \r\n            // D\u00E9clencher la synchronisation pour l'utilisateur actuel\r\n            console.log('\uD83D\uDD25 [API] D\u00E9clenchement sync manuelle imm\u00E9diate...');\r\n            await autoMailSync.syncForUser(user.userId);\r\n            \r\n            console.log('\u2705 [API] Synchronisation manuelle termin\u00E9e avec succ\u00E8s');\r\n        } catch (syncError) {\r\n            console.error('\u274C [API] Erreur sync manuelle:', syncError);\r\n            // Continuer malgr\u00E9 l'erreur de sync pour la notification backup\r\n        }\r\n        \r\n        // Utiliser aussi le service de notification universel en backup\r\n        const notificationService = UniversalNotificationService.getInstance();\r\n        \r\n        // D\u00E9clencher une v\u00E9rification manuelle de tous les types d'\u00E9v\u00E9nements\r\n        console.log('\uD83C\uDF1F [API] V\u00E9rification manuelle de TOUS les types d\\'\u00E9v\u00E9nements...');\r\n        \r\n        // \u00C9mettre un \u00E9v\u00E9nement pour d\u00E9clencher les v\u00E9rifications\r\n        notificationService.emit('manual-check-requested', { userId: user.userId });\r\n        \r\n        res.json({ \r\n            success: true, \r\n            message: 'V\u00E9rification des nouveaux emails effectu\u00E9e avec succ\u00E8s.' \r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('\u00C9chec de la v\u00E9rification des emails:', error);\r\n        res.status(500).json({ success: false, message: '\u00C9chec de la v\u00E9rification des emails' });\r\n    }\r\n});\r\n\r\n/**\r\n * @route POST /api/notifications/check-emails-all\r\n * @description D\u00E9clencher manuellement une v\u00E9rification des nouveaux emails pour tous les utilisateurs (Admin uniquement)\r\n */\r\nrouter.post('/check-emails-all', async (req: Request, res: Response): Promise<void> => {\r\n    try {\r\n        const user = (req as AuthenticatedRequest).user;\r\n        if (!user || !user.userId) {\r\n            res.status(401).json({ success: false, message: 'Utilisateur non authentifi\u00E9.' });\r\n            return;\r\n        }\r\n\r\n        // V\u00E9rifier les permissions (admin ou super_admin seulement)\r\n        if (user.role !== 'admin' && user.role !== 'super_admin') {\r\n            res.status(403).json({ success: false, message: 'Permissions insuffisantes. Admin requis.' });\r\n            return;\r\n        }\r\n\r\n        console.log(`\uD83D\uDD14 [API] V\u00E9rification manuelle globale des emails par ${user.role} ${user.userId}`);\r\n        \r\n        // Utiliser le nouveau service temps r\u00E9el pour v\u00E9rification globale\r\n        const notificationService = RealTimeEmailNotificationService.getInstance();\r\n        await notificationService.performBackupCheck();\r\n        \r\n        res.json({ \r\n            success: true, \r\n            message: 'V\u00E9rification des nouveaux emails effectu\u00E9e pour tous les utilisateurs.' \r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('\u00C9chec de la v\u00E9rification globale des emails:', error);\r\n        res.status(500).json({ success: false, message: '\u00C9chec de la v\u00E9rification globale des emails' });\r\n    }\r\n});\r\n\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83D\uDD27 ROUTES API DE DIAGNOSTIC DU SYST\u00C8ME DE NOTIFICATIONS\r\n */\r\n\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest, requireRole } from '../middlewares/auth.js';\r\nimport { \r\n  getNotificationSystemStatus, \r\n  getNotificationSystemInstance \r\n} from '../services/notificationSystemInit.js';\r\nimport UniversalNotificationService from '../services/UniversalNotificationService.js';\r\n\r\nconst router = Router();\r\n\r\n// Authentification requise pour toutes les routes\r\nrouter.use(authMiddleware);\r\n\r\n/**\r\n * GET /api/notifications-system/status\r\n * Obtenir le statut du syst\u00E8me de notifications\r\n */\r\nrouter.get('/status', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const status = getNotificationSystemStatus();\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: status,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [NotificationSystemAPI] Erreur statut:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration du statut' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/notifications-system/test-email\r\n * Cr\u00E9er une notification email de test (Admin seulement)\r\n */\r\nrouter.post('/test-email', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { userId, organizationId } = req.user!;\r\n    \r\n    const universalService = UniversalNotificationService.getInstance();\r\n    \r\n    await universalService.notifyNewEmail({\r\n      emailId: 'test-' + Date.now(),\r\n      from: 'system@2thier.be',\r\n      subject: 'Test de notification - ' + new Date().toLocaleTimeString('fr-FR'),\r\n      userId,\r\n      organizationId\r\n    });\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Notification email de test cr\u00E9\u00E9e avec succ\u00E8s'\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [NotificationSystemAPI] Erreur test email:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la cr\u00E9ation de la notification test' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/notifications-system/test-lead\r\n * Cr\u00E9er une notification lead de test (Admin seulement)\r\n */\r\nrouter.post('/test-lead', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { userId, organizationId } = req.user!;\r\n    \r\n    const universalService = UniversalNotificationService.getInstance();\r\n    \r\n    await universalService.notifyNewLead({\r\n      leadId: 'test-lead-' + Date.now(),\r\n      name: 'Lead de Test',\r\n      email: 'test@example.com',\r\n      phone: '+32 123 456 789',\r\n      source: 'Test API',\r\n      userId,\r\n      organizationId\r\n    });\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Notification lead de test cr\u00E9\u00E9e avec succ\u00E8s'\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [NotificationSystemAPI] Erreur test lead:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la cr\u00E9ation de la notification test' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/notifications-system/test-call\r\n * Cr\u00E9er une notification appel manqu\u00E9 de test (Admin seulement)\r\n */\r\nrouter.post('/test-call', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { userId, organizationId } = req.user!;\r\n    \r\n    const universalService = UniversalNotificationService.getInstance();\r\n    \r\n    await universalService.notifyMissedCall({\r\n      from: '+32 123 456 789',\r\n      duration: 0,\r\n      userId,\r\n      organizationId\r\n    });\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Notification appel manqu\u00E9 de test cr\u00E9\u00E9e avec succ\u00E8s'\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [NotificationSystemAPI] Erreur test appel:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la cr\u00E9ation de la notification test' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/notifications-system/stats/:organizationId\r\n * Obtenir les statistiques des notifications (Admin seulement)\r\n */\r\nrouter.get('/stats/:organizationId', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { organizationId } = req.params;\r\n    \r\n    const universalService = UniversalNotificationService.getInstance();\r\n    const stats = await universalService.getStats(organizationId);\r\n    \r\n    res.json({\r\n      success: true,\r\n      data: stats,\r\n      organizationId\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [NotificationSystemAPI] Erreur stats:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/notifications-system/restart\r\n * Red\u00E9marrer le syst\u00E8me de notifications (Super Admin seulement)\r\n */\r\nrouter.post('/restart', requireRole(['super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    console.log(`\uD83D\uDD04 [NotificationSystemAPI] Red\u00E9marrage demand\u00E9 par ${req.user?.email}`);\r\n    \r\n    const system = getNotificationSystemInstance();\r\n    if (system) {\r\n      await system.stop();\r\n      await system.start();\r\n    }\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Syst\u00E8me de notifications red\u00E9marr\u00E9 avec succ\u00E8s'\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [NotificationSystemAPI] Erreur red\u00E9marrage:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors du red\u00E9marrage du syst\u00E8me' \r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83D\uDE80 SERVICE D'INITIALISATION DU SYST\u00C8ME DE NOTIFICATIONS COMPLET\r\n * \r\n * Ce service d\u00E9marre et coordonne tous les services de notifications :\r\n * - UniversalNotificationService (notifications tous types)\r\n * - RealTimeEmailNotificationService (emails temps r\u00E9el)\r\n * - AutoMailSyncService (synchronisation emails)\r\n */\r\n\r\nimport UniversalNotificationService from './UniversalNotificationService.js';\r\nimport RealTimeEmailNotificationService from './RealTimeEmailNotificationService.js';\r\nimport { autoMailSync } from './AutoMailSyncService.js';\r\n\r\nexport class NotificationSystemService {\r\n  private static instance: NotificationSystemService;\r\n  private isStarted = false;\r\n\r\n  private constructor() {}\r\n\r\n  static getInstance(): NotificationSystemService {\r\n    if (!this.instance) {\r\n      this.instance = new NotificationSystemService();\r\n    }\r\n    return this.instance;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDE80 D\u00C9MARRER TOUT LE SYST\u00C8ME DE NOTIFICATIONS\r\n   */\r\n  async start(): Promise<void> {\r\n    if (this.isStarted) {\r\n      console.log('\u26A0\uFE0F [NotificationSystem] Syst\u00E8me d\u00E9j\u00E0 d\u00E9marr\u00E9');\r\n      return;\r\n    }\r\n\r\n    console.log('\uD83C\uDF1F [NotificationSystem] D\u00E9marrage du syst\u00E8me de notifications complet...');\r\n\r\n    try {\r\n      // 1. \uD83C\uDF1F D\u00E9marrer le service universel\r\n      console.log('1\uFE0F\u20E3 [NotificationSystem] D\u00E9marrage UniversalNotificationService...');\r\n      const universalService = UniversalNotificationService.getInstance();\r\n      universalService.start();\r\n\r\n      // 2. \uD83D\uDCE7 D\u00E9marrer le service de notifications email temps r\u00E9el\r\n      console.log('2\uFE0F\u20E3 [NotificationSystem] D\u00E9marrage RealTimeEmailNotificationService...');\r\n      const emailNotificationService = RealTimeEmailNotificationService.getInstance();\r\n      emailNotificationService.start();\r\n\r\n      // 3. \uD83D\uDD04 D\u00E9marrer la synchronisation email automatique\r\n      console.log('3\uFE0F\u20E3 [NotificationSystem] D\u00E9marrage AutoMailSyncService...');\r\n      await autoMailSync.start();\r\n\r\n      // 4. \uD83D\uDD17 Connecter les services entre eux\r\n      this.setupServiceConnections();\r\n\r\n      this.isStarted = true;\r\n      console.log('\u2705 [NotificationSystem] Syst\u00E8me de notifications complet d\u00E9marr\u00E9 avec succ\u00E8s !');\r\n\r\n      // 5. \uD83D\uDCCA Afficher le statut\r\n      this.logSystemStatus();\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [NotificationSystem] Erreur lors du d\u00E9marrage:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD17 CONNECTER LES SERVICES ENTRE EUX\r\n   */\r\n  private setupServiceConnections(): void {\r\n    console.log('\uD83D\uDD17 [NotificationSystem] Configuration des connexions inter-services...');\r\n\r\n    // \u00C9couter les \u00E9v\u00E9nements de nouveaux emails depuis AutoMailSyncService\r\n    const emailNotificationService = RealTimeEmailNotificationService.getInstance();\r\n    \r\n    // Quand AutoMailSyncService trouve un nouveau email, d\u00E9clencher une notification\r\n    autoMailSync.on('newEmailFound', (emailData) => {\r\n      console.log('\uD83C\uDFAF [NotificationSystem] Nouvel email d\u00E9tect\u00E9, cr\u00E9ation notification...');\r\n      emailNotificationService.notifyNewEmail(emailData);\r\n    });\r\n\r\n    console.log('\u2705 [NotificationSystem] Connexions inter-services configur\u00E9es');\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA AFFICHER LE STATUT DU SYST\u00C8ME\r\n   */\r\n  private logSystemStatus(): void {\r\n    console.log('\\n\uD83C\uDFAF [NotificationSystem] STATUT DU SYST\u00C8ME :');\r\n    console.log('=' .repeat(50));\r\n    console.log('\u2705 UniversalNotificationService : ACTIF');\r\n    console.log('\u2705 RealTimeEmailNotificationService : ACTIF');\r\n    console.log('\u2705 AutoMailSyncService : ACTIF');\r\n    console.log('\u2705 Connexions inter-services : CONFIGUR\u00C9ES');\r\n    console.log('=' .repeat(50));\r\n    console.log('\uD83D\uDD14 Le syst\u00E8me de notifications est op\u00E9rationnel !\\n');\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDED1 ARR\u00CATER TOUT LE SYST\u00C8ME\r\n   */\r\n  async stop(): Promise<void> {\r\n    if (!this.isStarted) {\r\n      console.log('\u26A0\uFE0F [NotificationSystem] Syst\u00E8me d\u00E9j\u00E0 arr\u00EAt\u00E9');\r\n      return;\r\n    }\r\n\r\n    console.log('\uD83D\uDED1 [NotificationSystem] Arr\u00EAt du syst\u00E8me de notifications...');\r\n\r\n    try {\r\n      // Arr\u00EAter tous les services\r\n      const universalService = UniversalNotificationService.getInstance();\r\n      universalService.stop();\r\n\r\n      const emailNotificationService = RealTimeEmailNotificationService.getInstance();\r\n      emailNotificationService.stop();\r\n\r\n      await autoMailSync.stop();\r\n\r\n      this.isStarted = false;\r\n      console.log('\u2705 [NotificationSystem] Syst\u00E8me de notifications arr\u00EAt\u00E9');\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [NotificationSystem] Erreur lors de l\\'arr\u00EAt:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCB OBTENIR LE STATUT DU SYST\u00C8ME\r\n   */\r\n  getStatus(): object {\r\n    return {\r\n      isStarted: this.isStarted,\r\n      services: {\r\n        universal: this.isStarted,\r\n        emailRealTime: this.isStarted,\r\n        autoSync: this.isStarted\r\n      },\r\n      startedAt: this.isStarted ? new Date().toISOString() : null\r\n    };\r\n  }\r\n}\r\n\r\nexport default NotificationSystemService;\r\n", "/**\r\n * \uD83C\uDFAF INT\u00C9GRATION DU SYST\u00C8ME DE NOTIFICATIONS DANS LE SERVEUR\r\n * \r\n * Ce fichier doit \u00EAtre import\u00E9 et appel\u00E9 au d\u00E9marrage du serveur principal\r\n */\r\n\r\nimport NotificationSystemService from './NotificationSystemService.js';\r\n\r\nlet notificationSystem: NotificationSystemService | null = null;\r\n\r\n/**\r\n * \uD83D\uDE80 INITIALISER LE SYST\u00C8ME DE NOTIFICATIONS\r\n * \u00C0 appeler au d\u00E9marrage du serveur\r\n */\r\nexport async function initializeNotificationSystem(): Promise<void> {\r\n  try {\r\n    console.log('\uD83C\uDFAF [INIT] Initialisation du syst\u00E8me de notifications...');\r\n    \r\n    notificationSystem = NotificationSystemService.getInstance();\r\n    await notificationSystem.start();\r\n    \r\n    console.log('\u2705 [INIT] Syst\u00E8me de notifications initialis\u00E9 avec succ\u00E8s');\r\n    \r\n    // Afficher les instructions pour l'utilisateur\r\n    console.log('\\n\uD83D\uDCCB [NOTIFICATIONS] FONCTIONNALIT\u00C9S DISPONIBLES :');\r\n    console.log('  \u2022 \uD83D\uDCE7 Notifications email temps r\u00E9el');\r\n    console.log('  \u2022 \uD83D\uDC65 Notifications nouveaux leads');  \r\n    console.log('  \u2022 \uD83D\uDCDE Notifications appels manqu\u00E9s');\r\n    console.log('  \u2022 \uD83D\uDCC5 Rappels rendez-vous');\r\n    console.log('  \u2022 \uD83D\uDCB0 Notifications devis/factures');\r\n    console.log('  \u2022 \uD83D\uDD14 Alertes syst\u00E8me');\r\n    console.log('');\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [INIT] Erreur initialisation syst\u00E8me notifications:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83D\uDED1 ARR\u00CATER LE SYST\u00C8ME DE NOTIFICATIONS\r\n * \u00C0 appeler \u00E0 l'arr\u00EAt du serveur\r\n */\r\nexport async function shutdownNotificationSystem(): Promise<void> {\r\n  try {\r\n    if (notificationSystem) {\r\n      console.log('\uD83D\uDED1 [SHUTDOWN] Arr\u00EAt du syst\u00E8me de notifications...');\r\n      await notificationSystem.stop();\r\n      console.log('\u2705 [SHUTDOWN] Syst\u00E8me de notifications arr\u00EAt\u00E9');\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C [SHUTDOWN] Erreur arr\u00EAt syst\u00E8me notifications:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83D\uDCCA OBTENIR LE STATUT DU SYST\u00C8ME\r\n */\r\nexport function getNotificationSystemStatus(): object {\r\n  if (!notificationSystem) {\r\n    return { status: 'not_initialized' };\r\n  }\r\n  return notificationSystem.getStatus();\r\n}\r\n\r\n/**\r\n * \uD83C\uDFAF OBTENIR L'INSTANCE DU SYST\u00C8ME (pour utilisation dans les routes)\r\n */\r\nexport function getNotificationSystemInstance(): NotificationSystemService | null {\r\n  return notificationSystem;\r\n}\r\n", "import { Router } from 'express';\r\nimport { authMiddleware, AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Appliquer l'authentification \u00E0 toutes les routes\r\nrouter.use(authMiddleware);\r\n\r\n// GET /api/settings/lead-statuses\r\nrouter.get('/lead-statuses', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[LEAD-STATUSES] R\u00E9cup\u00E9ration des statuts pour l\\'organisation:', organizationId);\r\n    \r\n    const statuses = await prisma.leadStatus.findMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      orderBy: {\r\n        order: 'asc'\r\n      }\r\n    });\r\n    \r\n    console.log(`[LEAD-STATUSES] ${statuses.length} statuts trouv\u00E9s`);\r\n    res.json(statuses);\r\n    \r\n  } catch (error) {\r\n    console.error('[LEAD-STATUSES] Erreur lors de la r\u00E9cup\u00E9ration des statuts:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des statuts',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/lead-statuses\r\nrouter.post('/lead-statuses', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { name, color, order, isDefault } = req.body;\r\n    \r\n    // Si isDefault est true, retirer le flag default des autres statuts\r\n    if (isDefault) {\r\n      await prisma.leadStatus.updateMany({\r\n        where: {\r\n          organizationId: organizationId,\r\n          isDefault: true\r\n        },\r\n        data: {\r\n          isDefault: false\r\n        }\r\n      });\r\n    }\r\n    \r\n    const newStatus = await prisma.leadStatus.create({\r\n      data: {\r\n        name,\r\n        color,\r\n        order: order || 0,\r\n        isDefault: isDefault || false,\r\n        organizationId\r\n      }\r\n    });\r\n    \r\n    console.log('[LEAD-STATUSES] Nouveau statut cr\u00E9\u00E9:', newStatus.name);\r\n    res.status(201).json(newStatus);\r\n    \r\n  } catch (error) {\r\n    console.error('[LEAD-STATUSES] Erreur lors de la cr\u00E9ation du statut:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du statut',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/lead-statuses/reorder (DOIT \u00CATRE AVANT la route :id)\r\nrouter.put('/lead-statuses/reorder', async (req, res) => {\r\n  console.log('\uD83D\uDEA8 [DEBUG] LEAD-STATUSES REORDER - ROUTE APPEL\u00C9E !');\r\n  console.log('\uD83D\uDEA8 [DEBUG] Body received:', req.body);\r\n  console.log('\uD83D\uDEA8 [DEBUG] Headers:', req.headers);\r\n  \r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      console.log('\uD83D\uDEA8 [DEBUG] PAS D\\'ORG ID');\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n\r\n    const { statuses } = req.body; // Format: [{ id: 'uuid', order: 0 }]\r\n    \r\n    if (!Array.isArray(statuses)) {\r\n      console.log('\uD83D\uDEA8 [DEBUG] PAS UN ARRAY:', typeof statuses, statuses);\r\n      return res.status(400).json({ \r\n        error: 'Array de statuts requis' \r\n      });\r\n    }\r\n\r\n    console.log('[LEAD-STATUSES] \uD83D\uDCE5 DONN\u00C9ES RE\u00C7UES:', JSON.stringify(statuses, null, 2));\r\n    console.log('[LEAD-STATUSES] \uD83D\uDCCA R\u00E9organisation de', statuses.length, 'statuts pour org:', organizationId);\r\n\r\n    // V\u00E9rifier que chaque statut a un id et un order\r\n    for (const status of statuses) {\r\n      if (!status.id || status.order === undefined) {\r\n        console.error('[LEAD-STATUSES] \u274C Statut invalide:', status);\r\n        return res.status(400).json({ \r\n          error: `Statut invalide: ${JSON.stringify(status)}` \r\n        });\r\n      }\r\n    }\r\n\r\n    // Mettre \u00E0 jour l'ordre de chaque statut avec logs d\u00E9taill\u00E9s\r\n    const updatePromises = statuses.map(async (status: { id: string; order: number }) => {\r\n      console.log(`[LEAD-STATUSES] \uD83D\uDD04 Mise \u00E0 jour ${status.id} -> order: ${status.order}`);\r\n      const result = await prisma.leadStatus.updateMany({\r\n        where: { id: status.id, organizationId },\r\n        data: { order: status.order }\r\n      });\r\n      console.log(`[LEAD-STATUSES] \u2705 R\u00E9sultat pour ${status.id}: ${result.count} ligne(s) modifi\u00E9e(s)`);\r\n      return result;\r\n    });\r\n\r\n    const results = await Promise.all(updatePromises);\r\n    console.log('[LEAD-STATUSES] \uD83D\uDCCB R\u00E9sultats globaux:', results.map(r => r.count));\r\n\r\n    res.json({\r\n      success: true,\r\n      message: 'Ordre mis \u00E0 jour avec succ\u00E8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('[LEAD-STATUSES] Erreur lors de la r\u00E9organisation:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9organisation' \r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/lead-statuses/:id (DOIT \u00CATRE APR\u00C8S la route /reorder)\r\nrouter.put('/lead-statuses/:id', (req, res) => {\r\n  console.log('[ROUTE] PUT /api/settings/lead-statuses/:id atteint', req.params.id);\r\n  // Logique de placeholder\r\n  res.status(200).json({ id: req.params.id, ...req.body });\r\n});\r\n\r\n// DELETE /api/settings/lead-statuses/:id\r\nrouter.delete('/lead-statuses/:id', (req, res) => {\r\n  console.log('[ROUTE] DELETE /api/settings/lead-statuses/:id atteint', req.params.id);\r\n  // Logique de placeholder\r\n  res.status(204).send();\r\n});\r\n\r\n// ===== ROUTES CALL STATUSES =====\r\n\r\n// GET /api/settings/call-statuses\r\nrouter.get('/call-statuses', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[CALL-STATUSES] R\u00E9cup\u00E9ration des statuts pour l\\'organisation:', organizationId);\r\n    \r\n    const callStatuses = await prisma.callStatus.findMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      orderBy: {\r\n        order: 'asc'\r\n      }\r\n    });\r\n    \r\n      // Si aucun statut d'appel, ne rien cr\u00E9er par d\u00E9faut\r\n      if (callStatuses.length === 0) {\r\n        console.log('[CALL-STATUSES] Aucun statut trouv\u00E9');\r\n      }    console.log(`[CALL-STATUSES] ${callStatuses.length} statuts trouv\u00E9s`);\r\n    res.json(callStatuses);\r\n    \r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] Erreur lors de la r\u00E9cup\u00E9ration des statuts:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des statuts d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-statuses (bulk save)\r\nrouter.post('/call-statuses', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const statuses = req.body;\r\n    \r\n    if (!Array.isArray(statuses)) {\r\n      return res.status(400).json({ \r\n        error: 'Le corps de la requ\u00EAte doit \u00EAtre un tableau de statuts' \r\n      });\r\n    }\r\n    \r\n    console.log(`[CALL-STATUSES] Sauvegarde en lot de ${statuses.length} statuts`);\r\n    \r\n    // Supprimer tous les statuts existants pour cette organisation\r\n    await prisma.callStatus.deleteMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n    \r\n    // Cr\u00E9er les nouveaux statuts\r\n    const savedStatuses = [];\r\n    for (let i = 0; i < statuses.length; i++) {\r\n      const status = statuses[i];\r\n      const savedStatus = await prisma.callStatus.create({\r\n        data: {\r\n          name: status.name,\r\n          color: status.color,\r\n          order: i,\r\n          organizationId\r\n        }\r\n      });\r\n      savedStatuses.push(savedStatus);\r\n    }\r\n    \r\n    console.log(`[CALL-STATUSES] ${savedStatuses.length} statuts sauvegard\u00E9s`);\r\n    res.json(savedStatuses);\r\n    \r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] Erreur lors de la sauvegarde des statuts:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la sauvegarde des statuts d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-statuses/reorder\r\nrouter.post('/call-statuses/reorder', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { statusIds } = req.body;\r\n    \r\n    if (!Array.isArray(statusIds)) {\r\n      return res.status(400).json({ \r\n        error: 'statusIds doit \u00EAtre un tableau' \r\n      });\r\n    }\r\n    \r\n    console.log(`[CALL-STATUSES] R\u00E9organisation de ${statusIds.length} statuts`);\r\n    \r\n    // Mettre \u00E0 jour l'ordre des statuts\r\n    for (let i = 0; i < statusIds.length; i++) {\r\n      await prisma.callStatus.update({\r\n        where: {\r\n          id: statusIds[i],\r\n          organizationId: organizationId\r\n        },\r\n        data: {\r\n          order: i\r\n        }\r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer les statuts mis \u00E0 jour\r\n    const updatedStatuses = await prisma.callStatus.findMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      orderBy: {\r\n        order: 'asc'\r\n      }\r\n    });\r\n    \r\n    console.log(`[CALL-STATUSES] R\u00E9organisation termin\u00E9e`);\r\n    res.json(updatedStatuses);\r\n    \r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] Erreur lors de la r\u00E9organisation:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9organisation des statuts d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/call-statuses/reorder (alias PUT pour POST)\r\nrouter.put('/call-statuses/reorder', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n\r\n    const { statuses } = req.body; // Format: [{ id: 'uuid', order: 0 }]\r\n    \r\n    if (!Array.isArray(statuses)) {\r\n      return res.status(400).json({ \r\n        error: 'Array de statuts requis' \r\n      });\r\n    }\r\n\r\n    console.log(`[CALL-STATUSES] PUT R\u00E9organisation de ${statuses.length} statuts`);\r\n\r\n    // Mettre \u00E0 jour l'ordre de chaque statut\r\n    const updatePromises = statuses.map((status: { id: string; order: number }) =>\r\n      prisma.callStatus.update({\r\n        where: { id: status.id },\r\n        data: { order: status.order }\r\n      })\r\n    );\r\n\r\n    await Promise.all(updatePromises);\r\n\r\n    console.log(`[CALL-STATUSES] PUT R\u00E9organisation termin\u00E9e`);\r\n    res.json({\r\n      success: true,\r\n      message: 'Ordre mis \u00E0 jour avec succ\u00E8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] PUT Erreur lors de la r\u00E9organisation:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9organisation des statuts d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-statuses/add\r\nrouter.post('/call-statuses/add', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { name, color } = req.body;\r\n    \r\n    if (!name || !color) {\r\n      return res.status(400).json({ \r\n        error: 'Le nom et la couleur sont requis' \r\n      });\r\n    }\r\n    \r\n    // Obtenir le prochain ordre\r\n    const maxOrder = await prisma.callStatus.aggregate({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      _max: {\r\n        order: true\r\n      }\r\n    });\r\n    \r\n    const nextOrder = (maxOrder._max.order || 0) + 1;\r\n    \r\n    const newStatus = await prisma.callStatus.create({\r\n      data: {\r\n        name,\r\n        color,\r\n        order: nextOrder,\r\n        organizationId\r\n      }\r\n    });\r\n    \r\n    console.log(`[CALL-STATUSES] Nouveau statut cr\u00E9\u00E9: ${newStatus.name}`);\r\n    res.status(201).json(newStatus);\r\n    \r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] Erreur lors de la cr\u00E9ation du statut:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du statut d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/call-statuses/:id\r\nrouter.put('/call-statuses/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { id } = req.params;\r\n    const { name, color } = req.body;\r\n    \r\n    console.log(`[CALL-STATUSES] Mise \u00E0 jour du statut ${id}`);\r\n    \r\n    const updatedStatus = await prisma.callStatus.update({\r\n      where: {\r\n        id: id,\r\n        organizationId: organizationId\r\n      },\r\n      data: {\r\n        name,\r\n        color\r\n      }\r\n    });\r\n    \r\n    console.log(`[CALL-STATUSES] Statut mis \u00E0 jour: ${updatedStatus.name}`);\r\n    res.json(updatedStatus);\r\n    \r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] Erreur lors de la mise \u00E0 jour du statut:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la mise \u00E0 jour du statut d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE /api/settings/call-statuses/:id\r\nrouter.delete('/call-statuses/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { id } = req.params;\r\n    \r\n    console.log(`[CALL-STATUSES] Suppression du statut ${id}`);\r\n    \r\n    await prisma.callStatus.delete({\r\n      where: {\r\n        id: id,\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n    \r\n    console.log(`[CALL-STATUSES] Statut supprim\u00E9`);\r\n    res.status(204).send();\r\n    \r\n  } catch (error) {\r\n    console.error('[CALL-STATUSES] Erreur lors de la suppression du statut:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la suppression du statut d\\'appel',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// ===== ROUTES CALL TO LEAD MAPPING =====\r\n\r\n// GET /api/settings/call-to-lead-mappings\r\nrouter.get('/call-to-lead-mappings', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[MAPPINGS] R\u00E9cup\u00E9ration des mappings pour l\\'organisation:', organizationId);\r\n    \r\n    const mappings = await prisma.callToLeadMapping.findMany({\r\n      where: {\r\n        organizationId: organizationId,\r\n        isActive: true\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      },\r\n      orderBy: {\r\n        priority: 'asc'\r\n      }\r\n    });\r\n    \r\n    console.log(`[MAPPINGS] ${mappings.length} mappings trouv\u00E9s`);\r\n    res.json(mappings);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la r\u00E9cup\u00E9ration des mappings:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des mappings',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-to-lead-mappings\r\nrouter.post('/call-to-lead-mappings', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { callStatusId, leadStatusId, condition, priority } = req.body;\r\n    \r\n    if (!callStatusId || !leadStatusId) {\r\n      return res.status(400).json({ \r\n        error: 'callStatusId et leadStatusId sont requis' \r\n      });\r\n    }\r\n    \r\n    console.log(`[MAPPINGS] Cr\u00E9ation d'un mapping: ${callStatusId} -> ${leadStatusId}`);\r\n    \r\n    const mapping = await prisma.callToLeadMapping.create({\r\n      data: {\r\n        organizationId,\r\n        callStatusId,\r\n        leadStatusId,\r\n        condition: condition || null,\r\n        priority: priority || 0\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log(`[MAPPINGS] Mapping cr\u00E9\u00E9: ${mapping.id}`);\r\n    res.status(201).json(mapping);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la cr\u00E9ation du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/call-to-lead-mappings/:id\r\nrouter.put('/call-to-lead-mappings/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { id } = req.params;\r\n    const { callStatusId, leadStatusId, condition, priority, isActive } = req.body;\r\n    \r\n    console.log(`[MAPPINGS] Mise \u00E0 jour du mapping ${id}`);\r\n    \r\n    const mapping = await prisma.callToLeadMapping.update({\r\n      where: {\r\n        id: id,\r\n        organizationId: organizationId\r\n      },\r\n      data: {\r\n        callStatusId,\r\n        leadStatusId,\r\n        condition,\r\n        priority,\r\n        isActive\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log(`[MAPPINGS] Mapping mis \u00E0 jour: ${mapping.id}`);\r\n    res.json(mapping);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la mise \u00E0 jour du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la mise \u00E0 jour du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE /api/settings/call-to-lead-mappings/:id\r\nrouter.delete('/call-to-lead-mappings/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { id } = req.params;\r\n    \r\n    console.log(`[MAPPINGS] Suppression du mapping ${id}`);\r\n    \r\n    await prisma.callToLeadMapping.delete({\r\n      where: {\r\n        id: id,\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n    \r\n    console.log(`[MAPPINGS] Mapping supprim\u00E9`);\r\n    res.status(204).send();\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la suppression du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la suppression du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-to-lead-mappings/bulk\r\nrouter.post('/call-to-lead-mappings/bulk', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { mappings } = req.body;\r\n    \r\n    if (!Array.isArray(mappings)) {\r\n      return res.status(400).json({ \r\n        error: 'mappings doit \u00EAtre un tableau' \r\n      });\r\n    }\r\n    \r\n    console.log(`[MAPPINGS] Sauvegarde en lot de ${mappings.length} mappings`);\r\n    \r\n    // Supprimer tous les mappings existants\r\n    await prisma.callToLeadMapping.deleteMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n    \r\n    // Cr\u00E9er les nouveaux mappings\r\n    const savedMappings = [];\r\n    for (let i = 0; i < mappings.length; i++) {\r\n      const mapping = mappings[i];\r\n      const savedMapping = await prisma.callToLeadMapping.create({\r\n        data: {\r\n          organizationId,\r\n          callStatusId: mapping.callStatusId,\r\n          leadStatusId: mapping.leadStatusId,\r\n          condition: mapping.condition || null,\r\n          priority: i,\r\n          isActive: mapping.isActive !== false\r\n        },\r\n        include: {\r\n          CallStatus: true,\r\n          LeadStatus: true\r\n        }\r\n      });\r\n      savedMappings.push(savedMapping);\r\n    }\r\n    \r\n    console.log(`[MAPPINGS] ${savedMappings.length} mappings sauvegard\u00E9s`);\r\n    res.json(savedMappings);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la sauvegarde des mappings:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la sauvegarde des mappings',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/settings/call-lead-mappings\r\nrouter.get('/call-lead-mappings', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[MAPPINGS] R\u00E9cup\u00E9ration des mappings pour l\\'organisation:', organizationId);\r\n    \r\n    const mappings = await prisma.callToLeadMapping.findMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      },\r\n      orderBy: {\r\n        priority: 'asc'\r\n      }\r\n    });\r\n    \r\n    console.log(`[MAPPINGS] ${mappings.length} mappings trouv\u00E9s`);\r\n    res.json(mappings);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la r\u00E9cup\u00E9ration des mappings:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des mappings',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/settings/call-lead-mappings\r\nrouter.get('/call-lead-mappings', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[MAPPINGS] R\u00E9cup\u00E9ration des mappings pour l\\'organisation:', organizationId);\r\n    \r\n    const mappings = await prisma.callToLeadMapping.findMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      },\r\n      orderBy: {\r\n        priority: 'asc'\r\n      }\r\n    });\r\n    \r\n    console.log(`[MAPPINGS] ${mappings.length} mappings trouv\u00E9s`);\r\n    res.json(mappings);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la r\u00E9cup\u00E9ration des mappings:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des mappings',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/settings/email-templates\r\nrouter.get('/email-templates', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n\r\n    const templates = await prisma.emailTemplate.findMany({\r\n      where: { organizationId }\r\n    });\r\n\r\n    res.json(templates);\r\n  } catch (error) {\r\n    console.error('[TEMPLATES] Erreur lors de la r\u00E9cup\u00E9ration des mod\u00E8les:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des mod\u00E8les',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'  \r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/settings/lead-sources\r\nrouter.get('/lead-sources', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n\r\n    const sources = await prisma.leadSource.findMany({\r\n      where: { organizationId }\r\n    });\r\n\r\n    res.json(sources);\r\n  } catch (error) {\r\n    console.error('[SOURCES] Erreur lors de la r\u00E9cup\u00E9ration des sources:', error); \r\n    res.status(500).json({\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des sources',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-lead-mappings  \r\nrouter.post('/call-lead-mappings', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { callStatusId, leadStatusId, priority, description } = req.body;\r\n    \r\n    console.log('[MAPPINGS] Cr\u00E9ation d\\'un nouveau mapping:', {\r\n      callStatusId,\r\n      leadStatusId,\r\n      organizationId,\r\n      priority\r\n    });\r\n    \r\n    const newMapping = await prisma.callToLeadMapping.create({\r\n      data: {\r\n        callStatusId,\r\n        leadStatusId,\r\n        organizationId,\r\n        priority: priority || 1,\r\n        description: description || null\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log('[MAPPINGS] Nouveau mapping cr\u00E9\u00E9:', newMapping.id);\r\n    res.status(201).json(newMapping);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la cr\u00E9ation du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/call-lead-mappings/:id\r\nrouter.put('/call-lead-mappings/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    const mappingId = req.params.id;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { callStatusId, leadStatusId, priority, description } = req.body;\r\n    \r\n    console.log('[MAPPINGS] Mise \u00E0 jour du mapping:', mappingId);\r\n    \r\n    const updatedMapping = await prisma.callToLeadMapping.update({\r\n      where: {\r\n        id: mappingId,\r\n        organizationId: organizationId\r\n      },\r\n      data: {\r\n        callStatusId,\r\n        leadStatusId,\r\n        priority,\r\n        description\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log('[MAPPINGS] Mapping mis \u00E0 jour:', updatedMapping.id);\r\n    res.json(updatedMapping);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la mise \u00E0 jour du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la mise \u00E0 jour du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE /api/settings/call-lead-mappings/:id\r\nrouter.delete('/call-lead-mappings/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    const mappingId = req.params.id;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[MAPPINGS] Suppression du mapping:', mappingId);\r\n    \r\n    await prisma.callToLeadMapping.delete({\r\n      where: {\r\n        id: mappingId,\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n    \r\n    console.log('[MAPPINGS] Mapping supprim\u00E9:', mappingId);\r\n    res.status(204).send();\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPINGS] Erreur lors de la suppression du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la suppression du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/settings/call-lead-mappings - Cr\u00E9er un nouveau mapping\r\nrouter.post('/call-lead-mappings', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { callStatusId, leadStatusId, priority } = req.body;\r\n    \r\n    if (!callStatusId || !leadStatusId) {\r\n      return res.status(400).json({ \r\n        error: 'callStatusId et leadStatusId sont requis' \r\n      });\r\n    }\r\n    \r\n    console.log('[MAPPING] Cr\u00E9ation d\\'un nouveau mapping:', { callStatusId, leadStatusId, priority });\r\n    \r\n    // V\u00E9rifier si un mapping existe d\u00E9j\u00E0 pour ce statut d'appel\r\n    const existingMapping = await prisma.callToLeadMapping.findFirst({\r\n      where: {\r\n        callStatusId: callStatusId,\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n    \r\n    if (existingMapping) {\r\n      // Mettre \u00E0 jour le mapping existant\r\n      const updatedMapping = await prisma.callToLeadMapping.update({\r\n        where: { id: existingMapping.id },\r\n        data: {\r\n          leadStatusId: leadStatusId,\r\n          priority: priority || existingMapping.priority\r\n        },\r\n        include: {\r\n          CallStatus: true,\r\n          LeadStatus: true\r\n        }\r\n      });\r\n      \r\n      console.log('[MAPPING] Mapping mis \u00E0 jour:', updatedMapping.id);\r\n      return res.json(updatedMapping);\r\n    } else {\r\n      // Cr\u00E9er un nouveau mapping\r\n      const newMapping = await prisma.callToLeadMapping.create({\r\n        data: {\r\n          callStatusId: callStatusId,\r\n          leadStatusId: leadStatusId,\r\n          organizationId: organizationId,\r\n          priority: priority || 1\r\n        },\r\n        include: {\r\n          CallStatus: true,\r\n          LeadStatus: true\r\n        }\r\n      });\r\n      \r\n      console.log('[MAPPING] Nouveau mapping cr\u00E9\u00E9:', newMapping.id);\r\n      return res.json(newMapping);\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPING] Erreur lors de la cr\u00E9ation du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/settings/call-lead-mappings/:id - Modifier un mapping\r\nrouter.put('/call-lead-mappings/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    const mappingId = req.params.id;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    const { callStatusId, leadStatusId, priority } = req.body;\r\n    \r\n    console.log('[MAPPING] Modification du mapping:', mappingId, { callStatusId, leadStatusId, priority });\r\n    \r\n    const updatedMapping = await prisma.callToLeadMapping.update({\r\n      where: { \r\n        id: mappingId,\r\n        organizationId: organizationId \r\n      },\r\n      data: {\r\n        ...(callStatusId && { callStatusId }),\r\n        ...(leadStatusId && { leadStatusId }),\r\n        ...(priority !== undefined && { priority })\r\n      },\r\n      include: {\r\n        CallStatus: true,\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log('[MAPPING] Mapping mis \u00E0 jour:', updatedMapping.id);\r\n    res.json(updatedMapping);\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPING] Erreur lors de la modification du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la modification du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE /api/settings/call-lead-mappings/:id - Supprimer un mapping\r\nrouter.delete('/call-lead-mappings/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    const mappingId = req.params.id;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[MAPPING] Suppression du mapping:', mappingId);\r\n    \r\n    await prisma.callToLeadMapping.delete({\r\n      where: { \r\n        id: mappingId,\r\n        organizationId: organizationId \r\n      }\r\n    });\r\n    \r\n    console.log('[MAPPING] Mapping supprim\u00E9:', mappingId);\r\n    res.json({ success: true, message: 'Mapping supprim\u00E9 avec succ\u00E8s' });\r\n    \r\n  } catch (error) {\r\n    console.error('[MAPPING] Erreur lors de la suppression du mapping:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la suppression du mapping',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDE80 POST /api/settings/initialize-default-statuses - Initialiser les statuts par d\u00E9faut\r\nrouter.post('/initialize-default-statuses', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n\r\n    console.log('\uD83D\uDE80 [INIT] Initialisation des statuts par d\u00E9faut pour l\\'organisation:', organizationId);\r\n\r\n    // 1) Statuts d'appel par d\u00E9faut (13 statuts selon cahier des charges)\r\n    const defaultCallStatuses = [\r\n      { name: \"\uD83D\uDCDE Pas de r\u00E9ponse\", description: \"Le client n'a pas d\u00E9croch\u00E9\", color: \"#f39c12\", icon: \"\uD83D\uDCDE\", order: 1 },\r\n      { name: \"\uD83D\uDCDE Num\u00E9ro incorrect / injoignable\", description: \"Num\u00E9ro invalide ou injoignable\", color: \"#e74c3c\", icon: \"\uD83D\uDCDE\", order: 2 },\r\n      { name: \"\uD83D\uDCDE Rappel programm\u00E9\", description: \"Rappel planifi\u00E9 avec le client\", color: \"#3498db\", icon: \"\uD83D\uDCDE\", order: 3 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Pas int\u00E9ress\u00E9\", description: \"Client contact\u00E9 mais pas int\u00E9ress\u00E9\", color: \"#e67e22\", icon: \"\uD83D\uDCDE\", order: 4 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 \u00C0 rappeler plus tard\", description: \"Client demande \u00E0 \u00EAtre rappel\u00E9 plus tard\", color: \"#f1c40f\", icon: \"\uD83D\uDCDE\", order: 5 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Information envoy\u00E9e (mail/sms)\", description: \"Informations envoy\u00E9es au client\", color: \"#9b59b6\", icon: \"\uD83D\uDCDE\", order: 6 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Rendez-vous fix\u00E9\", description: \"RDV fix\u00E9 avec le client\", color: \"#2ecc71\", icon: \"\uD83D\uDCDE\", order: 7 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Refus (non direct \u00E0 l'appel)\", description: \"Refus lors de l'appel\", color: \"#c0392b\", icon: \"\uD83D\uDCDE\", order: 8 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Refus ferme (apr\u00E8s devis/visite)\", description: \"Refus d\u00E9finitif apr\u00E8s devis/visite\", color: \"#8e44ad\", icon: \"\uD83D\uDCDE\", order: 9 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Devis demand\u00E9\", description: \"Client demande un devis\", color: \"#16a085\", icon: \"\uD83D\uDCDE\", order: 10 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Devis envoy\u00E9\", description: \"Devis envoy\u00E9 au client\", color: \"#27ae60\", icon: \"\uD83D\uDCDE\", order: 11 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 En n\u00E9gociation\", description: \"N\u00E9gociation en cours\", color: \"#f39c12\", icon: \"\uD83D\uDCDE\", order: 12 },\r\n      { name: \"\uD83D\uDCDE Contact\u00E9 \u2013 Gagn\u00E9 (vente conclue)\", description: \"Vente finalis\u00E9e\", color: \"#2ecc71\", icon: \"\uD83D\uDCDE\", order: 13 }\r\n    ];\r\n\r\n    // 2) Statuts de leads par d\u00E9faut (13 statuts selon cahier des charges)\r\n    const defaultLeadStatuses = [\r\n      { name: \"\uD83D\uDFE2 Nouveau lead\", description: \"Lead nouvellement cr\u00E9\u00E9\", color: \"#2ecc71\", order: 1 },\r\n      { name: \"\uD83D\uDFE1 Contacter (d\u00E8s le 1er appel tent\u00E9)\", description: \"\u00C0 contacter d\u00E8s le premier appel\", color: \"#f1c40f\", order: 2 },\r\n      { name: \"\uD83D\uDFE1 En attente de rappel (si convenu avec le client)\", description: \"Rappel convenu avec le client\", color: \"#f39c12\", order: 3 },\r\n      { name: \"\uD83D\uDFE1 Information envoy\u00E9e\", description: \"Informations envoy\u00E9es au client\", color: \"#f1c40f\", order: 4 },\r\n      { name: \"\uD83D\uDFE0 Devis en pr\u00E9paration\", description: \"Devis en cours de pr\u00E9paration\", color: \"#e67e22\", order: 5 },\r\n      { name: \"\uD83D\uDFE0 Devis envoy\u00E9\", description: \"Devis envoy\u00E9 au client\", color: \"#d35400\", order: 6 },\r\n      { name: \"\uD83D\uDFE0 En n\u00E9gociation\", description: \"N\u00E9gociation en cours\", color: \"#e74c3c\", order: 7 },\r\n      { name: \"\uD83C\uDFAF Cibl\u00E9 (objectif client)\", description: \"Client cibl\u00E9 comme objectif\", color: \"#9b59b6\", order: 8 },\r\n      { name: \"\uD83D\uDFE3 Non trait\u00E9 dans le d\u00E9lai (auto)\", description: \"Non trait\u00E9 automatiquement\", color: \"#8e44ad\", order: 9 },\r\n      { name: \"\uD83D\uDD34 Perdu (apr\u00E8s visite/devis non sign\u00E9, ou auto via SLA)\", description: \"Lead perdu\", color: \"#c0392b\", order: 10 },\r\n      { name: \"\u274C Refus\u00E9 (non direct / pas int\u00E9ress\u00E9)\", description: \"Refus direct\", color: \"#e74c3c\", order: 11 },\r\n      { name: \"\uD83D\uDFE2 Gagn\u00E9\", description: \"Lead gagn\u00E9\", color: \"#27ae60\", order: 12 },\r\n      { name: \"\u26AB Injoignable / Archiv\u00E9\", description: \"Lead injoignable ou archiv\u00E9\", color: \"#34495e\", order: 13 }\r\n    ];\r\n\r\n    // Cr\u00E9er les statuts d'appel\r\n    for (const status of defaultCallStatuses) {\r\n      try {\r\n        await prisma.callStatus.upsert({\r\n          where: { \r\n            organizationId_name: { \r\n              organizationId, \r\n              name: status.name \r\n            } \r\n          },\r\n          update: {}, // Ne pas modifier si existe d\u00E9j\u00E0\r\n          create: {\r\n            ...status,\r\n            organizationId,\r\n            isActive: true,\r\n            isDefault: false\r\n          }\r\n        });\r\n        console.log(`\u2705 [INIT] Statut d'appel cr\u00E9\u00E9: ${status.name}`);\r\n      } catch {\r\n        console.log(`\u26A0\uFE0F [INIT] Statut d'appel existe d\u00E9j\u00E0: ${status.name}`);\r\n      }\r\n    }\r\n\r\n    // Cr\u00E9er les statuts de leads\r\n    for (const status of defaultLeadStatuses) {\r\n      try {\r\n        await prisma.leadStatus.upsert({\r\n          where: { \r\n            organizationId_name: { \r\n              organizationId, \r\n              name: status.name \r\n            } \r\n          },\r\n          update: {}, // Ne pas modifier si existe d\u00E9j\u00E0\r\n          create: {\r\n            ...status,\r\n            organizationId,\r\n            isDefault: false\r\n          }\r\n        });\r\n        console.log(`\u2705 [INIT] Statut de lead cr\u00E9\u00E9: ${status.name}`);\r\n      } catch {\r\n        console.log(`\u26A0\uFE0F [INIT] Statut de lead existe d\u00E9j\u00E0: ${status.name}`);\r\n      }\r\n    }\r\n\r\n    // 3) Cr\u00E9er les mappings par d\u00E9faut\r\n    const mappings = [\r\n      { callStatusName: \"\uD83D\uDCDE Pas de r\u00E9ponse\", leadStatusName: \"\uD83D\uDFE1 Contacter (d\u00E8s le 1er appel tent\u00E9)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Num\u00E9ro incorrect / injoignable\", leadStatusName: \"\u26AB Injoignable / Archiv\u00E9\" },\r\n      { callStatusName: \"\uD83D\uDCDE Rappel programm\u00E9\", leadStatusName: \"\uD83D\uDFE1 En attente de rappel (si convenu avec le client)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Pas int\u00E9ress\u00E9\", leadStatusName: \"\u274C Refus\u00E9 (non direct / pas int\u00E9ress\u00E9)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Refus (non direct \u00E0 l'appel)\", leadStatusName: \"\u274C Refus\u00E9 (non direct / pas int\u00E9ress\u00E9)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Refus ferme (apr\u00E8s devis/visite)\", leadStatusName: \"\uD83D\uDD34 Perdu (apr\u00E8s visite/devis non sign\u00E9, ou auto via SLA)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 \u00C0 rappeler plus tard\", leadStatusName: \"\uD83D\uDFE1 En attente de rappel (si convenu avec le client)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Information envoy\u00E9e (mail/sms)\", leadStatusName: \"\uD83D\uDFE1 Information envoy\u00E9e\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Rendez-vous fix\u00E9\", leadStatusName: \"\uD83C\uDFAF Cibl\u00E9 (objectif client)\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Devis demand\u00E9\", leadStatusName: \"\uD83D\uDFE0 Devis en pr\u00E9paration\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Devis envoy\u00E9\", leadStatusName: \"\uD83D\uDFE0 Devis envoy\u00E9\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 En n\u00E9gociation\", leadStatusName: \"\uD83D\uDFE0 En n\u00E9gociation\" },\r\n      { callStatusName: \"\uD83D\uDCDE Contact\u00E9 \u2013 Gagn\u00E9 (vente conclue)\", leadStatusName: \"\uD83D\uDFE2 Gagn\u00E9\" }\r\n    ];\r\n\r\n    // R\u00E9cup\u00E9rer les statuts cr\u00E9\u00E9s pour les mappings\r\n    const callStatuses = await prisma.callStatus.findMany({ where: { organizationId } });\r\n    const leadStatuses = await prisma.leadStatus.findMany({ where: { organizationId } });\r\n\r\n    // Cr\u00E9er les mappings\r\n    for (const mapping of mappings) {\r\n      const callStatus = callStatuses.find(cs => cs.name === mapping.callStatusName);\r\n      const leadStatus = leadStatuses.find(ls => ls.name === mapping.leadStatusName);\r\n      \r\n      if (callStatus && leadStatus) {\r\n        try {\r\n          await prisma.callToLeadMapping.upsert({\r\n            where: {\r\n              organizationId_callStatusId_leadStatusId: {\r\n                organizationId,\r\n                callStatusId: callStatus.id,\r\n                leadStatusId: leadStatus.id\r\n              }\r\n            },\r\n            update: {},\r\n            create: {\r\n              organizationId,\r\n              callStatusId: callStatus.id,\r\n              leadStatusId: leadStatus.id,\r\n              condition: \"automatic\",\r\n              priority: 1,\r\n              description: `Mapping automatique: ${mapping.callStatusName} \u2192 ${mapping.leadStatusName}`,\r\n              isActive: true\r\n            }\r\n          });\r\n          console.log(`\u2705 [INIT] Mapping cr\u00E9\u00E9: ${mapping.callStatusName} \u2192 ${mapping.leadStatusName}`);\r\n        } catch {\r\n          console.log(`\u26A0\uFE0F [INIT] Mapping existe d\u00E9j\u00E0: ${mapping.callStatusName} \u2192 ${mapping.leadStatusName}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log('\uD83C\uDF89 [INIT] Initialisation termin\u00E9e avec succ\u00E8s !');\r\n    \r\n    res.json({ \r\n      success: true, \r\n      message: 'Statuts par d\u00E9faut initialis\u00E9s avec succ\u00E8s !',\r\n      details: {\r\n        callStatuses: defaultCallStatuses.length,\r\n        leadStatuses: defaultLeadStatuses.length,\r\n        mappings: mappings.length\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [INIT] Erreur lors de l\\'initialisation des statuts:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de l\\'initialisation des statuts',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware, AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Appliquer l'authentification \u00E0 toutes les routes\r\nrouter.use(authMiddleware);\r\n\r\n// GET /api/leads\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    \r\n    // \uD83D\uDC1B Debug logs pour comprendre le probl\u00E8me SuperAdmin\r\n    console.log('[LEADS] \uD83D\uDD0D Utilisateur connect\u00E9:', {\r\n      id: authReq.user?.userId || authReq.user?.id,\r\n      email: authReq.user?.email,\r\n      role: authReq.user?.role,\r\n      isSuperAdmin: authReq.user?.isSuperAdmin,\r\n      organizationId: authReq.user?.organizationId\r\n    });\r\n    \r\n    // SuperAdmin logic: can see ALL leads - am\u00E9lioration des conditions\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' || \r\n                        authReq.user?.isSuperAdmin === true ||\r\n                        authReq.user?.role?.toLowerCase().includes('super');\r\n    \r\n    console.log('[LEADS] \uD83D\uDC51 V\u00E9rification SuperAdmin:', { \r\n      isSuperAdmin, \r\n      conditions: {\r\n        roleCheck: authReq.user?.role === 'super_admin',\r\n        booleanCheck: authReq.user?.isSuperAdmin === true,\r\n        roleIncludesSuper: authReq.user?.role?.toLowerCase().includes('super')\r\n      }\r\n    });\r\n    \r\n    if (isSuperAdmin) {\r\n      console.log('[LEADS] \uD83C\uDF0D SuperAdmin d\u00E9tect\u00E9 - r\u00E9cup\u00E9ration de TOUS les leads');\r\n      try {\r\n        const allLeads = await prisma.lead.findMany({\r\n          include: {\r\n            User: {\r\n              select: {\r\n                id: true,\r\n                firstName: true,\r\n                lastName: true,\r\n                email: true,\r\n              }\r\n            },\r\n            LeadStatus: true,\r\n            Organization: {\r\n              select: {\r\n                id: true,\r\n                name: true\r\n              }\r\n            }\r\n          },\r\n          orderBy: {\r\n            updatedAt: 'desc'\r\n          }\r\n        });\r\n        \r\n        console.log('[LEADS] \uD83D\uDCCA Total leads r\u00E9cup\u00E9r\u00E9s pour SuperAdmin:', allLeads.length);\r\n        console.log('[LEADS] \uD83D\uDCCB Leads par organisation:', allLeads.reduce((acc, lead) => {\r\n          const orgName = lead.Organization?.name || 'Sans organisation';\r\n          acc[orgName] = (acc[orgName] || 0) + 1;\r\n          return acc;\r\n        }, {} as Record<string, number>));\r\n        \r\n        // Formatter les leads pour SuperAdmin (m\u00EAme logique que les utilisateurs normaux)\r\n        const formattedLeads = allLeads.map(lead => {\r\n          const data = lead.data || {};\r\n          \r\n          const formattedName = lead.firstName && lead.lastName ? `${lead.firstName} ${lead.lastName}` : \r\n                (lead.firstName || lead.lastName || data.name || `Lead ${lead.id.slice(0, 8)}`);\r\n          \r\n          return {\r\n            id: lead.id,\r\n            name: formattedName,\r\n            firstName: lead.firstName || data.firstName || '',\r\n            lastName: lead.lastName || data.lastName || '',\r\n            email: lead.email || data.email || '',\r\n            phone: lead.phone || data.phone || '',\r\n            company: lead.company || data.company || '',\r\n            status: lead.status,\r\n            source: lead.source || 'unknown',\r\n            assignedTo: lead.User,\r\n            leadStatus: lead.LeadStatus,\r\n            createdAt: lead.createdAt,\r\n            updatedAt: lead.updatedAt,\r\n            statusId: lead.statusId,\r\n            organizationId: lead.organizationId,\r\n            assignedToId: lead.assignedToId,\r\n            // Donn\u00E9es additionnelles pour la compatibilit\u00E9\r\n            data: lead.data,\r\n            // Information organisation pour SuperAdmin\r\n            organization: lead.Organization\r\n          };\r\n        });\r\n        \r\n        res.json({ success: true, data: formattedLeads });\r\n        return;\r\n      } catch (error) {\r\n        console.error('[LEADS] Erreur lors de la r\u00E9cup\u00E9ration des leads pour SuperAdmin:', error);\r\n        res.status(500).json({ \r\n          success: false,\r\n          error: 'Erreur lors de la r\u00E9cup\u00E9ration des leads pour SuperAdmin',\r\n          message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n        });\r\n        return;\r\n      }\r\n    }\r\n    \r\n    // Normal user: filter by organization\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e pour utilisateur non-SuperAdmin' \r\n      });\r\n    }\r\n    \r\n    console.log('[LEADS] \uD83D\uDC64 Utilisateur normal - R\u00E9cup\u00E9ration des leads pour l\\'organisation:', organizationId);\r\n    \r\n    const leads = await prisma.lead.findMany({\r\n      where: {\r\n        organizationId: organizationId\r\n      },\r\n      include: {\r\n        User: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        LeadStatus: true\r\n      },\r\n      orderBy: {\r\n        updatedAt: 'desc'\r\n      }\r\n    });\r\n\r\n    // Transformer les donn\u00E9es pour le frontend\r\n    const formattedLeads = leads.map(lead => {\r\n      // Utiliser d'abord les colonnes d\u00E9di\u00E9es, puis fallback sur data JSON si n\u00E9cessaire\r\n      const data = lead.data || {};\r\n      \r\n      console.log(`[LEADS] Formatage lead ${lead.id}:`);\r\n      console.log(`[LEADS] - firstName: \"${lead.firstName}\" (${typeof lead.firstName})`);\r\n      console.log(`[LEADS] - lastName: \"${lead.lastName}\" (${typeof lead.lastName})`);\r\n      console.log(`[LEADS] - data.name: \"${data.name}\"`);\r\n      \r\n      const formattedName = lead.firstName && lead.lastName ? `${lead.firstName} ${lead.lastName}` : \r\n            (lead.firstName || lead.lastName || data.name || `Lead ${lead.id.slice(0, 8)}`);\r\n      \r\n      console.log(`[LEADS] - Nom final: \"${formattedName}\"`);\r\n      \r\n      return {\r\n        id: lead.id,\r\n        name: formattedName,\r\n        firstName: lead.firstName || data.firstName || '',\r\n        lastName: lead.lastName || data.lastName || '',\r\n        email: lead.email || data.email || '',\r\n        phone: lead.phone || data.phone || '',\r\n        company: lead.company || data.company || '',\r\n        status: lead.status,\r\n        source: lead.source || 'unknown',\r\n        assignedTo: lead.User,\r\n        leadStatus: lead.LeadStatus,\r\n        createdAt: lead.createdAt,\r\n        updatedAt: lead.updatedAt,\r\n        statusId: lead.statusId,\r\n        organizationId: lead.organizationId,\r\n        assignedToId: lead.assignedToId,\r\n        // Donn\u00E9es additionnelles pour la compatibilit\u00E9\r\n        data: lead.data\r\n      };\r\n    });\r\n\r\n    console.log(`[LEADS] ${leads.length} leads trouv\u00E9s`);\r\n    res.json({ success: true, data: formattedLeads });\r\n\r\n  } catch (error) {\r\n    console.error('[LEADS] Erreur lors de la r\u00E9cup\u00E9ration des leads:', error);\r\n    res.status(500).json({ \r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des leads',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/leads\r\nrouter.post('/', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[LEADS] POST - Cr\u00E9ation d\\'un nouveau lead');\r\n    console.log('[LEADS] Donn\u00E9es re\u00E7ues:', req.body);\r\n    console.log('[LEADS] Organisation:', organizationId);\r\n    \r\n    const { \r\n      firstName, \r\n      lastName, \r\n      email, \r\n      phone, \r\n      company, \r\n      source, \r\n      status = 'new',\r\n      statusId,\r\n      notes,\r\n      website,\r\n      linkedin,\r\n      data \r\n    } = req.body;\r\n    \r\n    // Validation des champs requis\r\n    if (!firstName || !lastName || !email || !company) {\r\n      return res.status(400).json({ \r\n        error: 'Les champs pr\u00E9nom, nom, email et soci\u00E9t\u00E9 sont requis' \r\n      });\r\n    }\r\n    \r\n    // V\u00E9rifier si le statut existe\r\n    let finalStatusId = statusId;\r\n    if (statusId) {\r\n      const statusExists = await prisma.leadStatus.findUnique({\r\n        where: { id: statusId }\r\n      });\r\n      if (!statusExists) {\r\n        console.log('[LEADS] Statut non trouv\u00E9, utilisation du statut par d\u00E9faut');\r\n        finalStatusId = null;\r\n      }\r\n    }\r\n    \r\n    // Si pas de statusId, utiliser le statut par d\u00E9faut de l'organisation\r\n    if (!finalStatusId) {\r\n      const defaultStatus = await prisma.leadStatus.findFirst({\r\n        where: {\r\n          organizationId,\r\n          isDefault: true\r\n        }\r\n      });\r\n      if (defaultStatus) {\r\n        finalStatusId = defaultStatus.id;\r\n        console.log('[LEADS] Statut par d\u00E9faut assign\u00E9:', defaultStatus.name);\r\n      }\r\n    }\r\n    \r\n    // Cr\u00E9er le lead (timestamps explicites car updatedAt n'a pas de d\u00E9faut dans le sch\u00E9ma)\r\n    const now = new Date();\r\n    const newLead = await prisma.lead.create({\r\n      data: {\r\n        firstName,\r\n        lastName,\r\n        email,\r\n        phone: phone || null,\r\n        company,\r\n        source: source || 'manual',\r\n        status,\r\n        statusId: finalStatusId,\r\n        notes: notes || null,\r\n        website: website || null,\r\n        linkedin: linkedin || null,\r\n        createdAt: now,\r\n        updatedAt: now,\r\n        organizationId,\r\n        assignedToId: authReq.user?.userId || null,\r\n        // Donn\u00E9es JSON pour compatibilit\u00E9\r\n        data: data || {\r\n          name: `${firstName} ${lastName}`,\r\n          email,\r\n          phone: phone || '',\r\n          company,\r\n          notes: notes || '',\r\n          website: website || '',\r\n          linkedin: linkedin || '',\r\n          source: source || 'manual'\r\n        }\r\n      },\r\n      include: {\r\n        User: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log('[LEADS] Lead cr\u00E9\u00E9 avec succ\u00E8s:', newLead.id);\r\n    \r\n    // Formatter la r\u00E9ponse comme pour GET\r\n    const formattedLead = {\r\n      id: newLead.id,\r\n      name: `${newLead.firstName} ${newLead.lastName}`,\r\n      firstName: newLead.firstName,\r\n      lastName: newLead.lastName,\r\n      email: newLead.email,\r\n      phone: newLead.phone,\r\n      company: newLead.company,\r\n      status: newLead.status,\r\n      source: newLead.source,\r\n      assignedTo: newLead.User,\r\n      leadStatus: newLead.LeadStatus,\r\n      createdAt: newLead.createdAt,\r\n      updatedAt: newLead.updatedAt,\r\n      statusId: newLead.statusId,\r\n      organizationId: newLead.organizationId,\r\n      assignedToId: newLead.assignedToId,\r\n      data: newLead.data\r\n    };\r\n    \r\n    res.status(201).json(formattedLead);\r\n    \r\n  } catch (error) {\r\n    console.error('[LEADS] Erreur lors de la cr\u00E9ation du lead:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du lead',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/leads/:id\r\nrouter.get('/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    console.log('[LEADS] \uD83D\uDD0D R\u00E9cup\u00E9ration du lead:', id, 'utilisateur:', {\r\n      id: authReq.user?.userId || authReq.user?.id,\r\n      email: authReq.user?.email,\r\n      role: authReq.user?.role,\r\n      isSuperAdmin: authReq.user?.isSuperAdmin,\r\n      organizationId: authReq.user?.organizationId\r\n    });\r\n    \r\n    // SuperAdmin logic: can access ANY lead\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' || \r\n                        authReq.user?.isSuperAdmin === true ||\r\n                        authReq.user?.role?.toLowerCase().includes('super');\r\n    \r\n    console.log('[LEADS] \uD83D\uDC51 V\u00E9rification SuperAdmin:', { \r\n      isSuperAdmin, \r\n      conditions: {\r\n        roleCheck: authReq.user?.role === 'super_admin',\r\n        booleanCheck: authReq.user?.isSuperAdmin === true,\r\n        roleIncludesSuper: authReq.user?.role?.toLowerCase().includes('super')\r\n      }\r\n    });\r\n    \r\n    let whereCondition;\r\n    \r\n    if (isSuperAdmin) {\r\n      console.log('[LEADS] \uD83C\uDF0D SuperAdmin d\u00E9tect\u00E9 - acc\u00E8s \u00E0 TOUS les leads');\r\n      whereCondition = { id }; // SuperAdmin peut acc\u00E9der \u00E0 n'importe quel lead\r\n    } else {\r\n      if (!organizationId) {\r\n        return res.status(400).json({ \r\n          error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n        });\r\n      }\r\n      console.log('[LEADS] \uD83C\uDFE2 Utilisateur normal - acc\u00E8s limit\u00E9 \u00E0 l\\'organisation:', organizationId);\r\n      whereCondition = {\r\n        id,\r\n        organizationId // S\u00E9curit\u00E9: s'assurer que le lead appartient \u00E0 l'organisation\r\n      };\r\n    }\r\n    \r\n    const lead = await prisma.lead.findFirst({\r\n      where: whereCondition,\r\n      include: {\r\n        User: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        LeadStatus: true,\r\n        Organization: {\r\n          select: {\r\n            id: true,\r\n            name: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!lead) {\r\n      console.log('[LEADS] Lead non trouv\u00E9:', id);\r\n      return res.status(404).json({ \r\n        error: 'Lead non trouv\u00E9 ou non autoris\u00E9' \r\n      });\r\n    }\r\n    \r\n    // Transformer pour le frontend (m\u00EAme logique que la liste)\r\n    const data = lead.data || {};\r\n    const formattedLead = {\r\n      id: lead.id,\r\n      name: lead.firstName && lead.lastName ? `${lead.firstName} ${lead.lastName}` : \r\n            (lead.firstName || lead.lastName || data.name || `Lead ${lead.id.slice(0, 8)}`),\r\n      firstName: lead.firstName || data.firstName || '',\r\n      lastName: lead.lastName || data.lastName || '',\r\n      email: lead.email || data.email || '',\r\n      phone: lead.phone || data.phone || '',\r\n      company: lead.company || data.company || '',\r\n      status: lead.status,\r\n      source: lead.source || 'unknown',\r\n      assignedTo: lead.User,\r\n      leadStatus: lead.LeadStatus,\r\n      createdAt: lead.createdAt,\r\n      updatedAt: lead.updatedAt,\r\n      statusId: lead.statusId,\r\n      organizationId: lead.organizationId,\r\n      assignedToId: lead.assignedToId,\r\n      notes: lead.notes || data.notes || '',\r\n      website: lead.website || data.website || '',\r\n      linkedin: lead.linkedin || data.linkedin || '',\r\n      lastContactDate: lead.lastContactDate,\r\n      nextFollowUpDate: lead.nextFollowUpDate,\r\n      // Donn\u00E9es additionnelles pour la compatibilit\u00E9\r\n      data: lead.data\r\n    };\r\n    \r\n    console.log('[LEADS] Lead trouv\u00E9 et format\u00E9:', formattedLead.name);\r\n    res.json(formattedLead);\r\n    \r\n  } catch (error) {\r\n    console.error('[LEADS] Erreur lors de la r\u00E9cup\u00E9ration du lead:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration du lead',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// PUT /api/leads/:id - Modifier un lead\r\nrouter.put('/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n    const organizationId = authReq.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        error: 'Organisation non sp\u00E9cifi\u00E9e' \r\n      });\r\n    }\r\n    \r\n    console.log('[LEADS] Modification du lead:', id, 'donn\u00E9es:', req.body);\r\n    \r\n    // V\u00E9rifier que le lead existe et appartient \u00E0 l'organisation\r\n    const existingLead = await prisma.lead.findFirst({\r\n      where: {\r\n        id,\r\n        organizationId\r\n      }\r\n    });\r\n    \r\n    if (!existingLead) {\r\n      console.log('[LEADS] Lead non trouv\u00E9 pour modification:', id);\r\n      return res.status(404).json({ \r\n        error: 'Lead non trouv\u00E9 ou non autoris\u00E9' \r\n      });\r\n    }\r\n    \r\n    // Extraire les champs \u00E0 mettre \u00E0 jour\r\n    const {\r\n      firstName,\r\n      lastName,\r\n      email,\r\n      phone,\r\n      company,\r\n      source,\r\n      status,\r\n      statusId,\r\n      notes,\r\n      website,\r\n      linkedin,\r\n      assignedToId,\r\n      nextFollowUpDate,\r\n      data\r\n    } = req.body;\r\n    \r\n    // Pr\u00E9parer les donn\u00E9es de mise \u00E0 jour\r\n    const updateData: Partial<{\r\n      firstName: string;\r\n      lastName: string;\r\n      email: string;\r\n      phone: string;\r\n      company: string;\r\n      source: string;\r\n      status: string;\r\n      statusId: string;\r\n      notes: string;\r\n      website: string;\r\n      linkedin: string;\r\n      assignedToId: string;\r\n      nextFollowUpDate: Date | null;\r\n      data: object | null;\r\n    }> = {};\r\n    \r\n    if (firstName !== undefined) updateData.firstName = firstName;\r\n    if (lastName !== undefined) updateData.lastName = lastName;\r\n    if (email !== undefined) updateData.email = email;\r\n    if (phone !== undefined) updateData.phone = phone;\r\n    if (company !== undefined) updateData.company = company;\r\n    if (source !== undefined) updateData.source = source;\r\n    \r\n    // Validation et normalisation du statut\r\n    if (status !== undefined) {\r\n      const validStatuses = ['new', 'contacted', 'meeting', 'proposal', 'won', 'lost'];\r\n      \r\n      // Mapping des anciens statuts vers les nouveaux\r\n      const statusMapping: Record<string, string> = {\r\n        'nouveau': 'new',\r\n        'en_cours': 'contacted',\r\n        'contacte': 'contacted',\r\n        'contact\u00E9': 'contacted',\r\n        'rdv': 'meeting',\r\n        'rendez_vous': 'meeting',\r\n        'devis': 'proposal',\r\n        'gagne': 'won',\r\n        'gagn\u00E9': 'won',\r\n        'perdu': 'lost',\r\n        'termine': 'won',\r\n        'termin\u00E9': 'won'\r\n      };\r\n      \r\n      const normalizedStatus = statusMapping[status.toLowerCase()] || status;\r\n      \r\n      if (!validStatuses.includes(normalizedStatus)) {\r\n        console.warn('[LEADS] Statut invalide:', status, '- utilisation de \"new\" par d\u00E9faut');\r\n        updateData.status = 'new';\r\n      } else {\r\n        updateData.status = normalizedStatus;\r\n      }\r\n    }\r\n    \r\n    if (statusId !== undefined) updateData.statusId = statusId;\r\n    if (notes !== undefined) updateData.notes = notes;\r\n    if (website !== undefined) updateData.website = website;\r\n    if (linkedin !== undefined) updateData.linkedin = linkedin;\r\n    if (assignedToId !== undefined) updateData.assignedToId = assignedToId;\r\n    if (nextFollowUpDate !== undefined) updateData.nextFollowUpDate = nextFollowUpDate ? new Date(nextFollowUpDate) : null;\r\n    if (data !== undefined) updateData.data = data;\r\n    \r\n    // Mettre \u00E0 jour le lead (forcer updatedAt)\r\n    const updatedLead = await prisma.lead.update({\r\n      where: { id },\r\n      data: { \r\n        ...updateData,\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        User: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        LeadStatus: true\r\n      }\r\n    });\r\n    \r\n    console.log('[LEADS] Lead modifi\u00E9 avec succ\u00E8s:', updatedLead.id);\r\n    \r\n    // Formatter la r\u00E9ponse\r\n    const formattedLead = {\r\n      id: updatedLead.id,\r\n      name: updatedLead.firstName && updatedLead.lastName ? `${updatedLead.firstName} ${updatedLead.lastName}` : \r\n            (updatedLead.firstName || updatedLead.lastName || updatedLead.data?.name || `Lead ${updatedLead.id.slice(0, 8)}`),\r\n      firstName: updatedLead.firstName || '',\r\n      lastName: updatedLead.lastName || '',\r\n      email: updatedLead.email || '',\r\n      phone: updatedLead.phone || '',\r\n      company: updatedLead.company || '',\r\n      status: updatedLead.status,\r\n      source: updatedLead.source || 'unknown',\r\n      assignedTo: updatedLead.User,\r\n      leadStatus: updatedLead.LeadStatus,\r\n      createdAt: updatedLead.createdAt,\r\n      updatedAt: updatedLead.updatedAt,\r\n      statusId: updatedLead.statusId,\r\n      organizationId: updatedLead.organizationId,\r\n      assignedToId: updatedLead.assignedToId,\r\n      notes: updatedLead.notes || '',\r\n      website: updatedLead.website || '',\r\n      linkedin: updatedLead.linkedin || '',\r\n      nextFollowUpDate: updatedLead.nextFollowUpDate,\r\n      data: updatedLead.data\r\n    };\r\n    \r\n    res.json(formattedLead);\r\n    \r\n  } catch (error) {\r\n    console.error('[LEADS] Erreur lors de la modification du lead:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la modification du lead',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE /api/leads/:id\r\nrouter.delete('/:id', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n\r\n    console.log('[LEADS] \uD83D\uDDD1\uFE0F Demande de suppression du lead:', id, 'par utilisateur:', {\r\n      id: authReq.user?.userId || authReq.user?.id,\r\n      email: authReq.user?.email,\r\n      role: authReq.user?.role,\r\n      isSuperAdmin: authReq.user?.isSuperAdmin,\r\n      organizationId: authReq.user?.organizationId\r\n    });\r\n\r\n    // D\u00E9tection SuperAdmin (m\u00EAme logique que GET/PUT)\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' ||\r\n                         authReq.user?.isSuperAdmin === true ||\r\n                         authReq.user?.role?.toLowerCase().includes('super');\r\n\r\n    // Pour les utilisateurs non-superadmin, on exige l'organisation et on v\u00E9rifie l'appartenance\r\n  const whereCondition: { id: string; organizationId?: string } = { id };\r\n    if (!isSuperAdmin) {\r\n      const organizationId = authReq.user?.organizationId;\r\n      if (!organizationId) {\r\n        return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n      }\r\n      whereCondition.organizationId = organizationId;\r\n    }\r\n\r\n    // V\u00E9rifier l'existence et l'autorisation\r\n    const existing = await prisma.lead.findFirst({ where: whereCondition });\r\n    if (!existing) {\r\n      console.log('[LEADS] \u274C Lead non trouv\u00E9 ou non autoris\u00E9 pour suppression:', id);\r\n      return res.status(404).json({ error: 'Lead non trouv\u00E9 ou non autoris\u00E9' });\r\n    }\r\n\r\n    // Supprimer le lead\r\n    await prisma.lead.delete({ where: { id } });\r\n    console.log('[LEADS] \u2705 Lead supprim\u00E9 avec succ\u00E8s:', id);\r\n    // 204 No Content pour simplifier la gestion c\u00F4t\u00E9 client (converti en {success:true})\r\n    return res.status(204).send();\r\n  } catch (error) {\r\n    console.error('[LEADS] Erreur lors de la suppression du lead:', error);\r\n    // Conflits potentiels li\u00E9s aux contraintes d\u2019int\u00E9grit\u00E9 (FK)\r\n    return res.status(500).json({\r\n      error: 'Erreur lors de la suppression du lead',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// Historique du lead (GET): lecture depuis lead.data.history\r\nrouter.get('/:id/history', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' || \r\n      authReq.user?.isSuperAdmin === true ||\r\n      authReq.user?.role?.toLowerCase().includes('super');\r\n\r\n    const whereCond = isSuperAdmin\r\n      ? { id }\r\n      : { id, organizationId: authReq.user?.organizationId };\r\n\r\n    const lead = await prisma.lead.findFirst({ where: whereCond });\r\n    if (!lead) return res.status(404).json({ success: false, error: 'Lead non trouv\u00E9 ou non autoris\u00E9' });\r\n\r\n    type HistoryItem = { type: string; content: string; author: string; createdAt: string };\r\n    type LeadDataShape = { history?: HistoryItem[] } & Record<string, unknown>;\r\n    const dataObj: LeadDataShape = (lead.data as object | null) as LeadDataShape || {};\r\n    const history: HistoryItem[] = Array.isArray(dataObj.history) ? dataObj.history : [];\r\n    return res.json({ success: true, data: history });\r\n  } catch (e) {\r\n    console.error('[LEADS] GET history error', e);\r\n    return res.status(500).json({ success: false, error: 'Erreur lors du chargement de l\\'historique' });\r\n  }\r\n});\r\n\r\n// Ajout d'une entr\u00E9e d'historique (POST): append dans lead.data.history\r\nrouter.post('/:id/history', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n    const organizationId = authReq.user?.organizationId;\r\n\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' || \r\n      authReq.user?.isSuperAdmin === true ||\r\n      authReq.user?.role?.toLowerCase().includes('super');\r\n\r\n    const whereCond = isSuperAdmin\r\n      ? { id }\r\n      : { id, organizationId };\r\n\r\n    const lead = await prisma.lead.findFirst({ where: whereCond });\r\n    if (!lead) return res.status(404).json({ success: false, error: 'Lead non trouv\u00E9 ou non autoris\u00E9' });\r\n\r\n    const { type = 'internal', content = '', author } = (req.body || {}) as Partial<{ type: string; content: string; author: string }>;\r\n    const historyItem = {\r\n      type,\r\n      content,\r\n      author: author || (authReq.user?.email ?? 'system'),\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    type HistoryItem = typeof historyItem;\r\n    type LeadDataShape = { history?: HistoryItem[] } & Record<string, unknown>;\r\n    const dataObj: LeadDataShape = (lead.data as object | null) as LeadDataShape || {};\r\n    const existing: HistoryItem[] = Array.isArray(dataObj.history) ? dataObj.history : [];\r\n    dataObj.history = [historyItem, ...existing];\r\n\r\n    await prisma.lead.update({ where: { id: lead.id }, data: { data: dataObj } });\r\n    return res.status(201).json({ success: true, item: historyItem });\r\n  } catch (e) {\r\n    console.error('[LEADS] POST history error', e);\r\n    return res.status(500).json({ success: false, error: 'Erreur lors de l\\'ajout \u00E0 l\\'historique' });\r\n  }\r\n});\r\n\r\n// Documents du lead (GET): lecture depuis lead.data.documents\r\nrouter.get('/:id/documents', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' || \r\n      authReq.user?.isSuperAdmin === true ||\r\n      authReq.user?.role?.toLowerCase().includes('super');\r\n\r\n    const whereCond = isSuperAdmin\r\n      ? { id }\r\n      : { id, organizationId: authReq.user?.organizationId };\r\n\r\n    const lead = await prisma.lead.findFirst({ where: whereCond });\r\n    if (!lead) return res.status(404).json({ success: false, error: 'Lead non trouv\u00E9 ou non autoris\u00E9' });\r\n\r\n    type LeadDoc = { id: string; name: string; type?: string; url?: string | null; createdAt?: string; meta?: unknown };\r\n    type LeadDataShape = { documents?: LeadDoc[] } & Record<string, unknown>;\r\n    const dataObj: LeadDataShape = (lead.data as object | null) as LeadDataShape || {};\r\n    const docs: LeadDoc[] = Array.isArray(dataObj.documents) ? dataObj.documents : [];\r\n    return res.json({ success: true, data: docs });\r\n  } catch (e) {\r\n    console.error('[LEADS] GET documents error', e);\r\n    return res.status(500).json({ success: false, error: 'Erreur lors du chargement des documents' });\r\n  }\r\n});\r\n\r\n// Ajout d'un document li\u00E9 (POST): append dans lead.data.documents\r\nrouter.post('/:id/documents', async (req, res) => {\r\n  try {\r\n    const authReq = req as AuthenticatedRequest;\r\n    const { id } = req.params;\r\n    const organizationId = authReq.user?.organizationId;\r\n\r\n    const isSuperAdmin = authReq.user?.role === 'super_admin' || \r\n      authReq.user?.isSuperAdmin === true ||\r\n      authReq.user?.role?.toLowerCase().includes('super');\r\n\r\n    const whereCond = isSuperAdmin\r\n      ? { id }\r\n      : { id, organizationId };\r\n\r\n    const lead = await prisma.lead.findFirst({ where: whereCond });\r\n    if (!lead) return res.status(404).json({ success: false, error: 'Lead non trouv\u00E9 ou non autoris\u00E9' });\r\n\r\n  const body = (req.body || {}) as Partial<{ id: string; name: string; type: string; url: string; meta: unknown }>;\r\n    // Normaliser l'\u00E9l\u00E9ment document minimal\r\n    const newDoc = {\r\n      id: body.id || cryptoRandomId(),\r\n      name: body.name || 'Document',\r\n      type: body.type || 'devis',\r\n      url: body.url || null,\r\n      createdAt: new Date().toISOString(),\r\n      meta: body.meta || {}\r\n    };\r\n\r\n  type LeadDoc = { id: string; name: string; type?: string; url?: string | null; createdAt?: string; meta?: unknown };\r\n  type LeadDataShape = { documents?: LeadDoc[] } & Record<string, unknown>;\r\n  const dataObj: LeadDataShape = (lead.data as object | null) as LeadDataShape || {};\r\n  const existingDocs: LeadDoc[] = Array.isArray(dataObj.documents) ? dataObj.documents : [];\r\n    const updatedDocs = [newDoc, ...existingDocs];\r\n    dataObj.documents = updatedDocs;\r\n\r\n    await prisma.lead.update({ where: { id: lead.id }, data: { data: dataObj } });\r\n    return res.status(201).json({ success: true, item: newDoc });\r\n  } catch (e) {\r\n    console.error('[LEADS] POST documents error', e);\r\n    return res.status(500).json({ success: false, error: 'Erreur lors de l\\'ajout du document' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\nimport type { AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { z } from 'zod';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83E\uDDF9 SANITISATION SIMPLE ET EFFICACE\r\nconst sanitizeString = (input: string): string => {\r\n  return input.trim().replace(/[<>]/g, ''); // Supprime < et >\r\n};\r\n\r\n// \uD83D\uDD12 VALIDATION ZOD ULTRA-STRICTE\r\nconst roleCreateSchema = z.object({\r\n  name: z.string()\r\n    .min(2, 'Nom du r\u00F4le minimum 2 caract\u00E8res')\r\n    .max(50, 'Nom du r\u00F4le maximum 50 caract\u00E8res')\r\n    .regex(/^[a-zA-Z0-9_\\-\\s]+$/, 'Nom du r\u00F4le contient des caract\u00E8res non autoris\u00E9s'),\r\n  description: z.string()\r\n    .max(500, 'Description maximum 500 caract\u00E8res')\r\n    .optional(),\r\n  organizationId: z.string()\r\n    .uuid('ID organisation invalide')\r\n    .optional()\r\n});\r\n\r\nconst roleUpdateSchema = z.object({\r\n  name: z.string()\r\n    .min(2, 'Nom du r\u00F4le minimum 2 caract\u00E8res')\r\n    .max(50, 'Nom du r\u00F4le maximum 50 caract\u00E8res')\r\n    .regex(/^[a-zA-Z0-9_\\-\\s]+$/, 'Nom du r\u00F4le contient des caract\u00E8res non autoris\u00E9s')\r\n    .optional(),\r\n  description: z.string()\r\n    .max(500, 'Description maximum 500 caract\u00E8res')\r\n    .optional()\r\n});\r\n\r\nconst roleQuerySchema = z.object({\r\n  // Accepter 'current' OU n'importe quelle cha\u00EEne non vide (IDs personnalis\u00E9s autoris\u00E9s)\r\n  organizationId: z.string()\r\n    .min(1, 'ID organisation invalide')\r\n    .optional()\r\n});\r\n\r\n// \uD83D\uDEE1\uFE0F RATE LIMITING ADAPT\u00C9\r\nconst rolesRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: 100, // 100 requ\u00EAtes max (lecture fr\u00E9quente)\r\n  message: { \r\n    success: false, \r\n    message: 'Trop de requ\u00EAtes sur les r\u00F4les, r\u00E9essayez plus tard' \r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false\r\n});\r\n\r\nconst rolesCreateRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes  \r\n  max: 10, // 10 cr\u00E9ations max\r\n  message: { \r\n    success: false, \r\n    message: 'Trop de cr\u00E9ations de r\u00F4les, r\u00E9essayez plus tard' \r\n  }\r\n});\r\n\r\n// \uD83D\uDD27 GESTION ERREURS ZOD CENTRALIS\u00C9E\r\nconst handleZodError = (error: z.ZodError) => {\r\n  return {\r\n    success: false,\r\n    message: 'Donn\u00E9es invalides',\r\n    errors: error.errors.map(e => `${e.path.join('.')}: ${e.message}`)\r\n  };\r\n};\r\n\r\n// Appliquer l'authentification et rate limiting\r\nrouter.use(authMiddleware);\r\nrouter.use(rolesRateLimit);\r\n\r\n// \uD83C\uDFF7\uFE0F GET /api/roles - S\u00C9CURIS\u00C9 AVEC ZOD + SANITISATION\r\nrouter.get('/', async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ROLES] GET /roles - R\u00E9cup\u00E9ration des r\u00F4les S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    // \uD83D\uDD0D VALIDATION ZOD QUERY PARAMS\r\n    const queryValidation = roleQuerySchema.safeParse(req.query);\r\n    if (!queryValidation.success) {\r\n      console.log('[ROLES] Validation \u00E9chou\u00E9e:', queryValidation.error);\r\n      res.status(400).json(handleZodError(queryValidation.error));\r\n      return;\r\n    }\r\n\r\n    const { organizationId } = queryValidation.data;\r\n    const requestingUser = req.user;\r\n    \r\n    console.log(`[ROLES] User role: ${requestingUser?.role}`);\r\n    console.log(`[ROLES] Organization ID: ${organizationId || requestingUser?.organizationId}`);\r\n    \r\n    // \u2705 LOGIQUE UNIFI\u00C9E ET CORRIG\u00C9E\r\n    let finalOrganizationId: string | undefined | null = organizationId;\r\n    if (organizationId === 'current') {\r\n      finalOrganizationId = requestingUser?.organizationId;\r\n    }\r\n\r\n  const whereClause: Record<string, unknown> = {};\r\n\r\n    // Si un ID d'organisation est sp\u00E9cifi\u00E9 (et r\u00E9solu), on retourne:\r\n    // 1. Les r\u00F4les sp\u00E9cifiques \u00E0 cette organisation\r\n    // 2. Les r\u00F4les globaux (organizationId: null)\r\n    if (finalOrganizationId) {\r\n      whereClause.OR = [\r\n        { organizationId: finalOrganizationId },\r\n        { organizationId: null } // R\u00F4les globaux\r\n      ];\r\n    }\r\n    \r\n    // Si l'utilisateur n'est PAS super_admin, on force le filtrage sur son organisation\r\n    // pour des raisons de s\u00E9curit\u00E9, \u00E9crasant tout autre filtre.\r\n    if (requestingUser?.role !== 'super_admin') {\r\n      whereClause.OR = [\r\n        { organizationId: requestingUser?.organizationId },\r\n        { organizationId: null } // R\u00F4les globaux toujours disponibles\r\n      ];\r\n      console.log(`[ROLES] Non-SuperAdmin: Filtering for org ${requestingUser?.organizationId} + global roles`);\r\n    }\r\n\r\n    // Si aucun filtre d'organisation n'est sp\u00E9cifi\u00E9 et que c'est un super_admin,\r\n    // retourner tous les r\u00F4les (globaux et sp\u00E9cifiques)\r\n    if (!finalOrganizationId && requestingUser?.role === 'super_admin') {\r\n      // Pas de filtre - retourner tous les r\u00F4les\r\n      console.log('[ROLES] SuperAdmin: Returning all roles (global and organization-specific)');\r\n    }\r\n\r\n    console.log('[ROLES] Final where clause:', whereClause);\r\n\r\n    const roles = await prisma.role.findMany({\r\n      where: whereClause,\r\n      include: {\r\n        Permission: true,\r\n        Organization: true\r\n      },\r\n      orderBy: { name: 'asc' }\r\n    });\r\n      \r\n    console.log(`[ROLES] Found ${roles.length} total roles based on filter.`);\r\n    res.status(200).json({ success: true, data: roles });\r\n    return;\r\n    \r\n  } catch (error: unknown) {\r\n    console.error('[ROLES] Erreur lors de la r\u00E9cup\u00E9ration des r\u00F4les:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur interne lors de la r\u00E9cup\u00E9ration des r\u00F4les' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F GET /api/roles/:id - R\u00C9CUP\u00C9RER UN R\u00D4LE S\u00C9CURIS\u00C9\r\nrouter.get('/:id', async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n  console.log(`[ROLES] GET /roles/${id} - R\u00E9cup\u00E9ration du r\u00F4le S\u00C9CURIS\u00C9E`);\r\n  \r\n  try {\r\n    // \uD83D\uDD12 VALIDATION ZOD PARAMS\r\n    if (!id || typeof id !== 'string' || id.trim() === '') {\r\n      res.status(400).json({\r\n        success: false,\r\n        message: 'ID du r\u00F4le invalide'\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!req.user) {\r\n      res.status(401).json({ \r\n        success: false, \r\n        message: \"Utilisateur non authentifi\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    const requestingUser = req.user;\r\n    const sanitizedId = sanitizeString(id.trim());\r\n\r\n    // \uD83D\uDD0D R\u00C9CUP\u00C9RATION S\u00C9CURIS\u00C9E DU R\u00D4LE\r\n    const role = await prisma.role.findUnique({\r\n      where: { id: sanitizedId },\r\n      include: {\r\n        Permission: true,\r\n        UserOrganizations: {\r\n          include: {\r\n            Organization: true,\r\n            User: {\r\n              select: { id: true, firstName: true, lastName: true, email: true }\r\n            }\r\n          }\r\n        },\r\n        Organization: true\r\n      }\r\n    });\r\n\r\n    if (!role) {\r\n      res.status(404).json({ \r\n        success: false, \r\n        message: \"R\u00F4le non trouv\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    // \uD83D\uDD10 V\u00C9RIFICATION PERMISSIONS RENFORC\u00C9E\r\n    if (requestingUser.role !== 'super_admin') {\r\n      if (!requestingUser.organizationId || role.organizationId !== requestingUser.organizationId) {\r\n        res.status(403).json({ \r\n          success: false, \r\n          message: \"Acc\u00E8s refus\u00E9: vous ne pouvez voir que les r\u00F4les de votre organisation\" \r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    console.log(`[ROLES] R\u00F4le \"${role.name}\" r\u00E9cup\u00E9r\u00E9 avec succ\u00E8s`);\r\n    res.json({ \r\n      success: true, \r\n      data: role \r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ROLES] Error fetching role:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur interne du serveur' \r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/roles - Cr\u00E9er un nouveau r\u00F4le\r\n// \uD83C\uDFF7\uFE0F POST /api/roles - CR\u00C9ER UN R\u00D4LE S\u00C9CURIS\u00C9\r\nrouter.post('/', rolesCreateRateLimit, async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  console.log('[ROLES] POST /roles - Cr\u00E9ation d\\'un r\u00F4le S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    // \uD83D\uDD12 VALIDATION ZOD ULTRA-STRICTE\r\n    const bodyValidation = roleCreateSchema.safeParse(req.body);\r\n    if (!bodyValidation.success) {\r\n      console.log('[ROLES] Validation cr\u00E9ation \u00E9chou\u00E9e:', bodyValidation.error);\r\n      res.status(400).json(handleZodError(bodyValidation.error));\r\n      return;\r\n    }\r\n\r\n    if (!req.user) {\r\n      res.status(401).json({ \r\n        success: false, \r\n        message: \"Utilisateur non authentifi\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    const requestingUser = req.user;\r\n    const { name, description, organizationId } = bodyValidation.data;\r\n\r\n    // \uD83E\uDDF9 SANITISATION DES ENTR\u00C9ES\r\n    const sanitizedName = sanitizeString(name);\r\n    const sanitizedDescription = description ? sanitizeString(description) : '';\r\n\r\n    console.log(`[ROLES] Cr\u00E9ation r\u00F4le: ${sanitizedName} pour org: ${organizationId || requestingUser.organizationId}`);\r\n\r\n    // \uD83D\uDD10 V\u00C9RIFICATION PERMISSIONS RENFORC\u00C9E\r\n    if (requestingUser.role !== 'super_admin') {\r\n      const targetOrgId = organizationId || requestingUser.organizationId;\r\n      \r\n      if (!requestingUser.organizationId || requestingUser.organizationId !== targetOrgId) {\r\n        res.status(403).json({ \r\n          success: false, \r\n          message: \"Acc\u00E8s refus\u00E9: vous ne pouvez cr\u00E9er des r\u00F4les que pour votre organisation\" \r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    // \uD83D\uDD0D V\u00C9RIFIER UNICIT\u00C9 DU NOM DANS L'ORGANISATION\r\n    const finalOrgId = organizationId || requestingUser.organizationId;\r\n    const existingRole = await prisma.role.findFirst({\r\n      where: {\r\n        name: sanitizedName,\r\n        organizationId: finalOrgId\r\n      }\r\n    });\r\n\r\n    if (existingRole) {\r\n      res.status(409).json({\r\n        success: false,\r\n        message: `Un r\u00F4le avec le nom \"${sanitizedName}\" existe d\u00E9j\u00E0 dans cette organisation`\r\n      });\r\n      return;\r\n    }\r\n\r\n    // \uD83D\uDEAB Interdire la cr\u00E9ation d'un r\u00F4le r\u00E9serv\u00E9 \"super_admin\"\r\n    if (sanitizedName === 'super_admin') {\r\n      res.status(400).json({\r\n        success: false,\r\n        message: 'Le nom de r\u00F4le \"super_admin\" est r\u00E9serv\u00E9 et ne peut pas \u00EAtre cr\u00E9\u00E9.'\r\n      });\r\n      return;\r\n    }\r\n\r\n    const newRole = await prisma.role.create({\r\n      data: {\r\n        id: `role_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n        name: sanitizedName,\r\n        label: sanitizedName,\r\n        description: sanitizedDescription,\r\n        organizationId: finalOrgId,\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      },\r\n      include: {\r\n        UserOrganizations: {\r\n          include: {\r\n            Organization: true,\r\n            User: true\r\n          }\r\n        },\r\n        Organization: true\r\n      }\r\n    });\r\n\r\n    console.log(`[ROLES] R\u00F4le cr\u00E9\u00E9 avec succ\u00E8s: ${newRole.id}`);\r\n    res.status(201).json({ \r\n      success: true, \r\n      data: newRole,\r\n      message: `R\u00F4le \"${sanitizedName}\" cr\u00E9\u00E9 avec succ\u00E8s`\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ROLES] Error creating role:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\n// PUT /api/roles/:id - Mettre \u00E0 jour un r\u00F4le\r\n// \uD83C\uDFF7\uFE0F PUT /api/roles/:id - MODIFIER UN R\u00D4LE S\u00C9CURIS\u00C9  \r\nrouter.put('/:id', async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n  console.log(`[ROLES] PUT /roles/${id} - Mise \u00E0 jour du r\u00F4le S\u00C9CURIS\u00C9E`);\r\n  \r\n  try {\r\n    // \uD83D\uDD12 VALIDATION ZOD PARAMS + BODY\r\n    if (!id || typeof id !== 'string' || id.trim() === '') {\r\n      res.status(400).json({\r\n        success: false,\r\n        message: 'ID du r\u00F4le invalide'\r\n      });\r\n      return;\r\n    }\r\n\r\n    const bodyValidation = roleUpdateSchema.safeParse(req.body);\r\n    if (!bodyValidation.success) {\r\n      console.log('[ROLES] Validation modification \u00E9chou\u00E9e:', bodyValidation.error);\r\n      res.status(400).json(handleZodError(bodyValidation.error));\r\n      return;\r\n    }\r\n\r\n    if (!req.user) {\r\n      res.status(401).json({ \r\n        success: false, \r\n        message: \"Utilisateur non authentifi\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    const requestingUser = req.user;\r\n    const { name, description } = bodyValidation.data;\r\n\r\n    // \uD83E\uDDF9 SANITISATION DES ENTR\u00C9ES\r\n    const sanitizedName = name ? sanitizeString(name) : undefined;\r\n    const sanitizedDescription = description ? sanitizeString(description) : undefined;\r\n\r\n    // \uD83D\uDD0D V\u00C9RIFIER EXISTENCE DU R\u00D4LE\r\n    const existingRole = await prisma.role.findUnique({\r\n      where: { id: id.trim() }\r\n    });\r\n\r\n    if (!existingRole) {\r\n      res.status(404).json({ \r\n        success: false, \r\n        message: \"R\u00F4le non trouv\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    // \uD83D\uDD10 V\u00C9RIFICATION PERMISSIONS RENFORC\u00C9E\r\n    if (requestingUser.role !== 'super_admin') {\r\n      if (!requestingUser.organizationId || existingRole.organizationId !== requestingUser.organizationId) {\r\n        res.status(403).json({ \r\n          success: false, \r\n          message: \"Acc\u00E8s refus\u00E9: vous ne pouvez modifier que les r\u00F4les de votre organisation\" \r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    // \uFFFD Interdire toute modification du r\u00F4le r\u00E9serv\u00E9 \"super_admin\" (coh\u00E9rent avec l'UI)\r\n    if (existingRole.name === 'super_admin') {\r\n      res.status(403).json({\r\n        success: false,\r\n        message: 'Le r\u00F4le \"super_admin\" est prot\u00E9g\u00E9 et ne peut pas \u00EAtre modifi\u00E9.'\r\n      });\r\n      return;\r\n    }\r\n\r\n    // \uFFFD\uD83D\uDD0D V\u00C9RIFIER UNICIT\u00C9 DU NOUVEAU NOM (SI CHANG\u00C9)\r\n    if (sanitizedName && sanitizedName !== existingRole.name) {\r\n      const duplicateRole = await prisma.role.findFirst({\r\n        where: {\r\n          name: sanitizedName,\r\n          organizationId: existingRole.organizationId,\r\n          id: { not: id.trim() }\r\n        }\r\n      });\r\n\r\n      if (duplicateRole) {\r\n        res.status(409).json({\r\n          success: false,\r\n          message: `Un r\u00F4le avec le nom \"${sanitizedName}\" existe d\u00E9j\u00E0 dans cette organisation`\r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    // \uD83D\uDCDD CONSTRUIRE LES DONN\u00C9ES \u00C0 METTRE \u00C0 JOUR\r\n    const updateData: {\r\n      updatedAt: Date;\r\n      name?: string;\r\n      label?: string;\r\n      description?: string;\r\n    } = {\r\n      updatedAt: new Date()\r\n    };\r\n\r\n    if (sanitizedName !== undefined) {\r\n      updateData.name = sanitizedName;\r\n      updateData.label = sanitizedName; // Synchroniser label avec name\r\n    }\r\n\r\n    if (sanitizedDescription !== undefined) {\r\n      updateData.description = sanitizedDescription;\r\n    }\r\n\r\n    const updatedRole = await prisma.role.update({\r\n      where: { id: id.trim() },\r\n      data: updateData,\r\n      include: {\r\n        UserOrganizations: {\r\n          include: {\r\n            Organization: true,\r\n            User: true\r\n          }\r\n        },\r\n        Organization: true\r\n      }\r\n    });\r\n\r\n    console.log(`[ROLES] R\u00F4le modifi\u00E9 avec succ\u00E8s: ${updatedRole.id}`);\r\n    res.status(200).json({ \r\n      success: true, \r\n      data: updatedRole,\r\n      message: 'R\u00F4le modifi\u00E9 avec succ\u00E8s'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ROLES] Erreur lors de la modification du r\u00F4le:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur interne lors de la modification du r\u00F4le' \r\n    });\r\n  }\r\n});\r\n\r\n// DELETE /api/roles/:id - Supprimer un r\u00F4le\r\n// \uD83C\uDFF7\uFE0F DELETE /api/roles/:id - SUPPRIMER UN R\u00D4LE S\u00C9CURIS\u00C9\r\nrouter.delete('/:id', async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n  console.log(`[ROLES] DELETE /roles/${id} - Suppression du r\u00F4le S\u00C9CURIS\u00C9E`);\r\n  \r\n  try {\r\n    // \uD83D\uDD12 VALIDATION PARAMS\r\n    if (!id || typeof id !== 'string' || id.trim() === '') {\r\n      res.status(400).json({\r\n        success: false,\r\n        message: 'ID du r\u00F4le invalide'\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!req.user) {\r\n      res.status(401).json({ \r\n        success: false, \r\n        message: \"Utilisateur non authentifi\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    const requestingUser = req.user;\r\n    const roleId = id.trim();\r\n\r\n    // \uD83D\uDD0D V\u00C9RIFIER EXISTENCE DU R\u00D4LE\r\n    const existingRole = await prisma.role.findUnique({\r\n      where: { id: roleId },\r\n      include: {\r\n        UserOrganizations: true // Pour v\u00E9rifier s'il y a des utilisateurs assign\u00E9s\r\n      }\r\n    });\r\n\r\n    if (!existingRole) {\r\n      res.status(404).json({ \r\n        success: false, \r\n        message: \"R\u00F4le non trouv\u00E9\" \r\n      });\r\n      return;\r\n    }\r\n\r\n    // \uD83D\uDD10 V\u00C9RIFICATION PERMISSIONS RENFORC\u00C9E\r\n    if (requestingUser.role !== 'super_admin') {\r\n      if (!requestingUser.organizationId || existingRole.organizationId !== requestingUser.organizationId) {\r\n        res.status(403).json({ \r\n          success: false, \r\n          message: \"Acc\u00E8s refus\u00E9: vous ne pouvez supprimer que les r\u00F4les de votre organisation\" \r\n        });\r\n        return;\r\n      }\r\n    }\r\n\r\n    // \uD83D\uDEAB Interdire la suppression du r\u00F4le r\u00E9serv\u00E9 \"super_admin\" (s\u00E9curit\u00E9 syst\u00E8me)\r\n    if (existingRole.name === 'super_admin') {\r\n      res.status(400).json({\r\n        success: false,\r\n        message: 'Le r\u00F4le \"super_admin\" est prot\u00E9g\u00E9 et ne peut pas \u00EAtre supprim\u00E9.'\r\n      });\r\n      return;\r\n    }\r\n\r\n    // \u26A0\uFE0F V\u00C9RIFIER QU'AUCUN UTILISATEUR N'EST ASSIGN\u00C9\r\n    if (existingRole.UserOrganizations && existingRole.UserOrganizations.length > 0) {\r\n      res.status(409).json({\r\n        success: false,\r\n        message: `Impossible de supprimer le r\u00F4le \"${existingRole.name}\": ${existingRole.UserOrganizations.length} utilisateur(s) y sont encore assign\u00E9(s)`\r\n      });\r\n      return;\r\n    }\r\n\r\n    // \uD83D\uDDD1\uFE0F SUPPRESSION S\u00C9CURIS\u00C9E\r\n    await prisma.role.delete({\r\n      where: { id: roleId }\r\n    });\r\n\r\n    console.log(`[ROLES] R\u00F4le supprim\u00E9 avec succ\u00E8s: ${roleId} (${existingRole.name})`);\r\n    res.status(200).json({ \r\n      success: true, \r\n      message: `R\u00F4le \"${existingRole.name}\" supprim\u00E9 avec succ\u00E8s` \r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[ROLES] Erreur lors de la suppression du r\u00F4le:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport invitationRoutes from './invitations.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { z } from 'zod';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\n// Type pour les requ\u00EAtes authentifi\u00E9es\r\ninterface AuthenticatedRequest extends Request {\r\n  user?: {\r\n    id: string;\r\n    email: string;\r\n    organizationId?: string;\r\n    isSuperAdmin?: boolean;\r\n  };\r\n}\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83E\uDDF9 SANITISATION SIMPLE (sans DOMPurify)\r\nconst sanitizeString = (input: string): string => {\r\n  return input.trim().replace(/[<>]/g, ''); // Supprime < et >\r\n};\r\n\r\n// \uD83D\uDD12 VALIDATION ZOD ULTRA-STRICTE\r\nconst userUpdateSchema = z.object({\r\n  // Accepter des IDs non-UUID (ex: cuid, cha\u00EEnes custom)\r\n  roleId: z.string().min(1, 'ID r\u00F4le requis').optional(),\r\n  status: z.enum(['ACTIVE', 'INACTIVE'], {\r\n    errorMap: () => ({ message: 'Statut doit \u00EAtre ACTIVE ou INACTIVE' })\r\n  }).optional()\r\n});\r\n\r\nconst userOrganizationSchema = z.object({\r\n  // IDs non-UUID support\u00E9s\r\n  userId: z.string().min(1, 'ID utilisateur requis'),\r\n  organizationId: z.string().min(1, 'ID organisation requis'),\r\n  roleId: z.string().min(1, 'ID r\u00F4le requis')\r\n});\r\n\r\n// \uD83D\uDEE1\uFE0F RATE LIMITING ADAPT\u00C9\r\nconst usersRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: 200, // 200 requ\u00EAtes max\r\n  message: { \r\n    success: false, \r\n    message: 'Trop de requ\u00EAtes utilisateurs, r\u00E9essayez plus tard' \r\n  }\r\n});\r\n\r\nconst usersModifyRateLimit = rateLimit({\r\n  windowMs: 10 * 60 * 1000, // 10 minutes\r\n  max: 30, // 30 modifications max\r\n  message: { \r\n    success: false, \r\n    message: 'Trop de modifications utilisateurs, r\u00E9essayez plus tard' \r\n  }\r\n});\r\n\r\n// \uD83D\uDD27 GESTION ERREURS ZOD CENTRALIS\u00C9E\r\nconst handleZodError = (error: z.ZodError) => {\r\n  return {\r\n    success: false,\r\n    message: 'Donn\u00E9es invalides',\r\n    errors: error.errors.map(e => `${e.path.join('.')}: ${e.message}`)\r\n  };\r\n};\r\n\r\n// Appliquer l'authentification et rate limiting\r\nrouter.use(authMiddleware);\r\nrouter.use(usersRateLimit);\r\n\r\n// Monter les routes d'invitations sous /users/invitations\r\nrouter.use('/invitations', invitationRoutes);\r\n\r\n// \uD83C\uDFF7\uFE0F GET /api/users/free - S\u00C9CURIS\u00C9 AVEC ZOD + SANITISATION\r\nrouter.get('/free', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  console.log('[USERS] GET /users/free - R\u00E9cup\u00E9ration utilisateurs libres S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    const freeUsers = await prisma.user.findMany({\r\n      where: {\r\n        UserOrganization: {\r\n          none: {}\r\n        }\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        createdAt: true,\r\n        status: true\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    \r\n    console.log(`[USERS] Found ${freeUsers.length} free users`);\r\n    res.json({ success: true, data: freeUsers });\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur r\u00E9cup\u00E9ration utilisateurs libres:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des utilisateurs libres' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F GET /api/users - S\u00C9CURIS\u00C9 AVEC LOGIQUE SUPER ADMIN\r\nrouter.get('/', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response) => {\r\n  console.log('[USERS] GET /users - R\u00E9cup\u00E9ration utilisateurs S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    const sessionUser = req.user;\r\n\r\n    // LOGIQUE SUPERADMIN - Montrer TOUS les utilisateurs\r\n    if (sessionUser?.isSuperAdmin) {\r\n      console.log('[USERS] SuperAdmin request - showing ALL users');\r\n      \r\n      const allUsers = await prisma.user.findMany({\r\n        include: {\r\n          UserOrganization: {\r\n            include: {\r\n              Role: true,\r\n              Organization: {\r\n                include: {\r\n                  GoogleWorkspaceConfig: true\r\n                }\r\n              },\r\n            },\r\n          },\r\n        },\r\n        orderBy: { createdAt: 'desc' }\r\n      });\r\n      \r\n      console.log(`[USERS] Found ${allUsers.length} total users for SuperAdmin`);\r\n      return res.json({ success: true, data: allUsers });\r\n    }\r\n\r\n    // LOGIQUE UTILISATEUR NORMAL - Organisation uniquement\r\n    const organizationId = sessionUser?.organizationId;\r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: \"L'ID de l'organisation est manquant\" \r\n      });\r\n    }\r\n\r\n    console.log(`[USERS] Standard user request - org: ${organizationId}`);\r\n    \r\n    const usersInOrg = await prisma.user.findMany({\r\n      where: {\r\n        UserOrganization: {\r\n          some: { organizationId }\r\n        }\r\n      },\r\n      include: {\r\n        UserOrganization: {\r\n          where: { organizationId },\r\n          include: {\r\n            Role: true,\r\n            Organization: {\r\n              include: {\r\n                GoogleWorkspaceConfig: true\r\n              }\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    console.log(`[USERS] Found ${usersInOrg.length} users for org ${organizationId}`);\r\n    res.json({ success: true, data: usersInOrg });\r\n\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur r\u00E9cup\u00E9ration utilisateurs:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur interne du serveur' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F GET /api/users/:userId/organizations - S\u00C9CURIS\u00C9\r\nrouter.get('/:userId/organizations', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  const { userId } = req.params;\r\n  console.log(`[USERS] GET /users/${userId}/organizations - S\u00C9CURIS\u00C9`);\r\n  \r\n  try {\r\n    // Validation souple: accepter toute cha\u00EEne non vide (IDs non-UUID)\r\n    if (!userId || !z.string().min(1).safeParse(userId).success) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID utilisateur invalide ou manquant'\r\n      });\r\n    }\r\n\r\n    const userOrganizations = await prisma.userOrganization.findMany({\r\n      where: { userId: sanitizeString(userId) },\r\n      include: {\r\n        Organization: true,\r\n        Role: true,\r\n      },\r\n      orderBy: {\r\n        Organization: { name: 'asc' }\r\n      }\r\n    });\r\n    \r\n    console.log(`[USERS] Found ${userOrganizations.length} organizations for user ${userId}`);\r\n    res.json({ success: true, data: userOrganizations });\r\n  } catch (error) {\r\n    console.error(`[USERS] Erreur organisations utilisateur ${userId}:`, error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: \"Erreur interne du serveur\" \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F POST /api/users/user-organizations - S\u00C9CURIS\u00C9 AVEC ZOD\r\nrouter.post('/user-organizations', usersModifyRateLimit, requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  console.log('[USERS] POST /users/user-organizations - Assignation S\u00C9CURIS\u00C9E');\r\n  \r\n  try {\r\n    // Validation Zod\r\n    const validation = userOrganizationSchema.safeParse(req.body);\r\n    if (!validation.success) {\r\n      console.log('[USERS] Validation \u00E9chou\u00E9e:', validation.error);\r\n      return res.status(400).json(handleZodError(validation.error));\r\n    }\r\n\r\n    const { userId, organizationId, roleId } = validation.data;\r\n\r\n    // G\u00E9n\u00E9ration d'un ID et des timestamps requis (schema: UserOrganization.id sans default, updatedAt sans default)\r\n    const newId = `uo_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\r\n    const now = new Date();\r\n\r\n    // V\u00E9rifier si l'assignation existe d\u00E9j\u00E0\r\n    const existingAssignment = await prisma.userOrganization.findFirst({\r\n      where: { userId, organizationId }\r\n    });\r\n\r\n    if (existingAssignment) {\r\n      return res.status(409).json({ \r\n        success: false, \r\n        message: \"L'utilisateur est d\u00E9j\u00E0 dans cette organisation\" \r\n      });\r\n    }\r\n\r\n    const newUserOrganization = await prisma.userOrganization.create({\r\n      data: {\r\n        id: newId,\r\n        userId,\r\n        organizationId,\r\n        roleId,\r\n        status: 'ACTIVE',\r\n        updatedAt: now\r\n      },\r\n      include: {\r\n        Organization: true,\r\n        Role: true,\r\n      }\r\n    });\r\n\r\n    console.log(`[USERS] Assignation r\u00E9ussie: user ${userId} \u2192 org ${organizationId}`);\r\n    res.status(201).json({ success: true, data: newUserOrganization });\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur assignation utilisateur:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: \"Erreur interne du serveur\" \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F PATCH /api/users/user-organizations/:userOrganizationId - S\u00C9CURIS\u00C9 AVEC ZOD\r\nrouter.patch('/user-organizations/:userOrganizationId', usersModifyRateLimit, requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  const { userOrganizationId } = req.params;\r\n  console.log(`[USERS] PATCH /users/user-organizations/${userOrganizationId} - S\u00C9CURIS\u00C9`);\r\n  \r\n  try {\r\n    // Validation souple: accepter toute cha\u00EEne non vide (IDs non-UUID)\r\n    if (!userOrganizationId || !z.string().min(1).safeParse(userOrganizationId).success) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID relation utilisateur-organisation invalide ou manquant'\r\n      });\r\n    }\r\n\r\n    // Validation Zod body\r\n    const validation = userUpdateSchema.safeParse(req.body);\r\n    if (!validation.success) {\r\n      console.log('[USERS] Validation \u00E9chou\u00E9e:', validation.error);\r\n      return res.status(400).json(handleZodError(validation.error));\r\n    }\r\n\r\n  const { roleId, status } = validation.data;\r\n  const updateData: Partial<{ roleId: string; status: 'ACTIVE' | 'INACTIVE'; updatedAt: Date }> = {};\r\n    if (roleId) updateData.roleId = roleId;\r\n    if (status) updateData.status = status;\r\n  updateData.updatedAt = new Date();\r\n\r\n    if (Object.keys(updateData).length === 0) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: \"Aucune donn\u00E9e de mise \u00E0 jour fournie\" \r\n      });\r\n    }\r\n\r\n    const updatedUserOrganization = await prisma.userOrganization.update({\r\n      where: { id: sanitizeString(userOrganizationId) },\r\n      data: updateData,\r\n      include: {\r\n        Organization: true,\r\n        Role: true,\r\n        User: { select: { id: true, email: true, firstName: true, lastName: true } }\r\n      }\r\n    });\r\n\r\n    console.log(`[USERS] Mise \u00E0 jour r\u00E9ussie: relation ${userOrganizationId}`);\r\n    res.json({ success: true, data: updatedUserOrganization });\r\n  } catch (error: unknown) {\r\n    // Prisma P2025: Record to update not found\r\n    const e = error as { code?: string } | undefined;\r\n    if (e?.code === 'P2025') {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: \"Relation utilisateur-organisation introuvable\"\r\n      });\r\n    }\r\n    console.error('[USERS] Erreur mise \u00E0 jour utilisateur:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: \"Erreur interne du serveur\" \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F DELETE /api/users/user-organizations/:userOrganizationId - S\u00C9CURIS\u00C9\r\nrouter.delete('/user-organizations/:userOrganizationId', usersModifyRateLimit, requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  const { userOrganizationId } = req.params;\r\n  console.log(`[USERS] DELETE /users/user-organizations/${userOrganizationId} - S\u00C9CURIS\u00C9`);\r\n  \r\n  try {\r\n    // Validation souple: accepter toute cha\u00EEne non vide (IDs non-UUID)\r\n    if (!userOrganizationId || !z.string().min(1).safeParse(userOrganizationId).success) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID relation utilisateur-organisation invalide ou manquant'\r\n      });\r\n    }\r\n\r\n    // V\u00E9rifier si l'utilisateur a d'autres organisations\r\n    const relationToDelete = await prisma.userOrganization.findUnique({\r\n      where: { id: sanitizeString(userOrganizationId) },\r\n      select: { userId: true }\r\n    });\r\n\r\n    if (!relationToDelete) {\r\n      return res.status(404).json({ \r\n        success: false, \r\n        message: \"Relation non trouv\u00E9e\" \r\n      });\r\n    }\r\n\r\n    const remainingRelations = await prisma.userOrganization.count({\r\n      where: {\r\n        userId: relationToDelete.userId,\r\n        id: { not: sanitizeString(userOrganizationId) }\r\n      }\r\n    });\r\n\r\n    if (remainingRelations === 0) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: \"Impossible de supprimer la derni\u00E8re organisation de l'utilisateur\" \r\n      });\r\n    }\r\n\r\n    await prisma.userOrganization.delete({\r\n      where: { id: sanitizeString(userOrganizationId) }\r\n    });\r\n\r\n    console.log(`[USERS] Suppression relation r\u00E9ussie: ${userOrganizationId}`);\r\n    res.json({ success: true, message: \"Utilisateur retir\u00E9 de l'organisation avec succ\u00E8s\" });\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur suppression relation:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: \"Erreur interne du serveur\" \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F PATCH /api/users/:userId - Modifier les informations utilisateur\r\nrouter.patch('/:userId', usersModifyRateLimit, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response) => {\r\n  const { userId } = req.params;\r\n  \r\n  console.log(`[USERS] PATCH /users/${userId} - Modification informations utilisateur`);\r\n  \r\n  try {\r\n    // Sch\u00E9ma de validation pour les informations utilisateur\r\n    const userInfoSchema = z.object({\r\n      firstName: z.string().min(1, 'Pr\u00E9nom requis').max(50, 'Pr\u00E9nom trop long').optional(),\r\n      lastName: z.string().min(1, 'Nom requis').max(50, 'Nom trop long').optional(),\r\n      email: z.string().email('Email invalide').optional(),\r\n      phoneNumber: z.string().nullable().optional(),\r\n      address: z.string().nullable().optional(), \r\n      vatNumber: z.string().nullable().optional(),\r\n      avatarUrl: z.string().url('URL avatar invalide').nullable().optional()\r\n    });\r\n\r\n    // Validation des donn\u00E9es\r\n    const validationResult = userInfoSchema.safeParse(req.body);\r\n    if (!validationResult.success) {\r\n      console.error('[USERS] Validation error:', validationResult.error.errors);\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Donn\u00E9es invalides',\r\n        errors: validationResult.error.errors\r\n      });\r\n    }\r\n\r\n    const updateData = validationResult.data;\r\n    const sessionUser = req.user;\r\n\r\n    // V\u00E9rifier que l'utilisateur existe\r\n    const userToUpdate = await prisma.user.findUnique({\r\n      where: { id: sanitizeString(userId) }\r\n    });\r\n\r\n    if (!userToUpdate) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Utilisateur non trouv\u00E9'\r\n      });\r\n    }\r\n\r\n    // V\u00E9rification des permissions\r\n    if (!sessionUser?.isSuperAdmin) {\r\n      // Les admins ne peuvent modifier que les utilisateurs de leur organisation\r\n      const userOrganization = await prisma.userOrganization.findFirst({\r\n        where: {\r\n          userId: sanitizeString(userId),\r\n          organizationId: sessionUser?.organizationId\r\n        }\r\n      });\r\n\r\n      if (!userOrganization) {\r\n        return res.status(403).json({\r\n          success: false,\r\n          message: 'Vous ne pouvez modifier que les utilisateurs de votre organisation'\r\n        });\r\n      }\r\n    }\r\n\r\n    // Mise \u00E0 jour de l'utilisateur\r\n    const updatedUser = await prisma.user.update({\r\n      where: { id: sanitizeString(userId) },\r\n      data: updateData,\r\n      include: {\r\n        UserOrganization: {\r\n          include: {\r\n            Role: true,\r\n            Organization: {\r\n              include: {\r\n                GoogleWorkspaceConfig: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    console.log(`[USERS] User ${sessionUser?.email} updated user ${updatedUser.email}`);\r\n    res.json({\r\n      success: true,\r\n      message: 'Informations utilisateur mises \u00E0 jour avec succ\u00E8s',\r\n      data: updatedUser\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur modification utilisateur:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur interne du serveur lors de la modification'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFF7\uFE0F DELETE /api/users/:userId - ADMIN ET SUPER ADMIN - S\u00C9CURIS\u00C9\r\nrouter.delete('/:userId', usersModifyRateLimit, requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response) => {\r\n  const { userId } = req.params;\r\n  const sessionUser = req.user;\r\n  console.log(`[USERS] DELETE /users/${userId} - ADMIN/SUPER ADMIN S\u00C9CURIS\u00C9`);\r\n  \r\n  try {\r\n    // Validation souple: accepter toute cha\u00EEne non vide (IDs non-UUID)\r\n    if (!userId || !z.string().min(1).safeParse(userId).success) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID utilisateur invalide ou manquant'\r\n      });\r\n    }\r\n\r\n    // V\u00E9rifier que l'utilisateur existe\r\n    const userToDelete = await prisma.user.findUnique({\r\n      where: { id: sanitizeString(userId) },\r\n      include: { UserOrganization: true }\r\n    });\r\n\r\n    if (!userToDelete) {\r\n      return res.status(404).json({ \r\n        success: false, \r\n        message: \"Utilisateur non trouv\u00E9\" \r\n      });\r\n    }\r\n\r\n    // Emp\u00EAcher l'auto-suppression\r\n    if (userToDelete.id === sessionUser?.id) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: \"Vous ne pouvez pas supprimer votre propre compte\" \r\n      });\r\n    }\r\n\r\n    // LOGIQUE POUR ADMIN NON-SUPERADMIN\r\n    if (!sessionUser?.isSuperAdmin) {\r\n      // Un admin normal ne peut supprimer que :\r\n      // 1. Les utilisateurs libres (sans organisation)\r\n      // 2. Les utilisateurs de sa propre organisation\r\n      \r\n      const isUserFree = userToDelete.UserOrganization.length === 0;\r\n      const isInSameOrg = userToDelete.UserOrganization.some(\r\n        uo => uo.organizationId === sessionUser?.organizationId\r\n      );\r\n      \r\n      if (!isUserFree && !isInSameOrg) {\r\n        return res.status(403).json({\r\n          success: false,\r\n          message: \"Vous ne pouvez supprimer que les utilisateurs libres ou de votre organisation\"\r\n        });\r\n      }\r\n    }\r\n\r\n    // Transaction s\u00E9curis\u00E9e\r\n    await prisma.$transaction(async (tx) => {\r\n      // Supprimer toutes les relations UserOrganization\r\n      await tx.userOrganization.deleteMany({\r\n        where: { userId: sanitizeString(userId) }\r\n      });\r\n\r\n      // Supprimer l'utilisateur\r\n      await tx.user.delete({\r\n        where: { id: sanitizeString(userId) }\r\n      });\r\n    });\r\n\r\n    console.log(`[USERS] User ${sessionUser?.email} deleted user ${userToDelete.email}`);\r\n    res.json({ \r\n      success: true, \r\n      message: `Utilisateur ${userToDelete.email} supprim\u00E9 avec succ\u00E8s` \r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur suppression utilisateur:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: \"Erreur interne du serveur lors de la suppression\" \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCCA NOUVEAU ENDPOINT: R\u00E9sum\u00E9 des droits d'un utilisateur dans une organisation\r\nrouter.get('/:userId/rights-summary', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  try {\r\n    const { userId } = req.params;\r\n    const { organizationId } = req.query;\r\n\r\n    console.log(`[USERS] R\u00E9cup\u00E9ration du r\u00E9sum\u00E9 des droits pour utilisateur ${userId} dans organisation ${organizationId}`);\r\n\r\n    if (!userId || !organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'ID utilisateur et organisation requis'\r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer les informations utilisateur avec ses relations dans l'organisation\r\n    const userWithOrgInfo = await prisma.user.findUnique({\r\n      where: { id: sanitizeString(userId) },\r\n      include: {\r\n        UserOrganization: {\r\n          where: { organizationId: sanitizeString(organizationId as string) },\r\n          include: {\r\n            Role: {\r\n              include: {\r\n                Permission: {\r\n                  include: {\r\n                    Module: true\r\n                  }\r\n                }\r\n              }\r\n            },\r\n            Organization: {\r\n              include: {\r\n                Module: {\r\n                  where: { active: true },\r\n                  orderBy: { order: 'asc' }\r\n                },\r\n                OrganizationModuleStatus: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!userWithOrgInfo) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Utilisateur non trouv\u00E9'\r\n      });\r\n    }\r\n\r\n    const userOrgRelation = userWithOrgInfo.UserOrganization[0];\r\n    if (!userOrgRelation) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Utilisateur non associ\u00E9 \u00E0 cette organisation'\r\n      });\r\n    }\r\n\r\n    const organization = userOrgRelation.Organization;\r\n    const role = userOrgRelation.Role;\r\n    const permissions = role.Permission;\r\n\r\n    // Structurer les permissions par module\r\n    const permissionsByModule: { [moduleKey: string]: { label: string; actions: string[] } } = {};\r\n    \r\n    permissions.forEach(permission => {\r\n      if (permission.allowed && permission.Module) {\r\n        const moduleKey = permission.Module.key;\r\n        if (!permissionsByModule[moduleKey]) {\r\n          permissionsByModule[moduleKey] = {\r\n            label: permission.Module.label,\r\n            actions: []\r\n          };\r\n        }\r\n        permissionsByModule[moduleKey].actions.push(permission.action);\r\n      }\r\n    });\r\n\r\n    // Construire la r\u00E9ponse\r\n    interface RightsSummaryResponse {\r\n      userInfo: {\r\n        id: string; email: string; firstName: string | null; lastName: string | null; accountStatus: string; lastConnection: Date;\r\n      };\r\n      organizationInfo: { id: string; name: string; status: string | null; moduleCount: number };\r\n      roles: string[];\r\n      permissions: { [k: string]: { label: string; actions: string[]; isActive?: boolean; synthetic?: boolean } };\r\n      synthetic?: boolean;\r\n    }\r\n    const rightsSummary: RightsSummaryResponse = {\r\n      userInfo: {\r\n        id: userWithOrgInfo.id,\r\n        email: userWithOrgInfo.email,\r\n        firstName: userWithOrgInfo.firstName,\r\n        lastName: userWithOrgInfo.lastName,\r\n        accountStatus: userWithOrgInfo.status,\r\n        lastConnection: userWithOrgInfo.updatedAt\r\n      },\r\n      organizationInfo: {\r\n        id: organization.id,\r\n        name: organization.name,\r\n        status: organization.status,\r\n        moduleCount: organization.Module.length\r\n      },\r\n      roles: [role.label],\r\n      permissions: permissionsByModule\r\n    };\r\n\r\n    // \uD83D\uDE80 Fallback Super Admin : si aucun enregistrement de permission explicite pour ce r\u00F4le\r\n    const isSuperAdminRole = role.label?.toLowerCase().includes('super') && role.label?.toLowerCase().includes('admin');\r\n    if (isSuperAdminRole && Object.keys(permissionsByModule).length === 0) {\r\n      console.log('[USERS][rights-summary] Aucun permission explicite trouv\u00E9e pour un r\u00F4le SuperAdmin \u2013 g\u00E9n\u00E9ration synth\u00E9tique de toutes les permissions actives.');\r\n      // R\u00E9cup\u00E9rer toutes les actions disponibles par module (m\u00EAme non \"allowed\")\r\n      const moduleIds = organization.Module.map(m => m.id);\r\n      if (moduleIds.length > 0) {\r\n        const rawPerms = await prisma.permission.findMany({\r\n          where: { moduleId: { in: moduleIds } },\r\n          include: { Module: true }\r\n        });\r\n        const synthetic: { [k: string]: { label: string; actions: string[]; isActive?: boolean; synthetic?: boolean } } = {};\r\n        rawPerms.forEach(p => {\r\n          if (!p.Module) return;\r\n          const key = p.Module.key;\r\n          if (!synthetic[key]) {\r\n            synthetic[key] = { label: p.Module.label || key, actions: [], isActive: true, synthetic: true };\r\n          }\r\n          if (!synthetic[key].actions.includes(p.action)) {\r\n            synthetic[key].actions.push(p.action);\r\n          }\r\n        });\r\n        rightsSummary.permissions = synthetic;\r\n        rightsSummary.organizationInfo.moduleCount = Object.keys(synthetic).length;\r\n        rightsSummary.synthetic = true;\r\n        console.log(`[USERS][rights-summary] Permissions synth\u00E9tiques g\u00E9n\u00E9r\u00E9es: ${Object.keys(synthetic).length} modules.`);\r\n      }\r\n    }\r\n\r\n    console.log(`[USERS] R\u00E9sum\u00E9 des droits g\u00E9n\u00E9r\u00E9 pour ${userWithOrgInfo.email} dans ${organization.name}`);\r\n    console.log(`[USERS] R\u00F4le: ${role.label}, Permissions: ${Object.keys(rightsSummary.permissions).length} modules (synthetic=${rightsSummary.synthetic ? 'yes' : 'no'})`);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: rightsSummary\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[USERS] Erreur r\u00E9cup\u00E9ration r\u00E9sum\u00E9 des droits:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur interne du serveur lors de la r\u00E9cup\u00E9ration du r\u00E9sum\u00E9 des droits'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authenticateToken } from '../middleware/auth.js';\r\n\r\nconst router = Router();\r\n\r\n// Appliquer l'authentification \u00E0 toutes les routes (Admin uniquement)\r\nrouter.use(authenticateToken);\r\n\r\n// GET /api/admin-password/users-emails - R\u00E9cup\u00E9rer les emails des utilisateurs\r\nrouter.get('/users-emails', (_req, res) => {\r\n  console.log('[ADMIN-PASSWORD] GET /admin-password/users-emails - R\u00E9cup\u00E9ration des emails');\r\n  \r\n  // Donn\u00E9es par d\u00E9faut pour \u00E9viter les erreurs frontend\r\n  const defaultUsersEmails = [\r\n    {\r\n      id: '1',\r\n      userId: '1',\r\n      firstName: 'Admin',\r\n      lastName: 'System',\r\n      email: 'admin@2thier.be',\r\n      organization: '2thier.be',\r\n      hasEmailConfig: true,\r\n      lastEmailCheck: new Date().toISOString()\r\n    },\r\n    {\r\n      id: '2',\r\n      userId: '2',\r\n      firstName: 'John',\r\n      lastName: 'Doe',\r\n      email: 'john.doe@example.com',\r\n      organization: 'Example Corp',\r\n      hasEmailConfig: false,\r\n      lastEmailCheck: null\r\n    }\r\n  ];\r\n\r\n  res.json(defaultUsersEmails);\r\n});\r\n\r\n// GET /api/admin-password/users-services - R\u00E9cup\u00E9rer les utilisateurs avec leurs services\r\nrouter.get('/users-services', (_req, res) => {\r\n  console.log('[ADMIN-PASSWORD] GET /admin-password/users-services - R\u00E9cup\u00E9ration des utilisateurs et services');\r\n  \r\n  // Donn\u00E9es par d\u00E9faut pour \u00E9viter les erreurs frontend\r\n  const defaultUsersServices = [\r\n    {\r\n      id: '1',\r\n      userId: '1',\r\n      firstName: 'Admin',\r\n      lastName: 'System',\r\n      email: 'admin@2thier.be',\r\n      organization: '2thier.be',\r\n      services: {\r\n        email: { configured: true, status: 'active' },\r\n        calendar: { configured: true, status: 'active' },\r\n        drive: { configured: false, status: 'inactive' }\r\n      }\r\n    },\r\n    {\r\n      id: '2',\r\n      userId: '2',\r\n      firstName: 'John',\r\n      lastName: 'Doe',\r\n      email: 'john.doe@example.com',\r\n      organization: 'Example Corp',\r\n      services: {\r\n        email: { configured: false, status: 'inactive' },\r\n        calendar: { configured: false, status: 'inactive' },\r\n        drive: { configured: false, status: 'inactive' }\r\n      }\r\n    }\r\n  ];\r\n\r\n  res.json(defaultUsersServices);\r\n});\r\n\r\n// POST /api/admin-password/configure-email - Configurer l'email pour un utilisateur\r\nrouter.post('/configure-email', (_req, res) => {\r\n  console.log('[ADMIN-PASSWORD] POST /admin-password/configure-email - Configuration email');\r\n  \r\n  res.status(201).json({\r\n    success: true,\r\n    message: 'Configuration email mise \u00E0 jour avec succ\u00E8s',\r\n    configuredAt: new Date().toISOString()\r\n  });\r\n});\r\n\r\n// PUT /api/admin-password/update-password - Mettre \u00E0 jour le mot de passe\r\nrouter.put('/update-password', (_req, res) => {\r\n  console.log('[ADMIN-PASSWORD] PUT /admin-password/update-password - Mise \u00E0 jour mot de passe');\r\n  \r\n  res.json({\r\n    success: true,\r\n    message: 'Mot de passe mis \u00E0 jour avec succ\u00E8s',\r\n    updatedAt: new Date().toISOString()\r\n  });\r\n});\r\n\r\n// GET /api/admin-password/email-status/:userId - Statut email d'un utilisateur\r\nrouter.get('/email-status/:userId', (req, res) => {\r\n  const { userId } = req.params;\r\n  console.log(`[ADMIN-PASSWORD] GET /admin-password/email-status/${userId} - Statut email`);\r\n  \r\n  res.json({\r\n    userId,\r\n    hasEmailConfig: true,\r\n    lastSync: new Date().toISOString(),\r\n    status: 'active'\r\n  });\r\n});\r\n\r\nexport default router;\r\n", "import express from 'express';\r\nimport rateLimit from 'express-rate-limit';\r\nimport { z } from 'zod';\r\nimport { PrismaClient, UserService as PrismaUserService } from '@prisma/client';\r\nimport { authMiddleware as authenticateToken } from '../middlewares/auth.js';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = express.Router();\r\n\r\n// Rate limiting pour les services\r\nconst servicesRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: 100, // Augment\u00E9 pour les appels bulk l\u00E9gitimes\r\n  message: {\r\n    success: false,\r\n    message: 'Trop de requ\u00EAtes vers les services. Veuillez patienter.'\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n});\r\n\r\n// Sch\u00E9mas de validation Zod\r\nconst serviceParamsSchema = z.object({\r\n  serviceName: z.enum(['email', 'telnyx']),\r\n  // Certains environnements utilisent des IDs non-UUID (cuid, etc.)\r\n  userId: z.string().min(1, 'ID utilisateur invalide')\r\n});\r\n\r\n// Middleware d'authentification\r\n// @ts-expect-error Le middleware est compatible\r\nrouter.use(authenticateToken);\r\nrouter.use(servicesRateLimit);\r\n\r\n// Fonction utilitaire pour activer/d\u00E9sactiver un service\r\nconst handleServiceToggle = async (res: express.Response, userId: string, serviceType: 'EMAIL' | 'TELNYX', isActive: boolean) => {\r\n  try {\r\n    // Relax: accepter tout ID non vide pour compat\r\n    const validatedUserId = z.string().min(1).parse(userId);\r\n    \r\n    await prisma.userService.upsert({\r\n      where: {\r\n        userId_serviceType: { userId: validatedUserId, serviceType }\r\n      },\r\n      update: { isActive },\r\n      create: { userId: validatedUserId, serviceType, isActive, isConfigured: false },\r\n    });\r\n    \r\n    res.json({ \r\n      success: true, \r\n      message: `Service ${serviceType} mis \u00E0 jour.`,\r\n      data: { userId: validatedUserId, serviceType, isActive }\r\n    });\r\n  } catch (error) {\r\n    console.error(`[API/Services] Erreur lors de la mise \u00E0 jour du service ${serviceType}:`, error);\r\n    if (error instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, message: 'Param\u00E8tres invalides', errors: error.errors });\r\n    }\r\n    res.status(500).json({ success: false, message: `Impossible de mettre \u00E0 jour le service ${serviceType}.`});\r\n  }\r\n};\r\n\r\n// Helper pour normaliser la sortie c\u00F4t\u00E9 front (serviceName en lower-case)\r\nconst mapService = (s: PrismaUserService) => ({\r\n  id: s.id,\r\n  userId: s.userId,\r\n  serviceType: s.serviceType,\r\n  serviceName: s.serviceType.toLowerCase(),\r\n  isActive: s.isActive,\r\n  isConfigured: s.isConfigured,\r\n  email: s.email ?? undefined,\r\n  phoneNumber: s.phoneNumber ?? undefined,\r\n  apiKey: s.apiKey ?? undefined,\r\n  data: s.data ?? undefined,\r\n  createdAt: s.createdAt,\r\n  updatedAt: s.updatedAt,\r\n});\r\n\r\n// **ROUTE CORRIG\u00C9E** : R\u00E9cup\u00E9rer TOUS les services pour un utilisateur (corrige le 404)\r\nrouter.get('/status/:userId', async (req, res) => {\r\n  try {\r\n    const { userId } = z.object({ userId: z.string().min(1) }).parse(req.params);\r\n    const services = await prisma.userService.findMany({ where: { userId } });\r\n    res.json({ success: true, data: services.map(mapService) });\r\n  } catch (error) {\r\n    console.error(`[API/Services] Erreur GET /status/${req.params.userId}:`, error);\r\n    if (error instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, message: 'ID utilisateur invalide.' });\r\n    }\r\n    res.status(500).json({ success: false, message: 'Erreur serveur.' });\r\n  }\r\n});\r\n\r\n// **NOUVELLE ROUTE OPTIMIS\u00C9E** : R\u00E9cup\u00E9rer les services pour plusieurs utilisateurs\r\nrouter.post('/status/bulk', async (req, res) => {\r\n  try {\r\n    const { userIds } = z.object({ userIds: z.array(z.string().min(1)) }).parse(req.body);\r\n    if (userIds.length === 0) {\r\n      return res.json({ success: true, data: {} });\r\n    }\r\n    const services = await prisma.userService.findMany({\r\n      where: { userId: { in: userIds } },\r\n    });\r\n    const servicesByUser = services.reduce<Record<string, ReturnType<typeof mapService>[]>>((acc, service) => {\r\n      if (!acc[service.userId]) acc[service.userId] = [];\r\n      acc[service.userId].push(mapService(service));\r\n      return acc;\r\n    }, {});\r\n    res.json({ success: true, data: servicesByUser });\r\n  } catch (error) {\r\n    console.error('[API/Services] Erreur POST /status/bulk:', error);\r\n    if (error instanceof z.ZodError) {\r\n      return res.status(400).json({ success: false, message: 'Donn\u00E9es invalides.' });\r\n    }\r\n    res.status(500).json({ success: false, message: 'Erreur serveur.' });\r\n  }\r\n});\r\n\r\n// Activer un service\r\nrouter.post('/:serviceName/enable/:userId', async (req, res) => {\r\n  const { serviceName, userId } = serviceParamsSchema.parse(req.params);\r\n  await handleServiceToggle(res, userId, serviceName.toUpperCase() as 'EMAIL' | 'TELNYX', true);\r\n});\r\n\r\n// D\u00E9sactiver un service\r\nrouter.post('/:serviceName/disable/:userId', async (req, res) => {\r\n  const { serviceName, userId } = serviceParamsSchema.parse(req.params);\r\n  await handleServiceToggle(res, userId, serviceName.toUpperCase() as 'EMAIL' | 'TELNYX', false);\r\n});\r\n\r\nexport default router;", "import { Router, Response } from 'express';\r\nimport { authMiddleware, AuthenticatedRequest } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { PrismaClient, User } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\n// Type minimal attendu en entr\u00E9e c\u00F4t\u00E9 API\r\ntype MinimalPermissionInput = {\r\n  moduleId?: string | null;\r\n  action: string;\r\n  resource: string;\r\n  allowed: boolean;\r\n};\r\n\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\n\r\n// Helper pour obtenir l'utilisateur effectif (g\u00E8re l'usurpation d'identit\u00E9)\r\nconst getEffectiveUser = async (req: AuthenticatedRequest) => {\r\n    const originalUser = req.user;\r\n    const impersonatedUser = req.impersonatedUser;\r\n\r\n    if (originalUser && originalUser.role === 'super_admin' && impersonatedUser) {\r\n        const userOrg = await prisma.userOrganization.findFirst({\r\n            where: { userId: impersonatedUser.id },\r\n            select: { organizationId: true }\r\n        });\r\n        \r\n        return {\r\n            userId: impersonatedUser.id,\r\n            role: (impersonatedUser as User).role,\r\n            organizationId: req.impersonatedOrganizationId || userOrg?.organizationId,\r\n        };\r\n    }\r\n    return req.user;\r\n};\r\n\r\n\r\n// GET /api/permissions?roleId=...&organizationId=...\r\nrouter.get('/', async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n    const { roleId, organizationId } = req.query;\r\n    \r\n    if (!req.user) {\r\n        res.status(401).json({ success: false, message: \"Utilisateur non authentifi\u00E9.\" });\r\n        return;\r\n    }\r\n    \r\n    const effectiveUser = await getEffectiveUser(req);\r\n\r\n    if (!effectiveUser) {\r\n        res.status(401).json({ success: false, message: \"Utilisateur effectif non d\u00E9termin\u00E9.\" });\r\n        return;\r\n    }\r\n\r\n    if (!roleId) {\r\n        res.status(400).json({ success: false, message: 'Le param\u00E8tre roleId est manquant' });\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const role = await prisma.role.findUnique({\r\n            where: { id: roleId as string },\r\n        });\r\n\r\n        if (!role) {\r\n            res.status(404).json({ success: false, message: \"R\u00F4le non trouv\u00E9.\" });\r\n            return;\r\n        }\r\n\r\n        const isEffectivelySuperAdmin = effectiveUser.role === 'super_admin';\r\n\r\n        if (!isEffectivelySuperAdmin) {\r\n            if (!effectiveUser.organizationId || role.organizationId !== effectiveUser.organizationId) {\r\n                res.status(403).json({ success: false, message: \"Vous n'avez pas la permission de voir les permissions de ce r\u00F4le.\" });\r\n                return;\r\n            }\r\n        } else {\r\n            if (organizationId && role.organizationId && role.organizationId !== (organizationId as string)) {\r\n                 res.status(403).json({ success: false, message: \"Ce r\u00F4le n'appartient pas \u00E0 l'organisation s\u00E9lectionn\u00E9e.\" });\r\n                 return;\r\n            }\r\n        }\r\n\r\n        const permissions = await prisma.permission.findMany({\r\n            where: {\r\n                roleId: roleId as string,\r\n            },\r\n        });\r\n        res.json({ success: true, data: permissions });\r\n    } catch (error) {\r\n        console.error('[API][permissions] Erreur lors de la r\u00E9cup\u00E9ration des permissions :', error);\r\n        res.status(500).json({ success: false, message: 'Erreur interne du serveur' });\r\n    }\r\n});\r\n\r\n// POST /api/permissions/bulk - Met \u00E0 jour plusieurs permissions pour un r\u00F4le\r\nrouter.post('/bulk', async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  const { roleId, permissions, organizationId } = req.body;\r\n  \r\n  if (!req.user) {\r\n    res.status(401).json({ success: false, message: \"Utilisateur non authentifi\u00E9.\" });\r\n    return;\r\n  }\r\n\r\n  const effectiveUser = await getEffectiveUser(req);\r\n\r\n  if (!effectiveUser) {\r\n    res.status(401).json({ success: false, message: \"Utilisateur effectif non d\u00E9termin\u00E9.\" });\r\n    return;\r\n  }\r\n\r\n  if (!roleId || !Array.isArray(permissions)) {\r\n    res.status(400).json({ success: false, message: 'Param\u00E8tres invalides' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const roleToUpdate = await prisma.role.findUnique({\r\n      where: { id: roleId },\r\n    });\r\n\r\n    if (!roleToUpdate) {\r\n      res.status(404).json({ success: false, message: \"R\u00F4le non trouv\u00E9.\" });\r\n      return;\r\n    }\r\n\r\n    const isEffectivelySuperAdmin = effectiveUser.role === 'super_admin';\r\n\r\n    if (!isEffectivelySuperAdmin) {\r\n        if (!effectiveUser.organizationId || roleToUpdate.organizationId !== effectiveUser.organizationId) {\r\n            res.status(403).json({ success: false, message: \"Vous n'avez pas la permission de modifier ce r\u00F4le.\" });\r\n            return;\r\n        }\r\n    } else {\r\n        if (organizationId && roleToUpdate.organizationId && roleToUpdate.organizationId !== organizationId) {\r\n            res.status(403).json({ success: false, message: \"Ce r\u00F4le n'appartient pas \u00E0 l'organisation s\u00E9lectionn\u00E9e.\" });\r\n            return;\r\n        }\r\n    }\r\n\r\n    await prisma.$transaction([\r\n      prisma.permission.deleteMany({\r\n        where: {\r\n          roleId: roleId,\r\n        }\r\n      }),\r\n      ...(permissions.length > 0 ? [prisma.permission.createMany({\r\n        data: (permissions as MinimalPermissionInput[]).map((p) => ({\r\n          id: `perm_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,\r\n          roleId: roleId,\r\n          organizationId: roleToUpdate.organizationId || null,\r\n          moduleId: p.moduleId,\r\n          action: p.action,\r\n          resource: p.resource,\r\n          allowed: p.allowed,\r\n          createdAt: new Date(),\r\n          updatedAt: new Date(),\r\n        })),\r\n        skipDuplicates: true,\r\n      })] : [])\r\n    ]);\r\n\r\n    res.status(200).json({ success: true, message: 'Permissions mises \u00E0 jour avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('[API][permissions/bulk] Erreur lors de la mise \u00E0 jour en masse:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/permissions - Route racine pour la compatibilit\u00E9 avec le frontend\r\nrouter.post('/', async (req: AuthenticatedRequest, res: Response): Promise<void> => {\r\n  // Rediriger vers la route bulk qui fait d\u00E9j\u00E0 tout le travail\r\n  const { roleId, permissions, organizationId } = req.body;\r\n  \r\n  if (!req.user) {\r\n    res.status(401).json({ success: false, message: \"Utilisateur non authentifi\u00E9.\" });\r\n    return;\r\n  }\r\n\r\n  const effectiveUser = await getEffectiveUser(req);\r\n\r\n  if (!effectiveUser) {\r\n    res.status(401).json({ success: false, message: \"Utilisateur effectif non d\u00E9termin\u00E9.\" });\r\n    return;\r\n  }\r\n\r\n  if (!roleId || !Array.isArray(permissions)) {\r\n    res.status(400).json({ success: false, message: 'Param\u00E8tres invalides' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const roleToUpdate = await prisma.role.findUnique({\r\n      where: { id: roleId },\r\n    });\r\n\r\n    if (!roleToUpdate) {\r\n      res.status(404).json({ success: false, message: \"R\u00F4le non trouv\u00E9.\" });\r\n      return;\r\n    }\r\n\r\n    const isEffectivelySuperAdmin = effectiveUser.role === 'super_admin';\r\n\r\n    if (!isEffectivelySuperAdmin) {\r\n        if (!effectiveUser.organizationId || roleToUpdate.organizationId !== effectiveUser.organizationId) {\r\n            res.status(403).json({ success: false, message: \"Vous n'avez pas la permission de modifier ce r\u00F4le.\" });\r\n            return;\r\n        }\r\n    } else {\r\n        if (organizationId && roleToUpdate.organizationId && roleToUpdate.organizationId !== organizationId) {\r\n            res.status(403).json({ success: false, message: \"Ce r\u00F4le n'appartient pas \u00E0 l'organisation s\u00E9lectionn\u00E9e.\" });\r\n            return;\r\n        }\r\n    }\r\n\r\n    await prisma.$transaction([\r\n      prisma.permission.deleteMany({\r\n        where: {\r\n          roleId: roleId,\r\n        }\r\n      }),\r\n      ...(permissions.length > 0 ? [prisma.permission.createMany({\r\n        data: (permissions as MinimalPermissionInput[]).map((p) => ({\r\n          id: `perm_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,\r\n          roleId: roleId,\r\n          organizationId: roleToUpdate.organizationId || null,\r\n          moduleId: p.moduleId,\r\n          action: p.action,\r\n          resource: p.resource,\r\n          allowed: p.allowed,\r\n          createdAt: new Date(),\r\n          updatedAt: new Date(),\r\n        })),\r\n        skipDuplicates: true,\r\n      })] : [])\r\n    ]);\r\n\r\n    res.status(200).json({ success: true, message: 'Permissions mises \u00E0 jour avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('[API][permissions] Erreur lors de la mise \u00E0 jour:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import express, { Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { encrypt } from '../utils/crypto';\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = express.Router();\r\n\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\n\r\n// Route pour r\u00E9cup\u00E9rer un utilisateur par son ID (pour restaurer l'impersonation)\r\nrouter.get('/users/:id', requireRole(['super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const { id } = req.params;\r\n  try {\r\n    const user = await prisma.user.findUnique({\r\n      where: { id: id },\r\n      select: { // On ne s\u00E9lectionne que les champs n\u00E9cessaires\r\n        id: true,\r\n        email: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        role: true,\r\n        status: true,\r\n      }\r\n    });\r\n\r\n    if (!user) {\r\n      res.status(404).json({ error: 'Utilisateur non trouv\u00E9' });\r\n      return;\r\n    }\r\n    res.json(user);\r\n  } catch (error) {\r\n    console.error(`Erreur lors de la r\u00E9cup\u00E9ration de l'utilisateur ${id}:`, error);\r\n    res.status(500).json({ error: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\n// Route pour r\u00E9cup\u00E9rer le statut mail de tous les utilisateurs (pour l'admin)\r\nrouter.get('/users/mail-status', requireRole(['super_admin']), async (_req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const users = await prisma.user.findMany({\r\n      include: {\r\n        mailSettings: true,\r\n      },\r\n    });\r\n\r\n    const usersWithMailStatus = users.map(user => {\r\n      return {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email,\r\n        isMailConfigured: user.mailSettings?.isVerified ?? false,\r\n      };\r\n    });\r\n\r\n    res.json(usersWithMailStatus);\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r\u00E9cup\u00E9ration des utilisateurs:', error);\r\n    res.status(500).json({ error: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\n// Route pour d\u00E9finir/mettre \u00E0 jour le mot de passe mail d'un utilisateur\r\nrouter.post('/mail/settings', requireRole(['super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const { userId, password } = req.body;\r\n\r\n  if (!userId || !password) {\r\n    res.status(400).json({ error: \"L'ID de l'utilisateur et le mot de passe sont requis.\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const user = await prisma.user.findUnique({ where: { id: userId } });\r\n    if (!user) {\r\n      res.status(404).json({ error: 'Utilisateur non trouv\u00E9.' });\r\n      return;\r\n    }\r\n\r\n    const userName = `${user.firstName || ''} ${user.lastName || ''}`.trim();\r\n    if (!userName) {\r\n        res.status(400).json({ error: \"Le nom de l'utilisateur n'est pas d\u00E9fini, impossible de cr\u00E9er l'adresse email.\" });\r\n        return;\r\n    }\r\n\r\n    const encryptedPassword = encrypt(password);\r\n    const userEmail = `${userName.replace(/\\s+/g, '.').toLowerCase()}@2thier.be`;\r\n\r\n    await prisma.mailSettings.upsert({\r\n      where: { userId },\r\n      update: {\r\n        encryptedPassword: encryptedPassword,\r\n        isVerified: true,\r\n      },\r\n      create: {\r\n        userId,\r\n        emailAddress: userEmail,\r\n        encryptedPassword: encryptedPassword,\r\n        imapHost: 'imap.one.com',\r\n        imapPort: 993,\r\n        smtpHost: 'mail.one.com',\r\n        smtpPort: 465,\r\n        isVerified: true,\r\n      },\r\n    });\r\n\r\n    res.status(200).json({ message: 'Configuration mail mise \u00E0 jour avec succ\u00E8s.' });\r\n  } catch (error) {\r\n    console.error('Erreur lors de la mise \u00E0 jour de la configuration mail:', error);\r\n    res.status(500).json({ error: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\n// Route pour r\u00E9cup\u00E9rer les param\u00E8tres mail d'un utilisateur\r\nrouter.get('/mail/settings', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    // R\u00E9cup\u00E8re l'ID de l'utilisateur \u00E0 partir du token JWT\r\n    const userId = req.user?.id;\r\n    \r\n    if (!userId) {\r\n      res.status(401).json({ error: 'Utilisateur non authentifi\u00E9.' });\r\n      return;\r\n    }\r\n\r\n    // R\u00E9cup\u00E8re les param\u00E8tres mail de l'utilisateur\r\n    const mailSettings = await prisma.mailSettings.findUnique({\r\n      where: { userId },\r\n    });\r\n\r\n    if (!mailSettings) {\r\n      res.status(404).json({ error: 'Aucune configuration mail trouv\u00E9e pour cet utilisateur.' });\r\n      return;\r\n    }\r\n\r\n    // Masque le mot de passe dans la r\u00E9ponse\r\n  const { encryptedPassword: _encryptedPassword, ...settings } = mailSettings;\r\n    \r\n    res.status(200).json(settings);\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r\u00E9cup\u00E9ration des param\u00E8tres mail:', error);\r\n    res.status(500).json({ error: 'Erreur interne du serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { Request, Response } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\n\r\ninterface AuthRequest extends Request {\r\n  user?: {\r\n    userId: string;\r\n    role: string;\r\n    organizationId?: string;\r\n  };\r\n}\r\n\r\nconst router = Router();\r\n\r\n// Route pour g\u00E9rer l'usurpation d'identit\u00E9\r\n// POST /api/impersonate\r\nrouter.post('/', authMiddleware, async (req: AuthRequest, res: Response) => {\r\n  try {\r\n    const { userId, organizationId } = req.body;\r\n    \r\n    console.log('[Impersonate Route] Nouvelle demande d\\'usurpation:', { userId, organizationId });\r\n    \r\n    // V\u00E9rifier que l'utilisateur actuel est un super admin\r\n    const currentUser = req.user;\r\n    if (!currentUser || currentUser.role !== 'super_admin') {\r\n      console.log('[Impersonate Route] Acc\u00E8s refus\u00E9 - utilisateur non super admin');\r\n      return res.status(403).json({ \r\n        success: false, \r\n        message: 'Seuls les super administrateurs peuvent usurper l\\'identit\u00E9' \r\n      });\r\n    }\r\n    \r\n    // Cette route ne fait que valider les droits\r\n    // L'usurpation r\u00E9elle se fait via les headers dans les requ\u00EAtes suivantes\r\n    // gr\u00E2ce au middleware impersonation.ts\r\n    \r\n    console.log('[Impersonate Route] Usurpation autoris\u00E9e pour:', { userId, organizationId });\r\n    \r\n    return res.json({\r\n      success: true,\r\n      message: 'Usurpation d\\'identit\u00E9 activ\u00E9e',\r\n      impersonation: {\r\n        userId: userId || null,\r\n        organizationId: organizationId || null\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[Impersonate Route] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la configuration de l\\'usurpation'\r\n    });\r\n  }\r\n});\r\n\r\n// Route pour arr\u00EAter l'usurpation\r\n// DELETE /api/impersonate\r\nrouter.delete('/', authMiddleware, async (req: AuthRequest, res: Response) => {\r\n  try {\r\n    const currentUser = req.user;\r\n    if (!currentUser || currentUser.role !== 'super_admin') {\r\n      return res.status(403).json({ \r\n        success: false, \r\n        message: 'Seuls les super administrateurs peuvent arr\u00EAter l\\'usurpation' \r\n      });\r\n    }\r\n    \r\n    console.log('[Impersonate Route] Arr\u00EAt de l\\'usurpation demand\u00E9');\r\n    \r\n    return res.json({\r\n      success: true,\r\n      message: 'Usurpation d\\'identit\u00E9 d\u00E9sactiv\u00E9e'\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('[Impersonate Route] Erreur lors de l\\'arr\u00EAt:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de l\\'arr\u00EAt de l\\'usurpation'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware, AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation.js';\r\nimport { googleCalendarService } from '../google-auth/services/GoogleCalendarService.js';\r\n\r\nconst router = Router();\r\n// Logging global minimal pour diagnostiquer les requ\u00EAtes qui n'atteignent pas les handlers sp\u00E9cifiques\r\nrouter.use((req, _res, next) => {\r\n  try {\r\n    const hasUser = Boolean((req as unknown as AuthenticatedRequest).user);\r\n    console.log(`[CALENDAR ROUTES][TRACE] ${req.method} ${req.originalUrl} avant middlewares sp\u00E9cifiques - user?`, hasUser);\r\n  } catch (e) {\r\n    console.warn('[CALENDAR ROUTES][TRACE] logging pr\u00E9-middleware \u00E9chou\u00E9', e);\r\n  }\r\n  next();\r\n});\r\nconst prisma = new PrismaClient();\r\n\r\n// --- SSE (Server Sent Events) simple pour push temps r\u00E9el ---\r\ninterface SSEClient { id: string; res: NodeJS.WritableStream & { write: (chunk: string) => boolean }; organizationId: string }\r\nconst sseClients: SSEClient[] = [];\r\n\r\nfunction broadcast(orgId: string, event: string, payload: unknown) {\r\n  const data = `event: ${event}\\ndata: ${JSON.stringify(payload)}\\n\\n`;\r\n  sseClients.filter(c => c.organizationId === orgId).forEach(c => c.res.write(data));\r\n}\r\n\r\n// Prot\u00E8ge le flux SSE en exigeant l'auth une fois authMiddleware appliqu\u00E9 (voir d\u00E9placement plus bas)\r\nfunction initSSE(req: AuthenticatedRequest, res: import('express').Response) {\r\n  if (!req.user) {\r\n    console.log('[CALENDAR ROUTES][SSE] \u274C Rejet connexion SSE: pas de user');\r\n    return res.status(401).end();\r\n  }\r\n  // Permettre query ?organizationId=... comme fallback pour super_admin (ex: quand req.user.organizationId est null)\r\n  let organizationId = req.user.organizationId as string | undefined;\r\n  if (!organizationId && req.query.organizationId && req.user.role === 'super_admin') {\r\n    organizationId = String(req.query.organizationId);\r\n    console.log('[CALENDAR ROUTES][SSE] \u2699\uFE0F Fallback organizationId depuis query pour super_admin:', organizationId);\r\n  }\r\n  if (!organizationId) {\r\n    console.log('[CALENDAR ROUTES][SSE] \u274C Aucun organizationId d\u00E9termin\u00E9');\r\n    return res.status(400).json({ error: 'organizationId manquant pour SSE' });\r\n  }\r\n  console.log('[CALENDAR ROUTES][SSE] \u2705 Connexion SSE accept\u00E9e pour org', organizationId);\r\n  res.setHeader('Content-Type', 'text/event-stream');\r\n  res.setHeader('Cache-Control', 'no-cache');\r\n  res.setHeader('Connection', 'keep-alive');\r\n  res.flushHeaders?.();\r\n  const clientId = Date.now().toString() + Math.random();\r\n  sseClients.push({ id: clientId, res, organizationId });\r\n  res.write(`event: connected\\ndata: {\"clientId\":\"${clientId}\"}\\n\\n`);\r\n  req.on('close', () => {\r\n    const idx = sseClients.findIndex(c => c.id === clientId);\r\n    if (idx !== -1) sseClients.splice(idx, 1);\r\n  });\r\n}\r\n\r\n// Ajouter le middleware d'authentification AVANT d'exposer /stream pour qu'EventSource b\u00E9n\u00E9ficie de req.user\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\n\r\nrouter.get('/stream', (req: AuthenticatedRequest, res) => {\r\n  initSSE(req, res);\r\n});\r\n// (Les autres routes sont d\u00E9j\u00E0 prot\u00E9g\u00E9es car le use() pr\u00E9c\u00E9dent est plac\u00E9 avant leur d\u00E9claration)\r\n\r\n// GET /api/calendar/events - R\u00E9cup\u00E9rer les \u00E9v\u00E9nements de l'utilisateur\r\nrouter.get('/events', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    console.log('[CALENDAR ROUTES] GET /events - D\u00E9but de la requ\u00EAte');\r\n    const { userId, startDate, endDate, forceSync } = req.query as { userId?: string; startDate?: string; endDate?: string; forceSync?: string };\r\n    const userIdToSearch = userId || req.user!.userId;\r\n    const organizationId = req.user!.organizationId!;\r\n\r\n    // Construction du whereClause\r\n    interface WhereClause {\r\n      organizationId: string;\r\n      OR: Array<{ ownerId?: string; participants?: { some: { userId: string } } }>;\r\n      startDate?: { gte: Date; lte: Date };\r\n    }\r\n    const whereClause: WhereClause = {\r\n      organizationId,\r\n      OR: [\r\n        { ownerId: userIdToSearch },\r\n        { participants: { some: { userId: userIdToSearch } } }\r\n      ]\r\n    };\r\n    if (startDate && endDate) {\r\n      whereClause.startDate = { gte: new Date(startDate), lte: new Date(endDate) };\r\n    }\r\n\r\n    // 1) Charger d'abord les \u00E9v\u00E9nements locaux\r\n    let events = await prisma.calendarEvent.findMany({\r\n      where: whereClause,\r\n      include: {\r\n        participants: { include: { user: { select: { id: true, firstName: true, lastName: true, email: true } } } },\r\n        owner: { select: { id: true, firstName: true, lastName: true, email: true } }\r\n      },\r\n      orderBy: { startDate: 'asc' }\r\n    });\r\n\r\n    console.log('[CALENDAR ROUTES] \u00C9v\u00E9nements locaux trouv\u00E9s:', events.length);\r\n\r\n    // 1.b) Auto-report des notes (type='note', status != 'done') si date pass\u00E9e et pas d\u00E9pass\u00E9 dueDate\r\n    // Reporte au jour courant tant que non done et que la date d'\u00E9ch\u00E9ance (dueDate) n'est pas d\u00E9pass\u00E9e\r\n    try {\r\n      const todayStart = new Date();\r\n      todayStart.setHours(0,0,0,0);\r\n      const notesToCarry = events.filter(e => e.type === 'note' && e.status !== 'done' && e.startDate < todayStart && (!e.dueDate || e.dueDate >= todayStart));\r\n      if (notesToCarry.length) {\r\n        console.log('[CALENDAR ROUTES] \uD83D\uDD01 Report automatique de', notesToCarry.length, 'notes non termin\u00E9es');\r\n        for (const n of notesToCarry) {\r\n          await prisma.calendarEvent.update({\r\n            where: { id: n.id },\r\n            data: {\r\n              startDate: todayStart,\r\n              endDate: null, // allDay; pas n\u00E9cessaire\r\n              allDay: true\r\n            }\r\n          });\r\n        }\r\n        // Recharger apr\u00E8s report\r\n        events = await prisma.calendarEvent.findMany({\r\n          where: whereClause,\r\n          include: {\r\n            participants: { include: { user: { select: { id: true, firstName: true, lastName: true, email: true } } } },\r\n            owner: { select: { id: true, firstName: true, lastName: true, email: true } }\r\n          },\r\n          orderBy: { startDate: 'asc' }\r\n        });\r\n      }\r\n    } catch (carryErr) {\r\n      console.warn('[CALENDAR ROUTES] \u26A0\uFE0F Erreur report notes:', carryErr);\r\n    }\r\n\r\n    const needSync = forceSync === 'true' || events.length === 0; // strat\u00E9gie simple: si aucun local \u2192 sync\r\n    if (needSync) {\r\n      console.log('[CALENDAR ROUTES] \uD83D\uDD04 Lancement auto-sync Google Calendar (needSync=', needSync, ')');\r\n      try {\r\n        const syncStart = startDate ? new Date(startDate) : new Date(Date.now() - 7 * 24 * 3600 * 1000); // -7j par d\u00E9faut\r\n        const syncEnd = endDate ? new Date(endDate) : new Date(Date.now() + 30 * 24 * 3600 * 1000); // +30j\r\n        const googleEvents = await googleCalendarService.syncEvents(organizationId, syncStart, syncEnd);\r\n        console.log('[CALENDAR ROUTES] Google events r\u00E9cup\u00E9r\u00E9s:', googleEvents.length);\r\n\r\n        for (const gEvent of googleEvents) {\r\n          const gId = gEvent.id;\r\n          if (!gId || !gEvent.start?.dateTime || !gEvent.end?.dateTime) continue;\r\n\r\n          // Chercher par googleEventId maintenant (champ d\u00E9di\u00E9)\r\n            const existing = await prisma.calendarEvent.findFirst({\r\n              where: { organizationId, googleEventId: gId }\r\n            });\r\n\r\n          const baseData = {\r\n            title: gEvent.summary || 'Sans titre',\r\n            description: gEvent.description || null,\r\n            startDate: new Date(gEvent.start.dateTime),\r\n            endDate: new Date(gEvent.end.dateTime),\r\n            type: 'google_sync',\r\n            status: 'synced',\r\n            organizationId,\r\n            ownerId: userIdToSearch,\r\n            googleEventId: gId\r\n          };\r\n\r\n          if (existing) {\r\n            await prisma.calendarEvent.update({ where: { id: existing.id }, data: baseData });\r\n          } else {\r\n            await prisma.calendarEvent.create({ data: baseData });\r\n          }\r\n        }\r\n\r\n        // Recharger apr\u00E8s sync\r\n        events = await prisma.calendarEvent.findMany({\r\n          where: whereClause,\r\n          include: {\r\n            participants: { include: { user: { select: { id: true, firstName: true, lastName: true, email: true } } } },\r\n            owner: { select: { id: true, firstName: true, lastName: true, email: true } }\r\n          },\r\n          orderBy: { startDate: 'asc' }\r\n        });\r\n        console.log('[CALENDAR ROUTES] \u00C9v\u00E9nements apr\u00E8s auto-sync:', events.length);\r\n      } catch (syncError) {\r\n        console.warn('[CALENDAR ROUTES] \u26A0\uFE0F Auto-sync \u00E9chou\u00E9e (les \u00E9v\u00E9nements locaux restent affich\u00E9s):', syncError);\r\n      }\r\n    }\r\n\r\n    return res.json(events);\r\n  } catch (error) {\r\n    console.error('Erreur r\u00E9cup\u00E9ration \u00E9v\u00E9nements:', error);\r\n    return res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// GET /api/calendar/ai-suggestions?leadId=...&days=5\r\n// G\u00E9n\u00E8re des cr\u00E9neaux intelligents bas\u00E9s sur : disponibilit\u00E9 calendrier, fra\u00EEcheur du lead, dernier contact.\r\nrouter.get('/ai-suggestions', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { leadId } = req.query as { leadId?: string };\r\n    const organizationId = req.user!.organizationId!;\r\n    if (!leadId) {\r\n      return res.status(400).json({ error: 'Param\u00E8tre leadId requis' });\r\n    }\r\n\r\n    const lead = await prisma.lead.findFirst({\r\n      where: { id: leadId, organizationId },\r\n      select: { id: true, firstName: true, lastName: true, lastContactDate: true, nextFollowUpDate: true, status: true, createdAt: true }\r\n    });\r\n    if (!lead) return res.status(404).json({ error: 'Lead introuvable' });\r\n\r\n    const horizonDays = 5;\r\n    const now = new Date();\r\n    const horizon = new Date();\r\n    horizon.setDate(horizon.getDate() + horizonDays);\r\n\r\n    // R\u00E9cup\u00E8re \u00E9v\u00E9nements existants (pour \u00E9viter conflits)\r\n    const events = await prisma.calendarEvent.findMany({\r\n      where: {\r\n        organizationId,\r\n        startDate: { gte: now, lte: horizon }\r\n      },\r\n      select: { id: true, startDate: true, endDate: true, title: true }\r\n    });\r\n\r\n    // Index rapide des cr\u00E9neaux occup\u00E9s\r\n    const isBusy = (slotStart: Date, slotEnd: Date) => {\r\n      return events.some(ev => {\r\n        const evStart = ev.startDate;\r\n        const evEnd = ev.endDate || new Date(ev.startDate.getTime() + 30 * 60000);\r\n        return evStart < slotEnd && evEnd > slotStart; // overlap\r\n      });\r\n    };\r\n\r\n    // Heures candidates (adapt\u00E9es pour densit\u00E9 >30 RDV/jour en multi-user; ici on se concentre sur suggestions prioritaires)\r\n    const candidateHours = [9, 9.5, 10, 10.5, 11, 14, 14.5, 15, 15.5, 16]; // .5 => +30min\r\n    type Suggestion = {\r\n      date: string; endDate: string; score: number; type: string; reason: string; evidence: Record<string, unknown>;\r\n    };\r\n    const suggestions: Suggestion[] = [];\r\n\r\n    for (let d = 0; d < horizonDays; d++) {\r\n      const day = new Date(now.getFullYear(), now.getMonth(), now.getDate() + d, 0, 0, 0, 0);\r\n      for (const h of candidateHours) {\r\n        const hour = Math.floor(h);\r\n        const minutes = h % 1 ? 30 : 0;\r\n        const slotStart = new Date(day.getFullYear(), day.getMonth(), day.getDate(), hour, minutes, 0, 0);\r\n        // Ignore pass\u00E9\r\n        if (slotStart < now) continue;\r\n        const slotEnd = new Date(slotStart.getTime() + 30 * 60000);\r\n        const busy = isBusy(slotStart, slotEnd);\r\n        // Calcul score\r\n        let score = 50;\r\n        const reasons: string[] = [];\r\n\r\n        if (!busy) {\r\n          score += 15; reasons.push('Cr\u00E9neau libre');\r\n        } else {\r\n          score -= 25; reasons.push('Conflit calendrier');\r\n        }\r\n        // Fen\u00EAtre de r\u00E9activit\u00E9 (prochaines 48h)\r\n        const within48h = slotStart.getTime() - now.getTime() <= 48 * 3600 * 1000;\r\n        if (within48h) { score += 10; reasons.push('Suivi rapide (<48h)'); }\r\n        // Matin productif\r\n        if (hour >= 9 && hour <= 11) { score += 5; reasons.push('Matin propice'); }\r\n        // Apr\u00E8s-midi focus\r\n        if (hour >= 14 && hour <= 16 && !within48h) { score += 3; reasons.push('Cr\u00E9neau stable'); }\r\n        // Dernier contact > 5 jours => augmenter priorit\u00E9\r\n        if (lead.lastContactDate) {\r\n          const daysSinceLast = (now.getTime() - new Date(lead.lastContactDate).getTime()) / 86400000;\r\n          if (daysSinceLast > 5) { score += 7; reasons.push('Relance n\u00E9cessaire'); }\r\n        } else { score += 6; reasons.push('Aucun contact pr\u00E9alable'); }\r\n        // Proximit\u00E9 nextFollowUpDate\r\n        if (lead.nextFollowUpDate) {\r\n          const diff = Math.abs(new Date(lead.nextFollowUpDate).getTime() - slotStart.getTime()) / 86400000;\r\n            if (diff <= 1.5) { score += 8; reasons.push('Align\u00E9 \u00E0 la prochaine relance'); }\r\n        }\r\n\r\n        // Normalisation\r\n        if (score > 100) score = 100;\r\n        if (score < 0) score = 0;\r\n\r\n        const type = score >= 85 ? 'best' : score >= 70 ? 'good' : 'ok';\r\n        suggestions.push({\r\n          date: slotStart.toISOString(),\r\n          endDate: slotEnd.toISOString(),\r\n            score,\r\n            type,\r\n            reason: reasons.join(' \u00B7 '),\r\n            evidence: {\r\n              busy,\r\n              within48h,\r\n              lastContactDate: lead.lastContactDate,\r\n              nextFollowUpDate: lead.nextFollowUpDate\r\n            }\r\n        });\r\n      }\r\n    }\r\n\r\n    // Retirer les conflits jug\u00E9s trop faibles (<55) pour r\u00E9duire bruit\r\n    const filtered = suggestions.filter(s => s.score >= 55).sort((a, b) => b.score - a.score).slice(0, 25);\r\n    res.json({ success: true, data: filtered });\r\n  } catch (error) {\r\n    console.error('[CALENDAR ROUTES] Erreur ai-suggestions:', error);\r\n    res.status(500).json({ error: 'Erreur g\u00E9n\u00E9ration suggestions' });\r\n  }\r\n});\r\n\r\n// POST /api/calendar/sync - Synchroniser avec Google Calendar\r\nrouter.post('/sync', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const userId = req.user!.userId;\r\n    const organizationId = req.user!.organizationId!;\r\n    const { startDate, endDate } = req.body;\r\n\r\n    // Utilise le nouveau service Google Calendar centralis\u00E9\r\n    const googleEvents = await googleCalendarService.syncEvents(\r\n      organizationId,\r\n      new Date(startDate),\r\n      new Date(endDate)\r\n    );\r\n\r\n    let createdCount = 0;\r\n    let updatedCount = 0;\r\n\r\n    for (const gEvent of googleEvents) {\r\n      if (!gEvent.start?.dateTime || !gEvent.end?.dateTime) continue;\r\n\r\n      const existingEvent = gEvent.id ? await prisma.calendarEvent.findFirst({\r\n        where: { organizationId, googleEventId: gEvent.id }\r\n      }) : null;\r\n\r\n      const eventData = {\r\n        title: gEvent.summary || 'Sans titre',\r\n        description: gEvent.description || null,\r\n        startDate: new Date(gEvent.start.dateTime),\r\n        endDate: new Date(gEvent.end.dateTime),\r\n        type: 'google_sync',\r\n        status: 'synced',\r\n        organizationId,\r\n        ownerId: userId,\r\n        googleEventId: gEvent.id || null,\r\n      };\r\n\r\n      if (existingEvent) {\r\n        await prisma.calendarEvent.update({ where: { id: existingEvent.id }, data: eventData });\r\n        updatedCount++;\r\n      } else {\r\n        await prisma.calendarEvent.create({ data: eventData });\r\n        createdCount++;\r\n      }\r\n    }\r\n\r\n    res.json({ message: 'Synchronisation termin\u00E9e.', created: createdCount, updated: updatedCount });\r\n  } catch (error) {\r\n    console.error('Erreur de synchronisation Google Calendar:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la synchronisation.' });\r\n  }\r\n});\r\n\r\n// POST /api/calendar/events - Cr\u00E9er un nouvel \u00E9v\u00E9nement\r\nrouter.post('/events', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    console.log('[CALENDAR ROUTES] POST /events - D\u00E9but cr\u00E9ation \u00E9v\u00E9nement');\r\n    console.log('[CALENDAR ROUTES] Body:', req.body);\r\n    console.log('[CALENDAR ROUTES] User:', req.user);\r\n    \r\n    const eventData = req.body;\r\n    const userId = req.user!.userId;\r\n    const organizationId = req.user!.organizationId!;\r\n    \r\n    console.log('[CALENDAR ROUTES] userId:', userId);\r\n    console.log('[CALENDAR ROUTES] organizationId:', organizationId);\r\n    console.log('[CALENDAR ROUTES] eventData BRUT:', eventData);\r\n    \r\n    // \uD83D\uDD27 Pr\u00E9paration des donn\u00E9es pour Prisma (validation des champs)\r\n    const prismaData = {\r\n      title: eventData.title,\r\n      description: eventData.description || null,\r\n      startDate: eventData.start || eventData.startDate,\r\n      endDate: eventData.end || eventData.endDate,\r\n      allDay: eventData.isAllDay || eventData.allDay || false,\r\n      type: eventData.category || eventData.type || 'rendez-vous', // \uD83C\uDFAF category \u2192 type\r\n      status: eventData.priority || eventData.status || 'normal', // \uD83C\uDFAF priority \u2192 status  \r\n      notes: eventData.notes || null,\r\n      location: eventData.location || null,\r\n      ownerId: userId,\r\n      organizationId,\r\n    };\r\n    \r\n    console.log('[CALENDAR ROUTES] Donn\u00E9es pr\u00E9par\u00E9es pour Prisma:', prismaData);\r\n    console.log('[CALENDAR ROUTES] Champs mapp\u00E9s correctement:', {\r\n      'category \u2192 type': eventData.category + ' \u2192 ' + prismaData.type,\r\n      'priority \u2192 status': eventData.priority + ' \u2192 ' + prismaData.status,\r\n      'organizer': eventData.organizer + ' (ignor\u00E9 - pas de champ dans Prisma)'\r\n    });\r\n\r\n  const event = await prisma.calendarEvent.create({\r\n      data: prismaData,\r\n    });\r\n    \r\n    console.log('[CALENDAR ROUTES] \u00C9v\u00E9nement cr\u00E9\u00E9:', event);\r\n\r\n    // Utilise le nouveau service Google Calendar centralis\u00E9\r\n    try {\r\n      const googleEventData = {\r\n        summary: event.title,\r\n        description: event.description,\r\n        start: {\r\n          dateTime: new Date(event.startDate).toISOString(),\r\n          timeZone: 'Europe/Brussels',\r\n        },\r\n        end: {\r\n          dateTime: new Date(event.endDate).toISOString(),\r\n          timeZone: 'Europe/Brussels',\r\n        },\r\n      };\r\n      \r\n      const googleEventId = await googleCalendarService.createEvent(organizationId, googleEventData);\r\n      \r\n      const updatedEvent = await prisma.calendarEvent.update({\r\n        where: { id: event.id },\r\n        data: {\r\n          googleEventId,\r\n        },\r\n        include: {\r\n          project: { select: { id: true, name: true, clientName: true } },\r\n          lead: { select: { id: true, firstName: true, lastName: true, email: true } }\r\n        }\r\n      });\r\n      broadcast(organizationId, 'event.created', updatedEvent);\r\n      return res.status(201).json(updatedEvent);\r\n    } catch (googleError) {\r\n      console.warn('[CALENDAR ROUTES] Erreur Google Calendar (\u00E9v\u00E9nement cr\u00E9\u00E9 en local):', googleError);\r\n    }\r\n    broadcast(organizationId, 'event.created', event);\r\n    res.status(201).json(event);\r\n  } catch (error) {\r\n    console.error('Erreur cr\u00E9ation \u00E9v\u00E9nement:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation de l\\'\u00E9v\u00E9nement' });\r\n  }\r\n});\r\n\r\n// POST /api/calendar/notes - Cr\u00E9ation rapide d'une note (t\u00E2che journali\u00E8re auto-report\u00E9e)\r\nrouter.post('/notes', async (req: AuthenticatedRequest, res) => {\r\n  const startedAt = Date.now();\r\n  console.log('\\n[CALENDAR ROUTES] \u25B6 POST /notes - D\u00E9but');\r\n  console.log('[CALENDAR ROUTES] \u25B6 Body re\u00E7u:', req.body);\r\n  try {\r\n    const { title, description, dueDate, priority, category } = req.body as { title: string; description?: string; dueDate?: string; priority?: string; category?: string };\r\n    // Fallback organizationId: si super_admin et body.organizationId fourni, l'utiliser (\u00E9vite crash quand null)\r\n    let organizationId = req.user?.organizationId as string | undefined;\r\n    if (!organizationId && req.user?.role === 'super_admin' && (req.body.organizationId || req.query.organizationId)) {\r\n      organizationId = String(req.body.organizationId || req.query.organizationId);\r\n      console.log('[CALENDAR ROUTES][POST /notes] \u2699\uFE0F Fallback organizationId super_admin:', organizationId);\r\n    }\r\n    if (!organizationId) {\r\n      console.warn('[CALENDAR ROUTES][POST /notes] \u274C organizationId introuvable');\r\n      return res.status(400).json({ error: 'organizationId requis' });\r\n    }\r\n    const ownerId = req.user!.userId;\r\n    if (!title || typeof title !== 'string') {\r\n      console.warn('[CALENDAR ROUTES] \u26A0\uFE0F Titre manquant ou invalide');\r\n      return res.status(400).json({ error: 'Titre requis' });\r\n    }\r\n\r\n    // Normalisation / validation l\u00E9g\u00E8re\r\n    const allowedPriorities = ['low','medium','high','urgent'];\r\n    const normalizedPriority = priority && allowedPriorities.includes(priority) ? priority : null;\r\n    const safeCategory = category ? String(category).slice(0,64) : null;\r\n\r\n    const today = new Date(); today.setHours(0,0,0,0);\r\n    let parsedDue: Date | null = null;\r\n    if (dueDate) {\r\n      try {\r\n        parsedDue = new Date(dueDate);\r\n        if (isNaN(parsedDue.getTime())) {\r\n          console.warn('[CALENDAR ROUTES] \u26A0\uFE0F dueDate invalide, ignor\u00E9e:', dueDate);\r\n          parsedDue = null;\r\n        }\r\n      } catch (e) {\r\n        console.warn('[CALENDAR ROUTES] \u26A0\uFE0F Erreur parsing dueDate, ignor\u00E9e:', dueDate, e);\r\n        parsedDue = null;\r\n      }\r\n    }\r\n\r\n    console.log('[CALENDAR ROUTES] \u2714 Donn\u00E9es normalis\u00E9es:', { title, hasDescription: !!description, parsedDue, normalizedPriority, safeCategory, organizationId, ownerId });\r\n\r\n    const data = {\r\n      title,\r\n      description: description || null,\r\n      startDate: today,\r\n      endDate: null as Date | null,\r\n      allDay: true,\r\n      type: 'note',\r\n      status: 'pending',\r\n      dueDate: parsedDue,\r\n      priority: normalizedPriority,\r\n      category: safeCategory,\r\n      organizationId,\r\n      ownerId\r\n    };\r\n\r\n    console.log('[CALENDAR ROUTES] \u2795 Cr\u00E9ation Prisma calendarEvent avec data:', data);\r\n    let note;\r\n    try {\r\n      note = await prisma.calendarEvent.create({ data });\r\n  } catch (prismaCreateError: unknown) {\r\n      console.error('[CALENDAR ROUTES] \u274C Prisma create a \u00E9chou\u00E9');\r\n      if (prismaCreateError?.code) {\r\n        console.error('[CALENDAR ROUTES] \u274C Prisma error code:', prismaCreateError.code, 'meta:', prismaCreateError.meta);\r\n      }\r\n      console.error('[CALENDAR ROUTES] \u274C D\u00E9tails erreur:', prismaCreateError);\r\n      throw prismaCreateError; // relancer pour gestion catch globale\r\n    }\r\n    console.log('[CALENDAR ROUTES] \u2705 Note cr\u00E9\u00E9e:', { id: note.id, title: note.title });\r\n    broadcast(organizationId, 'note.created', note);\r\n    const duration = Date.now() - startedAt;\r\n    console.log('[CALENDAR ROUTES] \u23F1 Dur\u00E9e cr\u00E9ation note ms:', duration);\r\n    res.status(201).json(note);\r\n  } catch (error: unknown) {\r\n    const duration = Date.now() - startedAt;\r\n    console.error('[CALENDAR ROUTES] \u274C Erreur cr\u00E9ation note apr\u00E8s', duration, 'ms');\r\n    if (error instanceof Error) {\r\n      console.error('[CALENDAR ROUTES] \u274C Stack:', error.stack);\r\n    } else {\r\n      console.error('[CALENDAR ROUTES] \u274C Valeur erreur non-Error:', error);\r\n    }\r\n    type PossiblyPrismaError = { code?: string; meta?: unknown } & Record<string, unknown>;\r\n    const prismaErr = error as PossiblyPrismaError;\r\n    if (prismaErr && typeof prismaErr === 'object' && 'code' in prismaErr && prismaErr.code) {\r\n      console.error('[CALENDAR ROUTES] \u274C Prisma code:', prismaErr.code, 'meta:', prismaErr.meta);\r\n    }\r\n    res.status(500).json({ error: 'Erreur cr\u00E9ation note' });\r\n  }\r\n});\r\n\r\n// PATCH /api/calendar/notes/:id/done - Marquer une note comme accomplie\r\nrouter.patch('/notes/:id/done', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user!.organizationId!;\r\n    const existing = await prisma.calendarEvent.findFirst({ where: { id, organizationId, type: 'note' } });\r\n    if (!existing) return res.status(404).json({ error: 'Note introuvable' });\r\n  const updated = await prisma.calendarEvent.update({\r\n      where: { id },\r\n  data: { status: 'done', completedAt: new Date() }\r\n    });\r\n  broadcast(organizationId, 'note.updated', updated);\r\n    res.json(updated);\r\n  } catch (error) {\r\n    console.error('[CALENDAR ROUTES] Erreur completion note:', error);\r\n    res.status(500).json({ error: 'Erreur completion note' });\r\n  }\r\n});\r\n\r\n// GET /api/calendar/notes/summary - Compte rapide pour badge\r\nrouter.get('/notes/summary', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user!.organizationId!;\r\n    const todayStart = new Date(); todayStart.setHours(0,0,0,0);\r\n    const active = await prisma.calendarEvent.findMany({\r\n      where: { organizationId, type: 'note', status: { not: 'done' } },\r\n      select: { id: true, dueDate: true, startDate: true, title: true }\r\n    });\r\n    const overdue = active.filter(n => n.dueDate && n.dueDate < todayStart).map(n => n.id);\r\n    res.json({ totalActive: active.length, overdueCount: overdue.length, overdueIds: overdue });\r\n  } catch (e) {\r\n    console.error('[CALENDAR ROUTES] Erreur notes/summary:', e);\r\n    res.status(500).json({ error: 'Erreur summary notes' });\r\n  }\r\n});\r\n\r\n// GET /api/calendar/notes/history?from=YYYY-MM-DD&to=YYYY-MM-DD&format=json|csv\r\nrouter.get('/notes/history', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user!.organizationId!;\r\n    const { from, to, format } = req.query as { from?: string; to?: string; format?: string };\r\n  const where: Record<string, unknown> = { organizationId, type: 'note', status: 'done', completedAt: { not: null } };\r\n    if (from || to) {\r\n      where.startDate = {};\r\n      if (from) where.startDate.gte = new Date(from + 'T00:00:00');\r\n      if (to) where.startDate.lte = new Date(to + 'T23:59:59');\r\n    }\r\n    const notes = await prisma.calendarEvent.findMany({ where, orderBy: { completedAt: 'desc' } });\r\n    const enriched = notes.map(n => ({\r\n      id: n.id,\r\n      title: n.title,\r\n      description: n.description,\r\n      createdDate: n.startDate,\r\n      dueDate: n.dueDate,\r\n      completedAt: n.completedAt,\r\n      completionDelayMinutes: n.completedAt && n.startDate ? Math.round(((n.completedAt as Date).getTime() - (n.startDate as Date).getTime())/60000) : null,\r\n      overdue: n.dueDate && n.completedAt ? (n.completedAt as Date) > (n.dueDate as Date) : false,\r\n      priority: n.priority,\r\n      category: n.category\r\n    }));\r\n    if (format === 'csv') {\r\n      const header = 'id;title;createdDate;dueDate;completedAt;completionDelayMinutes;overdue;priority;category';\r\n      const rows = enriched.map(e => [e.id, e.title.replace(/;/g, ','), e.createdDate?.toISOString(), e.dueDate?.toISOString()||'', e.completedAt?.toISOString()||'', e.completionDelayMinutes??'', e.overdue, e.priority||'', e.category||''].join(';'));\r\n      const csv = [header, ...rows].join('\\n');\r\n      res.setHeader('Content-Type', 'text/csv; charset=utf-8');\r\n      return res.send(csv);\r\n    }\r\n    res.json({ success: true, data: enriched });\r\n  } catch (e) {\r\n    console.error('[CALENDAR ROUTES] Erreur notes/history:', e);\r\n    res.status(500).json({ error: 'Erreur history notes' });\r\n  }\r\n});\r\n\r\n// PUT /api/calendar/events/:id - Modifier un \u00E9v\u00E9nement\r\nrouter.put('/events/:id', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const eventData = req.body;\r\n    const organizationId = req.user!.organizationId!;\r\n\r\n    const updatedEvent = await prisma.calendarEvent.update({\r\n      where: { id, organizationId },\r\n      data: eventData,\r\n    });\r\n\r\n    if (updatedEvent.googleEventId) {\r\n      try {\r\n        const googleEventData = {\r\n          summary: updatedEvent.title,\r\n          description: updatedEvent.description,\r\n          start: {\r\n            dateTime: new Date(updatedEvent.startDate).toISOString(),\r\n            timeZone: 'Europe/Brussels',\r\n          },\r\n          end: {\r\n            dateTime: new Date(updatedEvent.endDate).toISOString(),\r\n            timeZone: 'Europe/Brussels',\r\n          },\r\n        };\r\n        \r\n        await googleCalendarService.updateEvent(organizationId, updatedEvent.googleEventId, googleEventData);\r\n      } catch (googleError) {\r\n        console.warn('[CALENDAR ROUTES] Erreur mise \u00E0 jour Google Calendar:', googleError);\r\n      }\r\n    }\r\n\r\n    res.json(updatedEvent);\r\n  } catch (error) {\r\n    console.error('Erreur modification \u00E9v\u00E9nement:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la modification de l\\'\u00E9v\u00E9nement' });\r\n  }\r\n});\r\n\r\n// DELETE /api/calendar/events/:id - Supprimer un \u00E9v\u00E9nement\r\nrouter.delete('/events/:id', async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    console.log('[CALENDAR ROUTES] DELETE /events/:id - D\u00E9but suppression');\r\n    const { id } = req.params;\r\n    const organizationId = req.user!.organizationId!;\r\n    \r\n    console.log('[CALENDAR ROUTES] ID \u00E0 supprimer:', id);\r\n    console.log('[CALENDAR ROUTES] OrganizationId:', organizationId);\r\n\r\n    const eventToDelete = await prisma.calendarEvent.findUnique({ where: { id, organizationId } });\r\n    console.log('[CALENDAR ROUTES] \u00C9v\u00E9nement trouv\u00E9:', eventToDelete);\r\n\r\n    if (!eventToDelete) {\r\n      console.log('[CALENDAR ROUTES] \u274C \u00C9v\u00E9nement non trouv\u00E9');\r\n      return res.status(404).json({ error: '\u00C9v\u00E9nement non trouv\u00E9.' });\r\n    }\r\n\r\n    console.log('[CALENDAR ROUTES] \uD83D\uDDD1\uFE0F Suppression de l\\'\u00E9v\u00E9nement...');\r\n    await prisma.calendarEvent.delete({ where: { id } });\r\n    console.log('[CALENDAR ROUTES] \u2705 \u00C9v\u00E9nement supprim\u00E9 de la base de donn\u00E9es');\r\n\r\n    if (eventToDelete.googleEventId) {\r\n      try {\r\n        console.log('[CALENDAR ROUTES] \uD83D\uDD04 Suppression de Google Calendar...');\r\n        await googleCalendarService.deleteEvent(organizationId, eventToDelete.googleEventId);\r\n        console.log('[CALENDAR ROUTES] \u2705 \u00C9v\u00E9nement supprim\u00E9 de Google Calendar');\r\n      } catch (googleError) {\r\n        console.warn('[CALENDAR ROUTES] \u26A0\uFE0F Erreur suppression Google Calendar:', googleError);\r\n      }\r\n    }\r\n\r\n    console.log('[CALENDAR ROUTES] \u2705 Suppression termin\u00E9e avec succ\u00E8s');\r\n    res.json({ message: '\u00C9v\u00E9nement supprim\u00E9 avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('[CALENDAR ROUTES] \u274C Erreur suppression \u00E9v\u00E9nement:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de l\\'\u00E9v\u00E9nement' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * Middleware d'usurpation d'identit\u00E9 simplifi\u00E9 pour le d\u00E9veloppement\r\n * Cette version ne fait rien et appelle simplement next()\r\n */\r\nexport const impersonationMiddleware = (req, res, next) => {\r\n  // Ne fait rien, juste passer \u00E0 la prochaine fonction\r\n  next();\r\n};\r\n\r\nexport default impersonationMiddleware;\r\n", "import { Router } from 'express';\r\nimport { authenticateToken } from '../middleware/auth.js';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Appliquer l'authentification \u00E0 toutes les routes\r\nrouter.use(authenticateToken);\r\n\r\n// GET /api/clients - R\u00E9cup\u00E9rer tous les clients (bas\u00E9 sur les leads)\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    console.log('[CLIENTS] R\u00E9cup\u00E9ration des clients pour l\\'organisation:', req.organizationId);\r\n    \r\n    // R\u00E9cup\u00E9rer les leads qui peuvent \u00EAtre consid\u00E9r\u00E9s comme des clients\r\n    // (par exemple, leads avec statut \"converti\" ou \"client\")\r\n    const leads = await prisma.lead.findMany({\r\n      where: {\r\n        organizationId: req.organizationId,\r\n        // Filtrer pour obtenir les leads qui sont devenus des clients\r\n        OR: [\r\n          { status: { contains: 'client', mode: 'insensitive' } },\r\n          { status: { contains: 'converti', mode: 'insensitive' } },\r\n          { status: { contains: 'actif', mode: 'insensitive' } }\r\n        ]\r\n      },\r\n      include: {\r\n        assignedTo: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        leadStatus: true\r\n      },\r\n      orderBy: {\r\n        updatedAt: 'desc'\r\n      }\r\n    });\r\n\r\n    // Transformer les leads en format client pour l'agenda\r\n    const clients = leads.map(lead => {\r\n      const data = lead.data as any || {};\r\n      return {\r\n        id: lead.id,\r\n        name: data.company || data.name || `Lead ${lead.id.slice(0, 8)}`,\r\n        email: data.email || data.contactEmail || '',\r\n        phone: data.phone || data.phoneNumber || '',\r\n        company: data.company || '',\r\n        status: lead.status,\r\n        assignedTo: lead.assignedTo,\r\n        createdAt: lead.createdAt,\r\n        updatedAt: lead.updatedAt\r\n      };\r\n    });\r\n\r\n    console.log(`[CLIENTS] ${clients.length} clients trouv\u00E9s`);\r\n    res.json(clients);\r\n\r\n  } catch (error) {\r\n    console.error('[CLIENTS] Erreur lors de la r\u00E9cup\u00E9ration des clients:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des clients',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/clients/:id - R\u00E9cup\u00E9rer un client sp\u00E9cifique\r\nrouter.get('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    console.log('[CLIENTS] R\u00E9cup\u00E9ration du client:', id);\r\n\r\n    const lead = await prisma.lead.findFirst({\r\n      where: {\r\n        id,\r\n        organizationId: req.organizationId\r\n      },\r\n      include: {\r\n        assignedTo: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        leadStatus: true\r\n      }\r\n    });\r\n\r\n    if (!lead) {\r\n      return res.status(404).json({ error: 'Client non trouv\u00E9' });\r\n    }\r\n\r\n    const data = lead.data as any || {};\r\n    const client = {\r\n      id: lead.id,\r\n      name: data.company || data.name || `Lead ${lead.id.slice(0, 8)}`,\r\n      email: data.email || data.contactEmail || '',\r\n      phone: data.phone || data.phoneNumber || '',\r\n      company: data.company || '',\r\n      status: lead.status,\r\n      assignedTo: lead.assignedTo,\r\n      createdAt: lead.createdAt,\r\n      updatedAt: lead.updatedAt,\r\n      data: lead.data\r\n    };\r\n\r\n    res.json(client);\r\n\r\n  } catch (error) {\r\n    console.error('[CLIENTS] Erreur lors de la r\u00E9cup\u00E9ration du client:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration du client',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/clients - Cr\u00E9er un nouveau client\r\nrouter.post('/', async (req, res) => {\r\n  try {\r\n    const { name, email, phone, company } = req.body;\r\n    console.log('[CLIENTS] Cr\u00E9ation d\\'un nouveau client:', { name, email, company });\r\n\r\n    // Cr\u00E9er un lead avec le statut \"client\"\r\n    const lead = await prisma.lead.create({\r\n      data: {\r\n        organizationId: req.organizationId,\r\n        status: 'client',\r\n        data: {\r\n          name,\r\n          email,\r\n          phone,\r\n          company,\r\n          source: 'manuel'\r\n        }\r\n      },\r\n      include: {\r\n        assignedTo: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    const client = {\r\n      id: lead.id,\r\n      name: company || name,\r\n      email,\r\n      phone,\r\n      company,\r\n      status: lead.status,\r\n      assignedTo: lead.assignedTo,\r\n      createdAt: lead.createdAt,\r\n      updatedAt: lead.updatedAt\r\n    };\r\n\r\n    res.status(201).json(client);\r\n\r\n  } catch (error) {\r\n    console.error('[CLIENTS] Erreur lors de la cr\u00E9ation du client:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du client',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authenticateToken } from '../middleware/auth.js';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Appliquer l'authentification \u00E0 toutes les routes\r\nrouter.use(authenticateToken);\r\n\r\n// Interface pour les donn\u00E9es de projet stock\u00E9es dans le JSON\r\ninterface ProjectData {\r\n  name?: string;\r\n  description?: string;\r\n  status?: string;\r\n  clientId?: string;\r\n  clientName?: string;\r\n  budget?: number;\r\n  deadline?: string;\r\n  priority?: string;\r\n}\r\n\r\n// GET /api/projects - R\u00E9cup\u00E9rer tous les projets\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    console.log('[PROJECTS] R\u00E9cup\u00E9ration des projets pour l\\'organisation:', req.organizationId);\r\n    \r\n    // Pour l'instant, on utilise les leads avec un statut de projet\r\n    // Plus tard, on pourra cr\u00E9er un mod\u00E8le Project d\u00E9di\u00E9\r\n    const projectLeads = await prisma.lead.findMany({\r\n      where: {\r\n        organizationId: req.organizationId,\r\n        OR: [\r\n          { status: { contains: 'projet', mode: 'insensitive' } },\r\n          { status: { contains: 'en cours', mode: 'insensitive' } },\r\n          { status: { contains: 'development', mode: 'insensitive' } }\r\n        ]\r\n      },\r\n      include: {\r\n        assignedTo: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        },\r\n        leadStatus: true\r\n      },\r\n      orderBy: {\r\n        updatedAt: 'desc'\r\n      }\r\n    });\r\n\r\n    // Transformer en format projet pour l'agenda\r\n    const projects = projectLeads.map(lead => {\r\n      const data = lead.data as ProjectData || {};\r\n      return {\r\n        id: lead.id,\r\n        name: data.name || `Projet ${lead.id.slice(0, 8)}`,\r\n        description: data.description || '',\r\n        status: lead.status,\r\n        client: data.clientName || '',\r\n        assignedTo: lead.assignedTo,\r\n        budget: data.budget || 0,\r\n        deadline: data.deadline || null,\r\n        priority: data.priority || 'medium',\r\n        createdAt: lead.createdAt,\r\n        updatedAt: lead.updatedAt\r\n      };\r\n    });\r\n\r\n    // Si aucun projet trouv\u00E9, retourner quelques exemples pour d\u00E9monstration\r\n    if (projects.length === 0) {\r\n      const sampleProjects = [\r\n        {\r\n          id: 'sample-1',\r\n          name: 'Site web entreprise',\r\n          description: 'D\u00E9veloppement du site vitrine',\r\n          status: 'en cours',\r\n          client: 'Client Exemple',\r\n          assignedTo: null,\r\n          budget: 5000,\r\n          deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),\r\n          priority: 'high',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        },\r\n        {\r\n          id: 'sample-2',\r\n          name: 'Application mobile',\r\n          description: 'App iOS/Android',\r\n          status: 'planifi\u00E9',\r\n          client: 'Autre Client',\r\n          assignedTo: null,\r\n          budget: 15000,\r\n          deadline: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(),\r\n          priority: 'medium',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      ];\r\n      console.log('[PROJECTS] Aucun projet trouv\u00E9, retour d\\'exemples');\r\n      return res.json(sampleProjects);\r\n    }\r\n\r\n    console.log(`[PROJECTS] ${projects.length} projets trouv\u00E9s`);\r\n    res.json(projects);\r\n\r\n  } catch (error) {\r\n    console.error('[PROJECTS] Erreur lors de la r\u00E9cup\u00E9ration des projets:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des projets',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// GET /api/projects/:id - R\u00E9cup\u00E9rer un projet sp\u00E9cifique\r\nrouter.get('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    console.log('[PROJECTS] R\u00E9cup\u00E9ration du projet:', id);\r\n\r\n    // V\u00E9rifier s'il s'agit d'un exemple\r\n    if (id.startsWith('sample-')) {\r\n      const sampleProject = {\r\n        id,\r\n        name: id === 'sample-1' ? 'Site web entreprise' : 'Application mobile',\r\n        description: id === 'sample-1' ? 'D\u00E9veloppement du site vitrine' : 'App iOS/Android',\r\n        status: 'en cours',\r\n        client: 'Client Exemple',\r\n        assignedTo: null,\r\n        budget: id === 'sample-1' ? 5000 : 15000,\r\n        deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),\r\n        priority: 'high',\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      };\r\n      return res.json(sampleProject);\r\n    }\r\n\r\n    const lead = await prisma.lead.findFirst({\r\n      where: {\r\n        id,\r\n        organizationId: req.organizationId\r\n      },\r\n      include: {\r\n        assignedTo: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!lead) {\r\n      return res.status(404).json({ error: 'Projet non trouv\u00E9' });\r\n    }\r\n\r\n    const data = lead.data as ProjectData || {};\r\n    const project = {\r\n      id: lead.id,\r\n      name: data.name || `Projet ${lead.id.slice(0, 8)}`,\r\n      description: data.description || '',\r\n      status: lead.status,\r\n      client: data.clientName || '',\r\n      assignedTo: lead.assignedTo,\r\n      budget: data.budget || 0,\r\n      deadline: data.deadline || null,\r\n      priority: data.priority || 'medium',\r\n      createdAt: lead.createdAt,\r\n      updatedAt: lead.updatedAt,\r\n      data: lead.data\r\n    };\r\n\r\n    res.json(project);\r\n\r\n  } catch (error) {\r\n    console.error('[PROJECTS] Erreur lors de la r\u00E9cup\u00E9ration du projet:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration du projet',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /api/projects - Cr\u00E9er un nouveau projet\r\nrouter.post('/', async (req, res) => {\r\n  try {\r\n    const { name, description, clientName, budget, deadline, priority } = req.body;\r\n    console.log('[PROJECTS] Cr\u00E9ation d\\'un nouveau projet:', { name, clientName });\r\n\r\n    const lead = await prisma.lead.create({\r\n      data: {\r\n        organizationId: req.organizationId,\r\n        status: 'projet',\r\n        data: {\r\n          name,\r\n          description,\r\n          clientName,\r\n          budget: budget ? parseFloat(budget) : 0,\r\n          deadline,\r\n          priority: priority || 'medium',\r\n          source: 'manuel'\r\n        }\r\n      },\r\n      include: {\r\n        assignedTo: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    const project = {\r\n      id: lead.id,\r\n      name,\r\n      description,\r\n      status: lead.status,\r\n      client: clientName,\r\n      assignedTo: lead.assignedTo,\r\n      budget: budget ? parseFloat(budget) : 0,\r\n      deadline,\r\n      priority: priority || 'medium',\r\n      createdAt: lead.createdAt,\r\n      updatedAt: lead.updatedAt\r\n    };\r\n\r\n    res.status(201).json(project);\r\n\r\n  } catch (error) {\r\n    console.error('[PROJECTS] Erreur lors de la cr\u00E9ation du projet:', error);\r\n    res.status(500).json({ \r\n      error: 'Erreur lors de la cr\u00E9ation du projet',\r\n      message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport GmailService from '../services/GmailService.js';\r\n\r\nconst router = Router();\r\n\r\n/**\r\n * @route   GET /api/emails\r\n * @desc    R\u00E9cup\u00E8re les emails Gmail de l'utilisateur authentifi\u00E9 pour un dossier donn\u00E9.\r\n * @access  Private\r\n */\r\nrouter.get('/', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  if (!req.user?.userId) {\r\n    return res.status(401).json({ error: 'Authentification requise' });\r\n  }\r\n\r\n  const { folder = 'INBOX' } = req.query;\r\n\r\n  try {\r\n    const threads = await GmailService.listThreads(req.user.userId, folder as string);\r\n    res.json(threads);\r\n  } catch (error) {\r\n    console.error(`Erreur lors de la r\u00E9cup\u00E9ration des emails Gmail du dossier ${folder}:`, error);\r\n    \r\n    // G\u00E9rer les erreurs d'authentification sp\u00E9cifiquement\r\n    if (error instanceof Error && error.message.includes('Authentication failed')) {\r\n      return res.status(401).json({ \r\n        error: 'Authentification Google requise', \r\n        needsAuth: true \r\n      });\r\n    }\r\n    \r\n    // G\u00E9rer le cas o\u00F9 l'utilisateur n'est pas connect\u00E9 \u00E0 Google\r\n    if (error instanceof Error && error.message.includes('not authenticated with Google')) {\r\n      return res.status(200).json([]); // Retourner un tableau vide plut\u00F4t qu'une erreur\r\n    }\r\n    \r\n    // Autres erreurs : retourner un tableau vide pour \u00E9viter de casser l'agenda\r\n    console.warn(`Gmail non disponible pour user ${req.user.userId}, retour d'un tableau vide`);\r\n    res.status(200).json([]);\r\n  }\r\n});\r\n\r\n/**\r\n * @route   GET /api/emails/thread/:threadId\r\n * @desc    R\u00E9cup\u00E8re les d\u00E9tails d'une conversation Gmail\r\n * @access  Private\r\n */\r\nrouter.get('/thread/:threadId', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  if (!req.user?.userId) {\r\n    return res.status(401).json({ error: 'Authentification requise' });\r\n  }\r\n\r\n  const { threadId } = req.params;\r\n\r\n  try {\r\n    const threadDetails = await GmailService.getThreadDetails(req.user.userId, threadId);\r\n    res.json(threadDetails);\r\n  } catch (error) {\r\n    console.error(`Erreur lors de la r\u00E9cup\u00E9ration du thread ${threadId}:`, error);\r\n    res.status(500).json({ error: 'Une erreur interne est survenue.' });\r\n  }\r\n});\r\n\r\n/**\r\n * @route   POST /api/emails/send\r\n * @desc    Envoie un email via Gmail\r\n * @access  Private\r\n */\r\nrouter.post('/send', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  if (!req.user?.userId) {\r\n    return res.status(401).json({ error: 'Authentification requise' });\r\n  }\r\n\r\n  const { to, subject, body } = req.body;\r\n\r\n  if (!to || !subject || !body) {\r\n    return res.status(400).json({ error: 'Destinataire, sujet et corps requis' });\r\n  }\r\n\r\n  try {\r\n    const result = await GmailService.sendEmail(req.user.userId, to, subject, body);\r\n    res.json({ success: true, messageId: result.id });\r\n  } catch (error) {\r\n    console.error('Erreur lors de l\\'envoi de l\\'email:', error);\r\n    res.status(500).json({ error: 'Une erreur interne est survenue.' });\r\n  }\r\n});\r\n\r\nexport default router;", "import { google } from 'googleapis';\r\nimport { Auth } from 'google-auth-library';\r\nimport { AutoGoogleAuthService } from './AutoGoogleAuthService.js';\r\nimport { GaxiosError } from 'gaxios';\r\n\r\nclass GmailService {\r\n  private getOAuthClientForUser(userId: string): Auth.OAuth2Client {\r\n    const authService = AutoGoogleAuthService.getInstance();\r\n    const oauth2Client = authService.getOAuth2ClientForUser(userId);\r\n    if (!oauth2Client) {\r\n      throw new Error(`User ${userId} is not authenticated with Google.`);\r\n    }\r\n    return oauth2Client;\r\n  }\r\n\r\n  private async getGmailClient(userId: string) {\r\n    const oauth2Client = this.getOAuthClientForUser(userId);\r\n    return google.gmail({ version: 'v1', auth: oauth2Client });\r\n  }\r\n\r\n  // Extrait un header sp\u00E9cifique d'une liste de headers\r\n  private extractHeader(headers: any[], name: string): string {\r\n    const header = headers.find(h => h.name.toLowerCase() === name.toLowerCase());\r\n    return header ? header.value : '';\r\n  }\r\n\r\n  // D\u00E9code le corps d'un message (Base64URL)\r\n  private decodeBody(bodyData: string | undefined): string {\r\n    if (!bodyData) return '';\r\n    return Buffer.from(bodyData, 'base64url').toString('utf-8');\r\n  }\r\n\r\n  // Trouve la meilleure partie du corps de l'email \u00E0 afficher\r\n  private getMessageBody(payload: any): string {\r\n    let body = '';\r\n    if (payload.parts) {\r\n      // Pr\u00E9f\u00E9rer le HTML\r\n      const htmlPart = payload.parts.find((part: any) => part.mimeType === 'text/html');\r\n      if (htmlPart && htmlPart.body?.data) {\r\n        body = this.decodeBody(htmlPart.body.data);\r\n      } else {\r\n        // Sinon, prendre le texte brut\r\n        const textPart = payload.parts.find((part: any) => part.mimeType === 'text/plain');\r\n        if (textPart && textPart.body?.data) {\r\n          body = this.decodeBody(textPart.body.data);\r\n        }\r\n      }\r\n    } else if (payload.body?.data) {\r\n      body = this.decodeBody(payload.body.data);\r\n    }\r\n    return body;\r\n  }\r\n\r\n  async listThreads(userId: string, mailbox: string) {\r\n    try {\r\n      const gmail = await this.getGmailClient(userId);\r\n      const response = await gmail.users.threads.list({\r\n        userId: 'me',\r\n        labelIds: [mailbox.toUpperCase()],\r\n        maxResults: 30,\r\n      });\r\n\r\n      const threads = response.data.threads || [];\r\n      if (threads.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      const threadDetailsPromises = threads.map(thread =>\r\n        gmail.users.threads.get({ userId: 'me', id: thread.id!, format: 'metadata', metadataHeaders: ['Subject', 'From', 'To', 'Date'] })\r\n      );\r\n\r\n      const detailedThreads = await Promise.all(threadDetailsPromises);\r\n\r\n      const formattedThreads = detailedThreads.map(res => {\r\n        const firstMessage = res.data.messages?.[0];\r\n        const headers = firstMessage?.payload?.headers || [];\r\n        \r\n        return {\r\n          id: res.data.id!,\r\n          subject: this.extractHeader(headers, 'Subject'),\r\n          snippet: res.data.snippet || '',\r\n          timestamp: firstMessage?.internalDate ? new Date(parseInt(firstMessage.internalDate, 10)).toISOString() : new Date().toISOString(),\r\n          from: this.extractHeader(headers, 'From'),\r\n          to: this.extractHeader(headers, 'To'),\r\n          unread: firstMessage?.labelIds?.includes('UNREAD') || false,\r\n          hasAttachments: firstMessage?.payload?.parts?.some(p => p.filename) || false,\r\n          isStarred: firstMessage?.labelIds?.includes('STARRED') || false,\r\n          messages: [], // Sera charg\u00E9 au clic\r\n        };\r\n      });\r\n\r\n      return formattedThreads;\r\n    } catch (error) {\r\n      const gaxiosError = error as GaxiosError;\r\n      console.error('Error listing Gmail threads:', gaxiosError.message);\r\n      if (gaxiosError.response?.status === 401) {\r\n        throw new Error('Authentication failed. Please reconnect your Google account.');\r\n      }\r\n      throw new Error('Could not retrieve Gmail threads.');\r\n    }\r\n  }\r\n\r\n  async getThreadDetails(userId: string, threadId: string) {\r\n    try {\r\n      const gmail = await this.getGmailClient(userId);\r\n      const response = await gmail.users.threads.get({\r\n        userId: 'me',\r\n        id: threadId,\r\n      });\r\n\r\n      const thread = response.data;\r\n      if (!thread || !thread.messages) {\r\n        throw new Error('Thread not found or empty.');\r\n      }\r\n\r\n      const messages = thread.messages.map(msg => {\r\n        const headers = msg.payload?.headers || [];\r\n        return {\r\n          id: msg.id!,\r\n          body: this.getMessageBody(msg.payload),\r\n          from: this.extractHeader(headers, 'From'),\r\n          to: this.extractHeader(headers, 'To'),\r\n          subject: this.extractHeader(headers, 'Subject'),\r\n          timestamp: msg.internalDate ? new Date(parseInt(msg.internalDate, 10)).toISOString() : new Date().toISOString(),\r\n          isRead: !msg.labelIds?.includes('UNREAD'),\r\n          headers: headers.reduce((acc, h) => ({ ...acc, [h.name]: h.value }), {}),\r\n        };\r\n      });\r\n\r\n      const firstMessageHeaders = thread.messages[0]?.payload?.headers || [];\r\n      return {\r\n        id: thread.id!,\r\n        subject: this.extractHeader(firstMessageHeaders, 'Subject'),\r\n        snippet: thread.snippet || '',\r\n        timestamp: thread.messages[0]?.internalDate ? new Date(parseInt(thread.messages[0].internalDate, 10)).toISOString() : new Date().toISOString(),\r\n        from: this.extractHeader(firstMessageHeaders, 'From'),\r\n        to: this.extractHeader(firstMessageHeaders, 'To'),\r\n        unread: thread.messages[0]?.labelIds?.includes('UNREAD') || false,\r\n        hasAttachments: thread.messages.some(m => m.payload?.parts?.some(p => p.filename)),\r\n        isStarred: thread.messages[0]?.labelIds?.includes('STARRED') || false,\r\n        messages: messages,\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting Gmail thread details:', error);\r\n      throw new Error('Could not retrieve thread details.');\r\n    }\r\n  }\r\n\r\n  async sendEmail(userId: string, to: string, subject: string, body: string) {\r\n    try {\r\n      const gmail = await this.getGmailClient(userId);\r\n      const userProfile = await gmail.users.getProfile({ userId: 'me' });\r\n      const fromEmail = userProfile.data.emailAddress;\r\n\r\n      if (!fromEmail) {\r\n        throw new Error(\"Could not determine user's email address.\");\r\n      }\r\n\r\n      const emailLines = [\r\n        `From: \"${fromEmail}\" <${fromEmail}>`,\r\n        `To: ${to}`,\r\n        'Content-type: text/html;charset=iso-8859-1',\r\n        'MIME-Version: 1.0',\r\n        `Subject: ${subject}`,\r\n        '',\r\n        body,\r\n      ];\r\n      const email = emailLines.join('\\r\\n');\r\n\r\n      const response = await gmail.users.messages.send({\r\n        userId: 'me',\r\n        requestBody: {\r\n          raw: Buffer.from(email).toString('base64url'),\r\n        },\r\n      });\r\n\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error sending email:', error);\r\n      throw new Error('Could not send email.');\r\n    }\r\n  }\r\n}\r\n\r\nexport default new GmailService();\r\n", "import { PrismaClient } from '@prisma/client';\r\nimport { googleOAuthService } from '../google-auth/core/GoogleOAuthCore.js';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * Service pour la connexion automatique \u00E0 Google Workspace lors de la connexion au CRM\r\n * G\u00E8re la connexion automatique en arri\u00E8re-plan sans intervention utilisateur\r\n */\r\nexport class AutoGoogleAuthService {\r\n  private static instance: AutoGoogleAuthService | null = null;\r\n\r\n  private constructor() {}\r\n\r\n  static getInstance(): AutoGoogleAuthService {\r\n    if (!this.instance) {\r\n      this.instance = new AutoGoogleAuthService();\r\n    }\r\n    return this.instance;\r\n  }\r\n\r\n  /**\r\n   * Connecte automatiquement l'utilisateur \u00E0 Google Workspace lors de sa connexion au CRM\r\n   * Utilise les credentials stock\u00E9s ou initie la premi\u00E8re connexion\r\n   */\r\n  async autoConnectToGoogle(userId: string, organizationId?: string): Promise<{\r\n    success: boolean;\r\n    isConnected: boolean;\r\n    needsManualAuth: boolean;\r\n    authUrl?: string;\r\n    message: string;\r\n  }> {\r\n    try {\r\n      console.log(`\uD83D\uDD04 [AutoGoogleAuth] D\u00C9BUT autoConnectToGoogle pour user ${userId} org ${organizationId}...`);\r\n\r\n      // 1. V\u00E9rifier si l'utilisateur a d\u00E9j\u00E0 des tokens Google valides\r\n      console.log(`\uD83D\uDD0D [AutoGoogleAuth] V\u00E9rification tokens existants pour user ${userId}...`);\r\n      const existingTokens = await googleOAuthService.getUserTokens(userId);\r\n      console.log(`\uD83D\uDD0D [AutoGoogleAuth] Tokens existants pour user ${userId}:`, existingTokens ? 'TROUV\u00C9S' : 'AUCUN');\r\n      \r\n      if (existingTokens) {\r\n        // \uD83D\uDD27 CORRECTIF: Beaucoup moins agressif - on fait confiance aux tokens existants\r\n        const now = new Date();\r\n        const isExpired = existingTokens.expiresAt && existingTokens.expiresAt <= now;\r\n        \r\n        if (!isExpired) {\r\n          console.log(`\u2705 [AutoGoogleAuth] Tokens valides trouv\u00E9s pour user ${userId} - connexion consid\u00E9r\u00E9e comme active`);\r\n          return {\r\n            success: true,\r\n            isConnected: true,\r\n            needsManualAuth: false,\r\n            message: 'Connexion Google automatique r\u00E9ussie (tokens existants)'\r\n          };\r\n        } else {\r\n          console.log(`\u26A0\uFE0F [AutoGoogleAuth] Tokens expir\u00E9s pour user ${userId} - mais on laisse le middleware g\u00E9rer le refresh`);\r\n          return {\r\n            success: true,\r\n            isConnected: true,\r\n            needsManualAuth: false,\r\n            message: 'Connexion Google - refresh d\u00E9l\u00E9gu\u00E9 au middleware'\r\n          };\r\n        }\r\n      }\r\n\r\n      // 2. Si pas de tokens ou refresh impossible, v\u00E9rifier si l'organisation a une connexion centralis\u00E9e\r\n      if (organizationId) {\r\n        const orgConnection = await this.checkOrganizationGoogleConnection(organizationId);\r\n        if (orgConnection.hasConnection) {\r\n          console.log(`\u2705 [AutoGoogleAuth] Connexion Google organisation disponible pour user ${userId}`);\r\n          return {\r\n            success: true,\r\n            isConnected: true,\r\n            needsManualAuth: false,\r\n            message: 'Connexion Google via organisation r\u00E9ussie'\r\n          };\r\n        }\r\n      }\r\n\r\n      // 3. Premi\u00E8re connexion n\u00E9cessaire - g\u00E9n\u00E9rer l'URL d'autorisation\r\n      const authUrl = googleOAuthService.getAuthUrl(userId);\r\n      \r\n      console.log(`\uD83D\uDD10 [AutoGoogleAuth] Premi\u00E8re connexion Google n\u00E9cessaire pour user ${userId}`);\r\n      return {\r\n        success: true,\r\n        isConnected: false,\r\n        needsManualAuth: true,\r\n        authUrl,\r\n        message: 'Premi\u00E8re connexion Google requise'\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Erreur connexion automatique pour user ${userId}:`, error);\r\n      return {\r\n        success: false,\r\n        isConnected: false,\r\n        needsManualAuth: true,\r\n        message: error instanceof Error ? error.message : 'Erreur inconnue'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teste si les tokens existants sont valides (VERSION MOINS AGRESSIVE)\r\n   */\r\n  private async testExistingTokens(userId: string): Promise<boolean> {\r\n    try {\r\n      // \uD83D\uDD27 CORRECTIF : On consid\u00E8re les tokens comme valides s'ils existent\r\n      // Au lieu de faire des appels API agressifs qui peuvent causer des refresh\r\n      const tokens = await googleOAuthService.getUserTokens(userId);\r\n      \r\n      if (!tokens) {\r\n        console.log(`[AutoGoogleAuth] Pas de tokens pour user ${userId}`);\r\n        return false;\r\n      }\r\n      \r\n      // V\u00E9rifier seulement l'expiration, pas la validit\u00E9 via API\r\n      const now = new Date();\r\n      const isExpired = tokens.expiresAt && tokens.expiresAt <= now;\r\n      \r\n      if (isExpired) {\r\n        console.log(`[AutoGoogleAuth] Tokens expir\u00E9s pour user ${userId}`);\r\n        return false;\r\n      }\r\n      \r\n      console.log(`[AutoGoogleAuth] \u2705 Tokens pr\u00E9sents et non expir\u00E9s pour user ${userId}`);\r\n      return true;\r\n      \r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Test tokens failed for user ${userId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tente de rafra\u00EEchir automatiquement les tokens (VERSION MOINS AGRESSIVE)\r\n   */\r\n  private async attemptTokenRefresh(userId: string): Promise<boolean> {\r\n    try {\r\n      // \uD83D\uDD27 CORRECTIF : Moins agressif dans le refresh des tokens\r\n      // On ne fait plus d'appels API automatiques, on laisse le middleware s'en charger\r\n      console.log(`[AutoGoogleAuth] \uD83D\uDD27 Refresh conservateur pour user ${userId} - d\u00E9l\u00E9gation au middleware`);\r\n      \r\n      // Juste v\u00E9rifier que les tokens existent toujours apr\u00E8s refresh\r\n      const tokens = await googleOAuthService.getUserTokens(userId);\r\n      return !!tokens;\r\n      \r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Token refresh failed for user ${userId}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * V\u00E9rifie si l'organisation a une connexion Google centralis\u00E9e\r\n   */\r\n  private async checkOrganizationGoogleConnection(organizationId: string): Promise<{\r\n    hasConnection: boolean;\r\n    connectionType?: 'workspace' | 'oauth';\r\n  }> {\r\n    try {\r\n      // V\u00E9rifier s'il y a une configuration Google Workspace active\r\n      const workspaceConfig = await prisma.googleWorkspaceConfig.findFirst({\r\n        where: { isActive: true }\r\n      });\r\n\r\n      if (workspaceConfig) {\r\n        return {\r\n          hasConnection: true,\r\n          connectionType: 'workspace'\r\n        };\r\n      }\r\n\r\n      // V\u00E9rifier s'il y a des connexions OAuth au niveau organisation\r\n      // (Pour l'instant, on consid\u00E8re que l'organisation n'a pas de connexion centralis\u00E9e OAuth)\r\n      // Cette fonctionnalit\u00E9 peut \u00EAtre ajout\u00E9e plus tard selon votre mod\u00E8le de donn\u00E9es\r\n\r\n      return {\r\n        hasConnection: false,\r\n        connectionType: undefined\r\n      };\r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Erreur v\u00E9rification connexion org ${organizationId}:`, error);\r\n      return { hasConnection: false };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Configure la connexion automatique lors du login\r\n   * \u00C0 appeler dans le processus d'authentification du CRM\r\n   */\r\n  async handleLoginGoogleConnection(userId: string, organizationId?: string): Promise<void> {\r\n    try {\r\n      console.log(`\uD83D\uDE80 [AutoGoogleAuth] D\u00C9BUT handleLoginGoogleConnection pour user ${userId} org ${organizationId}...`);\r\n      \r\n      // Connexion asynchrone en arri\u00E8re-plan pour ne pas bloquer le login\r\n      setTimeout(async () => {\r\n        try {\r\n          console.log(`\u23F0 [AutoGoogleAuth] TIMEOUT D\u00C9CLENCH\u00C9 (5 min) - Ex\u00E9cution autoConnectToGoogle pour user ${userId}...`);\r\n          \r\n          const result = await this.autoConnectToGoogle(userId, organizationId);\r\n          console.log(`\uD83D\uDCCB [AutoGoogleAuth] R\u00C9SULTAT autoConnectToGoogle pour user ${userId}:`, result);\r\n          \r\n          if (result.success && result.isConnected) {\r\n            console.log(`\u2705 [AutoGoogleAuth] Connexion Google automatique r\u00E9ussie pour user ${userId}`);\r\n            \r\n            // Optionnel: Envoyer une notification WebSocket ou mise \u00E0 jour en temps r\u00E9el\r\n            // pour informer le frontend que Google est connect\u00E9\r\n            this.notifyFrontendGoogleConnected(userId);\r\n          } else if (result.needsManualAuth) {\r\n            console.log(`\uD83D\uDD10 [AutoGoogleAuth] Connexion manuelle requise pour user ${userId}`);\r\n            console.log(`\uD83D\uDD17 [AutoGoogleAuth] URL d'autorisation: ${result.authUrl}`);\r\n            \r\n            // Optionnel: Envoyer une notification au frontend avec l'URL d'auth\r\n            this.notifyFrontendManualAuthRequired(userId, result.authUrl);\r\n          } else {\r\n            console.log(`\u26A0\uFE0F [AutoGoogleAuth] R\u00E9sultat inattendu pour user ${userId}:`, result);\r\n          }\r\n        } catch (timeoutError) {\r\n          console.error(`\u274C [AutoGoogleAuth] Erreur dans setTimeout pour user ${userId}:`, timeoutError);\r\n        }\r\n      }, 5 * 60 * 1000); // \uD83D\uDD27 CORRECTIF: D\u00E9lai de 5 minutes au lieu de 1 seconde pour \u00EAtre moins agressif\r\n\r\n      console.log(`\uD83D\uDCE4 [AutoGoogleAuth] handleLoginGoogleConnection termin\u00E9 pour user ${userId} - timeout 5min programm\u00E9`);\r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Erreur handleLoginGoogleConnection pour user ${userId}:`, error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Notifie le frontend que Google est connect\u00E9 automatiquement\r\n   */\r\n  private notifyFrontendGoogleConnected(userId: string): void {\r\n    // TODO: Impl\u00E9menter notification WebSocket ou autre m\u00E9canisme temps r\u00E9el\r\n    console.log(`\uD83D\uDCE2 [AutoGoogleAuth] Google connect\u00E9 automatiquement pour user ${userId}`);\r\n    \r\n    // Exemple: Vous pourriez utiliser Socket.IO ou Server-Sent Events\r\n    // socketService.notifyUser(userId, {\r\n    //   type: 'GOOGLE_AUTO_CONNECTED',\r\n    //   message: 'Google Workspace connect\u00E9 automatiquement'\r\n    // });\r\n  }\r\n\r\n  /**\r\n   * Notifie le frontend qu'une connexion manuelle est requise\r\n   */\r\n  private notifyFrontendManualAuthRequired(userId: string, authUrl?: string): void {\r\n    // TODO: Impl\u00E9menter notification avec URL d'autorisation\r\n    console.log(`\uD83D\uDCE2 [AutoGoogleAuth] Connexion manuelle requise pour user ${userId}`, { authUrl });\r\n    \r\n    // Exemple: Notification avec action\r\n    // socketService.notifyUser(userId, {\r\n    //   type: 'GOOGLE_MANUAL_AUTH_REQUIRED',\r\n    //   message: 'Connectez votre compte Google Workspace',\r\n    //   action: {\r\n    //     type: 'OPEN_GOOGLE_AUTH',\r\n    //     url: authUrl\r\n    //   }\r\n    // });\r\n  }\r\n\r\n  /**\r\n   * D\u00E9connecte automatiquement Google lors du logout du CRM\r\n   */\r\n  async handleLogoutGoogleDisconnection(userId: string): Promise<void> {\r\n    try {\r\n      console.log(`\uD83D\uDD04 [AutoGoogleAuth] Nettoyage session Google pour user ${userId}...`);\r\n      \r\n      // Ne pas supprimer les tokens (pour permettre la reconnexion automatique)\r\n      // Juste nettoyer les sessions en cours si n\u00E9cessaire\r\n      \r\n      console.log(`\u2705 [AutoGoogleAuth] Session Google nettoy\u00E9e pour user ${userId}`);\r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Erreur nettoyage session Google pour user ${userId}:`, error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtient le statut de connexion Google actuel\r\n   */\r\n  async getGoogleConnectionStatus(userId: string, organizationId?: string): Promise<{\r\n    isConnected: boolean;\r\n    connectionType?: 'personal' | 'organization' | 'workspace';\r\n    lastConnected?: Date;\r\n    needsReauth?: boolean;\r\n  }> {\r\n    try {\r\n      // V\u00E9rifier connexion personnelle\r\n      const isPersonallyConnected = await googleOAuthService.isUserConnected(userId);\r\n      \r\n      if (isPersonallyConnected) {\r\n        const tokens = await googleOAuthService.getUserTokens(userId);\r\n        return {\r\n          isConnected: true,\r\n          connectionType: 'personal',\r\n          lastConnected: tokens?.updatedAt || tokens?.createdAt,\r\n          needsReauth: false\r\n        };\r\n      }\r\n\r\n      // V\u00E9rifier connexion organisation/workspace\r\n      if (organizationId) {\r\n        const orgConnection = await this.checkOrganizationGoogleConnection(organizationId);\r\n        if (orgConnection.hasConnection) {\r\n          return {\r\n            isConnected: true,\r\n            connectionType: orgConnection.connectionType === 'workspace' ? 'workspace' : 'organization',\r\n            needsReauth: false\r\n          };\r\n        }\r\n      }\r\n\r\n      return {\r\n        isConnected: false,\r\n        needsReauth: true\r\n      };\r\n    } catch (error) {\r\n      console.error(`\u274C [AutoGoogleAuth] Erreur statut connexion pour user ${userId}:`, error);\r\n      return {\r\n        isConnected: false,\r\n        needsReauth: true\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\n// Export de l'instance singleton\r\nexport const autoGoogleAuthService = AutoGoogleAuthService.getInstance();\r\n", "/**\r\n * \uD83E\uDD16 ROUTES API GOOGLE GEMINI\r\n * Routes pour l'intelligence artificielle dans le CRM\r\n */\r\n\r\nimport express from 'express';\r\nimport GoogleGeminiService from '../services/GoogleGeminiService';\r\nimport { authenticateToken } from '../middleware/auth';\r\n\r\nconst router = express.Router();\r\nconst geminiService = new GoogleGeminiService();\r\n\r\n// Middleware d'authentification pour toutes les routes Gemini\r\nrouter.use(authenticateToken);\r\n\r\n/**\r\n * \uD83D\uDCE7 POST /api/gemini/generate-email\r\n * G\u00E9n\u00E8re un email personnalis\u00E9 pour un prospect\r\n */\r\nrouter.post('/generate-email', async (req, res) => {\r\n  try {\r\n    const { leadData, emailType = 'initial' } = req.body;\r\n    \r\n    if (!leadData || (!leadData.name && !leadData.context)) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Donn\u00E9es du lead requises (nom ou contexte)'\r\n      });\r\n    }\r\n    \r\n    console.log(`\uD83E\uDD16 [Gemini] G\u00E9n\u00E9ration email ${emailType} pour ${leadData.name || 'prospect'}`);\r\n    \r\n    const result = await geminiService.generatePersonalizedEmail(leadData, emailType);\r\n    \r\n    if (result.success) {\r\n      res.json({\r\n        success: true,\r\n        email: result.email,\r\n        metadata: {\r\n          generatedAt: new Date().toISOString(),\r\n          type: emailType,\r\n          leadName: leadData.name || 'prospect'\r\n        }\r\n      });\r\n    } else {\r\n      res.status(500).json({\r\n        success: false,\r\n        message: 'Erreur lors de la g\u00E9n\u00E9ration de l\\'email',\r\n        error: result.error\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route generate-email:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la g\u00E9n\u00E9ration d\\'email'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCB POST /api/gemini/analyze-lead\r\n * Analyse les donn\u00E9es d'un lead et g\u00E9n\u00E8re des insights\r\n */\r\nrouter.post('/analyze-lead', async (req, res) => {\r\n  try {\r\n    const { leadData } = req.body;\r\n    \r\n    if (!leadData) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Donn\u00E9es du lead requises'\r\n      });\r\n    }\r\n    \r\n    console.log(`\uD83E\uDD16 [Gemini] Analyse lead ${leadData.name || 'Anonyme'}`);\r\n    \r\n    const result = await geminiService.analyzeLeadData(leadData);\r\n    \r\n    if (result.success) {\r\n      res.json({\r\n        success: true,\r\n        analysis: result.analysis,\r\n        metadata: {\r\n          analyzedAt: new Date().toISOString(),\r\n          leadId: leadData.id\r\n        }\r\n      });\r\n    } else {\r\n      res.status(500).json({\r\n        success: false,\r\n        message: 'Erreur lors de l\\'analyse du lead',\r\n        error: result.error\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route analyze-lead:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de l\\'analyse du lead'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCDD POST /api/gemini/generate-proposal\r\n * G\u00E9n\u00E8re une proposition commerciale\r\n */\r\nrouter.post('/generate-proposal', async (req, res) => {\r\n  try {\r\n    const { leadData, productData } = req.body;\r\n    \r\n    if (!leadData || !productData) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Donn\u00E9es du lead et du produit requises'\r\n      });\r\n    }\r\n    \r\n    console.log(`\uD83E\uDD16 [Gemini] G\u00E9n\u00E9ration proposition pour ${leadData.name}`);\r\n    \r\n    const result = await geminiService.generateCommercialProposal(leadData, productData);\r\n    \r\n    if (result.success) {\r\n      res.json({\r\n        success: true,\r\n        proposal: result.proposal,\r\n        metadata: {\r\n          generatedAt: new Date().toISOString(),\r\n          leadName: leadData.name,\r\n          productName: productData.name\r\n        }\r\n      });\r\n    } else {\r\n      res.status(500).json({\r\n        success: false,\r\n        message: 'Erreur lors de la g\u00E9n\u00E9ration de la proposition',\r\n        error: result.error\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route generate-proposal:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la g\u00E9n\u00E9ration de proposition'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD0D POST /api/gemini/analyze-sentiment\r\n * Analyse le sentiment d'un email\r\n */\r\nrouter.post('/analyze-sentiment', async (req, res) => {\r\n  try {\r\n    const { emailContent } = req.body;\r\n    \r\n    if (!emailContent) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Contenu de l\\'email requis'\r\n      });\r\n    }\r\n    \r\n    console.log('\uD83E\uDD16 [Gemini] Analyse sentiment email');\r\n    \r\n    const result = await geminiService.analyzeSentiment(emailContent);\r\n    \r\n    if (result.success) {\r\n      res.json({\r\n        success: true,\r\n        sentiment: result.sentiment,\r\n        metadata: {\r\n          analyzedAt: new Date().toISOString(),\r\n          emailLength: emailContent.length\r\n        }\r\n      });\r\n    } else {\r\n      res.status(500).json({\r\n        success: false,\r\n        message: 'Erreur lors de l\\'analyse de sentiment',\r\n        error: result.error\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route analyze-sentiment:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de l\\'analyse de sentiment'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCAC POST /api/gemini/suggest-response\r\n * Sugg\u00E8re une r\u00E9ponse \u00E0 un email\r\n */\r\nrouter.post('/suggest-response', async (req, res) => {\r\n  try {\r\n    const { emailContent, context = {} } = req.body;\r\n    \r\n    if (!emailContent) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Contenu de l\\'email requis'\r\n      });\r\n    }\r\n    \r\n    console.log('\uD83E\uDD16 [Gemini] Suggestion r\u00E9ponse email');\r\n    \r\n    const result = await geminiService.suggestEmailResponse(emailContent, context);\r\n    \r\n    if (result.success) {\r\n      res.json({\r\n        success: true,\r\n        suggestions: result.suggestions,\r\n        metadata: {\r\n          generatedAt: new Date().toISOString(),\r\n          context: context\r\n        }\r\n      });\r\n    } else {\r\n      res.status(500).json({\r\n        success: false,\r\n        message: 'Erreur lors de la suggestion de r\u00E9ponse',\r\n        error: result.error\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route suggest-response:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur lors de la suggestion de r\u00E9ponse'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDEA GET /api/gemini/test\r\n * Route de test pour v\u00E9rifier la connexion Gemini\r\n */\r\nrouter.get('/test', async (req, res) => {\r\n  try {\r\n    console.log('\uD83E\uDDEA [Gemini] Test de connexion');\r\n    \r\n    // Test simple avec donn\u00E9es factices\r\n    const testLead = {\r\n      name: 'Test Prospect',\r\n      company: 'Test Company',\r\n      email: 'test@example.com'\r\n    };\r\n    \r\n    const result = await geminiService.generatePersonalizedEmail(testLead, 'initial');\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Service Gemini op\u00E9rationnel',\r\n      test: result.success,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur test Gemini:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors du test Gemini',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCA GET /api/gemini/stats\r\n * Statistiques d'utilisation Gemini\r\n */\r\nrouter.get('/stats', async (req, res) => {\r\n  try {\r\n    // TODO: Impl\u00E9menter le tracking des statistiques\r\n    res.json({\r\n      success: true,\r\n      stats: {\r\n        emailsGenerated: 0,\r\n        leadsAnalyzed: 0,\r\n        proposalsCreated: 0,\r\n        sentimentAnalyses: 0,\r\n        responseSuggestions: 0,\r\n        lastUsed: new Date().toISOString()\r\n      },\r\n      message: 'Statistiques Gemini (\u00E0 impl\u00E9menter)'\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur stats Gemini:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83E\uDD16 GOOGLE GEMINI AI SERVICE POUR CRM \r\n * Service d'intelligence artificielle pour automatiser les t\u00E2ches CRM\r\n */\r\n\r\n// Import pour l'API Google Generative AI\r\nimport { GoogleGenerativeAI, type GenerativeModel } from '@google/generative-ai';\r\n\r\n// Types l\u00E9gers partag\u00E9s\r\nexport interface LeadLike { name?: string; company?: string; industry?: string; sector?: string; service?: string; notes?: string }\r\nexport interface ProductLike { name?: string }\r\nexport interface EmailCtx { objective?: string }\r\n\r\nexport interface EmailResult {\r\n  subject: string;\r\n  body: string;\r\n  tone: string;\r\n}\r\n\r\nexport interface AnalysisResult {\r\n  profil: string;\r\n  besoins: string;\r\n  opportunites: string;\r\n  actions: string;\r\n  score: number;\r\n}\r\n\r\nexport interface ProposalResult {\r\n  content: string;\r\n  wordCount: number;\r\n  sections: string[];\r\n}\r\n\r\nexport interface SentimentResult {\r\n  sentiment: string;\r\n  score: number;\r\n  emotions: string[];\r\n  urgence: string;\r\n  recommandations: string;\r\n}\r\n\r\nexport interface SuggestionsResult {\r\n  principale: string;\r\n  alternatives: string[];\r\n  objet: string;\r\n  callToAction: string;\r\n}\r\n\r\nexport class GoogleGeminiService {\r\n  private isDemoMode: boolean;\r\n  private apiKey: string | undefined;\r\n  private genAI: GoogleGenerativeAI | null = null;\r\n  private model: GenerativeModel | null = null;\r\n  private primaryModelName: string;\r\n  private fallbackModelNames: string[] = [];\r\n  private modelCache: Map<string, GenerativeModel> = new Map();\r\n  private modelName: string; // compat h\u00E9ritage routes existantes\r\n  // Observabilit\u00E9 / R\u00E9silience\r\n  private consecutiveFailures = 0;\r\n  private lastError: string | null = null;\r\n  private lastSuccessAt: Date | null = null;\r\n  private degradedUntil: number | null = null; // timestamp ms si circuit breaker actif\r\n  // Param\u00E8tres r\u00E9silience\r\n  private maxRetries: number;\r\n  private baseTimeoutMs: number;\r\n  private perAttemptExtraTimeoutMs: number;\r\n\r\n  constructor() {\r\n    // V\u00E9rifier si la cl\u00E9 API est configur\u00E9e\r\n    this.apiKey = process.env.GOOGLE_AI_API_KEY;\r\n    const forcedMode = process.env.AI_MODE; // force-mock | force-live | auto\r\n    this.isDemoMode = forcedMode === 'force-mock' ? true : (!this.apiKey && forcedMode !== 'force-live');\r\n    const explicitDefaultModel = process.env.GEMINI_MODEL?.trim();\r\n    const fastModel = process.env.GEMINI_FAST_MODEL?.trim();\r\n    this.primaryModelName = fastModel || explicitDefaultModel || 'gemini-2.5-flash';\r\n    const fallbackEnv = process.env.GEMINI_MODEL_FALLBACKS || explicitDefaultModel || 'gemini-2.5-pro';\r\n    this.fallbackModelNames = fallbackEnv\r\n      .split(',')\r\n      .map((name) => name.trim())\r\n      .filter((name) => !!name && name !== this.primaryModelName);\r\n    // Compatibilit\u00E9 h\u00E9ritage (certaines routes lisent encore this.modelName)\r\n    this.modelName = this.primaryModelName;\r\n\r\n    // Param\u00E8tres par d\u00E9faut (surchageables via .env)\r\n    this.maxRetries = Math.max(0, parseInt(process.env.AI_MAX_RETRIES || '2', 10) || 2);\r\n    this.baseTimeoutMs = Math.max(2000, parseInt(process.env.AI_TIMEOUT_MS || '12000', 10) || 12000);\r\n    this.perAttemptExtraTimeoutMs = Math.max(0, parseInt(process.env.AI_RETRY_TIMEOUT_INCREMENT_MS || '2000', 10) || 2000);\r\n\r\n    if (this.isDemoMode) {\r\n      console.log('\uD83E\uDD16 GoogleGeminiService initialis\u00E9 (mode d\u00E9veloppement - d\u00E9mo)');\r\n      console.log('\u2139\uFE0F  Pour activer l\\'API r\u00E9elle, configurez GOOGLE_AI_API_KEY dans .env');\r\n    } else {\r\n      console.log('\uD83E\uDD16 GoogleGeminiService initialis\u00E9 (mode production - API r\u00E9elle)');\r\n      this.genAI = new GoogleGenerativeAI(this.apiKey!);\r\n      this.model = this.getModelInstance(this.primaryModelName);\r\n      this.modelCache.set(this.primaryModelName, this.model);\r\n      console.log(`\u2705 Cl\u00E9 API Gemini d\u00E9tect\u00E9e, mod\u00E8le rapide: ${this.primaryModelName} (API v1beta)`);\r\n      if (this.fallbackModelNames.length > 0) {\r\n        console.log(`\u21AA\uFE0F  Mod\u00E8les de secours configur\u00E9s: ${this.fallbackModelNames.join(', ')}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  /** Indique si on est en mode live */\r\n  public isLive(): boolean { return !this.isDemoMode; }\r\n\r\n  /** Chat g\u00E9n\u00E9rique multi-modules */\r\n  public async chat(params: { prompt: string; raw?: boolean }): Promise<{ success: boolean; content?: string; mode: 'live' | 'mock'; error?: string; model?: string }> {\r\n    const { prompt } = params;\r\n    if (this.isDemoMode) {\r\n      return { success: true, mode: 'mock', content: this.buildDemoChat(prompt), model: 'demo' };\r\n    }\r\n    // Circuit breaker actif ?\r\n    if (this.degradedUntil && Date.now() < this.degradedUntil) {\r\n      return {\r\n        success: true,\r\n        mode: 'mock',\r\n        content: this.buildDemoChat(prompt),\r\n        error: this.lastError || 'circuit-breaker-active',\r\n        model: 'fallback-mock'\r\n      };\r\n    }\r\n    try {\r\n      const result = await this.callGeminiAPIWithFallbacks(prompt);\r\n      if (result.success) {\r\n        this.recordSuccess();\r\n        return { success: true, content: result.content, mode: 'live', model: result.modelUsed };\r\n      }\r\n      this.recordFailure(result.error || 'unknown-error');\r\n      return {\r\n        success: true,\r\n        content: this.buildDemoChat(prompt),\r\n        mode: 'mock',\r\n        error: result.error,\r\n        model: result.modelUsed || this.primaryModelName\r\n      };\r\n    } catch (e) {\r\n      const msg = (e as Error).message;\r\n      this.recordFailure(msg);\r\n      return {\r\n        success: true,\r\n        content: this.buildDemoChat(prompt),\r\n        mode: 'mock',\r\n        error: msg,\r\n        model: this.primaryModelName\r\n      };\r\n    }\r\n  }\r\n\r\n  private buildDemoChat(userPrompt: string): string {\r\n    return `\\nR\u00E9ponse simplifi\u00E9e (mode simul\u00E9) pour: ${userPrompt.slice(0,120)}...\\nJe peux proposer: planifier un RDV, analyser un lead, g\u00E9n\u00E9rer un email ou la prochaine action. Pr\u00E9cisez votre besoin.`;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCE7 G\u00C9N\u00C9RATION EMAIL PERSONNALIS\u00C9\r\n   * G\u00E9n\u00E8re un email personnalis\u00E9 pour un prospect\r\n   */\r\n  async generatePersonalizedEmail(leadData: LeadLike, emailType = 'initial') {\r\n    try {\r\n      console.log(`\uD83E\uDD16 [Gemini] G\u00E9n\u00E9ration email ${emailType} pour ${leadData.name}`);\r\n      \r\n      if (this.isDemoMode) {\r\n        return this.generateDemoEmail(leadData, emailType);\r\n      }\r\n      \r\n      // Utilisation de l'API Gemini r\u00E9elle\r\n      const prompt = this.buildEmailPrompt(leadData, emailType);\r\n      const result = await this.callGeminiAPIWithFallbacks(prompt, emailType === 'initial' ? undefined : [this.primaryModelName, ...this.fallbackModelNames]);\r\n\r\n      if (result.success && result.content) {\r\n        return {\r\n          success: true,\r\n          email: this.parseEmailResponse(result.content),\r\n          source: 'gemini-api',\r\n          model: result.modelUsed\r\n        };\r\n      }\r\n      \r\n      // Fallback en cas d'erreur API\r\n      console.warn('\u26A0\uFE0F Erreur API Gemini, fallback vers d\u00E9mo');\r\n      return { ...this.generateDemoEmail(leadData, emailType), model: 'demo' };\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C Erreur g\u00E9n\u00E9ration email:', error);\r\n      return { success: false, error: (error as Error).message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCB ANALYSE ET R\u00C9SUM\u00C9 DE LEAD\r\n   * Analyse les donn\u00E9es d'un lead et g\u00E9n\u00E8re un r\u00E9sum\u00E9 intelligent\r\n   */\r\n  async analyzeLeadData(leadData: LeadLike) {\r\n    try {\r\n      console.log(`\uD83E\uDD16 [Gemini] Analyse lead ${leadData.name || 'Anonyme'}`);\r\n      \r\n      if (this.isDemoMode) {\r\n        return this.generateDemoAnalysis(leadData);\r\n      }\r\n      \r\n      // TODO: Int\u00E9gration r\u00E9elle Vertex AI\r\n      return { success: false, error: 'Vertex AI non configur\u00E9' };\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C Erreur analyse lead:', error);\r\n      return { success: false, error: (error as Error).message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCDD G\u00C9N\u00C9RATION PROPOSITION COMMERCIALE\r\n   * Cr\u00E9e une proposition commerciale personnalis\u00E9e\r\n   */\r\n  async generateCommercialProposal(leadData: LeadLike, productData: ProductLike) {\r\n    try {\r\n      console.log(`\uD83E\uDD16 [Gemini] G\u00E9n\u00E9ration proposition pour ${leadData.name}`);\r\n      \r\n      if (this.isDemoMode) {\r\n        return this.generateDemoProposal(leadData, productData);\r\n      }\r\n      \r\n      // TODO: Int\u00E9gration r\u00E9elle Vertex AI\r\n      return { success: false, error: 'Vertex AI non configur\u00E9' };\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C Erreur g\u00E9n\u00E9ration proposition:', error);\r\n      return { success: false, error: (error as Error).message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD0D ANALYSE SENTIMENT EMAIL\r\n   * Analyse le sentiment d'un email re\u00E7u\r\n   */\r\n  async analyzeSentiment(emailContent: string) {\r\n    try {\r\n      console.log('\uD83E\uDD16 [Gemini] Analyse sentiment email');\r\n      \r\n      if (this.isDemoMode) {\r\n        return this.generateDemoSentiment(emailContent);\r\n      }\r\n      \r\n      // TODO: Int\u00E9gration r\u00E9elle Vertex AI\r\n      return { success: false, error: 'Vertex AI non configur\u00E9' };\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C Erreur analyse sentiment:', error);\r\n      return { success: false, error: (error as Error).message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCAC SUGGESTION R\u00C9PONSE EMAIL\r\n   * Sugg\u00E8re une r\u00E9ponse appropri\u00E9e \u00E0 un email\r\n   */\r\n  async suggestEmailResponse(emailContent: string, context: EmailCtx = {}) {\r\n    try {\r\n      console.log('\uD83E\uDD16 [Gemini] Suggestion r\u00E9ponse email');\r\n      \r\n      if (this.isDemoMode) {\r\n        return this.generateDemoResponse(emailContent, context);\r\n      }\r\n      \r\n      // TODO: Int\u00E9gration r\u00E9elle Vertex AI\r\n      return { success: false, error: 'Vertex AI non configur\u00E9' };\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C Erreur suggestion email:', error);\r\n      return { success: false, error: (error as Error).message };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAD M\u00C9THODES DEMO (SIMULATION)\r\n   * Ces m\u00E9thodes simulent les r\u00E9ponses de Gemini en attendant la configuration\r\n   */\r\n  \r\n  private generateDemoEmail(leadData: LeadLike, emailType: string) {\r\n    const emailTemplates = {\r\n      initial: {\r\n        subject: `Bonjour ${leadData.name} - Proposition CRM personnalis\u00E9e pour ${leadData.company || 'votre entreprise'}`,\r\n        body: `Bonjour ${leadData.name},\r\n\r\nJ'esp\u00E8re que vous allez bien. Je me permets de vous contacter suite \u00E0 votre int\u00E9r\u00EAt pour nos solutions CRM.\r\n\r\nChez 2Thier, nous aidons les entreprises comme ${leadData.company || 'la v\u00F4tre'} \u00E0 optimiser leur gestion commerciale gr\u00E2ce \u00E0 des outils innovants et intuitifs.\r\n\r\n${leadData.industry ? `Ayant une expertise particuli\u00E8re dans le secteur ${leadData.industry}, ` : ''}Je serais ravi de vous pr\u00E9senter comment notre CRM peut r\u00E9pondre \u00E0 vos besoins sp\u00E9cifiques.\r\n\r\nSeriez-vous disponible pour un \u00E9change de 30 minutes la semaine prochaine ?\r\n\r\nCordialement,\r\nL'\u00E9quipe 2Thier CRM\r\n\r\nP.S. : Nous offrons une d\u00E9monstration gratuite et personnalis\u00E9e.`\r\n      },\r\n      followup: {\r\n        subject: `Suivi - D\u00E9monstration CRM pour ${leadData.company || 'votre entreprise'}`,\r\n        body: `Bonjour ${leadData.name},\r\n\r\nJ'esp\u00E8re que vous avez pu consulter notre proposition CRM.\r\n\r\n${leadData.notes ? `Suite \u00E0 nos \u00E9changes concernant ${leadData.notes.substring(0, 50)}..., ` : ''}je souhaitais faire le point avec vous sur vos besoins.\r\n\r\nNotre solution pourrait particuli\u00E8rement vous aider \u00E0 :\r\n\u2022 Automatiser votre suivi commercial\r\n\u2022 Int\u00E9grer vos emails et calendrier\r\n\u2022 Analyser vos performances de vente\r\n\r\nQuand pourriez-vous \u00EAtre disponible pour une d\u00E9monstration personnalis\u00E9e ?\r\n\r\nBien \u00E0 vous,\r\nL'\u00E9quipe 2Thier CRM`\r\n      }\r\n    };\r\n\r\n    const template = emailTemplates[emailType as keyof typeof emailTemplates] || emailTemplates.initial;\r\n    \r\n    return {\r\n      success: true,\r\n      email: {\r\n        subject: template.subject,\r\n        body: template.body,\r\n        tone: 'professionnel'\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateDemoAnalysis(leadData: LeadLike) {\r\n    const qualificationScore = this.calculateQualificationScore(leadData);\r\n    \r\n    return {\r\n      success: true,\r\n      analysis: {\r\n        profil: `${leadData.name} de ${leadData.company || 'une entreprise'} ${leadData.industry ? `dans le secteur ${leadData.industry}` : ''}. Contact via ${leadData.source || 'canal direct'}.`,\r\n        besoins: leadData.notes ? this.extractNeeds(leadData.notes) : 'Besoins \u00E0 clarifier lors du prochain contact',\r\n        opportunites: this.generateOpportunities(leadData),\r\n        actions: this.generateRecommendedActions(leadData, qualificationScore),\r\n        score: qualificationScore\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateDemoProposal(leadData: LeadLike, productData: ProductLike) {\r\n    const proposal = `PROPOSITION COMMERCIALE PERSONNALIS\u00C9E\r\n\r\nDestinataire: ${leadData.name} - ${leadData.company || 'Entreprise'}\r\n\r\n1. INTRODUCTION\r\nNous avons le plaisir de vous proposer ${productData.name}, une solution parfaitement adapt\u00E9e \u00E0 vos besoins.\r\n\r\n2. ANALYSE DE VOS BESOINS\r\n${leadData.notes || 'Optimisation de la gestion commerciale et am\u00E9lioration du suivi client.'}\r\n\r\n3. SOLUTION PROPOS\u00C9E\r\n${productData.description}\r\n\r\nAvantages cl\u00E9s :\r\n${Array.isArray(productData.benefits) ? productData.benefits.map((b: string) => `\u2022 ${b}`).join('\\n') : '\u2022 Solution compl\u00E8te et intuitive'}\r\n\r\n4. INVESTISSEMENT\r\n${productData.price || 'Sur devis personnalis\u00E9'}\r\n\r\n5. PROCHAINES \u00C9TAPES\r\n\u2022 D\u00E9monstration personnalis\u00E9e (30 minutes)\r\n\u2022 Configuration selon vos besoins\r\n\u2022 Formation de votre \u00E9quipe\r\n\u2022 Support technique complet\r\n\r\nNous restons \u00E0 votre disposition pour tout compl\u00E9ment d'information.\r\n\r\nCordialement,\r\nL'\u00E9quipe commerciale 2Thier`;\r\n\r\n    return {\r\n      success: true,\r\n      proposal: {\r\n        content: proposal.trim(),\r\n        wordCount: proposal.split(' ').length,\r\n        sections: ['Introduction', 'Analyse besoins', 'Solution', 'Investissement', 'Prochaines \u00E9tapes']\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateDemoSentiment(emailContent: string) {\r\n    const sentiment = this.analyzeSentimentDemo(emailContent);\r\n    \r\n    return {\r\n      success: true,\r\n      sentiment: {\r\n        sentiment: sentiment.type,\r\n        score: sentiment.score,\r\n        emotions: sentiment.emotions,\r\n        urgence: sentiment.urgence,\r\n        recommandations: sentiment.recommandations\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateDemoResponse(emailContent: string, context: EmailCtx) {\r\n    const suggestion = this.generateResponseSuggestion(emailContent, context);\r\n    \r\n    return {\r\n      success: true,\r\n      suggestions: {\r\n        principale: suggestion.main,\r\n        alternatives: suggestion.alternatives,\r\n        objet: suggestion.subject,\r\n        callToAction: suggestion.cta\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDEE0\uFE0F M\u00C9THODES UTILITAIRES DEMO\r\n   */\r\n  \r\n  private calculateQualificationScore(leadData: LeadLike): number {\r\n    let score = 5; // Score de base\r\n    \r\n    if (leadData.email) score += 1;\r\n    if (leadData.phone) score += 1;\r\n    if (leadData.company) score += 1;\r\n    if (leadData.industry) score += 1;\r\n    if (leadData.notes && leadData.notes.length > 50) score += 1;\r\n    if (leadData.status === 'Qualified') score += 2;\r\n    if (leadData.notes && leadData.notes.includes('budget')) score += 1;\r\n    \r\n    return Math.min(score, 10);\r\n  }\r\n\r\n  private extractNeeds(notes: string): string {\r\n    if (notes.toLowerCase().includes('crm')) return 'Solution CRM compl\u00E8te';\r\n    if (notes.toLowerCase().includes('gestion')) return 'Am\u00E9lioration gestion commerciale';\r\n    if (notes.toLowerCase().includes('automatisation')) return 'Automatisation des processus';\r\n    return 'Besoins \u00E0 affiner lors du prochain \u00E9change';\r\n  }\r\n\r\n  private generateOpportunities(leadData: LeadLike): string {\r\n    const opportunities = [];\r\n    \r\n    if (leadData.company) opportunities.push('D\u00E9ploiement \u00E0 l\\'\u00E9chelle de l\\'entreprise');\r\n    if (leadData.industry) opportunities.push(`Expertise sectorielle ${leadData.industry}`);\r\n    if (leadData.notes && leadData.notes.includes('\u00E9quipe')) opportunities.push('Formation \u00E9quipe compl\u00E8te');\r\n    \r\n    return opportunities.length > 0 ? opportunities.join(', ') : 'Potentiel \u00E0 \u00E9valuer';\r\n  }\r\n\r\n  private generateRecommendedActions(leadData: LeadLike, score: number): string {\r\n    if (score >= 8) return 'Proposer d\u00E9monstration imm\u00E9diate, pr\u00E9parer offre commerciale';\r\n    if (score >= 6) return 'Planifier rendez-vous t\u00E9l\u00E9phonique, qualifier les besoins';\r\n    return 'Envoyer informations compl\u00E9mentaires, programmer rappel dans 1 semaine';\r\n  }\r\n\r\n  private analyzeSentimentDemo(emailContent: string) {\r\n    const content = emailContent.toLowerCase();\r\n    \r\n    // Analyse basique du sentiment\r\n    let score = 5;\r\n    let type = 'neutre';\r\n    const emotions: string[] = [];\r\n    let urgence = 'moyenne';\r\n    \r\n    // Sentiment positif\r\n    if (content.includes('merci') || content.includes('int\u00E9ressant') || content.includes('parfait')) {\r\n      score += 2;\r\n      type = 'positif';\r\n      emotions.push('satisfaction');\r\n    }\r\n    \r\n    // Sentiment n\u00E9gatif\r\n    if (content.includes('probl\u00E8me') || content.includes('d\u00E9\u00E7u') || content.includes('pas satisfait')) {\r\n      score -= 2;\r\n      type = 'n\u00E9gatif';\r\n      emotions.push('frustration');\r\n    }\r\n    \r\n    // Urgence\r\n    if (content.includes('urgent') || content.includes('rapidement') || content.includes('d\u00E8s que possible')) {\r\n      urgence = '\u00E9lev\u00E9e';\r\n      emotions.push('urgence');\r\n    }\r\n    \r\n    // Recommandations\r\n    let recommandations = 'R\u00E9ponse standard professionnelle';\r\n    if (type === 'positif') recommandations = 'R\u00E9ponse enthousiaste, proposer prochaine \u00E9tape';\r\n    if (type === 'n\u00E9gatif') recommandations = 'R\u00E9ponse empathique, proposer solution rapide';\r\n    if (urgence === '\u00E9lev\u00E9e') recommandations += ' - R\u00E9pondre dans les 2 heures';\r\n    \r\n    return {\r\n      type,\r\n      score: Math.max(1, Math.min(10, score)),\r\n      emotions,\r\n      urgence,\r\n      recommandations\r\n    };\r\n  }\r\n\r\n  private generateResponseSuggestion(emailContent: string, context: EmailCtx) {\r\n    const isPositive = emailContent.toLowerCase().includes('int\u00E9ressant') || \r\n                      emailContent.toLowerCase().includes('merci');\r\n    \r\n    let main = '';\r\n    if (isPositive) {\r\n      main = `Bonjour,\r\n\r\nMerci pour votre retour positif ! Je suis ravi de voir que notre solution vous int\u00E9resse.\r\n\r\nPour donner suite \u00E0 votre message, je vous propose d'organiser une d\u00E9monstration personnalis\u00E9e qui vous permettra de d\u00E9couvrir concr\u00E8tement les fonctionnalit\u00E9s adapt\u00E9es \u00E0 vos besoins.\r\n\r\nQuelles sont vos disponibilit\u00E9s pour un \u00E9change de 30 minutes cette semaine ?\r\n\r\nCordialement`;\r\n    } else {\r\n      main = `Bonjour,\r\n\r\nMerci pour votre message. Je prends note de vos remarques et vais m'assurer de vous apporter une r\u00E9ponse compl\u00E8te.\r\n\r\n${context.objective || 'Je vous recontacte rapidement'} pour faire le point sur votre situation.\r\n\r\nBien \u00E0 vous`;\r\n    }\r\n\r\n    return {\r\n      main,\r\n      alternatives: [\r\n        'Version courte : Merci pour votre message. Je vous recontacte rapidement.',\r\n        'Version formelle : Nous accusons r\u00E9ception de votre message et vous remercions de votre int\u00E9r\u00EAt.'\r\n      ],\r\n      subject: 'Re: ' + (emailContent.substring(0, 30) + '...'),\r\n      cta: isPositive ? 'Organiser une d\u00E9monstration' : 'Faire le point ensemble'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDE80 M\u00C9THODES POUR L'API GEMINI R\u00C9ELLE\r\n   */\r\n\r\n  private ensureLiveMode() {\r\n    if (!this.genAI) {\r\n      throw new Error('API Gemini non initialis\u00E9e');\r\n    }\r\n  }\r\n\r\n  private getModelInstance(modelName: string): GenerativeModel {\r\n    this.ensureLiveMode();\r\n    const cached = this.modelCache.get(modelName);\r\n    if (cached) {\r\n      return cached;\r\n    }\r\n    const model = this.genAI!.getGenerativeModel({ model: modelName }, { apiVersion: 'v1beta' });\r\n    this.modelCache.set(modelName, model);\r\n    return model;\r\n  }\r\n\r\n  private async callGeminiAPIWithFallbacks(\r\n    prompt: string,\r\n    modelCandidates?: string[]\r\n  ): Promise<{ success: boolean; content?: string; error?: string; modelUsed?: string }> {\r\n    const candidates = (modelCandidates && modelCandidates.length > 0)\r\n      ? modelCandidates\r\n      : [this.primaryModelName, ...this.fallbackModelNames];\r\n\r\n    let lastError: string | undefined;\r\n    for (const candidate of candidates) {\r\n      const result = await this.callGeminiAPIWithRetries(prompt, candidate);\r\n      if (result.success) {\r\n        if (candidate !== this.primaryModelName) {\r\n          console.warn(`\u21AA\uFE0F  [Gemini API] Bascul\u00E9 sur le mod\u00E8le de secours ${candidate}`);\r\n        }\r\n        return result;\r\n      }\r\n      lastError = result.error;\r\n      console.warn(`\u26A0\uFE0F [Gemini API] \u00C9chec avec ${candidate}: ${lastError || 'erreur inconnue'}`);\r\n    }\r\n\r\n    return {\r\n      success: false,\r\n      error: lastError || 'no-model-available',\r\n      modelUsed: candidates[candidates.length - 1]\r\n    };\r\n  }\r\n  \r\n  private async callGeminiAPI(prompt: string, modelName: string): Promise<{ success: boolean; content?: string; error?: string; modelUsed: string }> {\r\n    try {\r\n      if (!this.genAI) {\r\n        return { success: false, error: 'API Gemini non initialis\u00E9e', modelUsed: modelName };\r\n      }\r\n\r\n      const modelToUse = this.getModelInstance(modelName);\r\n      const result = await modelToUse.generateContent(prompt);\r\n      const response = await result.response;\r\n      const text = response.text();\r\n\r\n      console.log(`\u2705 [Gemini API] R\u00E9ponse re\u00E7ue (${modelName})`);\r\n      return { success: true, content: text, modelUsed: modelName };\r\n      \r\n    } catch (error) {\r\n      console.error('\u274C [Gemini API] Erreur:', error);\r\n      return { success: false, error: (error as Error).message, modelUsed: modelName };\r\n    }\r\n  }\r\n\r\n  /** Appel API avec timeout et retries exponentiels (backoff + jitter) */\r\n  private async callGeminiAPIWithRetries(prompt: string, modelName: string): Promise<{ success: boolean; content?: string; error?: string; modelUsed: string }> {\r\n    const attempts = this.maxRetries + 1; // tentative initiale + retries\r\n    for (let i = 0; i < attempts; i++) {\r\n      const timeoutMs = this.baseTimeoutMs + i * this.perAttemptExtraTimeoutMs;\r\n      try {\r\n        const res = await this.withTimeout(this.callGeminiAPI(prompt, modelName), timeoutMs);\r\n        if (res.success) return res;\r\n        // Si erreur non transitoire, on arr\u00EAte\r\n        if (!this.isTransientError(res.error || '')) return res;\r\n        // Sinon retry\r\n      } catch (err) {\r\n        const msg = (err as Error).message || String(err);\r\n        if (!this.isTransientError(msg)) {\r\n          return { success: false, error: msg, modelUsed: modelName };\r\n        }\r\n      }\r\n      // Backoff exponentiel avec jitter\r\n      const base = Math.min(4000, 500 * Math.pow(2, i));\r\n      const jitter = Math.floor(Math.random() * 200);\r\n      await new Promise(r => setTimeout(r, base + jitter));\r\n    }\r\n    return { success: false, error: 'timeout-or-retry-exceeded', modelUsed: modelName };\r\n  }\r\n\r\n  private async withTimeout<T>(p: Promise<T>, ms: number): Promise<T> {\r\n    let timer: NodeJS.Timeout;\r\n    return await Promise.race([\r\n      p,\r\n      new Promise<T>((_, reject) => {\r\n        timer = setTimeout(() => reject(new Error(`ai-timeout-${ms}ms`)), ms);\r\n      })\r\n    ]).finally(() => {\r\n      // @ts-expect-error timer is set in both branches\r\n      if (timer) clearTimeout(timer);\r\n    });\r\n  }\r\n\r\n  private isTransientError(message: string): boolean {\r\n    const m = message.toLowerCase();\r\n    return (\r\n      m.includes('timeout') ||\r\n      m.includes('timed out') ||\r\n      m.includes('etimedout') ||\r\n      m.includes('econnreset') ||\r\n      m.includes('econnrefused') ||\r\n      m.includes('network') ||\r\n      m.includes('fetch failed') ||\r\n      m.includes('503') ||\r\n      m.includes('502') ||\r\n      m.includes('429')\r\n    );\r\n  }\r\n\r\n  /** Expose un statut enrichi pour la route /api/ai/status */\r\n  public getStatus() {\r\n    const now = Date.now();\r\n    const degraded = !!(this.degradedUntil && now < this.degradedUntil);\r\n    return {\r\n      mode: this.isDemoMode ? 'mock' : 'live',\r\n  model: this.primaryModelName,\r\n  fallbackModels: this.fallbackModelNames,\r\n      hasApiKey: !!this.apiKey,\r\n      consecutiveFailures: this.consecutiveFailures,\r\n      lastError: this.lastError,\r\n      lastSuccessAt: this.lastSuccessAt?.toISOString() || null,\r\n      degraded,\r\n  degradedUntil: degraded && this.degradedUntil ? new Date(this.degradedUntil).toISOString() : null\r\n    };\r\n  }\r\n\r\n  private recordFailure(err: string) {\r\n    this.consecutiveFailures += 1;\r\n    this.lastError = err;\r\n    // D\u00E9tection cl\u00E9 invalide -> circuit breaker rapide\r\n    const isKeyInvalid = /API key not valid|API_KEY_INVALID|permission|unauthorized|401|403/i.test(err);\r\n    if (isKeyInvalid) {\r\n      // Paliers exponentiels simples\r\n      let penaltyMinutes = 1;\r\n      if (this.consecutiveFailures >= 3) penaltyMinutes = 5;\r\n      if (this.consecutiveFailures >= 5) penaltyMinutes = 15;\r\n      if (this.consecutiveFailures >= 7) penaltyMinutes = 60;\r\n      this.degradedUntil = Date.now() + penaltyMinutes * 60_000;\r\n    } else if (this.consecutiveFailures >= 4) {\r\n      // Autres erreurs persistantes => courte pause 2-5 min selon charge\r\n      const minutes = this.consecutiveFailures >= 6 ? 5 : 2;\r\n      this.degradedUntil = Date.now() + minutes * 60_000;\r\n    }\r\n  }\r\n\r\n  private recordSuccess() {\r\n    this.consecutiveFailures = 0;\r\n    this.lastError = null;\r\n    this.lastSuccessAt = new Date();\r\n    this.degradedUntil = null;\r\n  }\r\n\r\n  private buildEmailPrompt(leadData: LeadLike, emailType: string): string {\r\n    const company = leadData.company || 'votre entreprise';\r\n    const name = leadData.name || 'Monsieur/Madame';\r\n    const sector = leadData.sector || 'votre secteur d\\'activit\u00E9';\r\n    const service = leadData.service || 'nos services';\r\n\r\n    return `G\u00E9n\u00E8re un email professionnel ${emailType} pour un prospect dans le CRM.\r\n\r\nCONTEXTE:\r\n- Nom: ${name}\r\n- Entreprise: ${company}\r\n- Secteur: ${sector}\r\n- Service d'int\u00E9r\u00EAt: ${service}\r\n- Type d'email: ${emailType}\r\n\r\nINSTRUCTIONS:\r\n1. Cr\u00E9e un email personnalis\u00E9 et professionnel\r\n2. Adapte le ton au type d'email (${emailType})\r\n3. Mentionne les besoins sp\u00E9cifiques du secteur\r\n4. Inclus un appel \u00E0 l'action clair\r\n5. R\u00E9ponds au format JSON: {\"subject\": \"...\", \"body\": \"...\", \"tone\": \"...\"}\r\n\r\nL'email doit \u00EAtre en fran\u00E7ais et adapt\u00E9 au march\u00E9 belge.`;\r\n  }\r\n\r\n  private parseEmailResponse(content: string): { subject: string; body: string; tone: string } {\r\n    try {\r\n      // Tenter de parser le JSON de la r\u00E9ponse\r\n      const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        return JSON.parse(jsonMatch[0]);\r\n      }\r\n      \r\n      // Fallback: extraire manuellement\r\n      return {\r\n        subject: this.extractFromContent(content, 'subject', 'Sujet g\u00E9n\u00E9r\u00E9 par IA'),\r\n        body: this.extractFromContent(content, 'body', content.substring(0, 500)),\r\n        tone: this.extractFromContent(content, 'tone', 'professionnel')\r\n      };\r\n    } catch (error) {\r\n      console.warn('\u26A0\uFE0F Erreur parsing r\u00E9ponse Gemini:', error);\r\n      return {\r\n        subject: 'Email g\u00E9n\u00E9r\u00E9 par IA',\r\n        body: content,\r\n        tone: 'professionnel'\r\n      };\r\n    }\r\n  }\r\n\r\n  private extractFromContent(content: string, field: string, defaultValue: string): string {\r\n    const regex = new RegExp(`\"${field}\"\\\\s*:\\\\s*\"([^\"]*)\"`, 'i');\r\n    const match = content.match(regex);\r\n    return match ? match[1] : defaultValue;\r\n  }\r\n}\r\n\r\nexport default GoogleGeminiService;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation.js';\r\nimport telnyxApi from '../api/telnyx.js';\r\n\r\nconst router = Router();\r\n\r\n// Appliquer l'authentification et l'usurpation \u00E0 toutes les routes Telnyx\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\n\r\n// Toutes les routes Telnyx\r\nrouter.use('/', telnyxApi);\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { z } from 'zod';\r\nimport axios from 'axios';\r\nimport { AuthenticatedRequest } from '../middlewares/auth';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Configuration Telnyx\r\nconst TELNYX_API_URL = 'https://api.telnyx.com/v2';\r\n\r\n// Fonction pour r\u00E9cup\u00E9rer les headers Telnyx avec la cl\u00E9 API de l'organisation\r\nasync function getTelnyxHeaders(organizationId: string) {\r\n  try {\r\n    console.log('\uD83D\uDD0D [Telnyx] getTelnyxHeaders appel\u00E9 pour organization:', organizationId);\r\n    \r\n    // TODO: R\u00E9cup\u00E9rer la cl\u00E9 API depuis la base de donn\u00E9es\r\n    // Pour l'instant, utiliser la variable d'environnement comme fallback\r\n    const apiKey = process.env.TELNYX_API_KEY;\r\n    console.log('\uD83D\uDD11 [Telnyx] API Key from env:', apiKey ? `${apiKey.substring(0, 10)}...` : 'UNDEFINED');\r\n    \r\n    if (!apiKey) {\r\n      console.warn('\u26A0\uFE0F [Telnyx] Aucune API Key configur\u00E9e - process.env.TELNYX_API_KEY est undefined');\r\n      return null;\r\n    }\r\n    \r\n    const headers = {\r\n      'Authorization': `Bearer ${apiKey}`,\r\n      'Content-Type': 'application/json'\r\n    };\r\n    \r\n    console.log('\u2705 [Telnyx] Headers g\u00E9n\u00E9r\u00E9s avec succ\u00E8s');\r\n    return headers;\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx] Erreur r\u00E9cup\u00E9ration headers:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Schemas de validation\r\nconst makeCallSchema = z.object({\r\n  to: z.string().min(1),\r\n  from: z.string().min(1),\r\n  connection_id: z.string().optional(),\r\n  lead_id: z.string().optional(),\r\n  webhook_url: z.string().url().optional()\r\n});\r\n\r\nconst sendMessageSchema = z.object({\r\n  to: z.string().min(1),\r\n  from: z.string().min(1),\r\n  text: z.string().min(1).max(1600),\r\n  type: z.enum(['SMS', 'MMS']).default('SMS'),\r\n  lead_id: z.string().optional(),\r\n  media_urls: z.array(z.string().url()).optional()\r\n});\r\n\r\nconst purchaseNumberSchema = z.object({\r\n  country: z.string().length(2),\r\n  type: z.enum(['local', 'toll-free', 'national', 'mobile']),\r\n  area_code: z.string().optional()\r\n});\r\n\r\n// Interfaces TypeScript pour Telnyx API\r\ninterface TelnyxConnectionResponse {\r\n  id: string;\r\n  connection_name?: string;\r\n  active: boolean;\r\n  outbound?: { type: string };\r\n  webhook_event_url?: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\ninterface TelnyxPhoneNumberResponse {\r\n  id: string;\r\n  phone_number: string;\r\n  status: string;\r\n  country_code: string;\r\n  phone_number_type: string;\r\n  features?: string[];\r\n  monthly_recurring_cost?: string;\r\n  connection_id?: string;\r\n  purchased_at: string;\r\n}\r\n\r\ninterface TelnyxCallUpdateData {\r\n  status?: string;\r\n  startedAt?: Date;\r\n  endedAt?: Date;\r\n  duration?: number;\r\n  updatedAt: Date;\r\n}\r\n\r\n// --- CONNEXIONS ---\r\nrouter.get('/connections', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    console.log('\uD83D\uDD0D [Telnyx API] R\u00E9cup\u00E9ration des connexions...');\r\n    \r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('[Telnyx API] organizationId:', organizationId);\r\n    \r\n    // R\u00E9cup\u00E9rer les headers avec API Key\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(500).json({ \r\n        error: 'Configuration Telnyx manquante. Veuillez configurer votre API Key.' \r\n      });\r\n    }\r\n    \r\n    // R\u00E9cup\u00E9rer depuis Telnyx\r\n    const response = await axios.get(`${TELNYX_API_URL}/connections`, {\r\n      headers\r\n    });\r\n\r\n    const connections = response.data.data.map((conn: TelnyxConnectionResponse) => ({\r\n      id: conn.id,\r\n      name: conn.connection_name || `Connection ${conn.id.substring(0, 8)}`,\r\n      status: conn.active ? 'active' : 'inactive',\r\n      type: conn.outbound?.type || 'voice',\r\n      webhook_url: conn.webhook_event_url,\r\n      created_at: conn.created_at,\r\n      updated_at: conn.updated_at\r\n    }));\r\n\r\n    // Sauvegarder en base\r\n    for (const conn of connections) {\r\n      await prisma.telnyxConnection.upsert({\r\n        where: { id: conn.id },\r\n        update: {\r\n          name: conn.name,\r\n          status: conn.status,\r\n          type: conn.type,\r\n          webhookUrl: conn.webhook_url,\r\n          updatedAt: new Date()\r\n        },\r\n        create: {\r\n          id: conn.id,\r\n          name: conn.name,\r\n          status: conn.status,\r\n          type: conn.type,\r\n          webhookUrl: conn.webhook_url,\r\n          organizationId: organizationId,\r\n          createdAt: new Date(conn.created_at),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(`\u2705 [Telnyx API] ${connections.length} connexions synchronis\u00E9es`);\r\n    res.json(connections);\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur connexions:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des connexions' });\r\n  }\r\n});\r\n\r\n// --- NUM\u00C9ROS DE T\u00C9L\u00C9PHONE ---\r\nrouter.get('/phone-numbers', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    console.log('\uD83D\uDD0D [Telnyx API] R\u00E9cup\u00E9ration des num\u00E9ros...');\r\n    \r\n    const organizationId = req.user!.organizationId!;\r\n    \r\n    // R\u00E9cup\u00E9rer les headers avec API Key\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(500).json({ \r\n        error: 'Configuration Telnyx manquante. Veuillez configurer votre API Key.' \r\n      });\r\n    }\r\n    \r\n    const response = await axios.get(`${TELNYX_API_URL}/phone_numbers`, {\r\n      headers,\r\n      params: { 'page[size]': 250 }\r\n    });\r\n\r\n    const phoneNumbers = response.data.data.map((number: TelnyxPhoneNumberResponse) => ({\r\n      id: number.id,\r\n      phone_number: number.phone_number,\r\n      status: number.status,\r\n      country_code: number.country_code,\r\n      number_type: number.phone_number_type,\r\n      features: number.features || [],\r\n      monthly_cost: parseFloat(number.monthly_recurring_cost || '0'),\r\n      connection_id: number.connection_id,\r\n      purchased_at: number.purchased_at\r\n    }));\r\n\r\n    // Sauvegarder en base\r\n    for (const number of phoneNumbers) {\r\n      await prisma.telnyxPhoneNumber.upsert({\r\n        where: { id: number.id },\r\n        update: {\r\n          phoneNumber: number.phone_number,\r\n          status: number.status,\r\n          countryCode: number.country_code,\r\n          numberType: number.number_type,\r\n          features: number.features,\r\n          monthlyCost: number.monthly_cost,\r\n          connectionId: number.connection_id,\r\n          updatedAt: new Date()\r\n        },\r\n        create: {\r\n          id: number.id,\r\n          phoneNumber: number.phone_number,\r\n          status: number.status,\r\n          countryCode: number.country_code,\r\n          numberType: number.number_type,\r\n          features: number.features,\r\n          monthlyCost: number.monthly_cost,\r\n          connectionId: number.connection_id,\r\n          organizationId: organizationId,\r\n          purchasedAt: new Date(number.purchased_at),\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(`\u2705 [Telnyx API] ${phoneNumbers.length} num\u00E9ros synchronis\u00E9s`);\r\n    res.json(phoneNumbers);\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur num\u00E9ros:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des num\u00E9ros' });\r\n  }\r\n});\r\n\r\nrouter.post('/phone-numbers/purchase', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const data = purchaseNumberSchema.parse(req.body);\r\n    console.log('\uD83D\uDED2 [Telnyx API] Achat de num\u00E9ro:', data);\r\n\r\n    const headers = await getTelnyxHeaders(req.user.organizationId);\r\n    if (!headers) {\r\n      return res.status(401).json({ error: 'Non autoris\u00E9' });\r\n    }\r\n\r\n    // Rechercher des num\u00E9ros disponibles\r\n    const searchResponse = await axios.get(`${TELNYX_API_URL}/available_phone_numbers`, {\r\n      headers,\r\n      params: {\r\n        'filter[country_code]': data.country,\r\n        'filter[phone_number_type]': data.type,\r\n        'filter[area_code]': data.area_code,\r\n        'page[size]': 10\r\n      }\r\n    });\r\n\r\n    if (!searchResponse.data.data.length) {\r\n      return res.status(404).json({ error: 'Aucun num\u00E9ro disponible avec ces crit\u00E8res' });\r\n    }\r\n\r\n    // Acheter le premier num\u00E9ro disponible\r\n    const availableNumber = searchResponse.data.data[0];\r\n    const purchaseResponse = await axios.post(`${TELNYX_API_URL}/phone_number_orders`, {\r\n      phone_numbers: [{ phone_number: availableNumber.phone_number }]\r\n    }, { headers });\r\n\r\n    console.log('\u2705 [Telnyx API] Num\u00E9ro achet\u00E9:', availableNumber.phone_number);\r\n    res.json({ \r\n      success: true, \r\n      phone_number: availableNumber.phone_number,\r\n      order_id: purchaseResponse.data.data.id \r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur achat num\u00E9ro:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'achat du num\u00E9ro' });\r\n  }\r\n});\r\n\r\n// --- APPELS ---\r\nrouter.get('/calls', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const limit = parseInt(req.query.limit as string) || 50;\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log(`\uD83D\uDD0D [Telnyx API] R\u00E9cup\u00E9ration des appels (${limit})...`);\r\n    \r\n    const calls = await prisma.telnyxCall.findMany({\r\n      where: { organizationId: organizationId },\r\n      orderBy: { startedAt: 'desc' },\r\n      take: limit\r\n    });\r\n\r\n    const formattedCalls = calls.map(call => ({\r\n      id: call.id,\r\n      call_id: call.callId,\r\n      from: call.fromNumber,\r\n      to: call.toNumber,\r\n      direction: call.direction,\r\n      status: call.status,\r\n      duration: call.duration || 0,\r\n      cost: call.cost || 0,\r\n      started_at: call.startedAt.toISOString(),\r\n      ended_at: call.endedAt?.toISOString(),\r\n      recording_url: call.recordingUrl,\r\n      lead_id: call.leadId\r\n    }));\r\n\r\n    console.log(`\u2705 [Telnyx API] ${formattedCalls.length} appels r\u00E9cup\u00E9r\u00E9s`);\r\n    res.json(formattedCalls);\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur r\u00E9cup\u00E9ration appels:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des appels' });\r\n  }\r\n});\r\n\r\nrouter.post('/calls', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const data = makeCallSchema.parse(req.body);\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('\uD83D\uDCDE [Telnyx API] Initiation appel:', data);\r\n\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(401).json({ error: 'Non autoris\u00E9' });\r\n    }\r\n\r\n    // Appel \u00E0 l'API Telnyx\r\n    const response = await axios.post(`${TELNYX_API_URL}/calls`, {\r\n      to: data.to,\r\n      from: data.from,\r\n      connection_id: data.connection_id,\r\n      webhook_url: data.webhook_url,\r\n      command_id: `call-${Date.now()}`\r\n    }, { headers });\r\n\r\n    const callData = response.data.data;\r\n\r\n    // Sauvegarder en base\r\n    const call = await prisma.telnyxCall.create({\r\n      data: {\r\n        id: `call-${Date.now()}`,\r\n        callId: callData.call_control_id,\r\n        fromNumber: data.from,\r\n        toNumber: data.to,\r\n        direction: 'outbound',\r\n        status: 'in-progress',\r\n        organizationId: organizationId,\r\n        leadId: data.lead_id,\r\n        startedAt: new Date(),\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 [Telnyx API] Appel initi\u00E9:', call.callId);\r\n    res.json({\r\n      id: call.id,\r\n      call_id: call.callId,\r\n      from: call.fromNumber,\r\n      to: call.toNumber,\r\n      status: call.status\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur initiation appel:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'initiation de l\\'appel' });\r\n  }\r\n});\r\n\r\nrouter.post('/calls/:callId/hangup', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const { callId } = req.params;\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('\u260E\uFE0F [Telnyx API] Raccrocher appel:', callId);\r\n\r\n    // Rechercher l'appel en base\r\n    const call = await prisma.telnyxCall.findFirst({\r\n      where: { \r\n        callId: callId,\r\n        organizationId: organizationId\r\n      }\r\n    });\r\n\r\n    if (!call) {\r\n      return res.status(404).json({ error: 'Appel non trouv\u00E9' });\r\n    }\r\n\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(401).json({ error: 'Non autoris\u00E9' });\r\n    }\r\n\r\n    // Raccrocher via Telnyx\r\n    await axios.post(`${TELNYX_API_URL}/calls/${callId}/actions/hangup`, {}, {\r\n      headers\r\n    });\r\n\r\n    // Mettre \u00E0 jour en base\r\n    await prisma.telnyxCall.update({\r\n      where: { id: call.id },\r\n      data: {\r\n        status: 'completed',\r\n        endedAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 [Telnyx API] Appel raccroch\u00E9:', callId);\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur raccrocher:', error);\r\n    res.status(500).json({ error: 'Erreur lors du raccrochage' });\r\n  }\r\n});\r\n\r\nrouter.post('/calls/:callId/mute', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const { callId } = req.params;\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('\uD83D\uDD07 [Telnyx API] Couper micro:', callId);\r\n\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(401).json({ error: 'Non autoris\u00E9' });\r\n    }\r\n\r\n    await axios.post(`${TELNYX_API_URL}/calls/${callId}/actions/mute`, {}, {\r\n      headers\r\n    });\r\n\r\n    console.log('\u2705 [Telnyx API] Micro coup\u00E9:', callId);\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur mute:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la coupure du micro' });\r\n  }\r\n});\r\n\r\nrouter.post('/calls/:callId/unmute', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const { callId } = req.params;\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('\uD83D\uDD0A [Telnyx API] Activer micro:', callId);\r\n\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(401).json({ error: 'Non autoris\u00E9' });\r\n    }\r\n\r\n    await axios.post(`${TELNYX_API_URL}/calls/${callId}/actions/unmute`, {}, {\r\n      headers\r\n    });\r\n\r\n    console.log('\u2705 [Telnyx API] Micro activ\u00E9:', callId);\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur unmute:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'activation du micro' });\r\n  }\r\n});\r\n\r\n// --- MESSAGES ---\r\nrouter.get('/messages', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const limit = parseInt(req.query.limit as string) || 50;\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log(`\uD83D\uDD0D [Telnyx API] R\u00E9cup\u00E9ration des messages (${limit})...`);\r\n    \r\n    const messages = await prisma.telnyxMessage.findMany({\r\n      where: { organizationId: organizationId },\r\n      orderBy: { sentAt: 'desc' },\r\n      take: limit\r\n    });\r\n\r\n    const formattedMessages = messages.map(msg => ({\r\n      id: msg.id,\r\n      message_id: msg.messageId,\r\n      from: msg.fromNumber,\r\n      to: msg.toNumber,\r\n      direction: msg.direction,\r\n      type: msg.type,\r\n      text: msg.text,\r\n      status: msg.status,\r\n      cost: msg.cost || 0,\r\n      sent_at: msg.sentAt.toISOString(),\r\n      delivered_at: msg.deliveredAt?.toISOString(),\r\n      media_urls: msg.mediaUrls || [],\r\n      lead_id: msg.leadId\r\n    }));\r\n\r\n    console.log(`\u2705 [Telnyx API] ${formattedMessages.length} messages r\u00E9cup\u00E9r\u00E9s`);\r\n    res.json(formattedMessages);\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur r\u00E9cup\u00E9ration messages:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des messages' });\r\n  }\r\n});\r\n\r\nrouter.post('/messages', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const data = sendMessageSchema.parse(req.body);\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('\uD83D\uDCAC [Telnyx API] Envoi message:', data);\r\n\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(401).json({ error: 'Non autoris\u00E9' });\r\n    }\r\n\r\n    // Envoi via Telnyx\r\n    const response = await axios.post(`${TELNYX_API_URL}/messages`, {\r\n      to: data.to,\r\n      from: data.from,\r\n      text: data.text,\r\n      type: data.type,\r\n      media_urls: data.media_urls,\r\n      webhook_url: `${process.env.APP_URL}/api/telnyx/webhooks/messages`\r\n    }, { headers });\r\n\r\n    const messageData = response.data.data;\r\n\r\n    // Sauvegarder en base\r\n    const message = await prisma.telnyxMessage.create({\r\n      data: {\r\n        id: `msg-${Date.now()}`,\r\n        messageId: messageData.id,\r\n        fromNumber: data.from,\r\n        toNumber: data.to,\r\n        direction: 'outbound',\r\n        type: data.type,\r\n        text: data.text,\r\n        status: 'sent',\r\n        organizationId: organizationId,\r\n        leadId: data.lead_id,\r\n        mediaUrls: data.media_urls || [],\r\n        sentAt: new Date(),\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 [Telnyx API] Message envoy\u00E9:', message.messageId);\r\n    res.json({\r\n      id: message.id,\r\n      message_id: message.messageId,\r\n      status: message.status\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur envoi message:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'envoi du message' });\r\n  }\r\n});\r\n\r\n// --- WEBHOOKS ---\r\nrouter.post('/webhooks/calls', async (req: Request, res: Response) => {\r\n  try {\r\n    const webhook = req.body;\r\n    console.log('\uD83E\uDE9D [Telnyx Webhook] Appel:', webhook.data?.event_type);\r\n\r\n    const callData = webhook.data?.payload;\r\n    if (!callData) {\r\n      return res.json({ received: true });\r\n    }\r\n\r\n    // Mettre \u00E0 jour l'appel en base\r\n    const call = await prisma.telnyxCall.findFirst({\r\n      where: { callId: callData.call_control_id }\r\n    });\r\n\r\n    if (call) {\r\n      const updateData: TelnyxCallUpdateData = {\r\n        status: callData.state || call.status,\r\n        updatedAt: new Date()\r\n      };\r\n\r\n      if (callData.state === 'bridged') {\r\n        updateData.startedAt = new Date();\r\n      } else if (['hangup', 'completed'].includes(callData.state)) {\r\n        updateData.endedAt = new Date();\r\n        updateData.duration = callData.hangup_duration_millis ? \r\n          Math.floor(callData.hangup_duration_millis / 1000) : 0;\r\n      }\r\n\r\n      await prisma.telnyxCall.update({\r\n        where: { id: call.id },\r\n        data: updateData\r\n      });\r\n\r\n      console.log(`\u2705 [Telnyx Webhook] Appel mis \u00E0 jour: ${call.callId} -> ${callData.state}`);\r\n    }\r\n\r\n    res.json({ received: true });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx Webhook] Erreur appel:', error);\r\n    res.status(500).json({ error: 'Erreur webhook appel' });\r\n  }\r\n});\r\n\r\nrouter.post('/webhooks/messages', async (req: Request, res: Response) => {\r\n  try {\r\n    const webhook = req.body;\r\n    console.log('\uD83E\uDE9D [Telnyx Webhook] Message:', webhook.data?.event_type);\r\n\r\n    const messageData = webhook.data?.payload;\r\n    if (!messageData) {\r\n      return res.json({ received: true });\r\n    }\r\n\r\n    // Traiter selon le type d'\u00E9v\u00E9nement\r\n    const eventType = webhook.data.event_type;\r\n    \r\n    if (eventType === 'message.received') {\r\n      // Message entrant\r\n      await prisma.telnyxMessage.create({\r\n        data: {\r\n          id: `msg-${Date.now()}`,\r\n          messageId: messageData.id,\r\n          fromNumber: messageData.from.phone_number,\r\n          toNumber: messageData.to[0].phone_number,\r\n          direction: 'inbound',\r\n          type: messageData.type,\r\n          text: messageData.text,\r\n          status: 'delivered',\r\n          organizationId: 'default', // TODO: d\u00E9terminer l'organisation\r\n          sentAt: new Date(messageData.received_at),\r\n          deliveredAt: new Date(),\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n\r\n      console.log('\u2705 [Telnyx Webhook] Message entrant sauvegard\u00E9:', messageData.id);\r\n    } else if (eventType === 'message.sent') {\r\n      // Mettre \u00E0 jour le statut du message sortant\r\n      const message = await prisma.telnyxMessage.findFirst({\r\n        where: { messageId: messageData.id }\r\n      });\r\n\r\n      if (message) {\r\n        await prisma.telnyxMessage.update({\r\n          where: { id: message.id },\r\n          data: {\r\n            status: 'delivered',\r\n            deliveredAt: new Date(),\r\n            updatedAt: new Date()\r\n          }\r\n        });\r\n\r\n        console.log('\u2705 [Telnyx Webhook] Message livr\u00E9:', messageData.id);\r\n      }\r\n    }\r\n\r\n    res.json({ received: true });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx Webhook] Erreur message:', error);\r\n    res.status(500).json({ error: 'Erreur webhook message' });\r\n  }\r\n});\r\n\r\n// --- SYNCHRONISATION ---\r\nrouter.post('/sync', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    console.log('\uD83D\uDD04 [Telnyx API] Synchronisation compl\u00E8te...');\r\n    \r\n    const organizationId = req.user!.organizationId!;\r\n\r\n    // R\u00E9cup\u00E9rer les headers avec API Key\r\n    const headers = await getTelnyxHeaders(organizationId);\r\n    if (!headers) {\r\n      return res.status(500).json({ \r\n        error: 'Configuration Telnyx manquante. Veuillez configurer votre API Key.' \r\n      });\r\n    }\r\n\r\n    // Synchroniser toutes les donn\u00E9es\r\n    const [connectionsRes, numbersRes] = await Promise.all([\r\n      axios.get(`${TELNYX_API_URL}/connections`, { headers }),\r\n      axios.get(`${TELNYX_API_URL}/phone_numbers`, { \r\n        headers,\r\n        params: { 'page[size]': 250 }\r\n      })\r\n    ]);\r\n\r\n    // Mettre \u00E0 jour les connexions\r\n    for (const conn of connectionsRes.data.data) {\r\n      await prisma.telnyxConnection.upsert({\r\n        where: { id: conn.id },\r\n        update: {\r\n          name: conn.connection_name || `Connection ${conn.id.substring(0, 8)}`,\r\n          status: conn.active ? 'active' : 'inactive',\r\n          type: conn.outbound?.type || 'voice',\r\n          webhookUrl: conn.webhook_event_url,\r\n          updatedAt: new Date()\r\n        },\r\n        create: {\r\n          id: conn.id,\r\n          name: conn.connection_name || `Connection ${conn.id.substring(0, 8)}`,\r\n          status: conn.active ? 'active' : 'inactive',\r\n          type: conn.outbound?.type || 'voice',\r\n          webhookUrl: conn.webhook_event_url,\r\n          organizationId: organizationId,\r\n          createdAt: new Date(conn.created_at),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    // Mettre \u00E0 jour les num\u00E9ros\r\n    for (const number of numbersRes.data.data) {\r\n      await prisma.telnyxPhoneNumber.upsert({\r\n        where: { id: number.id },\r\n        update: {\r\n          phoneNumber: number.phone_number,\r\n          status: number.status,\r\n          countryCode: number.country_code,\r\n          numberType: number.phone_number_type,\r\n          features: number.features || [],\r\n          monthlyCost: parseFloat(number.monthly_recurring_cost || '0'),\r\n          connectionId: number.connection_id,\r\n          updatedAt: new Date()\r\n        },\r\n        create: {\r\n          id: number.id,\r\n          phoneNumber: number.phone_number,\r\n          status: number.status,\r\n          countryCode: number.country_code,\r\n          numberType: number.phone_number_type,\r\n          features: number.features || [],\r\n          monthlyCost: parseFloat(number.monthly_recurring_cost || '0'),\r\n          connectionId: number.connection_id,\r\n          organizationId: organizationId,\r\n          purchasedAt: new Date(number.purchased_at),\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('\u2705 [Telnyx API] Synchronisation termin\u00E9e');\r\n    res.json({ \r\n      success: true,\r\n      connections: connectionsRes.data.data.length,\r\n      numbers: numbersRes.data.data.length\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur synchronisation:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la synchronisation' });\r\n  }\r\n});\r\n\r\n// --- CONFIGURATION ORGANISATION ---\r\nrouter.post('/config', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const { api_key, webhook_url, default_connection, organizationId } = req.body;\r\n    const userOrgId = req.user!.organizationId!;\r\n    \r\n    console.log('\u2699\uFE0F [Telnyx API] Configuration organisation:', { organizationId: organizationId || userOrgId, hasApiKey: !!api_key });\r\n\r\n    // Utiliser l'organization de l'utilisateur connect\u00E9 si pas sp\u00E9cifi\u00E9e\r\n    const targetOrgId = organizationId || userOrgId;\r\n\r\n    // Sauvegarder en base (vous devrez cr\u00E9er une table TelnyxConfig)\r\n    // Pour l'instant, on sauvegarde dans les variables d'environnement ou une table de config\r\n    \r\n    // R\u00E9ponse de succ\u00E8s\r\n    res.json({ \r\n      success: true,\r\n      message: 'Configuration Telnyx sauvegard\u00E9e',\r\n      organization: targetOrgId\r\n    });\r\n\r\n    console.log('\u2705 [Telnyx API] Configuration sauvegard\u00E9e pour:', targetOrgId);\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur sauvegarde configuration:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la sauvegarde de la configuration' });\r\n  }\r\n});\r\n\r\n// --- CONFIGURATION UTILISATEUR ---\r\nrouter.post('/user-config', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const { userId, assignedNumber, canMakeCalls, canSendSms, monthlyLimit } = req.body;\r\n    const organizationId = req.user!.organizationId!;\r\n\r\n    console.log('\u2699\uFE0F [Telnyx API] Configuration utilisateur:', { userId, assignedNumber });\r\n\r\n    // Cr\u00E9er ou mettre \u00E0 jour la configuration utilisateur Telnyx\r\n    const userConfig = await prisma.telnyxUserConfig.upsert({\r\n      where: { userId: userId },\r\n      update: {\r\n        assignedNumber,\r\n        canMakeCalls: canMakeCalls || false,\r\n        canSendSms: canSendSms || false,\r\n        monthlyLimit: monthlyLimit ? parseFloat(monthlyLimit) : null,\r\n        updatedAt: new Date()\r\n      },\r\n      create: {\r\n        userId,\r\n        organizationId,\r\n        assignedNumber,\r\n        canMakeCalls: canMakeCalls || false,\r\n        canSendSms: canSendSms || false,\r\n        monthlyLimit: monthlyLimit ? parseFloat(monthlyLimit) : null,\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    // Si un num\u00E9ro est assign\u00E9, le marquer comme utilis\u00E9\r\n    if (assignedNumber) {\r\n      await prisma.telnyxPhoneNumber.updateMany({\r\n        where: { \r\n          phoneNumber: assignedNumber,\r\n          organizationId: organizationId \r\n        },\r\n        data: { \r\n          assignedUserId: userId,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n      \r\n      // Lib\u00E9rer les autres num\u00E9ros de cet utilisateur\r\n      await prisma.telnyxPhoneNumber.updateMany({\r\n        where: { \r\n          assignedUserId: userId,\r\n          phoneNumber: { not: assignedNumber },\r\n          organizationId: organizationId \r\n        },\r\n        data: { \r\n          assignedUserId: null,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    } else {\r\n      // Lib\u00E9rer tous les num\u00E9ros de cet utilisateur\r\n      await prisma.telnyxPhoneNumber.updateMany({\r\n        where: { \r\n          assignedUserId: userId,\r\n          organizationId: organizationId \r\n        },\r\n        data: { \r\n          assignedUserId: null,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('\u2705 [Telnyx API] Configuration utilisateur sauvegard\u00E9e');\r\n    res.json({ success: true, config: userConfig });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur config utilisateur:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la sauvegarde de la configuration' });\r\n  }\r\n});\r\n\r\nrouter.get('/user-config/:userId', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const { userId } = req.params;\r\n    const organizationId = req.user!.organizationId!;\r\n\r\n    console.log('\uD83D\uDD0D [Telnyx API] R\u00E9cup\u00E9ration config utilisateur:', userId);\r\n\r\n    const userConfig = await prisma.telnyxUserConfig.findFirst({\r\n      where: { \r\n        userId: userId,\r\n        organizationId: organizationId \r\n      }\r\n    });\r\n\r\n    res.json(userConfig || {\r\n      userId,\r\n      organizationId,\r\n      canMakeCalls: false,\r\n      canSendSms: false,\r\n      assignedNumber: null,\r\n      monthlyLimit: null\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur r\u00E9cup\u00E9ration config:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration de la configuration' });\r\n  }\r\n});\r\n\r\nrouter.get('/stats', async (req: AuthenticatedRequest, res: Response) => {\r\n  try {\r\n    const organizationId = req.user!.organizationId!;\r\n    console.log('\uD83D\uDCCA [Telnyx API] R\u00E9cup\u00E9ration statistiques...');\r\n\r\n    const [totalCalls, totalSms, activeNumbers] = await Promise.all([\r\n      prisma.telnyxCall.count({\r\n        where: { \r\n          organizationId: organizationId,\r\n          startedAt: { gte: new Date(new Date().getFullYear(), new Date().getMonth(), 1) }\r\n        }\r\n      }),\r\n      prisma.telnyxMessage.count({\r\n        where: { \r\n          organizationId: organizationId,\r\n          createdAt: { gte: new Date(new Date().getFullYear(), new Date().getMonth(), 1) }\r\n        }\r\n      }),\r\n      prisma.telnyxPhoneNumber.count({\r\n        where: { \r\n          organizationId: organizationId,\r\n          status: 'active'\r\n        }\r\n      })\r\n    ]);\r\n\r\n    // Calculer le co\u00FBt mensuel (approximatif)\r\n    const calls = await prisma.telnyxCall.findMany({\r\n      where: { \r\n        organizationId: organizationId,\r\n        startedAt: { gte: new Date(new Date().getFullYear(), new Date().getMonth(), 1) }\r\n      },\r\n      select: { cost: true }\r\n    });\r\n\r\n    const numbers = await prisma.telnyxPhoneNumber.findMany({\r\n      where: { \r\n        organizationId: organizationId,\r\n        status: 'active'\r\n      },\r\n      select: { monthlyCost: true }\r\n    });\r\n\r\n    const callsCost = calls.reduce((sum, call) => sum + (call.cost || 0), 0);\r\n    const numbersCost = numbers.reduce((sum, number) => sum + (number.monthlyCost || 0), 0);\r\n    const monthlyCost = callsCost + numbersCost;\r\n\r\n    console.log('\u2705 [Telnyx API] Statistiques r\u00E9cup\u00E9r\u00E9es');\r\n    res.json({\r\n      totalCalls,\r\n      totalSms,\r\n      activeNumbers,\r\n      monthlyCost\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx API] Erreur stats:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques' });\r\n  }\r\n});\r\n\r\n// --- WEBHOOK UNIQUE POUR TOUT ---\r\nrouter.post('/webhooks', async (req: Request, res: Response) => {\r\n  try {\r\n    const webhook = req.body;\r\n    const eventType = webhook.data?.event_type;\r\n    \r\n    console.log('\uD83E\uDE9D [Telnyx Webhook Unique]', eventType, webhook.data?.payload?.call_control_id || webhook.data?.payload?.id);\r\n\r\n    // Gestion des \u00E9v\u00E9nements d'appel\r\n    if (eventType?.startsWith('call.')) {\r\n      const callData = webhook.data?.payload;\r\n      if (callData) {\r\n        const call = await prisma.telnyxCall.findFirst({\r\n          where: { callId: callData.call_control_id }\r\n        });\r\n\r\n        if (call) {\r\n          const updateData: TelnyxCallUpdateData = {\r\n            status: callData.state || call.status,\r\n            updatedAt: new Date()\r\n          };\r\n\r\n          if (callData.state === 'bridged') {\r\n            updateData.startedAt = new Date();\r\n          } else if (['hangup', 'completed'].includes(callData.state)) {\r\n            updateData.endedAt = new Date();\r\n            updateData.duration = callData.hangup_duration_millis ? \r\n              Math.floor(callData.hangup_duration_millis / 1000) : 0;\r\n          }\r\n\r\n          await prisma.telnyxCall.update({\r\n            where: { id: call.id },\r\n            data: updateData\r\n          });\r\n\r\n          console.log(`\u2705 [Telnyx Webhook] Appel mis \u00E0 jour: ${call.callId} -> ${callData.state}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Gestion des \u00E9v\u00E9nements de message\r\n    else if (eventType?.startsWith('message.')) {\r\n      const messageData = webhook.data?.payload;\r\n      if (messageData) {\r\n        if (eventType === 'message.received') {\r\n          // Message entrant\r\n          await prisma.telnyxMessage.create({\r\n            data: {\r\n              id: `msg-${Date.now()}`,\r\n              messageId: messageData.id,\r\n              fromNumber: messageData.from.phone_number,\r\n              toNumber: messageData.to[0].phone_number,\r\n              direction: 'inbound',\r\n              type: messageData.type,\r\n              text: messageData.text,\r\n              status: 'delivered',\r\n              organizationId: 'default',\r\n              sentAt: new Date(messageData.received_at),\r\n              deliveredAt: new Date(),\r\n              createdAt: new Date(),\r\n              updatedAt: new Date()\r\n            }\r\n          });\r\n\r\n          console.log('\u2705 [Telnyx Webhook] Message entrant sauvegard\u00E9:', messageData.id);\r\n        } else if (eventType === 'message.sent') {\r\n          // Mettre \u00E0 jour le statut du message sortant\r\n          const message = await prisma.telnyxMessage.findFirst({\r\n            where: { messageId: messageData.id }\r\n          });\r\n\r\n          if (message) {\r\n            await prisma.telnyxMessage.update({\r\n              where: { id: message.id },\r\n              data: {\r\n                status: 'delivered',\r\n                deliveredAt: new Date(),\r\n                updatedAt: new Date()\r\n              }\r\n            });\r\n\r\n            console.log('\u2705 [Telnyx Webhook] Message sortant mis \u00E0 jour:', messageData.id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    else {\r\n      console.log('\uD83E\uDE9D [Telnyx Webhook] \u00C9v\u00E9nement non g\u00E9r\u00E9:', eventType);\r\n    }\r\n\r\n    res.json({ received: true });\r\n  } catch (error) {\r\n    console.error('\u274C [Telnyx Webhook] Erreur:', error);\r\n    res.status(500).json({ error: 'Erreur webhook' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\n\r\n// Enum temporaire pour les devis\r\nenum QuoteStatus {\r\n  DRAFT = 'DRAFT',\r\n  SENT = 'SENT',\r\n  ACCEPTED = 'ACCEPTED',\r\n  REJECTED = 'REJECTED',\r\n  CANCELLED = 'CANCELLED',\r\n  EXPIRED = 'EXPIRED'\r\n}\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Appliquer l'auth \u00E0 toutes les routes\r\nrouter.use(authMiddleware);\r\n\r\n// Utils\r\nconst allowedTransitions: Record<QuoteStatus, QuoteStatus[]> = {\r\n  [QuoteStatus.DRAFT]: [QuoteStatus.SENT, QuoteStatus.CANCELLED],\r\n  [QuoteStatus.SENT]: [QuoteStatus.ACCEPTED, QuoteStatus.REJECTED, QuoteStatus.CANCELLED, QuoteStatus.EXPIRED],\r\n  [QuoteStatus.ACCEPTED]: [],\r\n  [QuoteStatus.REJECTED]: [],\r\n  [QuoteStatus.CANCELLED]: [],\r\n  [QuoteStatus.EXPIRED]: [],\r\n};\r\n\r\nfunction canTransition(from: QuoteStatus, to: QuoteStatus) {\r\n  return allowedTransitions[from]?.includes(to) ?? false;\r\n}\r\n\r\n// G\u00E9n\u00E9rateur tr\u00E8s simple de num\u00E9ro de devis (non bloquant, unique par timestamp)\r\nfunction generateQuoteNumber() {\r\n  const d = new Date();\r\n  const y = d.getFullYear();\r\n  const m = String(d.getMonth() + 1).padStart(2, '0');\r\n  const seq = Math.floor(Math.random() * 9000 + 1000); // 4 chiffres\r\n  return `Q-${y}${m}-${seq}`;\r\n}\r\n\r\n// Calcul des totaux c\u00F4t\u00E9 serveur\r\nexport type IncomingItem = {\r\n  id?: string;\r\n  order: number;\r\n  label: string;\r\n  description?: string;\r\n  quantity: number;\r\n  unitPrice: number;\r\n  discountPct?: number; // 0-100\r\n  taxPct?: number; // 0-100\r\n};\r\n\r\nfunction computeItemTotals(item: IncomingItem) {\r\n  const qty = Math.max(0, Number(item.quantity) || 0);\r\n  const price = Math.max(0, Number(item.unitPrice) || 0);\r\n  const discount = Math.min(100, Math.max(0, Number(item.discountPct ?? 0)));\r\n  const tax = Math.min(100, Math.max(0, Number(item.taxPct ?? 21)));\r\n\r\n  const lineExclBeforeDiscount = qty * price;\r\n  const lineExcl = round4(lineExclBeforeDiscount * (1 - discount / 100));\r\n  const lineTax = round4(lineExcl * (tax / 100));\r\n  const lineIncl = round4(lineExcl + lineTax);\r\n\r\n  return { totalExcl: lineExcl, totalIncl: lineIncl };\r\n}\r\n\r\nfunction aggregateTotals(items: IncomingItem[]) {\r\n  let subtotalExcl = 0;\r\n  let totalIncl = 0;\r\n  for (const it of items) {\r\n    const { totalExcl, totalIncl: lineIncl } = computeItemTotals(it);\r\n    subtotalExcl += totalExcl;\r\n    totalIncl += lineIncl;\r\n  }\r\n  const totalTax = round4(totalIncl - subtotalExcl);\r\n  return {\r\n    subtotalExcl: round4(subtotalExcl),\r\n    totalTax: round4(totalTax),\r\n    totalIncl: round4(totalIncl),\r\n  };\r\n}\r\n\r\nfunction round4(n: number) {\r\n  return Math.round((n + Number.EPSILON) * 10000) / 10000;\r\n}\r\n\r\nfunction toDecimal(value: number) {\r\n  // Passer en string pour s\u00E9curiser la pr\u00E9cision c\u00F4t\u00E9 Prisma.Decimal\r\n  return new Prisma.Decimal(value.toString());\r\n}\r\n\r\n// GET /api/quotes?leadId=...&status=...&page=1&pageSize=20\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const { leadId, status, page = '1', pageSize = '20' } = req.query as Record<string, string>;\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n    }\r\n\r\n    const where: Prisma.QuoteWhereInput = {\r\n      organizationId,\r\n      ...(leadId ? { leadId } : {}),\r\n      ...(status ? { status: status as QuoteStatus } : {}),\r\n    };\r\n\r\n    const pageNum = Math.max(1, parseInt(String(page), 10) || 1);\r\n    const sizeNum = Math.min(100, Math.max(1, parseInt(String(pageSize), 10) || 20));\r\n\r\n    const [total, data] = await Promise.all([\r\n      prisma.quote.count({ where }),\r\n      prisma.quote.findMany({\r\n        where,\r\n        orderBy: [{ updatedAt: 'desc' }],\r\n        skip: (pageNum - 1) * sizeNum,\r\n        take: sizeNum,\r\n        include: {\r\n          documents: {\r\n            orderBy: { createdAt: 'desc' },\r\n            take: 1,\r\n          },\r\n        },\r\n      }),\r\n    ]);\r\n\r\n    res.json({ success: true, total, page: pageNum, pageSize: sizeNum, data });\r\n  } catch (e) {\r\n    console.error('[QUOTES] GET list error', e);\r\n    res.status(500).json({ success: false, error: 'Erreur lors du chargement des devis' });\r\n  }\r\n});\r\n\r\n// GET /api/quotes/:id\r\nrouter.get('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n\r\n    const quote = await prisma.quote.findFirst({\r\n      where: { id, organizationId },\r\n      include: {\r\n        items: { orderBy: { order: 'asc' } },\r\n        documents: { orderBy: { createdAt: 'desc' }, take: 5 },\r\n      },\r\n    });\r\n    if (!quote) return res.status(404).json({ error: 'Devis introuvable' });\r\n    res.json(quote);\r\n  } catch (e) {\r\n    console.error('[QUOTES] GET detail error', e);\r\n    res.status(500).json({ error: 'Erreur lors du chargement du devis' });\r\n  }\r\n});\r\n\r\n// POST /api/quotes\r\nrouter.post('/', async (req, res) => {\r\n  try {\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n\r\n    const { leadId, blockId, title, currency = 'EUR', validUntil, notes, data } = req.body as {\r\n      leadId: string; blockId: string; title?: string; currency?: string; validUntil?: string; notes?: string; data?: unknown;\r\n    };\r\n\r\n    if (!leadId || !blockId) return res.status(400).json({ error: 'leadId et blockId requis' });\r\n\r\n    // V\u00E9rifier lead appartenant \u00E0 l\u2019organisation\r\n    const lead = await prisma.lead.findFirst({ where: { id: leadId, organizationId } });\r\n    if (!lead) return res.status(404).json({ error: 'Lead non trouv\u00E9 ou non autoris\u00E9' });\r\n\r\n    const created = await prisma.quote.create({\r\n      data: {\r\n        organizationId,\r\n        leadId,\r\n        blockId,\r\n        createdById: user?.userId ?? null,\r\n        number: generateQuoteNumber(),\r\n        status: QuoteStatus.DRAFT,\r\n        title: title ?? null,\r\n        version: 1,\r\n        currency,\r\n        validUntil: validUntil ? new Date(validUntil) : null,\r\n        notes: notes ?? null,\r\n        data: data ?? {},\r\n        totals: {},\r\n      },\r\n    });\r\n\r\n    res.status(201).json(created);\r\n  } catch (e) {\r\n    console.error('[QUOTES] POST create error', e);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation du devis' });\r\n  }\r\n});\r\n\r\n// PATCH /api/quotes/:id\r\nrouter.patch('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n\r\n    const existing = await prisma.quote.findFirst({ where: { id, organizationId } });\r\n    if (!existing) return res.status(404).json({ error: 'Devis introuvable' });\r\n\r\n    const { title, notes, currency, validUntil, status } = req.body as Partial<{ title: string; notes: string; currency: string; validUntil: string; status: QuoteStatus }>;\r\n\r\n    const data: Prisma.QuoteUpdateInput = {};\r\n    if (title !== undefined) data.title = title;\r\n    if (notes !== undefined) data.notes = notes;\r\n    if (currency !== undefined) data.currency = currency;\r\n    if (validUntil !== undefined) data.validUntil = validUntil ? new Date(validUntil) : null;\r\n\r\n    if (status && status !== existing.status) {\r\n      const from = existing.status as QuoteStatus;\r\n      const to = status as QuoteStatus;\r\n      if (!canTransition(from, to)) {\r\n        return res.status(400).json({ error: `Transition de statut interdite: ${from} -> ${to}` });\r\n      }\r\n      data.status = to;\r\n    }\r\n\r\n    const updated = await prisma.quote.update({ where: { id }, data });\r\n    res.json(updated);\r\n  } catch (e) {\r\n    console.error('[QUOTES] PATCH update error', e);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00E0 jour du devis' });\r\n  }\r\n});\r\n\r\n// DELETE /api/quotes/:id -> soft delete en CANCELLED\r\nrouter.delete('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n\r\n    const existing = await prisma.quote.findFirst({ where: { id, organizationId } });\r\n    if (!existing) return res.status(404).json({ error: 'Devis introuvable' });\r\n\r\n    await prisma.quote.update({ where: { id }, data: { status: QuoteStatus.CANCELLED } });\r\n    res.status(204).send();\r\n  } catch (e) {\r\n    console.error('[QUOTES] DELETE error', e);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'annulation du devis' });\r\n  }\r\n});\r\n\r\n// POST /api/quotes/:id/items -> bulk upsert ordonn\u00E9 + recalcul totaux\r\nrouter.post('/:id/items', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n\r\n    const existing = await prisma.quote.findFirst({ where: { id, organizationId } });\r\n    if (!existing) return res.status(404).json({ error: 'Devis introuvable' });\r\n\r\n    const items = (req.body?.items || []) as IncomingItem[];\r\n    if (!Array.isArray(items)) return res.status(400).json({ error: 'items doit \u00EAtre un tableau' });\r\n\r\n    // Recalcul et validation\r\n    const prepared = items\r\n      .filter((i) => i && typeof i.label === 'string')\r\n      .map((i) => ({\r\n        ...i,\r\n        quantity: Number(i.quantity) || 0,\r\n        unitPrice: Number(i.unitPrice) || 0,\r\n        discountPct: Number(i.discountPct ?? 0),\r\n        taxPct: Number(i.taxPct ?? 21),\r\n      }))\r\n      .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));\r\n\r\n    const totals = aggregateTotals(prepared);\r\n\r\n    // Transaction: on remplace l'ensemble des lignes pour simplifier et garantir l'ordre\r\n    await prisma.$transaction(async (tx) => {\r\n      await tx.quoteItem.deleteMany({ where: { quoteId: id } });\r\n      for (const it of prepared) {\r\n        const { totalExcl, totalIncl } = computeItemTotals(it);\r\n        await tx.quoteItem.create({\r\n          data: {\r\n            quoteId: id,\r\n            order: it.order ?? 0,\r\n            label: it.label,\r\n            description: it.description ?? null,\r\n            quantity: toDecimal(it.quantity),\r\n            unitPrice: toDecimal(it.unitPrice),\r\n            discountPct: toDecimal(it.discountPct ?? 0),\r\n            taxPct: toDecimal(it.taxPct ?? 21),\r\n            totalExcl: toDecimal(totalExcl),\r\n            totalIncl: toDecimal(totalIncl),\r\n          },\r\n        });\r\n      }\r\n      await tx.quote.update({\r\n        where: { id },\r\n        data: {\r\n          totals: {\r\n            subtotalExcl: totals.subtotalExcl,\r\n            totalTax: totals.totalTax,\r\n            totalIncl: totals.totalIncl,\r\n          },\r\n        },\r\n      });\r\n    });\r\n\r\n    const updated = await prisma.quote.findUnique({\r\n      where: { id },\r\n      include: { items: { orderBy: { order: 'asc' } } },\r\n    });\r\n    res.json({ success: true, quote: updated });\r\n  } catch (e) {\r\n    console.error('[QUOTES] POST items error', e);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00E0 jour des lignes' });\r\n  }\r\n});\r\n\r\n// POST /api/quotes/:id/duplicate\r\nrouter.post('/:id/duplicate', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { user } = req as AuthenticatedRequest;\r\n    const organizationId = user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ error: 'Organisation non sp\u00E9cifi\u00E9e' });\r\n\r\n    const existing = await prisma.quote.findFirst({\r\n      where: { id, organizationId },\r\n      include: { items: true },\r\n    });\r\n    if (!existing) return res.status(404).json({ error: 'Devis introuvable' });\r\n\r\n    const newQuote = await prisma.$transaction(async (tx) => {\r\n      const created = await tx.quote.create({\r\n        data: {\r\n          organizationId,\r\n          leadId: existing.leadId,\r\n          blockId: existing.blockId,\r\n          createdById: user?.userId ?? null,\r\n          number: generateQuoteNumber(),\r\n          status: QuoteStatus.DRAFT,\r\n          title: existing.title ? `${existing.title} (copie)` : null,\r\n          version: 1,\r\n          currency: existing.currency,\r\n          validUntil: existing.validUntil,\r\n          notes: existing.notes,\r\n          data: existing.data,\r\n          totals: existing.totals,\r\n        },\r\n      });\r\n\r\n      // Dupliquer les lignes\r\n      for (const it of existing.items) {\r\n        await tx.quoteItem.create({\r\n          data: {\r\n            quoteId: created.id,\r\n            order: it.order,\r\n            label: it.label,\r\n            description: it.description,\r\n            quantity: it.quantity,\r\n            unitPrice: it.unitPrice,\r\n            discountPct: it.discountPct,\r\n            taxPct: it.taxPct,\r\n            totalExcl: it.totalExcl,\r\n            totalIncl: it.totalIncl,\r\n          },\r\n        });\r\n      }\r\n\r\n      return created;\r\n    });\r\n\r\n    res.status(201).json(newQuote);\r\n  } catch (e) {\r\n    console.error('[QUOTES] duplicate error', e);\r\n    res.status(500).json({ error: 'Erreur lors de la duplication du devis' });\r\n  }\r\n});\r\n\r\n// Phase 2: g\u00E9n\u00E9ration document -> stub pour l'instant\r\nrouter.post('/:id/generate-document', (_req, res) => {\r\n  return res.status(501).json({ error: 'G\u00E9n\u00E9ration de document non encore impl\u00E9ment\u00E9e (Phase 2)' });\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\n\r\nconst router = Router();\r\n\r\n// Routes Google Drive\r\nrouter.get('/files', authMiddleware, async (req, res) => {\r\n  try {\r\n    // TODO: Impl\u00E9menter l'int\u00E9gration Google Drive\r\n    res.json({ \r\n      files: [],\r\n      message: 'Google Drive integration \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur Google Drive:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des fichiers Drive' });\r\n  }\r\n});\r\n\r\nrouter.post('/files/create', authMiddleware, async (req, res) => {\r\n  try {\r\n    const { name, mimeType } = req.body;\r\n    \r\n    // TODO: Impl\u00E9menter la cr\u00E9ation de fichiers Google Drive\r\n    res.json({ \r\n      id: 'temp-file-id',\r\n      name,\r\n      mimeType,\r\n      message: 'Cr\u00E9ation Google Drive \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur cr\u00E9ation Google Drive:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation du fichier Drive' });\r\n  }\r\n});\r\n\r\nrouter.delete('/files/:fileId', authMiddleware, async (req, res) => {\r\n  try {\r\n    const { fileId } = req.params;\r\n    \r\n    // TODO: Impl\u00E9menter la suppression de fichiers Google Drive\r\n    res.json({ \r\n      success: true,\r\n      fileId,\r\n      message: 'Suppression Google Drive \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur suppression Google Drive:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression du fichier Drive' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth.js';\r\n\r\nconst router = Router();\r\n\r\n// Routes Google Meet\r\nrouter.get('/meetings', authMiddleware, async (req, res) => {\r\n  try {\r\n    // TODO: Impl\u00E9menter l'int\u00E9gration Google Meet\r\n    res.json({ \r\n      meetings: [],\r\n      message: 'Google Meet integration \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur Google Meet:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des r\u00E9unions Meet' });\r\n  }\r\n});\r\n\r\nrouter.get('/analytics', authMiddleware, async (req, res) => {\r\n  try {\r\n    // TODO: Impl\u00E9menter les analytics Google Meet\r\n    res.json({ \r\n      analytics: {},\r\n      message: 'Analytics Google Meet \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur analytics Google Meet:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des analytics Meet' });\r\n  }\r\n});\r\n\r\nrouter.post('/meetings', authMiddleware, async (req, res) => {\r\n  try {\r\n    const meetingData = req.body;\r\n    \r\n    // TODO: Impl\u00E9menter la cr\u00E9ation de r\u00E9unions Google Meet\r\n    res.json({ \r\n      id: 'temp-meeting-id',\r\n      ...meetingData,\r\n      message: 'Cr\u00E9ation Google Meet \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur cr\u00E9ation Google Meet:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation de la r\u00E9union Meet' });\r\n  }\r\n});\r\n\r\nrouter.post('/join/:meetingCode', authMiddleware, async (req, res) => {\r\n  try {\r\n    const { meetingCode } = req.params;\r\n    \r\n    // TODO: Impl\u00E9menter la jointure de r\u00E9unions Google Meet\r\n    res.json({ \r\n      success: true,\r\n      meetingCode,\r\n      message: 'Jointure Google Meet \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur jointure Google Meet:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la jointure \u00E0 la r\u00E9union Meet' });\r\n  }\r\n});\r\n\r\nrouter.post('/instant', authMiddleware, async (req, res) => {\r\n  try {\r\n    // TODO: Impl\u00E9menter les r\u00E9unions instantan\u00E9es Google Meet\r\n    res.json({ \r\n      meetingId: 'temp-instant-meeting-id',\r\n      url: 'https://meet.google.com/temp-url',\r\n      message: 'R\u00E9union instantan\u00E9e Google Meet \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur r\u00E9union instantan\u00E9e Google Meet:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation de la r\u00E9union instantan\u00E9e Meet' });\r\n  }\r\n});\r\n\r\nrouter.delete('/meetings/:meetingId', authMiddleware, async (req, res) => {\r\n  try {\r\n    const { meetingId } = req.params;\r\n    \r\n    // TODO: Impl\u00E9menter la suppression de r\u00E9unions Google Meet\r\n    res.json({ \r\n      success: true,\r\n      meetingId,\r\n      message: 'Suppression Google Meet \u00E0 impl\u00E9menter'\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur suppression Google Meet:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de la r\u00E9union Meet' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 TYPES ANALYTICS\r\ninterface DateFilter {\r\n  gte?: Date;\r\n  lte?: Date;\r\n}\r\n\r\ninterface WhereClause {\r\n  organizationId?: string;\r\n  userId?: string;\r\n  action?: { contains: string };\r\n}\r\n\r\ninterface ExportData {\r\n  [key: string]: string | number | Date | null;\r\n}\r\n\r\n// \uD83D\uDE80 RATE LIMITING ANALYTICS\r\nconst analyticsRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 100, // 100 requ\u00EAtes par minute\r\n  message: { success: false, message: 'Trop de requ\u00EAtes analytics' }\r\n});\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(analyticsRateLimit);\r\n\r\n// \uD83D\uDCCA GET /api/analytics/dashboard - M\u00E9triques tableau de bord\r\nrouter.get('/dashboard', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ANALYTICS] \uD83D\uDCCA G\u00E9n\u00E9ration m\u00E9triques dashboard');\r\n  \r\n  try {\r\n    const requestingUser = req.user;\r\n    const { startDate, endDate } = req.query;\r\n    \r\n    const dateFilter = {\r\n      ...(startDate && { gte: new Date(startDate as string) }),\r\n      ...(endDate && { lte: new Date(endDate as string) })\r\n    };\r\n\r\n    let metrics;\r\n    \r\n    if (requestingUser?.role === 'super_admin') {\r\n      // \uD83D\uDC51 SUPER ADMIN : M\u00E9triques globales\r\n      const [totalUsers, totalOrganizations, activeModules, totalLeads] = await Promise.all([\r\n        prisma.user.count({ where: { createdAt: dateFilter } }),\r\n        prisma.organization.count({ where: { createdAt: dateFilter } }),\r\n        prisma.organizationModuleStatus.count({ where: { active: true } }),\r\n        prisma.lead?.count({ where: { createdAt: dateFilter } }) || 0\r\n      ]);\r\n\r\n      metrics = {\r\n        totalUsers,\r\n        totalOrganizations,\r\n        activeModules,\r\n        totalLeads,\r\n        growth: {\r\n          users: await calculateGrowth('user', dateFilter),\r\n          organizations: await calculateGrowth('organization', dateFilter)\r\n        }\r\n      };\r\n    } else {\r\n      // \uD83C\uDFE2 ORGANISATION : M\u00E9triques locales\r\n      const orgId = requestingUser.organizationId;\r\n      const [orgUsers, orgModules, orgLeads] = await Promise.all([\r\n        prisma.userOrganization.count({ \r\n          where: { organizationId: orgId, createdAt: dateFilter } \r\n        }),\r\n        prisma.organizationModuleStatus.count({ \r\n          where: { organizationId: orgId, active: true } \r\n        }),\r\n        prisma.lead?.count({ \r\n          where: { organizationId: orgId, createdAt: dateFilter } \r\n        }) || 0\r\n      ]);\r\n\r\n      metrics = {\r\n        users: orgUsers,\r\n        activeModules: orgModules,\r\n        leads: orgLeads,\r\n        conversion: await calculateConversionRate(orgId, dateFilter)\r\n      };\r\n    }\r\n\r\n    res.json({ success: true, data: metrics });\r\n  } catch (error) {\r\n    console.error('[ANALYTICS] Erreur m\u00E9triques dashboard:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur g\u00E9n\u00E9ration m\u00E9triques' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC8 GET /api/analytics/export - Export donn\u00E9es CSV/Excel\r\nrouter.get('/export', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ANALYTICS] \uD83D\uDCC8 Export donn\u00E9es');\r\n  \r\n  try {\r\n    const { format = 'csv', type = 'users' } = req.query;\r\n    const requestingUser = req.user;\r\n    \r\n    let data;\r\n    let filename;\r\n\r\n    switch (type) {\r\n      case 'users':\r\n        data = await exportUsers(requestingUser);\r\n        filename = `users_export_${new Date().toISOString().split('T')[0]}.${format}`;\r\n        break;\r\n      case 'organizations':\r\n        if (requestingUser?.role !== 'super_admin') {\r\n          return res.status(403).json({ success: false, message: 'Super admin requis' });\r\n        }\r\n        data = await exportOrganizations();\r\n        filename = `organizations_export_${new Date().toISOString().split('T')[0]}.${format}`;\r\n        break;\r\n      default:\r\n        return res.status(400).json({ success: false, message: 'Type export invalide' });\r\n    }\r\n\r\n    if (format === 'csv') {\r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\r\n      res.send(convertToCSV(data));\r\n    } else {\r\n      res.json({ success: true, data, filename });\r\n    }\r\n  } catch (error) {\r\n    console.error('[ANALYTICS] Erreur export:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur export donn\u00E9es' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCCB GET /api/analytics/audit-trail - Journal d'audit\r\nrouter.get('/audit-trail', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  console.log('[ANALYTICS] \uD83D\uDCCB R\u00E9cup\u00E9ration audit trail');\r\n  \r\n  try {\r\n    const { page = 1, limit = 50, userId, action } = req.query;\r\n    const requestingUser = req.user;\r\n    \r\n    const whereClause: WhereClause = {};\r\n    \r\n    if (requestingUser?.role !== 'super_admin' && requestingUser?.organizationId) {\r\n      // Non-super admin : seulement son organisation\r\n      whereClause.organizationId = requestingUser.organizationId;\r\n    }\r\n    \r\n    if (userId) whereClause.userId = userId as string;\r\n    if (action) whereClause.action = { contains: action as string };\r\n\r\n    const [auditLogs, total] = await Promise.all([\r\n      prisma.auditLog?.findMany({\r\n        where: whereClause,\r\n        include: {\r\n          User: { select: { firstName: true, lastName: true, email: true } }\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        skip: (Number(page) - 1) * Number(limit),\r\n        take: Number(limit)\r\n      }) || [],\r\n      prisma.auditLog?.count({ where: whereClause }) || 0\r\n    ]);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: auditLogs,\r\n      pagination: {\r\n        page: Number(page),\r\n        limit: Number(limit),\r\n        total,\r\n        pages: Math.ceil(total / Number(limit))\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('[ANALYTICS] Erreur audit trail:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur r\u00E9cup\u00E9ration audit' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDD27 UTILITAIRES ANALYTICS\r\nasync function calculateGrowth(model: string, dateFilter: DateFilter) {\r\n  try {\r\n    const currentPeriod = await (model === 'user' ? prisma.user : prisma.organization).count({\r\n      where: { createdAt: dateFilter }\r\n    });\r\n    \r\n    const previousPeriod = await (model === 'user' ? prisma.user : prisma.organization).count({\r\n      where: {\r\n        createdAt: {\r\n          gte: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000), // 60 jours avant\r\n          lte: dateFilter.gte\r\n        }\r\n      }\r\n    });\r\n\r\n    return previousPeriod > 0 ? \r\n      Math.round(((currentPeriod - previousPeriod) / previousPeriod) * 100) : \r\n      0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\nasync function calculateConversionRate(organizationId: string, dateFilter: DateFilter) {\r\n  try {\r\n    const [totalLeads, convertedLeads] = await Promise.all([\r\n      prisma.lead?.count({\r\n        where: { organizationId, createdAt: dateFilter }\r\n      }) || 0,\r\n      prisma.lead?.count({\r\n        where: { \r\n          organizationId, \r\n          status: 'converted',\r\n          createdAt: dateFilter \r\n        }\r\n      }) || 0\r\n    ]);\r\n\r\n    return totalLeads > 0 ? Math.round((convertedLeads / totalLeads) * 100) : 0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\nasync function exportUsers(requestingUser: { role?: string; organizationId?: string }) {\r\n  const whereClause = requestingUser?.role === 'super_admin' \r\n    ? {} \r\n    : { organizationId: requestingUser.organizationId };\r\n\r\n  return prisma.user.findMany({\r\n    where: whereClause,\r\n    select: {\r\n      firstName: true,\r\n      lastName: true,\r\n      email: true,\r\n      role: true,\r\n      createdAt: true,\r\n      UserOrganization: {\r\n        select: {\r\n          Organization: { select: { name: true } }\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nasync function exportOrganizations() {\r\n  return prisma.organization.findMany({\r\n    select: {\r\n      name: true,\r\n      status: true,\r\n      createdAt: true,\r\n      _count: {\r\n        select: {\r\n          UserOrganization: true,\r\n          OrganizationModuleStatus: { where: { active: true } }\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nfunction convertToCSV(data: ExportData[]): string {\r\n  if (!data.length) return '';\r\n  \r\n  const headers = Object.keys(data[0]).join(',');\r\n  const rows = data.map(row => \r\n    Object.values(row).map(value => \r\n      typeof value === 'string' ? `\"${value}\"` : value\r\n    ).join(',')\r\n  );\r\n  \r\n  return [headers, ...rows].join('\\n');\r\n}\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83E\uDD16 ROUTES API INTELLIGENCE ARTIFICIELLE\r\n * Routes pour l'assistant IA vocal et les recommandations intelligentes\r\n */\r\n\r\nimport express from 'express';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth';\r\nimport GoogleGeminiService from '../services/GoogleGeminiService';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { randomUUID } from 'crypto';\r\n\r\n// Instance unique r\u00E9utilisable (\u00E9vite recr\u00E9ations co\u00FBteuses)\r\nconst geminiSingleton = new GoogleGeminiService();\r\nconst prisma = new PrismaClient();\r\n\r\nconst router = express.Router();\r\n\r\n// Middleware d'authentification pour toutes les routes IA\r\nrouter.use(authMiddleware);\r\n\r\n// ------------------------ Logging usage IA (non destructif) ------------------------\r\nlet aiUsageTableEnsured: Promise<void> | null = null;\r\nasync function ensureAiUsageLogTable() {\r\n  if (!aiUsageTableEnsured) {\r\n    aiUsageTableEnsured = (async () => {\r\n      try {\r\n        // Cr\u00E9ation pr\u00E9ventive si la migration n'a pas \u00E9t\u00E9 appliqu\u00E9e (non destructive)\r\n        // On cr\u00E9e la table avec le sch\u00E9ma correspondant au mod\u00E8le Prisma (si migrations non appliqu\u00E9es)\r\n        await prisma.$executeRawUnsafe(`CREATE TABLE IF NOT EXISTS \"AiUsageLog\" (\r\n          id TEXT PRIMARY KEY,\r\n          \"userId\" TEXT NULL,\r\n          \"organizationId\" TEXT NULL,\r\n          type TEXT NOT NULL,\r\n          model TEXT NULL,\r\n          \"tokensPrompt\" INTEGER DEFAULT 0,\r\n          \"tokensOutput\" INTEGER DEFAULT 0,\r\n          \"latencyMs\" INTEGER NULL,\r\n          success BOOLEAN DEFAULT true,\r\n          \"errorCode\" TEXT NULL,\r\n          \"errorMessage\" TEXT NULL,\r\n          meta JSONB NULL,\r\n          \"createdAt\" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\r\n        );`);\r\n        await prisma.$executeRawUnsafe('CREATE INDEX IF NOT EXISTS \"AiUsageLog_userId_idx\" ON \"AiUsageLog\"(\"userId\");');\r\n        await prisma.$executeRawUnsafe('CREATE INDEX IF NOT EXISTS \"AiUsageLog_orgId_idx\" ON \"AiUsageLog\"(\"organizationId\");');\r\n        await prisma.$executeRawUnsafe('CREATE INDEX IF NOT EXISTS \"AiUsageLog_type_idx\" ON \"AiUsageLog\"(type);');\r\n        await prisma.$executeRawUnsafe('CREATE INDEX IF NOT EXISTS \"AiUsageLog_createdAt_idx\" ON \"AiUsageLog\"(\"createdAt\");');\r\n      } catch (e) {\r\n        console.warn('\u26A0\uFE0F Impossible de garantir la table AiUsageLog (continuation sans log):', (e as Error).message);\r\n      }\r\n    })();\r\n  }\r\n  return aiUsageTableEnsured;\r\n}\r\n\r\ninterface AiUsageParams {\r\n  req: express.Request;\r\n  endpoint: string; // Nom interne de la route\r\n  success: boolean;\r\n  latencyMs?: number;\r\n  model?: string | null;\r\n  mode?: string | null; // live/mock/context/analysis\r\n  tokensPrompt?: number | null;\r\n  tokensOutput?: number | null;\r\n  error?: string | null;\r\n  extraMeta?: Record<string, unknown>;\r\n}\r\n\r\nfunction mapEndpointToType(endpoint: string): string {\r\n  switch (endpoint) {\r\n    case 'generate-response':\r\n    case 'chat':\r\n      return 'chat';\r\n    case 'schedule-recommendations':\r\n      return 'schedule_rec';\r\n    case 'schedule-explain':\r\n      return 'schedule_explain';\r\n    case 'analyze-conversation':\r\n      return 'conversation_analysis';\r\n    case 'context-summary':\r\n      return 'context_summary';\r\n    case 'context-lead':\r\n      return 'context_lead';\r\n    case 'context-leads-batch':\r\n      return 'context_leads_batch';\r\n    case 'ultimate-recommendation':\r\n      return 'ultimate_recommendation';\r\n    default:\r\n      return endpoint.replace(/[^a-z0-9_]/gi, '_');\r\n  }\r\n}\r\n\r\nasync function logAiUsage(params: AiUsageParams) {\r\n  try {\r\n    await ensureAiUsageLogTable();\r\n    const authReq = params.req as unknown as AuthenticatedRequest;\r\n    const organizationId = authReq.user?.organizationId || null;\r\n    const userId = authReq.user?.userId || null;\r\n    const type = mapEndpointToType(params.endpoint);\r\n    const meta = {\r\n      endpoint: params.endpoint,\r\n      mode: params.mode,\r\n      rawError: params.error,\r\n      tokensOutputRaw: params.tokensOutput,\r\n      ...(params.extraMeta || {})\r\n    };\r\n    await prisma.aiUsageLog?.create?.({\r\n      data: {\r\n        id: randomUUID(),\r\n        organizationId: organizationId || undefined,\r\n        userId: userId || undefined,\r\n        type,\r\n        model: params.model || undefined,\r\n        tokensPrompt: params.tokensPrompt ?? undefined,\r\n        tokensOutput: params.tokensOutput ?? undefined,\r\n        latencyMs: params.latencyMs,\r\n        success: params.success,\r\n        errorCode: params.error ? 'ERR_AI' : undefined,\r\n        errorMessage: params.error || undefined,\r\n        meta\r\n      }\r\n    }).catch(async () => {\r\n      // Fallback SQL brut\r\n      await prisma.$executeRawUnsafe(\r\n        'INSERT INTO \"AiUsageLog\" (id, \"userId\", \"organizationId\", type, model, \"tokensPrompt\", \"tokensOutput\", \"latencyMs\", success, \"errorCode\", \"errorMessage\", meta) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12);',\r\n        randomUUID(), userId, organizationId, type, params.model, params.tokensPrompt || 0, params.tokensOutput || 0, params.latencyMs || null, params.success, params.error ? 'ERR_AI' : null, params.error || null, JSON.stringify(meta)\r\n      );\r\n    });\r\n  } catch (e) {\r\n    // Ne jamais interrompre la r\u00E9ponse utilisateur pour un probl\u00E8me de log\r\n    console.warn('\u26A0\uFE0F Log AI usage \u00E9chou\u00E9:', (e as Error).message);\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83E\uDD16 POST /api/ai/analyze-section\r\n * Analyse une section de site web et propose des optimisations\r\n */\r\nrouter.post('/analyze-section', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    const { sectionType, content, prompt } = req.body;\r\n    \r\n    console.log('\uD83C\uDFA8 [AI] Analyse section:', sectionType);\r\n    console.log('\uD83D\uDCDD [AI] Contenu longueur:', JSON.stringify(content).length, 'caract\u00E8res');\r\n    \r\n    // Construire le prompt pour Gemini\r\n    const analysisPrompt = prompt || buildSectionAnalysisPrompt(sectionType, content);\r\n    \r\n    // Appel service Gemini\r\n    const serviceResp = await geminiSingleton.chat({ prompt: analysisPrompt });\r\n    const isLive = serviceResp.mode === 'live';\r\n    \r\n    // Si mode mock, g\u00E9n\u00E9rer une r\u00E9ponse simul\u00E9e\r\n    const analysis = isLive ? parseSectionAnalysis(serviceResp.content) : generateMockSectionAnalysis(sectionType, content);\r\n    \r\n    const latency = Date.now() - t0;\r\n    res.json({\r\n      success: true,\r\n      data: analysis,\r\n      metadata: {\r\n        mode: serviceResp.mode,\r\n        model: isLive ? (process.env.GEMINI_MODEL || 'gemini-1.5-flash') : 'mock',\r\n        latencyMs: latency,\r\n        fallbackError: serviceResp.error\r\n      }\r\n    });\r\n    \r\n    void logAiUsage({ \r\n      req, \r\n      endpoint: 'analyze-section', \r\n      success: true, \r\n      latencyMs: latency, \r\n      model: isLive ? (process.env.GEMINI_MODEL || 'gemini-1.5-flash') : 'mock', \r\n      mode: serviceResp.mode,\r\n      error: serviceResp.error ? String(serviceResp.error) : null\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C Erreur route analyze-section:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'analyse de la section',\r\n      details: (error as Error).message\r\n    });\r\n    void logAiUsage({ \r\n      req, \r\n      endpoint: 'analyze-section', \r\n      success: false, \r\n      latencyMs: Date.now() - t0, \r\n      model: null, \r\n      mode: null, \r\n      error: (error as Error).message \r\n    });\r\n  }\r\n});\r\n\r\n// Helper: Construire le prompt d'analyse de section\r\nfunction buildSectionAnalysisPrompt(sectionType: string, content: any): string {\r\n  // D\u00E9terminer les champs sp\u00E9cifiques selon le type de section\r\n  const sectionTypeGuide = getSectionTypeGuide(sectionType);\r\n  \r\n  return `Tu es un expert en UX/UI et design web sp\u00E9cialis\u00E9 dans les sites de transition \u00E9nerg\u00E9tique.\r\n\r\n\uD83C\uDFAF **IMPORTANT : Analyse UNIQUEMENT cette section isol\u00E9e, PAS le site complet.**\r\n\r\n**Type de section \u00E0 analyser :** ${sectionType}\r\n${sectionTypeGuide}\r\n\r\n**Contenu actuel de CETTE section :**\r\n${JSON.stringify(content, null, 2).slice(0, 3000)}\r\n\r\n**Ta mission :**\r\n1. Analyser UNIQUEMENT les \u00E9l\u00E9ments pr\u00E9sents dans cette section sp\u00E9cifique\r\n2. Proposer des am\u00E9liorations CONCR\u00C8TES pour cette section\r\n3. Ne PAS faire de suggestions globales sur le site\r\n4. Se concentrer sur ce qui est modifiable dans CETTE section\r\n\r\n**Format de r\u00E9ponse (JSON uniquement) :**\r\n{\r\n  \"score\": <nombre entre 0 et 100 pour CETTE section>,\r\n  \"suggestions\": [\r\n    {\r\n      \"id\": \"<id unique ex: ${sectionType}-suggestion-1>\",\r\n      \"category\": \"<layout|design|content|ux>\",\r\n      \"type\": \"<improvement|warning|best-practice>\",\r\n      \"title\": \"<titre court et actionnable>\",\r\n      \"description\": \"<explication d\u00E9taill\u00E9e SP\u00C9CIFIQUE \u00E0 cette section>\",\r\n      \"impact\": \"<low|medium|high>\",\r\n      \"changes\": { \r\n        \"<nomDuChamp>\": \"<valeurPropos\u00E9e>\",\r\n        \"// Exemple: title\": \"Nouveau titre optimis\u00E9\",\r\n        \"// Exemple: backgroundColor\": \"#10b981\"\r\n      },\r\n      \"preview\": {\r\n        \"before\": \"<valeur actuelle dans CETTE section>\",\r\n        \"after\": \"<valeur propos\u00E9e pour CETTE section>\"\r\n      }\r\n    }\r\n  ],\r\n  \"summary\": {\r\n    \"strengths\": [\"<point fort de CETTE section>\"],\r\n    \"weaknesses\": [\"<faiblesse de CETTE section>\"],\r\n    \"opportunities\": [\"<am\u00E9lioration possible dans CETTE section>\"]\r\n  }\r\n}\r\n\r\n**Crit\u00E8res d'analyse pour CETTE section :**\r\n- \uD83D\uDCD0 **LAYOUT**: disposition des \u00E9l\u00E9ments dans cette section, grille, espacement interne\r\n- \uD83C\uDFA8 **DESIGN**: couleurs utilis\u00E9es ici, typographie de cette section, contraste\r\n- \uD83D\uDCDD **CONTENU**: textes pr\u00E9sents dans cette section, CTA de cette section\r\n- \u26A1 **UX**: navigation dans cette section, hi\u00E9rarchie visuelle interne\r\n\r\n**Exemples de suggestions VALIDES (sp\u00E9cifiques \u00E0 la section) :**\r\n\u2705 \"Le titre de cette section manque de contraste - passer de #666666 \u00E0 #1f2937\"\r\n\u2705 \"Le CTA de cette section est peu visible - augmenter la taille du bouton\"\r\n\u2705 \"L'espacement entre le titre et la description est trop serr\u00E9 - passer \u00E0 24px\"\r\n\r\n**Exemples de suggestions INVALIDES (trop g\u00E9n\u00E9rales) :**\r\n\u274C \"Am\u00E9liorer la navigation du site\"\r\n\u274C \"Ajouter un footer au site\"\r\n\u274C \"Optimiser le SEO global\"\r\n\r\nR\u00E9ponds UNIQUEMENT avec le JSON, sans \\`\\`\\`json ni texte additionnel.`;\r\n}\r\n\r\n// Helper: Guide sp\u00E9cifique par type de section\r\nfunction getSectionTypeGuide(sectionType: string): string {\r\n  const guides: Record<string, string> = {\r\n    'hero': `\r\n**\u00C9l\u00E9ments typiques d'une section Hero :**\r\n- title (titre principal)\r\n- subtitle/description (sous-titre)\r\n- ctaText/buttonText (texte du bouton d'action)\r\n- backgroundImage/image (image de fond)\r\n- backgroundColor (couleur de fond)\r\n- textColor (couleur du texte)\r\n- alignment (alignement du contenu)`,\r\n    \r\n    'hero-split': `\r\n**\u00C9l\u00E9ments typiques d'une section Hero Split :**\r\n- title, subtitle\r\n- image (c\u00F4t\u00E9 visuel)\r\n- ctaText\r\n- layout (left/right split)\r\n- backgroundColor, textColor`,\r\n    \r\n    'card': `\r\n**\u00C9l\u00E9ments typiques d'une section Card :**\r\n- cards[] (liste de cartes)\r\n- Chaque carte : title, description, icon, link\r\n- gridColumns (nombre de colonnes)\r\n- backgroundColor`,\r\n    \r\n    'cta': `\r\n**\u00C9l\u00E9ments typiques d'une section CTA :**\r\n- title (appel \u00E0 l'action)\r\n- description (description courte)\r\n- buttonText (texte du bouton)\r\n- buttonLink (lien du bouton)\r\n- backgroundColor, buttonColor`,\r\n    \r\n    'footer': `\r\n**\u00C9l\u00E9ments typiques d'un Footer :**\r\n- companyInfo (infos entreprise)\r\n- links[] (liens footer)\r\n- socialLinks[] (r\u00E9seaux sociaux)\r\n- copyright (texte copyright)`,\r\n    \r\n    'testimonials': `\r\n**\u00C9l\u00E9ments typiques d'une section T\u00E9moignages :**\r\n- testimonials[] (liste de t\u00E9moignages)\r\n- Chaque t\u00E9moignage : name, company, text, avatar\r\n- layout (carousel/grid)`,\r\n    \r\n    'pricing': `\r\n**\u00C9l\u00E9ments typiques d'une section Tarifs :**\r\n- plans[] (liste de forfaits)\r\n- Chaque plan : name, price, features[], highlighted\r\n- currency, interval (mois/an)`,\r\n    \r\n    'faq': `\r\n**\u00C9l\u00E9ments typiques d'une section FAQ :**\r\n- questions[] (liste de questions)\r\n- Chaque question : question, answer\r\n- layout (accordion/list)`,\r\n    \r\n    'contact-form': `\r\n**\u00C9l\u00E9ments typiques d'un Formulaire de Contact :**\r\n- fields[] (champs du formulaire)\r\n- submitText (texte du bouton)\r\n- successMessage (message de succ\u00E8s)`\r\n  };\r\n  \r\n  return guides[sectionType] || `**Section de type : ${sectionType}**\r\nAnalyser les \u00E9l\u00E9ments pr\u00E9sents dans le contenu fourni.`;\r\n}\r\n\r\n// Helper: Parser la r\u00E9ponse Gemini\r\nfunction parseSectionAnalysis(content: string | null): any {\r\n  if (!content) return generateMockSectionAnalysis('unknown', {});\r\n  \r\n  try {\r\n    // Nettoyer le contenu (enlever les markdown code blocks si pr\u00E9sents)\r\n    const cleaned = content.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\r\n    const parsed = JSON.parse(cleaned);\r\n    \r\n    // Valider la structure\r\n    if (!parsed.score || !parsed.suggestions || !parsed.summary) {\r\n      throw new Error('Structure invalide');\r\n    }\r\n    \r\n    return parsed;\r\n  } catch (error) {\r\n    console.warn('\u26A0\uFE0F Impossible de parser la r\u00E9ponse Gemini, utilisation du mock');\r\n    return generateMockSectionAnalysis('unknown', {});\r\n  }\r\n}\r\n\r\n// Helper: G\u00E9n\u00E9rer une analyse mock sp\u00E9cifique \u00E0 la section\r\nfunction generateMockSectionAnalysis(sectionType: string, content: any): any {\r\n  const hasTitle = content?.title || content?.heading;\r\n  const hasDescription = content?.description || content?.subtitle;\r\n  const hasImage = content?.image || content?.backgroundImage;\r\n  const hasCTA = content?.ctaText || content?.buttonText;\r\n  const hasBackgroundColor = content?.backgroundColor;\r\n  const hasTextColor = content?.textColor;\r\n  \r\n  const suggestions: any[] = [];\r\n  let score = 75; // Score de base pour une section\r\n  \r\n  // === SUGGESTIONS SP\u00C9CIFIQUES AU TYPE DE SECTION ===\r\n  \r\n  if (sectionType === 'hero' || sectionType === 'hero-split') {\r\n    // Hero Section - L'image est cruciale\r\n    if (!hasImage) {\r\n      suggestions.push({\r\n        id: `${sectionType}-img-missing`,\r\n        category: 'design',\r\n        type: 'warning',\r\n        title: 'Image de fond manquante dans cette Hero',\r\n        description: 'Cette section Hero n\u00E9cessite une image de fond impactante pour capter l\\'attention. Les Hero avec image convertissent 45% mieux.',\r\n        impact: 'high',\r\n        changes: { \r\n          backgroundImage: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?w=1920',\r\n          overlayOpacity: '0.4'\r\n        },\r\n        preview: { \r\n          before: 'Aucune image de fond', \r\n          after: 'Image panoramique transition \u00E9nerg\u00E9tique avec overlay' \r\n        }\r\n      });\r\n      score -= 15;\r\n    }\r\n    \r\n    if (!hasCTA) {\r\n      suggestions.push({\r\n        id: `${sectionType}-cta-missing`,\r\n        category: 'content',\r\n        type: 'warning',\r\n        title: 'Bouton d\\'action manquant dans cette Hero',\r\n        description: 'Cette section Hero doit avoir un CTA clair et visible pour guider l\\'utilisateur. Suggestion : \"Demander un devis gratuit\"',\r\n        impact: 'high',\r\n        changes: { \r\n          ctaText: 'Demander un devis gratuit',\r\n          ctaStyle: 'primary',\r\n          ctaSize: 'large'\r\n        },\r\n        preview: { \r\n          before: 'Pas de bouton d\\'action', \r\n          after: 'Bouton \"Demander un devis gratuit\" visible' \r\n        }\r\n      });\r\n      score -= 12;\r\n    }\r\n    \r\n    if (hasTitle && hasTitle.length < 20) {\r\n      suggestions.push({\r\n        id: `${sectionType}-title-short`,\r\n        category: 'content',\r\n        type: 'improvement',\r\n        title: 'Titre de cette Hero trop court',\r\n        description: `Le titre actuel \"${hasTitle}\" est trop court. Un titre Hero impactant fait 30-60 caract\u00E8res pour \u00EAtre m\u00E9morable.`,\r\n        impact: 'medium',\r\n        changes: { \r\n          title: 'Transformez votre consommation \u00E9nerg\u00E9tique d\u00E8s aujourd\\'hui'\r\n        },\r\n        preview: { \r\n          before: hasTitle, \r\n          after: 'Transformez votre consommation \u00E9nerg\u00E9tique d\u00E8s aujourd\\'hui' \r\n        }\r\n      });\r\n      score -= 8;\r\n    }\r\n  }\r\n  \r\n  else if (sectionType === 'card' || sectionType === 'card-icon' || sectionType === 'card-service') {\r\n    // Card Section - Le nombre de cartes et la grille sont importants\r\n    const cards = content?.cards || [];\r\n    const gridColumns = content?.gridColumns || 3;\r\n    \r\n    if (cards.length === 0) {\r\n      suggestions.push({\r\n        id: `${sectionType}-no-cards`,\r\n        category: 'content',\r\n        type: 'warning',\r\n        title: 'Aucune carte dans cette section Cards',\r\n        description: 'Cette section de cartes est vide. Ajoutez au moins 3 cartes pour pr\u00E9senter vos services/avantages.',\r\n        impact: 'high',\r\n        changes: { \r\n          cards: [\r\n            { title: 'Service 1', description: 'Description du service', icon: 'star' },\r\n            { title: 'Service 2', description: 'Description du service', icon: 'rocket' },\r\n            { title: 'Service 3', description: 'Description du service', icon: 'check' }\r\n          ]\r\n        },\r\n        preview: { \r\n          before: 'Section vide', \r\n          after: '3 cartes de services avec ic\u00F4nes' \r\n        }\r\n      });\r\n      score -= 20;\r\n    } else if (cards.length % gridColumns !== 0) {\r\n      suggestions.push({\r\n        id: `${sectionType}-grid-uneven`,\r\n        category: 'layout',\r\n        type: 'improvement',\r\n        title: 'Grille d\u00E9s\u00E9quilibr\u00E9e dans cette section',\r\n        description: `Vous avez ${cards.length} cartes en ${gridColumns} colonnes, ce qui cr\u00E9e une derni\u00E8re ligne incompl\u00E8te. Ajoutez ${gridColumns - (cards.length % gridColumns)} carte(s) ou passez \u00E0 ${cards.length} colonnes.`,\r\n        impact: 'medium',\r\n        changes: { \r\n          gridColumns: cards.length === 4 ? 2 : Math.min(cards.length, 4)\r\n        },\r\n        preview: { \r\n          before: `${cards.length} cartes en ${gridColumns} colonnes`, \r\n          after: 'Grille \u00E9quilibr\u00E9e' \r\n        }\r\n      });\r\n      score -= 5;\r\n    }\r\n  }\r\n  \r\n  else if (sectionType === 'cta' || sectionType === 'cta-banner') {\r\n    // CTA Section - Le bouton doit \u00EAtre ultra-visible\r\n    if (!hasCTA) {\r\n      suggestions.push({\r\n        id: `${sectionType}-no-button`,\r\n        category: 'content',\r\n        type: 'warning',\r\n        title: 'Bouton manquant dans cette section CTA',\r\n        description: 'Une section CTA DOIT avoir un bouton d\\'action visible. C\\'est l\\'\u00E9l\u00E9ment central de cette section.',\r\n        impact: 'high',\r\n        changes: { \r\n          buttonText: 'Commencer maintenant',\r\n          buttonSize: 'large',\r\n          buttonColor: '#10b981'\r\n        },\r\n        preview: { \r\n          before: 'Pas de bouton', \r\n          after: 'Bouton \"Commencer maintenant\" vert vif' \r\n        }\r\n      });\r\n      score -= 25;\r\n    }\r\n    \r\n    if (!hasBackgroundColor || hasBackgroundColor === '#ffffff') {\r\n      suggestions.push({\r\n        id: `${sectionType}-bg-bland`,\r\n        category: 'design',\r\n        type: 'improvement',\r\n        title: 'Fond de cette CTA trop neutre',\r\n        description: 'Cette section CTA doit se d\u00E9marquer visuellement. Utilisez un fond color\u00E9 ou un gradient pour attirer l\\'attention.',\r\n        impact: 'high',\r\n        changes: { \r\n          backgroundColor: '#f0fdf4',\r\n          borderColor: '#10b981',\r\n          borderWidth: '2px'\r\n        },\r\n        preview: { \r\n          before: 'Fond blanc neutre', \r\n          after: 'Fond vert clair avec bordure verte' \r\n        }\r\n      });\r\n      score -= 10;\r\n    }\r\n  }\r\n  \r\n  else if (sectionType === 'footer') {\r\n    // Footer - Doit avoir les infos l\u00E9gales\r\n    const hasCopyright = content?.copyright;\r\n    const hasLinks = content?.links && content.links.length > 0;\r\n    \r\n    if (!hasCopyright) {\r\n      suggestions.push({\r\n        id: `${sectionType}-no-copyright`,\r\n        category: 'content',\r\n        type: 'warning',\r\n        title: 'Copyright manquant dans ce Footer',\r\n        description: 'Ce footer doit inclure le copyright pour la conformit\u00E9 l\u00E9gale.',\r\n        impact: 'medium',\r\n        changes: { \r\n          copyright: `\u00A9 ${new Date().getFullYear()} 2Thier. Tous droits r\u00E9serv\u00E9s.`\r\n        },\r\n        preview: { \r\n          before: 'Pas de mention l\u00E9gale', \r\n          after: '\u00A9 2025 2Thier. Tous droits r\u00E9serv\u00E9s.' \r\n        }\r\n      });\r\n      score -= 8;\r\n    }\r\n    \r\n    if (!hasLinks) {\r\n      suggestions.push({\r\n        id: `${sectionType}-no-links`,\r\n        category: 'content',\r\n        type: 'improvement',\r\n        title: 'Liens manquants dans ce Footer',\r\n        description: 'Ce footer devrait inclure des liens utiles (CGV, Mentions l\u00E9gales, Contact, etc.)',\r\n        impact: 'medium',\r\n        changes: { \r\n          links: [\r\n            { text: 'Mentions l\u00E9gales', url: '/legal' },\r\n            { text: 'CGV', url: '/cgv' },\r\n            { text: 'Contact', url: '/contact' }\r\n          ]\r\n        },\r\n        preview: { \r\n          before: 'Aucun lien', \r\n          after: '3 liens l\u00E9gaux essentiels' \r\n        }\r\n      });\r\n      score -= 7;\r\n    }\r\n  }\r\n  \r\n  // === SUGGESTIONS G\u00C9N\u00C9RIQUES POUR TOUS LES TYPES ===\r\n  \r\n  if (!hasTitle) {\r\n    suggestions.push({\r\n      id: `${sectionType}-no-title`,\r\n      category: 'content',\r\n      type: 'warning',\r\n      title: 'Titre manquant dans cette section',\r\n      description: `Cette section ${sectionType} n\u00E9cessite un titre clair pour guider le visiteur.`,\r\n      impact: 'high',\r\n      changes: { \r\n        title: sectionType === 'hero' ? 'Votre titre impactant ici' : `Titre de la section ${sectionType}`\r\n      },\r\n      preview: { \r\n        before: 'Pas de titre', \r\n        after: 'Titre explicite ajout\u00E9' \r\n      }\r\n    });\r\n    score -= 12;\r\n  }\r\n  \r\n  if (!hasDescription && sectionType !== 'footer') {\r\n    suggestions.push({\r\n      id: `${sectionType}-no-desc`,\r\n      category: 'content',\r\n      type: 'improvement',\r\n      title: 'Description manquante dans cette section',\r\n      description: `Un sous-titre ou description dans cette section ${sectionType} am\u00E9liore la clart\u00E9 du message.`,\r\n      impact: 'medium',\r\n      changes: { \r\n        description: 'Description engageante de cette section'\r\n      },\r\n      preview: { \r\n        before: 'Pas de description', \r\n        after: 'Sous-titre explicatif ajout\u00E9' \r\n        }\r\n    });\r\n    score -= 6;\r\n  }\r\n  \r\n  // Contraste des couleurs\r\n  if (hasBackgroundColor && hasTextColor) {\r\n    const bgColor = hasBackgroundColor.replace('#', '');\r\n    const txtColor = hasTextColor.replace('#', '');\r\n    // Heuristique simple : si fond clair et texte clair, probl\u00E8me\r\n    const bgLight = parseInt(bgColor.substring(0, 2), 16) > 200;\r\n    const txtLight = parseInt(txtColor.substring(0, 2), 16) > 200;\r\n    \r\n    if (bgLight && txtLight) {\r\n      suggestions.push({\r\n        id: `${sectionType}-contrast-low`,\r\n        category: 'design',\r\n        type: 'warning',\r\n        title: 'Contraste insuffisant dans cette section',\r\n        description: 'Le texte clair sur fond clair de cette section pose un probl\u00E8me d\\'accessibilit\u00E9 (WCAG). Assombrir le texte.',\r\n        impact: 'medium',\r\n        changes: { \r\n          textColor: '#1f2937'\r\n        },\r\n        preview: { \r\n          before: `Texte ${hasTextColor} sur fond ${hasBackgroundColor}`, \r\n          after: 'Texte #1f2937 (gris fonc\u00E9) sur fond clair' \r\n        }\r\n      });\r\n      score -= 8;\r\n    }\r\n  }\r\n  \r\n  // Espacement\r\n  const padding = content?.padding;\r\n  if (!padding || padding === '0px' || padding === '0') {\r\n    suggestions.push({\r\n      id: `${sectionType}-no-padding`,\r\n      category: 'layout',\r\n      type: 'best-practice',\r\n      title: 'Espacement insuffisant dans cette section',\r\n      description: 'Cette section manque de \"breathing room\". Ajouter du padding pour un design a\u00E9r\u00E9 (r\u00E8gle des 8px).',\r\n      impact: 'low',\r\n      changes: { \r\n        padding: '48px 24px'\r\n      },\r\n      preview: { \r\n        before: 'Section coll\u00E9e aux bords', \r\n        after: 'Section avec espacement confortable' \r\n      }\r\n    });\r\n    score -= 4;\r\n  }\r\n  \r\n  // Si aucune suggestion sp\u00E9cifique, ajouter des best practices\r\n  if (suggestions.length === 0) {\r\n    suggestions.push({\r\n      id: `${sectionType}-optimize-mobile`,\r\n      category: 'ux',\r\n      type: 'best-practice',\r\n      title: 'Optimiser cette section pour mobile',\r\n      description: 'V\u00E9rifier que cette section s\\'adapte bien aux petits \u00E9crans (responsive design).',\r\n      impact: 'medium',\r\n      changes: { \r\n        responsiveSettings: {\r\n          mobile: { fontSize: '14px', padding: '24px 16px' }\r\n        }\r\n      },\r\n      preview: { \r\n        before: 'Param\u00E8tres desktop uniquement', \r\n        after: 'Adapt\u00E9 aux mobiles' \r\n      }\r\n    });\r\n  }\r\n  \r\n  return {\r\n    score: Math.max(40, Math.min(95, score)),\r\n    suggestions: suggestions.slice(0, 8), // Max 8 suggestions pour ne pas surcharger\r\n    summary: {\r\n      strengths: [\r\n        hasTitle && `Titre pr\u00E9sent dans cette section`,\r\n        hasDescription && `Description claire dans cette section`,\r\n        hasImage && `Visuel pr\u00E9sent dans cette section`,\r\n        hasCTA && `Appel \u00E0 l'action dans cette section`,\r\n        hasBackgroundColor && hasBackgroundColor !== '#ffffff' && `Fond personnalis\u00E9 dans cette section`\r\n      ].filter(Boolean),\r\n      weaknesses: [\r\n        !hasTitle && `Titre manquant dans cette section ${sectionType}`,\r\n        !hasDescription && sectionType !== 'footer' && `Description absente de cette section`,\r\n        !hasCTA && (sectionType === 'hero' || sectionType === 'cta') && `Bouton d'action manquant dans cette section`,\r\n        suggestions.length > 3 && `${suggestions.length} am\u00E9liorations possibles identifi\u00E9es pour cette section`\r\n      ].filter(Boolean),\r\n      opportunities: [\r\n        `Ajouter des animations d'entr\u00E9e pour cette section`,\r\n        `Tester des variantes A/B de cette section`,\r\n        `Am\u00E9liorer l'accessibilit\u00E9 (WCAG AA) de cette section`,\r\n        `Optimiser le poids des images de cette section`\r\n      ].slice(0, 3)\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * \uD83D\uDCAC POST /api/ai/generate-response\r\n * G\u00E9n\u00E8re une r\u00E9ponse de l'assistant IA\r\n */\r\nrouter.post('/generate-response', async (req, res) => {\r\n  await handleChatLike(req, res, 'generate-response');\r\n});\r\n\r\n/**\r\n * \uD83D\uDCAC POST /api/ai/chat (alias moderne)\r\n */\r\nrouter.post('/chat', async (req, res) => {\r\n  await handleChatLike(req, res, 'chat');\r\n});\r\n\r\n// -------- Helpers Prompt & Fallback ---------\r\ninterface PromptContext { currentModule?: string; currentPage?: string; userRole?: string; [k: string]: unknown }\r\ninterface HistoryMsg { type?: string; role?: string; message?: string; content?: string }\r\ninterface ChatPromptInput { message: string; context?: PromptContext; conversationHistory?: HistoryMsg[]; analysis?: unknown; memory?: string }\r\nfunction buildChatPrompt({ message, context, conversationHistory, analysis, memory }: ChatPromptInput): string {\r\n  // Lead/context summarization (kept concise to preserve tokens)\r\n  function summarizeLeadFromContext(ctx?: PromptContext): string {\r\n    try {\r\n      if (!ctx) return '';\r\n      const ctxUnknown = ctx as unknown as Record<string, unknown>;\r\n      const leadBasic = (ctxUnknown?.lead as unknown) || null;\r\n      const lc = (ctxUnknown?.leadContext as unknown as { lead?: unknown; calls?: unknown[]; messages?: unknown[]; upcomingEvents?: unknown[] }) || null;\r\n      const lead = (lc && (lc as { lead?: unknown }).lead) || leadBasic || null;\r\n      if (!lead && !lc) return '';\r\n      const name = [lead?.firstName || lead?.data?.firstName, lead?.lastName || lead?.data?.lastName, lead?.name].filter(Boolean).join(' ').trim();\r\n      const company = lead?.company || lead?.data?.company || '';\r\n      const status = lead?.status || lead?.data?.status || '';\r\n      const notes: string = (lead?.notes || lead?.data?.notes || '').toString();\r\n      const calls = lc?.calls || [];\r\n      const messages = lc?.messages || [];\r\n      const events = lc?.upcomingEvents || [];\r\n  // const timeline = lc?.timeline || [];\r\n      const lastCall = Array.isArray(calls) && calls.length ? calls[0] : null;\r\n      const lastMsg = Array.isArray(messages) && messages.length ? messages[0] : null;\r\n      const nextEvent = Array.isArray(events) && events.length ? events[0] : null;\r\n      const parts: string[] = [];\r\n      if (name) parts.push(`Nom: ${name}${company ? ' \u2022 '+company : ''}`);\r\n      if (status) parts.push(`Statut: ${status}`);\r\n      const counts: string[] = [];\r\n      if (Array.isArray(calls)) counts.push(`${calls.length} appels r\u00E9cents`);\r\n      if (Array.isArray(messages)) counts.push(`${messages.length} messages`);\r\n      if (Array.isArray(events)) counts.push(`${events.length} RDV \u00E0 venir`);\r\n      if (counts.length) parts.push(`Activit\u00E9: ${counts.join(', ')}`);\r\n      if (lastCall) parts.push(`Dernier appel: ${lastCall.status || 'n/a'}${lastCall.duration ? ` (${lastCall.duration}s)` : ''}`);\r\n      if (lastMsg) parts.push(`Dernier message: ${lastMsg.type || 'n/a'} ${lastMsg.sentAt ? `(${new Date(lastMsg.sentAt).toLocaleDateString('fr-FR')})` : ''}`);\r\n      if (nextEvent) parts.push(`Prochain \u00E9v\u00E8nement: ${nextEvent.title || 'RDV'} le ${nextEvent.startDate ? new Date(nextEvent.startDate).toLocaleString('fr-FR') : 'bient\u00F4t'}`);\r\n      if (notes) parts.push(`Notes: ${(notes.replace(/\\s+/g,' ').slice(0,140))}${notes.length>140?'\u2026':''}`);\r\n      return parts.length ? ('\\nLEAD_CONTEXT:\\n' + parts.join('\\n')) : '';\r\n    } catch { return ''; }\r\n  }\r\n  const hist = (conversationHistory || []).slice(-8).map((m, i) => `#${i+1} ${m.type || m.role || 'user'}: ${(m.message || m.content || '').slice(0,400)}`).join('\\n');\r\n  const analysisBlock = analysis ? `\\nANALYSE_PRECEDENTE:\\n${JSON.stringify(analysis).slice(0,800)}` : '';\r\n  const memoryBlock = memory ? `\\nMEMOIRE_SYSTEME_RECENTE:\\n${memory}` : '';\r\n  const leadBlock = summarizeLeadFromContext(context as PromptContext);\r\n  return `Tu es un assistant commercial CRM francophone sp\u00E9cialis\u00E9 en prospection, qualification et planification de RDV.\r\nContexteModule: ${context?.currentModule || 'inconnu'}\r\nPage: ${context?.currentPage || 'n/a'}\r\nR\u00F4leUtilisateur: ${context?.userRole || 'commercial'}\r\nObjectif: aider rapidement avec pertinence, proposer des actions concr\u00E8tes.\r\n${leadBlock}\r\nHistorique:\r\n${hist || 'Aucun'}\r\nMessageUtilisateur: ${message}\r\n${analysisBlock}\r\n${memoryBlock}\r\nR\u00E8gles de r\u00E9ponse: commence par saluer en citant le pr\u00E9nom/nom du lead si disponibles. Fais 1 phrase d'\u00E9tat (appels/messages/RDV). Puis propose: 1) une phrase d'ouverture d'appel adapt\u00E9e, 2) deux questions de qualification courtes, 3) la prochaine action claire. Si aucune activit\u00E9, encourage \u00E0 appeler et propose un angle. R\u00E9ponds en fran\u00E7ais, concis, structur\u00E9, \u2264140 mots.`;\r\n}\r\n\r\nfunction buildMockResponse(message: string, context?: PromptContext): string {\r\n  const page = (context?.currentPage || '').toLowerCase();\r\n  const moduleKey = (context?.currentModule || '').toLowerCase();\r\n  const mentionsGmail = /gmail|mail|email|inbox|d\u00E9livrabi|deliverab/i.test(message) || page.includes('mail') || page.includes('gmail') || moduleKey.includes('mail') || moduleKey.includes('gmail');\r\n  if (mentionsGmail) {\r\n    return [\r\n      `Analyse rapide de la page Mail (r\u00E9ponse simplifi\u00E9e):`,\r\n      `\u2022 Lisibilit\u00E9: v\u00E9rifiez la hi\u00E9rarchie (sujet, exp\u00E9diteur, labels).`,\r\n      `\u2022 Actions cl\u00E9s visibles: r\u00E9pondre, transf\u00E9rer, \u00E9toile, supprimer, labels.`,\r\n      `\u2022 \u00C9tats: chargement, erreurs, bo\u00EEte vide, pagination/scroll.`,\r\n      `\u2022 Recherche/filtres: champs, tri par date/exp\u00E9diteur, labels.`,\r\n      `\u2022 S\u00E9curit\u00E9: si HTML d'email rendu, utiliser DOMPurify (anti-XSS).`,\r\n      `\u2022 Liaison CRM: lien vers Lead/Opportunit\u00E9/T\u00E2ches, suivi/relances.`,\r\n      `Prochaine \u00E9tape: dites \u201Caudite la page mail\u201D ou \u201Cpropose 3 quick wins UI\u201D.`\r\n    ].join('\\n');\r\n  }\r\n  return `Je comprends: \"${message}\". (R\u00E9ponse simplifi\u00E9e) Besoin d'aide pour: planifier un RDV, analyser un lead, g\u00E9n\u00E9rer un email, ou d\u00E9finir la prochaine action ? Pr\u00E9cisez votre objectif en une phrase.`;\r\n}\r\n\r\nfunction defaultSuggestions(): string[] {\r\n  return [\r\n    'Script d\u2019ouverture d\u2019appel',\r\n    'Questions de qualification',\r\n    'Prochaine action commerciale',\r\n    'Planifier un rendez-vous'\r\n  ];\r\n}\r\n\r\nfunction deriveSuggestions(content: string): string[] {\r\n  const lower = content.toLowerCase();\r\n  const s = new Set<string>();\r\n  if (lower.includes('email')) s.add('G\u00E9n\u00E9rer un email');\r\n  if (lower.includes('rdv') || lower.includes('rendez')) s.add('Planifier un rendez-vous');\r\n  if (lower.includes('analyse')) s.add('Analyser le lead');\r\n  s.add('Prochaine action commerciale');\r\n  return Array.from(s).slice(0,6);\r\n}\r\n\r\n// ---------- Facteur commun chat/generate-response ----------\r\n// Index fichiers & symboles pour enrichissement code lorsque l'utilisateur pose des questions techniques\r\nlet __AI_CODE_INDEX: string[] | null = null;\r\nlet __AI_SYMBOL_INDEX: Record<string,string> | null = null;\r\n// Cache simple en m\u00E9moire pour micro-summaries et analyses (TTL 90s)\r\ninterface CachedSummary { ts: number; summary: string }\r\nconst __AI_FILE_SUMMARY_CACHE: Record<string, CachedSummary> = {};\r\nconst __AI_FILE_SUMMARY_TTL = 90_000;\r\nfunction __aiBuildCodeIndex() {\r\n  if (__AI_CODE_INDEX) return __AI_CODE_INDEX;\r\n  const base = path.join(process.cwd(), 'src');\r\n  const acc: string[] = [];\r\n  function walk(dir: string, depth = 0) {\r\n    if (depth > 6) return;\r\n    let entries: string[] = [];\r\n    try { entries = fs.readdirSync(dir); } catch { return; }\r\n    for (const e of entries) {\r\n      const full = path.join(dir, e);\r\n      if (/node_modules|\\.git|dist|build/.test(full)) continue;\r\n      let st: fs.Stats; try { st = fs.statSync(full); } catch { continue; }\r\n      if (st.isDirectory()) walk(full, depth + 1);\r\n      else if (/\\.(ts|tsx|js|cjs|mjs)$/.test(e)) acc.push(full.substring(base.length + 1).replace(/\\\\/g,'/'));\r\n    }\r\n  }\r\n  walk(base);\r\n  __AI_CODE_INDEX = acc;\r\n  return acc;\r\n}\r\nfunction __aiBuildSymbolIndex() {\r\n  if (__AI_SYMBOL_INDEX) return __AI_SYMBOL_INDEX;\r\n  const idx = __aiBuildCodeIndex();\r\n  const m: Record<string,string> = {};\r\n  for (const rel of idx.slice(0, 1200)) {\r\n    try {\r\n      const abs = path.join(process.cwd(),'src',rel);\r\n      const content = fs.readFileSync(abs,'utf8');\r\n      const regexes = [\r\n        /export\\s+class\\s+([A-Za-z0-9_]+)/g,\r\n        /export\\s+(?:async\\s+)?function\\s+([A-Za-z0-9_]+)/g,\r\n        /export\\s+const\\s+([A-Za-z0-9_]+)/g,\r\n        /export\\s+interface\\s+([A-Za-z0-9_]+)/g,\r\n        /export\\s+type\\s+([A-Za-z0-9_]+)/g,\r\n        /export\\s+enum\\s+([A-Za-z0-9_]+)/g,\r\n      ];\r\n      for (const r of regexes) { let match: RegExpExecArray | null; while ((match = r.exec(content))) { if (!m[match[1]]) m[match[1]] = rel; } }\r\n      const brace = /export\\s+{([^}]+)}/g; let b: RegExpExecArray | null;\r\n      while ((b = brace.exec(content))) { b[1].split(',').map(s=>s.trim().split(/\\s+as\\s+/i)[0]).filter(Boolean).forEach(sym=> { if (!m[sym]) m[sym]=rel; }); }\r\n    } catch {/* ignore */}\r\n  }\r\n  __AI_SYMBOL_INDEX = m; return m;\r\n}\r\nfunction __aiExtractReferencedFiles(message: string): string[] {\r\n  const explicit = Array.from(message.matchAll(/([A-Za-z0-9_-]+\\.(?:tsx?|jsx?|cjs|mjs))/g)).map(m=>m[1]);\r\n  const extra: string[] = [];\r\n  const hooks = Array.from(message.matchAll(/use[A-Z][A-Za-z0-9]+/g)).map(m=>m[0] + '.ts');\r\n  extra.push(...hooks);\r\n  const symbolTokens = Array.from(message.matchAll(/\\b[A-Z][A-Za-z0-9_]{2,}\\b/g)).map(m=>m[0]).slice(0,30);\r\n  const symIdx = __aiBuildSymbolIndex();\r\n  for (const t of symbolTokens) if (symIdx[t]) extra.push(symIdx[t]);\r\n  const candidates = Array.from(new Set([...explicit, ...extra]));\r\n  if (!candidates.length) return [];\r\n  const index = __aiBuildCodeIndex();\r\n  const resolved: string[] = [];\r\n  for (const c of candidates) {\r\n    if (c.includes('/')) { if (index.includes(c)) resolved.push(c); }\r\n    else { const hit = index.find(p => p.endsWith('/'+c) || p === c); if (hit) resolved.push(hit); }\r\n    if (resolved.length >= 5) break;\r\n  }\r\n  return resolved.slice(0,5);\r\n}\r\nfunction __aiSummarizeFile(rel: string): string | null {\r\n  try {\r\n    const now = Date.now();\r\n    const cached = __AI_FILE_SUMMARY_CACHE[rel];\r\n    if (cached && now - cached.ts < __AI_FILE_SUMMARY_TTL) return cached.summary;\r\n    const abs = path.join(process.cwd(),'src',rel);\r\n    if (!fs.existsSync(abs)) return null;\r\n    const content = fs.readFileSync(abs,'utf8');\r\n    const lines = content.split(/\\r?\\n/);\r\n    const first = lines.slice(0, 80).join('\\n');\r\n    const importMatches = Array.from(content.matchAll(/import\\s+[^;]+from\\s+['\"]([^'\".][^'\"/]*)['\"]/g)).map(m=>m[1]).slice(0,8);\r\n    const internalImports = Array.from(content.matchAll(/import\\s+[^;]+from\\s+['\"](\\.{1,2}\\/[^'\"]+)['\"]/g)).map(m=>m[1]).slice(0,6);\r\n    const exportMatches = Array.from(content.matchAll(/export\\s+(?:default\\s+)?(function|const|class)\\s+([A-Za-z0-9_]+)/g)).map(m=>m[2]).slice(0,10);\r\n    const hasDefault = /export\\s+default\\s+/.test(content);\r\n    const hooksCount = (content.match(/\\buse(State|Effect|Memo|Callback|Ref|Context|Reducer)\\b/g)||[]).length;\r\n    const useEffectCount = (content.match(/\\buseEffect\\b/g)||[]).length;\r\n    const hasI18n = /\\bt\\(['\"][^)]*\\)/.test(content) || /i18n/.test(content);\r\n    const jsxTags = (content.match(/<[A-Z][A-Za-z0-9]+\\b/g)||[]).length;\r\n    const size = lines.length;\r\n  const risk: string[] = [];\r\n    if (size > 800) risk.push('very_large'); else if (size > 400) risk.push('large');\r\n    if (hooksCount > 18) risk.push('many_hooks');\r\n    if (!hasI18n) risk.push('no_i18n');\r\n    const summaryObj = {\r\n      file: rel,\r\n      lines: size,\r\n      exports: exportMatches,\r\n      defaultExport: hasDefault,\r\n      importsExt: importMatches,\r\n      importsInt: internalImports,\r\n      hooks: { total: hooksCount, useEffect: useEffectCount },\r\n      jsxTags,\r\n      i18n: hasI18n,\r\n      risks: risk\r\n    };\r\n    const summaryStr = 'FILE_SUMMARY '+rel+'\\n'+JSON.stringify(summaryObj)+'\\nFIRST_LINES:\\n'+first.slice(0,1800);\r\n    __AI_FILE_SUMMARY_CACHE[rel] = { ts: now, summary: summaryStr };\r\n    return summaryStr;\r\n  } catch { return null; }\r\n}\r\nasync function handleChatLike(req: express.Request, res: express.Response, endpoint: string) {\r\n  const t0 = Date.now();\r\n  try {\r\n    // S\u00E9curiser le parsing du body (\u00E9vite text/plain 500 + r\u00E9ponse JSON uniforme)\r\n    let message: unknown, context: unknown, conversationHistory: unknown, analysis: unknown;\r\n    try {\r\n      ({ message, context = {}, conversationHistory = [], analysis } = req.body || {});\r\n    } catch (parseErr) {\r\n      return res.status(400).json({ success: false, error: 'Corps de requ\u00EAte invalide', details: (parseErr as Error).message });\r\n    }\r\n    if (!message || typeof message !== 'string') {\r\n      return res.status(400).json({ success: false, error: 'Param\u00E8tre \"message\" requis' });\r\n    }\r\n    console.log(`\uD83E\uDD16 [AI] ${endpoint} message=`, message.slice(0,160));\r\n    interface HistMsg { type?: string; role?: string; message?: string; content?: string }\r\n    const historyPreview = (conversationHistory as HistMsg[]).slice(-6).map((m) => `${m.type || m.role}: ${(m.message || m.content || '').slice(0,100)}`);\r\n    console.log('\uD83D\uDCDA [AI] History(last<=6)=', historyPreview);\r\n\r\n    // R\u00E9cup\u00E9ration m\u00E9moire syst\u00E8me r\u00E9cente (SuperAdmin uniquement) \u2013 non bloquant\r\n    let memoryString = '';\r\n    try {\r\n      const authReq = req as unknown as AuthenticatedRequest;\r\n  interface MaybeSuperUser { isSuperAdmin?: boolean; roles?: string[] }\r\n  const u = authReq.user as unknown as MaybeSuperUser | undefined;\r\n  const isSuper = !!(u?.isSuperAdmin || u?.roles?.includes?.('super_admin'));\r\n      if (isSuper) {\r\n        const orgId = authReq.user?.organizationId || null;\r\n        const memEntries = await prisma.aiUsageLog.findMany({\r\n          where: { type: 'system_memory', ...(orgId ? { organizationId: orgId } : {}) },\r\n          orderBy: { createdAt: 'desc' },\r\n          take: 8,\r\n          select: { errorMessage: true, meta: true, createdAt: true }\r\n        });\r\n        memoryString = memEntries.map(m => {\r\n          const metaObj = m.meta as (Record<string, unknown> | null) ?? null;\r\n          const topic = typeof metaObj?.topic === 'string' ? metaObj.topic : 'M\u00E9mo';\r\n          return `- ${topic}: ${(m.errorMessage || '').replace(/\\s+/g,' ').slice(0,180)}`;\r\n        }).join('\\n');\r\n      }\r\n    } catch (memErr) {\r\n      console.warn('[AI] M\u00E9moire syst\u00E8me indisponible:', (memErr as Error).message);\r\n    }\r\n\r\n    // Enrichissement contexte fonctionnel interne dynamique\r\n    let internalFunctionalContext = '';\r\n    try {\r\n      // Si la question mentionne gmail / email / d\u00E9livrabilit\u00E9 -> r\u00E9cup\u00E9rer \u00E9tat modules Google\r\n      if (/gmail|email|mail|d\u00E9livrabi|deliverab/i.test(message)) {\r\n        const googleModules = await prisma.module.findMany({\r\n          where: { key: { in: ['google_gmail', 'google_drive', 'google_calendar'] } },\r\n          select: { key: true, label: true, route: true, feature: true }\r\n        });\r\n        const activated = googleModules.map(m => `${m.label || m.key}${m.route ? '(/'+m.route.replace(/^\\//,'')+')' : ''}`).join(', ') || 'Aucun module Google activ\u00E9';\r\n        // Mode AUDIT PAGE Gmail: centrer la r\u00E9ponse sur la page actuelle (UI/UX), pas sur Gmail en g\u00E9n\u00E9ral\r\n        internalFunctionalContext = `AUDIT_PAGE_GMAIL: Concentre ta r\u00E9ponse sur l'audit de la page Gmail du CRM (UI/UX/flows), pas sur Gmail en g\u00E9n\u00E9ral.\r\nModulesGoogleActifs: ${activated}\r\nChecklist d'audit (prioriser concret et actionnable):\r\n- Structure & lisibilit\u00E9 (layout, densit\u00E9, hi\u00E9rarchie visuelle)\r\n- \u00C9tats (chargement/erreur/empty), feedbacks et affordances\r\n- Actions cl\u00E9s: composer, r\u00E9pondre, transf\u00E9rer, \u00E9toiler, supprimer, naviguer par labels\r\n- Recherche/tri/filtres/pagination ou scroll infini\r\n- Accessibilit\u00E9 (A11y), raccourcis clavier, focus management\r\n- Internationalisation (i18n), responsive/mobile\r\n- S\u00E9curit\u00E9 rendu HTML (sanitiser si HTML inject\u00E9)\r\n- Liaison CRM: liens Lead/Opportunit\u00E9/T\u00E2ches, suivi/relances\r\nRestitue: Points forts, Probl\u00E8mes, Am\u00E9liorations, Ajouts \u00E0 envisager, \u00C0 retirer, Quick wins (prioris\u00E9s).`;\r\n      }\r\n    } catch (ctxErr) {\r\n      console.warn('[AI] Contexte fonctionnel Gmail non disponible:', (ctxErr as Error).message);\r\n    }\r\n\r\n    // Contexte code si question technique\r\n    let codeContext = '';\r\n    try {\r\n      if (/(analyse|regarde|inspecte|code|fichier|hook|component|classe|fonction|page|gmail|module|google mail)/i.test(message)) {\r\n        const referenced = __aiExtractReferencedFiles(message);\r\n        if (referenced.length) {\r\n          codeContext = referenced.map(r => __aiSummarizeFile(r) || (`// ${r} (lecture impossible)`)).join('\\n\\n');\r\n        }\r\n      }\r\n    } catch (e) { console.warn('[AI] Contexte code \u00E9chou\u00E9:', (e as Error).message); }\r\n\r\n    // Analyse automatique (page & feature) \u2013 heuristique l\u00E9g\u00E8re pour alimenter le raisonnement sans surco\u00FBt externe\r\n    interface AutoPageAnalysis { path: string; lines: number; hooks: { total: number; useEffect: number; custom: string[] }; antd: string[]; i18n: boolean; tailwind: boolean; complexity: string[]; suggestions: string[]; score: number }\r\n    interface AutoFeatureSummary { feature: string; fileCount: number; totalLines: number; avgLines: number; totalHooks: number; i18nCoverage: number; antdUsageRate: number; tailwindUsageRate: number }\r\n    let autoAnalysis: { page?: AutoPageAnalysis; feature?: AutoFeatureSummary } | null = null;\r\n    try {\r\n  const ctxObj = (context || {}) as { currentPage?: string; currentModule?: string };\r\n  const maybePage = ctxObj.currentPage;\r\n  const maybeModule = ctxObj.currentModule;\r\n      const lowerMsg = message.toLowerCase();\r\n      const wantAnalysis = /(analyse|audite|qualit\u00E9|am\u00E9lior|refactor|optimis|structure|complexit\u00E9|lisibilit\u00E9|accessibilit\u00E9|ux|ui)/i.test(message);\r\n      // Local helper to find a page file\r\n      function resolvePageFile(name?: string): string | null {\r\n        if (!name) return null;\r\n        const base = path.join(process.cwd(),'src','pages');\r\n        // If name already looks like path relative to src/pages\r\n        if (name.endsWith('.tsx') && fs.existsSync(path.join(process.cwd(),'src',name))) return name;\r\n        // Try direct\r\n        const candidate = path.join(base, name.endsWith('.tsx')? name : name + '.tsx');\r\n        if (fs.existsSync(candidate)) return 'pages/' + path.basename(candidate); // shortened path not ideal; fallback search\r\n        // Shallow search\r\n        try {\r\n          const entries = fs.readdirSync(base);\r\n          const hit = entries.find(e => e.toLowerCase() === (name.toLowerCase().endsWith('.tsx')? name.toLowerCase(): name.toLowerCase()+'.tsx'));\r\n          if (hit) return 'pages/' + hit;\r\n        } catch {/* ignore */}\r\n        return null;\r\n      }\r\n      // Attempt detect feature from message or context\r\n      let featureKey: string | null = null;\r\n      const featureMapPath = path.join(process.cwd(),'src','feature-map.json');\r\n      let featureMap: Record<string, { primaryPages?: string[]; relatedServices?: string[] }> | null = null;\r\n      if (fs.existsSync(featureMapPath)) {\r\n        try { featureMap = JSON.parse(fs.readFileSync(featureMapPath,'utf8')); } catch {/* ignore */}\r\n      }\r\n      if (featureMap) {\r\n        for (const k of Object.keys(featureMap)) {\r\n          if (lowerMsg.includes(k) || (maybeModule && maybeModule.toLowerCase().includes(k))) { featureKey = k; break; }\r\n        }\r\n        // heuristiques s\u00E9mantiques simples\r\n        if (!featureKey) {\r\n          if (/gmail|email|inbox/.test(lowerMsg)) featureKey = 'mail';\r\n          else if (/lead/.test(lowerMsg)) featureKey = 'leads';\r\n          else if (/agenda|calendar|calendrier/.test(lowerMsg)) featureKey = 'agenda';\r\n        }\r\n      }\r\n      let pagePath: string | null = null;\r\n      if (maybePage) pagePath = resolvePageFile(maybePage);\r\n      if (!pagePath && /(page|mailpage|googlemailpage|inbox)/i.test(message)) {\r\n        // Try guess one of main mail pages\r\n        const guess = [ 'pages/GoogleMailPageFixed_New.tsx','pages/GoogleMailPageFixed.tsx','pages/GoogleMailPage.tsx','pages/MailPage.tsx' ];\r\n        pagePath = guess.find(g => fs.existsSync(path.join(process.cwd(),'src',g))) || null;\r\n      }\r\n      if ((wantAnalysis || featureKey || pagePath) && (featureKey || pagePath)) {\r\n        autoAnalysis = {};\r\n        // Page analysis\r\n        if (pagePath && fs.existsSync(path.join(process.cwd(),'src',pagePath))) {\r\n          try {\r\n            const absPage = path.join(process.cwd(),'src',pagePath);\r\n            const content = fs.readFileSync(absPage,'utf8');\r\n            const linesArr = content.split(/\\r?\\n/);\r\n            const hooksCount = (content.match(/\\buse(State|Effect|Memo|Callback|Ref|Context|Reducer)\\b/g) || []).length;\r\n            const useEffectCount = (content.match(/\\buseEffect\\b/g) || []).length;\r\n            const customHooks = (content.match(/\\buse[A-Z][A-Za-z0-9_]*/g) || []).filter(h => !/use(State|Effect|Memo|Callback|Ref|Context|Reducer)/.test(h));\r\n            const antdComponents = Array.from(new Set(((content.match(/<([A-Z][A-Za-z0-9]+)\\b/g) || []).map(m=>m.slice(1))).filter(n=>/^(Button|Table|Form|Modal|Input|Select|DatePicker|Tabs|Tag|Tooltip|Dropdown|Menu|Layout|Card|Space|Flex|Grid|Alert|Avatar|Badge)$/.test(n)))).sort();\r\n            const hasI18n = /\\bt\\(['\"][^)]*\\)/.test(content) || /i18n/.test(content);\r\n            const usesTailwind = /className=\"[^\"]*(flex|grid|px-|py-|text-|bg-|rounded|shadow)/.test(content);\r\n            const large = linesArr.length > 400;\r\n            const veryLarge = linesArr.length > 800;\r\n            const complexity: string[] = [];\r\n            if (large) complexity.push('taille>400');\r\n            if (veryLarge) complexity.push('taille>800');\r\n            if (hooksCount > 18) complexity.push('hooks>18');\r\n            if (useEffectCount > 7) complexity.push('useEffect>7');\r\n            const suggestions: string[] = [];\r\n            if (large) suggestions.push('Scinder en sous-composants logiques');\r\n            if (!hasI18n) suggestions.push('Internationaliser textes statiques');\r\n            if (!/Skeleton|Spin|isLoading/.test(content) && /api\\.(get|post|put|delete)/.test(content)) suggestions.push('Afficher \u00E9tat de chargement (Skeleton/Spin)');\r\n            if (!/ErrorBoundary|ErrorFallback/.test(content) && useEffectCount > 0) suggestions.push('Ajouter ErrorBoundary');\r\n            if (antdComponents.includes('Table') && !/pagination/i.test(content)) suggestions.push('Ajouter pagination / tri sur Table');\r\n            if (/dangerouslySetInnerHTML/.test(content)) suggestions.push('Sanitiser le contenu HTML (DOMPurify) pour \u00E9viter le XSS');\r\n            let score = 85; if (large) score -=5; if (veryLarge) score -=8; if (hooksCount>18) score -=5; if (!hasI18n) score -=4; score = Math.max(30, Math.min(95, score));\r\n            autoAnalysis.page = { path: pagePath, lines: linesArr.length, hooks: { total: hooksCount, useEffect: useEffectCount, custom: Array.from(new Set(customHooks)).slice(0,25) }, antd: antdComponents, i18n: hasI18n, tailwind: usesTailwind, complexity, suggestions: suggestions.slice(0,20), score };\r\n          } catch (e) { console.warn('[AI] Analyse page \u00E9chou\u00E9e:', (e as Error).message); }\r\n        }\r\n        // Feature aggregate\r\n        if (featureKey && featureMap && featureMap[featureKey]) {\r\n          try {\r\n            const def = featureMap[featureKey];\r\n            const files = [...(def.primaryPages||[]), ...(def.relatedServices||[])].filter(Boolean).slice(0,30);\r\n            let totalLines=0, totalHooks=0, i18nYes=0, antdYes=0, tailwindYes=0, count=0;\r\n            for (const f of files) {\r\n              const absF = path.join(process.cwd(),f);\r\n              if (!fs.existsSync(absF)) continue;\r\n              count++;\r\n              const content = fs.readFileSync(absF,'utf8');\r\n              const linesArr = content.split(/\\r?\\n/); totalLines += linesArr.length;\r\n              const hooksCount = (content.match(/\\buse(State|Effect|Memo|Callback|Ref|Context|Reducer)\\b/g) || []).length; totalHooks += hooksCount;\r\n              const hasI18n = /\\bt\\(['\"][^)]*\\)/.test(content) || /i18n/.test(content); if (hasI18n) i18nYes++;\r\n              if (/from ['\"]antd['\"]/g.test(content)) antdYes++;\r\n              if (/className=\"[^\"]*(flex|grid|px-|py-|text-|bg-|rounded|shadow)/.test(content)) tailwindYes++;\r\n            }\r\n            if (count) {\r\n              autoAnalysis.feature = { feature: featureKey, fileCount: count, totalLines, avgLines: Math.round(totalLines / count), totalHooks, i18nCoverage: i18nYes / count, antdUsageRate: antdYes / count, tailwindUsageRate: tailwindYes / count };\r\n            }\r\n          } catch (e) { console.warn('[AI] Analyse feature \u00E9chou\u00E9e:', (e as Error).message); }\r\n        }\r\n      }\r\n    } catch (e) { console.warn('[AI] Auto-analysis failed:', (e as Error).message); }\r\n\r\n    const memoryCombined = memoryString ? memoryString + (internalFunctionalContext ? '\\n'+internalFunctionalContext : '') : internalFunctionalContext;\r\n    // Fusionner \u00E9ventuelle analyse existante (fourni c\u00F4t\u00E9 client) et autoAnalysis\r\n    const mergedAnalysis = (() => {\r\n      if (analysis && autoAnalysis) return { client: analysis, auto: autoAnalysis };\r\n      if (autoAnalysis) return { auto: autoAnalysis };\r\n      if (analysis) return analysis;\r\n      return null;\r\n    })();\r\n  const prompt = buildChatPrompt({ message, context, conversationHistory, analysis: mergedAnalysis, memory: (memoryCombined + (codeContext ? '\\nCODE_CONTEXT:\\n'+codeContext.slice(0,6000) : '')).trim() });\r\n\r\n    // Appel service public\r\n  const serviceResp = await geminiSingleton.chat({ prompt });\r\n  const isLive = serviceResp.mode === 'live';\r\n  // En mode simul\u00E9, g\u00E9n\u00E9rer un mock contextuel local au lieu du message g\u00E9n\u00E9rique du service\r\n  const aiText = isLive ? (serviceResp.content || buildMockResponse(message, context as PromptContext)) : buildMockResponse(message, context as PromptContext);\r\n    let suggestions: string[] = [];\r\n    try {\r\n      suggestions = isLive ? deriveSuggestions(aiText) : defaultSuggestions();\r\n    } catch (sugErr) {\r\n      console.warn('\u26A0\uFE0F [AI] Erreur g\u00E9n\u00E9ration suggestions:', sugErr);\r\n      suggestions = defaultSuggestions();\r\n    }\r\n\r\n    const latency = Date.now() - t0;\r\n    // Pr\u00E9parer une version condens\u00E9e de l'analyse pour le frontend\r\n    let analysisPayload: unknown = null;\r\n    if (mergedAnalysis) {\r\n      try {\r\n        const str = JSON.stringify(mergedAnalysis);\r\n        if (str.length > 12000) {\r\n          analysisPayload = { truncated: true, size: str.length, excerpt: str.slice(0,6000) };\r\n        } else {\r\n          analysisPayload = mergedAnalysis;\r\n        }\r\n      } catch { analysisPayload = { error: 'serialization_failed' }; }\r\n    }\r\n    // Standardiser le champ data.analysis pour \u00E9viter de d\u00E9pendre du parsing markdown c\u00F4t\u00E9 client\r\n    const standardizedAnalysis = (() => {\r\n      // Si on a d\u00E9j\u00E0 une analyse c\u00F4t\u00E9 serveur (mergedAnalysis), la renvoyer (ou sa version tronqu\u00E9e)\r\n      if (analysisPayload) return analysisPayload;\r\n      // Sinon, fournir au minimum un squelette avec excerpt de la r\u00E9ponse AI\r\n      const minimal = { excerpt: aiText.slice(0, 1800) };\r\n      return { auto: minimal };\r\n    })();\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        response: aiText,\r\n        suggestions,\r\n        confidence: 0.92,\r\n        analysis: standardizedAnalysis,\r\n        metadata: {\r\n          model: isLive ? (process.env.GEMINI_MODEL || 'gemini-1.5-flash') : 'mock',\r\n          generatedAt: new Date().toISOString(),\r\n      latencyMs: latency,\r\n          mode: serviceResp.mode,\r\n          context: context?.currentPage || 'unknown',\r\n          fallbackError: serviceResp.error,\r\n          endpoint\r\n        }\r\n      }\r\n    });\r\n  void logAiUsage({\r\n      req,\r\n      endpoint,\r\n      success: true,\r\n      latencyMs: latency,\r\n      model: isLive ? (process.env.GEMINI_MODEL || 'gemini-1.5-flash') : 'mock',\r\n      mode: serviceResp.mode,\r\n      error: serviceResp.error ? String(serviceResp.error) : null,\r\n      extraMeta: {\r\n        conversationPreview: {\r\n          lastUserMessage: message.slice(0,200),\r\n          aiResponse: aiText.slice(0,200),\r\n          suggestions,\r\n          memoryUsed: !!memoryString,\r\n          memoryChars: memoryString.length\r\n        }\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur route ${endpoint}:`, error);\r\n    res.status(500).json({ success: false, error: `Erreur IA (${endpoint})`, details: (error as Error).message });\r\n  void logAiUsage({ req, endpoint, success: false, latencyMs: Date.now() - t0, model: null, mode: null, error: (error as Error).message });\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83D\uDCC5 POST /api/ai/schedule-recommendations\r\n * G\u00E9n\u00E8re des recommandations de cr\u00E9neaux intelligentes\r\n */\r\nrouter.post('/schedule-recommendations', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    const { leadId, targetDate, preferences, constraints } = req.body;\r\n    \r\n    console.log('\uD83D\uDCC5 [AI] G\u00E9n\u00E9ration recommandations planning pour lead:', leadId);\r\n    console.log('\uD83D\uDCC6 [AI] Date cible:', targetDate);\r\n    console.log('\u2699\uFE0F [AI] Pr\u00E9f\u00E9rences:', preferences);\r\n    console.log('\uD83D\uDEAB [AI] Contraintes:', constraints);\r\n    \r\n    // Simulation de recommandations intelligentes (\u00E0 remplacer par l'API Gemini)\r\n    const mockRecommendations = [\r\n      {\r\n        id: 'rec-1',\r\n        type: 'optimal',\r\n        datetime: new Date(Date.now() + 24 * 60 * 60 * 1000), // Demain\r\n        duration: 60,\r\n        confidence: 0.92,\r\n        reasoning: \"Cr\u00E9neau optimal bas\u00E9 sur l'historique des rendez-vous r\u00E9ussis\",\r\n        priority: 'high',\r\n        metadata: {\r\n          leadScore: 85,\r\n          bestTimeWindow: '09:00-11:00',\r\n          sectoralInsight: 'Les prospects B2B r\u00E9pondent mieux le matin'\r\n        }\r\n      },\r\n      {\r\n        id: 'rec-2',\r\n        type: 'alternative',\r\n        datetime: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000), // Apr\u00E8s-demain\r\n        duration: 45,\r\n        confidence: 0.78,\r\n        reasoning: \"Alternative solide avec disponibilit\u00E9 confirm\u00E9e\",\r\n        priority: 'medium',\r\n        metadata: {\r\n          leadScore: 85,\r\n          bestTimeWindow: '14:00-16:00',\r\n          sectoralInsight: 'Bon taux de conversion en d\u00E9but d\\'apr\u00E8s-midi'\r\n        }\r\n      },\r\n      {\r\n        id: 'rec-3',\r\n        type: 'backup',\r\n        datetime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000), // Dans 3 jours\r\n        duration: 30,\r\n        confidence: 0.65,\r\n        reasoning: \"Option de secours si les autres cr\u00E9neaux ne conviennent pas\",\r\n        priority: 'low',\r\n        metadata: {\r\n          leadScore: 85,\r\n          bestTimeWindow: '16:00-17:00',\r\n          sectoralInsight: 'Fin de journ\u00E9e acceptable pour ce secteur'\r\n        }\r\n      }\r\n    ];\r\n    \r\n    // D\u00E9lai simul\u00E9 pour l'API\r\n    await new Promise(resolve => setTimeout(resolve, 800));\r\n    \r\n  const latency = Date.now() - t0;\r\n  res.json({\r\n      success: true,\r\n      data: {\r\n        recommendations: mockRecommendations,\r\n        totalOptions: mockRecommendations.length,\r\n        analysisDate: new Date().toISOString(),\r\n        metadata: {\r\n          leadId,\r\n          targetDate,\r\n          analysisModel: \"gemini-pro-scheduling\",\r\n          factors: [\r\n            \"Historique des rendez-vous\",\r\n            \"Pr\u00E9f\u00E9rences du lead\",\r\n            \"Analyse sectorielle\",\r\n            \"Optimisation conversion\"\r\n          ]\r\n        }\r\n      }\r\n    });\r\n  void logAiUsage({ req, endpoint: 'schedule-recommendations', success: true, latencyMs: latency, model: 'mock', mode: 'mock' });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C Erreur route schedule-recommendations:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration des recommandations',\r\n      details: error.message\r\n    });\r\n  void logAiUsage({ req, endpoint: 'schedule-recommendations', success: false, latencyMs: Date.now() - t0, model: null, mode: null, error: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDDD3\uFE0F POST /api/ai/schedule-explain\r\n * Fournit une explication IA (ou mock) d'une s\u00E9lection de cr\u00E9neaux propos\u00E9s / choisis.\r\n * Body: { slots: [{ start: string, end: string }], objective?: string, lead?: { name?: string, sector?: string } }\r\n */\r\nrouter.post('/schedule-explain', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    const { slots = [], objective = 'planifier un rendez-vous', lead = {} } = req.body || {};\r\n    if (!Array.isArray(slots) || slots.length === 0) {\r\n      return res.status(400).json({ success: false, error: 'Aucun cr\u00E9neau fourni' });\r\n    }\r\n    const norm = slots.slice(0,6).map((s) => ({ start: s.start, end: s.end }));\r\n    const prompt = `Analyse les cr\u00E9neaux suivants pour ${objective} avec le lead ${lead.name || 'inconnu'} (${lead.sector || 'secteur standard'}).\r\nCr\u00E9neaux ISO:\r\n${norm.map((c,i)=>`#${i+1} ${c.start} -> ${c.end}`).join('\\n')}\r\nT\u00E2ches:\r\n1. Identifier le meilleur cr\u00E9neau (justifier).\r\n2. Donner 3 facteurs cl\u00E9s (brefs).\r\n3. Indiquer si un autre cr\u00E9neau serait \u00E0 \u00E9viter.\r\nR\u00E9ponds en fran\u00E7ais concis (<=110 mots).`;\r\n    const serviceResp = await geminiSingleton.chat({ prompt });\r\n    const explanation = serviceResp.content || 'Analyse simul\u00E9e: cr\u00E9neau central recommand\u00E9 pour maximiser disponibilit\u00E9 et \u00E9nergie.';\r\n  const latency = Date.now() - t0;\r\n  res.json({\r\n      success: true,\r\n      data: {\r\n        explanation,\r\n        mode: serviceResp.mode,\r\n        model: serviceResp.mode === 'live' ? (process.env.GEMINI_MODEL || 'gemini-1.5-flash') : 'mock',\r\n    latencyMs: latency,\r\n        slots: norm,\r\n        fallbackError: serviceResp.error\r\n      }\r\n    });\r\n  void logAiUsage({ req, endpoint: 'schedule-explain', success: true, latencyMs: latency, model: serviceResp.mode === 'live' ? (process.env.GEMINI_MODEL || 'gemini-1.5-flash') : 'mock', mode: serviceResp.mode, error: serviceResp.error ? String(serviceResp.error) : null });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route schedule-explain:', error);\r\n  res.status(500).json({ success: false, error: 'Erreur explication planning', details: (error as Error).message });\r\n  void logAiUsage({ req, endpoint: 'schedule-explain', success: false, latencyMs: Date.now() - t0, model: null, mode: null, error: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83C\uDFAF POST /api/ai/analyze-conversation\r\n * Analyse une conversation vocale transcrite\r\n */\r\nrouter.post('/analyze-conversation', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    const { transcription, context, speakers } = req.body;\r\n    \r\n    console.log('\uD83C\uDFAF [AI] Analyse conversation vocale');\r\n    console.log('\uD83D\uDCDD [AI] Transcription longueur:', transcription?.length || 0, 'caract\u00E8res');\r\n    console.log('\uD83C\uDFAF [AI] Contexte:', context);\r\n    console.log('\uD83D\uDC65 [AI] Interlocuteurs:', speakers?.length || 0);\r\n    \r\n    // Simulation d'analyse de conversation\r\n    const mockAnalysis = {\r\n      sentiment: {\r\n        overall: 'positive',\r\n        score: 0.75,\r\n        confidence: 0.88\r\n      },\r\n      keyPoints: [\r\n        \"Int\u00E9r\u00EAt exprim\u00E9 pour la solution\",\r\n        \"Questions sur les prix\",\r\n        \"Demande de d\u00E9monstration\"\r\n      ],\r\n      actionItems: [\r\n        \"Envoyer proposition commerciale\",\r\n        \"Planifier d\u00E9monstration produit\",\r\n        \"Suivre dans 3 jours\"\r\n      ],\r\n      leadScore: 78,\r\n      nextSteps: [\r\n        {\r\n          action: \"send_proposal\",\r\n          priority: \"high\",\r\n          deadline: new Date(Date.now() + 24 * 60 * 60 * 1000)\r\n        },\r\n        {\r\n          action: \"schedule_demo\",\r\n          priority: \"medium\",\r\n          deadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000)\r\n        }\r\n      ]\r\n    };\r\n    \r\n  const latency = Date.now() - t0;\r\n  res.json({\r\n      success: true,\r\n      data: mockAnalysis\r\n    });\r\n  void logAiUsage({ req, endpoint: 'analyze-conversation', success: true, latencyMs: latency, model: 'mock', mode: 'mock' });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C Erreur route analyze-conversation:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'analyse de la conversation',\r\n      details: error.message\r\n    });\r\n  void logAiUsage({ req, endpoint: 'analyze-conversation', success: false, latencyMs: Date.now() - t0, model: null, mode: null, error: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDEA GET /api/ai/test\r\n * Route de test pour v\u00E9rifier la connexion IA\r\n */\r\nrouter.get('/test', async (req, res) => {\r\n  try {\r\n    console.log('\uD83E\uDDEA [AI] Test de connexion IA');\r\n    \r\n    res.json({\r\n      success: true,\r\n      message: 'Service IA op\u00E9rationnel',\r\n      timestamp: new Date().toISOString(),\r\n      features: [\r\n        'G\u00E9n\u00E9ration de r\u00E9ponses',\r\n        'Recommandations de planning',\r\n        'Analyse de conversations',\r\n        'Assistant vocal'\r\n      ]\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur test IA:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors du test IA',\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u2699\uFE0F GET /api/ai/status\r\n * Expose l'\u00E9tat courant (live/mock) pour le frontend.\r\n */\r\nrouter.get('/status', async (_req, res) => {\r\n  try {\r\n  // @ts-expect-error acc\u00E8s method optionnel au runtime\r\n    const status = geminiSingleton.getStatus?.() || { mode: geminiSingleton.isLive() ? 'live':'mock' };\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        ...status,\r\n        aiModeFlag: process.env.AI_MODE || 'auto',\r\n        timestamp: new Date().toISOString()\r\n      }\r\n    });\r\n  } catch (error) {\r\n    res.status(500).json({ success: false, error: 'Erreur status IA', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCE6 GET /api/ai/context/summary\r\n * R\u00E9sum\u00E9 contextuel l\u00E9ger pour alimenter l'assistant (R1). Limite volontaire pour rester < token budget.\r\n * Fournit: user, organization, modules actifs, 5 leads r\u00E9cents, 5 prochains \u00E9v\u00E9nements.\r\n */\r\nrouter.get('/context/summary', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    const authReq = req as unknown as AuthenticatedRequest;\r\n    const orgId = authReq.user?.organizationId || null;\r\n    const userId = authReq.user?.userId || null;\r\n    const fieldsParam = (req.query.fields as string | undefined)?.toLowerCase();\r\n    // Par d\u00E9faut on retourne tout (modules, leads, events) \u2013 permet backward compatibility\r\n    const wanted = new Set((fieldsParam ? fieldsParam.split(',') : ['modules','leads','events']).map(s=>s.trim()).filter(Boolean));\r\n    if (!userId) return res.status(401).json({ success: false, error: 'Non authentifi\u00E9' });\r\n    if (!orgId) {\r\n      return res.json({\r\n        success: true,\r\n        data: {\r\n      user: { id: userId, role: authReq.user?.role, superAdmin: authReq.user?.isSuperAdmin },\r\n          organization: null,\r\n      modules: wanted.has('modules') ? [] : undefined,\r\n      leads: wanted.has('leads') ? [] : undefined,\r\n      upcomingEvents: wanted.has('events') ? [] : undefined,\r\n      meta: { generatedAt: new Date().toISOString(), orgContext: false, version: 1, filtered: Array.from(wanted) }\r\n        }\r\n      });\r\n    }\r\n\r\n    // Requ\u00EAtes parall\u00E8les minimales\r\n    const [organization, moduleStatuses, leads, events] = await Promise.all([\r\n  prisma.organization.findUnique({ where: { id: orgId }, select: { id: true, name: true } }),\r\n  wanted.has('modules') ? prisma.organizationModuleStatus.findMany({\r\n        where: { organizationId: orgId, active: true },\r\n        include: { Module: { select: { key: true, feature: true, label: true, route: true, description: true } } },\r\n        orderBy: { createdAt: 'asc' }\r\n  }) : Promise.resolve([]),\r\n  wanted.has('leads') ? prisma.lead.findMany({\r\n        where: { organizationId: orgId },\r\n        orderBy: { updatedAt: 'desc' },\r\n        take: 5,\r\n        select: {\r\n          id: true, firstName: true, lastName: true, company: true, status: true,\r\n          nextFollowUpDate: true, updatedAt: true, assignedToId: true\r\n        }\r\n  }) : Promise.resolve([]),\r\n  wanted.has('events') ? prisma.calendarEvent.findMany({\r\n        where: { organizationId: orgId, startDate: { gte: new Date() } },\r\n        orderBy: { startDate: 'asc' },\r\n        take: 5,\r\n        select: { id: true, title: true, startDate: true, endDate: true, type: true, status: true, linkedLeadId: true, ownerId: true }\r\n  }) : Promise.resolve([])\r\n    ]);\r\n\r\n    const modules = moduleStatuses.map(ms => ({\r\n      key: ms.Module.key,\r\n      feature: ms.Module.feature,\r\n      label: ms.Module.label,\r\n      route: ms.Module.route,\r\n      description: ms.Module.description\r\n    }));\r\n\r\n  const latency = Date.now() - t0;\r\n  res.json({\r\n      success: true,\r\n      data: {\r\n  user: { id: userId, role: authReq.user?.role, superAdmin: authReq.user?.isSuperAdmin },\r\n  organization,\r\n  modules: wanted.has('modules') ? modules : undefined,\r\n  leads: wanted.has('leads') ? leads : undefined,\r\n  upcomingEvents: wanted.has('events') ? events : undefined,\r\n  meta: { generatedAt: new Date().toISOString(), counts: { modules: modules.length, leads: leads.length, events: events.length }, version: 1, filtered: Array.from(wanted) }\r\n      }\r\n    });\r\n  void logAiUsage({ req, endpoint: 'context-summary', success: true, latencyMs: latency, model: 'internal', mode: 'context' });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur /api/ai/context/summary:', error);\r\n  res.status(500).json({ success: false, error: 'Erreur r\u00E9cup\u00E9ration contexte IA', details: (error as Error).message });\r\n  void logAiUsage({ req, endpoint: 'context-summary', success: false, latencyMs: Date.now() - t0, model: null, mode: 'context', error: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD0D GET /api/ai/context/lead/:id\r\n * Contexte d\u00E9taill\u00E9 d'un lead (R2). Inclut m\u00E9ta, derniers appels / messages, prochains \u00E9v\u00E9nements, timeline r\u00E9cente.\r\n */\r\nrouter.get('/context/lead/:id', async (req: AuthenticatedRequest, res) => {\r\n  const leadId = req.params.id;\r\n  const user = req.user;\r\n  const orgId = user?.organizationId || null;\r\n  const isSuperAdmin = user?.isSuperAdmin || false;\r\n  \r\n  // Pour les SuperAdmins, pas besoin d'organisationId\r\n  if (!orgId && !isSuperAdmin) {\r\n    return res.status(400).json({ success: false, error: 'Organisation requise' });\r\n  }\r\n  \r\n  const t0 = Date.now();\r\n  try {\r\n    const fieldsParam = (req.query.fields as string | undefined)?.toLowerCase();\r\n    const wanted = new Set((fieldsParam ? fieldsParam.split(',') : ['calls','messages','events','timeline']).map(s=>s.trim()).filter(Boolean));\r\n    \r\n    // Construire la condition where selon les permissions\r\n    const whereCondition = isSuperAdmin ? \r\n      { id: leadId } : \r\n      { id: leadId, organizationId: orgId };\r\n    \r\n    const lead = await prisma.lead.findFirst({\r\n      where: whereCondition,\r\n      select: {\r\n        id: true, firstName: true, lastName: true, company: true, email: true, phone: true,\r\n        status: true, source: true, nextFollowUpDate: true, updatedAt: true, createdAt: true,\r\n        assignedToId: true, notes: true, organizationId: true\r\n      }\r\n    });\r\n    if (!lead) return res.status(404).json({ success: false, error: 'Lead introuvable' });\r\n\r\n    // Utiliser l'organizationId du lead pour les requ\u00EAtes li\u00E9es\r\n    const leadOrgId = lead.organizationId;\r\n\r\n    const [calls, messages, upcomingEvents, timeline] = await Promise.all([\r\n      wanted.has('calls') ? prisma.telnyxCall.findMany({\r\n        where: { leadId, organizationId: leadOrgId },\r\n        orderBy: { startedAt: 'desc' },\r\n        take: 5,\r\n        select: { id: true, direction: true, status: true, duration: true, startedAt: true }\r\n      }) : Promise.resolve([]),\r\n      wanted.has('messages') ? prisma.telnyxMessage.findMany({\r\n        where: { leadId, organizationId: leadOrgId },\r\n        orderBy: { sentAt: 'desc' },\r\n        take: 5,\r\n        select: { id: true, direction: true, type: true, status: true, sentAt: true, text: true }\r\n      }) : Promise.resolve([]),\r\n      wanted.has('events') ? prisma.calendarEvent.findMany({\r\n        where: { linkedLeadId: leadId, organizationId: leadOrgId, startDate: { gte: new Date() } },\r\n        orderBy: { startDate: 'asc' },\r\n        take: 3,\r\n        select: { id: true, title: true, startDate: true, endDate: true, type: true, status: true }\r\n      }) : Promise.resolve([]),\r\n      wanted.has('timeline') ? prisma.timelineEvent.findMany({\r\n        where: { leadId, organizationId: leadOrgId },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: 8,\r\n        select: { id: true, eventType: true, createdAt: true }\r\n      }) : Promise.resolve([])\r\n    ]);\r\n\r\n    // Score heuristique (simplifi\u00E9) pour priorisation IA\r\n    const activityScore = calls.length * 2 + messages.length + (upcomingEvents.length * 3);\r\n\r\n  const latency = Date.now() - t0;\r\n  res.json({\r\n      success: true,\r\n      data: {\r\n        lead,\r\n        calls: wanted.has('calls') ? calls : undefined,\r\n        messages: wanted.has('messages') ? messages : undefined,\r\n        upcomingEvents: wanted.has('events') ? upcomingEvents : undefined,\r\n        timeline: wanted.has('timeline') ? timeline : undefined,\r\n        metrics: { activityScore },\r\n        meta: { generatedAt: new Date().toISOString(), version: 1, filtered: Array.from(wanted) }\r\n      }\r\n    });\r\n  void logAiUsage({ req, endpoint: 'context-lead', success: true, latencyMs: latency, model: 'internal', mode: 'context' });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur /api/ai/context/lead/:id', error);\r\n  res.status(500).json({ success: false, error: 'Erreur contexte lead', details: (error as Error).message });\r\n  void logAiUsage({ req, endpoint: 'context-lead', success: false, latencyMs: Date.now() - t0, model: null, mode: 'context', error: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCE6 GET /api/ai/context/leads (batch) ?ids=id1,id2&id2\r\n * Limit\u00E9 \u00E0 10 IDs pour \u00E9viter surcharge.\r\n */\r\nrouter.get('/context/leads', async (req: AuthenticatedRequest, res) => {\r\n  const user = req.user;\r\n  const orgId = user?.organizationId || null;\r\n  const isSuperAdmin = user?.isSuperAdmin || false;\r\n  \r\n  // Pour les SuperAdmins, pas besoin d'organisationId\r\n  if (!orgId && !isSuperAdmin) {\r\n    return res.status(400).json({ success: false, error: 'Organisation requise' });\r\n  }\r\n  const idsParam = (req.query.ids as string | undefined) || '';\r\n  const ids = Array.from(new Set(idsParam.split(',').map(s=>s.trim()).filter(Boolean))).slice(0,10);\r\n  if (!ids.length) return res.status(400).json({ success: false, error: 'Param\u00E8tre ids requis' });\r\n  const t0 = Date.now();\r\n  try {\r\n    // Construire la condition where selon les permissions\r\n    const whereCondition = isSuperAdmin ? \r\n      { id: { in: ids } } : \r\n      { id: { in: ids }, organizationId: orgId };\r\n      \r\n    const leads = await prisma.lead.findMany({\r\n      where: whereCondition,\r\n      select: { id: true, firstName: true, lastName: true, company: true, status: true, updatedAt: true, nextFollowUpDate: true }\r\n    });\r\n    const latency = Date.now() - t0;\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        count: leads.length,\r\n        leads,\r\n        missing: ids.filter(id => !leads.some(l => l.id === id)),\r\n        meta: { generatedAt: new Date().toISOString(), version: 1 }\r\n      }\r\n    });\r\n  void logAiUsage({ req, endpoint: 'context-leads-batch', success: true, latencyMs: latency, model: 'internal', mode: 'context' });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur /api/ai/context/leads (batch)', error);\r\n    res.status(500).json({ success: false, error: 'Erreur contexte leads batch', details: (error as Error).message });\r\n  void logAiUsage({ req, endpoint: 'context-leads-batch', success: false, latencyMs: Date.now() - t0, model: null, mode: 'context', error: (error as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDE0 POST /api/ai/ultimate-recommendation\r\n * G\u00E9n\u00E8re une analyse ultime et intelligente pour proposer la meilleure date de RDV\r\n */\r\nrouter.post('/ultimate-recommendation', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    const { lead, context } = req.body;\r\n    \r\n    console.log('\uD83E\uDDE0 [AI Ultimate] Analyse pour:', lead.name);\r\n    console.log('\uD83D\uDCCA [AI Ultimate] RDV existants:', context.existingAppointments?.length || 0);\r\n    console.log('\uD83D\uDCDE [AI Ultimate] Transcriptions:', context.callTranscriptions?.length || 0);\r\n    console.log('\uD83D\uDCDD [AI Ultimate] Notes:', context.notes?.length || 0);\r\n    \r\n    // Simulation d'analyse intelligente bas\u00E9e sur l'exp\u00E9rience commerciale mondiale\r\n    const mockAnalysis = {\r\n      // Analyse des patterns comportementaux\r\n      behavioralPattern: analyzeCallBehavior(context.callTranscriptions),\r\n      // Optimisation g\u00E9ographique des d\u00E9placements\r\n      geographicalOptimization: optimizeGeography(context.existingAppointments, lead),\r\n      // Insights sectoriels \r\n      sectoralInsights: getSectoralInsights(lead.sector),\r\n      // Exp\u00E9rience commerciale accumul\u00E9e\r\n      commercialWisdom: getCommercialWisdom(lead, context)\r\n    };\r\n\r\n    // Calcul de la date optimale\r\n    const optimalDate = calculateOptimalDate(mockAnalysis, context);\r\n    \r\n    const ultimateRecommendation = {\r\n      proposedDate: optimalDate,\r\n      reasoning: `\uD83D\uDCCA **ANALYSE COMMERCIALE EXPERTE** \r\n\r\n\uD83C\uDFAF **Date recommand\u00E9e**: ${optimalDate.toLocaleDateString('fr-FR', { \r\n        weekday: 'long', \r\n        year: 'numeric', \r\n        month: 'long', \r\n        day: 'numeric',\r\n        hour: '2-digit',\r\n        minute: '2-digit'\r\n      })}\r\n\r\n\uD83D\uDCA1 **Justification strat\u00E9gique**:\r\n${mockAnalysis.commercialWisdom.primaryReason}\r\n\r\n\uD83D\uDD0D **Facteurs analys\u00E9s**:\r\n\u2022 **Historique comportemental**: ${mockAnalysis.behavioralPattern}\r\n\u2022 **Optimisation trajets**: ${mockAnalysis.geographicalOptimization}  \r\n\u2022 **Intelligence sectorielle**: ${mockAnalysis.sectoralInsights}\r\n\u2022 **Exp\u00E9rience terrain**: ${mockAnalysis.commercialWisdom.experience}\r\n\r\n\u26A1 **Pourquoi cette date maximise vos chances**:\r\n${mockAnalysis.commercialWisdom.successFactors.join('\\n\u2022 ')}\r\n\r\n\uD83C\uDFAF **Taux de r\u00E9ussite estim\u00E9**: ${mockAnalysis.commercialWisdom.successRate}%`,\r\n      \r\n      confidence: mockAnalysis.commercialWisdom.confidence,\r\n      factors: {\r\n        callHistory: mockAnalysis.behavioralPattern,\r\n        notes: `${context.notes?.length || 0} notes analys\u00E9es`,\r\n        geographicalOptimization: mockAnalysis.geographicalOptimization,\r\n        behavioralPattern: \"Pattern de r\u00E9ceptivit\u00E9 d\u00E9tect\u00E9\",\r\n        sectoralInsight: mockAnalysis.sectoralInsights,\r\n        commercialExperience: mockAnalysis.commercialWisdom.experience\r\n      },\r\n      alternatives: [\r\n        {\r\n          date: new Date(optimalDate.getTime() + 24 * 60 * 60 * 1000),\r\n          reason: \"Alternative si conflit de derni\u00E8re minute\"\r\n        },\r\n        {\r\n          date: new Date(optimalDate.getTime() + 48 * 60 * 60 * 1000), \r\n          reason: \"Option de repli avec tr\u00E8s bon potentiel\"\r\n        }\r\n      ]\r\n    };\r\n\r\n    // D\u00E9lai simul\u00E9 pour l'analyse complexe\r\n    await new Promise(resolve => setTimeout(resolve, 1500));\r\n\r\n  const latency = Date.now() - t0;\r\n  res.json({\r\n      success: true,\r\n      data: {\r\n        recommendation: ultimateRecommendation,\r\n        analysisMetadata: {\r\n          processingTime: \"1.2s\",\r\n          factorsAnalyzed: 127,\r\n          dataPoints: context.callTranscriptions?.length * 15 + context.notes?.length * 8,\r\n          confidenceLevel: \"Tr\u00E8s \u00E9lev\u00E9\"\r\n        }\r\n      }\r\n    });\r\n  void logAiUsage({ req, endpoint: 'ultimate-recommendation', success: true, latencyMs: latency, model: 'mock', mode: 'analysis' });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C Erreur route ultimate-recommendation:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'analyse ultime',\r\n      details: error.message\r\n    });\r\n  void logAiUsage({ req, endpoint: 'ultimate-recommendation', success: false, latencyMs: Date.now() - t0, model: null, mode: 'analysis', error: (error as Error).message });\r\n  }\r\n});\r\n\r\n// Fonctions d'analyse (simulation d'IA avanc\u00E9e)\r\nfunction analyzeCallBehavior(transcriptions) {\r\n  if (!transcriptions?.length) return \"Aucun historique d'appel \u00E0 analyser\";\r\n  \r\n  // Simulation d'analyse des patterns de communication\r\n  return `${transcriptions.length} appels analys\u00E9s - R\u00E9ceptivit\u00E9 optimale d\u00E9tect\u00E9e en matin\u00E9e`;\r\n}\r\n\r\nfunction optimizeGeography(appointments: { startDate?: Date }[] | undefined) {\r\n  if (!appointments?.length) return \"Premier RDV dans le secteur\";\r\n  \r\n  // Simulation d'optimisation g\u00E9ographique\r\n  return `Optimisation trajets: 23 min \u00E9conomis\u00E9es vs planning classique`;\r\n}\r\n\r\nfunction getSectoralInsights(sector) {\r\n  const insights = {\r\n    'technology': \"Secteur tech: +47% de conversion en d\u00E9but de semaine\",\r\n    'healthcare': \"Sant\u00E9: \u00C9viter vendredi apr\u00E8s-midi (-23% taux r\u00E9ponse)\",\r\n    'finance': \"Finance: Mardi-Jeudi matin optimal (+31% signature)\",\r\n    'retail': \"Commerce: Lundi/Mardi hors p\u00E9riodes saisonni\u00E8res\",\r\n    'default': \"Secteur standard: Mardi-Jeudi 9h-11h optimaux\"\r\n  };\r\n  \r\n  return insights[sector] || insights['default'];\r\n}\r\n\r\nfunction getCommercialWisdom(lead: { name?: string }) {\r\n  return {\r\n    primaryReason: `Cr\u00E9neau optimal identifi\u00E9 gr\u00E2ce \u00E0 l'analyse de 50,000+ RDV commerciaux similaires. Cette plage horaire pr\u00E9sente 67% de taux de conversion sup\u00E9rieur pour le profil \"${lead.name}\".`,\r\n    \r\n    experience: \"15 ans d'exp\u00E9rience commerciale B2B analys\u00E9e\",\r\n    \r\n    successFactors: [\r\n      \"Moment de r\u00E9ceptivit\u00E9 maximale selon le profil comportemental\",\r\n      \"Absence de conflits avec les pics de charge du prospect\", \r\n      \"Timing optimal pour la prise de d\u00E9cision dans ce secteur\",\r\n      \"Fen\u00EAtre de disponibilit\u00E9 mentale favorable (post-caff\u00E9, pr\u00E9-rush)\"\r\n    ],\r\n    \r\n    successRate: Math.floor(75 + Math.random() * 20), // 75-95%\r\n    confidence: 0.89\r\n  };\r\n}\r\n\r\nfunction calculateOptimalDate() {\r\n  // Simulation de calcul intelligent de date\r\n  const baseDate = new Date();\r\n  baseDate.setDate(baseDate.getDate() + 2); // Dans 2 jours par d\u00E9faut\r\n  baseDate.setHours(10, 0, 0, 0); // 10h optimal pour B2B\r\n  \r\n  // \u00C9viter les vendredis apr\u00E8s-midi et lundis matin\r\n  if (baseDate.getDay() === 5 && baseDate.getHours() > 14) {\r\n    baseDate.setDate(baseDate.getDate() + 3); // Reporter au lundi\r\n    baseDate.setHours(10, 0, 0, 0);\r\n  }\r\n  \r\n  if (baseDate.getDay() === 1 && baseDate.getHours() < 10) {\r\n    baseDate.setHours(10, 0, 0, 0); // Pas avant 10h le lundi\r\n  }\r\n  \r\n  return baseDate;\r\n}\r\n\r\n/**\r\n * \uD83D\uDCC8 GET /api/ai/usage/recent\r\n * R\u00E9cup\u00E8re les derniers logs d'usage IA (non sensible). Filtrage basique.\r\n * Query: limit (1-200, d\u00E9faut 30), type, success (true/false)\r\n */\r\nrouter.get('/usage/recent', async (req, res) => {\r\n  const t0 = Date.now();\r\n  try {\r\n    await ensureAiUsageLogTable();\r\n    const rawLimit = parseInt(String(req.query.limit || '30'), 10);\r\n    const limit = Math.min(200, Math.max(1, isNaN(rawLimit) ? 30 : rawLimit));\r\n    const type = typeof req.query.type === 'string' ? req.query.type : undefined;\r\n    const successFilter = typeof req.query.success === 'string' ? req.query.success === 'true' : undefined;\r\n    // Pr\u00E9paration filtre Prisma si mod\u00E8le disponible\r\n  interface RawLogMeta { endpoint?: string; mode?: string; [k: string]: unknown }\r\n  interface RawLog { id: string; type: string; model?: string | null; tokensPrompt?: number | null; tokensOutput?: number | null; latencyMs?: number | null; success: boolean; errorCode?: string | null; errorMessage?: string | null; createdAt: Date; meta?: RawLogMeta | null }\r\n  let logs: RawLog[] = [];\r\n    let usedPrisma = false;\r\n    try {\r\n      if (prisma.aiUsageLog) {\r\n        logs = await prisma.aiUsageLog.findMany({\r\n          where: {\r\n            ...(type ? { type } : {}),\r\n            ...(successFilter !== undefined ? { success: successFilter } : {})\r\n          },\r\n            orderBy: { createdAt: 'desc' },\r\n            take: limit,\r\n          select: {\r\n            id: true, type: true, model: true, tokensPrompt: true, tokensOutput: true,\r\n            latencyMs: true, success: true, errorCode: true, errorMessage: true,\r\n            createdAt: true, meta: true\r\n          }\r\n        });\r\n        usedPrisma = true;\r\n      }\r\n    } catch (e) {\r\n      console.warn('\u26A0\uFE0F Lecture via Prisma aiUsageLog \u00E9chou\u00E9e, fallback SQL:', (e as Error).message);\r\n    }\r\n    if (!usedPrisma) {\r\n      // Fallback SQL brut (meta JSONB -> text)\r\n      const conditions: string[] = [];\r\n  const params: unknown[] = [];\r\n      let idx = 1;\r\n      if (type) { conditions.push(`type = $${idx++}`); params.push(type); }\r\n      if (successFilter !== undefined) { conditions.push(`success = $${idx++}`); params.push(successFilter); }\r\n      const where = conditions.length ? 'WHERE ' + conditions.join(' AND ') : '';\r\n      const sql = `SELECT id, type, model, \"tokensPrompt\", \"tokensOutput\", \"latencyMs\", success, \"errorCode\", \"errorMessage\", \"createdAt\", meta FROM \"AiUsageLog\" ${where} ORDER BY \"createdAt\" DESC LIMIT ${limit}`;\r\n      // @ts-expect-error raw\r\n      logs = await prisma.$queryRawUnsafe(sql, ...params);\r\n    }\r\n    // Stats rapides\r\n    const total = logs.length;\r\n    const successCount = logs.filter(l => l.success).length;\r\n    const avgLatency = logs.length ? Math.round(logs.reduce((s,l)=> s + (l.latencyMs || 0),0)/logs.length) : 0;\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        logs: logs.map(l => ({\r\n          id: l.id,\r\n          type: l.type,\r\n          endpoint: l.meta?.endpoint || undefined,\r\n          mode: l.meta?.mode || undefined,\r\n          model: l.model,\r\n          latencyMs: l.latencyMs,\r\n          tokensPrompt: l.tokensPrompt ?? l.tokens_prompt ?? 0,\r\n          tokensOutput: l.tokensOutput ?? l.tokens_output ?? 0,\r\n          success: l.success,\r\n          errorCode: l.errorCode || l.error_code || undefined,\r\n          errorMessage: l.errorMessage || l.error_message || undefined,\r\n          createdAt: l.createdAt,\r\n        })),\r\n        meta: {\r\n          count: total,\r\n          successRate: total ? +(successCount / total * 100).toFixed(1) : 0,\r\n          avgLatencyMs: avgLatency,\r\n          filtered: { type: type || null, success: successFilter ?? null },\r\n          generatedAt: new Date().toISOString(),\r\n          durationMs: Date.now() - t0\r\n        }\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur /api/ai/usage/recent:', error);\r\n    res.status(500).json({ success: false, error: 'Erreur r\u00E9cup\u00E9ration logs IA', details: (error as Error).message });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import express from 'express';\r\nimport { authenticateToken } from '../middleware/auth';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\nimport crypto from 'crypto';\r\n\r\n// Routeur exploration code pour coach IA (SuperAdmin seulement)\r\n// Endpoints:\r\n//  GET /api/ai/code/tree?path=src/pages&depth=2\r\n//  GET /api/ai/code/file?path=src/routes/ai.ts&offset=0&limit=400\r\n//  GET /api/ai/code/search?q=gmail&path=src&max=25\r\n//  GET /api/ai/code/summary?path=src/routes/ai.ts\r\n//  GET /api/ai/code/diff?old=src/routes/ai.ts&new=src/routes/index.ts\r\n//  GET /api/ai/code/recent\r\n\r\nconst router = express.Router();\r\nrouter.use(authenticateToken);\r\n\r\nconst ALLOWED_ROOTS = ['src', 'prisma'];\r\nconst REPO_ROOT = process.cwd().replace(/\\\\/g, '/');\r\nconst MAX_FILE_LINES_RETURN = 800;\r\nconst MAX_FILE_SIZE_BYTES = 400 * 1024; // 400KB\r\n\r\ninterface RecentEntry { path: string; at: number; lines?: number; hash?: string }\r\nconst RECENT_FILES: RecentEntry[] = [];\r\n// Cache simple en m\u00E9moire des analyses (TTL 60s)\r\ninterface Cached<T> { ts: number; data: T }\r\ninterface AnalyzeSummary {\r\n  path: string;\r\n  lines: number;\r\n  jsx?: boolean;\r\n  exports?: { named: string[]; hasDefault: boolean };\r\n  dependencies?: { external: string[]; internal: string[] };\r\n  antdComponents?: string[];\r\n  hooks?: { total: number; useEffect: number; custom: string[] };\r\n  signals?: { complexity: string[]; missing: string[] };\r\n  jsxStructure?: { maxDepth: number; tagCount: number; densityPer100Lines: number } | null;\r\n  metrics?: { score: number; heuristic: string };\r\n  risks?: { code: string; severity: 'low'|'medium'|'high'; detail: string }[];\r\n  suggestions?: string[];\r\n  notes?: string;\r\n  i18n?: boolean;\r\n}\r\nconst ANALYZE_CACHE: Record<string, Cached<AnalyzeSummary>> = {};\r\nconst ANALYZE_TTL_MS = 60_000;\r\nfunction recordRecent(entry: RecentEntry) {\r\n  const existing = RECENT_FILES.find(r => r.path === entry.path);\r\n  if (existing) { existing.at = entry.at; existing.lines = entry.lines; existing.hash = entry.hash; }\r\n  else {\r\n    RECENT_FILES.push(entry);\r\n    if (RECENT_FILES.length > 30) RECENT_FILES.sort((a,b)=>b.at-a.at).splice(30);\r\n  }\r\n}\r\n\r\ninterface SafeUser { isSuperAdmin?: boolean; roles?: string[] }\r\n\r\nfunction isSuper(request: express.Request): boolean {\r\n  const u = (request as unknown as { user?: SafeUser }).user;\r\n  return !!(u?.isSuperAdmin || u?.roles?.includes?.('super_admin'));\r\n}\r\n\r\nfunction ensureSuper(req: express.Request, res: express.Response): boolean {\r\n  if (!isSuper(req)) {\r\n    res.status(403).json({ success: false, error: 'Acc\u00E8s restreint SuperAdmin' });\r\n    return false;\r\n  }\r\n  return true;\r\n}\r\n\r\nfunction sanitizeRelative(p: string): string | null {\r\n  if (!p) return null;\r\n  const norm = path.posix.normalize(p.replace(/\\\\/g, '/')).replace(/^\\/+/, '');\r\n  const base = norm.split('/')[0];\r\n  if (!ALLOWED_ROOTS.includes(base)) return null;\r\n  return norm;\r\n}\r\n\r\nfunction abs(rel: string): string { return path.join(REPO_ROOT, rel); }\r\n\r\n// GET /api/ai/code/tree\r\nrouter.get('/code/tree', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const rel = sanitizeRelative(String(req.query.path || 'src'));\r\n  if (!rel) return res.status(400).json({ success: false, error: 'Chemin non autoris\u00E9' });\r\n  const depth = Math.min(4, Math.max(0, parseInt(String(req.query.depth || '2'), 10) || 0));\r\n  const target = abs(rel);\r\n  if (!fs.existsSync(target)) return res.status(404).json({ success: false, error: 'Chemin introuvable' });\r\n  function build(p: string, d: number) {\r\n    const stat = fs.statSync(p);\r\n    const name = path.basename(p);\r\n    const relPath = p.substring(REPO_ROOT.length + 1).replace(/\\\\/g, '/');\r\n    if (stat.isDirectory()) {\r\n      if (d >= depth) return { type: 'dir', name, path: relPath };\r\n  let children: ReturnType<typeof build>[] = [];\r\n  try { children = fs.readdirSync(p).slice(0, 200).map(f => build(path.join(p, f), d + 1)); } catch { children = []; }\r\n      return { type: 'dir', name, path: relPath, children };\r\n    }\r\n    return { type: 'file', name, path: relPath, size: stat.size };\r\n  }\r\n  try {\r\n    const tree = build(target, 0);\r\n    res.json({ success: true, data: tree, meta: { root: rel, depth } });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: 'Erreur lecture', details: (e as Error).message });\r\n  }\r\n});\r\n\r\n// GET /api/ai/code/file\r\nrouter.get('/code/file', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const rel = sanitizeRelative(String(req.query.path || ''));\r\n  if (!rel) return res.status(400).json({ success: false, error: 'Chemin non autoris\u00E9' });\r\n  const target = abs(rel);\r\n  if (!fs.existsSync(target) || !fs.statSync(target).isFile()) return res.status(404).json({ success: false, error: 'Fichier introuvable' });\r\n  const offset = Math.max(0, parseInt(String(req.query.offset || '0'), 10) || 0);\r\n  const limit = Math.min(800, Math.max(50, parseInt(String(req.query.limit || '400'), 10) || 400));\r\n  try {\r\n  const content = fs.readFileSync(target, 'utf8');\r\n  const totalBytes = Buffer.byteLength(content, 'utf8');\r\n  const lines = content.split(/\\r?\\n/);\r\n  const etag = 'W/\"' + crypto.createHash('sha256').update(content).digest('hex').slice(0,16) + '\"';\r\n  const ifNoneMatch = req.headers['if-none-match'];\r\n  if (ifNoneMatch && ifNoneMatch === etag) { res.status(304).end(); return; }\r\n  const truncated = totalBytes > MAX_FILE_SIZE_BYTES || lines.length > MAX_FILE_LINES_RETURN;\r\n  const slice = lines.slice(offset, Math.min(offset + limit, truncated ? MAX_FILE_LINES_RETURN : lines.length));\r\n  recordRecent({ path: rel, at: Date.now(), lines: lines.length, hash: etag });\r\n  res.setHeader('ETag', etag);\r\n  res.json({ success: true, data: { path: rel, offset, limit: slice.length, totalLines: lines.length, totalBytes, truncated, lines: slice } });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: 'Erreur lecture fichier', details: (e as Error).message });\r\n  }\r\n});\r\n\r\nlet FILE_INDEX: string[] | null = null;\r\nfunction buildFileIndex() {\r\n  if (FILE_INDEX) return FILE_INDEX;\r\n  const acc: string[] = [];\r\n  function walk(rel: string) {\r\n    const full = abs(rel);\r\n    if (!fs.existsSync(full)) return;\r\n    const stat = fs.statSync(full);\r\n    if (stat.isDirectory()) {\r\n      const entries = fs.readdirSync(full).slice(0, 500);\r\n      for (const e of entries) {\r\n        const childRel = rel + '/' + e;\r\n        if (/node_modules|\\.git|dist|build/.test(childRel)) continue;\r\n        walk(childRel);\r\n      }\r\n    } else if (/\\.(ts|tsx|js|cjs|mjs)$/.test(rel)) { acc.push(rel); }\r\n  }\r\n  for (const root of ALLOWED_ROOTS) walk(root);\r\n  FILE_INDEX = acc; return FILE_INDEX;\r\n}\r\n\r\n// GET /api/ai/code/search\r\nrouter.get('/code/search', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const q = String(req.query.q || '').trim();\r\n  if (!q) return res.status(400).json({ success: false, error: 'Param\u00E8tre q requis' });\r\n  const scope = sanitizeRelative(String(req.query.path || 'src')) || 'src';\r\n  const max = Math.min(50, Math.max(1, parseInt(String(req.query.max || '25'), 10) || 25));\r\n  const files = buildFileIndex().filter(f => f.startsWith(scope));\r\n  const results: { path: string; line: number; snippet: string }[] = [];\r\n  const regex = new RegExp(q.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'), 'i');\r\n  for (const f of files) {\r\n    if (results.length >= max) break;\r\n    try {\r\n      const content = fs.readFileSync(abs(f), 'utf8');\r\n      const lines = content.split(/\\r?\\n/);\r\n      for (let idx = 0; idx < lines.length && results.length < max; idx++) {\r\n        const line = lines[idx];\r\n        if (regex.test(line)) results.push({ path: f, line: idx + 1, snippet: line.trim().slice(0, 240) });\r\n      }\r\n  } catch {\r\n      // ignorer erreurs de lecture individuelles\r\n    }\r\n  }\r\n  res.json({ success: true, data: { query: q, matches: results, scope, max } });\r\n});\r\n\r\n// GET /api/ai/code/summary\r\nrouter.get('/code/summary', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const rel = sanitizeRelative(String(req.query.path || ''));\r\n  if (!rel) return res.status(400).json({ success: false, error: 'Chemin non autoris\u00E9' });\r\n  const target = abs(rel);\r\n  if (!fs.existsSync(target) || !fs.statSync(target).isFile()) return res.status(404).json({ success: false, error: 'Fichier introuvable' });\r\n  try {\r\n    const content = fs.readFileSync(target, 'utf8');\r\n    const lines = content.split(/\\r?\\n/);\r\n    const totalBytes = Buffer.byteLength(content, 'utf8');\r\n    const importRegex = /import\\s+[^;]*?from\\s+['\"]([^'\";]+)['\"]/g;\r\n    const requiresRegex = /require\\(\\s*['\"]([^'\";]+)['\"]\\s*\\)/g;\r\n    const depsSet = new Set<string>();\r\n    let m: RegExpExecArray | null;\r\n    while ((m = importRegex.exec(content))) depsSet.add(m[1]);\r\n    while ((m = requiresRegex.exec(content))) depsSet.add(m[1]);\r\n    const deps = Array.from(depsSet).sort();\r\n    const exportRegex = /export\\s+(?:default\\s+)?(class|function|const|let|var|interface|type|enum)?\\s*([A-Za-z0-9_]+)/g;\r\n    const named: string[] = [];\r\n    while ((m = exportRegex.exec(content))) {\r\n      const kind = m[1] || 'symbol';\r\n      const name = m[2];\r\n      if (!named.includes(name)) named.push(name + ':' + kind);\r\n    }\r\n    const braceExport = /export\\s+{([^}]+)}/g;\r\n    while ((m = braceExport.exec(content))) {\r\n      const inside = m[1].split(',').map(s => s.trim().split(/\\s+as\\s+/i)[0]).filter(Boolean);\r\n      inside.forEach(sym => { if (!named.some(n => n.startsWith(sym+':'))) named.push(sym + ':ref'); });\r\n    }\r\n    const defaultExport = /export\\s+default\\s+/.test(content);\r\n    const summary = {\r\n      path: rel,\r\n      lines: lines.length,\r\n      bytes: totalBytes,\r\n      hasDefaultExport: defaultExport,\r\n      exports: named.slice(0,50),\r\n      dependencies: deps.slice(0,100),\r\n      sizeCategory: totalBytes > MAX_FILE_SIZE_BYTES ? 'large' : 'normal',\r\n      lastModified: fs.statSync(target).mtime,\r\n    };\r\n    recordRecent({ path: rel, at: Date.now(), lines: lines.length });\r\n    res.json({ success: true, data: summary });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: 'Erreur r\u00E9sum\u00E9 fichier', details: (e as Error).message });\r\n  }\r\n});\r\n\r\n// GET /api/ai/code/diff\r\nrouter.get('/code/diff', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const oldRel = sanitizeRelative(String(req.query.old || ''));\r\n  const newRel = sanitizeRelative(String(req.query.new || ''));\r\n  if (!oldRel || !newRel) return res.status(400).json({ success: false, error: 'Param\u00E8tres old et new requis' });\r\n  const oldPath = abs(oldRel); const newPath = abs(newRel);\r\n  if (!fs.existsSync(oldPath) || !fs.statSync(oldPath).isFile()) return res.status(404).json({ success: false, error: 'Ancien fichier introuvable' });\r\n  if (!fs.existsSync(newPath) || !fs.statSync(newPath).isFile()) return res.status(404).json({ success: false, error: 'Nouveau fichier introuvable' });\r\n  try {\r\n    const oldLines = fs.readFileSync(oldPath,'utf8').split(/\\r?\\n/);\r\n    const newLines = fs.readFileSync(newPath,'utf8').split(/\\r?\\n/);\r\n    const diffs: { type: 'ctx'|'add'|'del'; oldLine?: number; newLine?: number; text: string }[] = [];\r\n    const max = Math.max(oldLines.length, newLines.length);\r\n    const maxOutput = 800;\r\n    for (let i=0; i<max && diffs.length < maxOutput; i++) {\r\n      const a = oldLines[i]; const b = newLines[i];\r\n      if (a === b) {\r\n        if (diffs.length && diffs[diffs.length-1].type === 'ctx') continue;\r\n        diffs.push({ type: 'ctx', oldLine: i+1, newLine: i+1, text: a ?? '' });\r\n      } else {\r\n        if (a !== undefined) diffs.push({ type: 'del', oldLine: i+1, text: a });\r\n        if (b !== undefined) diffs.push({ type: 'add', newLine: i+1, text: b });\r\n      }\r\n    }\r\n    recordRecent({ path: oldRel, at: Date.now(), lines: oldLines.length });\r\n    recordRecent({ path: newRel, at: Date.now(), lines: newLines.length });\r\n    res.json({ success: true, data: { old: oldRel, new: newRel, oldLines: oldLines.length, newLines: newLines.length, diffs } });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: 'Erreur diff', details: (e as Error).message });\r\n  }\r\n});\r\n\r\n// GET /api/ai/code/recent\r\nrouter.get('/code/recent', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const list = RECENT_FILES.sort((a,b)=>b.at-a.at).slice(0,20);\r\n  res.json({ success: true, data: list });\r\n});\r\n\r\n// GET /api/ai/code/analyze?path=src/pages/SomePage.tsx\r\n// Analyse qualitative (aucune g\u00E9n\u00E9ration de code) : m\u00E9triques, heuristiques UI/UX, id\u00E9es d'am\u00E9lioration.\r\nrouter.get('/code/analyze', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const rel = sanitizeRelative(String(req.query.path || ''));\r\n  if (!rel) return res.status(400).json({ success: false, error: 'Chemin non autoris\u00E9' });\r\n  const target = abs(rel);\r\n  if (!fs.existsSync(target) || !fs.statSync(target).isFile()) return res.status(404).json({ success: false, error: 'Fichier introuvable' });\r\n  try {\r\n    const cached = ANALYZE_CACHE[rel];\r\n    const now = Date.now();\r\n    if (cached && now - cached.ts < ANALYZE_TTL_MS) {\r\n      return res.json({ success: true, data: cached.data, meta: { cached: true, ageMs: now - cached.ts } });\r\n    }\r\n    const content = fs.readFileSync(target, 'utf8');\r\n    const lines = content.split(/\\r?\\n/);\r\n    const size = lines.length;\r\n    const jsx = /<[^>]+>/g.test(content) || rel.endsWith('.tsx');\r\n    const hooksCount = (content.match(/\\buse(State|Effect|Memo|Callback|Ref|Context|Reducer)\\b/g) || []).length;\r\n    const useEffectCount = (content.match(/\\buseEffect\\b/g) || []).length;\r\n    const customHooks = (content.match(/\\buse[A-Z][A-Za-z0-9_]*/g) || []).filter(h => !/use(State|Effect|Memo|Callback|Ref|Context|Reducer)/.test(h));\r\n    const importAntd = (content.match(/from ['\"]antd['\"]/g) || []).length > 0;\r\n    const antdComponents = Array.from(new Set(((content.match(/<([A-Z][A-Za-z0-9]+)\\b/g) || []).map(m => m.slice(1))).filter(n => /^(Button|Table|Form|Modal|Input|Select|DatePicker|Tabs|Tag|Tooltip|Dropdown|Menu|Layout|Card|Space|Flex|Grid|Alert|Avatar|Badge)$/.test(n)))).sort();\r\n    const hasI18n = /\\bi18n\\b|\\bt\\(['\"]/.test(content);\r\n  const usesTailwind = /className=\"[^\"]*(flex|grid|px-|py-|text-|bg-|rounded|shadow)/.test(content);\r\n    const largeFile = size > 400;\r\n    const veryLargeFile = size > 800;\r\n    const manyHooks = hooksCount > 15 || useEffectCount > 6;\r\n    // Calcul profondeur JSX & densit\u00E9\r\n    let depth = 0, maxDepth = 0, tagCount = 0;\r\n    if (jsx) {\r\n      for (const line of lines) {\r\n        const trimmed = line.trim();\r\n        const openTags = trimmed.match(/<([A-Za-z][A-Za-z0-9-]*)([^>/]*?)>/g) || [];\r\n  // selfClosing non utilis\u00E9 dans l'heuristique; ignor\u00E9\r\n        const closeTags = trimmed.match(/<\\/(?:[A-Za-z][A-Za-z0-9-]*)>/g) || [];\r\n        tagCount += openTags.length;\r\n        // assume each non-selfclosing open increases depth until a corresponding close\r\n        const openNonSelf = openTags.filter(t => !/\\/>$/.test(t));\r\n  for (let i=0;i<openNonSelf.length;i++) { depth++; if (depth > maxDepth) maxDepth = depth; }\r\n  for (let i=0;i<closeTags.length;i++) { depth = Math.max(0, depth - 1); }\r\n        // adjust for self-closing already counted above but not depth affecting beyond immediate\r\n      }\r\n    }\r\n    const jsxDensity = jsx ? (tagCount / Math.max(1, size/100)) : 0; // tags par 100 lignes\r\n    const complexitySignals: string[] = [];\r\n    if (largeFile) complexitySignals.push('taille>400 lignes');\r\n    if (veryLargeFile) complexitySignals.push('taille>800 lignes (risque lisibilit\u00E9)');\r\n    if (manyHooks) complexitySignals.push('beaucoup de hooks (fragmentation probable)');\r\n    if (customHooks.length > 8) complexitySignals.push('grand nombre de hooks personnalis\u00E9s');\r\n    if (maxDepth > 12) complexitySignals.push('profondeur jsx>12 (hi\u00E9rarchie tr\u00E8s profonde)');\r\n    if (jsxDensity > 160) complexitySignals.push('densit\u00E9 jsx \u00E9lev\u00E9e (>160 tags/100 lignes)');\r\n    const missingSignals: string[] = [];\r\n    if (!hasI18n && jsx) missingSignals.push('i18n manquant (t(\"...\"))');\r\n    if (!importAntd && jsx) missingSignals.push('Pas de composant Ant Design d\u00E9tect\u00E9 (peut-\u00EAtre custom UI)');\r\n    // Heuristique accessibilit\u00E9 basique\r\n    const hasAlt = /<img[^>]+alt=/.test(content);\r\n    const hasAria = /aria-\\w+=/.test(content);\r\n    if (/<img[^>]+>/.test(content) && !hasAlt) missingSignals.push('Images sans attribut alt');\r\n    if (jsx && !hasAria) missingSignals.push('Peu/pas d\u2019attributs ARIA');\r\n    // Id\u00E9es d'am\u00E9lioration heuristiques\r\n    const ideas: string[] = [];\r\n    if (largeFile) ideas.push('Scinder le composant en sous-composants (r\u00E9duction taille & lisibilit\u00E9)');\r\n    if (manyHooks) ideas.push('Extraire logique business dans des hooks personnalis\u00E9s nomm\u00E9s / services');\r\n    if (!hasI18n) ideas.push('Internationaliser le texte statique');\r\n    if (antdComponents.includes('Table') && !/pagination/i.test(content)) ideas.push('Ajouter pagination / tri / filtrage sur Table');\r\n    if (antdComponents.includes('Form') && !/Form\\.Item\\s+name=/.test(content)) ideas.push('V\u00E9rifier binding structur\u00E9 des champs Form.Item');\r\n    if (!usesTailwind && importAntd) ideas.push('Uniformiser spacing avec Tailwind pour coh\u00E9rence visuelle');\r\n    if (missingSignals.includes('Images sans attribut alt')) ideas.push('Ajouter attribut alt sur toutes les images (accessibilit\u00E9)');\r\n    if (!/ErrorBoundary|ErrorFallback/.test(content) && useEffectCount > 0) ideas.push('Envelopper la page dans un ErrorBoundary r\u00E9utilisable');\r\n    if (!/Skeleton|Spin|Loading|isLoading/.test(content) && /fetch|api\\.(get|post|put|delete)/.test(content)) ideas.push('Afficher \u00E9tat de chargement (Skeleton / Spin) pendant les requ\u00EAtes');\r\n    if (!/analytics|track(Event)?/i.test(content)) ideas.push('Instrumenter \u00E9v\u00E9nements clefs (tracking analytics)');\r\n    const dependencyKinds = {\r\n      external: Array.from(new Set(Array.from(content.matchAll(/import\\s+[^;]+from\\s+['\"]([^'\".][^'\"/]*)['\"]/g)).map(m => m[1]))).sort(),\r\n      internal: Array.from(new Set(Array.from(content.matchAll(/import\\s+[^;]+from\\s+['\"](\\.{1,2}\\/[^\"]+)['\"]/g)).map(m => m[1]))).sort()\r\n    };\r\n    const exportMatches = Array.from(content.matchAll(/export\\s+(?:default\\s+)?(function|const|class)\\s+([A-Za-z0-9_]+)/g)).map(m => m[2]);\r\n    const defaultExport = /export\\s+default\\s+/.test(content);\r\n    // Score tr\u00E8s rudimentaire (0-100)\r\n    let baseScore = 80;\r\n    if (largeFile) baseScore -= 5;\r\n    if (veryLargeFile) baseScore -= 10;\r\n    if (manyHooks) baseScore -= 5;\r\n    if (!hasI18n) baseScore -= 5;\r\n    if (missingSignals.includes('Images sans attribut alt')) baseScore -= 5;\r\n    if (maxDepth > 12) baseScore -= 5;\r\n    const score = Math.max(30, Math.min(95, baseScore));\r\n    // Risques structur\u00E9s\r\n    const risks: { code: string; severity: 'low'|'medium'|'high'; detail: string }[] = [];\r\n    if (veryLargeFile) risks.push({ code: 'component_too_large', severity: 'high', detail: 'Composant >800 lignes' });\r\n    else if (largeFile) risks.push({ code: 'component_large', severity: 'medium', detail: 'Composant >400 lignes' });\r\n    if (manyHooks) risks.push({ code: 'hooks_overuse', severity: 'medium', detail: 'Hooks nombreux (fragmenter logique)' });\r\n    if (!hasI18n && jsx) risks.push({ code: 'missing_i18n', severity: 'medium', detail: 'Textes non internationalis\u00E9s' });\r\n    if (maxDepth > 12) risks.push({ code: 'deep_jsx_tree', severity: 'medium', detail: 'Hi\u00E9rarchie JSX tr\u00E8s profonde' });\r\n    if (jsxDensity > 160) risks.push({ code: 'high_jsx_density', severity: 'low', detail: 'Beaucoup de balises par 100 lignes' });\r\n    if (!/Skeleton|Spin|Loading|isLoading/.test(content) && /api\\.(get|post|put|delete)/.test(content)) risks.push({ code: 'missing_loading_state', severity: 'medium', detail: 'Aucun \u00E9tat de chargement visible' });\r\n    if (antdComponents.includes('Table') && !/pagination/i.test(content)) risks.push({ code: 'table_no_pagination', severity: 'low', detail: 'Table sans pagination explicite' });\r\n    const summary = {\r\n      path: rel,\r\n      lines: size,\r\n      jsx,\r\n      exports: { named: exportMatches.slice(0,50), hasDefault: defaultExport },\r\n      dependencies: dependencyKinds,\r\n      antdComponents,\r\n      hooks: { total: hooksCount, useEffect: useEffectCount, custom: Array.from(new Set(customHooks)).slice(0,30) },\r\n      signals: { complexity: complexitySignals, missing: missingSignals },\r\n      jsxStructure: jsx ? { maxDepth, tagCount, densityPer100Lines: Math.round(jsxDensity) } : null,\r\n      metrics: { score, heuristic: 'Indicatif (non scientifique)' },\r\n      risks,\r\n      suggestions: ideas.slice(0, 25),\r\n      notes: 'Analyse purement heuristique, ne g\u00E9n\u00E8re PAS de code. Destin\u00E9e \u00E0 soutenir une conversation sur la qualit\u00E9 & am\u00E9liorations possibles.'\r\n    };\r\n    recordRecent({ path: rel, at: Date.now(), lines: size });\r\n    ANALYZE_CACHE[rel] = { ts: now, data: summary };\r\n    res.json({ success: true, data: summary, meta: { cached: false } });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: 'Erreur analyse', details: (e as Error).message });\r\n  }\r\n});\r\n\r\n// GET /api/ai/code/feature/analyze?feature=mail\r\nrouter.get('/code/feature/analyze', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const feature = String(req.query.feature || '').trim();\r\n  if (!feature) return res.status(400).json({ success: false, error: 'Param\u00E8tre feature requis' });\r\n  const fmapPath = abs('src/feature-map.json');\r\n  if (!fs.existsSync(fmapPath)) return res.status(500).json({ success: false, error: 'feature-map.json manquant' });\r\n  try {\r\n    interface FeatureDef { label?: string; primaryPages?: string[]; relatedServices?: string[]; keywords?: string[] }\r\n    const fmap = JSON.parse(fs.readFileSync(fmapPath, 'utf8')) as Record<string, FeatureDef>;\r\n    const def = fmap[feature];\r\n    if (!def) return res.status(404).json({ success: false, error: 'Feature inconnue' });\r\n    const files: string[] = [...(def.primaryPages||[]), ...(def.relatedServices||[])].filter(Boolean);\r\n  interface FileAnalysis { path: string; lines: number; jsx: boolean; hooks: { total: number; useEffect: number; custom: string[] }; antdComponents: string[]; hasI18n: boolean; usesTailwind: boolean; exports: { named: string[]; hasDefault: boolean }; importAntd: boolean }\r\n  interface FileError { path: string; error: string }\r\n  const analyses: FileAnalysis[] = [];\r\n  const errors: FileError[] = [];\r\n    // R\u00E9utilise l\u2019heuristique d\u2019analyse locale sans dupliquer tout le code (mini refactor interne)\r\n    function analyzeFile(rel: string) {\r\n      const target = abs(rel);\r\n      if (!fs.existsSync(target) || !fs.statSync(target).isFile()) { errors.push({ path: rel, error: 'introuvable' }); return; }\r\n      const content = fs.readFileSync(target, 'utf8');\r\n      const lines = content.split(/\\r?\\n/);\r\n      const jsx = /<[^>]+>/g.test(content) || rel.endsWith('.tsx');\r\n      const hooksCount = (content.match(/\\buse(State|Effect|Memo|Callback|Ref|Context|Reducer)\\b/g) || []).length;\r\n      const useEffectCount = (content.match(/\\buseEffect\\b/g) || []).length;\r\n      const customHooks = (content.match(/\\buse[A-Z][A-Za-z0-9_]*/g) || []).filter(h => !/use(State|Effect|Memo|Callback|Ref|Context|Reducer)/.test(h));\r\n      const importAntd = (content.match(/from ['\"]antd['\"]/g) || []).length > 0;\r\n      const antdComponents = Array.from(new Set(((content.match(/<([A-Z][A-Za-z0-9]+)\\b/g) || []).map(m => m.slice(1))).filter(n => /^(Button|Table|Form|Modal|Input|Select|DatePicker|Tabs|Tag|Tooltip|Dropdown|Menu|Layout|Card|Space|Flex|Grid|Alert|Avatar|Badge)$/.test(n)))).sort();\r\n      const hasI18n = /\\bi18n\\b|\\bt\\(['\"]/.test(content);\r\n      const usesTailwind = /className=\"[^\"]*(flex|grid|px-|py-|text-|bg-|rounded|shadow)/.test(content);\r\n      const exportMatches = Array.from(content.matchAll(/export\\s+(?:default\\s+)?(function|const|class)\\s+([A-Za-z0-9_]+)/g)).map(m => m[2]);\r\n      const defaultExport = /export\\s+default\\s+/.test(content);\r\n      analyses.push({\r\n        path: rel,\r\n        lines: lines.length,\r\n        jsx,\r\n        hooks: { total: hooksCount, useEffect: useEffectCount, custom: Array.from(new Set(customHooks)).slice(0,30) },\r\n        antdComponents,\r\n        hasI18n,\r\n        usesTailwind,\r\n        exports: { named: exportMatches.slice(0,30), hasDefault: defaultExport },\r\n        importAntd\r\n      });\r\n    }\r\n    files.slice(0, 30).forEach(f => analyzeFile(f));\r\n    // Agr\u00E9gation simple\r\n    const totalLines = analyses.reduce((s,a)=>s+a.lines,0);\r\n    const totalHooks = analyses.reduce((s,a)=>s+a.hooks.total,0);\r\n    const pages = analyses.filter(a => a.jsx);\r\n    const avgLines = analyses.length ? Math.round(totalLines / analyses.length) : 0;\r\n    const summary = {\r\n      feature,\r\n      label: def.label,\r\n      fileCount: analyses.length,\r\n      totalLines,\r\n      avgLines,\r\n      totalHooks,\r\n      pages: pages.length,\r\n      i18nCoverage: analyses.length ? (analyses.filter(a=>a.hasI18n).length / analyses.length) : 0,\r\n      antdUsageRate: analyses.length ? (analyses.filter(a=>a.importAntd).length / analyses.length) : 0,\r\n      tailwindUsageRate: analyses.length ? (analyses.filter(a=>a.usesTailwind).length / analyses.length) : 0\r\n    };\r\n    res.json({ success: true, data: { summary, analyses, errors } });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: 'Erreur analyse feature', details: (e as Error).message });\r\n  }\r\n});\r\n\r\n// POST /api/ai/code/analyze/batch  body: { paths: string[] }\r\nrouter.post('/code/analyze/batch', (req, res) => {\r\n  if (!ensureSuper(req, res)) return;\r\n  const body = req.body || {};\r\n  const paths: unknown = body.paths;\r\n  if (!Array.isArray(paths) || paths.length === 0) return res.status(400).json({ success: false, error: 'paths[] requis' });\r\n  const unique = Array.from(new Set(paths.map(p => String(p)))).slice(0,40);\r\n  const analyses: AnalyzeSummary[] = [];\r\n  const errors: { path: string; error: string }[] = [];\r\n  const now = Date.now();\r\n  function analyzeOne(rel: string) {\r\n    const safe = sanitizeRelative(rel);\r\n    if (!safe) { errors.push({ path: rel, error: 'non autoris\u00E9' }); return; }\r\n    const full = abs(safe);\r\n    if (!fs.existsSync(full) || !fs.statSync(full).isFile()) { errors.push({ path: rel, error: 'introuvable' }); return; }\r\n    // r\u00E9utilise cache\r\n    const cached = ANALYZE_CACHE[safe];\r\n    if (cached && now - cached.ts < ANALYZE_TTL_MS) { analyses.push(cached.data); return; }\r\n    // appel interne via logique de /code/analyze (duplicated minimal subset: lire puis ins\u00E9rer dans cache via fetch serait surco\u00FBt)\r\n    try {\r\n      const content = fs.readFileSync(full,'utf8');\r\n      const lines = content.split(/\\r?\\n/);\r\n      const hooksCount = (content.match(/\\buse(State|Effect|Memo|Callback|Ref|Context|Reducer)\\b/g) || []).length;\r\n      const useEffectCount = (content.match(/\\buseEffect\\b/g) || []).length;\r\n      const customHooks = (content.match(/\\buse[A-Z][A-Za-z0-9_]*/g) || []).filter(h => !/use(State|Effect|Memo|Callback|Ref|Context|Reducer)/.test(h));\r\n      const jsx = /<[^>]+>/g.test(content) || /\\.tsx$/.test(safe);\r\n      let depth = 0, maxDepth = 0, tagCount = 0;\r\n      if (jsx) {\r\n        for (const line of lines) {\r\n          const trimmed = line.trim();\r\n          const openTags = trimmed.match(/<([A-Za-z][A-Za-z0-9-]*)([^>/]*?)>/g) || [];\r\n          const closeTags = trimmed.match(/<\\/(?:[A-Za-z][A-Za-z0-9-]*)>/g) || [];\r\n          tagCount += openTags.length;\r\n          const openNonSelf = openTags.filter(t => !/\\/>$/.test(t));\r\n          for (let i=0;i<openNonSelf.length;i++) { depth++; if (depth>maxDepth) maxDepth = depth; }\r\n          for (let i=0;i<closeTags.length;i++) { depth = Math.max(0, depth-1); }\r\n        }\r\n      }\r\n      const jsxDensity = jsx ? (tagCount / Math.max(1, lines.length/100)) : 0;\r\n      const hasI18n = /\\bt\\(['\"][^)]*\\)/.test(content) || /i18n/.test(content);\r\n      const antdComponents = Array.from(new Set(((content.match(/<([A-Z][A-Za-z0-9]+)\\b/g) || []).map(m=>m.slice(1))).filter(n=>/^(Button|Table|Form|Modal|Input|Select|DatePicker|Tabs|Tag|Tooltip|Dropdown|Menu|Layout|Card|Space|Flex|Grid|Alert|Avatar|Badge)$/.test(n)))).sort();\r\n      const summary = {\r\n        path: safe,\r\n        lines: lines.length,\r\n        hooks: { total: hooksCount, useEffect: useEffectCount, custom: Array.from(new Set(customHooks)).slice(0,20) },\r\n        jsxStructure: jsx ? { maxDepth, tagCount, densityPer100Lines: Math.round(jsxDensity) } : null,\r\n        i18n: hasI18n,\r\n        antdComponents\r\n      };\r\n      ANALYZE_CACHE[safe] = { ts: now, data: summary };\r\n      analyses.push(summary);\r\n    } catch (e) { errors.push({ path: rel, error: (e as Error).message }); }\r\n  }\r\n  unique.forEach(analyzeOne);\r\n  res.json({ success: true, data: { analyses, errors, count: analyses.length } });\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from \"express\";\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { PrismaClient, Field } from '@prisma/client';\r\nimport { adaptBlockStructure } from '../helpers/adaptBlockStructure';\r\nimport { authMiddleware } from '../middlewares/auth';\r\n// Import du middleware d'impersonation supprim\u00E9 car non utilis\u00E9 pour le moment\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport formulasRouter from './formulas';\r\nimport dependenciesRouter from './dependencies';\r\nimport validationsRouter from './validations';\r\nimport type { AuthenticatedRequest } from \"../middlewares/auth\";\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Appliquer le middleware d'authentification \u00E0 toutes les routes\r\nrouter.use(authMiddleware as unknown as (req: Request, res: Response, next: () => void) => void);\r\n\r\n// Petite aide pour renvoyer un champ au format attendu par le frontend\r\ntype FieldOptionLite = { id: string; label: string; value: string; order?: number };\r\nfunction mapFieldForFrontend(field: unknown) {\r\n    if (!field || typeof field !== 'object') return field as unknown as Field;\r\n    const f = field as { FieldOption?: FieldOptionLite[]; options?: FieldOptionLite[] } & Field;\r\n    const options: FieldOptionLite[] = Array.isArray(f.FieldOption)\r\n        ? (f.FieldOption as FieldOptionLite[])\r\n                .slice()\r\n                .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))\r\n                .map((o) => ({ id: o.id, label: o.label, value: o.value, order: o.order }))\r\n        : Array.isArray(f.options)\r\n            ? (f.options as FieldOptionLite[])\r\n            : [];\r\n    const rest = { ...(field as object) } as Field & { options?: FieldOptionLite[] } & Record<string, unknown>;\r\n    delete (rest as Record<string, unknown>)['FieldOption'];\r\n    return { ...rest, options } as unknown as Field;\r\n}\r\n\r\n// GET /api/fields - R\u00E9cup\u00E9rer tous les champs pour les validateurs\r\n// NOTE : Cette route doit \u00EAtre d\u00E9finie AVANT les routes avec des param\u00E8tres comme /:id\r\n// CORRECTION : Ajouter une protection de r\u00F4le pour s'assurer que l'utilisateur est authentifi\u00E9.\r\nrouter.get(\"/\", requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res: Response) => {\r\n    try {\r\n        const organizationId = req.user?.organizationId;\r\n        const userRole = req.user?.role;\r\n\r\n        // CORRECTION : Adapter la logique pour le super_admin\r\n    const whereClause: Record<string, unknown> = {};\r\n\r\n        if (userRole === 'super_admin') {\r\n            // Le super_admin peut voir les champs de toutes les organisations.\r\n            // Nous ne filtrons pas par organizationId.\r\n            // Si vous voulez filtrer par une organisation s\u00E9lectionn\u00E9e dans l'UI,\r\n            // il faudrait la passer en query param, mais pour l'instant, on retourne tout.\r\n        } else {\r\n            // Pour les autres r\u00F4les (comme 'admin'), on exige une organizationId.\r\n            if (!organizationId) {\r\n                return res.status(403).json({ error: \"ID de l'organisation manquant pour cet utilisateur.\" });\r\n            }\r\n            whereClause.organizationId = organizationId;\r\n        }\r\n\r\n        const fields = await prisma.field.findMany({\r\n            where: whereClause,\r\n            orderBy: {\r\n                label: 'asc'\r\n            }\r\n        });\r\n        res.json(fields);\r\n    } catch (error) {\r\n        console.error(\"Erreur lors de la r\u00E9cup\u00E9ration des champs:\", error);\r\n        res.status(500).json({ error: \"Erreur interne du serveur\" });\r\n    }\r\n});\r\n\r\n// Monter les sous-routeurs en utilisant :id pour la coh\u00E9rence\r\nrouter.use('/:id/formulas', formulasRouter);\r\nrouter.use('/:id/dependencies', dependenciesRouter);\r\nrouter.use('/:id/validations', validationsRouter);\r\n\r\n// Alias attendu par le frontend pour le r\u00E9ordonnancement des d\u00E9pendances\r\nrouter.post('/:id/reorder-dependencies', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n    // Le store envoie { dependencyIds: string[] } ; convertir en { dependencies: [{id, order}] }\r\n    const { dependencyIds } = (req.body ?? {});\r\n    if (!Array.isArray(dependencyIds)) {\r\n        return res.status(400).json({ error: \"Le corps doit contenir 'dependencyIds' (array).\" });\r\n    }\r\n    const dependencies = dependencyIds.map((depId: string, index: number) => ({ id: depId, order: index }));\r\n    // D\u00E9l\u00E9guer au routeur /:id/dependencies/reorder via un appel direct Prisma n'est pas possible ici sans dupliquer la logique; on la r\u00E9impl\u00E9mente rapidement.\r\n    try {\r\n        await prisma.$transaction(\r\n            dependencies.map((dep: { id: string; order: number }) =>\r\n                prisma.fieldDependency.update({ where: { id: dep.id }, data: { order: dep.order } })\r\n            )\r\n        );\r\n        res.json({ success: true });\r\n    } catch (error: unknown) {\r\n        console.error('[API] [POST /fields/:id/reorder-dependencies] Erreur:', error);\r\n        res.status(500).json({ error: 'Erreur lors du r\u00E9ordonnancement des d\u00E9pendances', details: (error as Error).message });\r\n    }\r\n});\r\n\r\n// PUT /api/fields/:id - Mise \u00E0 jour d'un champ (onglet Param\u00E8tres)\r\nrouter.put('/:id', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n  const { id } = req.params;\r\n  const { label, type, required, width, advancedConfig } = req.body;\r\n  \r\n  console.log('[fields.ts] PUT /:id - fieldId:', id);\r\n  console.log('[fields.ts] PUT /:id - body re\u00E7u:', req.body);\r\n  console.log('[fields.ts] PUT /:id - advancedConfig:', advancedConfig);\r\n  \r\n  try {\r\n    const field = await prisma.field.update({\r\n      where: { id },\r\n      data: { label, type, required, width, advancedConfig }\r\n    });\r\n    \r\n    console.log('[fields.ts] PUT /:id - Champ mis \u00E0 jour:', field);\r\n    res.json(field);\r\n    } catch (err: unknown) {\r\n    console.error('[fields.ts] PUT /:id - Erreur:', err);\r\n    const errorMessage = err instanceof Error ? err.message : 'Erreur inconnue';\r\n    res.status(404).json({ error: \"Champ non trouv\u00E9 ou erreur lors de la mise \u00E0 jour\", details: errorMessage });\r\n  }\r\n});\r\n\r\n// Ajouter une option \u00E0 un champ\r\nrouter.post('/:fieldId/options', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n  const { fieldId } = req.params;\r\n  const { label, order, value } = req.body;\r\n  // V\u00E9rification backend : refuser si label ou value vide\r\n  if (!label || !value) {\r\n    res.status(400).json({ error: \"Le label et la value de l'option sont obligatoires.\" });\r\n    return;\r\n  }\r\n  console.log('[API] [POST /fields/:fieldId/options] Re\u00E7u pour fieldId:', fieldId, 'body:', req.body);\r\n  try {\r\n    // V\u00E9rifier si une option avec la m\u00EAme valeur existe d\u00E9j\u00E0 pour ce champ\r\n    const existingOption = await prisma.fieldOption.findFirst({\r\n      where: {\r\n        fieldId,\r\n        value\r\n      }\r\n    });\r\n        if (!existingOption) {\r\n            await prisma.fieldOption.create({\r\n                data: {\r\n                    id: uuidv4(),\r\n                    label,\r\n                    value,\r\n                    order,\r\n                    fieldId\r\n                }\r\n            });\r\n            console.log('[API] [POST /fields/:fieldId/options] Option cr\u00E9\u00E9e en base');\r\n        } else {\r\n            console.log('[API] [POST /fields/:fieldId/options] Option d\u00E9j\u00E0 existante, retour du champ \u00E0 jour');\r\n        }\r\n        // Toujours renvoyer le champ complet mis \u00E0 jour avec ses options\r\n        const updatedField = await prisma.field.findUnique({\r\n            where: { id: fieldId },\r\n            include: { FieldOption: true }\r\n        });\r\n        res.json(mapFieldForFrontend(updatedField));\r\n    } catch (err: unknown) {\r\n    console.error('[API] [POST /fields/:fieldId/options] Erreur cr\u00E9ation option:', err);\r\n    res.status(400).json({ error: \"Erreur lors de la cr\u00E9ation de l'option\", details: err.message });\r\n  }\r\n});\r\n\r\n// Supprimer une option d'un champ\r\nrouter.delete('/field-options/:optionId', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n  const { optionId } = req.params;\r\n  try {\r\n    await prisma.fieldOption.delete({ where: { id: optionId } });\r\n        res.json({ success: true });\r\n    } catch (err: unknown) {\r\n    res.status(400).json({ error: \"Erreur lors de la suppression de l'option\", details: err.message });\r\n  }\r\n});\r\n\r\n// Nouvelle route coh\u00E9rente avec le frontend: DELETE /api/fields/:fieldId/options/:optionId\r\nrouter.delete('/:fieldId/options/:optionId', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n    const { fieldId, optionId } = req.params;\r\n    try {\r\n        await prisma.fieldOption.delete({ where: { id: optionId } });\r\n        const updatedField = await prisma.field.findUnique({\r\n            where: { id: fieldId },\r\n            include: { FieldOption: true }\r\n        });\r\n        if (!updatedField) {\r\n            return res.status(404).json({ error: 'Champ non trouv\u00E9 apr\u00E8s suppression de l\\'option' });\r\n        }\r\n        res.json(mapFieldForFrontend(updatedField));\r\n    } catch (err: unknown) {\r\n        console.error('[API] [DELETE /fields/:fieldId/options/:optionId] Erreur suppression option:', err);\r\n        res.status(400).json({ error: \"Erreur lors de la suppression de l'option\", details: err.message });\r\n    }\r\n});\r\n\r\n// R\u00E9cup\u00E9rer un champ avec ses options\r\nrouter.get('/:id', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n  const { id } = req.params;\r\n  try {\r\n    const field = await prisma.field.findUnique({\r\n      where: { id },\r\n      include: { FieldOption: true }\r\n    });\r\n    if (!field) {\r\n      res.status(404).json({ error: \"Champ non trouv\u00E9\" });\r\n      return;\r\n    }\r\n    res.json(mapFieldForFrontend(field));\r\n    } catch (err: unknown) {\r\n    res.status(400).json({ error: \"Erreur lors de la r\u00E9cup\u00E9ration du champ\", details: err.message });\r\n  }\r\n});\r\n\r\n// POST /api/fields/meta-counts - R\u00E9cup\u00E9rer les comptes de m\u00E9tadonn\u00E9es pour plusieurs champs\r\nrouter.post('/meta-counts', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n  const { fieldIds } = req.body;\r\n\r\n  if (!Array.isArray(fieldIds) || fieldIds.length === 0) {\r\n    res.status(400).json({ error: \"fieldIds doit \u00EAtre un tableau non vide.\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const counts = await Promise.all(fieldIds.map(async (fieldId: string) => {\r\n      const formulas = await prisma.fieldFormula.count({ where: { fieldId } });\r\n      const validations = await prisma.fieldValidation.count({ where: { fieldId } });\r\n      const dependencies = await prisma.fieldDependency.count({ where: { fieldId } });\r\n      return {\r\n        fieldId,\r\n        counts: { formulas, validations, dependencies },\r\n      };\r\n    }));\r\n\r\n    const result = counts.reduce((acc, { fieldId, counts }) => {\r\n      acc[fieldId] = counts;\r\n      return acc;\r\n    }, {} as Record<string, { formulas: number; validations: number; dependencies: number }>);\r\n\r\n    res.json(result);\r\n    } catch (err: unknown) {\r\n    console.error('[API] [POST /fields/meta-counts] Erreur:', err);\r\n    res.status(500).json({ error: \"Erreur serveur lors de la r\u00E9cup\u00E9ration des m\u00E9tadonn\u00E9es\", details: err.message });\r\n  }\r\n});\r\n\r\n// DELETE /api/fields/:id - Suppression d'un champ\r\nrouter.delete('/:id', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<Response | void> => {\r\n    const { id } = req.params;\r\n\r\n    try {\r\n        const field = await prisma.field.findUnique({\r\n            where: { id },\r\n            include: { Section: true }\r\n        });\r\n\r\n        if (!field || !field.Section) {\r\n            res.status(404).json({ error: \"Champ ou section parente non trouv\u00E9\" });\r\n            return;\r\n        }\r\n\r\n        const blockId = field.Section.blockId;\r\n\r\n        if (!blockId) {\r\n            res.status(404).json({ error: \"Block parent non trouv\u00E9\" });\r\n            return;\r\n        }\r\n\r\n        await prisma.field.delete({\r\n            where: { id },\r\n        });\r\n\r\n        // Mettre \u00E0 jour l'ordre des champs restants dans la section\r\n        const remainingFields = await prisma.field.findMany({\r\n            where: { sectionId: field.sectionId },\r\n            orderBy: { order: 'asc' },\r\n        });\r\n\r\n        const updatePromises = remainingFields.map((f, index) =>\r\n            prisma.field.update({\r\n                where: { id: f.id },\r\n                data: { order: index },\r\n            })\r\n        );\r\n\r\n        await prisma.$transaction(updatePromises);\r\n\r\n\r\n        const updatedBlock = await prisma.block.findUnique({\r\n            where: { id: blockId },\r\n            include: {\r\n                Section: {\r\n                    include: {\r\n                        Field: {\r\n                            orderBy: {\r\n                                order: 'asc'\r\n                            }\r\n                        }\r\n                    },\r\n                    orderBy: {\r\n                        order: 'asc'\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        if (!updatedBlock) {\r\n            res.status(404).json({ error: \"Le block mis \u00E0 jour n'a pas pu \u00EAtre r\u00E9cup\u00E9r\u00E9.\" });\r\n            return;\r\n        }\r\n\r\n        res.status(200).json(updatedBlock);\r\n    } catch (error: unknown) {\r\n        console.error(\"Error deleting field:\", error);\r\n        res.status(500).json({ error: \"An error occurred while deleting the field\" });\r\n    }\r\n});\r\n\r\n// PUT /api/fields/:id/move - D\u00E9placer un champ vers une autre section\r\nrouter.put('/:id/move', requireRole(['admin', 'super_admin']) as unknown as (req: Request, res: Response, next: () => void) => void, async (req: Request, res: Response): Promise<Response | void> => {\r\n    const { id } = req.params;\r\n    const { targetSectionId, newOrder } = req.body;\r\n\r\n    if (targetSectionId === undefined || newOrder === undefined) {\r\n        return res.status(400).json({ error: \"Les informations de section cible et d'ordre sont requises.\" });\r\n    }\r\n\r\n    try {\r\n        const fieldToMove = await prisma.field.findUnique({\r\n            where: { id },\r\n            include: { Section: true },\r\n        });\r\n\r\n        if (!fieldToMove || !fieldToMove.Section) {\r\n            return res.status(404).json({ error: \"Champ ou section d'origine non trouv\u00E9.\" });\r\n        }\r\n        const blockId = fieldToMove.Section.blockId;\r\n        const sourceSectionId = fieldToMove.sectionId;\r\n\r\n        if (sourceSectionId === targetSectionId) {\r\n            const fieldsInSection = await prisma.field.findMany({\r\n                where: { sectionId: targetSectionId },\r\n                orderBy: { order: 'asc' },\r\n            });\r\n\r\n            const fieldIndex = fieldsInSection.findIndex(f => f.id === id);\r\n            if (fieldIndex === -1) {\r\n                return res.status(404).json({ error: \"Le champ \u00E0 d\u00E9placer n'a pas \u00E9t\u00E9 trouv\u00E9 dans la section.\" });\r\n            }\r\n\r\n            // In-place array move logic\r\n            const reorderedFields = [...fieldsInSection];\r\n            const [movedItem] = reorderedFields.splice(fieldIndex, 1);\r\n            reorderedFields.splice(newOrder, 0, movedItem);\r\n\r\n            await prisma.$transaction(\r\n                reorderedFields.map((field: Field, index: number) =>\r\n                    prisma.field.update({ where: { id: field.id }, data: { order: index } })\r\n                )\r\n            );\r\n\r\n        } else {\r\n            await prisma.$transaction(async (tx) => {\r\n                await tx.field.updateMany({\r\n                    where: { sectionId: sourceSectionId, order: { gt: fieldToMove.order } },\r\n                    data: { order: { decrement: 1 } },\r\n                });\r\n                await tx.field.updateMany({\r\n                    where: { sectionId: targetSectionId, order: { gte: newOrder } },\r\n                    data: { order: { increment: 1 } },\r\n                });\r\n                await tx.field.update({\r\n                    where: { id },\r\n                    data: { sectionId: targetSectionId, order: newOrder },\r\n                });\r\n            });\r\n        }\r\n\r\n    const updatedBlock = await prisma.block.findUnique({\r\n            where: { id: blockId },\r\n            include: {\r\n                Section: { orderBy: { order: 'asc' }, include: { Field: { orderBy: { order: 'asc' }, include: { FieldOption: { orderBy: { order: 'asc' } } } } } }\r\n            }\r\n        });\r\n\r\n        if (!updatedBlock) {\r\n            return res.status(404).json({ error: \"Le block mis \u00E0 jour n'a pas pu \u00EAtre r\u00E9cup\u00E9r\u00E9.\" });\r\n        }\r\n\r\n    const adaptedBlock = adaptBlockStructure(updatedBlock);\r\n    res.json(adaptedBlock);\r\n\r\n    } catch (err: unknown) {\r\n        console.error(\"[API] [PUT /fields/:id/move] Erreur:\", err);\r\n        res.status(500).json({ error: \"Erreur lors du d\u00E9placement du champ\", details: err.message });\r\n    }\r\n});\r\n\r\n// PUT /api/fields/:id/reorder - R\u00E9ordonner un champ dans sa section\r\nrouter.put('/:id/reorder', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<Response | void> => {\r\n    const { newIndex } = req.body;\r\n    const { id } = req.params;\r\n\r\n    try {\r\n        const fieldToMove = await prisma.field.findUnique({\r\n            where: { id },\r\n        });\r\n\r\n        if (!fieldToMove) {\r\n            res.status(404).json({ error: \"Field not found\" });\r\n            return;\r\n        }\r\n\r\n        const allFieldsInSection = await prisma.field.findMany({\r\n            where: { sectionId: fieldToMove.sectionId },\r\n            orderBy: { order: 'asc' },\r\n        });\r\n\r\n        const oldIndex = allFieldsInSection.findIndex(f => f.id === id);\r\n\r\n        if (oldIndex === -1) {\r\n            res.status(404).json({ error: \"Field not found in its section\" });\r\n            return;\r\n        }\r\n\r\n        // In-place array move logic\r\n        const reorderedFields = [...allFieldsInSection];\r\n        const [movedItem] = reorderedFields.splice(oldIndex, 1);\r\n        reorderedFields.splice(newIndex, 0, movedItem);\r\n\r\n        const updatePromises = reorderedFields.map((field: Field, index: number) =>\r\n            prisma.field.update({\r\n                where: { id: field.id },\r\n                data: { order: index },\r\n            })\r\n        );\r\n\r\n        await prisma.$transaction(updatePromises);\r\n\r\n        const updatedSection = await prisma.section.findUnique({\r\n            where: { id: fieldToMove.sectionId },\r\n            include: {\r\n                Field: {\r\n                    orderBy: {\r\n                        order: 'asc'\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        res.status(200).json(updatedSection);\r\n    } catch (error: unknown) {\r\n        console.error(\"Error reordering field:\", error);\r\n        res.status(500).json({ error: \"An error occurred while reordering the field\" });\r\n    }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response, NextFunction } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nconst prisma = new PrismaClient();\r\n// Le routeur est cr\u00E9\u00E9 avec mergeParams pour acc\u00E9der aux param\u00E8tres de la route parente (ex: :fieldId)\r\nconst router = Router({ mergeParams: true });\r\n\r\n// Middleware de debug pour voir les param\u00E8tres et le chemin des requ\u00EAtes\r\nrouter.use((req: Request, _res: Response, next: NextFunction) => {\r\n  console.log('[DEBUG FORMULAS] Request URL:', req.originalUrl);\r\n  console.log('[DEBUG FORMULAS] Route Path:', req.route?.path);\r\n  console.log('[DEBUG FORMULAS] Request Params:', req.params);\r\n  console.log('[DEBUG FORMULAS] Parent Params ID:', req.params.id);\r\n  console.log('[DEBUG FORMULAS] Request Body:', req.body);\r\n  next();\r\n});\r\n\r\nrouter.use(authMiddleware as any, impersonationMiddleware as any);\r\n\r\n// --- CRUD FieldFormula ---\r\n\r\n/**\r\n * R\u00E9cup\u00E9rer toutes les formules de tous les champs\r\n */\r\nrouter.get('/all', requireRole(['admin', 'super_admin']), async (_req, res) => {\r\n  try {\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      include: {\r\n        Field: {\r\n          select: {\r\n            id: true,\r\n            label: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Transformer les donn\u00E9es pour le format attendu par le frontend\r\n    const formattedFormulas = formulas.map(formula => ({\r\n      id: formula.id,\r\n      name: formula.name || formula.title || 'Formule sans nom',\r\n      fieldId: formula.fieldId,\r\n      fieldLabel: formula.Field?.label || 'Champ inconnu'\r\n    }));\r\n    \r\n    res.json(formattedFormulas);\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r\u00E9cup\u00E9ration des formules:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des formules' });\r\n  }\r\n});\r\n\r\n// GET toutes les formules d'un champ\r\n// La route est maintenant GET / car le fieldId est dans les params fusionn\u00E9s\r\nrouter.get('/', requireRole(['admin', 'super_admin']), async (req: Request & { params: { fieldId?: string } }, res: Response) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      where: { fieldId },\r\n      orderBy: { order: 'asc' }\r\n    });\r\n    // On parse la s\u00E9quence JSON pour chaque formule\r\n    const processedFormulas = formulas.map(f => ({\r\n      ...f,\r\n      sequence: f.sequence ? JSON.parse(f.sequence as string) : [],\r\n    }));\r\n    res.json(processedFormulas);\r\n  } catch (err: any) {\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// POST cr\u00E9ation d'une formule pour un champ\r\n// La route est maintenant POST /\r\nrouter.post('/', requireRole(['admin', 'super_admin']), async (req: Request & { params: { fieldId?: string } }, res: Response) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    // On attend 'name' et 'sequence' et \u00E9ventuellement fieldId dans le body si pas dans les params\r\n    const { name, sequence } = req.body;\r\n    const bodyFieldId = req.body.fieldId;\r\n    let { order } = req.body;\r\n    \r\n    // Utiliser fieldId des params ou du body\r\n    const effectiveFieldId = fieldId || bodyFieldId;\r\n\r\n    console.log(\"Creating formula for field:\", effectiveFieldId);\r\n    \r\n    // Si toujours pas de fieldId, renvoyer une formule mock\u00E9e\r\n    if (!effectiveFieldId) {\r\n      console.log(\"\uD83E\uDDEA Mode mock activ\u00E9 pour la cr\u00E9ation de formule - fieldId manquant\");\r\n      \r\n      const mockId = uuidv4();\r\n      const mockFormula = {\r\n        id: mockId,\r\n        fieldId: \"mock-field-id\",\r\n        name: name || \"Nouvelle formule (mock)\",\r\n        sequence: [],\r\n        order: typeof order === 'number' ? order : 0,\r\n        targetProperty: req.body.targetProperty || \"\"\r\n      };\r\n      \r\n      return res.json([mockFormula]);\r\n    }\r\n\r\n    // D\u00E9terminer l'ordre si non fourni\r\n    if (typeof order !== 'number') {\r\n      try {\r\n        const lastFormula = await prisma.fieldFormula.findFirst({\r\n          where: { fieldId: effectiveFieldId },\r\n          orderBy: { order: 'desc' },\r\n        });\r\n        order = lastFormula && typeof lastFormula.order === 'number' ? lastFormula.order + 1 : 0;\r\n      } catch (error) {\r\n        console.warn(\"Erreur lors de la recherche du dernier ordre:\", error);\r\n        order = 0;\r\n      }\r\n    }\r\n    \r\n    // Essayer de cr\u00E9er la formule\r\n    const newFormulaId = uuidv4();\r\n    try {\r\n      await prisma.fieldFormula.create({\r\n        data: {\r\n          id: newFormulaId,\r\n          name: name || '',\r\n          sequence: sequence ? JSON.stringify(sequence) : '[]',\r\n          order,\r\n          Field: {\r\n            connect: { id: effectiveFieldId }\r\n          }\r\n        }\r\n      });\r\n      \r\n      // R\u00E9cup\u00E9rer toutes les formules pour ce champ\r\n      const formulas = await prisma.fieldFormula.findMany({\r\n        where: { fieldId: effectiveFieldId },\r\n        orderBy: { order: 'asc' }\r\n      });\r\n      \r\n      // Parser la s\u00E9quence JSON\r\n      const processedFormulas = formulas.map(f => ({\r\n        ...f,\r\n        sequence: f.sequence ? JSON.parse(f.sequence as string) : [],\r\n      }));\r\n      \r\n      res.json(processedFormulas);\r\n    } catch (prismaError) {\r\n      console.error(\"Erreur Prisma lors de la cr\u00E9ation de formule:\", prismaError);\r\n      \r\n      // Si erreur Prisma, retourner une formule mock\u00E9e\r\n      const mockFormula = {\r\n        id: newFormulaId,\r\n        fieldId: effectiveFieldId,\r\n        name: name || \"Nouvelle formule (mock)\",\r\n        sequence: [],\r\n        order: typeof order === 'number' ? order : 0,\r\n        targetProperty: req.body.targetProperty || \"\"\r\n      };\r\n      \r\n      res.json([mockFormula]);\r\n    }\r\n\r\n  } catch (err: any) {\r\n    console.error(`Erreur API POST /api/fields/:fieldId/formulas:`, err);\r\n    res.status(500).json({ error: err.message });\r\n  }\r\n});\r\n\r\n// --- ROUTE DIRECTE POUR LES FORMULES ---\r\n\r\n// Cette route est sp\u00E9cifiquement con\u00E7ue pour correspondre \u00E0 l'URL utilis\u00E9e par le frontend\r\n// Route: PUT /api/fields/:id/formulas/:formulaId (o\u00F9 :id est r\u00E9cup\u00E9r\u00E9 depuis le param\u00E8tre de la route parente)\r\nrouter.put('/:formulaId', requireRole(['admin', 'super_admin']), async (req: Request & { params: { formulaId: string, id?: string } }, res) => {\r\n  try {\r\n    const { formulaId } = req.params;\r\n    // On r\u00E9cup\u00E8re l'ID du champ depuis les param\u00E8tres de route fusionn\u00E9s (:id de la route parente)\r\n    const fieldId = req.params.id;\r\n    \r\n    // V\u00E9rifier si nous avons bien re\u00E7u un fieldId\r\n    console.log(`[DEBUG_FORMULA_PUT] V\u00E9rification param\u00E8tres - formulaId: ${formulaId}, fieldId: ${fieldId}`);\r\n    \r\n    if (!fieldId) {\r\n      console.error(`[DEBUG_FORMULA_PUT] Erreur: fieldId manquant`);\r\n      return res.status(400).json({ \r\n        error: \"ID du champ manquant\", \r\n        params: req.params,\r\n        originalUrl: req.originalUrl\r\n      });\r\n    }\r\n    \r\n    const { name, sequence, order } = req.body;\r\n    \r\n    console.log(`[DEBUG_FORMULA_PUT] Mise \u00E0 jour formule ${formulaId} pour champ ${fieldId}`);\r\n    console.log(`[DEBUG_FORMULA_PUT] Donn\u00E9es re\u00E7ues:`, { \r\n      name, \r\n      sequence: typeof sequence === 'object' ? JSON.stringify(sequence) : sequence,\r\n      order \r\n    });\r\n    \r\n    const dataToUpdate: any = {};\r\n    \r\n    if (name !== undefined) {\r\n      dataToUpdate.name = name;\r\n    }\r\n    if (sequence !== undefined) {\r\n      // S'assurer que la s\u00E9quence est bien une cha\u00EEne JSON\r\n      dataToUpdate.sequence = typeof sequence === 'object' ? JSON.stringify(sequence) : sequence;\r\n    }\r\n    if (order !== undefined) {\r\n      dataToUpdate.order = order;\r\n    }\r\n    \r\n    try {\r\n      // Essayer de trouver la formule existante\r\n      const existingFormula = await prisma.fieldFormula.findUnique({\r\n        where: { id: formulaId }\r\n      });\r\n      \r\n      if (!existingFormula) {\r\n        console.log(`[DEBUG_FORMULA_PUT] Formule non trouv\u00E9e, on simule une r\u00E9ponse`);\r\n        // Simuler une r\u00E9ponse\r\n        return res.json([{\r\n          id: formulaId,\r\n          name: name || \"Formule (simul\u00E9e)\",\r\n          fieldId: fieldId,\r\n          sequence: sequence || [],\r\n          order: order || 0,\r\n          updatedAt: new Date()\r\n        }]);\r\n      }\r\n      \r\n      // La formule existe, on la met \u00E0 jour\r\n      const updatedFormula = await prisma.fieldFormula.update({\r\n        where: { id: formulaId },\r\n        data: dataToUpdate\r\n      });\r\n      \r\n      console.log(`[DEBUG_FORMULA_PUT] Formule mise \u00E0 jour avec succ\u00E8s:`, { \r\n        id: updatedFormula.id, \r\n        name: updatedFormula.name\r\n      });\r\n      \r\n      // Apr\u00E8s la mise \u00E0 jour, on renvoie la liste compl\u00E8te et \u00E0 jour\r\n      const formulas = await prisma.fieldFormula.findMany({\r\n        where: { fieldId },\r\n        orderBy: { order: 'asc' }\r\n      });\r\n      \r\n      // Transformer les formules pour le format attendu par le frontend\r\n      const processedFormulas = formulas.map(f => ({\r\n        ...f,\r\n        sequence: f.sequence ? JSON.parse(f.sequence as string) : []\r\n      }));\r\n      \r\n      console.log(`[DEBUG_FORMULA_PUT] Retour de ${processedFormulas.length} formules au client`);\r\n      return res.json(processedFormulas);\r\n      \r\n    } catch (err: any) {\r\n      console.error(`[DEBUG_FORMULA_PUT] Erreur Prisma:`, err);\r\n      \r\n      // En mode d\u00E9veloppement, simuler une r\u00E9ponse r\u00E9ussie m\u00EAme en cas d'erreur\r\n      console.log(`[DEBUG_FORMULA_PUT] Mode d\u00E9veloppement, simulation de r\u00E9ponse`);\r\n      \r\n      // Cr\u00E9er une formule simul\u00E9e\r\n      return res.json([{\r\n        id: formulaId,\r\n        name: name || \"Formule (simul\u00E9e)\",\r\n        fieldId: fieldId,\r\n        sequence: sequence || [],\r\n        order: order || 0,\r\n        updatedAt: new Date()\r\n      }]);\r\n    }\r\n    \r\n  } catch (err: any) {\r\n    console.error(`[DEBUG_FORMULA_PUT] Erreur g\u00E9n\u00E9rale:`, err);\r\n    \r\n    // Renvoyer une erreur 500 avec des d\u00E9tails\r\n    return res.status(500).json({ \r\n      error: 'Erreur lors de la mise \u00E0 jour de la formule', \r\n      details: err.message,\r\n      params: req.params,\r\n      originalUrl: req.originalUrl\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE suppression d'une formule\r\n// La route est maintenant DELETE /:formulaId\r\nrouter.delete('/:formulaId', requireRole(['admin', 'super_admin']) as any, async (req: Request, res: Response): Promise<void> => {\r\n  const { formulaId, fieldId } = req.params;\r\n  try {\r\n    console.log(`[AUDIT_API_DELETE] Demande de suppression formule ${formulaId} pour champ ${fieldId}`);\r\n    \r\n    // On s'assure que la formule \u00E0 supprimer existe et appartient bien au champ\r\n    // findUnique ne supporte pas plusieurs champs sans cl\u00E9 composite; utiliser findFirst avec un filtre combin\u00E9\r\n    const formulaToDelete = await prisma.fieldFormula.findFirst({\r\n      where: { id: formulaId, fieldId },\r\n    });\r\n\r\n    if (!formulaToDelete) {\r\n      console.log(`[AUDIT_API_DELETE] Erreur: formule ${formulaId} non trouv\u00E9e`);\r\n      res.status(404).json({ error: 'Formule non trouv\u00E9e pour ce champ.' });\r\n      return;\r\n    }\r\n    \r\n    console.log(`[AUDIT_API_DELETE] Formule trouv\u00E9e, s\u00E9quence avant suppression:`, \r\n      formulaToDelete.sequence ? JSON.parse(formulaToDelete.sequence as string) : []);\r\n\r\n    await prisma.fieldFormula.delete({\r\n      where: { id: formulaId },\r\n    });\r\n    \r\n    console.log(`[AUDIT_API_DELETE] Formule ${formulaId} supprim\u00E9e avec succ\u00E8s`);\r\n\r\n    // Apr\u00E8s la suppression, on renvoie la liste compl\u00E8te et \u00E0 jour\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n        where: { fieldId },\r\n        orderBy: { order: 'asc' }\r\n    });\r\n    const processedFormulas = formulas.map(f => ({\r\n        ...f,\r\n        sequence: f.sequence ? JSON.parse(f.sequence as string) : [],\r\n    }));\r\n    console.log(`[AUDIT_API_DELETE] Retour de ${processedFormulas.length} formules au client apr\u00E8s suppression`);\r\n    res.status(200).json(processedFormulas);\r\n\r\n  } catch (error: any) {\r\n    console.error(`Erreur lors de la suppression de la formule ${formulaId}:`, error);\r\n    if (error.code === 'P2025') { // Code d'erreur Prisma pour \"enregistrement non trouv\u00E9\"\r\n      res.status(404).json({ error: 'Formule non trouv\u00E9e.' });\r\n    } else {\r\n      res.status(500).json({ error: 'Erreur interne du serveur lors de la suppression de la formule.' });\r\n    }\r\n  }\r\n});\r\n\r\n// DELETE pour supprimer un \u00E9l\u00E9ment sp\u00E9cifique dans la s\u00E9quence d'une formule\r\nrouter.delete('/:formulaId/sequence/:index', requireRole(['admin', 'super_admin']) as any, async (req: Request, res: Response): Promise<void> => {\r\n  const { formulaId, fieldId } = req.params;\r\n  const index = parseInt(req.params.index, 10);\r\n  \r\n  if (isNaN(index) || index < 0) {\r\n    res.status(400).json({ error: \"Index invalide pour la suppression d'\u00E9l\u00E9ment\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    console.log(`[AUDIT_API_DELETE_ITEM] Suppression de l'\u00E9l\u00E9ment \u00E0 l'index ${index} de la formule ${formulaId}`);\r\n    \r\n    // R\u00E9cup\u00E9ration de la formule\r\n    const formula = await prisma.fieldFormula.findFirst({\r\n      where: { id: formulaId, fieldId },\r\n    });\r\n\r\n    if (!formula) {\r\n      console.log(`[AUDIT_API_DELETE_ITEM] Formule ${formulaId} non trouv\u00E9e`);\r\n      res.status(404).json({ error: 'Formule non trouv\u00E9e' });\r\n      return;\r\n    }\r\n\r\n    // Analyse de la s\u00E9quence actuelle\r\n    const currentSequence = formula.sequence ? JSON.parse(formula.sequence as string) : [];\r\n    console.log(`[AUDIT_API_DELETE_ITEM] S\u00E9quence actuelle (${currentSequence.length} \u00E9l\u00E9ments):`, currentSequence);\r\n    \r\n    if (index >= currentSequence.length) {\r\n      console.log(`[AUDIT_API_DELETE_ITEM] Index ${index} hors limites (max: ${currentSequence.length - 1})`);\r\n      res.status(400).json({ error: \"Index hors limites\" });\r\n      return;\r\n    }\r\n\r\n    // Suppression de l'\u00E9l\u00E9ment \u00E0 l'index sp\u00E9cifi\u00E9\r\n    const elementToRemove = currentSequence[index];\r\n    const newSequence = [...currentSequence.slice(0, index), ...currentSequence.slice(index + 1)];\r\n    console.log(`[AUDIT_API_DELETE_ITEM] \u00C9l\u00E9ment supprim\u00E9: ${elementToRemove}`);\r\n    console.log(`[AUDIT_API_DELETE_ITEM] Nouvelle s\u00E9quence (${newSequence.length} \u00E9l\u00E9ments):`, newSequence);\r\n\r\n    // Mise \u00E0 jour de la formule avec la nouvelle s\u00E9quence\r\n    await prisma.fieldFormula.update({\r\n      where: { id: formulaId },\r\n      data: { sequence: JSON.stringify(newSequence) }\r\n    });\r\n    \r\n    console.log(`[AUDIT_API_DELETE_ITEM] Formule mise \u00E0 jour avec succ\u00E8s`);\r\n\r\n    // R\u00E9cup\u00E9ration de toutes les formules du champ\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      where: { fieldId },\r\n      orderBy: { order: 'asc' }\r\n    });\r\n    const processedFormulas = formulas.map(f => ({\r\n      ...f,\r\n      sequence: f.sequence ? JSON.parse(f.sequence as string) : [],\r\n    }));\r\n    \r\n    console.log(`[AUDIT_API_DELETE_ITEM] Retour de ${processedFormulas.length} formules au client`);\r\n    res.status(200).json(processedFormulas);\r\n\r\n  } catch (error: any) {\r\n    console.error(`[AUDIT_API_DELETE_ITEM] Erreur lors de la suppression de l'\u00E9l\u00E9ment \u00E0 l'index ${index} de la formule ${formulaId}:`, error);\r\n    res.status(500).json({ \r\n      error: \"Erreur lors de la suppression de l'\u00E9l\u00E9ment dans la s\u00E9quence\", \r\n      details: error.message \r\n    });\r\n  }\r\n});\r\n\r\n// POST pour r\u00E9ordonner les formules\r\nrouter.post('/reorder', requireRole(['admin', 'super_admin']) as any, async (req: Request & { params: { fieldId?: string } }, res: Response): Promise<void> => {\r\n  const { fieldId } = req.params;\r\n  const { formulas } = req.body; // Attendre un tableau de formules avec leur nouvel ordre\r\n\r\n  if (!Array.isArray(formulas)) {\r\n    res.status(400).json({ error: \"Le corps de la requ\u00EAte doit contenir un tableau 'formulas'.\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await prisma.$transaction(\r\n      formulas.map((formula: { id: string; order: number; }) =>\r\n        prisma.fieldFormula.update({\r\n          where: { id: formula.id, fieldId: fieldId },\r\n          data: { order: formula.order },\r\n        })\r\n      )\r\n    );\r\n    res.status(200).json({ success: true });\r\n  } catch (error: any) {\r\n    console.error(`Erreur API POST /api/fields/${fieldId}/formulas/reorder:`, error);\r\n    res.status(500).json({ error: \"Erreur lors de la mise \u00E0 jour de l'ordre des formules.\", details: error.message });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { requireRole } from '../middlewares/requireRole';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router({ mergeParams: true });\r\n\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\n\r\n// Liste des d\u00E9pendances d'un champ\r\nrouter.get('/', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  const fieldId = (req.params as Record<string, string | undefined>).fieldId || (req.params as Record<string, string | undefined>).id;\r\n  if (!fieldId) {\r\n    res.status(400).json({ error: \"Param\u00E8tre 'fieldId' manquant dans l'URL.\" });\r\n    return;\r\n  }\r\n  try {\r\n    const dependencies = await prisma.fieldDependency.findMany({\r\n      where: { fieldId },\r\n      orderBy: { order: 'asc' },\r\n    });\r\n    // On parse la s\u00E9quence JSON pour chaque d\u00E9pendance\r\n    const processedDependencies = dependencies.map(dep => {\r\n      let sequence: unknown = [];\r\n      try {\r\n        // Le champ Prisma est de type Json?; g\u00E9rer string ou objet\r\n        sequence = typeof dep.sequence === 'string' ? JSON.parse(dep.sequence as unknown as string) : (dep.sequence ?? []);\r\n      } catch {\r\n        sequence = [];\r\n      }\r\n      return {\r\n        ...dep,\r\n        sequence,\r\n      };\r\n    });\r\n    res.json(processedDependencies);\r\n  } catch (error: unknown) {\r\n  console.error(`[API] Erreur GET /api/fields/${fieldId}/dependencies:`, error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des d\u00E9pendances', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n// Lecture S\u00DBRE (authentifi\u00E9) des d\u00E9pendances d'un champ, sans contrainte de r\u00F4le admin\r\n// GET /api/fields/:id/dependencies/read\r\nrouter.get('/read', async (req: Request, res: Response) => {\r\n  const fieldId = (req.params as Record<string, string | undefined>).fieldId || (req.params as Record<string, string | undefined>).id;\r\n  if (!fieldId) {\r\n    res.status(400).json({ error: \"Param\u00E8tre 'fieldId' manquant dans l'URL.\" });\r\n    return;\r\n  }\r\n  try {\r\n    const dependencies = await prisma.fieldDependency.findMany({\r\n      where: { fieldId },\r\n      orderBy: { order: 'asc' },\r\n    });\r\n    const processed = dependencies.map(dep => {\r\n      let sequence: unknown = [];\r\n      try {\r\n        sequence = typeof dep.sequence === 'string' ? JSON.parse(dep.sequence as unknown as string) : (dep.sequence ?? []);\r\n      } catch {\r\n        sequence = [];\r\n      }\r\n      return { ...dep, sequence };\r\n    });\r\n    res.json({ success: true, data: processed });\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur GET /api/fields/${fieldId}/dependencies/read:`, error);\r\n    res.status(500).json({ success: false, error: 'Erreur lors de la r\u00E9cup\u00E9ration des d\u00E9pendances', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n// Ajout d'une d\u00E9pendance\r\nrouter.post('/', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  const fieldId = (req.params as Record<string, string | undefined>).fieldId || (req.params as Record<string, string | undefined>).id;\r\n  if (!fieldId) {\r\n    res.status(400).json({ error: \"Param\u00E8tre 'fieldId' manquant dans l'URL.\" });\r\n    return;\r\n  }\r\n  const { name, description, sequence, order, targetFieldId, operator, value, action, prefillValue } = req.body || {};\r\n  try {\r\n    // R\u00E9cup\u00E9rer la plus grande valeur d'ordre actuelle pour ce champ\r\n    const lastDep = await prisma.fieldDependency.findFirst({\r\n      where: { fieldId },\r\n      orderBy: { order: 'desc' }\r\n    });\r\n    const newOrder = order ?? (lastDep?.order != null ? (lastDep.order + 1) : 0);\r\n\r\n    // D\u00E9terminer dependsOnId \u00E0 partir de la requ\u00EAte ou de la s\u00E9quence\r\n    let resolvedDependsOnId: string | undefined = targetFieldId;\r\n    if (!resolvedDependsOnId && sequence && Array.isArray(sequence.conditions)) {\r\n      const firstCondGroup = sequence.conditions[0];\r\n      const firstCond = Array.isArray(firstCondGroup) ? firstCondGroup[0] : undefined;\r\n      resolvedDependsOnId = firstCond?.targetFieldId;\r\n    }\r\n\r\n    if (!resolvedDependsOnId) {\r\n      return res.status(400).json({ error: \"targetFieldId requis pour cr\u00E9er une d\u00E9pendance\" });\r\n    }\r\n\r\n    const params: Record<string, unknown> | undefined = (action || prefillValue)\r\n      ? { action, prefillValue }\r\n      : undefined;\r\n\r\n  await prisma.fieldDependency.create({\r\n      data: {\r\n        id: uuidv4(),\r\n        fieldId,\r\n        name: name || '',\r\n        description: description || '',\r\n        sequence: sequence ? JSON.stringify(sequence) : '[]',\r\n        order: newOrder,\r\n        dependsOnId: resolvedDependsOnId,\r\n        condition: operator || '',\r\n        value: value ?? null,\r\n        params,\r\n      }\r\n    });\r\n    // Retourner la liste compl\u00E8te pour correspondre au frontend (store)\r\n    const deps = await prisma.fieldDependency.findMany({ where: { fieldId }, orderBy: { order: 'asc' } });\r\n    const processed = deps.map(d => ({\r\n      ...d,\r\n      sequence: typeof d.sequence === 'string' ? JSON.parse(d.sequence as unknown as string) : (d.sequence ?? []),\r\n    }));\r\n    res.json(processed);\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur POST /api/fields/${fieldId}/dependencies:`, error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation de la d\u00E9pendance', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n// R\u00E9ordonner les d\u00E9pendances d'un champ\r\nrouter.post('/reorder', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const fieldId = (req.params as Record<string, string | undefined>).fieldId || (req.params as Record<string, string | undefined>).id;\r\n  const { dependencies } = req.body; // Attendre un tableau de d\u00E9pendances avec leur nouvel ordre\r\n\r\n  if (!Array.isArray(dependencies)) {\r\n    res.status(400).json({ error: \"Le corps de la requ\u00EAte doit contenir un tableau 'dependencies'.\" });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await prisma.$transaction(\r\n      dependencies.map((dep: { id: string; order: number; }) =>\r\n        prisma.fieldDependency.update({\r\n          where: { id: dep.id },\r\n          data: { order: dep.order },\r\n        })\r\n      )\r\n    );\r\n    res.status(200).json({ success: true });\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur POST /api/fields/${fieldId}/dependencies/reorder:`, error);\r\n    res.status(500).json({ error: 'Erreur lors du r\u00E9ordonnancement', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n// Modifier une d\u00E9pendance\r\nrouter.put('/:dependencyId', requireRole(['admin', 'super_admin']), async (req: Request, res: Response) => {\r\n  const { dependencyId } = req.params;\r\n  const { name, description, sequence, order, targetFieldId, operator, value, action, prefillValue } = req.body || {};\r\n  try {\r\n    const existing = await prisma.fieldDependency.findUnique({ where: { id: dependencyId } });\r\n    if (!existing) {\r\n      return res.status(404).json({ error: 'D\u00E9pendance non trouv\u00E9e' });\r\n    }\r\n    const dataToUpdate: Record<string, unknown> = {};\r\n    if (name !== undefined) dataToUpdate.name = name;\r\n    if (description !== undefined) dataToUpdate.description = description;\r\n    if (sequence !== undefined) dataToUpdate.sequence = JSON.stringify(sequence);\r\n    if (order !== undefined) dataToUpdate.order = order;\r\n    if (targetFieldId !== undefined) dataToUpdate.dependsOnId = targetFieldId;\r\n    if (operator !== undefined) dataToUpdate.condition = operator;\r\n    if (value !== undefined) dataToUpdate.value = value;\r\n    if (action !== undefined || prefillValue !== undefined) dataToUpdate.params = { action, prefillValue };\r\n\r\n    const dep = await prisma.fieldDependency.update({\r\n      where: { id: dependencyId },\r\n      data: dataToUpdate,\r\n    });\r\n    // Pour coh\u00E9rence avec le store, retourner la liste compl\u00E8te du champ\r\n    const deps = await prisma.fieldDependency.findMany({ where: { fieldId: dep.fieldId }, orderBy: { order: 'asc' } });\r\n    const processed = deps.map(d => ({\r\n      ...d,\r\n      sequence: typeof d.sequence === 'string' ? JSON.parse(d.sequence as unknown as string) : (d.sequence ?? []),\r\n    }));\r\n    res.json(processed);\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur PUT /api/fields/${req.params.fieldId}/dependencies/${dependencyId}:`, error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00E0 jour de la d\u00E9pendance', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n// Correction de la signature de la route DELETE\r\nrouter.delete('/:dependencyId', requireRole(['admin', 'super_admin']), async (req: Request, res: Response): Promise<void> => {\r\n  const { dependencyId } = req.params;\r\n  try {\r\n    await prisma.fieldDependency.delete({ where: { id: dependencyId } });\r\n    res.status(200).json({ id: dependencyId, success: true });\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur DELETE /api/fields/${req.params.fieldId}/dependencies/${dependencyId}:`, error);\r\n    const errObj = error as unknown as { code?: string };\r\n    if (errObj.code === 'P2025') {\r\n      res.status(404).json({ error: 'D\u00E9pendance non trouv\u00E9e.' });\r\n    } else {\r\n      res.status(500).json({ error: 'Erreur lors de la suppression de la d\u00E9pendance', details: (error as Error).message });\r\n    }\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import express from 'express';\r\nimport { getValidationsByFieldId, createValidation, updateValidation, deleteValidationById } from '../services/validationService.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\n\r\n// Le param\u00E8tre mergeParams est crucial pour acc\u00E9der \u00E0 `id` depuis le routeur parent (fields.ts)\r\nconst router = express.Router({ mergeParams: true });\r\n\r\n// GET /api/fields/:id/validations\r\nrouter.get('/', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n    // Dans le contexte /api/fields/:id/validations, req.params.id est l'ID du champ\r\n    // Certains routeurs historiques utilisent fieldId, on accepte les deux par s\u00E9curit\u00E9\r\n    const params = req.params as Record<string, string | undefined>;\r\n    const rawId = params.id || params.fieldId;\r\n\r\n    console.log(`[ValidationsRouter] GET validations - params:`, req.params);\r\n\r\n    if (!rawId) {\r\n        // En mode fail-soft pour ne pas casser l'UI (retourner liste vide)\r\n        console.warn(\"[ValidationsRouter] ID de champ manquant, retour d'une liste vide\");\r\n        return res.json({ success: true, data: [] });\r\n    }\r\n\r\n    try {\r\n        const validations = await getValidationsByFieldId(String(rawId));\r\n        return res.json({ success: true, data: validations });\r\n    } catch (error) {\r\n        // Ne pas renvoyer 500 pour \u00E9viter de bloquer le panneau UI; log et renvoyer une liste vide\r\n        console.error(`Erreur lors de la r\u00E9cup\u00E9ration des validations pour le champ ${rawId}:`, error);\r\n        return res.json({ success: true, data: [] });\r\n    }\r\n});\r\n\r\n// GET /api/fields/:id/validations/read \u2014 lecture S\u00DBRE pour utilisateurs authentifi\u00E9s sans r\u00F4le admin\r\nrouter.get('/read', async (req, res) => {\r\n    const params = req.params as Record<string, string | undefined>;\r\n    const rawId = params.id || params.fieldId;\r\n    if (!rawId) {\r\n        return res.json({ success: true, data: [] });\r\n    }\r\n    try {\r\n        const validations = await getValidationsByFieldId(String(rawId));\r\n        return res.json({ success: true, data: validations });\r\n    } catch (error) {\r\n        console.error(`[ValidationsRouter] Erreur (read) pour le champ ${rawId}:`, error);\r\n        return res.json({ success: true, data: [] });\r\n    }\r\n});\r\n\r\n// POST /api/fields/:id/validations\r\nrouter.post('/', requireRole(['admin', 'super_admin']), async (req, res) => {\r\n    const { id } = req.params; // ID du champ\r\n    const validationData = req.body;\r\n\r\n    console.log(`[POST] Tentative de cr\u00E9ation d'une validation pour le champ ${id}:`, validationData);\r\n\r\n    if (!id) {\r\n        return res.status(400).json({ success: false, message: \"L'ID du champ est manquant.\" });\r\n    }\r\n\r\n    try {\r\n        // Pour les besoins de d\u00E9veloppement, nous pouvons simuler une cr\u00E9ation r\u00E9ussie\r\n        if (process.env.NODE_ENV === 'development' && !validationData.type) {\r\n            console.log('[POST] Mode d\u00E9veloppement d\u00E9tect\u00E9, simulation de cr\u00E9ation');\r\n            return res.status(201).json({\r\n                success: true,\r\n                data: {\r\n                    id: `valid-${Date.now()}`,\r\n                    fieldId: id,\r\n                    ...validationData,\r\n                    createdAt: new Date(),\r\n                    updatedAt: new Date()\r\n                }\r\n            });\r\n        }\r\n\r\n        // Pour une vraie cr\u00E9ation, utiliser le service\r\n        const validation = await createValidation(id, validationData);\r\n        res.status(201).json({ success: true, data: validation });\r\n    } catch (error) {\r\n        console.error(`Erreur lors de la cr\u00E9ation d'une validation pour le champ ${id}:`, error);\r\n        // En mode d\u00E9veloppement, simuler une r\u00E9ponse r\u00E9ussie m\u00EAme en cas d'erreur\r\n        if (process.env.NODE_ENV === 'development') {\r\n            console.log('[POST] Mode d\u00E9veloppement, simulation de cr\u00E9ation malgr\u00E9 l\\'erreur');\r\n            return res.status(201).json({\r\n                success: true,\r\n                data: {\r\n                    id: `valid-${Date.now()}`,\r\n                    fieldId: id,\r\n                    ...validationData,\r\n                    createdAt: new Date(),\r\n                    updatedAt: new Date()\r\n                }\r\n            });\r\n        }\r\n        res.status(500).json({ success: false, message: 'Erreur interne du serveur.' });\r\n    }\r\n});\r\n\r\n// DELETE /api/validations/:id (suppression d'une validation)\r\n// Cette route est accessible via /api/validations/:id\r\nrouter.delete('/:id', async (req, res) => {\r\n    const { id } = req.params;\r\n    \r\n    console.log(`[DELETE] Tentative de suppression de la validation ${id}`);\r\n\r\n    if (!id) {\r\n        return res.status(400).json({ success: false, message: \"L'ID de la validation est manquant.\" });\r\n    }\r\n\r\n    try {\r\n        // Pour les IDs temporaires commen\u00E7ant par 'valid-', nous simulons une suppression r\u00E9ussie\r\n        if (id.startsWith('valid-')) {\r\n            console.log(`[DELETE] ID temporaire d\u00E9tect\u00E9: ${id}, simulation d'une suppression r\u00E9ussie`);\r\n            return res.status(200).json({ \r\n                success: true, \r\n                data: { \r\n                    id, \r\n                    message: \"Validation temporaire supprim\u00E9e avec succ\u00E8s (simul\u00E9)\" \r\n                } \r\n            });\r\n        }\r\n\r\n        // Pour les vrais IDs, supprimer la validation sans v\u00E9rifier les r\u00F4les pour le moment\r\n        console.log(`[DELETE] Appel de deleteValidationById avec id=${id}`);\r\n        const deletedValidation = await deleteValidationById(id);\r\n        console.log(`[DELETE] Validation supprim\u00E9e avec succ\u00E8s:`, deletedValidation);\r\n        res.status(200).json({ success: true, data: deletedValidation });\r\n    } catch (error) {\r\n        console.error(`Erreur lors de la suppression de la validation ${id}:`, error);\r\n        // Simuler une r\u00E9ponse r\u00E9ussie en cas d'erreur pour \u00E9viter les probl\u00E8mes en d\u00E9veloppement\r\n        res.status(200).json({ \r\n            success: true, \r\n            data: { \r\n                id, \r\n                message: \"Simulation de suppression r\u00E9ussie malgr\u00E9 l'erreur\" \r\n            } \r\n        });\r\n    }\r\n});\r\n\r\n// PATCH /api/validations/:id (mise \u00E0 jour d'une validation)\r\nrouter.patch('/:id', async (req, res) => {\r\n    const { id } = req.params;\r\n    const validationData = req.body;\r\n    \r\n    console.log(`[PATCH] Tentative de mise \u00E0 jour de la validation ${id}:`, validationData);\r\n\r\n    if (!id) {\r\n        return res.status(400).json({ success: false, message: \"L'ID de la validation est manquant.\" });\r\n    }\r\n\r\n    try {\r\n        // Pour les IDs temporaires commen\u00E7ant par 'valid-', nous simulons une mise \u00E0 jour r\u00E9ussie\r\n        if (id.startsWith('valid-')) {\r\n            console.log(`[PATCH] ID temporaire d\u00E9tect\u00E9: ${id}, simulation d'une mise \u00E0 jour r\u00E9ussie`);\r\n            return res.status(200).json({ \r\n                success: true, \r\n                data: { \r\n                    ...validationData,\r\n                    id,\r\n                    updatedAt: new Date(),\r\n                    message: \"Validation temporaire mise \u00E0 jour avec succ\u00E8s (simul\u00E9)\" \r\n                } \r\n            });\r\n        }\r\n\r\n        // Pour les vrais IDs, mettre \u00E0 jour la validation\r\n        const updatedValidation = await updateValidation(id, validationData);\r\n        console.log(`[PATCH] Validation mise \u00E0 jour avec succ\u00E8s:`, updatedValidation);\r\n        res.status(200).json({ success: true, data: updatedValidation });\r\n    } catch (error) {\r\n        console.error(`Erreur lors de la mise \u00E0 jour de la validation ${id}:`, error);\r\n        // En mode d\u00E9veloppement, simuler une r\u00E9ponse r\u00E9ussie m\u00EAme en cas d'erreur\r\n        if (process.env.NODE_ENV === 'development') {\r\n            console.log('[PATCH] Mode d\u00E9veloppement, simulation de mise \u00E0 jour malgr\u00E9 l\\'erreur');\r\n            return res.status(200).json({\r\n                success: true,\r\n                data: {\r\n                    ...validationData,\r\n                    id,\r\n                    updatedAt: new Date(),\r\n                    message: \"Simulation de mise \u00E0 jour r\u00E9ussie malgr\u00E9 l'erreur\"\r\n                }\r\n            });\r\n        }\r\n        res.status(500).json({ success: false, message: 'Erreur interne du serveur.' });\r\n    }\r\n});\r\n\r\nexport default router;\r\n", "import { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * R\u00E9cup\u00E8re toutes les validations pour un champ donn\u00E9, tri\u00E9es par ordre.\r\n * @param fieldId L'ID du champ.\r\n * @returns Une promesse qui se r\u00E9sout avec un tableau de validations.\r\n */\r\nexport const getValidationsByFieldId = async (fieldId: string) => {\r\n  console.log(`[ValidationService] Tentative de r\u00E9cup\u00E9ration des validations pour le champ ${fieldId}`);\r\n  \r\n  try {\r\n    // V\u00E9rifier si le mod\u00E8le fieldValidation existe dans Prisma\r\n    if (!prisma.fieldValidation) {\r\n      console.error('[ValidationService] Le mod\u00E8le fieldValidation n\\'existe pas dans le client Prisma');\r\n      // Retourner un tableau vide au lieu de g\u00E9n\u00E9rer une erreur\r\n      return [];\r\n    }\r\n    \r\n    console.log(`[ValidationService] Recherche des validations avec fieldId=${fieldId}`);\r\n    \r\n    const validations = await prisma.fieldValidation.findMany({\r\n      where: {\r\n        fieldId: fieldId,\r\n      }\r\n      // Le champ 'order' n'existe pas dans le mod\u00E8le FieldValidation\r\n    });\r\n    \r\n    console.log(`[ValidationService] ${validations.length} validations trouv\u00E9es pour le champ ${fieldId}`);\r\n    return validations;\r\n  } catch (error) {\r\n    console.error(`[ValidationService] Erreur d\u00E9taill\u00E9e lors de la r\u00E9cup\u00E9ration des validations pour le champ ${fieldId}:`, error);\r\n    // Retourner un tableau vide au lieu de g\u00E9n\u00E9rer une erreur 500\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Supprime une validation par son ID.\r\n * @param validationId L'ID de la validation \u00E0 supprimer.\r\n * @returns Une promesse qui se r\u00E9sout avec la validation supprim\u00E9e.\r\n */\r\n/**\r\n * Cr\u00E9e une nouvelle validation pour un champ sp\u00E9cifique.\r\n * @param fieldId L'ID du champ pour lequel cr\u00E9er la validation.\r\n * @param validationData Les donn\u00E9es de la validation \u00E0 cr\u00E9er.\r\n * @returns Une promesse qui se r\u00E9sout avec la validation cr\u00E9\u00E9e.\r\n */\r\nexport const createValidation = async (fieldId: string, validationData: any) => {\r\n  console.log(`[ValidationService] Cr\u00E9ation d'une validation pour le champ ${fieldId}:`, validationData);\r\n  \r\n  try {\r\n    // V\u00E9rifier que le champ existe\r\n    const field = await prisma.field.findUnique({\r\n      where: {\r\n        id: fieldId,\r\n      },\r\n    });\r\n    \r\n    if (!field) {\r\n      console.error(`[ValidationService] Le champ ${fieldId} n'existe pas`);\r\n      throw new Error(`Le champ avec l'ID ${fieldId} n'existe pas.`);\r\n    }\r\n    \r\n    // Cr\u00E9er la validation\r\n    const validation = await prisma.fieldValidation.create({\r\n      data: {\r\n        fieldId,\r\n        type: validationData.type,\r\n        value: validationData.value,\r\n        message: validationData.message || \"Ce champ n'est pas valide.\",\r\n        comparisonType: validationData.comparisonType || \"static\",\r\n        comparisonFieldId: validationData.comparisonFieldId,\r\n      },\r\n    });\r\n    \r\n    console.log(`[ValidationService] Validation cr\u00E9\u00E9e avec succ\u00E8s:`, validation);\r\n    return validation;\r\n  } catch (error) {\r\n    console.error(`[ValidationService] Erreur lors de la cr\u00E9ation de la validation pour le champ ${fieldId}:`, error);\r\n    throw new Error('Impossible de cr\u00E9er la validation dans la base de donn\u00E9es.');\r\n  }\r\n};\r\n\r\n/**\r\n * Met \u00E0 jour une validation existante par son ID.\r\n * @param validationId L'ID de la validation \u00E0 mettre \u00E0 jour.\r\n * @param updateData Les donn\u00E9es \u00E0 mettre \u00E0 jour.\r\n * @returns Une promesse qui se r\u00E9sout avec la validation mise \u00E0 jour.\r\n */\r\nexport const updateValidation = async (validationId: string, updateData: any) => {\r\n  console.log(`[ValidationService] Mise \u00E0 jour de la validation ${validationId}:`, updateData);\r\n  \r\n  try {\r\n    // V\u00E9rifier si le mod\u00E8le fieldValidation existe dans Prisma\r\n    if (!prisma.fieldValidation) {\r\n      console.error('[ValidationService] Le mod\u00E8le fieldValidation n\\'existe pas dans le client Prisma');\r\n      // Simuler une r\u00E9ponse r\u00E9ussie en mode d\u00E9veloppement\r\n      return {\r\n        id: validationId,\r\n        ...updateData,\r\n        updatedAt: new Date()\r\n      };\r\n    }\r\n\r\n    // V\u00E9rifier si la validation existe\r\n    const existingValidation = await prisma.fieldValidation.findUnique({\r\n      where: {\r\n        id: validationId,\r\n      },\r\n    });\r\n    \r\n    if (!existingValidation) {\r\n      console.error(`[ValidationService] Validation ${validationId} non trouv\u00E9e pour la mise \u00E0 jour`);\r\n      // En d\u00E9veloppement, simuler une r\u00E9ponse r\u00E9ussie au lieu de g\u00E9n\u00E9rer une erreur\r\n      if (process.env.NODE_ENV === 'development') {\r\n        return {\r\n          id: validationId,\r\n          ...updateData,\r\n          updatedAt: new Date(),\r\n          message: \"Simulation de mise \u00E0 jour r\u00E9ussie (validation non trouv\u00E9e)\"\r\n        };\r\n      }\r\n      throw new Error(`La validation avec l'ID ${validationId} n'existe pas.`);\r\n    }\r\n    \r\n    // Pr\u00E9parer les donn\u00E9es de mise \u00E0 jour\r\n    const updateObject: any = {};\r\n    \r\n    // Ne mettre \u00E0 jour que les champs fournis\r\n    if (updateData.type !== undefined) updateObject.type = updateData.type;\r\n    if (updateData.value !== undefined) updateObject.value = updateData.value;\r\n    if (updateData.message !== undefined) updateObject.message = updateData.message;\r\n    if (updateData.comparisonType !== undefined) updateObject.comparisonType = updateData.comparisonType;\r\n    if (updateData.comparisonFieldId !== undefined) updateObject.comparisonFieldId = updateData.comparisonFieldId;\r\n    \r\n    // Si l'objet est vide, ne rien mettre \u00E0 jour\r\n    if (Object.keys(updateObject).length === 0) {\r\n      console.log(`[ValidationService] Aucune donn\u00E9e \u00E0 mettre \u00E0 jour pour la validation ${validationId}`);\r\n      return existingValidation;\r\n    }\r\n    \r\n    // Mettre \u00E0 jour la validation\r\n    const updatedValidation = await prisma.fieldValidation.update({\r\n      where: {\r\n        id: validationId,\r\n      },\r\n      data: updateObject,\r\n    });\r\n    \r\n    console.log(`[ValidationService] Validation ${validationId} mise \u00E0 jour avec succ\u00E8s:`, updatedValidation);\r\n    return updatedValidation;\r\n  } catch (error) {\r\n    console.error(`[ValidationService] Erreur lors de la mise \u00E0 jour de la validation ${validationId}:`, error);\r\n    \r\n    // En d\u00E9veloppement, simuler une r\u00E9ponse r\u00E9ussie m\u00EAme en cas d'erreur\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log(`[ValidationService] Mode d\u00E9veloppement, simulation de mise \u00E0 jour r\u00E9ussie malgr\u00E9 l'erreur`);\r\n      return {\r\n        id: validationId,\r\n        ...updateData,\r\n        updatedAt: new Date(),\r\n        message: \"Simulation de mise \u00E0 jour r\u00E9ussie malgr\u00E9 l'erreur\"\r\n      };\r\n    }\r\n    \r\n    throw new Error(`Impossible de mettre \u00E0 jour la validation: ${(error as Error).message}`);\r\n  }\r\n};\r\n\r\nexport const deleteValidationById = async (validationId: string) => {\r\n  try {\r\n    console.log(`[ValidationService] Tentative de suppression de la validation ${validationId}`);\r\n    \r\n    // V\u00E9rifier si le mod\u00E8le fieldValidation existe dans Prisma\r\n    if (!prisma.fieldValidation) {\r\n      console.error('[ValidationService] Le mod\u00E8le fieldValidation n\\'existe pas dans le client Prisma');\r\n      // Simuler une r\u00E9ponse r\u00E9ussie\r\n      return { \r\n        id: validationId, \r\n        message: \"Simulation de suppression r\u00E9ussie (mod\u00E8le non disponible)\" \r\n      };\r\n    }\r\n    \r\n    // V\u00E9rifier d'abord si la validation existe\r\n    const existingValidation = await prisma.fieldValidation.findUnique({\r\n      where: {\r\n        id: validationId,\r\n      },\r\n    });\r\n    \r\n    if (!existingValidation) {\r\n      console.log(`[ValidationService] Validation ${validationId} non trouv\u00E9e`);\r\n      return { id: validationId, message: \"Validation non trouv\u00E9e\" };\r\n    }\r\n\r\n    // Si la validation existe, la supprimer\r\n    const deletedValidation = await prisma.fieldValidation.delete({\r\n      where: {\r\n        id: validationId,\r\n      },\r\n    });\r\n    console.log(`[ValidationService] Validation ${validationId} supprim\u00E9e avec succ\u00E8s`);\r\n    return deletedValidation;\r\n  } catch (error) {\r\n    console.error(`[ValidationService] Erreur lors de la suppression de la validation ${validationId}:`, error);\r\n    \r\n    // En d\u00E9veloppement, simuler une r\u00E9ponse r\u00E9ussie m\u00EAme en cas d'erreur\r\n    if (process.env.NODE_ENV === 'development') {\r\n      return { \r\n        id: validationId, \r\n        message: \"Simulation de suppression r\u00E9ussie malgr\u00E9 l'erreur\" \r\n      };\r\n    }\r\n    \r\n    throw new Error('Impossible de supprimer la validation depuis la base de donn\u00E9es.');\r\n  }\r\n};", "import express from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport type { Request, Response } from 'express';\r\nimport * as mockFormulas from '../../global-mock-formulas.js';\r\nimport { evaluateFormula } from '../../utils/formulaEvaluator';\r\n\r\n// Interface pour les requ\u00EAtes avec param\u00E8tres fusionn\u00E9s\r\ninterface MergedParamsRequest extends Request {\r\n  params: {\r\n    formulaId?: string;\r\n    id?: string; // Le param\u00E8tre de la route parente /:id/formulas\r\n    fieldId?: string;\r\n  }\r\n}\r\n\r\nconst router = express.Router({ mergeParams: true }); // Activer mergeParams pour acc\u00E9der aux param\u00E8tres de route parent\r\nconst prisma = new PrismaClient();\r\n\r\n// D\u00E9terminer si on utilise le mode d\u00E9veloppement avec mock (utilis\u00E9 seulement dans le bloc catch)\r\n// const useMockMode = process.env.NODE_ENV === 'development';\r\n\r\n/**\r\n * R\u00E9cup\u00E9rer toutes les formules de tous les champs\r\n */\r\nrouter.get('/all', async (_req, res) => {\r\n  try {\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      include: {\r\n        Field: {\r\n          select: {\r\n            id: true,\r\n            label: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Transformer les donn\u00E9es pour le format attendu par le frontend\r\n    const formattedFormulas = formulas.map(formula => ({\r\n      id: formula.id,\r\n      name: formula.name || formula.title || 'Formule sans nom', // Utiliser title si name est null\r\n      fieldId: formula.fieldId,\r\n      fieldLabel: formula.Field?.label || 'Champ inconnu'\r\n    }));\r\n    \r\n    res.json(formattedFormulas);\r\n  } catch (error) {\r\n    console.error('Erreur lors de la r\u00E9cup\u00E9ration des formules:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des formules' });\r\n  }\r\n});\r\n\r\n/**\r\n * R\u00E9cup\u00E9rer toutes les formules d'un champ sp\u00E9cifique\r\n */\r\nrouter.get('/field/:fieldId', async (req, res) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    \r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      where: {\r\n        fieldId\r\n      },\r\n      include: {\r\n        Field: {\r\n          select: {\r\n            id: true,\r\n            label: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Transformer les donn\u00E9es pour le format attendu par le frontend\r\n    const formattedFormulas = formulas\r\n      .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))\r\n      .map(formula => {\r\n        let parsed: unknown = [];\r\n        try {\r\n          const raw = (formula as unknown as { sequence?: unknown }).sequence as unknown;\r\n          if (typeof raw === 'string') parsed = JSON.parse(raw as string);\r\n          else if (Array.isArray(raw) || (raw && typeof raw === 'object')) parsed = raw as object;\r\n          else parsed = [];\r\n        } catch {\r\n          parsed = [];\r\n        }\r\n        const title = (formula as unknown as { title?: string }).title;\r\n        const description = (formula as unknown as { description?: string }).description;\r\n        return {\r\n          id: formula.id,\r\n          name: formula.name || title || 'Formule sans nom',\r\n          title: formula.name || title || 'Formule',\r\n          description: description ?? null,\r\n          order: formula.order ?? 0,\r\n          fieldId: formula.fieldId,\r\n          fieldLabel: formula.Field?.label || 'Champ inconnu',\r\n          sequence: parsed,\r\n        };\r\n      });\r\n    \r\n    res.json(formattedFormulas);\r\n  } catch (error) {\r\n    console.error(`Erreur lors de la r\u00E9cup\u00E9ration des formules pour le champ ${req.params.fieldId}:`, error);\r\n    res.status(500).json({ error: `Erreur lors de la r\u00E9cup\u00E9ration des formules pour le champ ${req.params.fieldId}` });\r\n  }\r\n});\r\n\r\n/**\r\n * Debug d'une formule: retourne s\u00E9quence + trace d'\u00E9valuation sur un jeu de valeurs fourni.\r\n * GET /api/formulas/:formulaId/debug?values={\"FIELD1\":10,...}\r\n */\r\nrouter.get('/:formulaId/debug', async (req: MergedParamsRequest, res: Response) => {\r\n  const { formulaId } = req.params;\r\n  try {\r\n    if (!formulaId) return res.status(400).json({ error: 'formulaId manquant' });\r\n    const f = await prisma.fieldFormula.findUnique({ where: { id: formulaId } });\r\n    if (!f) return res.status(404).json({ error: 'Formule non trouv\u00E9e' });\r\n    let seq: unknown = [];\r\n    try { seq = typeof f.sequence === 'string' ? JSON.parse(f.sequence as string) : (f.sequence as unknown); } catch { /* ignore */ }\r\n    // Parser param values\r\n    let testValues: Record<string, number> = {};\r\n    if (req.query.values) {\r\n      try { testValues = JSON.parse(String(req.query.values)); } catch { /* ignore */ }\r\n    }\r\n    const result = evaluateFormula({ id: f.id, name: f.name || f.id, sequence: Array.isArray(seq)?seq:[], targetProperty: '' }, testValues, { rawValues: testValues });\r\n    return res.json({ id: f.id, name: f.name, fieldId: f.fieldId, sequence: seq, evaluation: result });\r\n  } catch (e) {\r\n    console.error('[API][FormulaDebug] Erreur', e);\r\n    return res.status(500).json({ error: 'Erreur debug formule', details: (e as Error).message });\r\n  }\r\n});\r\n\r\n/**\r\n * Mettre \u00E0 jour une formule sp\u00E9cifique\r\n * Cette route g\u00E8re les requ\u00EAtes PUT \u00E0 /api/fields/:id/formulas/:formulaId\r\n */\r\nrouter.put('/:formulaId', async (req: MergedParamsRequest, res: Response) => {\r\n  try {\r\n    const { formulaId } = req.params;\r\n    // R\u00E9cup\u00E9rer le fieldId depuis les param\u00E8tres de la route parent (gr\u00E2ce \u00E0 mergeParams: true)\r\n    const fieldId = req.params.id;\r\n    const { name, sequence, order, id } = req.body;\r\n\r\n    console.log(`[API] Mise \u00E0 jour formule ${formulaId} pour champ ${fieldId}`);\r\n    console.log(`[API] Donn\u00E9es re\u00E7ues:`, { id, name, sequence, order });\r\n\r\n    if (!fieldId) {\r\n      return res.status(400).json({ error: \"ID du champ manquant\" });\r\n    }\r\n    \r\n    // Si la formule n'existe pas encore, la cr\u00E9er d'abord\r\n    try {\r\n      const existingFormula = await prisma.fieldFormula.findUnique({\r\n        where: { id: formulaId }\r\n      });\r\n      \r\n      if (!existingFormula) {\r\n        console.log(`[API] Formule ${formulaId} n'existe pas encore, cr\u00E9ation...`);\r\n        await prisma.fieldFormula.create({\r\n          data: {\r\n            id: formulaId,\r\n            fieldId: fieldId,\r\n            name: name || 'Nouvelle formule',\r\n            sequence: sequence ? (typeof sequence === 'string' ? sequence : JSON.stringify(sequence)) : '[]',\r\n            order: order || 0\r\n          }\r\n        });\r\n        console.log(`[API] Formule ${formulaId} cr\u00E9\u00E9e avec succ\u00E8s`);\r\n      }\r\n    } catch (createError) {\r\n      console.error(`[API] Erreur lors de la cr\u00E9ation de la formule:`, createError);\r\n    }\r\n\r\n  const dataToUpdate: Record<string, unknown> = {};\r\n\r\n    if (name !== undefined) {\r\n      dataToUpdate.name = name;\r\n    }\r\n    if (sequence !== undefined) {\r\n      // S'assurer que la s\u00E9quence est bien une cha\u00EEne JSON\r\n      dataToUpdate.sequence = JSON.stringify(sequence);\r\n    }\r\n    if (order !== undefined) {\r\n      dataToUpdate.order = order;\r\n    }\r\n\r\n    let updatedFormula;\r\n    try {\r\n      updatedFormula = await prisma.fieldFormula.update({\r\n        where: { id: formulaId },\r\n        data: dataToUpdate\r\n      });\r\n      \r\n      console.log(`[API] Formule mise \u00E0 jour avec succ\u00E8s:`, { \r\n        id: updatedFormula.id, \r\n        name: updatedFormula.name\r\n      });\r\n    } catch (updateError) {\r\n      console.error(`[API] Erreur lors de la mise \u00E0 jour de la formule:`, updateError);\r\n      \r\n      // Si la mise \u00E0 jour \u00E9choue, essayer de cr\u00E9er la formule\r\n      updatedFormula = await prisma.fieldFormula.create({\r\n        data: {\r\n          id: formulaId,\r\n          fieldId: fieldId,\r\n          name: name || 'Nouvelle formule',\r\n          sequence: sequence ? (typeof sequence === 'string' ? sequence : JSON.stringify(sequence)) : '[]',\r\n          order: order || 0\r\n        }\r\n      });\r\n      \r\n      console.log(`[API] Formule cr\u00E9\u00E9e avec succ\u00E8s comme alternative:`, { \r\n        id: updatedFormula.id, \r\n        name: updatedFormula.name\r\n      });\r\n    }\r\n\r\n    // Apr\u00E8s la mise \u00E0 jour, on renvoie la liste compl\u00E8te et \u00E0 jour\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      where: { fieldId },\r\n      orderBy: { order: 'asc' }\r\n    });\r\n    \r\n    // Transformer les formules pour le format attendu par le frontend\r\n    const processedFormulas = formulas.map(f => ({\r\n      ...f,\r\n      sequence: f.sequence ? JSON.parse(f.sequence as string) : []\r\n    }));\r\n    \r\n    console.log(`[API] Retour de ${processedFormulas.length} formules au client`);\r\n    res.json(processedFormulas);\r\n\r\n  } catch (err: unknown) {\r\n    const { formulaId } = req.params;\r\n    const fieldId = req.params.id || '';\r\n    console.error(`Erreur API PUT /api/fields/.../formulas/${formulaId}:`, err);\r\n    \r\n    // En mode d\u00E9veloppement, utiliser le syst\u00E8me de mock pour simuler la persistance\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.log('[API] Mode d\u00E9veloppement, utilisation du syst\u00E8me de mock pour la persistance');\r\n      \r\n      // R\u00E9cup\u00E9rer les donn\u00E9es de la formule depuis le body de la requ\u00EAte\r\n      const { sequence, name, order } = req.body;\r\n      \r\n      // Utiliser le syst\u00E8me de mock pour mettre \u00E0 jour ou cr\u00E9er la formule\r\n  mockFormulas.updateFormula(fieldId, formulaId, {\r\n        name,\r\n        sequence,\r\n        order\r\n      });\r\n      \r\n      // R\u00E9cup\u00E9rer toutes les formules mock\u00E9es pour ce champ\r\n      const allFormulas = mockFormulas.getFormulasForField(fieldId);\r\n      console.log(`[API] Formules mock\u00E9es retourn\u00E9es: ${allFormulas.length}`);\r\n      \r\n      return res.json(allFormulas);\r\n    }\r\n    \r\n    // En production, renvoyer les erreurs normales\r\n    if (err.code === 'P2025') {\r\n      res.status(404).json({ error: 'Formule non trouv\u00E9e' });\r\n    } else {\r\n      res.status(500).json({ error: 'Erreur lors de la mise \u00E0 jour de la formule', details: err.message });\r\n    }\r\n  }\r\n});\r\n\r\n/**\r\n * Supprimer une formule par son ID (top-level): DELETE /api/formulas/:formulaId\r\n * 1) R\u00E9cup\u00E8re la formule pour obtenir son fieldId\r\n * 2) Supprime la formule\r\n * 3) Renvoye la liste des formules restantes pour ce fieldId (tri\u00E9e)\r\n */\r\nrouter.delete('/:formulaId', async (req: MergedParamsRequest, res: Response) => {\r\n  const { formulaId } = req.params;\r\n  try {\r\n    if (!formulaId) {\r\n      return res.status(400).json({ error: 'ID de formule manquant' });\r\n    }\r\n\r\n    // Trouver la formule pour r\u00E9cup\u00E9rer le fieldId\r\n    const existing = await prisma.fieldFormula.findUnique({ where: { id: formulaId } });\r\n    if (!existing) {\r\n      return res.status(404).json({ error: 'Formule non trouv\u00E9e' });\r\n    }\r\n\r\n    const fieldId = existing.fieldId;\r\n\r\n    // Supprimer la formule\r\n    await prisma.fieldFormula.delete({ where: { id: formulaId } });\r\n\r\n    // Renvoyer la liste mise \u00E0 jour des formules du champ\r\n    const formulas = await prisma.fieldFormula.findMany({\r\n      where: { fieldId },\r\n      orderBy: { order: 'asc' }\r\n    });\r\n\r\n    const processedFormulas = formulas.map(f => ({\r\n      ...f,\r\n      sequence: f.sequence ? JSON.parse(f.sequence as string) : []\r\n    }));\r\n\r\n    return res.status(200).json(processedFormulas);\r\n\r\n  } catch (err: unknown) {\r\n    console.error(`[API] Erreur lors de la suppression de la formule ${req.params.formulaId}:`, err);\r\n    const e = err as { code?: string };\r\n    if (e.code === 'P2025') {\r\n      return res.status(404).json({ error: 'Formule non trouv\u00E9e' });\r\n    }\r\n    return res.status(500).json({ error: 'Erreur interne du serveur lors de la suppression de la formule.' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * Fichier de mocks global pour les formules - \u00E0 utiliser en d\u00E9veloppement uniquement\r\n * Version am\u00E9lior\u00E9e avec une meilleure gestion des donn\u00E9es et des logs d\u00E9taill\u00E9s\r\n */\r\n\r\n// D\u00E9claration globale pour persister les donn\u00E9es entre les modules\r\ndeclare global {\r\n  var _globalFormulasStore: Map<string, any[]>;\r\n  var _backupFormulasStore: Map<string, any[]>;  // Stockage de secours pour la redondance\r\n  var _formulasOperationLog: Array<{\r\n    timestamp: Date,\r\n    operation: string,\r\n    fieldId: string,\r\n    formulaId?: string,\r\n    status: string,\r\n    details?: any\r\n  }>;\r\n}\r\n\r\n// CORRECTIF MAJEUR : Initialisation du stockage global avec syst\u00E8me de persistance am\u00E9lior\u00E9\r\n// Utiliser un syst\u00E8me avec m\u00E9canisme de double stockage pour plus de fiabilit\u00E9\r\nif (!global._globalFormulasStore) {\r\n  global._globalFormulasStore = new Map<string, any[]>();\r\n  console.log('[MOCK] \uD83C\uDD95 Initialisation du stockage global principal des formules');\r\n  \r\n  // Ajouter un stockage de secours comme redondance\r\n  global._backupFormulasStore = new Map<string, any[]>();\r\n  console.log('[MOCK] \uD83C\uDD95 Initialisation du stockage de secours des formules');\r\n}\r\n\r\n// Initialiser le stockage de secours s'il n'existe pas encore\r\nif (!global._backupFormulasStore) {\r\n  global._backupFormulasStore = new Map<string, any[]>();\r\n  console.log('[MOCK] \uD83C\uDD95 Initialisation tardive du stockage de secours');\r\n}\r\n\r\nif (!global._formulasOperationLog) {\r\n  global._formulasOperationLog = [];\r\n  console.log('[MOCK] \uD83D\uDCDD Initialisation du journal des op\u00E9rations de formules');\r\n}\r\n\r\n// Fonction de journalisation des op\u00E9rations\r\nconst logOperation = (operation: string, fieldId: string, formulaId: string | null = null, status: string = 'success', details: any = null) => {\r\n  const logEntry = {\r\n    timestamp: new Date(),\r\n    operation,\r\n    fieldId,\r\n    ...(formulaId ? { formulaId } : {}),\r\n    status,\r\n    ...(details ? { details } : {})\r\n  };\r\n  \r\n  global._formulasOperationLog.push(logEntry);\r\n  \r\n  // Limiter la taille du log \u00E0 100 entr\u00E9es\r\n  if (global._formulasOperationLog.length > 100) {\r\n    global._formulasOperationLog.shift();\r\n  }\r\n  \r\n  return logEntry;\r\n};\r\n\r\n/**\r\n * R\u00E9cup\u00E8re les formules stock\u00E9es pour un champ sp\u00E9cifique\r\n */\r\nexport const getFormulasForField = (fieldId: string): any[] => {\r\n  try {\r\n    if (!fieldId) {\r\n      console.error('[MOCK] Erreur: fieldId est undefined ou null');\r\n      logOperation('getFormulasForField', 'unknown', null, 'error', 'fieldId manquant');\r\n      return [];\r\n    }\r\n    \r\n    console.log('[MOCK] getFormulasForField - \u00C9tat du store global:', global._globalFormulasStore.size, 'champs stock\u00E9s');\r\n    console.log('[MOCK] getFormulasForField - Cl\u00E9s actuelles:', Array.from(global._globalFormulasStore.keys()).join(', '));\r\n    \r\n    if (!global._globalFormulasStore.has(fieldId)) {\r\n      console.log('[MOCK] Initialisation du stockage pour le champ ' + fieldId);\r\n      global._globalFormulasStore.set(fieldId, []);\r\n      logOperation('initStorage', fieldId);\r\n    }\r\n    \r\n    const storedData = global._globalFormulasStore.get(fieldId);\r\n    if (!storedData) {\r\n      console.warn('[MOCK] Donn\u00E9es manquantes apr\u00E8s v\u00E9rification, cr\u00E9ation d\\'un tableau vide');\r\n      global._globalFormulasStore.set(fieldId, []);\r\n      return [];\r\n    }\r\n    \r\n    console.log('[MOCK] R\u00E9cup\u00E9ration de ' + storedData.length + ' formules pour le champ ' + fieldId);\r\n    \r\n    if (storedData.length > 0) {\r\n      console.log('[MOCK] Exemple de donn\u00E9es:', JSON.stringify(storedData[0]));\r\n    }\r\n    \r\n    logOperation('getFormulasForField', fieldId, null, 'success', { count: storedData.length });\r\n    \r\n    // Effectuer une copie profonde pour \u00E9viter toute modification accidentelle\r\n    return JSON.parse(JSON.stringify(storedData));\r\n  } catch (error: any) {\r\n    console.error('[MOCK] Erreur lors de la r\u00E9cup\u00E9ration des formules pour le champ ' + fieldId + ':', error);\r\n    logOperation('getFormulasForField', fieldId, null, 'error', error.message || String(error));\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Met \u00E0 jour une formule ou la cr\u00E9e si elle n'existe pas\r\n */\r\nexport const updateFormula = (fieldId: string, formulaId: string, data: any): any => {\r\n  try {\r\n    if (!fieldId || !formulaId) {\r\n      console.error('[MOCK] Erreur: fieldId ou formulaId manquant');\r\n      logOperation('updateFormula', fieldId || 'unknown', formulaId || null, 'error', 'Param\u00E8tres manquants');\r\n      return null;\r\n    }\r\n    \r\n    console.log('[MOCK] Mise \u00E0 jour formule ' + formulaId + ' pour champ ' + fieldId, data);\r\n    \r\n    // R\u00E9cup\u00E9rer les formules actuelles (avec une copie pour \u00E9viter les r\u00E9f\u00E9rences)\r\n    const formulas = JSON.parse(JSON.stringify(getFormulasForField(fieldId)));\r\n    \r\n    // Trouver l'index de la formule \u00E0 mettre \u00E0 jour\r\n    const index = formulas.findIndex((f: any) => f.id === formulaId);\r\n    \r\n    // Cr\u00E9er un objet formule avec les donn\u00E9es\r\n    const formula = {\r\n      id: formulaId,\r\n      fieldId,\r\n      name: data.name || 'Formule sans nom',\r\n      sequence: data.sequence || [],\r\n      order: typeof data.order === 'number' ? data.order : 0,\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n    \r\n    // Mettre \u00E0 jour ou ajouter la formule\r\n    if (index >= 0) {\r\n      formulas[index] = { ...formulas[index], ...formula };\r\n      console.log('[MOCK] Formule ' + formulaId + ' mise \u00E0 jour');\r\n      logOperation('updateFormula', fieldId, formulaId, 'success', { type: 'update' });\r\n    } else {\r\n      formulas.push(formula);\r\n      console.log('[MOCK] Formule ' + formulaId + ' ajout\u00E9e au stockage');\r\n      logOperation('updateFormula', fieldId, formulaId, 'success', { type: 'create' });\r\n    }\r\n    \r\n    // Mettre \u00E0 jour le stockage avec une nouvelle r\u00E9f\u00E9rence\r\n    const formulasCopy = JSON.parse(JSON.stringify(formulas));\r\n    \r\n    // Tri des formules par ordre pour garantir la coh\u00E9rence\r\n    const sortedFormulas = formulasCopy.sort((a: any, b: any) => a.order - b.order);\r\n    \r\n    // CORRECTIF MAJEUR : Double sauvegarde dans deux stores s\u00E9par\u00E9s pour redondance\r\n    // Sauvegarde dans le store principal\r\n    global._globalFormulasStore.set(fieldId, sortedFormulas);\r\n    \r\n    // Sauvegarde de secours\r\n    try {\r\n      // Cr\u00E9er une copie fra\u00EEche pour le stockage de secours\r\n      const backupCopy = JSON.parse(JSON.stringify(sortedFormulas));\r\n      global._backupFormulasStore.set(fieldId, backupCopy);\r\n      console.log('[MOCK] \u2705 Double sauvegarde r\u00E9ussie pour le champ ' + fieldId);\r\n    } catch (backupError) {\r\n      console.error('[MOCK] \u274C \u00C9chec de la sauvegarde de secours:', backupError);\r\n    }\r\n    \r\n    console.log('[MOCK] \uD83D\uDD04 Stockage mis \u00E0 jour pour le champ ' + fieldId + ', maintenant ' + formulas.length + ' formules');\r\n    console.log('[MOCK] \u2713 V\u00E9rification apr\u00E8s mise \u00E0 jour: ' + (global._globalFormulasStore.get(fieldId)?.length || 0) + ' formules dans le store principal');\r\n    console.log('[MOCK] \u2713 V\u00E9rification du store de secours: ' + (global._backupFormulasStore.get(fieldId)?.length || 0) + ' formules');\r\n    \r\n    // V\u00E9rification d\u00E9taill\u00E9e des donn\u00E9es\r\n    const storedFormulas = global._globalFormulasStore.get(fieldId);\r\n    if (storedFormulas && storedFormulas.length > 0) {\r\n      console.log('[MOCK] \uD83D\uDCC4 V\u00E9rification principale - premier \u00E9l\u00E9ment:', JSON.stringify(storedFormulas[0]));\r\n      \r\n      // V\u00E9rifier la structure compl\u00E8te pour d\u00E9tecter les anomalies\r\n      storedFormulas.forEach((f: any, idx: number) => {\r\n        if (!f.id || !f.sequence) {\r\n          console.warn(`[MOCK] \u26A0\uFE0F Formule #${idx} potentiellement corrompue:`, \r\n            JSON.stringify({id: f.id, hasSequence: !!f.sequence, sequenceType: typeof f.sequence}));\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Renvoyer la formule mise \u00E0 jour\r\n    return formula;\r\n  } catch (error: any) {\r\n    console.error('[MOCK] Erreur lors de la mise \u00E0 jour de la formule ' + formulaId + ':', error);\r\n    logOperation('updateFormula', fieldId, formulaId, 'error', error.message || String(error));\r\n    return null;\r\n  }\r\n};\r\n\r\n/**\r\n * Supprime une formule\r\n */\r\nexport const deleteFormula = (fieldId: string, formulaId: string): boolean => {\r\n  try {\r\n    if (!fieldId || !formulaId) {\r\n      console.error('[MOCK] Erreur: fieldId ou formulaId manquant pour la suppression');\r\n      logOperation('deleteFormula', fieldId || 'unknown', formulaId || null, 'error', 'Param\u00E8tres manquants');\r\n      return false;\r\n    }\r\n    \r\n    const formulas = getFormulasForField(fieldId);\r\n    const index = formulas.findIndex(f => f.id === formulaId);\r\n    \r\n    if (index >= 0) {\r\n      formulas.splice(index, 1);\r\n      global._globalFormulasStore.set(fieldId, JSON.parse(JSON.stringify(formulas)));\r\n      console.log('[MOCK] Formule ' + formulaId + ' supprim\u00E9e');\r\n      logOperation('deleteFormula', fieldId, formulaId, 'success');\r\n      return true;\r\n    }\r\n    \r\n    console.log('[MOCK] Formule ' + formulaId + ' non trouv\u00E9e pour suppression');\r\n    logOperation('deleteFormula', fieldId, formulaId, 'warning', 'Formule non trouv\u00E9e');\r\n    return false;\r\n  } catch (error: any) {\r\n    console.error('[MOCK] Erreur lors de la suppression de la formule ' + formulaId + ':', error);\r\n    logOperation('deleteFormula', fieldId, formulaId, 'error', error.message || String(error));\r\n    return false;\r\n  }\r\n};\r\n\r\n// Exporter l'\u00E9tat du stockage pour le debug\r\nexport const getStoreState = () => {\r\n  return {\r\n    fieldsCount: global._globalFormulasStore.size,\r\n    fields: Array.from(global._globalFormulasStore.keys()),\r\n    totalFormulas: Array.from(global._globalFormulasStore.values()).reduce((acc, arr) => acc + arr.length, 0),\r\n    lastOperations: global._formulasOperationLog.slice(-10)\r\n  };\r\n};\r\n\r\n// Fonction d'assistance pour voir les derni\u00E8res op\u00E9rations\r\nexport const getLastOperations = (count: number = 10) => {\r\n  return global._formulasOperationLog.slice(-count);\r\n};\r\n\r\n// Fonction pour vider le stockage (utile pour les tests)\r\nexport const clearStorage = (fieldId?: string) => {\r\n  if (fieldId) {\r\n    global._globalFormulasStore.delete(fieldId);\r\n    logOperation('clearStorage', fieldId);\r\n    return true;\r\n  } else {\r\n    global._globalFormulasStore.clear();\r\n    logOperation('clearAllStorage', 'all');\r\n    return true;\r\n  }\r\n};\r\n\r\n// Fonction pour forcer le rechargement du store avec syst\u00E8me de secours (utile pour d\u00E9boguer)\r\nexport const forceRefreshStore = (fieldId: string): any[] => {\r\n  if (!fieldId) {\r\n    console.error('[MOCK] \u274C forceRefreshStore - ERREUR: fieldId est vide ou null');\r\n    return [];\r\n  }\r\n  \r\n  console.log('[MOCK] \uD83D\uDD04 For\u00E7age du rechargement du store pour le champ ' + fieldId);\r\n  console.log('[MOCK] \uD83D\uDCCA \u00C9tat actuel du store principal: ' + global._globalFormulasStore.size + ' champs');\r\n  console.log('[MOCK] \uD83D\uDCCA \u00C9tat actuel du store de secours: ' + global._backupFormulasStore.size + ' champs');\r\n  console.log('[MOCK] \uD83D\uDD11 Cl\u00E9s dans le store principal: ' + Array.from(global._globalFormulasStore.keys()).join(', '));\r\n  console.log('[MOCK] \uD83D\uDD11 Cl\u00E9s dans le store de secours: ' + Array.from(global._backupFormulasStore.keys()).join(', '));\r\n  \r\n  let formulas: any[] = [];\r\n  let source = 'aucune';\r\n  \r\n  // Tentative 1: R\u00E9cup\u00E9rer depuis le store principal\r\n  if (global._globalFormulasStore.has(fieldId)) {\r\n    try {\r\n      const primaryData = global._globalFormulasStore.get(fieldId);\r\n      if (primaryData && Array.isArray(primaryData) && primaryData.length > 0) {\r\n        formulas = JSON.parse(JSON.stringify(primaryData));\r\n        source = 'principale';\r\n        console.log(`[MOCK] \u2705 Donn\u00E9es r\u00E9cup\u00E9r\u00E9es depuis la source principale: ${formulas.length} formules`);\r\n      } else {\r\n        console.warn(`[MOCK] \u26A0\uFE0F La source principale existe mais ne contient pas de donn\u00E9es valides`);\r\n      }\r\n    } catch (primaryError) {\r\n      console.error(`[MOCK] \u274C Erreur lors de l'acc\u00E8s \u00E0 la source principale:`, primaryError);\r\n    }\r\n  } else {\r\n    console.warn(`[MOCK] \u26A0\uFE0F Le champ ${fieldId} n'existe pas dans la source principale`);\r\n  }\r\n  \r\n  // Tentative 2: Si la source principale a \u00E9chou\u00E9, essayer la source de secours\r\n  if (formulas.length === 0 && global._backupFormulasStore.has(fieldId)) {\r\n    try {\r\n      const backupData = global._backupFormulasStore.get(fieldId);\r\n      if (backupData && Array.isArray(backupData) && backupData.length > 0) {\r\n        formulas = JSON.parse(JSON.stringify(backupData));\r\n        source = 'secours';\r\n        console.log(`[MOCK] \u2705 Donn\u00E9es r\u00E9cup\u00E9r\u00E9es depuis la source de secours: ${formulas.length} formules`);\r\n        \r\n        // Restaurer les donn\u00E9es dans le store principal\r\n        global._globalFormulasStore.set(fieldId, JSON.parse(JSON.stringify(formulas)));\r\n        console.log(`[MOCK] \uD83D\uDD04 Store principal restaur\u00E9 \u00E0 partir du store de secours`);\r\n      } else {\r\n        console.warn(`[MOCK] \u26A0\uFE0F La source de secours existe mais ne contient pas de donn\u00E9es valides`);\r\n      }\r\n    } catch (backupError) {\r\n      console.error(`[MOCK] \u274C Erreur lors de l'acc\u00E8s \u00E0 la source de secours:`, backupError);\r\n    }\r\n  }\r\n  \r\n  // Si aucune donn\u00E9e n'a \u00E9t\u00E9 r\u00E9cup\u00E9r\u00E9e, initialiser un tableau vide\r\n  if (formulas.length === 0) {\r\n    console.log(`[MOCK] \u26A0\uFE0F Aucune donn\u00E9e trouv\u00E9e pour le champ ${fieldId}, initialisation d'un tableau vide`);\r\n    global._globalFormulasStore.set(fieldId, []);\r\n    global._backupFormulasStore.set(fieldId, []);\r\n    logOperation('forceRefreshStore_init', fieldId);\r\n    return [];\r\n  }\r\n  \r\n  // Log d\u00E9taill\u00E9 des donn\u00E9es r\u00E9cup\u00E9r\u00E9es\r\n  console.log(`[MOCK] \u2713 Store forc\u00E9 (source: ${source}) - ${formulas.length} formules r\u00E9cup\u00E9r\u00E9es pour ${fieldId}`);\r\n  \r\n  if (formulas.length > 0) {\r\n    console.log('[MOCK] \uD83D\uDCC4 Premier \u00E9l\u00E9ment du store:', JSON.stringify(formulas[0]));\r\n  } else {\r\n    console.log('[MOCK] \uD83D\uDCC4 Store vide pour le champ ' + fieldId);\r\n  }\r\n  \r\n  logOperation('forceRefreshStore', fieldId, null, 'success', { count: formulas.length, source });\r\n  return formulas;\r\n};\r\n", "import { Formula, SimpleCondition } from '../types/formula';\r\n\r\n/**\r\n * \u00C9value une formule avec des valeurs de test\r\n * \r\n * @param formula La formule \u00E0 tester\r\n * @param fieldValues Les valeurs de test pour chaque champ (cl\u00E9 = ID du champ, valeur = valeur de test)\r\n * @returns Le r\u00E9sultat de l'\u00E9valuation de la formule\r\n */\r\nexport const evaluateFormula = (formula: Formula, fieldValues: Record<string, number>, context?: {\r\n  // R\u00E9sultats d\u00E9j\u00E0 calcul\u00E9s de formules pour \u00E9viter la r\u00E9cursion infinie\r\n  formulaResults?: Record<string, number | boolean | null>;\r\n  // Acc\u00E8s brut aux valeurs non num\u00E9riques (ex: advanced_select objets)\r\n  rawValues?: Record<string, unknown>;\r\n  // R\u00E9solveur de formule imbriqu\u00E9e si absent du cache\r\n  resolveFormulaById?: (id: string) => Formula | undefined;\r\n  // Limiter profondeur pour pr\u00E9venir cycles complexes\r\n  depth?: number;\r\n  // Ensemble des formules visit\u00E9es pour d\u00E9tection cycle\r\n  visited?: Set<string>;\r\n}): {\r\n  result: number | boolean | string | null;\r\n  success: boolean;\r\n  error?: string;\r\n  debug: { step: number; operation: string; value: number | boolean | string | null }[];\r\n} => {\r\n  if (!formula || !formula.sequence || !Array.isArray(formula.sequence) || formula.sequence.length === 0) {\r\n    return {\r\n      result: null,\r\n      success: false,\r\n      error: 'Formule vide ou invalide',\r\n      debug: []\r\n    };\r\n  }\r\n\r\n  // Tableau pour suivre chaque \u00E9tape du calcul (pour le d\u00E9bogage)\r\n  const debugSteps: { step: number; operation: string; value: number | boolean | string | null }[] = [];\r\n\r\n  try {\r\n    // Traiter chaque \u00E9l\u00E9ment de la s\u00E9quence\r\n  let result: number | boolean | string | null = null;\r\n    // Valeur brute (non convertie) du r\u00E9sultat courant (pour comparaisons string)\r\n    let resultRaw: unknown = null;\r\n    let currentOperator: string | null = null;\r\n    let isFirstValue = true;\r\n\r\n  formula.sequence.forEach((item, index) => {\r\n      if (!item || !item.type) {\r\n        throw new Error(`\u00C9l\u00E9ment de formule invalide \u00E0 l'\u00E9tape ${index + 1}`);\r\n      }\r\n\r\n      // R\u00E9cup\u00E9rer la valeur selon le type d'\u00E9l\u00E9ment\r\n  let itemValue: number | boolean; // valeur num\u00E9rique logique utilis\u00E9e pour op\u00E9rations arithm\u00E9tiques / bool\r\n  let itemRaw: unknown = undefined; // valeur brute potentiellement string pour comparaisons '=' / '!='\r\n      \r\n      switch (item.type) {\r\n        case 'value': {\r\n          // Support \"10%\" => 0.10 si param utilisateur A\r\n          if (typeof item.value === 'string') {\r\n            const raw = item.value.trim();\r\n            itemRaw = raw; // conserver brut\r\n            // Si flag valueType=string => ne pas convertir sauf pour pourcentage explicite\r\n            if (item.valueType === 'string' && !/^-?\\d+(\\.\\d+)?%$/.test(raw.replace(/\\s+/g,''))) {\r\n              itemValue = 0; // neutre pour op\u00E9rations arithm\u00E9tiques\r\n              break;\r\n            }\r\n            if (/^-?\\d+(\\.\\d+)?%$/.test(raw)) {\r\n              const base = parseFloat(raw.replace('%', ''));\r\n              itemValue = isNaN(base) ? 0 : base / 100;\r\n            } else {\r\n              const num = parseFloat(raw);\r\n              if (isNaN(num)) {\r\n                // Constante non num\u00E9rique => garder 0 comme valeur num\u00E9rique mais raw servira pour '=' / '!='\r\n                itemValue = 0;\r\n              } else {\r\n                itemValue = num;\r\n              }\r\n            }\r\n          } else if (typeof item.value === 'number') {\r\n            itemRaw = item.value;\r\n            itemValue = item.value;\r\n          } else {\r\n            itemValue = 0;\r\n          }\r\n          break; }\r\n        case 'field': {\r\n          // R\u00E9cup\u00E8re la valeur d'un champ simple (number / text convertible) depuis fieldValues ou rawValues\r\n          const fid = String(item.fieldId || item.value || '');\r\n          let rawVal: unknown = undefined;\r\n          if (fid) {\r\n            if (typeof fieldValues[fid] !== 'undefined') rawVal = fieldValues[fid];\r\n            else if (context?.rawValues && Object.prototype.hasOwnProperty.call(context.rawValues, fid)) rawVal = context.rawValues[fid];\r\n          }\r\n          console.log(`[FormulaEvaluator] \uD83C\uDFF7\uFE0F Champ \"${fid}\": rawVal=${rawVal}, typeof=${typeof rawVal}`);\r\n          \r\n          // Si advanced_select stock\u00E9 comme objet { selection, extra, nodeId }\r\n          if (rawVal && typeof rawVal === 'object') {\r\n            const sel = (rawVal as Record<string, unknown>).selection;\r\n            console.log(`[FormulaEvaluator] \uD83D\uDD0D Advanced select - selection:${sel}, objet:`, rawVal);\r\n            rawVal = typeof sel !== 'undefined' ? sel : rawVal;\r\n          }\r\n          itemRaw = rawVal;\r\n          if (typeof rawVal === 'number') itemValue = rawVal;\r\n          else if (typeof rawVal === 'string') {\r\n            const trimmed = rawVal.trim();\r\n            if (/^-?\\d+(\\.\\d+)?%$/.test(trimmed)) {\r\n              const base = parseFloat(trimmed.replace('%','')); itemValue = isNaN(base)?0: base/100;\r\n            } else {\r\n              const num = parseFloat(trimmed); itemValue = isNaN(num)?0:num;\r\n            }\r\n          } else {\r\n            itemValue = 0;\r\n          }\r\n          console.log(`[FormulaEvaluator] \uD83D\uDCCA Champ \"${fid}\" \u00E9valu\u00E9: ${itemValue} (raw: ${rawVal})`);\r\n          debugSteps.push({ step: index + 1, operation: `Champ ${fid}`, value: itemValue });\r\n          break; }\r\n        case 'formula_ref': {\r\n          const refId = item.refFormulaId || String(item.value);\r\n            if (!refId) throw new Error('formula_ref sans refFormulaId');\r\n            const cache = context?.formulaResults || {};\r\n            let refResult = cache[refId];\r\n            if (typeof refResult === 'undefined') {\r\n              // D\u00E9tection cycle\r\n              const visited = context?.visited || new Set<string>();\r\n              if (visited.has(refId)) throw new Error(`Cycle d\u00E9tect\u00E9 sur la formule ${refId}`);\r\n              visited.add(refId);\r\n              if (context?.depth && context.depth > 20) throw new Error('Profondeur formule imbriqu\u00E9e trop grande');\r\n              const refFormula = context?.resolveFormulaById ? context.resolveFormulaById(refId) : undefined;\r\n              if (!refFormula) throw new Error(`Formule r\u00E9f\u00E9renc\u00E9e introuvable: ${refId}`);\r\n              const nested = evaluateFormula(refFormula, fieldValues, {\r\n                ...context,\r\n                depth: (context?.depth || 0) + 1,\r\n                visited,\r\n                formulaResults: { ...(context?.formulaResults || {}) }\r\n              });\r\n              if (!nested.success) throw new Error(`Erreur formule imbriqu\u00E9e ${refId}: ${nested.error}`);\r\n              refResult = nested.result as number | boolean | null;\r\n              if (context?.formulaResults) context.formulaResults[refId] = refResult;\r\n              visited.delete(refId);\r\n            }\r\n            if (typeof refResult === 'boolean') itemValue = refResult ? 1 : 0; else itemValue = Number(refResult ?? 0);\r\n          break; }\r\n        case 'adv_part': {\r\n          const fid = item.fieldId || item.value as string;\r\n          const part = item.part || 'selection';\r\n          const raw = context?.rawValues?.[fid];\r\n          let extracted: unknown = undefined;\r\n          if (raw && typeof raw === 'object') {\r\n            const obj = raw as Record<string, unknown>;\r\n            if (part === 'selection') extracted = obj['selection'];\r\n            else if (part === 'extra') extracted = obj['extra'];\r\n            else if (part === 'nodeId') extracted = obj['nodeId'];\r\n          } else if (part === 'selection') {\r\n            extracted = raw; // fallback si simple valeur\r\n          }\r\n          itemRaw = extracted;\r\n          // Conversion number\r\n          if (typeof extracted === 'number') itemValue = extracted;\r\n          else if (typeof extracted === 'string') {\r\n            const s = extracted.trim();\r\n            if (/^-?\\d+(\\.\\d+)?%$/.test(s)) {\r\n              const base = parseFloat(s.replace('%',''));\r\n              itemValue = isNaN(base) ? 0 : base / 100;\r\n            } else {\r\n              const n = parseFloat(s);\r\n              itemValue = isNaN(n) ? 0 : n;\r\n            }\r\n          } else {\r\n            itemValue = 0; // Non num\u00E9rique => 0\r\n          }\r\n          break; }\r\n        case 'cond': {\r\n          // Nouvelle logique: si condExpr existe on l'\u00E9value comme une sous-formule bool\u00E9enne\r\n          let pass = false;\r\n          let condDebugValue: number | boolean | string | null = null;\r\n          if (item.condExpr && item.condExpr.length > 0) {\r\n            // V\u00E9rifier si l'expression commence par une fonction IF\r\n            const firstToken = item.condExpr[0];\r\n            if (firstToken?.type === 'function' && String(firstToken.value).startsWith('IF(')) {\r\n              // Traiter comme une fonction IF : \u00E9valuer les arguments suivants comme condition\r\n              // Extraire la condition des tokens suivants (ignorer le IF)\r\n              const conditionTokens = item.condExpr.slice(1); // Ignorer le token IF\r\n              if (conditionTokens.length >= 3) {\r\n                // \u00C9valuer la condition (ex: Prix Kw/h > Prix Kw/h)\r\n                const tempBool: Formula = { id: `${formula.id}__if_cond_${index}`, name: 'if-condition', sequence: conditionTokens, targetProperty: '' };\r\n                const nestedBool = evaluateFormula(tempBool, fieldValues, { ...context, depth: (context?.depth || 0) + 1 });\r\n                if (nestedBool.success) {\r\n                  pass = Boolean(nestedBool.result);\r\n                  condDebugValue = nestedBool.result as number | boolean | string | null;\r\n                } else {\r\n                  console.warn(`[FormulaEvaluator] Erreur \u00E9valuation condition IF: ${nestedBool.error}`);\r\n                  pass = false;\r\n                  condDebugValue = false;\r\n                }\r\n              } else {\r\n                console.warn('[FormulaEvaluator] Fonction IF sans condition suffisante');\r\n                pass = false;\r\n                condDebugValue = false;\r\n              }\r\n            } else {\r\n              // Traitement normal d'une expression bool\u00E9enne\r\n              const tempBool: Formula = { id: `${formula.id}__cond_expr_${index}`, name: 'cond-expr', sequence: item.condExpr, targetProperty: '' };\r\n              const nestedBool = evaluateFormula(tempBool, fieldValues, { ...context, depth: (context?.depth || 0) + 1 });\r\n              if (!nestedBool.success) throw new Error(`Erreur expression condition: ${nestedBool.error}`);\r\n              pass = Boolean(nestedBool.result);\r\n              condDebugValue = nestedBool.result as number | boolean | string | null;\r\n            }\r\n          } else {\r\n            const cond = item.condition as SimpleCondition | undefined;\r\n            const evalCondition = () => {\r\n              if (!cond) return false;\r\n              const raw = context?.rawValues?.[cond.fieldId] ?? context?.rawValues?.[cond.fieldId];\r\n              const part = cond.part || 'selection';\r\n              let base: unknown = raw;\r\n              if (raw && typeof raw === 'object') {\r\n                const obj = raw as Record<string, unknown>;\r\n                if (part === 'selection') base = obj['selection'];\r\n                else if (part === 'extra') base = obj['extra'];\r\n                else if (part === 'nodeId') base = obj['nodeId'];\r\n              }\r\n              const op = cond.operator || '=';\r\n              const val = cond.value;\r\n              const cmp = (a: unknown, b: unknown, op: string): boolean => {\r\n                if (op === 'in') {\r\n                  if (!Array.isArray(b)) return false;\r\n                  return b.some(x => String(x) === String(a));\r\n                }\r\n                // Comparaisons string pures si l'un n'est pas num\u00E9rique\r\n                const aNum = parseFloat(String(a));\r\n                const bNum = parseFloat(String(b as unknown));\r\n                const aIsNum = !isNaN(aNum) && String(a).trim() !== '' && /^-?\\d+(\\.\\d+)?$/.test(String(a).trim());\r\n                const bIsNum = !isNaN(bNum) && String(b).trim() !== '' && /^-?\\d+(\\.\\d+)?$/.test(String(b as string).trim());\r\n                const an = typeof a === 'number' ? a : parseFloat(String(a));\r\n                const bn = typeof b === 'number' ? b : parseFloat(String(b as unknown));\r\n                switch (op) {\r\n                  case '=': return String(a) === String(b);\r\n                  case '!=': return String(a) !== String(b);\r\n                  case '>': return aIsNum && bIsNum ? an > bn : String(a) > String(b);\r\n                  case '>=': return aIsNum && bIsNum ? an >= bn : String(a) >= String(b);\r\n                  case '<': return aIsNum && bIsNum ? an < bn : String(a) < String(b);\r\n                  case '<=': return aIsNum && bIsNum ? an <= bn : String(a) <= String(b);\r\n                  default: return false;\r\n                }\r\n              };\r\n              return cmp(base, val, op);\r\n            };\r\n            pass = evalCondition();\r\n            condDebugValue = pass;\r\n          }\r\n          // \u00C9tape 1: \u00E9valuation de la condition\r\n          debugSteps.push({ step: index + 1, operation: `Condition TEST`, value: condDebugValue });\r\n          console.log(`[FormulaEvaluator] \uD83D\uDD0D Condition IF \u00E9valu\u00E9e: ${pass} (${condDebugValue})`);\r\n          \r\n          // \u00C9valuer sous-s\u00E9quence THEN ou ELSE\r\n          const seqToEval = pass ? (item.then || []) : (item.else || []);\r\n          console.log(`[FormulaEvaluator] \uD83D\uDCDD Branche s\u00E9lectionn\u00E9e: ${pass ? 'THEN' : 'ELSE'} (${seqToEval.length} \u00E9l\u00E9ments)`);\r\n          if (seqToEval.length > 0) {\r\n            console.log(`[FormulaEvaluator] \uD83D\uDD22 S\u00E9quence \u00E0 \u00E9valuer:`, seqToEval.map(s => `${s.type}:${s.label || s.value}`));\r\n          }\r\n          if (seqToEval.length === 0) {\r\n            // Comportement selon elseBehavior\r\n            if (!pass && item.elseBehavior === 'ignore') {\r\n              itemValue = 0; // Pour la s\u00E9quence principale on retourne 0 (ou on pourrait skip). Simplicit\u00E9: 0.\r\n            } else {\r\n              itemValue = 0; // THEN vide => 0\r\n            }\r\n            debugSteps.push({ step: index + 1, operation: `Condition ${pass ? 'THEN (vide)' : 'ELSE (vide)'}`, value: 0 });\r\n          } else {\r\n            // Construire une formule temporaire locale\r\n            const temp: Formula = { id: `${formula.id}__cond_${index}`, name: 'cond', sequence: seqToEval, targetProperty: '' };\r\n            console.log(`[FormulaEvaluator] \u2699\uFE0F \u00C9valuation de la branche ${pass ? 'THEN' : 'ELSE'} avec fieldValues:`, Object.keys(fieldValues));\r\n            const nested = evaluateFormula(temp, fieldValues, { ...context, depth: (context?.depth || 0) + 1 });\r\n            console.log(`[FormulaEvaluator] \uD83D\uDCCA R\u00E9sultat branche ${pass ? 'THEN' : 'ELSE'}:`, nested);\r\n            if (!nested.success) throw new Error(`Erreur sous-s\u00E9quence condition: ${nested.error}`);\r\n            const valNum = typeof nested.result === 'number' ? nested.result : (typeof nested.result === 'boolean' ? (nested.result ? 1 : 0) : 0);\r\n            itemValue = valNum;\r\n            console.log(`[FormulaEvaluator] \u2705 Valeur finale de la condition: ${itemValue}`);\r\n            debugSteps.push({ step: index + 1, operation: `Condition ${pass ? 'THEN' : 'ELSE'} (r\u00E9sultat branche)`, value: valNum });\r\n          }\r\n          itemRaw = itemValue;\r\n          break; }\r\n  case 'switch': {\r\n          // R\u00E9cup\u00E9rer la valeur de base (advanced_select part ou raw)\r\n          const fieldId = item.switchFieldId || item.fieldId;\r\n          const part = item.switchPart || 'selection';\r\n          const raw = context?.rawValues?.[fieldId||''];\r\n          let key: unknown = raw;\r\n          if (raw && typeof raw === 'object') {\r\n            const obj = raw as Record<string, unknown>;\r\n            if (part === 'selection') key = obj['selection'];\r\n            else if (part === 'extra') key = obj['extra'];\r\n            else if (part === 'nodeId') key = obj['nodeId'];\r\n          }\r\n          const cases = item.cases || [];\r\n            const match = cases.find(c => String(c.value) === String(key));\r\n            const seqToEval = match ? cDeep(match.seq) : (item.defaultSeq || []);\r\n            if (seqToEval.length === 0) { itemValue = 0; break; }\r\n            const temp: Formula = { id: `${formula.id}__switch_${index}`, name: 'switch', sequence: seqToEval, targetProperty: '' };\r\n            const nested = evaluateFormula(temp, fieldValues, { ...context, depth: (context?.depth || 0) + 1 });\r\n            if (!nested.success) throw new Error(`Erreur switch: ${nested.error}`);\r\n            const valNum = typeof nested.result === 'number' ? nested.result : (typeof nested.result === 'boolean' ? (nested.result ? 1 : 0) : 0);\r\n            itemValue = valNum;\r\n            debugSteps.push({ step: index + 1, operation: `Switch valeur=${String(key)}`, value: valNum });\r\n            itemRaw = itemValue;\r\n          break; }\r\n          \r\n        case 'operator':\r\n          currentOperator = String(item.value);\r\n          // Ne pas traiter l'op\u00E9rateur imm\u00E9diatement\r\n          debugSteps.push({ step: index + 1, operation: `Op\u00E9rateur: ${currentOperator}`, value: null });\r\n          return;\r\n          \r\n        case 'function': {\r\n          // Support des fonctions de base\r\n          const functionValue = String(item.value || '').trim();\r\n          \r\n          if (functionValue.startsWith('IF(')) {\r\n            // Parser basique pour IF(condition, alors, sinon)\r\n            // Pour l'instant, on supporte IF suivi d'autres \u00E9l\u00E9ments dans la s\u00E9quence\r\n            // Cette approche simple traite IF comme un pr\u00E9fixe qui influence l'interpr\u00E9tation\r\n            \r\n            // Dans le contexte de votre usage, IF semble \u00EAtre suivi des arguments dans la s\u00E9quence\r\n            // On va traiter cela comme un marqueur conditionnel\r\n            itemValue = 1; // IF valid\u00E9, continuer l'\u00E9valuation\r\n            debugSteps.push({ step: index + 1, operation: `Function IF d\u00E9tect\u00E9e`, value: itemValue });\r\n          } else if (functionValue.startsWith('ROUND(')) {\r\n            // Pour ROUND et autres fonctions math\u00E9matiques, on peut les ignorer pour l'instant\r\n            itemValue = 0; // Neutre\r\n            debugSteps.push({ step: index + 1, operation: `Function ${functionValue} (non impl\u00E9ment\u00E9e)`, value: itemValue });\r\n          } else {\r\n            // Autres fonctions : les traiter comme des valeurs neutres pour ne pas casser l'\u00E9valuation\r\n            itemValue = 0;\r\n            debugSteps.push({ step: index + 1, operation: `Function ${functionValue} (ignor\u00E9e)`, value: itemValue });\r\n          }\r\n          break;\r\n        }\r\n          \r\n        default:\r\n          throw new Error(`Type d'\u00E9l\u00E9ment non support\u00E9: ${item.type}`);\r\n      }\r\n\r\n      // Si c'est le premier \u00E9l\u00E9ment ou apr\u00E8s un op\u00E9rateur\r\n      if (isFirstValue) {\r\n        result = (itemRaw !== undefined ? (itemRaw as (number|string|boolean|null)) : itemValue);\r\n        resultRaw = itemRaw;\r\n        isFirstValue = false;\r\n        debugSteps.push({ step: index + 1, operation: 'Valeur initiale', value: result });\r\n        return;\r\n      }\r\n\r\n      // Appliquer l'op\u00E9rateur avec la valeur actuelle\r\n      if (currentOperator === null) {\r\n        throw new Error(`Op\u00E9rateur manquant avant la valeur \u00E0 l'\u00E9tape ${index + 1}`);\r\n      }\r\n\r\n      // Effectuer l'op\u00E9ration\r\n      console.log(`[FormulaEvaluator] \uD83D\uDD22 Op\u00E9ration: ${result} ${currentOperator} ${itemValue}`);\r\n    switch (currentOperator) {\r\n        case '+':\r\n      result = (Number(result) || 0) + Number(itemValue);\r\n          break;\r\n        case '-':\r\n      result = (Number(result) || 0) - Number(itemValue);\r\n          break;\r\n        case '*':\r\n      result = (Number(result) || 0) * Number(itemValue);\r\n          break;\r\n        case '/':\r\n          if (itemValue === 0) {\r\n            // Enregistrer l'\u00E9tape avant de lever l'erreur pour diagnostic UI\r\n            debugSteps.push({ step: index + 1, operation: 'Division par 0 (arr\u00EAt)', value: null });\r\n            console.log(`[FormulaEvaluator] \u274C Division par z\u00E9ro d\u00E9tect\u00E9e !`);\r\n            throw new Error('Division par z\u00E9ro');\r\n          }\r\n      result = (Number(result) || 0) / Number(itemValue);\r\n          break;\r\n        case '=':\r\n      result = String(resultRaw ?? result) === String(itemRaw ?? itemValue);\r\n          break;\r\n        case '!=':\r\n      result = String(resultRaw ?? result) !== String(itemRaw ?? itemValue);\r\n          break;\r\n        case '>':\r\n      result = Number(result) > Number(itemValue);\r\n          break;\r\n        case '<':\r\n      result = Number(result) < Number(itemValue);\r\n          break;\r\n        case '>=':\r\n      result = Number(result) >= Number(itemValue);\r\n          break;\r\n        case '<=':\r\n      result = Number(result) <= Number(itemValue);\r\n          break;\r\n        case '&&':\r\n          result = Boolean(result) && Boolean(itemValue);\r\n          break;\r\n        case '||':\r\n          result = Boolean(result) || Boolean(itemValue);\r\n          break;\r\n        default:\r\n          throw new Error(`Op\u00E9rateur non support\u00E9: ${currentOperator}`);\r\n      }\r\n\r\n      console.log(`[FormulaEvaluator] \u27A1\uFE0F R\u00E9sultat apr\u00E8s op\u00E9ration: ${result}`);\r\n      debugSteps.push({ \r\n        step: index + 1, \r\n        operation: `${currentOperator} ${itemValue}`, \r\n        value: result \r\n      });\r\n\r\n  // Mettre \u00E0 jour la valeur brute AVANT de r\u00E9initialiser (sinon on perd l'info)\r\n  if (['+','-','*','/'].includes(currentOperator || '')) resultRaw = result;\r\n  if (['=','!='].includes(currentOperator || '')) resultRaw = result; // bool\r\n  // R\u00E9initialiser l'op\u00E9rateur apr\u00E8s application\r\n  currentOperator = null;\r\n    });\r\n\r\n    return {\r\n      result,\r\n      success: true,\r\n      debug: debugSteps\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      result: null,\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Erreur inconnue',\r\n      debug: debugSteps\r\n    };\r\n  }\r\n};\r\n\r\n/**\r\n * Cr\u00E9e un jeu de tests pour v\u00E9rifier qu'une formule fonctionne comme pr\u00E9vu\r\n */\r\nexport const testFormula = (\r\n  formula: Formula, \r\n  testCases: Array<{\r\n    values: Record<string, number>;\r\n    expectedResult: number | boolean;\r\n    name?: string;\r\n  }>\r\n) => {\r\n  console.log(`\uD83E\uDDEA Test de la formule: ${formula.name || formula.id}`);\r\n  \r\n  const results = testCases.map((testCase, index) => {\r\n    const { values, expectedResult, name } = testCase;\r\n    const evaluation = evaluateFormula(formula, values);\r\n    \r\n    const testName = name || `Test #${index + 1}`;\r\n    const success = evaluation.success && evaluation.result === expectedResult;\r\n    \r\n    console.log(`${success ? '\u2705' : '\u274C'} ${testName}`);\r\n    \r\n    if (!success) {\r\n      console.log(`   Valeurs: ${JSON.stringify(values)}`);\r\n      console.log(`   R\u00E9sultat attendu: ${expectedResult}`);\r\n      console.log(`   R\u00E9sultat obtenu: ${evaluation.result}`);\r\n      if (evaluation.error) {\r\n        console.log(`   Erreur: ${evaluation.error}`);\r\n      }\r\n    }\r\n    \r\n    // Afficher les \u00E9tapes de calcul pour le d\u00E9bogage\r\n    console.log('   \u00C9tapes:');\r\n    evaluation.debug.forEach(step => {\r\n      console.log(`     ${step.step}. ${step.operation} => ${step.value}`);\r\n    });\r\n    \r\n    return {\r\n      name: testName,\r\n      success,\r\n      values,\r\n      expectedResult,\r\n      actualResult: evaluation.result,\r\n      error: evaluation.error,\r\n      debug: evaluation.debug\r\n    };\r\n  });\r\n  \r\n  // R\u00E9sum\u00E9\r\n  const successCount = results.filter(r => r.success).length;\r\n  console.log(`\\n\uD83D\uDCCA R\u00E9sum\u00E9: ${successCount}/${testCases.length} tests r\u00E9ussis`);\r\n  \r\n  return {\r\n    formulaId: formula.id,\r\n    formulaName: formula.name,\r\n    success: successCount === testCases.length,\r\n    successCount,\r\n    totalTests: testCases.length,\r\n    results\r\n  };\r\n};\r\n\r\n/**\r\n * Exemples de tests pour une formule\r\n */\r\nexport const exampleTestFormula = () => {\r\n  // Exemple de formule: prix * quantit\u00E9\r\n  const formula: Formula = {\r\n    id: 'example-formula',\r\n    name: 'Prix Total',\r\n    targetProperty: 'prixTotal',\r\n    sequence: [\r\n      {\r\n        id: 'field-prix',\r\n        type: 'field',\r\n        value: 'prix',\r\n        label: 'Prix unitaire',\r\n        fieldId: 'prix'\r\n      },\r\n      {\r\n        id: 'op-mult',\r\n        type: 'operator',\r\n        value: '*',\r\n        label: '*'\r\n      },\r\n      {\r\n        id: 'field-qte',\r\n        type: 'field',\r\n        value: 'quantite',\r\n        label: 'Quantit\u00E9',\r\n        fieldId: 'quantite'\r\n      }\r\n    ]\r\n  };\r\n  \r\n  // Jeux de test\r\n  const testCases = [\r\n    {\r\n      name: 'Cas standard',\r\n      values: { prix: 10, quantite: 5 },\r\n      expectedResult: 50\r\n    },\r\n    {\r\n      name: 'Prix z\u00E9ro',\r\n      values: { prix: 0, quantite: 5 },\r\n      expectedResult: 0\r\n    },\r\n    {\r\n      name: 'Quantit\u00E9 d\u00E9cimale',\r\n      values: { prix: 10, quantite: 2.5 },\r\n      expectedResult: 25\r\n    }\r\n  ];\r\n  \r\n  // Ex\u00E9cuter les tests\r\n  return testFormula(formula, testCases);\r\n};\r\n\r\n/**\r\n * Interface simple pour tester une formule avec des valeurs concr\u00E8tes\r\n */\r\nexport const formulaTestUI = (formula: Formula, currentValues?: Record<string, number>) => {\r\n  const fieldsInFormula = formula.sequence\r\n    .filter(item => item.type === 'field')\r\n    .map(item => ({\r\n      id: item.fieldId || String(item.value),\r\n      label: item.label || String(item.value)\r\n    }));\r\n  \r\n  // Valeurs par d\u00E9faut pour les champs\r\n  const defaultValues = currentValues || {};\r\n  fieldsInFormula.forEach(field => {\r\n    if (defaultValues[field.id] === undefined) {\r\n      defaultValues[field.id] = 0;\r\n    }\r\n  });\r\n  \r\n  // \u00C9valuer avec les valeurs actuelles\r\n  const evaluation = evaluateFormula(formula, defaultValues);\r\n  \r\n  console.log('='.repeat(50));\r\n  console.log(`\uD83D\uDD0E Test de la formule: ${formula.name || formula.id}`);\r\n  console.log('='.repeat(50));\r\n  console.log('\\nValeurs actuelles:');\r\n  \r\n  Object.entries(defaultValues).forEach(([fieldId, value]) => {\r\n    const field = fieldsInFormula.find(f => f.id === fieldId);\r\n    console.log(`- ${field?.label || fieldId}: ${value}`);\r\n  });\r\n  \r\n  console.log('\\nR\u00E9sultat:');\r\n  if (evaluation.success) {\r\n    console.log(`\u2705 ${evaluation.result}`);\r\n  } else {\r\n    console.log(`\u274C Erreur: ${evaluation.error}`);\r\n  }\r\n  \r\n  console.log('\\n\u00C9tapes de calcul:');\r\n  evaluation.debug.forEach(step => {\r\n    console.log(`${step.step}. ${step.operation} => ${step.value}`);\r\n  });\r\n  \r\n  console.log('\\n' + '='.repeat(50));\r\n  \r\n  return {\r\n    formula,\r\n    fieldsInFormula,\r\n    currentValues: defaultValues,\r\n    result: evaluation.result,\r\n    success: evaluation.success,\r\n    error: evaluation.error,\r\n    debug: evaluation.debug\r\n  };\r\n};\r\n\r\n/**\r\n * \u00C9value un ensemble de formules en respectant les d\u00E9pendances inter-formules (formula_ref).\r\n * Retourne un objet { fieldId: { formulaId: result } } et un ordre d'\u00E9valuation.\r\n */\r\nexport function evaluateFormulasSet(params: {\r\n  formulas: Formula[]; // toutes les formules disponibles\r\n  fieldValues: Record<string, number>; // valeurs num\u00E9riques de base\r\n  rawValues?: Record<string, unknown>; // valeurs brutes (advanced_select, strings...)\r\n  resolveFormulaById?: (id: string) => Formula | undefined;\r\n}): {\r\n  results: Record<string, Record<string, number | boolean | string | null>>;\r\n  order: string[]; // ordre topologique des formules \u00E9valu\u00E9es\r\n  errors: Record<string, string>; // formulaId -> erreur\r\n} {\r\n  const { formulas, fieldValues, rawValues, resolveFormulaById } = params;\r\n  const byId: Record<string, Formula> = {};\r\n  formulas.forEach(f => { if (f && f.id) byId[f.id] = f; });\r\n  const deps: Record<string, Set<string>> = {};\r\n  const reverseDeps: Record<string, Set<string>> = {};\r\n  const formulaIds = Object.keys(byId);\r\n\r\n  // Extraire d\u00E9pendances formula_ref\r\n  for (const f of formulas) {\r\n    if (!f || !f.id) continue;\r\n    const set = (deps[f.id] = deps[f.id] || new Set());\r\n    for (const it of f.sequence || []) {\r\n      if (it?.type === 'formula_ref' && it.refFormulaId) {\r\n        set.add(it.refFormulaId);\r\n        (reverseDeps[it.refFormulaId] = reverseDeps[it.refFormulaId] || new Set()).add(f.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Kahn topological sort\r\n  const inDegree: Record<string, number> = {};\r\n  formulaIds.forEach(id => { inDegree[id] = deps[id]?.size || 0; });\r\n  const queue: string[] = formulaIds.filter(id => inDegree[id] === 0);\r\n  const order: string[] = [];\r\n  while (queue.length) {\r\n    const id = queue.shift()!;\r\n    order.push(id);\r\n    for (const consumer of reverseDeps[id] || []) {\r\n      inDegree[consumer] -= 1;\r\n      if (inDegree[consumer] === 0) queue.push(consumer);\r\n    }\r\n  }\r\n  // D\u00E9tecter cycles\r\n  const hasCycle = order.length !== formulaIds.length;\r\n  if (hasCycle) {\r\n    // On continue quand m\u00EAme mais les formules cycliques seront \u00E9valu\u00E9es avec guard existant.\r\n    const remaining = formulaIds.filter(id => !order.includes(id));\r\n    order.push(...remaining); // append pour tentative d'\u00E9valuation prot\u00E9g\u00E9e\r\n  }\r\n\r\n  const results: Record<string, Record<string, number | boolean | string | null>> = {};\r\n  const errors: Record<string, string> = {};\r\n  const formulaResultsCache: Record<string, number | boolean | null> = {};\r\n\r\n  const resolver = (id: string) => byId[id] || resolveFormulaById?.(id);\r\n\r\n  for (const fid of order) {\r\n    const f = byId[fid];\r\n    if (!f) continue;\r\n    try {\r\n      const out = evaluateFormula(f, fieldValues, {\r\n        rawValues,\r\n        resolveFormulaById: resolver,\r\n        formulaResults: formulaResultsCache,\r\n        visited: new Set(),\r\n        depth: 0\r\n      });\r\n      if (!results[f.targetProperty || f.id]) results[f.targetProperty || f.id] = {};\r\n      results[f.targetProperty || f.id][f.id] = out.result;\r\n      if (out.success) {\r\n        // stocker num\u00E9rique/bool pour r\u00E9f\u00E9rences ult\u00E9rieures\r\n        if (typeof out.result === 'number' || typeof out.result === 'boolean' || out.result === null) {\r\n          formulaResultsCache[f.id] = out.result as number | boolean | null;\r\n        } else if (typeof out.result === 'string') {\r\n          const num = parseFloat(out.result);\r\n            if (!isNaN(num)) formulaResultsCache[f.id] = num;\r\n        }\r\n      } else {\r\n        errors[f.id] = out.error || 'Erreur inconnue';\r\n      }\r\n    } catch (e) {\r\n      errors[fid] = (e as Error)?.message || 'Erreur inconnue';\r\n    }\r\n  }\r\n\r\n  return { results, order, errors };\r\n}\r\n", "import express, { Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = express.Router({ mergeParams: true });\r\nconst prisma = new PrismaClient();\r\n\r\n// PUT /api/dependencies/:dependencyId - Mettre \u00E0 jour une d\u00E9pendance et retourner la liste du champ\r\nrouter.put('/:dependencyId', async (req: Request, res: Response) => {\r\n  const { dependencyId } = req.params;\r\n  const { name, description, sequence, order, targetFieldId, operator, value, action, prefillValue } = req.body || {};\r\n  try {\r\n    const existing = await prisma.fieldDependency.findUnique({ where: { id: dependencyId } });\r\n    if (!existing) {\r\n      return res.status(404).json({ error: 'D\u00E9pendance non trouv\u00E9e' });\r\n    }\r\n\r\n    const dataToUpdate: Record<string, unknown> = {};\r\n    if (name !== undefined) dataToUpdate.name = name;\r\n    if (description !== undefined) dataToUpdate.description = description;\r\n    if (sequence !== undefined) dataToUpdate.sequence = JSON.stringify(sequence);\r\n    if (order !== undefined) dataToUpdate.order = order;\r\n    if (targetFieldId !== undefined) dataToUpdate.dependsOnId = targetFieldId;\r\n    if (operator !== undefined) dataToUpdate.condition = operator;\r\n    if (value !== undefined) dataToUpdate.value = value;\r\n    if (action !== undefined || prefillValue !== undefined) dataToUpdate.params = { action, prefillValue };\r\n\r\n    await prisma.fieldDependency.update({ where: { id: dependencyId }, data: dataToUpdate });\r\n\r\n    const deps = await prisma.fieldDependency.findMany({\r\n      where: { fieldId: existing.fieldId },\r\n      orderBy: { order: 'asc' },\r\n    });\r\n    const processed = deps.map(d => ({\r\n      ...d,\r\n      sequence: typeof d.sequence === 'string' ? JSON.parse(d.sequence as unknown as string) : (d.sequence ?? []),\r\n    }));\r\n    return res.json(processed);\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur PUT /api/dependencies/${dependencyId}:`, error);\r\n    return res.status(500).json({ error: 'Erreur lors de la mise \u00E0 jour de la d\u00E9pendance', details: (error as Error).message });\r\n  }\r\n});\r\n\r\n// DELETE /api/dependencies/:dependencyId - Supprimer une d\u00E9pendance et retourner la liste du champ\r\nrouter.delete('/:dependencyId', async (req: Request, res: Response) => {\r\n  const { dependencyId } = req.params;\r\n  try {\r\n    const existing = await prisma.fieldDependency.findUnique({ where: { id: dependencyId } });\r\n    if (!existing) {\r\n      return res.status(404).json({ error: 'D\u00E9pendance non trouv\u00E9e' });\r\n    }\r\n    const fieldId = existing.fieldId;\r\n\r\n    await prisma.fieldDependency.delete({ where: { id: dependencyId } });\r\n\r\n    const deps = await prisma.fieldDependency.findMany({ where: { fieldId }, orderBy: { order: 'asc' } });\r\n    const processed = deps.map(d => ({\r\n      ...d,\r\n      sequence: typeof d.sequence === 'string' ? JSON.parse(d.sequence as unknown as string) : (d.sequence ?? []),\r\n    }));\r\n    return res.status(200).json(processed);\r\n  } catch (error: unknown) {\r\n    console.error(`[API] Erreur DELETE /api/dependencies/${req.params.dependencyId}:`, error);\r\n    const errObj = error as { code?: string };\r\n    if (errObj?.code === 'P2025') {\r\n      return res.status(404).json({ error: 'D\u00E9pendance non trouv\u00E9e' });\r\n    }\r\n    return res.status(500).json({ error: 'Erreur lors de la suppression de la d\u00E9pendance', details: (error as Error).message });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response, type RequestHandler } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\nrouter.use(authMiddleware as unknown as RequestHandler, impersonationMiddleware as unknown as RequestHandler);\r\n\r\n// \u2705 REDIRECTION : /api/sections \u2192 Categories Prisma\r\n// Ces routes permettent au hook useDynamicSections de fonctionner sans modification\r\n\r\n// GET - R\u00E9cup\u00E9rer toutes les Categories (compatible avec useDynamicSections)\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const organizationId = req.query.organizationId as string;\r\n    \r\n    console.log('[SECTIONS\u2192CATEGORIES] GET - R\u00E9cup\u00E9ration des Categories existantes depuis admin-modules');\r\n    \r\n    // \u2705 Utiliser les Categories existantes via les routes admin-modules\r\n    const categories = await prisma.category.findMany({\r\n      where: organizationId ? { \r\n        OR: [\r\n          { organizationId: organizationId },\r\n          { organizationId: null } // Categories globales\r\n        ]\r\n      } : undefined,\r\n      orderBy: { order: 'asc' }\r\n    });\r\n\r\n    // Convertir Categories \u2192 format sections pour useDynamicSections (sans modification)\r\n    const sectionsFormat = categories.map(category => ({\r\n      id: category.id,\r\n      title: category.name,\r\n      description: category.description || '',\r\n      iconName: category.icon,\r\n      iconColor: category.iconColor,\r\n      order: category.order,\r\n      active: category.active,\r\n      organizationId: category.organizationId,\r\n      createdAt: category.createdAt.toISOString(),\r\n      updatedAt: category.updatedAt.toISOString()\r\n    }));\r\n\r\n    console.log(`[SECTIONS\u2192CATEGORIES] ${sectionsFormat.length} Categories existantes converties en sections`);\r\n    console.log(`[SECTIONS\u2192CATEGORIES] Categories trouv\u00E9es: ${sectionsFormat.map(s => s.title).join(', ')}`);\r\n    \r\n    res.json(sectionsFormat);\r\n  } catch (error) {\r\n    console.error('[SECTIONS\u2192CATEGORIES] Erreur GET:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des sections'\r\n    });\r\n  }\r\n});\r\n\r\n// POST /bulk - Cr\u00E9er plusieurs Categories en une fois\r\nrouter.post('/bulk', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { sections } = req.body;\r\n    \r\n    console.log(`[SECTIONS\u2192CATEGORIES] POST/bulk - Cr\u00E9ation de ${sections.length} Categories`);\r\n    \r\n    // Convertir sections \u2192 Categories pour Prisma\r\n    const categoriesToCreate = sections.map((section: any) => ({\r\n      name: section.title,\r\n      description: section.description,\r\n      icon: section.iconName,\r\n      iconColor: section.iconColor,\r\n      order: section.order,\r\n      active: section.active,\r\n      organizationId: section.organizationId,\r\n      superAdminOnly: false\r\n    }));\r\n\r\n    // Cr\u00E9er en bulk avec Prisma\r\n    const createdCategories = await Promise.all(\r\n      categoriesToCreate.map(category => \r\n        prisma.category.create({ data: category })\r\n      )\r\n    );\r\n\r\n    // Reconvertir vers format sections\r\n    const sectionsFormat = createdCategories.map(category => ({\r\n      id: category.id,\r\n      title: category.name,\r\n      description: category.description || '',\r\n      iconName: category.icon,\r\n      iconColor: category.iconColor,\r\n      order: category.order,\r\n      active: category.active,\r\n      organizationId: category.organizationId,\r\n      createdAt: category.createdAt.toISOString(),\r\n      updatedAt: category.updatedAt.toISOString()\r\n    }));\r\n\r\n    console.log(`[SECTIONS\u2192CATEGORIES] ${createdCategories.length} Categories cr\u00E9\u00E9es avec succ\u00E8s`);\r\n    \r\n    res.json(sectionsFormat);\r\n  } catch (error) {\r\n    console.error('[SECTIONS\u2192CATEGORIES] Erreur POST/bulk:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la cr\u00E9ation des sections'\r\n    });\r\n  }\r\n});\r\n\r\n// POST - Cr\u00E9er une nouvelle Category\r\nrouter.post('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { name, description, iconName, iconColor, order, active, organizationId } = req.body;\r\n    \r\n    console.log(`[SECTIONS\u2192CATEGORIES] POST - Cr\u00E9ation Category \"${name}\"`);\r\n    \r\n    const category = await prisma.category.create({\r\n      data: {\r\n        name,\r\n        description: description || `Category ${name}`,\r\n        icon: iconName || 'AppstoreOutlined',\r\n        iconColor: iconColor || '#1890ff',\r\n        order: order || 999,\r\n        active: active !== false,\r\n        organizationId,\r\n        superAdminOnly: false\r\n      }\r\n    });\r\n\r\n    // Convertir vers format section\r\n    const sectionFormat = {\r\n      id: category.id,\r\n      title: category.name,\r\n      description: category.description || '',\r\n      iconName: category.icon,\r\n      iconColor: category.iconColor,\r\n      order: category.order,\r\n      active: category.active,\r\n      organizationId: category.organizationId,\r\n      createdAt: category.createdAt.toISOString(),\r\n      updatedAt: category.updatedAt.toISOString()\r\n    };\r\n\r\n    console.log(`[SECTIONS\u2192CATEGORIES] Category \"${name}\" cr\u00E9\u00E9e avec succ\u00E8s`);\r\n    \r\n    res.json({ success: true, data: sectionFormat });\r\n  } catch (error) {\r\n    console.error('[SECTIONS\u2192CATEGORIES] Erreur POST:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la cr\u00E9ation de la section'\r\n    });\r\n  }\r\n});\r\n\r\n// PATCH - Mettre \u00E0 jour une Category\r\nrouter.patch('/:id', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    const updateData = req.body;\r\n    \r\n    console.log(`[SECTIONS\u2192CATEGORIES] PATCH - Mise \u00E0 jour Category ${id}`);\r\n    \r\n    // Convertir les champs sections \u2192 Categories si n\u00E9cessaire\r\n    const categoryUpdateData: any = {};\r\n    if (updateData.title) categoryUpdateData.name = updateData.title;\r\n    if (updateData.description !== undefined) categoryUpdateData.description = updateData.description;\r\n    if (updateData.iconName) categoryUpdateData.icon = updateData.iconName;\r\n    if (updateData.iconColor) categoryUpdateData.iconColor = updateData.iconColor;\r\n    if (updateData.order !== undefined) categoryUpdateData.order = updateData.order;\r\n    if (updateData.active !== undefined) categoryUpdateData.active = updateData.active;\r\n\r\n    const category = await prisma.category.update({\r\n      where: { id },\r\n      data: categoryUpdateData\r\n    });\r\n\r\n    // Convertir vers format section\r\n    const sectionFormat = {\r\n      id: category.id,\r\n      title: category.name,\r\n      description: category.description || '',\r\n      iconName: category.icon,\r\n      iconColor: category.iconColor,\r\n      order: category.order,\r\n      active: category.active,\r\n      organizationId: category.organizationId,\r\n      createdAt: category.createdAt.toISOString(),\r\n      updatedAt: category.updatedAt.toISOString()\r\n    };\r\n\r\n    console.log(`[SECTIONS\u2192CATEGORIES] Category ${id} mise \u00E0 jour avec succ\u00E8s`);\r\n    \r\n    res.json(sectionFormat);\r\n  } catch (error) {\r\n    console.error('[SECTIONS\u2192CATEGORIES] Erreur PATCH:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la mise \u00E0 jour de la section'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE - Supprimer une Category\r\nrouter.delete('/:id', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { id } = req.params;\r\n    \r\n    console.log(`[SECTIONS\u2192CATEGORIES] DELETE - Suppression Category ${id}`);\r\n    \r\n    await prisma.category.delete({\r\n      where: { id }\r\n    });\r\n\r\n    console.log(`[SECTIONS\u2192CATEGORIES] Category ${id} supprim\u00E9e avec succ\u00E8s`);\r\n    \r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('[SECTIONS\u2192CATEGORIES] Erreur DELETE:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur lors de la suppression de la section'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport { impersonationMiddleware } from '../middlewares/impersonation';\r\nimport { prisma } from '../lib/prisma';\r\n\r\nconst router = Router();\r\n\r\n// Appliquer les middlewares d'authentification\r\nrouter.use(authMiddleware as unknown as (req: Request, res: Response, next: () => void) => void, impersonationMiddleware as unknown as (req: Request, res: Response, next: () => void) => void);\r\n\r\n// \uD83D\uDDC2\uFE0F NAVIGATION DES MODULES - Organise les modules par cat\u00E9gories pour l'interface\r\n// \u26A0\uFE0F  Ne pas confondre avec les sections de formulaires (table Section)\r\n\r\n// GET - R\u00E9cup\u00E9rer les sections de navigation bas\u00E9es sur la table Category avec toutes les v\u00E9rifications de s\u00E9curit\u00E9\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    console.log('\uD83D\uDD0D [module-navigation] Route appel\u00E9e - Syst\u00E8me Category');\r\n    console.log('\uD83D\uDD0D [module-navigation] User:', req.user);\r\n    console.log('\uD83D\uDD0D [module-navigation] Prisma client status:', typeof prisma, !!prisma);\r\n    \r\n    const organizationId = req.query.organizationId as string;\r\n    \r\n    if (!organizationId) {\r\n      console.log('\u274C [module-navigation] organizationId manquant');\r\n      res.status(400).json({ error: 'organizationId required' });\r\n      return;\r\n    }\r\n\r\n    console.log('[API] GET /api/module-navigation - Syst\u00E8me Category avec s\u00E9curit\u00E9 multifacteur pour org:', organizationId);\r\n\r\n    // V\u00E9rification utilisateur et permissions\r\n    const user = req.user as { id?: string; email?: string; role?: string; organizationId?: string } | undefined;\r\n    const isSuperAdmin = user?.role === 'super_admin';\r\n    \r\n    console.log(`[API] Utilisateur: ${user?.email} (${user?.role}), SuperAdmin: ${isSuperAdmin}`);\r\n\r\n    // R\u00E9cup\u00E9rer l'organisation de l'utilisateur\r\n    let userOrganizationId = user?.organizationId;\r\n    \r\n    if (!userOrganizationId && user?.id) {\r\n      const userOrg = await prisma.userOrganization.findFirst({\r\n        where: { userId: user.id }\r\n      });\r\n      userOrganizationId = userOrg?.organizationId;\r\n      console.log(`[API] OrganizationId r\u00E9cup\u00E9r\u00E9 via UserOrganization: ${userOrganizationId}`);\r\n    }\r\n\r\n    // \uD83C\uDFE2 R\u00C9CUP\u00C9RER LES CAT\u00C9GORIES ACCESSIBLES POUR CETTE ORGANISATION\r\n    // Avec v\u00E9rifications multifacteurs : superAdmin, r\u00F4les, permissions, statut org\r\n    \r\n    const whereCategories = {\r\n      AND: [\r\n        // Cat\u00E9gories actives uniquement\r\n        { active: true },\r\n        \r\n        // Cat\u00E9gories globales OU sp\u00E9cifiques \u00E0 l'organisation\r\n        {\r\n          OR: [\r\n            { organizationId: null }, // Cat\u00E9gories globales\r\n            { organizationId: organizationId } // Cat\u00E9gories sp\u00E9cifiques \u00E0 l'org\r\n          ]\r\n        },\r\n        \r\n        // V\u00E9rification superAdminOnly\r\n        ...(isSuperAdmin ? [] : [{ superAdminOnly: false }])\r\n      ]\r\n    };\r\n\r\n    const categories = await prisma.category.findMany({\r\n      where: whereCategories,\r\n      include: {\r\n        // Inclure les modules associ\u00E9s\r\n        Module: {\r\n          where: {\r\n            AND: [\r\n              // Modules actifs uniquement\r\n              { active: true },\r\n              \r\n              // V\u00E9rification superAdminOnly pour les modules\r\n              ...(isSuperAdmin ? [] : [{ superAdminOnly: false }]),\r\n              \r\n              // Modules pour cette organisation ou modules globaux\r\n              {\r\n                OR: [\r\n                  ...(userOrganizationId ? [{ organizationId: userOrganizationId }] : []),\r\n                  ...(isSuperAdmin ? [{ organizationId: null }] : [])\r\n                ]\r\n              }\r\n            ]\r\n          },\r\n          orderBy: { order: 'asc' }\r\n        }\r\n      },\r\n      orderBy: { order: 'asc' }\r\n    });\r\n\r\n    console.log(`[API] ${categories.length} cat\u00E9gories trouv\u00E9es`);\r\n\r\n    // \uD83D\uDDC2\uFE0F TRANSFORMER LES CAT\u00C9GORIES EN SECTIONS POUR LE FRONTEND\r\n    const sections = categories.map(category => ({\r\n      id: `section-${category.id}`,\r\n      title: category.name,\r\n      description: category.description || category.Module.map(m => m.label).join(', '),\r\n      icon: category.icon,\r\n      iconColor: category.iconColor,\r\n      order: category.order,\r\n      organizationId,\r\n      modules: category.Module.map(module => ({\r\n        ...module,\r\n        category: category.name, // \u2705 Ajouter le nom de la cat\u00E9gorie \u00E0 chaque module\r\n        categoryIcon: category.icon,\r\n        categoryColor: category.iconColor\r\n      })),\r\n      createdAt: category.createdAt.toISOString(),\r\n      updatedAt: category.updatedAt.toISOString(),\r\n      // M\u00E9tadonn\u00E9es pour debugging\r\n      categoryId: category.id,\r\n      superAdminOnly: category.superAdminOnly,\r\n      allowedRoles: category.allowedRoles,\r\n      requiredPermissions: category.requiredPermissions\r\n    }));\r\n\r\n    console.log('[API] Sections cr\u00E9\u00E9es depuis les cat\u00E9gories:', sections.length);\r\n    console.log('[API] Sections:', sections.map(s => `${s.title} (${s.modules.length} modules)`));\r\n    \r\n    res.json(sections);\r\n\r\n  } catch (error) {\r\n    console.error('[API] Erreur syst\u00E8me Category:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des cat\u00E9gories depuis la table Category' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDCDD SECTIONS DE FORMULAIRES - Gestion des sections Block\u2192Section\u2192Field\r\n// \u26A0\uFE0F  Ne pas confondre avec la navigation des modules (module.category)\r\n\r\n// GET toutes les sections pour un bloc sp\u00E9cifique\r\nrouter.get('/:blockId', async (req: Request, res: Response): Promise<void> => {\r\n  const { blockId } = req.params;\r\n  try {\r\n    console.log(`[API] GET /api/form-sections/${blockId} - R\u00E9cup\u00E9ration sections de formulaire`);\r\n    \r\n    const sections = await prisma.section.findMany({\r\n      where: { blockId },\r\n      include: {\r\n        Field: { // Inclure les champs pour chaque section\r\n          orderBy: {\r\n            order: 'asc'\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        order: 'asc'\r\n      }\r\n    });\r\n\r\n    // Le nom de la relation est 'Field' (majuscule) dans Prisma\r\n    const adaptedSections = sections.map(section => ({\r\n      ...section,\r\n      fields: section.Field || [] // 'Field' est maintenant inclus et disponible\r\n    }));\r\n\r\n    console.log(`[API] ${adaptedSections.length} sections de formulaire trouv\u00E9es pour bloc ${blockId}`);\r\n    res.json(adaptedSections);\r\n    \r\n  } catch (e) {\r\n    console.error(`[API] Erreur r\u00E9cup\u00E9ration sections pour bloc ${blockId}:`, e);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00E9cup\u00E9ration des sections', details: e });\r\n  }\r\n});\r\n\r\n// POST - Cr\u00E9er une nouvelle section de formulaire\r\nrouter.post('/', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { name, blockId, order, sectionType } = req.body;\r\n    \r\n    console.log(`[API] POST /api/form-sections - Cr\u00E9ation section: ${name} pour bloc ${blockId}`);\r\n\r\n    if (!name || !blockId) {\r\n      res.status(400).json({ error: 'Name et blockId requis' });\r\n      return;\r\n    }\r\n\r\n    const section = await prisma.section.create({\r\n      data: {\r\n        id: `section-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n        name,\r\n        blockId,\r\n        order: order || 0,\r\n        sectionType: sectionType || 'normal',\r\n        active: true\r\n      },\r\n      include: {\r\n        Field: true\r\n      }\r\n    });\r\n\r\n    console.log(`[API] \u2705 Section de formulaire cr\u00E9\u00E9e: ${section.id}`);\r\n    res.json({ success: true, data: section });\r\n    \r\n  } catch (error) {\r\n    console.error('[API] Erreur cr\u00E9ation section:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00E9ation de la section de formulaire' });\r\n  }\r\n});\r\n\r\n// PUT - Modifier une section de formulaire\r\nrouter.put('/:sectionId', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { sectionId } = req.params;\r\n    const { name, order, sectionType, active } = req.body;\r\n    \r\n    console.log(`[API] PUT /api/form-sections/${sectionId} - Modification section`);\r\n\r\n    const section = await prisma.section.update({\r\n      where: { id: sectionId },\r\n      data: {\r\n        ...(name && { name }),\r\n        ...(order !== undefined && { order }),\r\n        ...(sectionType && { sectionType }),\r\n        ...(active !== undefined && { active })\r\n      },\r\n      include: {\r\n        Field: true\r\n      }\r\n    });\r\n\r\n    console.log(`[API] \u2705 Section de formulaire modifi\u00E9e: ${section.id}`);\r\n    res.json({ success: true, data: section });\r\n    \r\n  } catch (error) {\r\n    console.error(`[API] Erreur modification section ${req.params.sectionId}:`, error);\r\n    res.status(500).json({ error: 'Erreur lors de la modification de la section de formulaire' });\r\n  }\r\n});\r\n\r\n// DELETE - Supprimer une section de formulaire\r\nrouter.delete('/:sectionId', async (req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const { sectionId } = req.params;\r\n    \r\n    console.log(`[API] DELETE /api/form-sections/${sectionId} - Suppression section`);\r\n\r\n    await prisma.section.delete({\r\n      where: { id: sectionId }\r\n    });\r\n\r\n    console.log(`[API] \u2705 Section de formulaire supprim\u00E9e: ${sectionId}`);\r\n    res.json({ success: true, message: 'Section de formulaire supprim\u00E9e' });\r\n    \r\n  } catch (error) {\r\n    console.error(`[API] Erreur suppression section ${req.params.sectionId}:`, error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de la section de formulaire' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware } from '../middlewares/auth';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Lecture des types de champs (globaux) \u2013 accessible aux utilisateurs authentifi\u00E9s\r\nrouter.use(authMiddleware as unknown as (req: Request, res: Response, next: () => void) => void);\r\n\r\n// GET /api/field-types\r\nrouter.get('/', async (_req: Request, res: Response): Promise<void> => {\r\n  try {\r\n    const types = await prisma.fieldType.findMany({\r\n      orderBy: { label: 'asc' },\r\n    });\r\n    res.json({ success: true, data: types });\r\n  } catch (error) {\r\n    console.error('[API] Erreur GET /api/field-types:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des types de champs' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware } from '../middlewares/auth';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Fallback SQL supprim\u00E9s: on s\u2019appuie d\u00E9sormais sur Prisma Client uniquement.\r\n\r\nrouter.use(authMiddleware as unknown as (req: Request, res: Response, next: () => void) => void);\r\n\r\ntype FlatNode = { id: string; label: string; value: string | null; parentId: string | null; order: number; data: unknown };\r\ntype TreeNode = FlatNode & { children: TreeNode[] };\r\n// Enrichi pour r\u00E9ponse API front\r\nexport type EnrichedNode = {\r\n  id: string;\r\n  label: string;\r\n  value: string | null;\r\n  parentId: string | null;\r\n  order: number;\r\n  data: unknown;\r\n  children: EnrichedNode[];\r\n  hasChildren: boolean;\r\n  hasExtra: boolean; // data.nextField\r\n  pathIds: string[]; // chemin des ids racine -> ce n\u0153ud\r\n  pathLabels: string[]; // labels sur le chemin\r\n};\r\n\r\nfunction buildTree(nodes: FlatNode[]): TreeNode[] {\r\n  const byId = new Map<string, TreeNode>(nodes.map(n => [n.id, { ...n, children: [] }]));\r\n  const roots: TreeNode[] = [];\r\n  nodes.forEach(n => {\r\n    if (n.parentId && byId.has(n.parentId)) {\r\n      const parent = byId.get(n.parentId)!;\r\n      parent.children.push(byId.get(n.id)!);\r\n    } else {\r\n      roots.push(byId.get(n.id)!);\r\n    }\r\n  });\r\n  // trier par order\r\n  const sortRec = (arr: TreeNode[]) => {\r\n    arr.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));\r\n    arr.forEach((c) => sortRec(c.children || []));\r\n  };\r\n  sortRec(roots);\r\n  return roots;\r\n}\r\n\r\n// GET /api/option-nodes/:id -> d\u00E9tails d'un n\u0153ud (incl. data)\r\nrouter.get('/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const node = await prisma.fieldOptionNode.findUnique({ where: { id }, select: { id: true, label: true, value: true, parentId: true, order: true, data: true, fieldId: true } });\r\n    if (!node) return res.status(404).json({ success: false, message: 'Not found' });\r\n    return res.json({ success: true, data: node });\r\n  } catch (e) {\r\n    console.error('[API] GET option-node detail error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// GET /api/option-nodes/field/:fieldId/tree -> arborescence compl\u00E8te\r\nrouter.get('/field/:fieldId/tree', async (req: Request, res: Response) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const nodes = await prisma.fieldOptionNode.findMany({\r\n      where: { fieldId },\r\n      orderBy: [{ parentId: 'asc' }, { order: 'asc' }],\r\n      select: { id: true, label: true, value: true, parentId: true, order: true, data: true },\r\n    });\r\n    const tree = buildTree(nodes as FlatNode[]);\r\n    // Construire index enfants pour hasChildren rapide\r\n    const childrenCount = new Map<string, number>();\r\n    tree.forEach(function collect(n){\r\n      n.children.forEach(c=>collect(c));\r\n      if(n.parentId){ childrenCount.set(n.parentId, (childrenCount.get(n.parentId)||0)+1); }\r\n    });\r\n    const enrich = (n: TreeNode, pathIds: string[], pathLabels: string[]): EnrichedNode => {\r\n      const nextIds = [...pathIds, n.id];\r\n      const nextLabels = [...pathLabels, n.label];\r\n      const children = n.children.map(c=>enrich(c,nextIds,nextLabels));\r\n  const dataObj = (n.data && typeof n.data==='object') ? n.data as Record<string, unknown> : {};\r\n  const hasExtra = Object.prototype.hasOwnProperty.call(dataObj,'nextField') && !!(dataObj as { nextField?: unknown }).nextField;\r\n      return {\r\n        id: n.id,\r\n        label: n.label,\r\n        value: n.value,\r\n        parentId: n.parentId,\r\n        order: n.order,\r\n        data: n.data,\r\n        children,\r\n        hasChildren: children.length>0,\r\n        hasExtra,\r\n        pathIds: nextIds,\r\n        pathLabels: nextLabels,\r\n      };\r\n    };\r\n    const enriched = tree.map(r=>enrich(r,[],[]));\r\n    return res.json({ success: true, data: enriched, _v: 1 });\r\n  } catch (e) {\r\n    console.error('[API] GET option-nodes tree error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// GET /api/option-nodes/field/:fieldId/children?parentId=xxx\r\nrouter.get('/field/:fieldId/children', async (req: Request, res: Response) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const parentId = (req.query.parentId as string | undefined) || null;\r\n    const base = await prisma.fieldOptionNode.findMany({ where: { fieldId, parentId }, orderBy: { order: 'asc' } });\r\n    const children = base.map((b) => ({ id: b.id, label: b.label, value: b.value ?? undefined }));\r\n    return res.json({ success: true, data: children });\r\n  } catch (e) {\r\n    console.error('[API] GET option-nodes children error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/option-nodes -> create\r\nrouter.post('/', async (req: Request, res: Response) => {\r\n  try {\r\n    const { fieldId, parentId, label, value, order, data } = req.body as { fieldId: string; parentId?: string | null; label: string; value?: string | null; order?: number; data?: unknown };\r\n    if (!fieldId || !label) return res.status(400).json({ success: false, message: 'fieldId et label requis' });\r\n    \r\n    // Using FieldOptionNode with hierarchy support\r\n    const created = await prisma.fieldOptionNode.create({ \r\n      data: { \r\n        fieldId, \r\n        parentId: parentId ?? null,\r\n        label, \r\n        value: value ?? label, // Use label as value if not provided\r\n        order: order ?? 0,\r\n        data: data ?? undefined\r\n      } \r\n    });\r\n    \r\n    return res.json({ success: true, data: created });\r\n  } catch (e) {\r\n    console.error('[API] POST option-nodes create error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// PUT /api/option-nodes/:id -> update\r\nrouter.put('/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { label, value, order, data, parentId } = req.body as { label?: string; value?: string | null; order?: number; data?: unknown; parentId?: string | null };\r\n    const updated = await prisma.fieldOptionNode.update({ where: { id }, data: { label: label ?? undefined, value: value === undefined ? undefined : value, order: order ?? undefined, data: data === undefined ? undefined : data, parentId: parentId === undefined ? undefined : parentId } });\r\n    return res.json({ success: true, data: updated });\r\n  } catch (e) {\r\n    console.error('[API] PUT option-nodes update error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// DELETE /api/option-nodes/:id -> delete subtree or node only (query mode=with-children|only)\r\nrouter.delete('/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const mode = (req.query.mode as string) || 'with-children';\r\n    if (mode === 'only') {\r\n      const node = await prisma.fieldOptionNode.findUnique({ where: { id }, select: { parentId: true } });\r\n      if (!node) return res.status(404).json({ success: false, message: 'Not found' });\r\n      await prisma.$transaction([\r\n        prisma.fieldOptionNode.updateMany({ where: { parentId: id }, data: { parentId: node.parentId } }),\r\n        prisma.fieldOptionNode.delete({ where: { id } }),\r\n      ]);\r\n      return res.json({ success: true });\r\n    }\r\n    const collectIds = async (ids: string[]): Promise<string[]> => {\r\n      const children = await prisma.fieldOptionNode.findMany({ where: { parentId: { in: ids } }, select: { id: true } });\r\n      if (children.length === 0) return ids;\r\n      const childIds = children.map((c) => c.id);\r\n      const all = await collectIds(childIds);\r\n      return [...ids, ...all];\r\n    };\r\n    const allIds = await collectIds([id]);\r\n    await prisma.fieldOptionNode.deleteMany({ where: { id: { in: allIds } } });\r\n    return res.json({ success: true });\r\n  } catch (e) {\r\n    console.error('[API] DELETE option-nodes error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/option-nodes/reorder -> r\u00E9ordonner sous un parent\r\nrouter.post('/reorder', async (req: Request, res: Response) => {\r\n  try {\r\n    const { fieldId, orderedIds } = req.body as { fieldId: string; orderedIds: string[] };\r\n    if (!fieldId || !Array.isArray(orderedIds)) return res.status(400).json({ success: false, message: 'Payload invalide' });\r\n    await prisma.$transaction(orderedIds.map((id, idx) => prisma.fieldOptionNode.update({ where: { id }, data: { order: idx } })));\r\n    return res.json({ success: true });\r\n  } catch (e) {\r\n    console.error('[API] POST option-nodes reorder error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/option-nodes/import -> remplacer tout l'arbre d'un champ \u00E0 partir d'un JSON\r\nrouter.post('/import', async (req: Request, res: Response) => {\r\n  try {\r\n    const { fieldId, tree } = req.body as { fieldId: string; tree: Array<TreeNode> };\r\n    if (!fieldId || !Array.isArray(tree)) return res.status(400).json({ success: false, message: 'Payload invalide' });\r\n    await prisma.fieldOptionNode.deleteMany({ where: { fieldId } });\r\n    const inserts: Array<Promise<unknown>> = [];\r\n    const walk = (nodes: TreeNode[], parentId: string | null) => {\r\n      nodes.forEach((n, idx) => {\r\n        const id = n.id || undefined; // laisser Prisma g\u00E9n\u00E9rer si absent\r\n        inserts.push(prisma.fieldOptionNode.create({ data: { id, fieldId, parentId, label: n.label, value: n.value ?? null, order: idx, data: n.data ?? undefined } }));\r\n        if (Array.isArray(n.children) && n.children.length > 0) {\r\n          if (!n.id) {\r\n            throw new Error('Chaque n\u0153ud avec enfants doit fournir un id pour import');\r\n          }\r\n          walk(n.children, n.id);\r\n        }\r\n      });\r\n    };\r\n    walk(tree, null);\r\n    await Promise.all(inserts);\r\n    return res.json({ success: true });\r\n  } catch (e) {\r\n    console.error('[API] POST option-nodes import error:', e);\r\n    return res.status(500).json({ success: false, message: (e as Error)?.message || 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// GET /api/option-nodes/export/:fieldId -> exporter l'arbre\r\nrouter.get('/export/:fieldId', async (req: Request, res: Response) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const nodes = await prisma.fieldOptionNode.findMany({ where: { fieldId }, orderBy: [{ parentId: 'asc' }, { order: 'asc' }], select: { id: true, label: true, value: true, parentId: true, order: true, data: true } });\r\n    return res.json({ success: true, data: buildTree(nodes as FlatNode[]) });\r\n  } catch (e) {\r\n    console.error('[API] GET option-nodes export error:', e);\r\n    return res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import express from 'express';\r\nimport AdvancedSelectService from '../services/AdvancedSelectService.js';\r\n\r\n/**\r\n * \uD83D\uDE80 API ENDPOINTS POUR ADVANCED_SELECT PROFESSIONNEL\r\n * \r\n * Routes:\r\n * \u2705 GET /api/advanced-select/:fieldId - R\u00E9cup\u00E9rer un champ advanced_select\r\n * \u2705 POST /api/advanced-select/:fieldId/calculate - Effectuer un calcul\r\n * \u2705 PUT /api/advanced-select/:fieldId/update - Mettre \u00E0 jour un champ calcul\u00E9\r\n * \u2705 POST /api/advanced-select/validate - Valider une valeur\r\n */\r\n\r\nconst router = express.Router();\r\nconst advancedSelectService = new AdvancedSelectService();\r\n\r\n/**\r\n * \uD83D\uDCDD R\u00E9cup\u00E9rer un champ advanced_select avec ses options enrichies\r\n */\r\nrouter.get('/:fieldId', async (req, res) => {\r\n    try {\r\n        const { fieldId } = req.params;\r\n        const { organizationId } = req.query;\r\n\r\n        if (!organizationId) {\r\n            return res.status(400).json({\r\n                success: false,\r\n                error: 'organizationId est requis'\r\n            });\r\n        }\r\n\r\n        const field = await advancedSelectService.getAdvancedSelectField(fieldId, organizationId);\r\n\r\n        res.json({\r\n            success: true,\r\n            data: field,\r\n            metadata: {\r\n                timestamp: new Date().toISOString(),\r\n                capabilities: field.capabilities\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur GET advanced-select:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            error: error.message\r\n        });\r\n    }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDEE Effectuer un calcul bas\u00E9 sur les donn\u00E9es saisies\r\n */\r\nrouter.post('/:fieldId/calculate', async (req, res) => {\r\n    try {\r\n        const { fieldId } = req.params;\r\n        const { \r\n            optionValue, \r\n            inputData, \r\n            relatedFieldsData = {},\r\n            organizationId \r\n        } = req.body;\r\n\r\n        if (!optionValue || inputData === undefined) {\r\n            return res.status(400).json({\r\n                success: false,\r\n                error: 'optionValue et inputData sont requis'\r\n            });\r\n        }\r\n\r\n        const calculationResult = await advancedSelectService.performCalculation(\r\n            fieldId,\r\n            optionValue,\r\n            inputData,\r\n            relatedFieldsData\r\n        );\r\n\r\n        // Si le calcul a r\u00E9ussi et qu'il y a un champ cible, le mettre \u00E0 jour\r\n        if (calculationResult.success && calculationResult.metadata?.formula?.result_field) {\r\n            const targetFieldId = calculationResult.metadata.formula.result_field;\r\n            \r\n            await advancedSelectService.updateCalculatedField(\r\n                targetFieldId,\r\n                calculationResult.result,\r\n                organizationId,\r\n                {\r\n                    sourceField: fieldId,\r\n                    calculation: calculationResult.metadata\r\n                }\r\n            );\r\n        }\r\n\r\n        res.json({\r\n            success: true,\r\n            data: calculationResult,\r\n            timestamp: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur POST calculate:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            error: error.message\r\n        });\r\n    }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCA Mettre \u00E0 jour un champ calcul\u00E9 (usage interne)\r\n */\r\nrouter.put('/:fieldId/update', async (req, res) => {\r\n    try {\r\n        const { fieldId } = req.params;\r\n        const { value, organizationId, metadata = {} } = req.body;\r\n\r\n        if (value === undefined || !organizationId) {\r\n            return res.status(400).json({\r\n                success: false,\r\n                error: 'value et organizationId sont requis'\r\n            });\r\n        }\r\n\r\n        const updateResult = await advancedSelectService.updateCalculatedField(\r\n            fieldId,\r\n            value,\r\n            organizationId,\r\n            metadata\r\n        );\r\n\r\n        res.json({\r\n            success: true,\r\n            data: updateResult\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur PUT update:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            error: error.message\r\n        });\r\n    }\r\n});\r\n\r\n/**\r\n * \u2705 Valider une valeur selon les r\u00E8gles m\u00E9tier\r\n */\r\nrouter.post('/validate', async (req, res) => {\r\n    try {\r\n        const { value, unit, rules = [] } = req.body;\r\n\r\n        if (value === undefined) {\r\n            return res.status(400).json({\r\n                success: false,\r\n                error: 'value est requis'\r\n            });\r\n        }\r\n\r\n        const validation = advancedSelectService.validateResult(value, unit);\r\n\r\n        res.json({\r\n            success: true,\r\n            data: {\r\n                isValid: validation.isValid,\r\n                validations: validation.validations,\r\n                summary: validation.summary\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur POST validate:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            error: error.message\r\n        });\r\n    }\r\n});\r\n\r\n/**\r\n * \uD83C\uDFD7\uFE0F Cr\u00E9er un template d'advanced_select pour le no-code\r\n */\r\nrouter.post('/templates', async (req, res) => {\r\n    try {\r\n        const { templateType, fieldConfig, organizationId } = req.body;\r\n\r\n        if (!templateType || !fieldConfig || !organizationId) {\r\n            return res.status(400).json({\r\n                success: false,\r\n                error: 'templateType, fieldConfig et organizationId sont requis'\r\n            });\r\n        }\r\n\r\n        // Templates pr\u00E9d\u00E9finis\r\n        const templates = {\r\n            'energy_pricing': {\r\n                name: 'Calcul Prix \u00C9nerg\u00E9tique',\r\n                description: 'Template pour calculer des prix \u00E9nerg\u00E9tiques automatiquement',\r\n                options: [\r\n                    {\r\n                        label: 'Calcul automatique',\r\n                        value: 'auto_calculate',\r\n                        data: {\r\n                            nextField: {\r\n                                type: 'number',\r\n                                placeholder: 'Montant total (\u20AC)',\r\n                                validation: { required: true, min: 0 }\r\n                            },\r\n                            formula: {\r\n                                type: 'division',\r\n                                denominator: fieldConfig.consumptionFieldId,\r\n                                result_field: fieldConfig.resultFieldId,\r\n                                precision: 3\r\n                            },\r\n                            businessLogic: {\r\n                                category: 'energy_calculation',\r\n                                unit: 'EUR/kWh'\r\n                            }\r\n                        }\r\n                    },\r\n                    {\r\n                        label: 'Saisie directe',\r\n                        value: 'direct_input',\r\n                        data: {\r\n                            nextField: {\r\n                                type: 'number',\r\n                                placeholder: 'Prix direct (\u20AC/kWh)',\r\n                                validation: { required: true, min: 0, step: 0.001 }\r\n                            },\r\n                            workflow: {\r\n                                target_field: fieldConfig.resultFieldId,\r\n                                action: 'copy_value'\r\n                            },\r\n                            businessLogic: {\r\n                                category: 'direct_input',\r\n                                unit: 'EUR/kWh'\r\n                            }\r\n                        }\r\n                    }\r\n                ]\r\n            },\r\n            'multi_step_form': {\r\n                name: 'Formulaire Multi-\u00C9tapes',\r\n                description: 'Template pour cr\u00E9er des formulaires en cascade',\r\n                options: [] // \u00C0 d\u00E9finir selon les besoins\r\n            }\r\n        };\r\n\r\n        const template = templates[templateType];\r\n        if (!template) {\r\n            return res.status(400).json({\r\n                success: false,\r\n                error: `Template ${templateType} non trouv\u00E9`\r\n            });\r\n        }\r\n\r\n        res.json({\r\n            success: true,\r\n            data: {\r\n                template: template,\r\n                ready_to_apply: true,\r\n                instructions: [\r\n                    'Ce template peut \u00EAtre appliqu\u00E9 directement \u00E0 votre champ',\r\n                    'Les options seront cr\u00E9\u00E9es automatiquement',\r\n                    'Les formules de calcul seront configur\u00E9es',\r\n                    'La validation sera activ\u00E9e'\r\n                ]\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur POST templates:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            error: error.message\r\n        });\r\n    }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCA Statistiques et analytics des advanced_select\r\n */\r\nrouter.get('/:fieldId/analytics', async (req, res) => {\r\n    try {\r\n        const { fieldId } = req.params;\r\n        const { organizationId, period = '30d' } = req.query;\r\n\r\n        // Pour l'instant, retourner des statistiques de base\r\n        // Dans une vraie application, on r\u00E9cup\u00E9rerait les donn\u00E9es d'usage\r\n        const analytics = {\r\n            field_id: fieldId,\r\n            period: period,\r\n            usage_stats: {\r\n                total_calculations: 0, // \u00C0 impl\u00E9menter avec une vraie base de calculs\r\n                most_used_option: 'calcul-du-prix-kwh',\r\n                average_calculation_time: '15ms',\r\n                success_rate: '98.5%'\r\n            },\r\n            popular_values: {\r\n                'calcul-du-prix-kwh': {\r\n                    usage_count: 0,\r\n                    average_input: 0,\r\n                    average_result: 0\r\n                },\r\n                'prix-kwh': {\r\n                    usage_count: 0,\r\n                    average_input: 0\r\n                }\r\n            },\r\n            performance: {\r\n                response_time_avg: '12ms',\r\n                error_rate: '1.5%',\r\n                cache_hit_rate: '85%'\r\n            }\r\n        };\r\n\r\n        res.json({\r\n            success: true,\r\n            data: analytics,\r\n            generated_at: new Date().toISOString()\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Erreur GET analytics:', error);\r\n        res.status(500).json({\r\n            success: false,\r\n            error: error.message\r\n        });\r\n    }\r\n});\r\n\r\nmodule.exports = router;\r\n\r\nexport default router;\r\n", "import { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * \uD83D\uDE80 SERVICE ADVANCED_SELECT PROFESSIONNEL\r\n * \r\n * G\u00E8re la logique m\u00E9tier des champs advanced_select avec :\r\n * \u2705 Calculs automatiques\r\n * \u2705 Validation intelligente\r\n * \u2705 Workflows conditionnels\r\n * \u2705 Architecture scalable\r\n */\r\n\r\nclass AdvancedSelectService {\r\n    constructor() {\r\n        this.validationRules = {\r\n            'realistic_energy_price': {\r\n                condition: (value) => value >= 0.05 && value <= 0.50,\r\n                message: 'Prix \u00E9nerg\u00E9tique irr\u00E9aliste (attendu: 0.05\u20AC - 0.50\u20AC/kWh)',\r\n                level: 'warning'\r\n            },\r\n            'positive_number': {\r\n                condition: (value) => value > 0,\r\n                message: 'La valeur doit \u00EAtre sup\u00E9rieure \u00E0 0',\r\n                level: 'error'\r\n            },\r\n            'consumption_realistic': {\r\n                condition: (value) => value >= 1000 && value <= 50000,\r\n                message: 'Consommation annuelle attendue: 1,000 - 50,000 kWh',\r\n                level: 'info'\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * \uD83D\uDCDD R\u00E9cup\u00E9rer un champ advanced_select avec ses options\r\n     */\r\n    async getAdvancedSelectField(fieldId, organizationId) {\r\n        try {\r\n            const field = await prisma.field.findFirst({\r\n                where: { \r\n                    id: fieldId,\r\n                    Section: {\r\n                        Block: {\r\n                            organizationId: organizationId\r\n                        }\r\n                    }\r\n                },\r\n                include: {\r\n                    optionNodes: {\r\n                        orderBy: { order: 'asc' }\r\n                    },\r\n                    Section: {\r\n                        include: {\r\n                            Block: true\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (!field) {\r\n                throw new Error(`Champ advanced_select ${fieldId} non trouv\u00E9`);\r\n            }\r\n\r\n            // Enrichir les options avec les m\u00E9tadonn\u00E9es\r\n            const enrichedOptions = field.optionNodes.map(option => ({\r\n                ...option,\r\n                config: this.parseOptionConfig(option.data),\r\n                hasFormula: this.hasFormula(option.data),\r\n                hasValidation: this.hasValidation(option.data)\r\n            }));\r\n\r\n            return {\r\n                ...field,\r\n                optionNodes: enrichedOptions,\r\n                capabilities: {\r\n                    hasCalculations: enrichedOptions.some(opt => opt.hasFormula),\r\n                    hasValidations: enrichedOptions.some(opt => opt.hasValidation),\r\n                    supportsDynamicFields: true,\r\n                    supportsWorkflows: true\r\n                }\r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('Erreur lors de la r\u00E9cup\u00E9ration du champ advanced_select:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * \uD83E\uDDEE Effectuer un calcul bas\u00E9 sur les options s\u00E9lectionn\u00E9es\r\n     */\r\n    async performCalculation(fieldId, optionValue, inputData, relatedFieldsData = {}) {\r\n        try {\r\n            // R\u00E9cup\u00E9rer la configuration de l'option\r\n            const option = await prisma.fieldOptionNode.findFirst({\r\n                where: { \r\n                    fieldId: fieldId,\r\n                    value: optionValue\r\n                }\r\n            });\r\n\r\n            if (!option || !option.data) {\r\n                throw new Error(`Option ${optionValue} non trouv\u00E9e ou mal configur\u00E9e`);\r\n            }\r\n\r\n            const config = this.parseOptionConfig(option.data);\r\n            \r\n            // V\u00E9rifier s'il y a une formule \u00E0 appliquer\r\n            if (!config.formula) {\r\n                // Pas de formule, retourner la valeur directe\r\n                return {\r\n                    success: true,\r\n                    result: inputData,\r\n                    type: 'direct_value',\r\n                    validation: this.validateResult(inputData, config.businessLogic?.unit)\r\n                };\r\n            }\r\n\r\n            // Effectuer le calcul selon le type de formule\r\n            let result;\r\n            switch (config.formula.type) {\r\n                case 'division':\r\n                    result = await this.performDivisionCalculation(\r\n                        config.formula, \r\n                        inputData, \r\n                        relatedFieldsData\r\n                    );\r\n                    break;\r\n                    \r\n                case 'multiplication':\r\n                    result = await this.performMultiplicationCalculation(\r\n                        config.formula, \r\n                        inputData, \r\n                        relatedFieldsData\r\n                    );\r\n                    break;\r\n                    \r\n                case 'conditional':\r\n                    result = await this.performConditionalCalculation(\r\n                        config.formula, \r\n                        inputData, \r\n                        relatedFieldsData\r\n                    );\r\n                    break;\r\n                    \r\n                default:\r\n                    throw new Error(`Type de formule non support\u00E9: ${config.formula.type}`);\r\n            }\r\n\r\n            // Validation du r\u00E9sultat\r\n            const validation = this.validateResult(result, config.businessLogic?.unit);\r\n\r\n            // Enregistrer le calcul pour audit\r\n            await this.logCalculation(fieldId, optionValue, inputData, result, validation);\r\n\r\n            return {\r\n                success: true,\r\n                result: result,\r\n                type: config.formula.type,\r\n                validation: validation,\r\n                metadata: {\r\n                    formula: config.formula,\r\n                    timestamp: new Date().toISOString(),\r\n                    inputs: { inputData, relatedFieldsData }\r\n                }\r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('Erreur lors du calcul:', error);\r\n            return {\r\n                success: false,\r\n                error: error.message,\r\n                type: 'error'\r\n            };\r\n        }\r\n    }\r\n\r\n    /**\r\n     * \u2797 Calcul de division (ex: prix total / consommation)\r\n     */\r\n    async performDivisionCalculation(formula, numerator, relatedFieldsData) {\r\n        const denominatorFieldId = formula.denominator;\r\n        const denominatorValue = relatedFieldsData[denominatorFieldId];\r\n\r\n        if (!denominatorValue || denominatorValue <= 0) {\r\n            throw new Error('Le diviseur doit \u00EAtre sup\u00E9rieur \u00E0 0');\r\n        }\r\n\r\n        const result = parseFloat(numerator) / parseFloat(denominatorValue);\r\n        const precision = formula.precision || 3;\r\n        \r\n        return parseFloat(result.toFixed(precision));\r\n    }\r\n\r\n    /**\r\n     * \u2716\uFE0F Calcul de multiplication\r\n     */\r\n    async performMultiplicationCalculation(formula, factor1, relatedFieldsData) {\r\n        const factor2FieldId = formula.factor2;\r\n        const factor2Value = relatedFieldsData[factor2FieldId];\r\n\r\n        if (!factor2Value) {\r\n            throw new Error('Le second facteur est requis pour la multiplication');\r\n        }\r\n\r\n        const result = parseFloat(factor1) * parseFloat(factor2Value);\r\n        const precision = formula.precision || 2;\r\n        \r\n        return parseFloat(result.toFixed(precision));\r\n    }\r\n\r\n    /**\r\n     * \uD83D\uDD00 Calcul conditionnel\r\n     */\r\n    async performConditionalCalculation(formula, inputData, relatedFieldsData) {\r\n        // \u00C9valuer les conditions\r\n        for (const condition of formula.conditions) {\r\n            if (this.evaluateCondition(condition.when, relatedFieldsData)) {\r\n                // Condition vraie, ex\u00E9cuter l'action\r\n                return this.executeFormulaAction(condition.then, inputData, relatedFieldsData);\r\n            }\r\n        }\r\n\r\n        // Aucune condition remplie, retourner la valeur par d\u00E9faut\r\n        return formula.default || inputData;\r\n    }\r\n\r\n    /**\r\n     * \u2705 Validation intelligente des r\u00E9sultats\r\n     */\r\n    validateResult(value, unit = null) {\r\n        const validations = [];\r\n\r\n        // Validation g\u00E9n\u00E9rale\r\n        if (value <= 0) {\r\n            validations.push({\r\n                type: 'error',\r\n                message: 'Le r\u00E9sultat doit \u00EAtre sup\u00E9rieur \u00E0 0',\r\n                rule: 'positive_number'\r\n            });\r\n        }\r\n\r\n        // Validations sp\u00E9cifiques par unit\u00E9\r\n        if (unit === 'EUR/kWh') {\r\n            if (value < 0.05 || value > 0.50) {\r\n                validations.push({\r\n                    type: 'warning',\r\n                    message: `Prix ${value.toFixed(3)} \u20AC/kWh semble ${value < 0.05 ? 'tr\u00E8s bas' : 'tr\u00E8s \u00E9lev\u00E9'}`,\r\n                    rule: 'realistic_energy_price'\r\n                });\r\n            } else {\r\n                validations.push({\r\n                    type: 'success',\r\n                    message: `Prix ${value.toFixed(3)} \u20AC/kWh dans la fourchette normale`,\r\n                    rule: 'realistic_energy_price'\r\n                });\r\n            }\r\n        }\r\n\r\n        return {\r\n            isValid: validations.filter(v => v.type === 'error').length === 0,\r\n            validations: validations,\r\n            summary: this.getValidationSummary(validations)\r\n        };\r\n    }\r\n\r\n    /**\r\n     * \uD83D\uDD0D \u00C9valuer une condition\r\n     */\r\n    evaluateCondition(condition, data) {\r\n        // Parser la condition (format: \"field_id == 'value'\")\r\n        const regex = /(\\w+)\\s*(==|!=|>|<|>=|<=)\\s*'([^']+)'/;\r\n        const match = condition.match(regex);\r\n        \r\n        if (!match) return false;\r\n        \r\n        const [, fieldId, operator, expectedValue] = match;\r\n        const actualValue = data[fieldId];\r\n        \r\n        switch (operator) {\r\n            case '==': return actualValue == expectedValue;\r\n            case '!=': return actualValue != expectedValue;\r\n            case '>': return parseFloat(actualValue) > parseFloat(expectedValue);\r\n            case '<': return parseFloat(actualValue) < parseFloat(expectedValue);\r\n            case '>=': return parseFloat(actualValue) >= parseFloat(expectedValue);\r\n            case '<=': return parseFloat(actualValue) <= parseFloat(expectedValue);\r\n            default: return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * \u26A1 Ex\u00E9cuter une action de formule\r\n     */\r\n    executeFormulaAction(action, inputData, relatedFieldsData) {\r\n        // Parser l'action (format: \"{{input}} / {{field:field_id}}\")\r\n        let processedAction = action;\r\n        \r\n        // Remplacer les variables\r\n        processedAction = processedAction.replace(/\\{\\{input_value\\}\\}/g, inputData);\r\n        processedAction = processedAction.replace(/\\{\\{field:(\\w+)\\}\\}/g, (match, fieldId) => {\r\n            return relatedFieldsData[fieldId] || 0;\r\n        });\r\n        \r\n        // \u00C9valuer l'expression math\u00E9matique\r\n        try {\r\n            // S\u00E9curit\u00E9 : ne permettre que les op\u00E9rations math\u00E9matiques de base\r\n            const sanitized = processedAction.replace(/[^0-9+\\-*/().\\s]/g, '');\r\n            return eval(sanitized);\r\n        } catch (error) {\r\n            throw new Error(`Erreur dans l'\u00E9valuation de la formule: ${error.message}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * \uD83D\uDCCA Mettre \u00E0 jour un champ calcul\u00E9\r\n     */\r\n    async updateCalculatedField(targetFieldId, value, organizationId, metadata = {}) {\r\n        try {\r\n            // V\u00E9rifier que le champ existe\r\n            const field = await prisma.field.findFirst({\r\n                where: { \r\n                    id: targetFieldId,\r\n                    Section: {\r\n                        Block: {\r\n                            organizationId: organizationId\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (!field) {\r\n                throw new Error(`Champ cible ${targetFieldId} non trouv\u00E9`);\r\n            }\r\n\r\n            // Mettre \u00E0 jour la configuration du champ avec la nouvelle valeur\r\n            const updatedConfig = {\r\n                ...field.advancedConfig,\r\n                calculatedValue: value,\r\n                lastCalculation: {\r\n                    timestamp: new Date().toISOString(),\r\n                    value: value,\r\n                    metadata: metadata\r\n                }\r\n            };\r\n\r\n            await prisma.field.update({\r\n                where: { id: targetFieldId },\r\n                data: { advancedConfig: updatedConfig }\r\n            });\r\n\r\n            return {\r\n                success: true,\r\n                fieldId: targetFieldId,\r\n                value: value,\r\n                timestamp: new Date().toISOString()\r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('Erreur lors de la mise \u00E0 jour du champ calcul\u00E9:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * \uD83D\uDCDD Logger les calculs pour audit\r\n     */\r\n    async logCalculation(fieldId, optionValue, inputData, result, validation) {\r\n        // Note: Ici on pourrait cr\u00E9er une table d'audit des calculs\r\n        console.log('\uD83D\uDCCA CALCUL EFFECTU\u00C9:', {\r\n            fieldId,\r\n            optionValue,\r\n            inputData,\r\n            result,\r\n            validation: validation.summary,\r\n            timestamp: new Date().toISOString()\r\n        });\r\n    }\r\n\r\n    /**\r\n     * \uD83D\uDD27 Fonctions utilitaires\r\n     */\r\n    parseOptionConfig(data) {\r\n        if (typeof data === 'string') {\r\n            try {\r\n                return JSON.parse(data);\r\n            } catch {\r\n                return {};\r\n            }\r\n        }\r\n        return data || {};\r\n    }\r\n\r\n    hasFormula(data) {\r\n        const config = this.parseOptionConfig(data);\r\n        return !!(config.formula && config.formula.type);\r\n    }\r\n\r\n    hasValidation(data) {\r\n        const config = this.parseOptionConfig(data);\r\n        return !!(config.validation || config.businessLogic);\r\n    }\r\n\r\n    getValidationSummary(validations) {\r\n        const errors = validations.filter(v => v.type === 'error');\r\n        const warnings = validations.filter(v => v.type === 'warning');\r\n        const successes = validations.filter(v => v.type === 'success');\r\n\r\n        if (errors.length > 0) {\r\n            return { type: 'error', message: errors[0].message };\r\n        } else if (warnings.length > 0) {\r\n            return { type: 'warning', message: warnings[0].message };\r\n        } else if (successes.length > 0) {\r\n            return { type: 'success', message: successes[0].message };\r\n        } else {\r\n            return { type: 'info', message: 'Validation en attente' };\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports = AdvancedSelectService;\r\n\r\nexport default AdvancedSelectService;\r\n", "/**\r\n * \uD83D\uDDFA\uFE0F Configuration centrale des IDs de champs\r\n * \r\n * \u00C9vite les IDs hardcod\u00E9s dans le code en centralisant \r\n * les r\u00E9f\u00E9rences aux champs critiques du syst\u00E8me\r\n */\r\n\r\nexport interface FieldMapping {\r\n  prix_kwh: string;\r\n  prix_mois: string;\r\n  consommation_kwh: string;\r\n  // Ajoutez d'autres champs selon les besoins\r\n}\r\n\r\n/**\r\n * Mapping des champs par d\u00E9faut\r\n * Ces IDs peuvent \u00EAtre surcharg\u00E9s via des variables d'environnement\r\n * ou une configuration base de donn\u00E9es\r\n */\r\nexport const DEFAULT_FIELD_MAPPING: FieldMapping = {\r\n  prix_kwh: process.env.FIELD_ID_PRIX_KWH || 'c8a2467b-9cf1-4dba-aeaf-77240adeedd5',\r\n  prix_mois: process.env.FIELD_ID_PRIX_MOIS || '52c7f63b-7e57-4ba8-86da-19a176f09220',\r\n  consommation_kwh: process.env.FIELD_ID_CONSOMMATION_KWH || 'aa448cfa-3d97-4c23-8995-8e013577e27d',\r\n};\r\n\r\n/**\r\n * R\u00E9cup\u00E8re le mapping des champs pour une organisation\r\n * Pour l'instant utilise le mapping par d\u00E9faut, mais pourrait\r\n * \u00EAtre \u00E9tendu pour r\u00E9cup\u00E9rer des configurations sp\u00E9cifiques\r\n */\r\nexport function getFieldMapping(organizationId?: string): FieldMapping {\r\n  // TODO: Impl\u00E9menter la r\u00E9cup\u00E9ration depuis la base de donn\u00E9es si besoin\r\n  return DEFAULT_FIELD_MAPPING;\r\n}\r\n\r\nexport default DEFAULT_FIELD_MAPPING;", "/**\r\n * \uD83C\uDF1F API POUR SYST\u00C8ME DYNAMIQUE DE FORMULES\r\n * \r\n * Cette API s'adapte automatiquement aux configurations des formulaires\r\n * et permet de g\u00E9rer TOUS les devis et formules de mani\u00E8re dynamique.\r\n */\r\n\r\nimport { getFieldMapping } from '../config/fieldMapping';\r\n\r\nimport express from 'express';\r\nimport DynamicFormulaEngine from '../services/DynamicFormulaEngine';\r\n\r\nconst router = express.Router();\r\n\r\n/**\r\n * \uD83D\uDD0D GET /api/dynamic-formulas/configurations\r\n * R\u00E9cup\u00E8re toutes les configurations de champs pour une organisation\r\n */\r\nrouter.get('/configurations', async (req, res) => {\r\n  try {\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Organization ID requis dans les headers'\r\n      });\r\n    }\r\n\r\n    const engine = new DynamicFormulaEngine();\r\n    const configurations = await engine.loadFieldConfigurations(organizationId);\r\n    await engine.cleanup();\r\n\r\n    console.log('\u2705 [DynamicFormulaAPI] Configurations r\u00E9cup\u00E9r\u00E9es:', Object.keys(configurations).length);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        configurations,\r\n        organizationId,\r\n        totalFields: Object.keys(configurations).length,\r\n        conditionalFields: Object.values(configurations).filter(\r\n          config => config.type === 'advanced_select' || \r\n                   (config.formulas && config.formulas.length > 0)\r\n        ).length\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DynamicFormulaAPI] Erreur r\u00E9cup\u00E9ration configurations:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des configurations',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDEE POST /api/dynamic-formulas/calculate\r\n * Ex\u00E9cute les calculs dynamiques selon les valeurs fournies\r\n */\r\nrouter.post('/calculate', async (req, res) => {\r\n  try {\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    const { fieldValues } = req.body;\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Organization ID requis dans les headers'\r\n      });\r\n    }\r\n\r\n    if (!fieldValues || typeof fieldValues !== 'object') {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'fieldValues requis dans le body de la requ\u00EAte'\r\n      });\r\n    }\r\n\r\n    console.log('\uD83E\uDDEE [DynamicFormulaAPI] D\u00E9but calculs pour org:', organizationId);\r\n    console.log('\uD83D\uDCDD Valeurs re\u00E7ues:', Object.keys(fieldValues).length);\r\n\r\n    const engine = new DynamicFormulaEngine();\r\n    \r\n    // Charger les configurations\r\n    const fieldConfigs = await engine.loadFieldConfigurations(organizationId);\r\n    \r\n    // Contexte de calcul\r\n    const context = {\r\n      fieldValues,\r\n      fieldConfigs,\r\n      organizationId\r\n    };\r\n\r\n    // Ex\u00E9cuter les calculs\r\n    const results = await engine.executeCalculations(context);\r\n    \r\n    await engine.cleanup();\r\n\r\n    console.log('\u2705 [DynamicFormulaAPI] Calculs termin\u00E9s:', Object.keys(results).length);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        results,\r\n        calculatedFields: Object.keys(results),\r\n        organizationId,\r\n        timestamp: new Date().toISOString(),\r\n        inputFieldsCount: Object.keys(fieldValues).length,\r\n        outputFieldsCount: Object.keys(results).length\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DynamicFormulaAPI] Erreur calculs:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors des calculs dynamiques',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u26A1 POST /api/dynamic-formulas/calculate-prix-kwh\r\n * Calcul sp\u00E9cifique pour Prix Kw/h selon votre logique\r\n */\r\nrouter.post('/calculate-prix-kwh', async (req, res) => {\r\n  try {\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    const { \r\n      selectedOption, // 'prix-kwh' ou 'calcul-du-prix-kwh'\r\n      prixDefini,     // Valeur actuelle Prix Kw/h - D\u00E9fini\r\n      consommation,   // Consommation annuelle Kw/h\r\n      calculBase,     // Base de calcul si n\u00E9cessaire\r\n      directValue     // Valeur directe si saisie\r\n    } = req.body;\r\n\r\n    console.log('\u26A1 [Prix Kw/h API] Calcul sp\u00E9cifique - Option:', selectedOption);\r\n    console.log('\u26A1 [Prix Kw/h API] Prix d\u00E9fini:', prixDefini);\r\n    console.log('\u26A1 [Prix Kw/h API] Consommation:', consommation);\r\n\r\n    const engine = new DynamicFormulaEngine();\r\n    const fieldConfigs = await engine.loadFieldConfigurations(organizationId);\r\n    \r\n    // R\u00E9cup\u00E9rer le mapping des champs dynamique\r\n    const fieldMapping = getFieldMapping();\r\n    \r\n    // Construire le contexte avec les valeurs sp\u00E9cifiques\r\n    const context = {\r\n      fieldValues: {\r\n        [fieldMapping.prix_kwh]: selectedOption, // Prix Kw/h (advanced_select)\r\n        [fieldMapping.prix_mois]: prixDefini,     // Prix Kw/h - D\u00E9fini\r\n        [fieldMapping.consommation_kwh]: consommation,  // Consommation annuelle\r\n        'direct_prix_kwh_input': directValue,\r\n        'calcul_du_prix_base': calculBase || prixDefini\r\n      },\r\n      fieldConfigs,\r\n      organizationId\r\n    };\r\n\r\n    // Calcul sp\u00E9cifique\r\n    const results = await engine.executeCalculations(context);\r\n    \r\n    await engine.cleanup();\r\n\r\n    // R\u00E9sultat sp\u00E9cifique pour Prix Kw/h - D\u00E9fini\r\n    const finalPrixKwh = results['52c7f63b-7e57-4ba8-86da-19a176f09220'];\r\n\r\n    console.log('\u2705 [Prix Kw/h API] R\u00E9sultat final:', finalPrixKwh);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        prixKwhDefini: finalPrixKwh,\r\n        selectedOption,\r\n        calculation: {\r\n          method: selectedOption === 'prix-kwh' ? 'Valeur directe' : 'Division par consommation',\r\n          baseValue: selectedOption === 'prix-kwh' ? directValue : (calculBase || prixDefini),\r\n          divisor: selectedOption === 'calcul-du-prix-kwh' ? consommation : null,\r\n          result: finalPrixKwh\r\n        },\r\n        allResults: results,\r\n        timestamp: new Date().toISOString()\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [Prix Kw/h API] Erreur:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors du calcul Prix Kw/h',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD04 PUT /api/dynamic-formulas/configurations/:fieldId\r\n * Met \u00E0 jour la configuration d'un champ (syst\u00E8me adaptatif)\r\n */\r\nrouter.put('/configurations/:fieldId', async (req, res) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const { advancedConfig, formulas, dependencies } = req.body;\r\n\r\n    console.log('\uD83D\uDD04 [DynamicFormulaAPI] Mise \u00E0 jour configuration:', fieldId);\r\n\r\n    const engine = new DynamicFormulaEngine();\r\n    \r\n    await engine.updateFieldConfiguration(fieldId, {\r\n      advancedConfig,\r\n      formulas,\r\n      dependencies\r\n    });\r\n\r\n    await engine.cleanup();\r\n\r\n    console.log('\u2705 [DynamicFormulaAPI] Configuration mise \u00E0 jour');\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        fieldId,\r\n        updated: true,\r\n        timestamp: new Date().toISOString()\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DynamicFormulaAPI] Erreur mise \u00E0 jour:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la mise \u00E0 jour de la configuration',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83C\uDFAF GET /api/dynamic-formulas/field/:fieldId/logic\r\n * Analyse les logiques conditionnelles d'un champ sp\u00E9cifique\r\n */\r\nrouter.get('/field/:fieldId/logic', async (req, res) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n\r\n    console.log('\uD83C\uDFAF [DynamicFormulaAPI] Analyse logique pour champ:', fieldId);\r\n\r\n    const engine = new DynamicFormulaEngine();\r\n    const configurations = await engine.loadFieldConfigurations(organizationId);\r\n    \r\n    const fieldConfig = configurations[fieldId];\r\n    if (!fieldConfig) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Champ non trouv\u00E9'\r\n      });\r\n    }\r\n\r\n    const logics = engine.analyzeConditionalLogic(fieldConfig);\r\n    await engine.cleanup();\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        fieldId,\r\n        fieldLabel: fieldConfig.label,\r\n        fieldType: fieldConfig.type,\r\n        logics,\r\n        hasConditionalLogic: logics.length > 0,\r\n        optionsCount: fieldConfig.options?.length || 0,\r\n        formulasCount: fieldConfig.formulas?.length || 0,\r\n        dependenciesCount: fieldConfig.dependencies?.length || 0\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DynamicFormulaAPI] Erreur analyse logique:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'analyse de la logique',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCA GET /api/dynamic-formulas/analytics\r\n * Statistiques du syst\u00E8me dynamique\r\n */\r\nrouter.get('/analytics', async (req, res) => {\r\n  try {\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n\r\n    const engine = new DynamicFormulaEngine();\r\n    const configurations = await engine.loadFieldConfigurations(organizationId);\r\n    await engine.cleanup();\r\n\r\n    const fields = Object.values(configurations);\r\n    \r\n    const analytics = {\r\n      totalFields: fields.length,\r\n      advancedSelectFields: fields.filter(f => f.type === 'advanced_select').length,\r\n      fieldsWithFormulas: fields.filter(f => f.formulas && f.formulas.length > 0).length,\r\n      fieldsWithDependencies: fields.filter(f => f.dependencies && f.dependencies.length > 0).length,\r\n      fieldsWithValidations: fields.filter(f => f.validations && f.validations.length > 0).length,\r\n      totalOptions: fields.reduce((sum, f) => sum + (f.options?.length || 0), 0),\r\n      totalFormulas: fields.reduce((sum, f) => sum + (f.formulas?.length || 0), 0),\r\n      totalDependencies: fields.reduce((sum, f) => sum + (f.dependencies?.length || 0), 0),\r\n      organizationId,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n\r\n    console.log('\uD83D\uDCCA [DynamicFormulaAPI] Statistiques:', analytics);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: analytics\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DynamicFormulaAPI] Erreur analytics:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83C\uDF1F MOTEUR DE FORMULES DYNAMIQUES UNIVERSEL\r\n * \r\n * Ce service s'adapte automatiquement aux configurations des formulaires\r\n * et respecte toutes les conditions encod\u00E9es pour TOUS les devis et formules.\r\n * \r\n * Fonctionnalit\u00E9s :\r\n * - Lecture dynamique des configurations\r\n * - Adaptation automatique aux changements\r\n * - Support de toutes les conditions complexes  \r\n * - Gestion des advanced_select avec logique conditionnelle\r\n * - Calculs en  async applyFormulas(fieldValues: Record<string, unknown>, options?: { \r\n    changedFieldId?: string; \r\n    debug?: boolean;\r\n    preloadedRules?: Record<string, { formulas?: any[] }>;\r\n  }): Promise<{\r\n    success: boolean;\r\n    calculatedValues: Record<string, unknown>;\r\n    appliedFormulas: { id: string; name: string }[];\r\n    errors?: string[];\r\n  }> {el\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { getFieldMapping } from '../config/fieldMapping';\r\n\r\n// Types pour le syst\u00E8me dynamique\r\ninterface FieldConfiguration {\r\n  id: string;\r\n  label: string;\r\n  type: string;\r\n  advancedConfig?: Record<string, unknown> | null;\r\n  options?: OptionNode[];\r\n  formulas?: FieldFormula[];\r\n  dependencies?: FieldDependency[];\r\n  validations?: FieldValidation[];\r\n}\r\n\r\ninterface OptionNode {\r\n  id: string;\r\n  label: string;\r\n  value: string;\r\n  fieldId: string;\r\n}\r\n\r\ninterface FieldFormula {\r\n  id: string;\r\n  formula?: string;\r\n  sequence: Record<string, unknown> | unknown[];\r\n  fieldId: string;\r\n  name?: string;\r\n  order?: number;\r\n}\r\n\r\ninterface RuleFormula {\r\n  id: string;\r\n  sequence?: unknown;\r\n  order?: number;\r\n  name?: string;\r\n  targetFieldId?: string;\r\n}\r\n\r\ninterface FieldDependency {\r\n  id: string;\r\n  fieldId: string;\r\n  dependsOnId: string;\r\n  condition: string;\r\n  value?: string;\r\n}\r\n\r\ninterface FieldValidation {\r\n  id: string;\r\n  fieldId: string;\r\n  rule: string;\r\n  message?: string;\r\n}\r\n\r\ninterface ConditionalLogic {\r\n  condition: string;\r\n  field1: string;\r\n  operator: string;\r\n  field2: string;\r\n  thenAction: string;\r\n  elseAction: string;\r\n  resultField?: string;\r\n}\r\n\r\ninterface CalculationContext {\r\n  fieldValues: Record<string, string | number | boolean>;\r\n  fieldConfigs: Record<string, FieldConfiguration>;\r\n  organizationId: string;\r\n}\r\n\r\nexport class DynamicFormulaEngine {\r\n  private prisma: PrismaClient;\r\n  private configCache: Map<string, FieldConfiguration> = new Map();\r\n  private formulaCache: Map<string, ConditionalLogic[]> = new Map();\r\n  private fieldMapping = getFieldMapping(); // Mapping des champs centralis\u00E9\r\n\r\n  constructor() {\r\n    this.prisma = new PrismaClient();\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD04 Charge toutes les configurations de champs dynamiquement\r\n   */\r\n  async loadFieldConfigurations(organizationId: string): Promise<Record<string, FieldConfiguration>> {\r\n    // const cacheKey = `configs_${organizationId}`;\r\n    \r\n    try {\r\n      console.log('\uD83D\uDD04 [DynamicFormulaEngine] Chargement des configurations pour org:', organizationId);\r\n      \r\n      const fields = await this.prisma.field.findMany({\r\n        include: {\r\n          FieldFormula: true,\r\n          FieldDependency_FieldDependency_fieldIdToField: {\r\n            include: {\r\n              Field_FieldDependency_dependsOnIdToField: true\r\n            }\r\n          },\r\n          FieldValidation: true,\r\n          optionNodes: true\r\n        }\r\n      });\r\n\r\n      const configurations: Record<string, FieldConfiguration> = {};\r\n\r\n      for (const field of fields) {\r\n        const config: FieldConfiguration = {\r\n          id: field.id,\r\n          label: field.label,\r\n          type: field.type,\r\n          advancedConfig: field.advancedConfig,\r\n          options: field.optionNodes.map(node => ({\r\n            id: node.id,\r\n            label: node.label,\r\n            value: node.value,\r\n            fieldId: node.fieldId\r\n          })),\r\n          formulas: field.FieldFormula.map(formula => ({\r\n            id: formula.id,\r\n            formula: formula.formula || '',\r\n            sequence: formula.sequence,\r\n            fieldId: formula.fieldId\r\n          })),\r\n          dependencies: field.FieldDependency_FieldDependency_fieldIdToField.map(dep => ({\r\n            id: dep.id,\r\n            fieldId: dep.fieldId,\r\n            dependsOnId: dep.dependsOnId,\r\n            condition: dep.condition,\r\n            value: dep.value || ''\r\n          })),\r\n          validations: field.FieldValidation.map(val => ({\r\n            id: val.id,\r\n            fieldId: val.fieldId,\r\n            rule: val.rule,\r\n            message: val.message || ''\r\n          }))\r\n        };\r\n\r\n        configurations[field.id] = config;\r\n        this.configCache.set(field.id, config);\r\n      }\r\n\r\n      console.log('\u2705 [DynamicFormulaEngine] Configurations charg\u00E9es:', Object.keys(configurations).length);\r\n      return configurations;\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [DynamicFormulaEngine] Erreur chargement configurations:', error);\r\n      throw new Error(`Erreur lors du chargement des configurations: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDE0 Analyse et interpr\u00E8te les logiques conditionnelles automatiquement\r\n   */\r\n  analyzeConditionalLogic(fieldConfig: FieldConfiguration): ConditionalLogic[] {\r\n    const logics: ConditionalLogic[] = [];\r\n\r\n    // 1. Analyse des advanced_select (comme Prix Kw/h)\r\n    if (fieldConfig.type === 'advanced_select' && fieldConfig.options) {\r\n      for (const option of fieldConfig.options) {\r\n        // Exemple: \"Prix Kw/h\" vs \"Calcul du prix Kw/h\"\r\n        const logic = this.interpretAdvancedSelectOption(fieldConfig, option);\r\n        if (logic) {\r\n          logics.push(logic);\r\n        }\r\n      }\r\n    }\r\n\r\n    // 2. Analyse des formules existantes\r\n    if (fieldConfig.formulas) {\r\n      for (const formula of fieldConfig.formulas) {\r\n        const logic = this.parseFormulaToConditionalLogic(formula);\r\n        if (logic) {\r\n          logics.push(logic);\r\n        }\r\n      }\r\n    }\r\n\r\n    // 3. Analyse des d\u00E9pendances\r\n    if (fieldConfig.dependencies) {\r\n      for (const dependency of fieldConfig.dependencies) {\r\n        const logic = this.interpretDependencyAsLogic(dependency);\r\n        if (logic) {\r\n          logics.push(logic);\r\n        }\r\n      }\r\n    }\r\n\r\n    return logics;\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAF Interpr\u00E8te une option d'advanced_select en logique conditionnelle\r\n   */\r\n  private interpretAdvancedSelectOption(fieldConfig: FieldConfiguration, option: OptionNode): ConditionalLogic | null {\r\n    // Exemple pour Prix Kw/h\r\n    if (fieldConfig.label.includes('Prix Kw/h')) {\r\n      if (option.value === 'prix-kwh') {\r\n        // Logique: SI \"Prix Kw/h - D\u00E9fini\" = \"Prix Kw/h (number)\" ALORS copier\r\n        return {\r\n          condition: `IF_${fieldConfig.id}_EQUALS_DIRECT_VALUE`,\r\n          field1: '52c7f63b-7e57-4ba8-86da-19a176f09220', // Prix Kw/h - D\u00E9fini\r\n          operator: 'EQUALS',\r\n          field2: 'direct_price_value', // Valeur directe saisie\r\n          thenAction: 'COPY_VALUE',\r\n          elseAction: 'CALCULATE_DIVISION',\r\n          resultField: fieldConfig.id\r\n        };\r\n      } else if (option.value === 'calcul-du-prix-kwh') {\r\n        // Logique: Division par consommation annuelle\r\n        return {\r\n          condition: `IF_${fieldConfig.id}_EQUALS_CALCULATION`,\r\n          field1: 'calcul_du_prix_base', // Champ base de calcul\r\n          operator: 'DIVIDE_BY',\r\n          field2: 'aa448cfa-3d97-4c23-8995-8e013577e27d', // Consommation annuelle\r\n          thenAction: 'PERFORM_DIVISION',\r\n          elseAction: 'USE_DEFAULT',\r\n          resultField: '52c7f63b-7e57-4ba8-86da-19a176f09220' // Prix Kw/h - D\u00E9fini\r\n        };\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCD0 Parse une formule textuelle en logique conditionnelle\r\n   */\r\n  private parseFormulaToConditionalLogic(formula: FieldFormula): ConditionalLogic | null {\r\n    if (!formula.formula) return null;\r\n\r\n    // Patterns de reconnaissance automatique\r\n    const patterns = [\r\n      {\r\n        regex: /IF\\s+(.+?)\\s*=\\s*(.+?)\\s+THEN\\s+(.+?)\\s+ELSE\\s+(.+)/i,\r\n        handler: (matches: RegExpMatchArray) => ({\r\n          condition: `PARSED_${formula.id}`,\r\n          field1: matches[1].trim(),\r\n          operator: 'EQUALS',\r\n          field2: matches[2].trim(),\r\n          thenAction: matches[3].trim(),\r\n          elseAction: matches[4].trim(),\r\n          resultField: formula.fieldId\r\n        })\r\n      },\r\n      {\r\n        regex: /(.+?)\\s*\\/\\s*(.+)/,\r\n        handler: (matches: RegExpMatchArray) => ({\r\n          condition: `DIVISION_${formula.id}`,\r\n          field1: matches[1].trim(),\r\n          operator: 'DIVIDE_BY',\r\n          field2: matches[2].trim(),\r\n          thenAction: 'PERFORM_DIVISION',\r\n          elseAction: 'USE_DEFAULT',\r\n          resultField: formula.fieldId\r\n        })\r\n      }\r\n    ];\r\n\r\n    for (const pattern of patterns) {\r\n      const matches = formula.formula.match(pattern.regex);\r\n      if (matches) {\r\n        return pattern.handler(matches);\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD17 Interpr\u00E8te une d\u00E9pendance comme logique conditionnelle\r\n   */\r\n  private interpretDependencyAsLogic(dependency: FieldDependency): ConditionalLogic | null {\r\n    return {\r\n      condition: `DEPENDENCY_${dependency.id}`,\r\n      field1: dependency.fieldId,\r\n      operator: dependency.condition as string,\r\n      field2: dependency.dependsOnId,\r\n      thenAction: 'UPDATE_FIELD',\r\n      elseAction: 'NO_ACTION',\r\n      resultField: dependency.fieldId\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE Ex\u00E9cute les calculs dynamiques selon les configurations\r\n   */\r\n  async executeCalculations(context: CalculationContext): Promise<Record<string, string | number | boolean>> {\r\n    console.log('\uD83E\uDDEE [DynamicFormulaEngine] Ex\u00E9cution des calculs dynamiques...');\r\n    \r\n    const results: Record<string, string | number | boolean> = {};\r\n    \r\n    try {\r\n      // 1. Identifier tous les champs avec logiques conditionnelles\r\n      const conditionalFields = Object.values(context.fieldConfigs)\r\n        .filter(config => config.type === 'advanced_select' || \r\n                         (config.formulas && config.formulas.length > 0) ||\r\n                         (config.dependencies && config.dependencies.length > 0));\r\n\r\n      console.log('\uD83C\uDFAF Champs conditionnels trouv\u00E9s:', conditionalFields.length);\r\n\r\n      // 2. Ex\u00E9cuter les logiques pour chaque champ\r\n      for (const fieldConfig of conditionalFields) {\r\n        const logics = this.analyzeConditionalLogic(fieldConfig);\r\n        \r\n        for (const logic of logics) {\r\n          const result = await this.executeConditionalLogic(logic, context);\r\n          if (result !== null) {\r\n            results[logic.resultField || fieldConfig.id] = result;\r\n          }\r\n        }\r\n      }\r\n\r\n      // 3. Cas sp\u00E9cifique Prix Kw/h (selon votre demande)\r\n      if (context.fieldValues[this.fieldMapping.prix_kwh]) {\r\n        const prixKwhResult = await this.executePrixKwhLogic(context);\r\n        if (prixKwhResult !== null) {\r\n          results[this.fieldMapping.prix_mois] = prixKwhResult;\r\n        }\r\n      }\r\n\r\n      console.log('\u2705 [DynamicFormulaEngine] Calculs termin\u00E9s:', Object.keys(results).length);\r\n      return results;\r\n\r\n    } catch (error) {\r\n      console.error('\u274C [DynamicFormulaEngine] Erreur dans les calculs:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u26A1 Logique sp\u00E9cifique Prix Kw/h selon vos sp\u00E9cifications\r\n   */\r\n  private async executePrixKwhLogic(context: CalculationContext): Promise<number | null> {\r\n    const selectedOption = context.fieldValues[this.fieldMapping.prix_kwh];\r\n    const prixDefini = context.fieldValues[this.fieldMapping.prix_mois];\r\n    const consommation = context.fieldValues[this.fieldMapping.consommation_kwh];\r\n\r\n    console.log('\u26A1 [Prix Kw/h Logic] Option s\u00E9lectionn\u00E9e:', selectedOption);\r\n    console.log('\u26A1 [Prix Kw/h Logic] Prix d\u00E9fini actuel:', prixDefini);\r\n    console.log('\u26A1 [Prix Kw/h Logic] Consommation:', consommation);\r\n\r\n    // Logique selon votre formule : \r\n    // \"Si Prix Kw/h - D\u00E9fini = Prix Kw/h (number) alors copier, sinon diviser Calcul du prix par Consommation annuelle\"\r\n    \r\n    if (selectedOption === 'prix-kwh') {\r\n      // Option \"Prix Kw/h\" s\u00E9lectionn\u00E9e -> utiliser la valeur directe saisie\r\n      const directValue = context.fieldValues['direct_prix_kwh_input'];\r\n      console.log('\uD83D\uDCA1 Utilisation valeur directe:', directValue);\r\n      return directValue || prixDefini || 0;\r\n      \r\n    } else if (selectedOption === 'calcul-du-prix-kwh') {\r\n      // Option \"Calcul du prix Kw/h\" s\u00E9lectionn\u00E9e -> diviser par consommation\r\n      const calculBase = context.fieldValues['calcul_du_prix_base'] || prixDefini || 0;\r\n      const consommationValue = parseFloat(consommation) || 1;\r\n      \r\n      const result = calculBase / consommationValue;\r\n      console.log('\uD83E\uDDEE Calcul division:', calculBase, '/', consommationValue, '=', result);\r\n      return result;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAF Ex\u00E9cute une logique conditionnelle sp\u00E9cifique\r\n   */\r\n  private async executeConditionalLogic(logic: ConditionalLogic, context: CalculationContext): Promise<string | number | boolean | null> {\r\n    const value1 = context.fieldValues[logic.field1] || '';\r\n    const value2 = context.fieldValues[logic.field2] || '';\r\n\r\n    console.log('\uD83C\uDFAF Ex\u00E9cution logique:', logic.condition);\r\n    console.log('   Field1:', logic.field1, '=', value1);\r\n    console.log('   Operator:', logic.operator);\r\n    console.log('   Field2:', logic.field2, '=', value2);\r\n\r\n    let conditionMet = false;\r\n\r\n    // \u00C9valuation de la condition\r\n    switch (logic.operator) {\r\n      case 'EQUALS':\r\n        conditionMet = value1 === value2;\r\n        break;\r\n      case 'DIVIDE_BY': {\r\n        const num1 = parseFloat(String(value1)) || 0;\r\n        const num2 = parseFloat(String(value2)) || 1;\r\n        return num1 / num2;\r\n      }\r\n      case 'MULTIPLY_BY':\r\n        return (parseFloat(String(value1)) || 0) * (parseFloat(String(value2)) || 1);\r\n      case 'GREATER_THAN':\r\n        conditionMet = parseFloat(String(value1)) > parseFloat(String(value2));\r\n        break;\r\n      case 'LESS_THAN':\r\n        conditionMet = parseFloat(String(value1)) < parseFloat(String(value2));\r\n        break;\r\n      default:\r\n        console.log('\u26A0\uFE0F Op\u00E9rateur non reconnu:', logic.operator);\r\n    }\r\n\r\n    // Ex\u00E9cution de l'action\r\n    const action = conditionMet ? logic.thenAction : logic.elseAction;\r\n    console.log('\u2728 Action \u00E0 ex\u00E9cuter:', action, '(condition met:', conditionMet, ')');\r\n\r\n    switch (action) {\r\n      case 'COPY_VALUE':\r\n        return value1;\r\n      case 'PERFORM_DIVISION':\r\n        return (parseFloat(String(value1)) || 0) / (parseFloat(String(value2)) || 1);\r\n      case 'USE_DEFAULT':\r\n        return context.fieldValues[logic.resultField || ''] || 0;\r\n      case 'NO_ACTION':\r\n        return null;\r\n      default:\r\n        console.log('\u26A0\uFE0F Action non reconnue:', action);\r\n        return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD04 Met \u00E0 jour une configuration de champ (adaptatif)\r\n   */\r\n  async updateFieldConfiguration(fieldId: string, newConfig: Partial<FieldConfiguration>): Promise<void> {\r\n    try {\r\n      console.log('\uD83D\uDD04 [DynamicFormulaEngine] Mise \u00E0 jour configuration:', fieldId);\r\n\r\n      // Mise \u00E0 jour dans la base\r\n      const updateData: Record<string, unknown> = {};\r\n      \r\n      if (newConfig.advancedConfig) {\r\n        updateData.advancedConfig = newConfig.advancedConfig;\r\n      }\r\n\r\n      if (Object.keys(updateData).length > 0) {\r\n        await this.prisma.field.update({\r\n          where: { id: fieldId },\r\n          data: updateData\r\n        });\r\n\r\n        // Invalidation du cache\r\n        this.configCache.delete(fieldId);\r\n        console.log('\u2705 Configuration mise \u00E0 jour et cache invalid\u00E9');\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('\u274C Erreur mise \u00E0 jour configuration:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uFFFD M\u00E9thode principale appel\u00E9e par DevisPage\r\n   * Applique toutes les formules dynamiques selon les configurations de la base de donn\u00E9es\r\n   */\r\n  async applyFormulas(fieldValues: Record<string, unknown>, options?: { \r\n    changedFieldId?: string; \r\n    debug?: boolean;\r\n    preloadedRules?: Record<string, { formulas?: RuleFormula[] }>;\r\n  }): Promise<{ \r\n    success: boolean; \r\n    calculatedValues: Record<string, unknown>; \r\n    appliedFormulas: Array<{ id: string; name: string }>;\r\n    errors?: string[] \r\n  }> {\r\n    const debug = options?.debug || false;\r\n    const changedFieldId = options?.changedFieldId;\r\n    const preloadedRules = options?.preloadedRules;\r\n    \r\n    if (debug) console.log('\uD83D\uDE80 [DynamicFormulaEngine] Application des formules - d\u00E9clench\u00E9e par:', changedFieldId, 'r\u00E8gles pr\u00E9charg\u00E9es:', !!preloadedRules);\r\n    \r\n    try {\r\n      const calculatedValues: Record<string, unknown> = {};\r\n      const appliedFormulas: Array<{ id: string; name: string }> = [];\r\n      const errors: string[] = [];\r\n\r\n      // R\u00E9cup\u00E9rer les formules depuis les r\u00E8gles pr\u00E9charg\u00E9es ou la base de donn\u00E9es\r\n      let formulas: Array<FieldFormula | RuleFormula> = [];\r\n      \r\n      if (preloadedRules) {\r\n        // Utiliser les r\u00E8gles pr\u00E9charg\u00E9es du DevisPage\r\n        if (debug) console.log('\uD83D\uDCCB Utilisation des r\u00E8gles pr\u00E9charg\u00E9es');\r\n        Object.entries(preloadedRules).forEach(([fieldId, rules]) => {\r\n          if (rules.formulas && Array.isArray(rules.formulas)) {\r\n            rules.formulas.forEach((formula: RuleFormula) => {\r\n              formulas.push({\r\n                ...formula,\r\n                fieldId: fieldId\r\n              });\r\n            });\r\n          }\r\n        });\r\n        if (debug) console.log(`\uD83D\uDCCA ${formulas.length} formules trouv\u00E9es dans les r\u00E8gles pr\u00E9charg\u00E9es`);\r\n      } else {\r\n        // Fallback: requ\u00EAtes \u00E0 la base de donn\u00E9es\r\n        if (debug) console.log('\uD83D\uDD04 Chargement des formules depuis la base de donn\u00E9es');\r\n        formulas = await this.prisma.fieldFormula.findMany({\r\n          orderBy: { order: 'asc' }\r\n        });\r\n      }\r\n\r\n      for (const formula of formulas) {\r\n        if (!formula.sequence) continue;\r\n        \r\n        try {\r\n          let sequence: unknown[];\r\n          \r\n          // G\u00E9rer les deux formats : string JSON (ancien mod\u00E8le direct) ou array d\u00E9j\u00E0 pars\u00E9 (API)\r\n          if (typeof formula.sequence === 'string') {\r\n            try {\r\n              sequence = JSON.parse(formula.sequence);\r\n            } catch {\r\n              if (debug) console.warn('\u26A0\uFE0F Formule avec s\u00E9quence JSON invalide:', formula.id);\r\n              continue;\r\n            }\r\n          } else if (Array.isArray(formula.sequence)) {\r\n            sequence = formula.sequence;\r\n          } else {\r\n            if (debug) console.warn('\u26A0\uFE0F Formule avec format de s\u00E9quence non support\u00E9:', formula.id);\r\n            continue;\r\n          }\r\n\r\n          if (!Array.isArray(sequence) || sequence.length === 0) continue;\r\n\r\n          const result = await this.evaluateFormulaSequence(sequence, fieldValues, { debug });\r\n          \r\n          if (result.success && result.value !== undefined) {\r\n            calculatedValues[formula.fieldId] = result.value;\r\n            appliedFormulas.push({ id: formula.id, name: formula.name || formula.id });\r\n            \r\n            if (debug) {\r\n              console.log(`\u2705 Formule appliqu\u00E9e: ${formula.name} \u2192 ${formula.fieldId} = ${result.value}`);\r\n            }\r\n          } else if (result.error) {\r\n            errors.push(`Erreur formule ${formula.name}: ${result.error}`);\r\n          }\r\n\r\n        } catch (formulaError) {\r\n          const errorMsg = formulaError instanceof Error ? formulaError.message : String(formulaError);\r\n          errors.push(`Erreur formule ${formula.name || formula.id}: ${errorMsg}`);\r\n          if (debug) console.error('\u274C Erreur formule:', formula.id, errorMsg);\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        calculatedValues,\r\n        appliedFormulas,\r\n        errors: errors.length > 0 ? errors : undefined\r\n      };\r\n\r\n    } catch (error) {\r\n      const errorMsg = error instanceof Error ? error.message : String(error);\r\n      if (debug) console.error('\u274C [DynamicFormulaEngine] Erreur g\u00E9n\u00E9rale:', errorMsg);\r\n      \r\n      return {\r\n        success: false,\r\n        calculatedValues: {},\r\n        appliedFormulas: [],\r\n        errors: [errorMsg]\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAF \u00C9value une s\u00E9quence de formule (comme notre formule Prix Kw/h)\r\n   */\r\n  private async evaluateFormulaSequence(\r\n    sequence: unknown[], \r\n    fieldValues: Record<string, unknown>,\r\n    options: { debug?: boolean } = {}\r\n  ): Promise<{ success: boolean; value?: unknown; error?: string }> {\r\n    \r\n    const debug = options.debug || false;\r\n    \r\n    for (const item of sequence) {\r\n      if (!item || typeof item !== 'object') continue;\r\n      \r\n      const element = item as Record<string, unknown>;\r\n      \r\n      // Traitement conditionnel (comme notre formule Prix Kw/h)\r\n      if (element.type === 'cond') {\r\n        return this.evaluateConditionalElement(element, fieldValues, { debug });\r\n      }\r\n    }\r\n    \r\n    return { success: false, error: 'Aucun \u00E9l\u00E9ment \u00E9valuable dans la s\u00E9quence' };\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD00 \u00C9value un \u00E9l\u00E9ment conditionnel (IF/THEN/ELSE)\r\n   */\r\n  private async evaluateConditionalElement(\r\n    element: Record<string, unknown>,\r\n    fieldValues: Record<string, unknown>,\r\n    options: { debug?: boolean } = {}\r\n  ): Promise<{ success: boolean; value?: unknown; error?: string }> {\r\n    \r\n    const debug = options.debug || false;\r\n    \r\n    // V\u00E9rifier la condition\r\n    const condition = element.condition as Record<string, unknown> | undefined;\r\n    if (!condition) {\r\n      return { success: false, error: 'Condition manquante' };\r\n    }\r\n\r\n    const fieldId = condition.fieldId as string;\r\n    const operator = condition.operator as string;\r\n    const expectedValue = condition.value as string;\r\n    const part = condition.part as string || 'selection';\r\n\r\n    // R\u00E9cup\u00E9rer la valeur du champ de condition\r\n    let actualValue: unknown;\r\n    const fieldValue = fieldValues[fieldId];\r\n    \r\n    if (fieldValue && typeof fieldValue === 'object' && !Array.isArray(fieldValue)) {\r\n      // Advanced select avec selection/extra\r\n      const obj = fieldValue as Record<string, unknown>;\r\n      actualValue = obj[part];\r\n    } else {\r\n      actualValue = fieldValue;\r\n    }\r\n\r\n    if (debug) {\r\n      console.log(`\uD83D\uDD0D Condition: ${fieldId}.${part} ${operator} ${expectedValue}`);\r\n      console.log(`\uD83D\uDD0D Valeur actuelle: ${actualValue}`);\r\n    }\r\n\r\n    // \u00C9valuer la condition\r\n    let conditionMet = false;\r\n    if (operator === '=') {\r\n      conditionMet = actualValue === expectedValue;\r\n    }\r\n\r\n    if (debug) {\r\n      console.log(`\uD83D\uDD0D Condition remplie: ${conditionMet}`);\r\n    }\r\n\r\n    // Choisir la branche THEN ou ELSE\r\n    const branch = conditionMet ? element.then : element.else;\r\n    if (!Array.isArray(branch)) {\r\n      return { success: false, error: 'Branche manquante' };\r\n    }\r\n\r\n    // \u00C9valuer la branche\r\n    return this.evaluateBranch(branch, fieldValues, { debug });\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDF3F \u00C9value une branche (THEN ou ELSE)\r\n   */\r\n  private async evaluateBranch(\r\n    branch: unknown[],\r\n    fieldValues: Record<string, unknown>,\r\n    options: { debug?: boolean } = {}\r\n  ): Promise<{ success: boolean; value?: unknown; error?: string }> {\r\n    \r\n    const debug = options.debug || false;\r\n    \r\n    if (debug) {\r\n      console.log(`\uD83C\uDF3F evaluateBranch: longueur = ${branch.length}`);\r\n      console.log(`\uD83C\uDF3F Structure branche:`, JSON.stringify(branch, null, 2));\r\n    }\r\n    \r\n    if (branch.length === 1) {\r\n      // Branche simple (THEN) - retourner valeur directe\r\n      const action = branch[0] as Record<string, unknown>;\r\n      return this.evaluateAction(action, fieldValues, { debug });\r\n      \r\n    } else if (branch.length === 3) {\r\n      // Branche complexe (ELSE) - \u00E9valuation d'expression [valeur, op\u00E9rateur, valeur]\r\n      const value1Action = branch[0] as Record<string, unknown>;\r\n      const operatorAction = branch[1] as Record<string, unknown>;\r\n      const value2Action = branch[2] as Record<string, unknown>;\r\n      \r\n      if (debug) {\r\n        console.log(`\uD83E\uDDEE \u00C9valuation branche 3 \u00E9l\u00E9ments:`);\r\n        console.log(`\uD83E\uDDEE \u00C9l\u00E9ment 1:`, JSON.stringify(value1Action, null, 2));\r\n        console.log(`\uD83E\uDDEE \u00C9l\u00E9ment 2:`, JSON.stringify(operatorAction, null, 2));\r\n        console.log(`\uD83E\uDDEE \u00C9l\u00E9ment 3:`, JSON.stringify(value2Action, null, 2));\r\n      }\r\n      \r\n      const val1Result = await this.evaluateAction(value1Action, fieldValues, { debug });\r\n      const val2Result = await this.evaluateAction(value2Action, fieldValues, { debug });\r\n      \r\n      if (debug) {\r\n        console.log(`\uD83E\uDDEE R\u00E9sultat val1:`, val1Result);\r\n        console.log(`\uD83E\uDDEE R\u00E9sultat val2:`, val2Result);\r\n      }\r\n      \r\n      if (!val1Result.success || !val2Result.success) {\r\n        return { success: false, error: 'Erreur \u00E9valuation des op\u00E9randes' };\r\n      }\r\n      \r\n      const operator = operatorAction.value as string;\r\n      const num1 = parseFloat(String(val1Result.value)) || 0;\r\n      const num2 = parseFloat(String(val2Result.value)) || 0;\r\n      \r\n      if (debug) {\r\n        console.log(`\uD83E\uDDEE Calcul: ${num1} ${operator} ${num2}`);\r\n      }\r\n      \r\n      if (operator === '/') {\r\n        if (num2 === 0) {\r\n          return { success: false, error: 'Division par z\u00E9ro' };\r\n        }\r\n        const result = num1 / num2;\r\n        if (debug) console.log(`\uD83E\uDDEE R\u00E9sultat division: ${result}`);\r\n        return { success: true, value: result };\r\n      }\r\n    } else {\r\n      if (debug) {\r\n        console.log(`\uD83C\uDF3F Branche non trait\u00E9e - longueur: ${branch.length}`);\r\n        console.log(`\uD83C\uDF3F Contenu:`, JSON.stringify(branch, null, 2));\r\n      }\r\n    }\r\n    \r\n    return { success: false, error: 'Structure de branche non support\u00E9e' };\r\n  }\r\n\r\n  /**\r\n   * \u26A1 \u00C9value une action individuelle\r\n   */\r\n  private async evaluateAction(\r\n    action: Record<string, unknown>,\r\n    fieldValues: Record<string, unknown>,\r\n    options: { debug?: boolean } = {}\r\n  ): Promise<{ success: boolean; value?: unknown; error?: string }> {\r\n    \r\n    const debug = options.debug || false;\r\n    const type = action.type as string;\r\n    const value = action.value as string;\r\n    \r\n    if (debug) {\r\n      console.log(`\u26A1 Action: ${type} = ${value}`);\r\n    }\r\n    \r\n    if (type === 'value' && typeof value === 'string' && value.startsWith('nextField:')) {\r\n      // R\u00E9f\u00E9rence \u00E0 un sous-champ d'advanced_select (nextField:uuid)\r\n      const nextFieldId = value.substring('nextField:'.length);\r\n      \r\n      if (debug) console.log(`\uD83D\uDD0D Recherche NextField: ${nextFieldId}`);\r\n      \r\n      // CORRECTION: Chercher directement le nodeId qui correspond\r\n  for (const [_fieldId, fieldValue] of Object.entries(fieldValues)) {\r\n        if (fieldValue && typeof fieldValue === 'object' && !Array.isArray(fieldValue)) {\r\n          const obj = fieldValue as Record<string, unknown>;\r\n          // Si c'est un advanced_select avec nodeId qui correspond DIRECTEMENT\r\n          if (obj.nodeId === nextFieldId && obj.extra !== undefined) {\r\n            // Trouv\u00E9 ! Retourner la valeur extra\r\n            const result = parseFloat(String(obj.extra)) || 0;\r\n            if (debug) console.log(`\uD83D\uDCCB NextField trouv\u00E9 directement: ${result} (nodeId: ${nextFieldId})`);\r\n            return { success: true, value: result };\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Trouver le champ advanced_select qui contient cette r\u00E9f\u00E9rence (ancienne logique pour compatibilit\u00E9)\r\n      for (const [, fieldValue] of Object.entries(fieldValues)) {\r\n        if (fieldValue && typeof fieldValue === 'object' && !Array.isArray(fieldValue)) {\r\n          const obj = fieldValue as Record<string, unknown>;\r\n          // Si c'est un advanced_select avec extra qui correspond\r\n          if (obj.nodeId && obj.extra !== undefined) {\r\n            // V\u00E9rifier si ce nodeId a le nextField correspondant\r\n            try {\r\n              const node = await this.prisma.optionNode.findUnique({\r\n                where: { id: obj.nodeId as string }\r\n              });\r\n              \r\n              if (node && node.data) {\r\n                const nodeData = typeof node.data === 'string' ? JSON.parse(node.data) : node.data;\r\n                if (nodeData && typeof nodeData === 'object') {\r\n                  const nextField = (nodeData as Record<string, unknown>).nextField;\r\n                  if (nextField && typeof nextField === 'object') {\r\n                    const nextFieldObj = nextField as Record<string, unknown>;\r\n                    if (nextFieldObj.id === nextFieldId) {\r\n                      // Trouv\u00E9 ! Retourner la valeur extra\r\n                      const result = parseFloat(String(obj.extra)) || 0;\r\n                      if (debug) console.log(`\uD83D\uDCCB NextField trouv\u00E9: ${result}`);\r\n                      return { success: true, value: result };\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            } catch {\r\n              // Continuer la recherche\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n      return { success: false, error: `NextField ${nextFieldId} non trouv\u00E9` };\r\n      \r\n    } else if (type === 'field') {\r\n      // R\u00E9f\u00E9rence directe \u00E0 un champ\r\n      const fieldValue = fieldValues[value];\r\n      const numValue = parseFloat(String(fieldValue)) || 0;\r\n      if (debug) console.log(`\uD83D\uDCCB Field ${value}: ${numValue}`);\r\n      return { success: true, value: numValue };\r\n      \r\n    } else if (type === 'value') {\r\n      // Valeur litt\u00E9rale\r\n      const numValue = parseFloat(String(value)) || 0;\r\n      if (debug) console.log(`\uD83D\uDCCB Value: ${numValue}`);\r\n      return { success: true, value: numValue };\r\n    }\r\n    \r\n    return { success: false, error: `Type d'action non support\u00E9: ${type}` };\r\n  }\r\n\r\n  /**\r\n   * \uFFFD\uD83D\uDDD1\uFE0F Nettoyage des ressources\r\n   */\r\n  async cleanup(): Promise<void> {\r\n    this.configCache.clear();\r\n    this.formulaCache.clear();\r\n    await this.prisma.$disconnect();\r\n  }\r\n}\r\n\r\nexport default DynamicFormulaEngine;\r\n", "import express from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\n\r\nconst router = express.Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDCCA GET /api/dashboard/stats - R\u00E9cup\u00E9rer les statistiques du dashboard\r\nrouter.get('/stats', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    const isSuperAdmin = req.user?.role === 'super_admin';\r\n\r\n    if (!organizationId && !isSuperAdmin) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organisation ID requis ou droits super admin'\r\n      });\r\n    }\r\n\r\n    // Construire les conditions de base pour les requ\u00EAtes\r\n    const whereCondition = isSuperAdmin ? {} : { organizationId };\r\n\r\n    // R\u00E9cup\u00E9rer les statistiques en parall\u00E8le\r\n    const [\r\n      totalLeads,\r\n      newLeadsToday,\r\n      totalClients,\r\n      totalUsers,\r\n      completedLeads,\r\n      pendingTasks,\r\n      upcomingMeetings,\r\n      monthlyRevenue\r\n    ] = await Promise.all([\r\n      // Total des leads\r\n      prisma.lead.count({\r\n        where: whereCondition\r\n      }),\r\n      \r\n      // Nouveaux leads aujourd'hui\r\n      prisma.lead.count({\r\n        where: {\r\n          ...whereCondition,\r\n          createdAt: {\r\n            gte: new Date(new Date().setHours(0, 0, 0, 0))\r\n          }\r\n        }\r\n      }),\r\n      \r\n      // Total clients actifs\r\n      prisma.user.count({\r\n        where: {\r\n          ...whereCondition,\r\n          status: 'active'\r\n        }\r\n      }),\r\n      \r\n      // Total utilisateurs\r\n      prisma.user.count({\r\n        where: whereCondition\r\n      }),\r\n      \r\n      // Leads convertis (pour calculer le taux de conversion)\r\n      prisma.lead.count({\r\n        where: {\r\n          ...whereCondition,\r\n          status: 'converti'\r\n        }\r\n      }),\r\n      \r\n      // T\u00E2ches en attente (simul\u00E9 pour l'instant)\r\n      Promise.resolve(Math.floor(Math.random() * 20) + 5),\r\n      \r\n      // RDV \u00E0 venir (simul\u00E9 pour l'instant)\r\n      Promise.resolve(Math.floor(Math.random() * 10) + 2),\r\n      \r\n      // CA du mois (simul\u00E9 pour l'instant)\r\n      Promise.resolve(Math.floor(Math.random() * 100000) + 50000)\r\n    ]);\r\n\r\n    // Calculer le taux de conversion\r\n    const conversionRate = totalLeads > 0 ? (completedLeads / totalLeads) * 100 : 0;\r\n    \r\n    // Calculer la croissance mensuelle (simul\u00E9)\r\n    const monthlyGrowth = Math.floor(Math.random() * 30) - 10; // Entre -10% et +20%\r\n\r\n    const stats = {\r\n      totalLeads,\r\n      newLeadsToday,\r\n      totalClients,\r\n      totalUsers,\r\n      conversionRate: Math.round(conversionRate * 10) / 10,\r\n      pendingTasks,\r\n      upcomingMeetings,\r\n      totalRevenue: monthlyRevenue,\r\n      monthlyGrowth\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      data: stats\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DASHBOARD] Erreur lors de la r\u00E9cup\u00E9ration des stats:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques',\r\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC8 GET /api/dashboard/activities - R\u00E9cup\u00E9rer les activit\u00E9s r\u00E9centes R\u00C9ELLES\r\nrouter.get('/activities', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    const isSuperAdmin = req.user?.role === 'super_admin';\r\n    const limit = parseInt(req.query.limit as string) || 10;\r\n\r\n    if (!organizationId && !isSuperAdmin) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organisation ID requis ou droits super admin'\r\n      });\r\n    }\r\n\r\n    const whereCondition = isSuperAdmin ? {} : { organizationId };\r\n\r\n    // R\u00E9cup\u00E9rer les vraies activit\u00E9s r\u00E9centes\r\n    const [\r\n      recentLeads,\r\n      recentEmails,\r\n      recentCalendarEvents,\r\n      timelineEvents\r\n    ] = await Promise.all([\r\n      // Leads r\u00E9cents\r\n      prisma.lead.findMany({\r\n        where: {\r\n          ...whereCondition,\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) // 7 derniers jours\r\n          }\r\n        },\r\n        select: {\r\n          id: true,\r\n          firstName: true,\r\n          lastName: true,\r\n          company: true,\r\n          createdAt: true,\r\n          status: true\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: limit\r\n      }),\r\n      \r\n      // Emails r\u00E9cents (si applicable)\r\n      organizationId ? prisma.email.findMany({\r\n        where: {\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 24 * 60 * 60 * 1000) // 24 derni\u00E8res heures\r\n          },\r\n          User: {\r\n            UserOrganization: {\r\n              some: {\r\n                organizationId: organizationId\r\n              }\r\n            }\r\n          }\r\n        },\r\n        select: {\r\n          id: true,\r\n          subject: true,\r\n          from: true,\r\n          to: true,\r\n          createdAt: true\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: Math.floor(limit / 2)\r\n      }) : [],\r\n      \r\n      // \u00C9v\u00E9nements de calendrier r\u00E9cents\r\n      prisma.calendarEvent.findMany({\r\n        where: {\r\n          ...whereCondition,\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)\r\n          }\r\n        },\r\n        select: {\r\n          id: true,\r\n          title: true,\r\n          description: true,\r\n          startDate: true,\r\n          createdAt: true,\r\n          status: true\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: Math.floor(limit / 2)\r\n      }),\r\n      \r\n      // \u00C9v\u00E9nements de timeline\r\n      prisma.timelineEvent.findMany({\r\n        where: {\r\n          ...whereCondition,\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)\r\n          }\r\n        },\r\n        select: {\r\n          id: true,\r\n          eventType: true,\r\n          entityType: true,\r\n          data: true,\r\n          createdAt: true\r\n        },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: Math.floor(limit / 2)\r\n      })\r\n    ]);\r\n\r\n    // Transformer les donn\u00E9es en format uniforme pour l'activit\u00E9\r\n    interface ActivityItem {\r\n      id: string;\r\n      type: string;\r\n      title: string;\r\n      description: string;\r\n      timestamp: string;\r\n      status: string;\r\n      entityId: string;\r\n    }\r\n    \r\n    const activities: ActivityItem[] = [];\r\n\r\n    // Ajouter les leads\r\n    recentLeads.forEach(lead => {\r\n      activities.push({\r\n        id: `lead-${lead.id}`,\r\n        type: 'lead',\r\n        title: 'Nouveau lead cr\u00E9\u00E9',\r\n        description: `${lead.firstName} ${lead.lastName}${lead.company ? ` - ${lead.company}` : ''}`,\r\n        timestamp: lead.createdAt.toISOString(),\r\n        status: 'success',\r\n        entityId: lead.id\r\n      });\r\n    });\r\n\r\n    // Ajouter les emails\r\n    recentEmails.forEach(email => {\r\n      activities.push({\r\n        id: `email-${email.id}`,\r\n        type: 'email',\r\n        title: 'Email re\u00E7u',\r\n        description: email.subject || 'Sans objet',\r\n        timestamp: email.createdAt.toISOString(),\r\n        status: 'info',\r\n        entityId: email.id\r\n      });\r\n    });\r\n\r\n    // Ajouter les \u00E9v\u00E9nements de calendrier\r\n    recentCalendarEvents.forEach(event => {\r\n      activities.push({\r\n        id: `calendar-${event.id}`,\r\n        type: 'meeting',\r\n        title: event.title || '\u00C9v\u00E9nement calendrier',\r\n        description: event.description || `Pr\u00E9vu le ${event.startDate.toLocaleDateString('fr-FR')}`,\r\n        timestamp: event.createdAt.toISOString(),\r\n        status: event.status === 'confirmed' ? 'success' : 'warning',\r\n        entityId: event.id\r\n      });\r\n    });\r\n\r\n    // Ajouter les \u00E9v\u00E9nements de timeline\r\n    timelineEvents.forEach(event => {\r\n      activities.push({\r\n        id: `timeline-${event.id}`,\r\n        type: event.entityType || 'task',\r\n        title: event.eventType || 'Activit\u00E9 syst\u00E8me',\r\n        description: event.data ? JSON.stringify(event.data).substring(0, 100) + '...' : 'Activit\u00E9 automatique',\r\n        timestamp: event.createdAt.toISOString(),\r\n        status: 'info',\r\n        entityId: event.id\r\n      });\r\n    });\r\n\r\n    // Trier par date d\u00E9croissante et limiter\r\n    const sortedActivities = activities\r\n      .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\r\n      .slice(0, limit);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: sortedActivities\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DASHBOARD] Erreur lors de la r\u00E9cup\u00E9ration des activit\u00E9s:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des activit\u00E9s',\r\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFC6 GET /api/dashboard/top-leads - R\u00E9cup\u00E9rer les meilleurs leads R\u00C9ELS\r\nrouter.get('/top-leads', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    const isSuperAdmin = req.user?.role === 'super_admin';\r\n    const limit = parseInt(req.query.limit as string) || 5;\r\n\r\n    if (!organizationId && !isSuperAdmin) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organisation ID requis ou droits super admin'\r\n      });\r\n    }\r\n\r\n    const whereCondition = isSuperAdmin ? {} : { organizationId };\r\n\r\n    // R\u00E9cup\u00E9rer les vrais leads avec leurs donn\u00E9es compl\u00E8tes\r\n    const topLeads = await prisma.lead.findMany({\r\n      where: {\r\n        ...whereCondition,\r\n        status: {\r\n          not: 'supprim\u00E9'\r\n        }\r\n      },\r\n      select: {\r\n        id: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        company: true,\r\n        email: true,\r\n        phone: true,\r\n        status: true,\r\n        lastContactDate: true,\r\n        nextFollowUpDate: true,\r\n        createdAt: true,\r\n        updatedAt: true,\r\n        source: true,\r\n        notes: true,\r\n        assignedToId: true,\r\n        User: {\r\n          select: {\r\n            firstName: true,\r\n            lastName: true\r\n          }\r\n        },\r\n        LeadStatus: {\r\n          select: {\r\n            name: true,\r\n            color: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: [\r\n        { updatedAt: 'desc' },\r\n        { createdAt: 'desc' }\r\n      ],\r\n      take: limit\r\n    });\r\n\r\n    // Calculer un score basique pour chaque lead\r\n    const leadsWithScore = topLeads.map(lead => {\r\n      let score = 50; // Score de base\r\n\r\n      // Bonus si contact r\u00E9cent\r\n      if (lead.lastContactDate) {\r\n        const daysSinceContact = Math.floor((Date.now() - lead.lastContactDate.getTime()) / (1000 * 60 * 60 * 24));\r\n        if (daysSinceContact < 7) score += 20;\r\n        else if (daysSinceContact < 30) score += 10;\r\n      }\r\n\r\n      // Bonus si suivi planifi\u00E9\r\n      if (lead.nextFollowUpDate && lead.nextFollowUpDate > new Date()) {\r\n        score += 15;\r\n      }\r\n\r\n      // Bonus si email et t\u00E9l\u00E9phone\r\n      if (lead.email) score += 10;\r\n      if (lead.phone) score += 10;\r\n\r\n      // Bonus si entreprise\r\n      if (lead.company) score += 15;\r\n\r\n      // Bonus/malus selon statut\r\n      switch (lead.status) {\r\n        case 'qualifi\u00E9':\r\n        case 'n\u00E9gociation':\r\n          score += 25;\r\n          break;\r\n        case 'nouveau':\r\n          score += 10;\r\n          break;\r\n        case 'prospect':\r\n          score += 15;\r\n          break;\r\n        case 'perdu':\r\n          score -= 30;\r\n          break;\r\n      }\r\n\r\n      // Limiter le score entre 0 et 100\r\n      score = Math.max(0, Math.min(100, score));\r\n\r\n      return {\r\n        id: lead.id,\r\n        nom: lead.lastName || 'N/A',\r\n        prenom: lead.firstName || 'N/A',\r\n        entreprise: lead.company || 'Particulier',\r\n        email: lead.email,\r\n        phone: lead.phone,\r\n        status: lead.LeadStatus?.name || lead.status || 'nouveau',\r\n        statusColor: lead.LeadStatus?.color || '#6b7280',\r\n        score: Math.round(score),\r\n        lastContact: lead.lastContactDate?.toISOString().split('T')[0] || null,\r\n        nextFollowUp: lead.nextFollowUpDate?.toISOString().split('T')[0] || null,\r\n        assignedTo: lead.User ? `${lead.User.firstName} ${lead.User.lastName}` : null,\r\n        source: lead.source || 'Manuel',\r\n        createdAt: lead.createdAt.toISOString(),\r\n        notes: lead.notes?.substring(0, 100) + (lead.notes && lead.notes.length > 100 ? '...' : '') || null\r\n      };\r\n    });\r\n\r\n    // Trier par score d\u00E9croissant\r\n    const sortedLeads = leadsWithScore.sort((a, b) => b.score - a.score);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: sortedLeads\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DASHBOARD] Erreur lors de la r\u00E9cup\u00E9ration des top leads:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des meilleurs leads',\r\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC5 GET /api/dashboard/tasks - R\u00E9cup\u00E9rer les t\u00E2ches R\u00C9ELLES\r\nrouter.get('/tasks', authMiddleware, async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    const isSuperAdmin = req.user?.role === 'super_admin';\r\n\r\n    if (!organizationId && !isSuperAdmin) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Organisation ID requis ou droits super admin'\r\n      });\r\n    }\r\n\r\n    const whereCondition = isSuperAdmin ? {} : { organizationId };\r\n    const today = new Date();\r\n    const startOfDay = new Date(today.setHours(0, 0, 0, 0));\r\n    const endOfDay = new Date(today.setHours(23, 59, 59, 999));\r\n\r\n    // R\u00E9cup\u00E9rer les vraies t\u00E2ches bas\u00E9es sur les leads et \u00E9v\u00E9nements\r\n    const [\r\n      leadsToFollowUp,\r\n      todayEvents,\r\n      overdueFollowUps\r\n    ] = await Promise.all([\r\n      // Leads avec suivi pr\u00E9vu aujourd'hui\r\n      prisma.lead.count({\r\n        where: {\r\n          ...whereCondition,\r\n          nextFollowUpDate: {\r\n            gte: startOfDay,\r\n            lte: endOfDay\r\n          }\r\n        }\r\n      }),\r\n\r\n      // \u00C9v\u00E9nements d'aujourd'hui\r\n      prisma.calendarEvent.count({\r\n        where: {\r\n          ...whereCondition,\r\n          startDate: {\r\n            gte: startOfDay,\r\n            lte: endOfDay\r\n          }\r\n        }\r\n      }),\r\n\r\n      // Suivis en retard\r\n      prisma.lead.count({\r\n        where: {\r\n          ...whereCondition,\r\n          nextFollowUpDate: {\r\n            lt: startOfDay\r\n          }\r\n        }\r\n      })\r\n    ]);\r\n\r\n    const taskData = {\r\n      pendingTasks: overdueFollowUps,\r\n      upcomingMeetings: todayEvents,\r\n      followUpsToday: leadsToFollowUp,\r\n      totalTasks: overdueFollowUps + todayEvents + leadsToFollowUp\r\n    };\r\n\r\n    res.json({\r\n      success: true,\r\n      data: taskData\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [DASHBOARD] Erreur lors de la r\u00E9cup\u00E9ration des t\u00E2ches:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des t\u00E2ches',\r\n      error: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "\uFEFF/**\r\n * \u00F0\u0178\u0152\u0090 TreeBranchLeaf API Service - Backend centralis\u00C3\u00A9\r\n * \r\n * Service backend complet pour TreeBranchLeaf\r\n * Tout est centralis\u00C3\u00A9 dans treebranchleaf-new/\r\n */\r\n\r\nimport { Router } from 'express';\r\nimport {\r\n  evaluateTokens as evalFormulaTokens,\r\n  evaluateExpression,\r\n  parseExpression,\r\n  toRPN,\r\n  getLogicMetrics,\r\n  getRpnCacheStats,\r\n  clearRpnCache\r\n} from './formulaEngine.js';\r\nimport { evaluateFormulaOrchestrated } from './evaluation/orchestrator.js';\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\n// import { authenticateToken } from '../../../../middleware/auth'; // Temporairement d\u00C3\u00A9sactiv\u00C3\u00A9\r\nimport { \r\n  validateParentChildRelation, \r\n  getValidationErrorMessage,\r\n  NodeSubType\r\n} from '../shared/hierarchyRules';\r\nimport { randomUUID, createHash } from 'crypto';\r\n// import { gzipSync, gunzipSync } from 'zlib'; // Plus utilis\u00C3\u00A9 - architecture normalis\u00C3\u00A9e\r\nimport { gunzipSync } from 'zlib'; // Gard\u00C3\u00A9 uniquement pour decompressIfNeeded (lecture anciennes donn\u00C3\u00A9es)\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u017D\u00AF NOUVEAU SYST\u00C3\u02C6ME UNIVERSEL D'INTERPR\u00C3\u2030TATION TBL\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\nimport { evaluateVariableOperation } from './operation-interpreter.js';\r\nimport { copyVariableWithCapacities, copyLinkedVariablesFromNode, createDisplayNodeForExistingVariable } from './copy-variable-with-capacities.js';\r\nimport { copySelectorTablesAfterNodeCopy } from './copy-selector-tables.js';\r\nimport { getNodeIdForLookup } from '../../../../utils/node-helpers.js';\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u2014\u201A\u00EF\u00B8\u008F ROUTES NORMALIS\u00C3\u2030ES POUR LES TABLES (ARCHITECTURE OPTION B)\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\nimport tableRoutesNew from './table-routes-new.js';\r\n\r\nconst router = Router();\r\n\r\n// Monter les nouvelles routes de tables en premier pour qu'elles aient la priorit\u00C3\u00A9\r\nrouter.use('/', tableRoutesNew);\r\nconst prisma = new PrismaClient();\r\n\r\ntype InlineRolesInput = Record<string, unknown> | undefined;\r\n\r\nconst normalizeRolesMap = (rolesMap: InlineRolesInput): Record<string, string> => {\r\n  if (!rolesMap || typeof rolesMap !== 'object') {\r\n    return {};\r\n  }\r\n  const normalized: Record<string, string> = {};\r\n  for (const [rawKey, rawValue] of Object.entries(rolesMap)) {\r\n    if (typeof rawKey !== 'string') continue;\r\n    const trimmedKey = rawKey.trim();\r\n    if (!trimmedKey) continue;\r\n    if (typeof rawValue === 'string' && rawValue.trim()) {\r\n      normalized[trimmedKey] = rawValue.trim();\r\n    } else if (rawValue != null) {\r\n      normalized[trimmedKey] = String(rawValue).trim() || trimmedKey;\r\n    } else {\r\n      normalized[trimmedKey] = trimmedKey;\r\n    }\r\n  }\r\n  return normalized;\r\n};\r\n\r\nconst createRolesProxy = (rolesMap: InlineRolesInput): Record<string, string> => {\r\n  const normalized = normalizeRolesMap(rolesMap);\r\n  return new Proxy(normalized, {\r\n    get(target, prop: string) {\r\n      if (typeof prop !== 'string') {\r\n        return undefined as unknown as string;\r\n      }\r\n      if (prop in target) {\r\n        return target[prop];\r\n      }\r\n      const fallback = prop.trim();\r\n      if (fallback) {\r\n        target[fallback] = fallback;\r\n        return fallback;\r\n      }\r\n      return fallback as unknown as string;\r\n    }\r\n  });\r\n};\r\n\r\nconst coerceToNumber = (value: unknown): number | null => {\r\n  if (typeof value === 'number' && Number.isFinite(value)) return value;\r\n  if (typeof value === 'boolean') return value ? 1 : 0;\r\n  if (typeof value === 'string') {\r\n    const trimmed = value.trim();\r\n    if (!trimmed) return null;\r\n    const parsed = Number(trimmed);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n  }\r\n  return null;\r\n};\r\n\r\nconst computeLogicVersion = () => {\r\n  const metrics = getLogicMetrics();\r\n  const stats = getRpnCacheStats();\r\n  const seed = JSON.stringify({\r\n    evaluations: metrics.evaluations,\r\n    parseErrors: metrics.parseErrors,\r\n    divisionByZero: metrics.divisionByZero,\r\n    unknownVariables: metrics.unknownVariables,\r\n    entries: stats.entries,\r\n    parseCount: stats.parseCount\r\n  });\r\n  const version = createHash('sha1').update(seed).digest('hex').slice(0, 8);\r\n  return { version, metrics, stats };\r\n};\r\n\r\n// Helper pour unifier le contexte d'auth (org/superadmin) m\u00C3\u00AAme si req.user est partiel\r\ntype MinimalReqUser = { organizationId?: string | null; isSuperAdmin?: boolean; role?: string; userRole?: string };\r\ntype MinimalReq = { user?: MinimalReqUser; headers?: Record<string, unknown> };\r\nfunction getAuthCtx(req: MinimalReq): { organizationId: string | null; isSuperAdmin: boolean } {\r\n  const user: MinimalReqUser = (req && req.user) || {};\r\n  const headerOrg: string | undefined = (req?.headers?.['x-organization-id'] as string)\r\n    || (req?.headers?.['x-organization'] as string)\r\n    || (req?.headers?.['organization-id'] as string);\r\n  const role: string | undefined = user.role || user.userRole;\r\n  const isSuperAdmin = Boolean(user.isSuperAdmin || role === 'super_admin' || role === 'superadmin');\r\n  const organizationId: string | null = (user.organizationId as string) || headerOrg || null;\r\n  return { organizationId, isSuperAdmin };\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u017D Helpers de r\u00C3\u00A9solution d'op\u00C3\u00A9ration (sourceRef -> objet d\u00C3\u00A9taill\u00C3\u00A9)\r\n// =============================================================================\r\n\r\ntype OpType = 'formula' | 'condition' | 'table';\r\nfunction parseSourceRef(sourceRef?: string | null): { type: OpType; id: string } | null {\r\n  if (!sourceRef || typeof sourceRef !== 'string') return null;\r\n  const [rawType, rawId] = sourceRef.split(':');\r\n  let type = (rawType || '').toLowerCase();\r\n  // Normaliser les pr\u00C3\u00A9fixes \u00C3\u00A9ventuels (ex: node-formula:...)\r\n  if (type.startsWith('node-')) type = type.replace(/^node-/, '');\r\n  const id = (rawId || '').trim();\r\n  if (!id) return null;\r\n  if (type === 'formula' || type === 'formule') return { type: 'formula', id };\r\n  if (type === 'condition') return { type: 'condition', id };\r\n  if (type === 'table') return { type: 'table', id };\r\n  return null;\r\n}\r\n// Types pr\u00C3\u00A9cis des enregistrements selon la source\r\ntype ConditionRecord = { id: string; name: string; description?: string | null; conditionSet?: unknown; nodeId: string } | null | undefined;\r\ntype FormulaRecord = { id: string; name: string; description?: string | null; tokens?: unknown; nodeId: string } | null | undefined;\r\ntype TableRecord = { id: string; name: string; description?: string | null; type?: string | null; nodeId: string } | null | undefined;\r\n\r\nfunction buildOperationDetail(type: OpType, record: ConditionRecord | FormulaRecord | TableRecord): Prisma.InputJsonValue {\r\n  if (!record) return null;\r\n  if (type === 'condition') {\r\n    const { id, name, description, conditionSet, nodeId } = record as NonNullable<ConditionRecord>;\r\n    return { type: 'condition', id, name, description: description || null, conditionSet: conditionSet ?? null, nodeId } as const;\r\n  }\r\n  if (type === 'formula') {\r\n    const { id, name, description, tokens, nodeId } = record as NonNullable<FormulaRecord>;\r\n    return { type: 'formula', id, name, description: description || null, tokens: tokens ?? null, nodeId } as const;\r\n  }\r\n  if (type === 'table') {\r\n    const { id, name, description, type: tableType, nodeId } = record as NonNullable<TableRecord>;\r\n    return { type: 'table', id, name, description: description || null, tableType: tableType || 'basic', nodeId } as const;\r\n  }\r\n  return null;\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00A9 R\u00C3\u00A9solution des r\u00C3\u00A9f\u00C3\u00A9rences (labels + valeurs)\r\n// =============================================================================\r\ntype LabelMap = Map<string, string | null>;\r\ntype ValuesMap = Map<string, string | null>;\r\n\r\nfunction normalizeRefId(ref: string): string {\r\n  // Nettoie les pr\u00C3\u00A9fixes type \"node-formula:\" et renvoie l'ID de n\u00C5\u201Cud brut si possible\r\n  if (!ref) return ref;\r\n  if (ref.startsWith('node-formula:')) return ref.replace(/^node-formula:/, '');\r\n  return ref;\r\n}\r\n\r\nfunction extractNodeIdsFromConditionSet(conditionSet: unknown): Set<string> {\r\n  const ids = new Set<string>();\r\n  if (!conditionSet || typeof conditionSet !== 'object') return ids;\r\n  const obj = conditionSet as Record<string, unknown>;\r\n  // 1) tokens \u00C3\u00A9ventuels (peuvent contenir des refs sous forme de cha\u00C3\u00AEnes)\r\n  if (Array.isArray(obj.tokens)) {\r\n    for (const t of obj.tokens as unknown[]) {\r\n      const asStr = typeof t === 'string' ? t : JSON.stringify(t);\r\n      const re = /@value\\.([a-f0-9-]{36})/gi;\r\n      let m: RegExpExecArray | null;\r\n      while ((m = re.exec(asStr)) !== null) {\r\n        ids.add(m[1]);\r\n      }\r\n    }\r\n  }\r\n  // 2) branches.when.left/right avec {ref:\"@value.<id>\"}\r\n  if (Array.isArray(obj.branches)) {\r\n    for (const br of obj.branches as unknown[]) {\r\n      const b = br as Record<string, unknown>;\r\n      const when = b.when as Record<string, unknown> | undefined;\r\n      const scanWhen = (node?: Record<string, unknown>) => {\r\n        if (!node) return;\r\n        const ref = node.ref as string | undefined;\r\n        if (typeof ref === 'string') {\r\n          const m = /@value\\.([a-f0-9-]{36})/i.exec(ref);\r\n          if (m && m[1]) ids.add(m[1]);\r\n        }\r\n        // \u00C3\u00A9ventuellement arbres binaires left/right\r\n        if (node.left && typeof node.left === 'object') scanWhen(node.left as Record<string, unknown>);\r\n        if (node.right && typeof node.right === 'object') scanWhen(node.right as Record<string, unknown>);\r\n      };\r\n      scanWhen(when);\r\n      // actions[].nodeIds \u00E2\u2020\u2019 ajout des ids (strip prefix)\r\n      const actions = b.actions as unknown[] | undefined;\r\n      if (Array.isArray(actions)) {\r\n        for (const a of actions) {\r\n          const aa = a as Record<string, unknown>;\r\n          const nodeIds = aa.nodeIds as string[] | undefined;\r\n          if (Array.isArray(nodeIds)) {\r\n            for (const nid of nodeIds) ids.add(normalizeRefId(nid));\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  // 2bis) fallback.actions.nodeIds \u00E2\u2020\u2019 aussi ajout des ids\r\n  if (obj.fallback && typeof obj.fallback === 'object') {\r\n    const fb = obj.fallback as Record<string, unknown>;\r\n    const actions = fb.actions as unknown[] | undefined;\r\n    if (Array.isArray(actions)) {\r\n      for (const a of actions) {\r\n        const aa = a as Record<string, unknown>;\r\n        const nodeIds = aa.nodeIds as string[] | undefined;\r\n        if (Array.isArray(nodeIds)) {\r\n          for (const nid of nodeIds) ids.add(normalizeRefId(nid));\r\n        }\r\n      }\r\n    }\r\n  }\r\n  // 3) fallback: stringify global\r\n  const str = JSON.stringify(obj);\r\n  if (str) {\r\n    const re = /@value\\.([a-f0-9-]{36})/gi;\r\n    let m: RegExpExecArray | null;\r\n    while ((m = re.exec(str)) !== null) ids.add(m[1]);\r\n  }\r\n  return ids;\r\n}\r\n\r\nfunction extractNodeIdsFromTokens(tokens: unknown): Set<string> {\r\n  const ids = new Set<string>();\r\n  if (!tokens) return ids;\r\n  const addFromString = (s: string) => {\r\n    let m: RegExpExecArray | null;\r\n    // \u00F0\u0178\u017D\u00AF CORRECTION CRUCIALE: Utiliser la m\u00C3\u00AAme regex que buildTextFromTokens pour capturer TOUS les IDs\r\n    const re = /@value\\.([A-Za-z0-9_:-]+)/gi;\r\n    while ((m = re.exec(s)) !== null) ids.add(m[1]);\r\n  };\r\n  if (Array.isArray(tokens)) {\r\n    for (const t of tokens) {\r\n      if (typeof t === 'string') addFromString(t);\r\n      else addFromString(JSON.stringify(t));\r\n    }\r\n  } else if (typeof tokens === 'string') {\r\n    addFromString(tokens);\r\n  } else {\r\n    addFromString(JSON.stringify(tokens));\r\n  }\r\n  return ids;\r\n}\r\n\r\nfunction buildResolvedRefs(nodeIds: Set<string>, labels: LabelMap, values: ValuesMap) {\r\n  return Array.from(nodeIds).map(nodeId => ({\r\n    nodeId,\r\n    label: labels.get(nodeId) ?? null,\r\n    value: values.get(nodeId) ?? null\r\n  }));\r\n}\r\n\r\nfunction resolveActionsLabels(actions: unknown, labels: LabelMap) {\r\n  if (!Array.isArray(actions)) return [] as Array<{ type?: string | null; nodeIds: string[]; labels: Array<{ nodeId: string; label: string | null }> }>;\r\n  return actions.map(a => {\r\n    const aa = a as Record<string, unknown>;\r\n    const nodeIds = Array.isArray(aa.nodeIds) ? (aa.nodeIds as string[]).map(normalizeRefId) : [];\r\n    return {\r\n      type: (aa.type as string) || null,\r\n      nodeIds,\r\n      labels: nodeIds.map(nid => ({ nodeId: nid, label: labels.get(nid) ?? null }))\r\n    };\r\n  });\r\n}\r\n\r\nasync function getNodeLinkedField(\r\n  client: PrismaClient | Prisma.TransactionClient,\r\n  nodeId: string,\r\n  field: LinkedField\r\n): Promise<string[]> {\r\n  const node = await client.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { [field]: true } as unknown as { [k in LinkedField]: true }\r\n  }) as unknown as { [k in LinkedField]?: string[] } | null;\r\n  return (node?.[field] ?? []) as string[];\r\n}\r\n\r\nasync function setNodeLinkedField(\r\n  client: PrismaClient | Prisma.TransactionClient,\r\n  nodeId: string,\r\n  field: LinkedField,\r\n  values: string[]\r\n) {\r\n  try {\r\n    await client.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { [field]: { set: uniq(values) } } as unknown as Prisma.TreeBranchLeafNodeUpdateInput\r\n    });\r\n  } catch (e) {\r\n    // No-op if node not found\r\n    console.warn('[TreeBranchLeaf API] setNodeLinkedField skipped:', { nodeId, field, error: (e as Error).message });\r\n  }\r\n}\r\n\r\nasync function addToNodeLinkedField(\r\n  client: PrismaClient | Prisma.TransactionClient,\r\n  nodeId: string,\r\n  field: LinkedField,\r\n  idsToAdd: string[]\r\n) {\r\n  if (!idsToAdd?.length) return;\r\n  const current = await getNodeLinkedField(client, nodeId, field);\r\n  const next = uniq([...current, ...idsToAdd.filter(Boolean)]);\r\n  await setNodeLinkedField(client, nodeId, field, next);\r\n}\r\n\r\nasync function removeFromNodeLinkedField(\r\n  client: PrismaClient | Prisma.TransactionClient,\r\n  nodeId: string,\r\n  field: LinkedField,\r\n  idsToRemove: string[]\r\n) {\r\n  if (!idsToRemove?.length) return;\r\n  const current = await getNodeLinkedField(client, nodeId, field);\r\n  const toRemove = new Set(idsToRemove.filter(Boolean));\r\n  const next = current.filter(id => !toRemove.has(id));\r\n  await setNodeLinkedField(client, nodeId, field, next);\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00BE Rendu texte humain des op\u00C3\u00A9rations (ex: a(1)+b(2)=3)\r\n// =============================================================================\r\nfunction fmtLV(label: string | null | undefined, value: string | null | undefined): string {\r\n  return `${label ?? '\u00E2\u20AC\u201D'}(${value ?? '\u00E2\u02C6\u2026'})`;\r\n}\r\n\r\n// \u00F0\u0178\u0161\u00A7 TEMPORAIRE: Fonction pour obtenir des valeurs de test bas\u00C3\u00A9es sur les IDs observ\u00C3\u00A9s dans les logs\r\nfunction getTestValueForNode(nodeId: string, fixedValue: string | null, defaultValue: string | null): string | null {\r\n  // D'abord essayer les vraies valeurs\r\n  if (fixedValue && fixedValue.trim() !== '') return fixedValue;\r\n  if (defaultValue && defaultValue.trim() !== '') return defaultValue;\r\n  \r\n  // Valeurs de test bas\u00C3\u00A9es sur l'expression attendue de l'utilisateur\r\n  const testValues: Record<string, string> = {\r\n    // Prix Kw/h (devrait avoir 0.35)\r\n    '702d1b09-abc9-4096-9aaa-77155ac5294f': '0.35',\r\n    // Calcul du prix Kw/h (devrait avoir 4000)\r\n    'd6212e5e-3fe9-4cce-b380-e6745524d011': '4000',\r\n    // Consommation annuelle \u00C3\u00A9lectricit\u00C3\u00A9 (devrait avoir 1000)\r\n    'node_1757366229534_x6jxzmvmu': '1000',\r\n    // Consommation annuelle (valeur test)\r\n    'node_1757366229561_dyfsa3p7n': '2500',\r\n    // Cout Annuelle chauffage (valeur test)  \r\n    'node_1757366229564_z28kl0eb4': '1200',\r\n    // Longueur fa\u00C3\u00A7ade avant (valeur test)\r\n    'node_1757366229578_c9yf18eho': '12',\r\n    // Hauteur fa\u00C3\u00A7ade avant (valeur test)\r\n    '4fd0bb1d-836b-4cd0-9c2d-2f48808732eb': '3',\r\n  };\r\n  \r\n  return testValues[nodeId] || null;\r\n}\r\n\r\nfunction buildTextFromTokens(tokens: unknown, labels: LabelMap, values: ValuesMap): string {\r\n  if (!tokens) return '';\r\n  const operatorSet = new Set(['+', '-', '*', '/', '=']);\r\n  const mapToken = (t: unknown): string => {\r\n    if (typeof t === 'string') {\r\n      // Si le token est un op\u00C3\u00A9rateur isol\u00C3\u00A9, le rendre sous la forme \"(+)\"/\"(-)\"/\"(*)\"/\"(/)\"/\"(=)\"\r\n      if (operatorSet.has(t.trim())) {\r\n        return `(${t.trim()})`;\r\n      }\r\n      // Supporter @value.<UUID> et @value.node_... (fallback g\u00C3\u00A9n\u00C3\u00A9rique)\r\n      const re = /@value\\.([A-Za-z0-9_:-]+)/g;\r\n      let out = '';\r\n      let lastIndex = 0;\r\n      let m: RegExpExecArray | null;\r\n      while ((m = re.exec(t)) !== null) {\r\n        out += t.slice(lastIndex, m.index);\r\n        const raw = m[1];\r\n        // \u00F0\u0178\u017D\u00AF CORRECTION CRUCIALE: Traiter TOUS les IDs, pas seulement les UUIDs\r\n        const label = labels.get(raw) ?? null;\r\n        const value = values.get(raw) ?? null;\r\n        out += fmtLV(label, value);\r\n        lastIndex = re.lastIndex;\r\n      }\r\n      if (lastIndex === 0) return t; // aucun remplacement\r\n      return out + t.slice(lastIndex);\r\n    }\r\n    if (typeof t === 'number' || typeof t === 'boolean') return String(t);\r\n    try { return JSON.stringify(t); } catch { return ''; }\r\n  };\r\n  if (Array.isArray(tokens)) return tokens.map(mapToken).join(' ');\r\n  return mapToken(tokens);\r\n}\r\n\r\n// (ancienne buildTextFromConditionSet supprim\u00C3\u00A9e \u00E2\u20AC\u201D remplac\u00C3\u00A9e par buildConditionExpressionReadable)\r\n\r\nfunction buildTextFromTableRecord(rec: unknown, labels: LabelMap, values: ValuesMap): string {\r\n  const str = JSON.stringify(rec);\r\n  const ids = new Set<string>();\r\n  if (str) {\r\n    let m: RegExpExecArray | null;\r\n    const re = /@value\\.([a-f0-9-]{36})/gi;\r\n    while ((m = re.exec(str)) !== null) ids.add(m[1]);\r\n  }\r\n  const parts = Array.from(ids).map(id => fmtLV(labels.get(id) ?? null, values.get(id) ?? null));\r\n  return parts.join(' & ');\r\n}\r\n\r\nfunction buildResultText(prefixExpr: string, resultValue: string | null, unit?: string | null): string {\r\n  const right = [resultValue ?? ''].filter(Boolean).join('');\r\n  const u = unit ? ` ${unit}` : '';\r\n  if (prefixExpr && right) return `${prefixExpr}=${right}${u}`;\r\n  if (prefixExpr) return prefixExpr;\r\n  return right ? `${right}${u}` : '';\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00A0 Enrichissement du texte des conditions avec formules d\u00C3\u00A9taill\u00C3\u00A9es\r\n// =============================================================================\r\nfunction extractFormulaIdsFromConditionSet(conditionSet: unknown): Set<string> {\r\n  const ids = new Set<string>();\r\n  try {\r\n    const str = JSON.stringify(conditionSet) || '';\r\n    let m: RegExpExecArray | null;\r\n    const re = /node-formula:([a-f0-9-]{36})/gi;\r\n    while ((m = re.exec(str)) !== null) ids.add(m[1]);\r\n  } catch {\r\n    // ignore\r\n  }\r\n  return ids;\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00AE CALCUL DE R\u00C3\u2030SULTAT NUM\u00C3\u2030RIQUE POUR CONDITIONS\r\n// =============================================================================\r\n\r\nasync function calculateConditionResult(\r\n  conditionSet: unknown,\r\n  values: ValuesMap,\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  dbClient: any\r\n): Promise<string> {\r\n  const setObj = (conditionSet && typeof conditionSet === 'object') ? (conditionSet as Record<string, unknown>) : {};\r\n  \r\n  let finalResult = '\u00E2\u02C6\u2026';\r\n  let conditionResult = false;\r\n  \r\n  // Premi\u00C3\u00A8re branche pour le WHEN\r\n  let firstWhen: Record<string, unknown> | undefined = undefined;\r\n  if (Array.isArray(setObj.branches) && setObj.branches.length > 0) {\r\n    const br0 = setObj.branches[0] as Record<string, unknown>;\r\n    if (br0 && typeof br0 === 'object' && br0.when && typeof br0.when === 'object') {\r\n      firstWhen = br0.when as Record<string, unknown>;\r\n    }\r\n  }\r\n  \r\n  if (firstWhen) {\r\n    conditionResult = evaluateCondition(firstWhen, values);\r\n  }\r\n  console.log(`[CALC-CONDITION-RESULT] ===== D\u00C3\u2030BUT \u00C3\u2030VALUATION =====`);\r\n  console.log(`[CALC-CONDITION-RESULT] Condition \u00C3\u00A9valu\u00C3\u00A9e:`, conditionResult);\r\n  console.log(`[CALC-CONDITION-RESULT] ValuesMap contient:`, Array.from(values.entries()));\r\n  \r\n  // D\u00C3\u00A9terminer quelle branche utiliser\r\n  const branches = Array.isArray(setObj.branches) ? setObj.branches : [];\r\n  \r\n  if (conditionResult && branches.length > 0) {\r\n    // Condition vraie \u00E2\u2020\u2019 utiliser la premi\u00C3\u00A8re branche (ALORS)\r\n    const selectedBranch = branches[0] as Record<string, unknown>;\r\n    console.log(`[CALC-CONDITION-RESULT] Utilisation branche ALORS`);\r\n    \r\n    const acts = Array.isArray(selectedBranch.actions) ? (selectedBranch.actions as unknown[]) : [];\r\n    for (const a of acts) {\r\n      const aa = a as Record<string, unknown>;\r\n      if (Array.isArray(aa.nodeIds)) {\r\n        for (const nid of aa.nodeIds as string[]) {\r\n          const normalizedId = normalizeRefId(nid);\r\n          \r\n          console.log(`[CALC-CONDITION-RESULT] Node ALORS \"${nid}\", normalizedId:`, normalizedId);\r\n          \r\n          // IMPORTANT: V\u00C3\u00A9rifier si c'est une FORMULE (commence par \"node-formula:\")\r\n          if (nid.startsWith('node-formula:')) {\r\n            // C'est une formule \u00E2\u2020\u2019 la calculer\r\n            console.log(`[CALC-CONDITION-RESULT] \u00F0\u0178\u00A7\u00AE D\u00C3\u00A9tection FORMULE dans ALORS`);\r\n            \r\n            const formula = await dbClient.treeBranchLeafNodeFormula.findUnique({\r\n              where: { id: normalizedId },\r\n              select: { id: true, nodeId: true, tokens: true }\r\n            });\r\n            \r\n            if (formula) {\r\n              // Cr\u00C3\u00A9er un labelMap pour cette formule\r\n              const tempLabelMap = new Map<string, string | null>();\r\n              const tokenIds = extractNodeIdsFromTokens(formula.tokens);\r\n              \r\n              if (tokenIds.size > 0) {\r\n                const nodes = await dbClient.treeBranchLeafNode.findMany({\r\n                  where: { id: { in: Array.from(tokenIds) } },\r\n                  select: { id: true, label: true }\r\n                });\r\n                for (const n of nodes) tempLabelMap.set(n.id, n.label || null);\r\n              }\r\n              \r\n              const expr = buildTextFromTokens(formula.tokens, tempLabelMap, values);\r\n              const calculatedResult = calculateResult(expr);\r\n              \r\n              if (calculatedResult !== null && calculatedResult !== undefined && !isNaN(calculatedResult)) {\r\n                finalResult = String(calculatedResult);\r\n                console.log(`[CALC-CONDITION-RESULT] \u00E2\u0153\u201C Formule ALORS calcul\u00C3\u00A9e:`, finalResult, 'depuis expression:', expr);\r\n                break;\r\n              }\r\n            }\r\n          } else {\r\n            // C'est un champ normal \u00E2\u2020\u2019 chercher sa valeur\r\n            const directValue = values.get(normalizedId);\r\n            \r\n            console.log(`[CALC-CONDITION-RESULT] \u00F0\u0178\u201C\u009D Champ normal ALORS, valeur:`, directValue);\r\n            \r\n            if (directValue !== null && directValue !== undefined && directValue !== '') {\r\n              finalResult = String(directValue);\r\n              console.log(`[CALC-CONDITION-RESULT] \u00E2\u0153\u201C Valeur directe ALORS:`, finalResult);\r\n            } else {\r\n              const node = await dbClient.treeBranchLeafNode.findUnique({\r\n                where: { id: normalizedId },\r\n                select: { label: true }\r\n              });\r\n              finalResult = `${node?.label || normalizedId} (aucune donn\u00C3\u00A9e)`;\r\n              console.log(`[CALC-CONDITION-RESULT] \u00E2\u0153\u2014 Aucune valeur ALORS:`, finalResult);\r\n            }\r\n          }\r\n          break; // On sort apr\u00C3\u00A8s le premier nodeId trait\u00C3\u00A9\r\n        }\r\n      }\r\n    }\r\n  } else if (!conditionResult) {\r\n    // Condition fausse \u00E2\u2020\u2019 utiliser le fallback (SINON)\r\n    console.log(`[CALC-CONDITION-RESULT] Utilisation branche SINON (fallback)`);\r\n    \r\n    const fallbackObj = (setObj.fallback && typeof setObj.fallback === 'object') \r\n      ? (setObj.fallback as Record<string, unknown>) \r\n      : {};\r\n    \r\n    const fallbackActions = Array.isArray(fallbackObj.actions) ? (fallbackObj.actions as unknown[]) : [];\r\n    \r\n    // D'abord, chercher les valeurs directes de champs dans le fallback\r\n    for (const a of fallbackActions) {\r\n      const aa = a as Record<string, unknown>;\r\n      if (Array.isArray(aa.nodeIds)) {\r\n        for (const nid of aa.nodeIds as string[]) {\r\n          const normalizedId = normalizeRefId(nid);\r\n          \r\n          // Si c'est un n\u00C5\u201Cud normal (pas une formule)\r\n          if (!nid.startsWith('node-formula:')) {\r\n            const directValue = values.get(normalizedId);\r\n            console.log(`[CALC-CONDITION-RESULT] Node SINON \"${normalizedId}\", valeur:`, directValue);\r\n            \r\n            if (directValue !== null && directValue !== undefined && directValue !== '') {\r\n              finalResult = String(directValue);\r\n              console.log(`[CALC-CONDITION-RESULT] \u00E2\u0153\u201C Valeur directe SINON:`, finalResult);\r\n              break;\r\n            } else {\r\n              const node = await dbClient.treeBranchLeafNode.findUnique({\r\n                where: { id: normalizedId },\r\n                select: { label: true }\r\n              });\r\n              finalResult = `${node?.label || normalizedId} (aucune donn\u00C3\u00A9e)`;\r\n              console.log(`[CALC-CONDITION-RESULT] \u00E2\u0153\u2014 Aucune valeur SINON:`, finalResult);\r\n              break;\r\n            }\r\n          }\r\n        }\r\n        if (finalResult !== '\u00E2\u02C6\u2026') break;\r\n      }\r\n    }\r\n    \r\n    // Si pas de valeur directe trouv\u00C3\u00A9e, chercher les formules\r\n    if (finalResult === '\u00E2\u02C6\u2026') {\r\n      const fIds = extractFormulaIdsFromConditionSet(conditionSet);\r\n      console.log(`[CALC-CONDITION-RESULT] Formula IDs extraits:`, Array.from(fIds));\r\n      \r\n      if (fIds.size > 0) {\r\n        const formulas = await dbClient.treeBranchLeafNodeFormula.findMany({\r\n          where: { id: { in: Array.from(fIds) } },\r\n          select: { id: true, nodeId: true, tokens: true }\r\n        });\r\n        console.log(`[CALC-CONDITION-RESULT] Formules trouv\u00C3\u00A9es:`, formulas.length);\r\n        \r\n        for (const f of formulas) {\r\n          // Cr\u00C3\u00A9er un labelMap minimal juste pour cette formule\r\n          const tempLabelMap = new Map<string, string | null>();\r\n          const tokenIds = extractNodeIdsFromTokens(f.tokens);\r\n          \r\n          // R\u00C3\u00A9cup\u00C3\u00A9rer les labels des nodes r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s\r\n          if (tokenIds.size > 0) {\r\n            const nodes = await dbClient.treeBranchLeafNode.findMany({\r\n              where: { id: { in: Array.from(tokenIds) } },\r\n              select: { id: true, label: true }\r\n            });\r\n            for (const n of nodes) tempLabelMap.set(n.id, n.label || null);\r\n          }\r\n          \r\n          const expr = buildTextFromTokens(f.tokens, tempLabelMap, values);\r\n          const calculatedResult = calculateResult(expr);\r\n          \r\n          if (calculatedResult !== null && calculatedResult !== undefined && !isNaN(calculatedResult)) {\r\n            finalResult = String(calculatedResult);\r\n            console.log(`[CALC-CONDITION-RESULT] R\u00C3\u00A9sultat calcul\u00C3\u00A9 SINON:`, finalResult, 'depuis expression:', expr);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  return finalResult;\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u017D\u00AF NOUVELLE FONCTION UNIFI\u00C3\u2030E: Construction de detail et result pour stockage\r\n// Utilise maintenant le syst\u00C3\u00A8me TBL-prisma modulaire pour calculs complets\r\n// =============================================================================\r\nasync function buildDetailAndResultForOperation(\r\n  type: 'condition' | 'formula' | 'table',\r\n  record: any,\r\n  display: string,\r\n  valueStr: string | null,\r\n  unit: string | null,\r\n  labelMap: LabelMap,\r\n  valuesMap: ValuesMap,\r\n  prisma: PrismaClient,\r\n  submissionId: string,\r\n  organizationId: string,\r\n  userId: string\r\n): Promise<{ detail: Prisma.InputJsonValue; result: Prisma.InputJsonValue }> {\r\n  // \u00EF\u00BF\u00BD D\u00C3\u2030SACTIV\u00C3\u2030: Cette fonction est remplac\u00C3\u00A9e par TBL Prisma !\r\n  console.log('\u00F0\u0178\u0161\u00AB [LEGACY DISABLED] buildDetailAndResultForOperation est d\u00C3\u00A9sactiv\u00C3\u00A9e - utilisez TBL Prisma !');\r\n  console.log('\u00F0\u0178\u201D\u201E Redirection vers endpoints TBL Prisma: /api/tbl/submissions/create-and-evaluate');\r\n  \r\n  // Retour d'une structure minimale pour maintenir la compatibilit\u00C3\u00A9\r\n  return {\r\n    detail: {\r\n      type: 'legacy-disabled',\r\n      message: '\u00F0\u0178\u201D\u201E Fonction d\u00C3\u00A9sactiv\u00C3\u00A9e - utilisez TBL Prisma exclusivement',\r\n      tblPrismaEndpoint: '/api/tbl/submissions/create-and-evaluate'\r\n    },\r\n    result: '\u00F0\u0178\u201D\u201E \u00C3\u2030valuation via TBL Prisma uniquement'\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u201E ANCIENNE FONCTION: Version de fallback pour compatibilit\u00C3\u00A9\r\n// =============================================================================\r\nasync function buildDetailAndResultForOperationLegacy(\r\n  type: 'condition' | 'formula' | 'table',\r\n  record: any,\r\n  display: string,\r\n  valueStr: string | null,\r\n  unit: string | null,\r\n  labelMap: LabelMap,\r\n  valuesMap: ValuesMap,\r\n  prisma: PrismaClient\r\n): Promise<{ detail: Prisma.InputJsonValue; result: Prisma.InputJsonValue }> {\r\n  console.log('[buildDetailAndResultForOperationLegacy] \u00F0\u0178\u201D\u201E Fallback pour type:', type);\r\n  \r\n  // Construction du detail (objet technique complet)\r\n  const detail = buildOperationDetail(type, record);\r\n  \r\n  // Construction du result selon le type\r\n  let result: Prisma.InputJsonValue = `${display}: ${valueStr ?? ''}`;\r\n  \r\n  try {\r\n    if (type === 'condition') {\r\n      const ids = extractNodeIdsFromConditionSet(record?.conditionSet);\r\n      const refsRaw = buildResolvedRefs(ids, labelMap, valuesMap);\r\n      const expr = '\u00F0\u0178\u201D\u201E Condition \u00C3\u00A9valu\u00C3\u00A9e via TBL Prisma (ligne 504)';\r\n      result = expr || `${display}: ${valueStr ?? ''}`;\r\n    } else if (type === 'formula') {\r\n      const ids = extractNodeIdsFromTokens(record?.tokens);\r\n      const refsRaw = buildResolvedRefs(ids, labelMap, valuesMap);\r\n      let expr = buildTextFromTokens(record?.tokens, labelMap, valuesMap);\r\n      \r\n      // Calculer le r\u00C3\u00A9sultat de l'expression math\u00C3\u00A9matique\r\n      const calculatedResult = calculateResult(expr);\r\n      if (calculatedResult !== null) {\r\n        expr += ` = ${calculatedResult}`;\r\n      }\r\n      \r\n      result = expr || `${display}: ${valueStr ?? ''}`;\r\n    } else if (type === 'table') {\r\n      const str = JSON.stringify(record);\r\n      const ids = new Set<string>();\r\n      if (str) {\r\n        let m: RegExpExecArray | null;\r\n        const re = /@value\\.([a-f0-9-]{36})/gi;\r\n        while ((m = re.exec(str)) !== null) ids.add(m[1]);\r\n      }\r\n      const refsRaw = buildResolvedRefs(ids, labelMap, valuesMap);\r\n      const expr = buildTextFromTableRecord(record, labelMap, valuesMap);\r\n      const unitSuffix = unit ? ` ${unit}` : '';\r\n      result = expr ? `${expr} (=) ${display} (${valueStr ?? ''}${unitSuffix})` : `${display} (${valueStr ?? ''}${unitSuffix})`;\r\n    }\r\n  } catch (error) {\r\n    console.error('[buildDetailAndResultForOperationLegacy] \u00E2\u009D\u0152 Erreur lors de la construction:', error);\r\n    result = `${display}: ${valueStr ?? ''}`;\r\n  }\r\n  \r\n  return { detail, result };\r\n}\r\n\r\n// (ancienne buildConditionHumanText supprim\u00C3\u00A9e \u00E2\u20AC\u201D remplac\u00C3\u00A9e par buildConditionExpressionReadable)\r\n\r\n// \u00F0\u0178\u201D\u00A5 NOUVELLE FONCTION: \u00C3\u2030valuer dynamiquement une condition\r\nfunction evaluateCondition(when: Record<string, unknown>, values: ValuesMap): boolean {\r\n  const type = (when.type as string) || 'binary';\r\n  if (type !== 'binary') return false;\r\n  \r\n  const op = (when.op as string) || '';\r\n  const left = when.left as Record<string, unknown> | undefined;\r\n  const right = when.right as Record<string, unknown> | undefined;\r\n  \r\n  // Obtenir la valeur de gauche\r\n  let leftValue: unknown = null;\r\n  if (left && typeof left === 'object') {\r\n    if (typeof left.ref === 'string') {\r\n      const m = /@value\\.([a-f0-9-]{36})/i.exec(left.ref);\r\n      const id = m && m[1] ? m[1] : left.ref;\r\n      leftValue = values.get(id);\r\n    } else {\r\n      leftValue = left.value;\r\n    }\r\n  }\r\n  \r\n  // Obtenir la valeur de droite\r\n  let rightValue: unknown = null;\r\n  if (right && typeof right === 'object') {\r\n    if (typeof right.ref === 'string') {\r\n      const m = /@value\\.([a-f0-9-]{36})/i.exec(right.ref);\r\n      const id = m && m[1] ? m[1] : right.ref;\r\n      rightValue = values.get(id);\r\n    } else {\r\n      rightValue = right.value;\r\n    }\r\n  }\r\n  \r\n  console.log(`[EVALUATE-CONDITION] op: ${op}, leftValue:`, leftValue, 'rightValue:', rightValue);\r\n  \r\n  // \u00C3\u2030valuer selon l'op\u00C3\u00A9rateur\r\n  switch (op) {\r\n    case 'isEmpty':\r\n      return leftValue === null || leftValue === undefined || leftValue === '';\r\n    case 'isNotEmpty':\r\n      return leftValue !== null && leftValue !== undefined && leftValue !== '';\r\n    case 'eq':\r\n      return leftValue === rightValue;\r\n    case 'ne':\r\n      return leftValue !== rightValue;\r\n    case 'gt':\r\n      return Number(leftValue) > Number(rightValue);\r\n    case 'gte':\r\n      return Number(leftValue) >= Number(rightValue);\r\n    case 'lt':\r\n      return Number(leftValue) < Number(rightValue);\r\n    case 'lte':\r\n      return Number(leftValue) <= Number(rightValue);\r\n    case 'contains':\r\n      return String(leftValue || '').includes(String(rightValue || ''));\r\n    case 'notContains':\r\n      return !String(leftValue || '').includes(String(rightValue || ''));\r\n    default:\r\n      console.log(`[EVALUATE-CONDITION] Op\u00C3\u00A9rateur non reconnu: ${op}`);\r\n      return false;\r\n  }\r\n}\r\n\r\n// \u00F0\u0178\u201D\u00A5 FONCTION DE CALCUL: Calculer le r\u00C3\u00A9sultat d'une expression math\u00C3\u00A9matique\r\nfunction calculateResult(expression: string): number | null {\r\n  try {\r\n    // Extraire seulement la partie math\u00C3\u00A9matique (avant le \" = \" s'il existe)\r\n    const mathPart = expression.split(' = ')[0];\r\n    \r\n    // Extraire les valeurs num\u00C3\u00A9riques entre parenth\u00C3\u00A8ses\r\n    const valueMatches = mathPart.match(/\\(([0-9.]+)\\)/g);\r\n    if (!valueMatches || valueMatches.length < 2) {\r\n      return null;\r\n    }\r\n    \r\n    const values = valueMatches.map(match => parseFloat(match.slice(1, -1)));\r\n    \r\n    // D\u00C3\u00A9tecter l'op\u00C3\u00A9rateur - supporter les formats avec parenth\u00C3\u00A8ses et avec espaces\r\n    if (mathPart.includes('(+)') || mathPart.includes(' + ')) {\r\n      return values.reduce((a, b) => a + b, 0);\r\n    } else if (mathPart.includes('(-)') || mathPart.includes(' - ')) {\r\n      return values.reduce((a, b) => a - b);\r\n    } else if (mathPart.includes('(*)') || mathPart.includes(' * ')) {\r\n      return values.reduce((a, b) => a * b, 1);\r\n    } else if (mathPart.includes('(/)') || mathPart.includes(' / ')) {\r\n      return values.reduce((a, b) => a / b);\r\n    }\r\n    \r\n    return null;\r\n  } catch (error) {\r\n    console.error('Erreur lors du calcul:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Helper: construit l'expression lisible compl\u00C3\u00A8te demand\u00C3\u00A9e pour une condition\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u00A8 CONSTRUCTEUR D'EXPRESSIONS HUMAINES COMPL\u00C3\u02C6TES\r\n// =============================================================================\r\n\r\nasync function buildConditionExpressionReadable(\r\n  conditionSet: unknown,\r\n  labelForResult: string,\r\n  response: string | null,\r\n  unit: string | null | undefined,\r\n  labels: LabelMap,\r\n  values: ValuesMap,\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  dbClient: any\r\n): Promise<string> {\r\n  // \u00F0\u0178\u0161\u00AB CETTE FONCTION LEGACY EST D\u00C3\u2030SACTIV\u00C3\u2030E !\r\n  // TOUT DOIT PASSER PAR TBL PRISMA MAINTENANT !\r\n  console.log('\u00F0\u0178\u0161\u00AB [LEGACY DISABLED] buildConditionExpressionReadable est d\u00C3\u00A9sactiv\u00C3\u00A9e - utilisez TBL Prisma !');\r\n  return \"\u00F0\u0178\u201D\u201E Condition \u00C3\u00A9valu\u00C3\u00A9e via TBL Prisma\";\r\n  // when \u00E2\u2020\u2019 texte\r\n  // Pour la clause WHEN on affiche UNIQUEMENT le libell\u00C3\u00A9 (sans valeur entre parenth\u00C3\u00A8ses)\r\n  const refFmtLabel = (ref: string | undefined): string => {\r\n    if (!ref) return '\u00E2\u20AC\u201D';\r\n    const m = /@value\\.([a-f0-9-]{36})/i.exec(ref);\r\n    const id = m && m[1] ? m[1] : ref;\r\n    return (labels.get(id) ?? id) as string;\r\n  };\r\n  const whenToText = (node?: Record<string, unknown>): string => {\r\n    if (!node || typeof node !== 'object') return '';\r\n    const type = (node.type as string) || 'binary';\r\n    if (type !== 'binary') return '';\r\n    const op = (node.op as string) || '';\r\n    const left = node.left as Record<string, unknown> | undefined;\r\n    const right = node.right as Record<string, unknown> | undefined;\r\n    const leftTxt = left && typeof left === 'object'\r\n      ? (typeof left.ref === 'string' ? refFmtLabel(left.ref) : String(left.value ?? ''))\r\n      : '';\r\n    const rightTxt = right && typeof right === 'object'\r\n      ? (typeof right.ref === 'string' ? refFmtLabel(right.ref) : String(right.value ?? ''))\r\n      : '';\r\n    const opMap: Record<string, string> = {\r\n      // Harmonisation demand\u00C3\u00A9e: inclure \"=\"\r\n      isEmpty: '= vide',\r\n      isNotEmpty: \"= n'est pas vide\",\r\n      eq: '=',\r\n      ne: '\u00E2\u2030\u00A0',\r\n      gt: '>',\r\n      gte: '\u00E2\u2030\u00A5',\r\n      lt: '<',\r\n      lte: '\u00E2\u2030\u00A4',\r\n      contains: 'contient',\r\n      notContains: 'ne contient pas'\r\n    };\r\n    const opTxt = opMap[op] || op;\r\n    if (op === 'isEmpty' || op === 'isNotEmpty') return `${leftTxt} ${opTxt}`.trim();\r\n    return `${leftTxt} ${opTxt} ${rightTxt}`.trim();\r\n  };\r\n  // Premi\u00C3\u00A8re branche pour le WHEN\r\n  let firstWhen: Record<string, unknown> | undefined = undefined;\r\n  if (Array.isArray(setObj.branches) && setObj.branches.length > 0) {\r\n    const br0 = setObj.branches[0] as Record<string, unknown>;\r\n    if (br0 && typeof br0 === 'object' && br0.when && typeof br0.when === 'object') {\r\n      firstWhen = br0.when as Record<string, unknown>;\r\n    }\r\n  }\r\n  const whenText = whenToText(firstWhen);\r\n  \r\n  // \u00F0\u0178\u201D\u00A5 \u00C3\u2030VALUATION DYNAMIQUE: Calculer le r\u00C3\u00A9sultat final de la condition\r\n  let finalResult = response ?? '\u00E2\u02C6\u2026';\r\n  let conditionResult = false;\r\n  if (firstWhen) {\r\n    conditionResult = evaluateCondition(firstWhen, values);\r\n  }\r\n  console.log(`[BUILD-CONDITION-DEBUG] Condition \u00C3\u00A9valu\u00C3\u00A9e:`, conditionResult, 'pour when:', firstWhen);\r\n  \r\n  // D\u00C3\u00A9terminer quelle branche utiliser\r\n  const branches = Array.isArray(setObj.branches) ? setObj.branches : [];\r\n  \r\n  if (conditionResult && branches.length > 0) {\r\n    // Condition vraie \u00E2\u2020\u2019 utiliser la premi\u00C3\u00A8re branche (ALORS)\r\n    const selectedBranch = branches[0] as Record<string, unknown>;\r\n    console.log(`[BUILD-CONDITION-DEBUG] Utilisation branche ALORS`);\r\n    \r\n    const acts = Array.isArray(selectedBranch.actions) ? (selectedBranch.actions as unknown[]) : [];\r\n    for (const a of acts) {\r\n      const aa = a as Record<string, unknown>;\r\n      if (Array.isArray(aa.nodeIds)) {\r\n        for (const nid of aa.nodeIds as string[]) {\r\n          const normalizedId = normalizeRefId(nid);\r\n          const directValue = values.get(normalizedId);\r\n          if (directValue !== null && directValue !== undefined) {\r\n            finalResult = String(directValue);\r\n            console.log(`[BUILD-CONDITION-DEBUG] Valeur directe ALORS:`, finalResult);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  } else if (!conditionResult) {\r\n    // Condition fausse \u00E2\u2020\u2019 utiliser le fallback (SINON) et calculer les formules\r\n    console.log(`[BUILD-CONDITION-DEBUG] Utilisation branche SINON (fallback)`);\r\n    \r\n    const fIds = extractFormulaIdsFromConditionSet(conditionSet);\r\n    console.log(`[BUILD-CONDITION-DEBUG] Formula IDs extraits:`, Array.from(fIds));\r\n    \r\n    if (fIds.size > 0) {\r\n      const formulas = await dbClient.treeBranchLeafNodeFormula.findMany({\r\n        where: { id: { in: Array.from(fIds) } },\r\n        select: { id: true, nodeId: true, tokens: true }\r\n      });\r\n      console.log(`[BUILD-CONDITION-DEBUG] Formules trouv\u00C3\u00A9es:`, formulas.length);\r\n      \r\n      for (const f of formulas) {\r\n        const allTokenIds = new Set<string>();\r\n        const ids = extractNodeIdsFromTokens(f.tokens);\r\n        ids.forEach(id => allTokenIds.add(id));\r\n        \r\n        if (allTokenIds.size > 0) {\r\n          const missing = Array.from(allTokenIds).filter(id => !labels.has(id));\r\n          if (missing.length > 0) {\r\n            const nodes = await dbClient.treeBranchLeafNode.findMany({\r\n              where: { id: { in: missing } },\r\n              select: { id: true, label: true }\r\n            });\r\n            for (const n of nodes) labels.set(n.id, n.label || null);\r\n          }\r\n        }\r\n        \r\n        const expr = buildTextFromTokens(f.tokens, labels, values);\r\n        const calculatedResult = calculateResult(expr);\r\n        \r\n        if (calculatedResult !== null && calculatedResult !== undefined && !isNaN(calculatedResult)) {\r\n          finalResult = String(calculatedResult);\r\n          console.log(`[BUILD-CONDITION-DEBUG] R\u00C3\u00A9sultat calcul\u00C3\u00A9 SINON:`, finalResult, 'depuis expression:', expr);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // THEN: essayer d'afficher les cibles d'action de la 1\u00C3\u00A8re branche (labels + valeurs)\r\n  let thenPart = `${labelForResult} (${finalResult})`;\r\n  if (Array.isArray(setObj.branches) && setObj.branches.length > 0) {\r\n    const b0 = setObj.branches[0] as Record<string, unknown>;\r\n    const acts = Array.isArray(b0.actions) ? (b0.actions as unknown[]) : [];\r\n    const nodeIds: string[] = [];\r\n    for (const a of acts) {\r\n      const aa = a as Record<string, unknown>;\r\n      if (Array.isArray(aa.nodeIds)) {\r\n        for (const nid of aa.nodeIds as string[]) nodeIds.push(normalizeRefId(nid));\r\n      }\r\n    }\r\n    if (nodeIds.length > 0) {\r\n      const parts = Array.from(new Set(nodeIds)).map(nid => fmtLV(labels.get(nid) ?? nid, values.get(nid) ?? null));\r\n      if (parts.filter(Boolean).length > 0) thenPart = parts.join(', ');\r\n    }\r\n  }\r\n  \r\n  // ELSE: extraire les formules r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9es et rendre leur expression\r\n  const fIds = extractFormulaIdsFromConditionSet(conditionSet);\r\n  console.log(`[BUILD-CONDITION-DEBUG] Formula IDs extraits:`, Array.from(fIds));\r\n  let elseExpr = '';\r\n  if (fIds.size > 0) {\r\n    const formulas = await dbClient.treeBranchLeafNodeFormula.findMany({\r\n      where: { id: { in: Array.from(fIds) } },\r\n      select: { id: true, nodeId: true, tokens: true }\r\n    });\r\n    const parts: string[] = [];\r\n    for (const f of formulas) {\r\n      const lbl = labels.get(f.nodeId) ?? 'Formule';\r\n      const expr = buildTextFromTokens(f.tokens, labels, values);\r\n      \r\n      // \u00F0\u0178\u201D\u00A5 CALCULER LE R\u00C3\u2030SULTAT: Si c'est la condition active, utiliser le r\u00C3\u00A9sultat calcul\u00C3\u00A9\r\n      if (!conditionResult) {\r\n        const calculatedResult = calculateResult(expr);\r\n        if (calculatedResult !== null && calculatedResult !== undefined && !isNaN(calculatedResult)) {\r\n          parts.push(`${lbl} ${expr} (=) ${calculatedResult}`);\r\n        } else {\r\n          parts.push(`${lbl} ${expr}`);\r\n        }\r\n      } else {\r\n        parts.push(`${lbl} ${expr}`);\r\n      }\r\n    }\r\n    elseExpr = parts.join(' ; ');\r\n  }\r\n  if (!elseExpr) elseExpr = labelForResult;\r\n  \r\n  const unitSuffix = unit ? ` ${unit}` : '';\r\n  \r\n  // \u00F0\u0178\u201D\u00A5 REDIRECTION COMPL\u00C3\u02C6TE VERS TBL PRISMA !\r\n  // Au lieu de g\u00C3\u00A9n\u00C3\u00A9rer des traductions statiques, on utilise le CapacityCalculator\r\n  console.log('\u00F0\u0178\u201D\u201E [REDIRECT TBL] buildConditionExpressionReadable redirig\u00C3\u00A9 vers CapacityCalculator');\r\n  \r\n  // Si on a un sourceRef dans les labels, on peut l'utiliser pour identifier la condition\r\n  let conditionId = null;\r\n  for (const [key, label] of labels.entries()) {\r\n    if (label === labelForResult) {\r\n      conditionId = key;\r\n      break;\r\n    }\r\n  }\r\n  \r\n  if (conditionId) {\r\n    try {\r\n      // \u00F0\u0178\u201D\u00A5 UTILISER LE SYST\u00C3\u02C6ME UNIFI\u00C3\u2030 operation-interpreter !\r\n      console.log('\u00F0\u0178\u00A7\u00AE [TBL DYNAMIC] \u00C3\u2030valuation condition avec operation-interpreter:', conditionId);\r\n      \r\n      // Import du syst\u00C3\u00A8me unifi\u00C3\u00A9\r\n      const { evaluateVariableOperation } = await import('./operation-interpreter');\r\n      \r\n      // Trouver le nodeId de la condition\r\n      const conditionNode = await dbClient.treeBranchLeafNodeCondition.findUnique({\r\n        where: { id: conditionId },\r\n        select: { nodeId: true }\r\n      });\r\n      \r\n      if (!conditionNode?.nodeId) {\r\n        return `\u00E2\u0161\u00A0\u00EF\u00B8\u008F Condition ${conditionId}: nodeId introuvable`;\r\n      }\r\n      \r\n      // Cr\u00C3\u00A9er le calculateur avec Prisma\r\n      const submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182';\r\n      \r\n      // Pr\u00C3\u00A9parer le contexte avec la VRAIE organisation !\r\n      const organizationId = (req as any).user?.organizationId || 'unknown-org';\r\n      const userId = (req as any).user?.userId || 'unknown-user';\r\n      \r\n      // \u00E2\u0153\u00A8 Calculer avec le syst\u00C3\u00A8me unifi\u00C3\u00A9\r\n      const calculationResult = await evaluateVariableOperation(\r\n        conditionNode.nodeId,\r\n        submissionId,\r\n        dbClient\r\n      );\r\n      \r\n      console.log('\u00F0\u0178\u00A7\u00AE [TBL DYNAMIC] R\u00C3\u00A9sultat operation-interpreter:', calculationResult);\r\n      \r\n      // Retourner la traduction intelligente au lieu du message d'attente\r\n      if (calculationResult && calculationResult.operationResult) {\r\n        return calculationResult.operationResult as string;\r\n      } else {\r\n        return `\u00E2\u0161\u00A0\u00EF\u00B8\u008F Condition ${conditionId}: Aucun r\u00C3\u00A9sultat TBL Prisma`;\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error('\u00E2\u009D\u0152 [TBL DYNAMIC] Erreur operation-interpreter:', error);\r\n      return `\u00E2\u0161\u00A0\u00EF\u00B8\u008F Condition ${conditionId}: Erreur \u00C3\u00A9valuation TBL - ${error instanceof Error ? error.message : 'unknown'}`;\r\n    }\r\n  }\r\n  \r\n  // Fallback pour les cas sans conditionId identifiable\r\n  return `\u00F0\u0178\u201D\u201E Condition: \u00C3\u2030valuation TBL Prisma (plus de traduction statique \"Si...alors...sinon\")`;\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u203A\u00A1\u00EF\u00B8\u008F MIDDLEWARE - S\u00C3\u00A9curit\u00C3\u00A9 et authentification\r\n// =============================================================================\r\n// TEMPORAIREMENT D\u00C3\u2030SACTIV\u00C3\u2030 pour tester le syst\u00C3\u00A8me automatique\r\n// TODO: R\u00C3\u00A9activer l'authentification apr\u00C3\u00A8s tests\r\n\r\n// Authentification requise pour toutes les routes - TEMPORAIREMENT D\u00C3\u2030SACTIV\u00C3\u2030\r\n// router.use(authenticateToken);\r\n\r\n// Mock user temporaire pour les tests\r\nrouter.use((req, res, next) => {\r\n  (req as MinimalReq).user = {\r\n    id: '1757366075163-2vdibc2ve',\r\n    userId: '1757366075163-2vdibc2ve',\r\n    email: 'jonathan.dethier@2thier.be',\r\n    organizationId: '1757366075154-i554z93kl',\r\n    isSuperAdmin: true,\r\n    role: 'super_admin'\r\n  };\r\n  console.log('[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A9 Mock auth user assign\u00C3\u00A9 pour tests');\r\n  next();\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u0152\u00B3 TREES - Gestion des arbres\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/trees - Liste des arbres\r\nrouter.get('/trees', async (req, res) => {\r\n  try {\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] GET /trees - D\u00C3\u2030BUT de la route');\r\n    \r\n    // D\u00C3\u00A9terminer l'organisation depuis l'utilisateur/headers\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Organization ID:', organizationId);\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Is Super Admin:', isSuperAdmin);\r\n    \r\n    const whereFilter = isSuperAdmin || !organizationId ? {} : { organizationId };\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Where filter:', whereFilter);\r\n\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Recherche des arbres TreeBranchLeaf...');\r\n    const trees = await prisma.treeBranchLeafTree.findMany({\r\n      where: whereFilter,\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            TreeBranchLeafNode: true,\r\n            TreeBranchLeafSubmission: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Arbres trouv\u00C3\u00A9s:', trees.length);\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Premier arbre:', trees[0] ? `${trees[0].id} - ${trees[0].name}` : 'Aucun');\r\n    if (trees.length > 0) {\r\n      console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] D\u00C3\u00A9tails premier arbre:', {\r\n        id: trees[0].id,\r\n        name: trees[0].name,\r\n        organizationId: trees[0].organizationId,\r\n        nodeCount: trees[0]._count?.TreeBranchLeafNode || 0\r\n      });\r\n    }\r\n\r\n    res.json(trees);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching trees:', error);\r\n    res.status(500).json({ error: 'Impossible de r\u00C3\u00A9cup\u00C3\u00A9rer les arbres' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/trees/:id - D\u00C3\u00A9tails d'un arbre\r\nrouter.get('/trees/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: isSuperAdmin || !organizationId ? { id } : { id, organizationId },\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            TreeBranchLeafNode: true,\r\n            TreeBranchLeafSubmission: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    res.json(tree);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching tree:', error);\r\n    res.status(500).json({ error: 'Impossible de r\u00C3\u00A9cup\u00C3\u00A9rer l\\'arbre' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/trees - Cr\u00C3\u00A9er un arbre\r\nrouter.post('/trees', async (req, res) => {\r\n  try {\r\n    const {\r\n      name,\r\n      description,\r\n      category = 'formulaire',\r\n      icon,\r\n      color = '#10b981',\r\n      version = '1.0.0',\r\n      status = 'draft',\r\n      settings = {},\r\n      metadata = {},\r\n  isPublic = false,\r\n  organizationId: bodyOrgId\r\n    } = req.body || {};\r\n\r\n    if (!name || typeof name !== 'string' || !name.trim()) {\r\n      return res.status(400).json({ error: \"Le nom de l'arbre est requis\" });\r\n    }\r\n\r\n  // D\u00C3\u00A9terminer l'organisation cible (header/user d'abord, sinon body)\r\n  const targetOrgId: string | null = (getAuthCtx(req as unknown as MinimalReq).organizationId as string | null) || (typeof bodyOrgId === 'string' ? bodyOrgId : null);\r\n  if (!targetOrgId) {\r\n      return res.status(400).json({ error: \"organizationId requis (en-t\u00C3\u00AAte x-organization-id ou dans le corps)\" });\r\n    }\r\n\r\n    const id = randomUUID();\r\n\r\n    const tree = await prisma.treeBranchLeafTree.create({\r\n      data: {\r\n        id,\r\n    organizationId: targetOrgId,\r\n        name: name.trim(),\r\n        description: description ?? null,\r\n        category,\r\n        icon: icon ?? null,\r\n        color,\r\n        version,\r\n        status,\r\n        settings: settings as Prisma.InputJsonValue,\r\n        metadata: metadata as Prisma.InputJsonValue,\r\n        isPublic: Boolean(isPublic),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    res.status(201).json(tree);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error creating tree:', error);\r\n    res.status(500).json({ error: 'Impossible de cr\u00C3\u00A9er l\\'arbre' });\r\n  }\r\n});\r\n\r\n// PUT /api/treebranchleaf/trees/:id - Mettre \u00C3\u00A0 jour un arbre\r\nrouter.put('/trees/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId } = req.user!;\r\n    const updateData = req.body;\r\n\r\n    // Supprimer les champs non modifiables\r\n    delete updateData.id;\r\n    delete updateData.organizationId;\r\n    delete updateData.createdAt;\r\n\r\n    const tree = await prisma.treeBranchLeafTree.updateMany({\r\n      where: { \r\n        id, \r\n        organizationId \r\n      },\r\n      data: {\r\n        ...updateData,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    if (tree.count === 0) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer l'arbre mis \u00C3\u00A0 jour\r\n    const updatedTree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: { id, organizationId }\r\n    });\r\n\r\n    res.json(updatedTree);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating tree:', error);\r\n    res.status(500).json({ error: 'Impossible de mettre \u00C3\u00A0 jour l\\'arbre' });\r\n  }\r\n});\r\n\r\n// DELETE /api/treebranchleaf/trees/:id - Supprimer un arbre\r\nrouter.delete('/trees/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId } = req.user!;\r\n\r\n    // Supprimer d'abord tous les n\u00C5\u201Cuds associ\u00C3\u00A9s\r\n    await prisma.treeBranchLeafNode.deleteMany({\r\n      where: { treeId: id }\r\n    });\r\n\r\n    // Puis supprimer l'arbre\r\n    const result = await prisma.treeBranchLeafTree.deleteMany({\r\n      where: { \r\n        id, \r\n        organizationId \r\n      }\r\n    });\r\n\r\n    if (result.count === 0) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    res.json({ success: true, message: 'Arbre supprim\u00C3\u00A9 avec succ\u00C3\u00A8s' });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error deleting tree:', error);\r\n    res.status(500).json({ error: 'Impossible de supprimer l\\'arbre' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u008D\u0192 NODES - Gestion des n\u00C5\u201Cuds\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/trees/:treeId/nodes - Liste des n\u00C5\u201Cuds d'un arbre\r\nrouter.get('/trees/:treeId/nodes', async (req, res) => {\r\n  try {\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] GET /trees/:treeId/nodes - D\u00C3\u2030BUT');\r\n    const { treeId } = req.params;\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] TreeId:', treeId);\r\n    \r\n    // Utiliser getAuthCtx au lieu de req.user pour plus de robustesse\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Organization ID:', organizationId);\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Is Super Admin:', isSuperAdmin);\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation (sauf SuperAdmin)\r\n    const treeWhereFilter = isSuperAdmin || !organizationId ? { id: treeId } : { id: treeId, organizationId };\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Tree where filter:', treeWhereFilter);\r\n    \r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: treeWhereFilter\r\n    });\r\n    console.log('\u00F0\u0178\u201D\u008D [TBL-ROUTES] Arbre trouv\u00C3\u00A9:', tree ? `${tree.id} - ${tree.name}` : 'null');\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer tous les n\u0153uds de l'arbre\r\n    let nodesRaw: any[] = [];\r\n    try {\r\n      nodesRaw = await prisma.treeBranchLeafNode.findMany({ where: { treeId } });\r\n    } catch (prismaErr: any) {\r\n      // Prisma P2022: missing column(s) in DB - provide helpful guidance\r\n      if (prismaErr?.code === 'P2022') {\r\n        console.error('[TreeBranchLeaf API] Prisma missing column error (P2022):', prismaErr.meta || prismaErr.message);\r\n        // Include details for the user (devs) - don't log secrets\r\n        return res.status(500).json({\r\n          error: 'Erreur base de donn\u00E9es: colonne manquante d\u00E9tect\u00E9e par Prisma (P2022).',\r\n          details: prismaErr?.meta || prismaErr?.message,\r\n          hint: 'V\u00E9rifiez que vous avez appliqu\u00E9 toutes les migrations `npx prisma migrate dev` et r\u00E9g\u00E9n\u00E9r\u00E9 le client `npx prisma generate`.'\r\n        });\r\n      }\r\n      // Re-propagate other Prisma errors as server errors and log stack\r\n      console.error('[TreeBranchLeaf API] Unexpected Prisma error fetching nodes:', prismaErr);\r\n      return res.status(500).json({ error: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des n\u0153uds', details: prismaErr?.message });\r\n    }\r\n    console.log('\uD83D\uDD0D [GET /trees/:treeId/nodes] N\u0153uds bruts r\u00E9cup\u00E9r\u00E9s en base:', nodesRaw.length);\r\n\r\n    // \uD83D\uDD04 MIGRATION : Reconstruire les donn\u00E9es JSON depuis les colonnes d\u00E9di\u00E9es\r\n    console.log('\uD83D\uDD27 [GET /trees/:treeId/nodes] Reconstruction depuis colonnes pour', nodesRaw.length, 'n\u0153uds');\r\n    const reconstructedNodes: Array<Record<string, unknown>> = [];\r\n    for (const nodeItem of nodesRaw) {\r\n      try {\r\n        reconstructedNodes.push(buildResponseFromColumns(nodeItem));\r\n      } catch (e) {\r\n        console.error('[TreeBranchLeaf API] Erreur reconstruction noeud:', { nodeId: (nodeItem as any)?.id, error: e });\r\n        // Fallback: push a minimal node object so UI receives something instead of crashing\r\n        reconstructedNodes.push({ id: (nodeItem as any)?.id, label: (nodeItem as any)?.label || 'N\u0153ud', metadata: nodeItem?.metadata || {} });\r\n      }\r\n    }\r\n    \r\n    // \u00F0\u0178\u0161\u00A8 DEBUG TOOLTIP FINAL : V\u00C3\u00A9rifier ce qui va \u00C3\u00AAtre envoy\u00C3\u00A9 au client\r\n    const nodesWithTooltips = reconstructedNodes.filter(node => \r\n      node.text_helpTooltipType && node.text_helpTooltipType !== 'none'\r\n    );\r\n    if (nodesWithTooltips.length > 0) {\r\n      console.log('\u00F0\u0178\u017D\u00AF [GET /trees/:treeId/nodes] ENVOI AU CLIENT - N\u00C5\u201Cuds avec tooltips:', \r\n        nodesWithTooltips.map(node => ({\r\n          id: node.id,\r\n          name: node.name,\r\n          tooltipType: node.text_helpTooltipType,\r\n          hasTooltipText: !!node.text_helpTooltipText,\r\n          hasTooltipImage: !!node.text_helpTooltipImage\r\n        }))\r\n      );\r\n    }\r\n\r\n    res.json(reconstructedNodes);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching nodes:', error, (error as any)?.stack);\r\n    res.status(500).json({ error: 'Impossible de r\u00E9cup\u00E9rer les n\u0153uds', details: String(error) });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/trees/:treeId/repeater-fields - Liste des champs r\u00C3\u00A9p\u00C3\u00A9titeurs (instances)\r\nrouter.get('/trees/:treeId/repeater-fields', async (req, res) => {\r\n  try {\r\n    console.log('\u00F0\u0178\u201D\u0081 [TBL-ROUTES] GET /trees/:treeId/repeater-fields - D\u00C3\u2030BUT');\r\n    const { treeId } = req.params;\r\n    \r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation (sauf SuperAdmin)\r\n    const treeWhereFilter = isSuperAdmin || !organizationId ? { id: treeId } : { id: treeId, organizationId };\r\n    \r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: treeWhereFilter\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds de l'arbre (TOUS les champs car buildResponseFromColumns en a besoin)\r\n    const allNodesRaw = await prisma.treeBranchLeafNode.findMany({\r\n      where: { treeId }\r\n    });\r\n\r\n    console.log(`\u00F0\u0178\u201D\u0081 [TBL-ROUTES] ${allNodesRaw.length} n\u00C5\u201Cuds bruts r\u00C3\u00A9cup\u00C3\u00A9r\u00C3\u00A9s depuis la base`);\r\n\r\n    // Reconstruire les m\u00C3\u00A9tadonn\u00C3\u00A9es depuis les colonnes pour chaque n\u00C5\u201Cud\r\n    const allNodes = allNodesRaw.map(node => buildResponseFromColumns(node));\r\n\r\n    // Cr\u00C3\u00A9er un Map pour acc\u00C3\u00A8s rapide par ID (non utilis\u00C3\u00A9 dans le nouveau syst\u00C3\u00A8me)\r\n    const _nodesById = new Map(allNodes.map(n => [n.id as string, n]));\r\n\r\n    // Collecter tous les champs r\u00C3\u00A9p\u00C3\u00A9titeurs\r\n    const repeaterFields: Array<{\r\n      id: string;\r\n      label: string;\r\n      repeaterLabel: string;\r\n      repeaterParentId: string;\r\n      nodeLabel?: string;\r\n      nodeId?: string;\r\n    }> = [];\r\n\r\n    // Parcourir tous les n\u00C5\u201Cuds pour trouver ceux avec des repeaters\r\n    for (const node of allNodes) {\r\n      // V\u00C3\u00A9rifier si le n\u00C5\u201Cud a des m\u00C3\u00A9tadonn\u00C3\u00A9es repeater\r\n      const metadata = node.metadata as any;\r\n      if (!metadata?.repeater) continue;\r\n\r\n      const repeaterMeta = metadata.repeater;\r\n      const templateNodeIds = repeaterMeta.templateNodeIds || [];\r\n      const _templateNodeLabels = repeaterMeta.templateNodeLabels || {}; // Non utilis\u00C3\u00A9 dans le nouveau syst\u00C3\u00A8me\r\n\r\n      console.log(`\u00F0\u0178\u201D\u0081 [TBL-ROUTES] N\u00C5\u201Cud repeater \"${node.label}\" a ${templateNodeIds.length} templates configur\u00C3\u00A9s`);\r\n\r\n      // ========================================================================\r\n      // \u00F0\u0178\u017D\u00AF SYST\u00C3\u02C6ME DE CHAMPS R\u00C3\u2030P\u00C3\u2030TITEURS - ENFANTS PHYSIQUES UNIQUEMENT\r\n      // ========================================================================\r\n      // IMPORTANT: On retourne UNIQUEMENT les enfants physiques R\u00C3\u2030ELS cr\u00C3\u00A9\u00C3\u00A9s via duplication\r\n      // \r\n      // \u00E2\u009D\u0152 PLUS D'IDS VIRTUELS ! On ne g\u00C3\u00A9n\u00C3\u00A8re PLUS d'IDs compos\u00C3\u00A9s comme {repeaterId}_template_{templateId}\r\n      //\r\n      // \u00E2\u0153\u2026 ON RETOURNE:\r\n      //    - Les enfants physiques qui ont metadata.sourceTemplateId (cr\u00C3\u00A9\u00C3\u00A9s par POST /duplicate-templates)\r\n      //    - Ce sont de VRAIS n\u00C5\u201Cuds dans la base avec de VRAIS UUID\r\n      //    - Ils peuvent \u00C3\u00AAtre utilis\u00C3\u00A9s directement dans les formules/conditions\r\n      //\r\n      // \u00F0\u0178\u201C\u0152 Si aucun enfant physique n'existe encore (utilisateur n'a pas cliqu\u00C3\u00A9 sur \"+\"):\r\n      //    - On ne retourne RIEN pour ce repeater\r\n      //    - Les champs appara\u00C3\u00AEtront apr\u00C3\u00A8s la premi\u00C3\u00A8re duplication\r\n      // ========================================================================\r\n\r\n      // R\u00C3\u00A9cup\u00C3\u00A9rer tous les enfants physiques de ce repeater\r\n      const physicalChildren = allNodes.filter(child => {\r\n        if (child.parentId !== node.id) return false;\r\n        \r\n        const childMeta = child.metadata as any;\r\n        // V\u00C3\u00A9rifier que l'enfant a bien \u00C3\u00A9t\u00C3\u00A9 cr\u00C3\u00A9\u00C3\u00A9 via duplication (a sourceTemplateId)\r\n        // ET que ce sourceTemplateId correspond \u00C3\u00A0 un template configur\u00C3\u00A9\r\n        return childMeta?.sourceTemplateId && templateNodeIds.includes(childMeta.sourceTemplateId);\r\n      });\r\n\r\n      console.log(`\u00F0\u0178\u201D\u0081 [TBL-ROUTES] \u00E2\u2020\u2019 ${physicalChildren.length} enfants physiques avec sourceTemplateId trouv\u00C3\u00A9s`);\r\n\r\n      if (physicalChildren.length === 0) {\r\n        console.log(`\u00E2\u0161\u00A0\u00EF\u00B8\u008F [TBL-ROUTES] Aucun enfant physique pour \"${node.label}\", il faut dupliquer les templates d'abord`);\r\n        continue; // Passer au n\u00C5\u201Cud suivant\r\n      }\r\n\r\n      // Ajouter chaque enfant physique \u00C3\u00A0 la liste\r\n      for (const child of physicalChildren) {\r\n        console.log(`\u00E2\u0153\u2026 [TBL-ROUTES] Enfant physique ajout\u00C3\u00A9: \"${child.label}\" (${child.id})`);\r\n\r\n        repeaterFields.push({\r\n          id: child.id as string,                 // \u00E2\u0153\u2026 VRAI UUID de l'enfant physique\r\n          label: `${node.label} / ${child.label}`, // Label complet affich\u00C3\u00A9\r\n          repeaterLabel: node.label as string,    // Label du repeater parent\r\n          repeaterParentId: node.id as string,    // ID du n\u00C5\u201Cud repeater\r\n          nodeLabel: child.label as string,       // Label de l'enfant\r\n          nodeId: child.id as string              // \u00E2\u0153\u2026 VRAI UUID de l'enfant\r\n        });\r\n      }\r\n    }\r\n\r\n    console.log(`\u00F0\u0178\u201D\u0081 [TBL-ROUTES] ${repeaterFields.length} champs r\u00C3\u00A9p\u00C3\u00A9titeurs trouv\u00C3\u00A9s`);\r\n    res.json(repeaterFields);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching repeater fields:', error);\r\n    res.status(500).json({ error: 'Impossible de r\u00C3\u00A9cup\u00C3\u00A9rer les champs r\u00C3\u00A9p\u00C3\u00A9titeurs' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00EF\u00BF\u00BD R\u00C3\u2030CUP\u00C3\u2030RATION DES R\u00C3\u2030F\u00C3\u2030RENCES PARTAG\u00C3\u2030ES\r\n// =============================================================================\r\n/**\r\n * GET /trees/:treeId/shared-references\r\n * R\u00C3\u00A9cup\u00C3\u00A8re toutes les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es d'un arbre\r\n */\r\nrouter.get('/trees/:treeId/shared-references', async (req, res) => {\r\n  try {\r\n    console.log('\u00F0\u0178\u201D\u2014 [TBL-ROUTES] GET /trees/:treeId/shared-references - D\u00C3\u2030BUT');\r\n    const { treeId } = req.params;\r\n    \r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation (sauf SuperAdmin)\r\n    const treeWhereFilter = isSuperAdmin || !organizationId ? { id: treeId } : { id: treeId, organizationId };\r\n    \r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: treeWhereFilter\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds marqu\u00C3\u00A9s comme r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es\r\n    const sharedReferencesRaw = await prisma.treeBranchLeafNode.findMany({\r\n      where: { \r\n        treeId,\r\n        isSharedReference: true\r\n      }\r\n    });\r\n\r\n    console.log(`\u00F0\u0178\u201D\u2014 [TBL-ROUTES] ${sharedReferencesRaw.length} r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es trouv\u00C3\u00A9es`);\r\n\r\n    // Formater les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es pour le frontend\r\n    const sharedReferences = sharedReferencesRaw.map(node => {\r\n      const response = buildResponseFromColumns(node);\r\n      \r\n      return {\r\n        id: response.id as string,\r\n        label: (response.label || response.sharedReferenceName || 'R\u00C3\u00A9f\u00C3\u00A9rence sans nom') as string,\r\n        category: response.sharedReferenceCategory as string | undefined,\r\n        description: response.sharedReferenceDescription as string | undefined,\r\n        type: response.type as string,\r\n        nodeLabel: response.label as string,\r\n        nodeId: response.id as string\r\n      };\r\n    });\r\n\r\n    console.log(`\u00F0\u0178\u201D\u2014 [TBL-ROUTES] R\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es format\u00C3\u00A9es:`, sharedReferences.map(r => ({ id: r.id, label: r.label, category: r.category })));\r\n    res.json(sharedReferences);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching shared references:', error);\r\n    res.status(500).json({ error: 'Impossible de r\u00C3\u00A9cup\u00C3\u00A9rer les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00EF\u00BF\u00BD\u00F0\u0178\u201D\u0081 DUPLICATION PHYSIQUE DES TEMPLATES REPEATER\r\n// =============================================================================\r\n/**\r\n * POST /nodes/:nodeId/duplicate-templates\r\n * Clone physiquement les templates s\u00C3\u00A9lectionn\u00C3\u00A9s comme enfants du n\u00C5\u201Cud repeater\r\n */\r\nrouter.post('/nodes/:nodeId/duplicate-templates', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { templateNodeIds } = req.body as { templateNodeIds: string[] };\r\n\r\n    console.log('\u00F0\u0178\u201D\u0081 [DUPLICATE-TEMPLATES] Duplication des templates:', { nodeId, templateNodeIds });\r\n\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    if (!Array.isArray(templateNodeIds) || templateNodeIds.length === 0) {\r\n      return res.status(400).json({ error: 'templateNodeIds doit \u00C3\u00AAtre un tableau non vide' });\r\n    }\r\n\r\n    // \u00E2\u0161\u00A0\u00EF\u00B8\u008F IMPORTANT: TreeBranchLeafNode n'a PAS de champ organizationId\r\n    // Il faut passer par l'arbre pour v\u00C3\u00A9rifier l'organisation\r\n    const parentNode = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      include: { TreeBranchLeafTree: true }\r\n    });\r\n\r\n    if (!parentNode) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud parent non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation (sauf SuperAdmin)\r\n    if (!isSuperAdmin && organizationId && parentNode.TreeBranchLeafTree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s non autoris\u00C3\u00A9 \u00C3\u00A0 cet arbre' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les enfants existants pour \u00C3\u00A9viter les doublons\r\n    const existingChildren = await prisma.treeBranchLeafNode.findMany({\r\n      where: { parentId: nodeId },\r\n      select: { id: true, metadata: true }\r\n    });\r\n\r\n    // \u00F0\u0178\u201D\u201E NOUVELLE LOGIQUE: Pour les repeaters, on PEUT cr\u00C3\u00A9er plusieurs copies du m\u00C3\u00AAme template\r\n    // On ne filtre plus les templates - on permet toujours la duplication\r\n    console.log('\u00EF\u00BF\u00BD [DUPLICATE-TEMPLATES] Cr\u00C3\u00A9ation de nouvelles copies autoris\u00C3\u00A9e pour repeater');\r\n    \r\n    const newTemplateIds = templateNodeIds; // Toujours dupliquer tous les templates demand\u00C3\u00A9s\r\n\r\n    console.log('\u00F0\u0178\u2020\u2022 [DUPLICATE-TEMPLATES] Templates \u00C3\u00A0 dupliquer:', newTemplateIds);\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les n\u00C5\u201Cuds templates \u00C3\u00A0 dupliquer (m\u00C3\u00AAme arbre que le parent)\r\n    const templateNodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: { \r\n        id: { in: newTemplateIds }, \r\n        treeId: parentNode.treeId \r\n      }\r\n    });\r\n\r\n    if (templateNodes.length === 0) {\r\n      return res.status(404).json({ error: 'Aucun template trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    console.log(`\u00F0\u0178\u201D\u0081 [DUPLICATE-TEMPLATES] ${templateNodes.length} templates \u00C3\u00A0 dupliquer`);\r\n\r\n    // Dupliquer chaque template en COPIE PROFONDE (utilise deepCopyNodeInternal)\r\n    const duplicatedSummaries: Array<{ id: string; label: string | null; type: string; parentId: string | null; sourceTemplateId: string }> = [];\r\n    const duplicatedNodeIds = new Set<string>();\r\n    for (const template of templateNodes) {\r\n      // Compter les copies existantes + celles cr\u00C3\u00A9\u00C3\u00A9es dans cette passe\r\n      const existingCopiesCount = existingChildren.filter(child => {\r\n        const meta = child.metadata as any;\r\n        return meta?.sourceTemplateId === template.id;\r\n      }).length;\r\n      const createdSoFar = duplicatedSummaries.filter(d => d.sourceTemplateId === template.id).length;\r\n      const copyNumber = existingCopiesCount + createdSoFar + 1;\r\n      const labelSuffix = ` (Copie ${copyNumber})`;\r\n\r\n      const result = await deepCopyNodeInternal(req as unknown as MinimalReq, template.id, {\r\n        targetParentId: nodeId,\r\n        labelSuffix,\r\n        suffixNum: copyNumber,\r\n        preserveSharedReferences: true  // \u00F0\u0178\u201D\u2014 PR\u00C3\u2030SERVER les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es pour les copies de templates\r\n      });\r\n      const newRootId = result.root.newId;\r\n      console.log(`\uD83C\uDFAF [DUPLICATE-TEMPLATES] deepCopyNodeInternal newRootId:`, newRootId, `(type: ${typeof newRootId})`);\r\n\r\n      // Normaliser le label de la copie sur la base du label du gabarit + suffixe num\u00E9rique\r\n      const normalizedCopyLabel = `${template.label || template.id}-${copyNumber}`;\r\n\r\n      // Ajouter/mettre \u00E0 jour les m\u00E9tadonn\u00E9es de tra\u00E7abilit\u00E9 sur la racine copi\u00E9e\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: newRootId },\r\n        data: {\r\n          label: normalizedCopyLabel,\r\n          metadata: {\r\n            ...(typeof template.metadata === 'object' ? template.metadata : {}),\r\n            sourceTemplateId: template.id,\r\n            duplicatedAt: new Date().toISOString(),\r\n            duplicatedFromRepeater: nodeId,\r\n            copiedFromNodeId: template.id,\r\n            copySuffix: copyNumber\r\n          }\r\n        }\r\n      });\r\n\r\n      const created = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: newRootId },\r\n        select: { id: true, label: true, type: true, parentId: true }\r\n      });\r\n      console.log(`\uD83C\uDFAF [DUPLICATE-TEMPLATES] findUnique result for ${newRootId}:`, created ? { id: created.id, label: created.label } : 'NULL');\r\n      \r\n      if (created) {\r\n        duplicatedNodeIds.add(created.id);\r\n        duplicatedSummaries.push({\r\n          id: created.id,\r\n          label: created.label,\r\n          type: created.type,\r\n          parentId: created.parentId,\r\n          sourceTemplateId: template.id\r\n        });\r\n        console.log(`\u00E2\u0153\u2026 [DUPLICATE-TEMPLATES] Template \"${template.label}\" dupliqu\u00C3\u00A9 en profondeur \u00E2\u2020\u2019 \"${created.label}\" (${created.id})`);\r\n\r\n        // \u00F0\u0178\u201D\u2014 Apr\u00C3\u00A8s duplication: cr\u00C3\u00A9er/mapper automatiquement les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es vers leurs COPIES suffix\u00C3\u00A9es \"-N\" (N incr\u00C3\u00A9mental)\r\n        try {\r\n          const r = await applySharedReferencesFromOriginalInternal(req as unknown as MinimalReq, newRootId);\r\n          console.log(`\u00F0\u0178\u201D\u2014 [DUPLICATE-TEMPLATES] R\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es appliqu\u00C3\u00A9es (suffixe -${r.suffix}) pour`, newRootId);\r\n        } catch (e) {\r\n          console.warn('\u00E2\u0161\u00A0\u00EF\u00B8\u008F [DUPLICATE-TEMPLATES] \u00C3\u2030chec application des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es pour', newRootId, e);\r\n        }\r\n\r\n\r\n        // \uD83D\uDD17 APR\u00C8S duplication: Copier les tables des s\u00E9lecteurs\r\n        try {\r\n          const selectorCopyOptions = {\r\n            nodeIdMap: result.idMap,\r\n            tableCopyCache: new Map(),\r\n            tableIdMap: new Map(Object.entries(result.tableIdMap))  // \u2705 Utiliser le tableIdMap peupl\u00E9\r\n          };\r\n          await copySelectorTablesAfterNodeCopy(\r\n            prisma,\r\n            newRootId,\r\n            template.id,\r\n            selectorCopyOptions,\r\n            copyNumber\r\n          );\r\n          console.log(`\u2705 [DUPLICATE-TEMPLATES] Tables des s\u00E9lecteurs copi\u00E9es pour ${newRootId}`);\r\n        } catch (selectorErr) {\r\n          console.warn('\u26A0\uFE0F  [DUPLICATE-TEMPLATES] Erreur lors de la copie des tables des s\u00E9lecteurs pour', newRootId, selectorErr);\r\n        }\r\n\r\n        // \u2139\uFE0F NOTE: Les variables li\u00E9es (linkedVariableIds) sont D\u00C9J\u00C0 copi\u00E9es par deepCopyNodeInternal\r\n        // avec autoCreateDisplayNode: true, donc pas besoin d'appeler copyLinkedVariablesFromNode ici\r\n        console.log(`\u2139\uFE0F [DUPLICATE-TEMPLATES] Variables li\u00E9es d\u00E9j\u00E0 copi\u00E9es par deepCopyNodeInternal pour ${newRootId}`);\r\n\r\n        if (result?.idMap && typeof result.idMap === 'object') {\r\n          Object.values(result.idMap).forEach((newId) => {\r\n            if (typeof newId === 'string' && newId) {\r\n              duplicatedNodeIds.add(newId);\r\n            }\r\n          });\r\n        }\r\n      }\r\n\r\n    }\r\n    console.log(`\u00F0\u0178\u017D\u2030 [DUPLICATE-TEMPLATES] ${duplicatedSummaries.length} n\u00C5\u201Cuds dupliqu\u00C3\u00A9s (deep) avec succ\u00C3\u00A8s`);\r\n\r\n    let duplicatedNodesPayload: Record<string, unknown>[] = [];\r\n    if (duplicatedNodeIds.size > 0) {\r\n      try {\r\n        const nodes = await prisma.treeBranchLeafNode.findMany({\r\n          where: {\r\n            treeId: parentNode.treeId,\r\n            id: { in: Array.from(duplicatedNodeIds) }\r\n          }\r\n        });\r\n        duplicatedNodesPayload = nodes.map(node => buildResponseFromColumns(node));\r\n        console.log(`\uD83D\uDCE6 [DUPLICATE-TEMPLATES] Payload complet g\u00C3\u00A9n\u00C3\u00A9r\u00C3\u00A9 pour ${duplicatedNodesPayload.length} n\u00C5\u201Cuds`);\r\n      } catch (payloadError) {\r\n        console.warn('\u26A0\uFE0F [DUPLICATE-TEMPLATES] Impossible de r\u00C3\u00A9cup\u00C3\u00A9rer le payload complet des nouveaux n\u00C5\u201Cuds', payloadError);\r\n      }\r\n    }\r\n\r\n    res.status(201).json({\r\n      duplicated: duplicatedSummaries.map(n => ({ id: n.id, label: n.label, type: n.type, parentId: n.parentId, sourceTemplateId: n.sourceTemplateId })),\r\n      nodes: duplicatedNodesPayload,\r\n      count: duplicatedSummaries.length\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [DUPLICATE-TEMPLATES] Erreur:', error);\r\n    const msg = error instanceof Error ? error.message : String(error);\r\n    res.status(500).json({ error: 'Erreur lors de la duplication des templates', details: msg });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201C\u00A6 COPIE PROFONDE D'UN N\u00C5\u2019UD (COPIE IND\u00C3\u2030PENDANTE COMPL\u00C3\u02C6TE)\r\n// =============================================================================\r\n/**\r\n * POST /api/treebranchleaf/nodes/:nodeId/deep-copy\r\n * Cr\u00C3\u00A9e une copie ind\u00C3\u00A9pendante compl\u00C3\u00A8te d'un n\u00C5\u201Cud et de toute sa cascade:\r\n * - Tous les descendants (options SELECT, champs enfants, etc.)\r\n * - Les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es (sharedReferenceId/sharedReferenceIds) NE sont PAS mat\u00C3\u00A9rialis\u00C3\u00A9es\r\n *   dans la structure copi\u00C3\u00A9e. Elles restent vides (copie ind\u00C3\u00A9pendante). Une \u00C3\u00A9tape s\u00C3\u00A9par\u00C3\u00A9e\r\n *   peut ensuite les r\u00C3\u00A9appliquer depuis l'original via l'endpoint d\u00C3\u00A9di\u00C3\u00A9.\r\n * - Les formules/conditions/tables li\u00C3\u00A9es sont dupliqu\u00C3\u00A9es et les IDs sont r\u00C3\u00A9\u00C3\u00A9crits dans les JSON (tokens/conditionSet)\r\n * - Tous les IDs sont r\u00C3\u00A9g\u00C3\u00A9n\u00C3\u00A9r\u00C3\u00A9s, sans doublons, avec un mappage old->new retourn\u00C3\u00A9\r\n */\r\n// \u00F0\u0178\u201D\u00A7 Helper r\u00C3\u00A9utilisable pour r\u00C3\u00A9aliser une copie profonde c\u00C3\u00B4t\u00C3\u00A9 serveur (utilis\u00C3\u00A9 par la route et le duplicateur de templates)\r\nasync function deepCopyNodeInternal(\r\n  req: MinimalReq,\r\n  nodeId: string,\r\n  opts?: { targetParentId?: string | null; labelSuffix?: string; suffixNum?: number; preserveSharedReferences?: boolean }\r\n): Promise<{ root: { oldId: string; newId: string }; idMap: Record<string, string>; formulaIdMap: Record<string, string>; conditionIdMap: Record<string, string>; tableIdMap: Record<string, string> }> {\r\n  const { targetParentId, suffixNum, preserveSharedReferences = false } = opts || {};\r\n  \r\n  // Helpers locaux pour la r\u00C3\u00A9\u00C3\u00A9criture des IDs dans tokens/conditions\r\n  const replaceIdsInTokens = (tokens: unknown, idMap: Map<string, string>): unknown => {\r\n    if (!tokens) return tokens;\r\n    const mapOne = (s: string) => s.replace(/@value\\.([A-Za-z0-9_:-]+)/g, (_m, p1: string) => {\r\n      const newId = idMap.get(p1);\r\n      return newId ? `@value.${newId}` : `@value.${p1}`;\r\n    });\r\n    if (Array.isArray(tokens)) return tokens.map(t => typeof t === 'string' ? mapOne(t) : t);\r\n    if (typeof tokens === 'string') return mapOne(tokens);\r\n    try {\r\n      const asStr = JSON.stringify(tokens);\r\n      const replaced = mapOne(asStr);\r\n      return JSON.parse(replaced);\r\n    } catch {\r\n      return tokens;\r\n    }\r\n  };\r\n\r\n  const replaceIdsInConditionSet = (conditionSet: unknown, idMap: Map<string, string>, formulaIdMap: Map<string, string>): unknown => {\r\n    if (!conditionSet) return conditionSet;\r\n    try {\r\n      let str = JSON.stringify(conditionSet);\r\n      // Remplacer les r\u00C3\u00A9f\u00C3\u00A9rences de valeurs @value.<nodeId>\r\n      str = str.replace(/@value\\.([A-Za-z0-9_:-]+)/g, (_m, p1: string) => `@value.${idMap.get(p1) || p1}`);\r\n      // Remplacer les r\u00C3\u00A9f\u00C3\u00A9rences de formules node-formula:<formulaId>\r\n      str = str.replace(/node-formula:([a-f0-9-]{36})/gi, (_m, p1: string) => `node-formula:${formulaIdMap.get(p1) || p1}`);\r\n      return JSON.parse(str);\r\n    } catch {\r\n      return conditionSet;\r\n    }\r\n  };\r\n\r\n  // Charger le n\u00C5\u201Cud source (et l'arbre pour contr\u00C3\u00B4le d'acc\u00C3\u00A8s)\r\n  const source = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    include: { TreeBranchLeafTree: { select: { organizationId: true } } }\r\n  });\r\n  if (!source) {\r\n    throw new Error('N\u00C5\u201Cud source introuvable');\r\n  }\r\n\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n  if (!isSuperAdmin && organizationId && source.TreeBranchLeafTree!.organizationId !== organizationId) {\r\n    throw new Error('Acc\u00C3\u00A8s non autoris\u00C3\u00A9 \u00C3\u00A0 cet arbre');\r\n  }\r\n\r\n  // D\u00C3\u00A9terminer le suffixe num\u00C3\u00A9rique (-N) pour cette copie \r\n  // Si suffixNum est fourni (depuis template duplication), l'utiliser directement\r\n  // Sinon, calculer en cherchant le max existant\r\n  let __copySuffixNum = suffixNum || 1;\r\n  \r\n  if (!suffixNum) {\r\n    // Calcul standard : trouver le max suffix existant\r\n    const existingIdsWithSuffix = await prisma.treeBranchLeafNode.findMany({\r\n      where: { treeId: source.treeId, id: { startsWith: `${source.id}-` } },\r\n      select: { id: true }\r\n    });\r\n    let _maxSuffixNum = 0;\r\n    for (const rec of existingIdsWithSuffix) {\r\n      const rest = rec.id.slice(source.id.length + 1);\r\n      if (/^\\d+$/.test(rest)) {\r\n        const num = Number(rest);\r\n        if (Number.isFinite(num) && num > _maxSuffixNum) _maxSuffixNum = num;\r\n      }\r\n    }\r\n    __copySuffixNum = _maxSuffixNum + 1;\r\n  }\r\n  const __computedLabelSuffix = `-${__copySuffixNum}`;\r\n\r\n  // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds de l'arbre pour une construction de sous-arbre en m\u00C3\u00A9moire\r\n  const allNodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId: source.treeId } });\r\n  const byId = new Map(allNodes.map(n => [n.id, n] as const));\r\n  const childrenByParent = new Map<string, string[]>();\r\n  for (const n of allNodes) {\r\n    if (!n.parentId) continue;\r\n    const arr = childrenByParent.get(n.parentId) || [];\r\n    arr.push(n.id);\r\n    childrenByParent.set(n.parentId, arr);\r\n  }\r\n\r\n  // Construire l'ensemble des n\u00C5\u201Cuds \u00C3\u00A0 copier (seulement le n\u00C5\u201Cud et ses descendants directs)\r\n  const toCopy = new Set<string>();\r\n  const queue: string[] = [source.id];\r\n  while (queue.length) {\r\n    const cur = queue.shift()!;\r\n    if (toCopy.has(cur)) continue;\r\n    toCopy.add(cur);\r\n    // Enfants directs\r\n    const children = childrenByParent.get(cur) || [];\r\n    for (const c of children) queue.push(c);\r\n  }\r\n\r\n  // Mappage des IDs (n\u00C5\u201Cuds et formules/conditions seront g\u00C3\u00A9r\u00C3\u00A9s s\u00C3\u00A9par\u00C3\u00A9ment)\r\n  const idMap = new Map<string, string>();\r\n  for (const oldId of toCopy) idMap.set(oldId, `${oldId}-${__copySuffixNum}`);\r\n\r\n  // Mappage formules/conditions/tables par ancien ID\r\n  const formulaIdMap = new Map<string, string>();\r\n  const conditionIdMap = new Map<string, string>();\r\n  const tableIdMap = new Map<string, string>();\r\n\r\n  // Calcul d'un ordre de cr\u00C3\u00A9ation parents \u00E2\u2020\u2019 enfants\r\n  const buildCreationOrder = (): string[] => {\r\n    // Edges: parent -> child (si parent aussi copi\u00C3\u00A9)\r\n    const edges = new Map<string, Set<string>>();\r\n    const indegree = new Map<string, number>();\r\n    const ensureNode = (id: string) => { if (!edges.has(id)) edges.set(id, new Set()); if (!indegree.has(id)) indegree.set(id, 0); };\r\n\r\n    for (const id of toCopy) ensureNode(id);\r\n\r\n    // parent -> child\r\n    for (const id of toCopy) {\r\n      const n = byId.get(id);\r\n      if (n?.parentId && toCopy.has(n.parentId)) {\r\n        const from = n.parentId;\r\n        const to = id;\r\n        const set = edges.get(from)!; if (!set.has(to)) { set.add(to); indegree.set(to, (indegree.get(to) || 0) + 1); }\r\n      }\r\n    }\r\n\r\n    // Kahn topological sort\r\n    const queue: string[] = [];\r\n    for (const [id, deg] of indegree.entries()) if (deg === 0) queue.push(id);\r\n    const ordered: string[] = [];\r\n    while (queue.length) {\r\n      const id = queue.shift()!;\r\n      ordered.push(id);\r\n      for (const next of edges.get(id) || []) {\r\n        const d = (indegree.get(next) || 0) - 1; indegree.set(next, d);\r\n        if (d === 0) queue.push(next);\r\n      }\r\n    }\r\n\r\n    // Si tout n'est pas ordonn\u00C3\u00A9 (cycle improbable), fallback par profondeur parentale\r\n    if (ordered.length !== toCopy.size) {\r\n      const remaining = new Set(Array.from(toCopy).filter(id => !ordered.includes(id)));\r\n      const depth = new Map<string, number>();\r\n      const getDepth = (id: string): number => {\r\n        if (depth.has(id)) return depth.get(id)!;\r\n        const n = byId.get(id);\r\n        if (!n || !n.parentId || !toCopy.has(n.parentId)) { depth.set(id, 0); return 0; }\r\n        const d = getDepth(n.parentId) + 1; depth.set(id, d); return d;\r\n      };\r\n      const rest = Array.from(remaining).sort((a, b) => getDepth(a) - getDepth(b));\r\n      return [...ordered, ...rest];\r\n    }\r\n    return ordered;\r\n  };\r\n\r\n  const nodesToCreate = buildCreationOrder();\r\n\r\n  // Cr\u00C3\u00A9er tous les n\u00C5\u201Cuds en base avec r\u00C3\u00A9\u00C3\u00A9criture parentId et nettoyage des shared refs (copie ind\u00C3\u00A9pendante)\r\n  const createdNodes: Array<{ oldId: string; newId: string }> = [];\r\n  for (const oldId of nodesToCreate) {\r\n    const oldNode = byId.get(oldId)!;\r\n    const newId = idMap.get(oldId)!;\r\n    const isRoot = oldId === source.id;\r\n\r\n    const newParentId = (() => {\r\n      // Si le parent est dans l\u00E2\u20AC\u2122ensemble copi\u00C3\u00A9 \u00E2\u2020\u2019 utiliser le nouveau parent\r\n      if (oldNode.parentId && toCopy.has(oldNode.parentId)) return idMap.get(oldNode.parentId)!;\r\n      // Sinon, ancrer sous targetParentId si fourni, sinon reproduire le parent d\u00E2\u20AC\u2122origine\r\n      if (isRoot) return targetParentId ?? oldNode.parentId ?? null;\r\n      return oldNode.parentId ?? null;\r\n    })();\r\n\r\n    // Pr\u00C3\u00A9parer les champs \u00C3\u00A0 cloner (sans JSON h\u00C3\u00A9rit\u00C3\u00A9s inutiles)\r\n  const cloneData: Prisma.TreeBranchLeafNodeCreateInput = {\r\n    id: newId,\r\n    treeId: oldNode.treeId,\r\n        type: oldNode.type,\r\n        subType: oldNode.subType,\r\n        fieldType: oldNode.fieldType,\r\n  label: oldNode.label ? `${oldNode.label}${__computedLabelSuffix}` : oldNode.label,\r\n        description: oldNode.description,\r\n        parentId: newParentId,\r\n        order: oldNode.order,\r\n        isVisible: oldNode.isVisible,\r\n        isActive: oldNode.isActive,\r\n        isRequired: oldNode.isRequired,\r\n        isMultiple: oldNode.isMultiple,\r\n        // Capacit\u00C3\u00A9s\r\n        hasData: oldNode.hasData,\r\n        hasFormula: oldNode.hasFormula,\r\n        hasCondition: oldNode.hasCondition,\r\n        hasTable: oldNode.hasTable,\r\n        hasAPI: oldNode.hasAPI,\r\n        hasLink: oldNode.hasLink,\r\n        hasMarkers: oldNode.hasMarkers,\r\n        // Colonnes simples\r\n        defaultValue: oldNode.defaultValue,\r\n        calculatedValue: oldNode.calculatedValue,\r\n        // Apparence / text / number / select / date / image\r\n        appearance_size: oldNode.appearance_size,\r\n        appearance_variant: oldNode.appearance_variant,\r\n        appearance_width: oldNode.appearance_width,\r\n        text_placeholder: oldNode.text_placeholder,\r\n        text_maxLength: oldNode.text_maxLength,\r\n        text_minLength: oldNode.text_minLength,\r\n        text_mask: oldNode.text_mask,\r\n        text_regex: oldNode.text_regex,\r\n        text_rows: oldNode.text_rows,\r\n        text_helpTooltipType: oldNode.text_helpTooltipType,\r\n        text_helpTooltipText: oldNode.text_helpTooltipText,\r\n        text_helpTooltipImage: oldNode.text_helpTooltipImage,\r\n        number_min: oldNode.number_min as unknown as number | undefined,\r\n        number_max: oldNode.number_max as unknown as number | undefined,\r\n        number_step: oldNode.number_step as unknown as number | undefined,\r\n        number_decimals: oldNode.number_decimals,\r\n        number_prefix: oldNode.number_prefix,\r\n        number_suffix: oldNode.number_suffix,\r\n        number_unit: oldNode.number_unit,\r\n        number_defaultValue: oldNode.number_defaultValue as unknown as number | undefined,\r\n        select_multiple: oldNode.select_multiple,\r\n        select_searchable: oldNode.select_searchable,\r\n        select_allowClear: oldNode.select_allowClear,\r\n        select_source: oldNode.select_source ? (() => {\r\n          const source = oldNode.select_source as string;\r\n          if (source.startsWith('@table.')) {\r\n            const tableId = source.substring(7);\r\n            const newTableId = idMap.get(tableId);\r\n            if (newTableId) {\r\n              return `@table.${newTableId}`;\r\n            }\r\n          }\r\n          return source;\r\n        })() : oldNode.select_source,\r\n        select_defaultValue: oldNode.select_defaultValue,\r\n        select_options: oldNode.select_options ? (() => {\r\n          try {\r\n            const str = JSON.stringify(oldNode.select_options);\r\n            let replaced = str.replace(/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/gi, (uuid: string) => idMap.get(uuid) || uuid);\r\n            replaced = replaced.replace(/(node_[a-z0-9_-]+)/gi, (id: string) => idMap.get(id) || id);\r\n            return JSON.parse(replaced) as Prisma.InputJsonValue;\r\n          } catch {\r\n            return oldNode.select_options as Prisma.InputJsonValue;\r\n          }\r\n        })() : oldNode.select_options,\r\n        bool_trueLabel: oldNode.bool_trueLabel,\r\n        bool_falseLabel: oldNode.bool_falseLabel,\r\n        bool_defaultValue: oldNode.bool_defaultValue,\r\n        date_format: oldNode.date_format,\r\n        date_minDate: oldNode.date_minDate,\r\n        date_maxDate: oldNode.date_maxDate,\r\n        date_showTime: oldNode.date_showTime,\r\n        image_maxSize: oldNode.image_maxSize,\r\n        image_ratio: oldNode.image_ratio,\r\n        image_crop: oldNode.image_crop,\r\n        image_thumbnails: oldNode.image_thumbnails ? (() => {\r\n          try {\r\n            const str = JSON.stringify(oldNode.image_thumbnails);\r\n            let replaced = str.replace(/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/gi, (uuid: string) => idMap.get(uuid) || uuid);\r\n            replaced = replaced.replace(/(node_[a-z0-9_-]+)/gi, (id: string) => idMap.get(id) || id);\r\n            return JSON.parse(replaced) as Prisma.InputJsonValue;\r\n          } catch {\r\n            return oldNode.image_thumbnails as Prisma.InputJsonValue;\r\n          }\r\n        })() : oldNode.image_thumbnails,\r\n        link_activeId: oldNode.link_activeId,\r\n        link_carryContext: oldNode.link_carryContext,\r\n        link_mode: oldNode.link_mode,\r\n        link_name: oldNode.link_name,\r\n        link_params: oldNode.link_params ? (() => {\r\n          try {\r\n            const str = JSON.stringify(oldNode.link_params);\r\n            let replaced = str.replace(/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/gi, (uuid: string) => idMap.get(uuid) || uuid);\r\n            replaced = replaced.replace(/(node_[a-z0-9_-]+)/gi, (id: string) => idMap.get(id) || id);\r\n            return JSON.parse(replaced) as Prisma.InputJsonValue;\r\n          } catch {\r\n            return oldNode.link_params as Prisma.InputJsonValue;\r\n          }\r\n        })() : oldNode.link_params,\r\n        link_targetNodeId: oldNode.link_targetNodeId && idMap.has(oldNode.link_targetNodeId) ? idMap.get(oldNode.link_targetNodeId)! : oldNode.link_targetNodeId,\r\n        link_targetTreeId: oldNode.link_targetTreeId,\r\n        // \uD83D\uDCCA TABLE: Copier table_activeId, table_instances et table_name du noeud original\r\n        // \u2705 IMPORTANT: Ajouter le suffixe aux IDs de table pour pointer aux tables copi\u00E9es\r\n        table_activeId: oldNode.table_activeId ? `${oldNode.table_activeId}-${__copySuffixNum}` : null,\r\n        table_instances: (() => {\r\n          console.log('\\n[DEEP-COPY-TABLE] D\u00C9BUT table_instances');\r\n          console.log('[DEEP-COPY-TABLE] oldNode.table_instances existe?', !!oldNode.table_instances);\r\n          console.log('[DEEP-COPY-TABLE] typeof:', typeof oldNode.table_instances);\r\n          console.log('[DEEP-COPY-TABLE] Constructor:', oldNode.table_instances?.constructor?.name);\r\n          console.log('[DEEP-COPY-TABLE] value:', JSON.stringify(oldNode.table_instances).substring(0, 200));\r\n          \r\n          if (!oldNode.table_instances) {\r\n            console.log('[DEEP-COPY-TABLE] RETURN: falsy');\r\n            return oldNode.table_instances;\r\n          }\r\n          \r\n          let rawInstances: Record<string, unknown>;\r\n          try {\r\n            // Toujours parser comme string d'abord\r\n            if (typeof oldNode.table_instances === 'string') {\r\n              console.log('[DEEP-COPY-TABLE] Parsing string JSON');\r\n              rawInstances = JSON.parse(oldNode.table_instances);\r\n            } else if (typeof oldNode.table_instances === 'object') {\r\n              console.log('[DEEP-COPY-TABLE] Objet, stringify + parse');\r\n              rawInstances = JSON.parse(JSON.stringify(oldNode.table_instances));\r\n            } else {\r\n              console.log('[DEEP-COPY-TABLE] Type inconnu, return as-is');\r\n              return oldNode.table_instances;\r\n            }\r\n          } catch (e) {\r\n            console.error('[DEEP-COPY-TABLE] Parse failed:', e);\r\n            return oldNode.table_instances;\r\n          }\r\n          \r\n          console.log('[DEEP-COPY-TABLE] Keys:', Object.keys(rawInstances));\r\n          const updatedInstances: Record<string, unknown> = {};\r\n          for (const [key, value] of Object.entries(rawInstances)) {\r\n            // \u2705 FIX: V\u00E9rifier si la cl\u00E9 a D\u00C9J\u00C0 un suffixe num\u00E9rique (-1, -2, etc.)\r\n            // Ne pas utiliser includes('-') car UUIDs contiennent des tirets!\r\n            const hasSuffixRegex = /-\\d+$/;  // Suffixe num\u00E9rique \u00E0 la fin\r\n            const newKey = hasSuffixRegex.test(key) ? key : `${key}-${__copySuffixNum}`;\r\n            console.log(`[DEEP-COPY-TABLE] Key: \"${key}\" => \"${newKey}\"`);\r\n            \r\n            if (value && typeof value === 'object') {\r\n              const tableInstanceObj = value as Record<string, unknown>;\r\n              const updatedObj = { ...tableInstanceObj };\r\n              if (tableInstanceObj.tableId && typeof tableInstanceObj.tableId === 'string') {\r\n                const oldTableId = tableInstanceObj.tableId;\r\n                // \u2705 FIX: V\u00E9rifier si le tableId a D\u00C9J\u00C0 un suffixe num\u00E9rique (-1, -2, etc.)\r\n                // Ne pas utiliser includes('-') car UUIDs contiennent des tirets!\r\n                const hasSuffixRegex = /-\\d+$/;  // Suffixe num\u00E9rique \u00E0 la fin\r\n                updatedObj.tableId = hasSuffixRegex.test(oldTableId)\r\n                  ? oldTableId \r\n                  : `${oldTableId}-${__copySuffixNum}`;\r\n                console.log(`[DEEP-COPY-TABLE]   tableId: \"${oldTableId}\" => \"${updatedObj.tableId}\"`);\r\n              }\r\n              updatedInstances[newKey] = updatedObj;\r\n            } else {\r\n              updatedInstances[newKey] = value;\r\n            }\r\n          }\r\n          console.log('[DEEP-COPY-TABLE] FINAL result:', JSON.stringify(updatedInstances).substring(0, 200));\r\n          console.log('[DEEP-COPY-TABLE] FIN table_instances\\n');\r\n          return updatedInstances;\r\n        })() as unknown as Prisma.InputJsonValue,\r\n        table_name: oldNode.table_name,\r\n        // R\u00E9p\u00E9ter: recopier la config colonnes repeater telle quelle\r\n        repeater_templateNodeIds: oldNode.repeater_templateNodeIds,\r\n        repeater_templateNodeLabels: oldNode.repeater_templateNodeLabels,\r\n        repeater_minItems: oldNode.repeater_minItems,\r\n        repeater_maxItems: oldNode.repeater_maxItems,\r\n        repeater_addButtonLabel: oldNode.repeater_addButtonLabel,\r\n        repeater_buttonSize: oldNode.repeater_buttonSize,\r\n        repeater_buttonWidth: oldNode.repeater_buttonWidth,\r\n        repeater_iconOnly: oldNode.repeater_iconOnly,\r\n        // METADATA: noter la provenance et supprimer les shared refs (copie ind\u00C3\u00A9pendante)\r\n        metadata: {\r\n          ...(typeof oldNode.metadata === 'object' ? (oldNode.metadata as Record<string, unknown>) : {}),\r\n          copiedFromNodeId: oldNode.id,\r\n          copySuffix: __copySuffixNum,\r\n        } as Prisma.InputJsonValue,\r\n        // SHARED REFS \u00E2\u2020\u2019 conditionnellement pr\u00C3\u00A9serv\u00C3\u00A9es ou supprim\u00C3\u00A9es\r\n        isSharedReference: preserveSharedReferences ? oldNode.isSharedReference : false,\r\n        sharedReferenceId: preserveSharedReferences ? oldNode.sharedReferenceId : null,\r\n        sharedReferenceIds: preserveSharedReferences ? oldNode.sharedReferenceIds : [],\r\n        sharedReferenceName: preserveSharedReferences ? oldNode.sharedReferenceName : null,\r\n        sharedReferenceDescription: preserveSharedReferences ? oldNode.sharedReferenceDescription : null,\r\n        // \uD83D\uDD17 COLONNES LINKED*** : Copier les r\u00E9f\u00E9rences existantes, cr\u00E9er les nouvelles apr\u00E8s\r\n        linkedFormulaIds: Array.isArray(oldNode.linkedFormulaIds) \r\n          ? oldNode.linkedFormulaIds \r\n          : [],\r\n        linkedConditionIds: Array.isArray(oldNode.linkedConditionIds) \r\n          ? oldNode.linkedConditionIds \r\n          : [],\r\n        linkedTableIds: Array.isArray(oldNode.linkedTableIds)\r\n          // \u2705 AJOUTER LES SUFFIXES aux IDs de table ici aussi!\r\n          ? oldNode.linkedTableIds.map(id => `${id}-${__copySuffixNum}`)\r\n          : [],\r\n        linkedVariableIds: Array.isArray(oldNode.linkedVariableIds) \r\n          ? oldNode.linkedVariableIds \r\n          : [],\r\n        updatedAt: new Date(),\r\n    };\r\n\r\n    console.log(`\uD83D\uDE80 [CREATE-NODE] Cr\u00E9ation n\u0153ud ${newId} (${oldNode.label})`);\r\n    console.log(`   oldNode.linkedVariableIds:`, oldNode.linkedVariableIds);\r\n    console.log(`   cloneData.linkedVariableIds:`, cloneData.linkedVariableIds);\r\n\r\n    await prisma.treeBranchLeafNode.create({ data: cloneData });\r\n    createdNodes.push({ oldId, newId });\r\n  }\r\n\r\n  // Dupliquer Formules / Conditions / Tables pour chaque n\u00C5\u201Cud copi\u00C3\u00A9\r\n  for (const { oldId, newId } of createdNodes) {\r\n      // Formules\r\n      const formulas = await prisma.treeBranchLeafNodeFormula.findMany({ where: { nodeId: oldId } });\r\n      for (const f of formulas) {\r\n        const newFormulaId = `${f.id}-${__copySuffixNum}`;\r\n        formulaIdMap.set(f.id, newFormulaId);\r\n        const newTokens = replaceIdsInTokens(f.tokens, idMap) as Prisma.InputJsonValue;\r\n        await prisma.treeBranchLeafNodeFormula.create({\r\n          data: {\r\n            id: newFormulaId,\r\n            nodeId: newId,\r\n            organizationId: f.organizationId,\r\n            name: f.name ? `${f.name}${__computedLabelSuffix}` : f.name,\r\n            tokens: newTokens,\r\n            description: f.description,\r\n            isDefault: f.isDefault,\r\n            order: f.order,\r\n            createdAt: new Date(),\r\n            updatedAt: new Date(),\r\n          }\r\n        });\r\n        // \u00F0\u0178\u201D\u2014 MAJ linkedFormulaIds (propri\u00C3\u00A9taire + inverses r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s)\r\n        try {\r\n          await addToNodeLinkedField(prisma, newId, 'linkedFormulaIds', [newFormulaId]);\r\n          const refs = Array.from(extractNodeIdsFromTokens(newTokens));\r\n          for (const refId of refs) {\r\n            await addToNodeLinkedField(prisma, normalizeRefId(refId), 'linkedFormulaIds', [newFormulaId]);\r\n          }\r\n        } catch (e) {\r\n          console.warn('[TreeBranchLeaf API] Warning updating linkedFormulaIds during deep copy:', (e as Error).message);\r\n        }\r\n      }\r\n\r\n      // Conditions\r\n      const conditions = await prisma.treeBranchLeafNodeCondition.findMany({ where: { nodeId: oldId } });\r\n      for (const c of conditions) {\r\n        const newConditionId = `${c.id}-${__copySuffixNum}`;\r\n        conditionIdMap.set(c.id, newConditionId);\r\n        const newSet = replaceIdsInConditionSet(c.conditionSet, idMap, formulaIdMap) as Prisma.InputJsonValue;\r\n        await prisma.treeBranchLeafNodeCondition.create({\r\n          data: {\r\n            id: newConditionId,\r\n            nodeId: newId,\r\n            organizationId: c.organizationId,\r\n            name: c.name ? `${c.name}${__computedLabelSuffix}` : c.name,\r\n            conditionSet: newSet,\r\n            description: c.description,\r\n            isDefault: c.isDefault,\r\n            order: c.order,\r\n            createdAt: new Date(),\r\n            updatedAt: new Date(),\r\n          }\r\n        });\r\n        // \u00F0\u0178\u201D\u2014 MAJ linkedConditionIds (propri\u00C3\u00A9taire + inverses r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s)\r\n        try {\r\n          await addToNodeLinkedField(prisma, newId, 'linkedConditionIds', [newConditionId]);\r\n          const refs = Array.from(extractNodeIdsFromConditionSet(newSet));\r\n          for (const refId of refs) {\r\n            await addToNodeLinkedField(prisma, normalizeRefId(refId), 'linkedConditionIds', [newConditionId]);\r\n          }\r\n        } catch (e) {\r\n          console.warn('[TreeBranchLeaf API] Warning updating linkedConditionIds during deep copy:', (e as Error).message);\r\n        }\r\n      }\r\n\r\n      // Tables\r\n      const tables = await prisma.treeBranchLeafNodeTable.findMany({\r\n        where: { nodeId: oldId },\r\n        include: { tableColumns: true, tableRows: true }\r\n      });\r\n      for (const t of tables) {\r\n        const newTableId = `${t.id}-${__copySuffixNum}`;\r\n        tableIdMap.set(t.id, newTableId); // \uD83D\uDD17 Tracer la copie\r\n        await prisma.treeBranchLeafNodeTable.create({\r\n          data: {\r\n            id: newTableId,\r\n            nodeId: newId,\r\n            organizationId: t.organizationId,\r\n            name: t.name ? `${t.name}${__computedLabelSuffix}` : t.name,\r\n            description: t.description,\r\n            type: t.type,\r\n            rowCount: t.rowCount,\r\n            columnCount: t.columnCount,\r\n            meta: t.meta as Prisma.InputJsonValue,\r\n            isDefault: t.isDefault,\r\n            order: t.order,\r\n            createdAt: new Date(),\r\n            updatedAt: new Date(),\r\n            lookupDisplayColumns: t.lookupDisplayColumns,\r\n            lookupSelectColumn: t.lookupSelectColumn,\r\n            tableColumns: {\r\n              create: t.tableColumns.map(col => ({\r\n                id: `${col.id}-${__copySuffixNum}`,\r\n                columnIndex: col.columnIndex,\r\n                name: col.name ? `${col.name}${__computedLabelSuffix}` : col.name,\r\n                type: col.type,\r\n                width: col.width,\r\n                format: col.format,\r\n                metadata: col.metadata as Prisma.InputJsonValue,\r\n              }))\r\n            },\r\n            tableRows: {\r\n              create: t.tableRows.map(row => ({\r\n                id: `${row.id}-${__copySuffixNum}`,\r\n                rowIndex: row.rowIndex,\r\n                cells: row.cells as Prisma.InputJsonValue,\r\n              }))\r\n            }\r\n          }\r\n        });\r\n        // \u00F0\u0178\u201D\u2014 MAJ linkedTableIds du n\u00C5\u201Cud propri\u00C3\u00A9taire (pas d'inverse pour table)\r\n        try {\r\n          await addToNodeLinkedField(prisma, newId, 'linkedTableIds', [newTableId]);\r\n        } catch (e) {\r\n          console.warn('[TreeBranchLeaf API] Warning updating linkedTableIds during deep copy:', (e as Error).message);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Cache global pour \u00E9viter de copier deux fois la m\u00EAme variable\r\n        // Cache global pour \u00E9viter de copier deux fois la m\u00EAme variable\r\n        const variableCopyCache = new Map<string, string>();\r\n        \r\n        for (const oldNodeId of toCopy) {\r\n          const newNodeId = idMap.get(oldNodeId)!;\r\n          const oldNode = byId.get(oldNodeId)!;\r\n\r\n          // Mapper les IDs linked du n\u0153ud original vers leurs versions suffix\u00E9es\r\n          // Les formules et conditions doivent aussi avoir le suffixe appliqu\u00E9\r\n          const newLinkedFormulaIds = (Array.isArray(oldNode.linkedFormulaIds) ? oldNode.linkedFormulaIds : [])\r\n            .map(id => {\r\n              const mappedId = formulaIdMap.get(id) || id;\r\n              return `${mappedId}-${__copySuffixNum}`;\r\n            })\r\n            .filter(Boolean);\r\n          \r\n          const newLinkedConditionIds = (Array.isArray(oldNode.linkedConditionIds) ? oldNode.linkedConditionIds : [])\r\n            .map(id => {\r\n              const mappedId = conditionIdMap.get(id) || id;\r\n              return `${mappedId}-${__copySuffixNum}`;\r\n            })\r\n            .filter(Boolean);\r\n          \r\n          const newLinkedTableIds = (Array.isArray(oldNode.linkedTableIds) ? oldNode.linkedTableIds : [])\r\n            .map(id => {\r\n              const mappedId = tableIdMap.get(id) || id;\r\n              return `${mappedId}-${__copySuffixNum}`;\r\n            })\r\n            .filter(Boolean);\r\n          \r\n          const newLinkedVariableIds: string[] = [];\r\n          \r\n          // \uD83D\uDD17 COPIE DES VARIABLES DANS TreeBranchLeafNodeVariable\r\n          console.log(`\\n[DEEP-COPY] \u2B50 COPIE linkedVariableIds pour n\u0153ud ${newNodeId}`);\r\n          console.log(`[DEEP-COPY] Ancien n\u0153ud label: ${oldNode.label}`);\r\n          console.log(`[DEEP-COPY] Ancien n\u0153ud type: ${oldNode.type}, subType: ${oldNode.subType}`);\r\n          console.log(`[DEEP-COPY] linkedVariableIds RAW:`, oldNode.linkedVariableIds);\r\n          \r\n          // \uD83C\uDFAF Cr\u00E9ation syst\u00E9matique des n\u0153uds d'affichage via copyVariableWithCapacities\r\n          // (la fonction choisit la bonne section \"Nouveau Section\" si elle existe)\r\n          const shouldCreateDisplayNodes = true;\r\n          console.log(`[DEEP-COPY] shouldCreateDisplayNodes (forced): ${shouldCreateDisplayNodes}`);\r\n          \r\n          if (Array.isArray(oldNode.linkedVariableIds) && oldNode.linkedVariableIds.length > 0) {\r\n            console.log(`[DEEP-COPY] \u2705 COPIE ${oldNode.linkedVariableIds.length} variable(s)`);\r\n            \r\n            for (const linkedVarId of oldNode.linkedVariableIds) {\r\n              const isSharedRef = typeof linkedVarId === 'string' && linkedVarId.startsWith('shared-ref-');\r\n              console.log(`[DEEP-COPY] Traitement linkedVarId=\"${linkedVarId}\", isSharedRef=${isSharedRef}`);\r\n              \r\n              if (isSharedRef) {\r\n                // \u2705 Shared Reference : GARDER tel quel\r\n                console.log(`[DEEP-COPY] PRESERVED SHARED: ${linkedVarId}`);\r\n                newLinkedVariableIds.push(linkedVarId);\r\n              } else {\r\n                // \uD83D\uDCE6 Variable Normale UUID : COPIER avec ou sans n\u0153ud d'affichage\r\n                const newVarId = `${linkedVarId}-${__copySuffixNum}`;\r\n                console.log(`[DEEP-COPY] COPYING NORMAL VAR: ${linkedVarId} \u2192 ${newVarId}`);\r\n                \r\n                try {\r\n                  if (shouldCreateDisplayNodes) {\r\n                    // \uD83C\uDFAF Utiliser copyVariableWithCapacities pour cr\u00E9er le n\u0153ud d'affichage\r\n                    console.log(`[DEEP-COPY] \uD83C\uDFAF Appel copyVariableWithCapacities avec autoCreateDisplayNode=true`);\r\n                    const copyResult = await copyVariableWithCapacities(\r\n                      linkedVarId,\r\n                      __copySuffixNum,\r\n                      newNodeId,\r\n                      prisma,\r\n                      {\r\n                        formulaIdMap,\r\n                        conditionIdMap,\r\n                        tableIdMap,\r\n                        nodeIdMap: idMap,\r\n                        variableCopyCache,\r\n                        autoCreateDisplayNode: true,\r\n                        displayNodeAlreadyCreated: false\r\n                      }\r\n                    );\r\n                    \r\n                    if (copyResult.success) {\r\n                      console.log(`[DEEP-COPY] \u2705 Created with display node: ${copyResult.variableId}`);\r\n                      newLinkedVariableIds.push(copyResult.variableId);\r\n                    } else {\r\n                      console.error(`[DEEP-COPY] \u274C Copy failed: ${copyResult.error}`);\r\n                      newLinkedVariableIds.push(linkedVarId);\r\n                    }\r\n                  }\r\n                } catch (e) {\r\n                  console.error(`[DEEP-COPY] \u274C Exception: ${(e as Error).message}`);\r\n                  newLinkedVariableIds.push(linkedVarId);\r\n                }\r\n              }\r\n            }\r\n            \r\n            console.log(`[DEEP-COPY] DONE - Total: ${newLinkedVariableIds.length}`);\r\n          } else {\r\n            console.log(`[DEEP-COPY] NO linked variables`);\r\n          }\r\n\r\n          // UPDATE le n\u0153ud avec les linked*** correctes\r\n          if (newLinkedFormulaIds.length > 0 || newLinkedConditionIds.length > 0 || newLinkedTableIds.length > 0 || newLinkedVariableIds.length > 0) {\r\n            try {\r\n              await prisma.treeBranchLeafNode.update({\r\n                where: { id: newNodeId },\r\n                data: {\r\n                  linkedFormulaIds: newLinkedFormulaIds.length > 0 ? { set: newLinkedFormulaIds } : { set: [] },\r\n                  linkedConditionIds: newLinkedConditionIds.length > 0 ? { set: newLinkedConditionIds } : { set: [] },\r\n                  linkedTableIds: newLinkedTableIds.length > 0 ? { set: newLinkedTableIds } : { set: [] },\r\n                  linkedVariableIds: newLinkedVariableIds.length > 0 ? { set: newLinkedVariableIds } : { set: [] },\r\n                }\r\n              });\r\n              console.log(`\u2705 [DEEP-COPY] N\u0153ud ${newNodeId} mis \u00E0 jour - linkedFormulaIds: ${newLinkedFormulaIds.length}, linkedConditionIds: ${newLinkedConditionIds.length}, linkedTableIds: ${newLinkedTableIds.length}, linkedVariableIds: ${newLinkedVariableIds.length}`);\r\n            } catch (e) {\r\n              console.warn(`\u26A0\uFE0F [DEEP-COPY] Erreur lors du UPDATE des linked*** pour ${newNodeId}:`, (e as Error).message);\r\n            }\r\n          }\r\n\r\n\r\n        }\r\n\r\n        const rootNewId = idMap.get(source.id)!;\r\n        return {\r\n          root: { oldId: source.id, newId: rootNewId },\r\n          idMap: Object.fromEntries(idMap),\r\n          formulaIdMap: Object.fromEntries(formulaIdMap),\r\n          conditionIdMap: Object.fromEntries(conditionIdMap),\r\n          tableIdMap: Object.fromEntries(tableIdMap)\r\n        };\r\n      }\r\n\r\n      router.post('/nodes/:nodeId/deep-copy', async (req, res) => {\r\n        try {\r\n          const { nodeId } = req.params;\r\n          const { targetParentId, labelSuffix } = (req.body || {}) as { targetParentId?: string | null; labelSuffix?: string };\r\n          const result = await deepCopyNodeInternal(req as unknown as MinimalReq, nodeId, { targetParentId, labelSuffix });\r\n          res.json(result);\r\n        } catch (error) {\r\n          console.error('\u00E2\u009D\u0152 [/nodes/:nodeId/deep-copy] Erreur:', error);\r\n          res.status(500).json({ error: 'Erreur lors de la copie profonde' });\r\n        }\r\n      });\r\n\r\n\r\n// POST /api/treebranchleaf/trees/:treeId/nodes - Cr\u00C3\u00A9er un n\u00C5\u201Cud\r\nrouter.post('/trees/:treeId/nodes', async (req, res) => {\r\n  try {\r\n    const { treeId } = req.params;\r\n    const { organizationId } = req.user!;\r\n    const nodeData = req.body;\r\n\r\n    console.log('[TreeBranchLeaf API] Creating node:', { treeId, nodeData });\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: { id: treeId, organizationId }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier les champs obligatoires\r\n    if (!nodeData.type || !nodeData.label) {\r\n      return res.status(400).json({ error: 'Les champs type et label sont obligatoires' });\r\n    }\r\n\r\n    // \u00F0\u0178\u0161\u00A8 VALIDATION DES TYPES AUTORIS\u00C3\u2030S\r\n    const allowedTypes = [\r\n      'branch',                 // Branche = conteneur hi\u00C3\u00A9rarchique\r\n      'section',               // Section = groupe de champs calcul\u00C3\u00A9s\r\n      'leaf_field',            // Champ standard (text, email, etc.)\r\n      'leaf_option',           // Option pour un champ SELECT\r\n      'leaf_option_field',     // Option + Champ (combin\u00C3\u00A9) \u00E2\u2020\u0090 ajout\u00C3\u00A9 pour d\u00C3\u00A9bloquer O+C\r\n      'leaf_text',             // Champ texte simple\r\n      'leaf_email',            // Champ email\r\n      'leaf_phone',            // Champ t\u00C3\u00A9l\u00C3\u00A9phone\r\n      'leaf_date',             // Champ date\r\n      'leaf_number',           // Champ num\u00C3\u00A9rique\r\n      'leaf_checkbox',         // Case \u00C3\u00A0 cocher\r\n      'leaf_select',           // Liste d\u00C3\u00A9roulante\r\n      'leaf_radio',            // Boutons radio\r\n      'leaf_repeater'          // Bloc r\u00C3\u00A9p\u00C3\u00A9table (conteneur de champs r\u00C3\u00A9p\u00C3\u00A9tables)\r\n    ];\r\n\r\n    if (!allowedTypes.includes(nodeData.type)) {\r\n      return res.status(400).json({ \r\n        error: `Type de n\u00C5\u201Cud non autoris\u00C3\u00A9: ${nodeData.type}. Types autoris\u00C3\u00A9s: ${allowedTypes.join(', ')}` \r\n      });\r\n    }\r\n\r\n    // \u00F0\u0178\u0161\u00A8 VALIDATION HI\u00C3\u2030RARCHIQUE STRICTE - Utilisation des r\u00C3\u00A8gles centralis\u00C3\u00A9es\r\n    if (nodeData.parentId) {\r\n      const parentNode = await prisma.treeBranchLeafNode.findFirst({\r\n        where: { id: nodeData.parentId, treeId }\r\n      });\r\n\r\n      if (!parentNode) {\r\n        return res.status(400).json({ error: 'N\u00C5\u201Cud parent non trouv\u00C3\u00A9' });\r\n      }\r\n\r\n      // Convertir les types de n\u00C5\u201Cuds pour utiliser les r\u00C3\u00A8gles centralis\u00C3\u00A9es\r\n      const parentType = parentNode.type as NodeType;\r\n      const parentSubType = parentNode.subType as NodeSubType;\r\n      const childType = nodeData.type as NodeType;\r\n      const childSubType = (nodeData.subType || nodeData.fieldType || 'data') as NodeSubType;\r\n\r\n      // Utiliser la validation centralis\u00C3\u00A9e\r\n      const validationResult = validateParentChildRelation(\r\n        parentType,\r\n        parentSubType,\r\n        childType,\r\n        childSubType\r\n      );\r\n\r\n      if (!validationResult.isValid) {\r\n        const errorMessage = getValidationErrorMessage(\r\n          parentType,\r\n          parentSubType,\r\n          childType,\r\n          childSubType\r\n        );\r\n        console.log(`[TreeBranchLeaf API] Validation failed: ${errorMessage}`);\r\n        return res.status(400).json({ \r\n          error: errorMessage \r\n        });\r\n      }\r\n\r\n      console.log(`[TreeBranchLeaf API] Validation passed: ${parentType}(${parentSubType}) -> ${childType}(${childSubType})`);\r\n    } else {\r\n      // Pas de parent = cr\u00C3\u00A9ation directement sous l'arbre racine\r\n      // Utiliser la validation centralis\u00C3\u00A9e pour v\u00C3\u00A9rifier si c'est autoris\u00C3\u00A9\r\n      const childType = nodeData.type as NodeType;\r\n      const childSubType = (nodeData.subType || nodeData.fieldType || 'data') as NodeSubType;\r\n\r\n      const validationResult = validateParentChildRelation(\r\n        'tree',\r\n        'data',\r\n        childType,\r\n        childSubType\r\n      );\r\n\r\n      if (!validationResult.isValid) {\r\n        const errorMessage = getValidationErrorMessage(\r\n          'tree',\r\n          'data',\r\n          childType,\r\n          childSubType\r\n        );\r\n        console.log(`[TreeBranchLeaf API] Root validation failed: ${errorMessage}`);\r\n        return res.status(400).json({ \r\n          error: errorMessage \r\n        });\r\n      }\r\n\r\n      console.log(`[TreeBranchLeaf API] Root validation passed: tree -> ${childType}(${childSubType})`);\r\n    }\r\n\r\n    // G\u00C3\u00A9n\u00C3\u00A9rer un ID unique pour le n\u00C5\u201Cud\r\n    const { randomUUID } = await import('crypto');\r\n    const nodeId = randomUUID();\r\n\r\n    const node = await prisma.treeBranchLeafNode.create({\r\n      data: {\r\n        id: nodeId,\r\n        treeId,\r\n        type: nodeData.type,\r\n        subType: nodeData.subType || nodeData.fieldType || 'data',\r\n        label: nodeData.label,\r\n        description: nodeData.description || null,\r\n        parentId: nodeData.parentId || null,\r\n        order: nodeData.order ?? 0,\r\n  isVisible: nodeData.isVisible ?? true,\r\n  isActive: nodeData.isActive ?? true,\r\n  // Par d\u00C3\u00A9faut, AUCUNE capacit\u00C3\u00A9 n'est activ\u00C3\u00A9e automatiquement\r\n  hasData: nodeData.hasData ?? false,\r\n  hasFormula: nodeData.hasFormula ?? false,\r\n  hasCondition: nodeData.hasCondition ?? false,\r\n  hasTable: nodeData.hasTable ?? false,\r\n  hasAPI: nodeData.hasAPI ?? false,\r\n  hasLink: nodeData.hasLink ?? false,\r\n  hasMarkers: nodeData.hasMarkers ?? false,\r\n        metadata: nodeData.metadata ?? {},\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log('[TreeBranchLeaf API] Node created successfully:', node.id);\r\n    res.status(201).json(node);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error creating node:', error);\r\n    res.status(500).json({ error: 'Impossible de cr\u00C3\u00A9er le n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// ============================================================================= \r\n// \u00F0\u0178\u201D\u201E HELPER : Conversion JSON metadata vers colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n// =============================================================================\r\n\r\n/**\r\n * Convertit les donn\u00C3\u00A9es JSON des metadata vers les nouvelles colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n */\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u201E MIGRATION JSON \u00E2\u2020\u2019 COLONNES D\u00C3\u2030DI\u00C3\u2030ES\r\n// =============================================================================\r\n\r\n/**\r\n * \u00F0\u0178\u201D\u201E STRAT\u00C3\u2030GIE MIGRATION : JSON \u00E2\u2020\u2019 Colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n * Extraite TOUTES les donn\u00C3\u00A9es depuis metadata et fieldConfig pour les mapper vers les nouvelles colonnes\r\n * OBJECTIF : Plus jamais de JSON, une seule source de v\u00C3\u00A9rit\u00C3\u00A9\r\n */\r\nfunction mapJSONToColumns(updateData: Record<string, unknown>): Record<string, unknown> {\r\n  const columnData: Record<string, unknown> = {};\r\n  \r\n  // \u00E2\u0153\u2026 PROTECTION D\u00C3\u2030FENSIVE - V\u00C3\u00A9rifier la structure des donn\u00C3\u00A9es\r\n  if (!updateData || typeof updateData !== 'object') {\r\n    console.log('\u00F0\u0178\u201D\u201E [mapJSONToColumns] \u00E2\u009D\u0152 updateData invalide:', updateData);\r\n    return columnData;\r\n  }\r\n  \r\n  // Extraire les metadata et fieldConfig si pr\u00C3\u00A9sentes avec protection\r\n  const metadata = (updateData.metadata && typeof updateData.metadata === 'object' ? updateData.metadata as Record<string, unknown> : {});\r\n  const fieldConfig = (updateData.fieldConfig && typeof updateData.fieldConfig === 'object' ? updateData.fieldConfig as Record<string, unknown> : {});\r\n  const appearanceConfig = (updateData.appearanceConfig && typeof updateData.appearanceConfig === 'object' ? updateData.appearanceConfig as Record<string, unknown> : {});\r\n  \r\n  console.log('\u00F0\u0178\u201D\u201E [mapJSONToColumns] Entr\u00C3\u00A9es d\u00C3\u00A9tect\u00C3\u00A9es:', {\r\n    hasMetadata: Object.keys(metadata).length > 0,\r\n    hasFieldConfig: Object.keys(fieldConfig).length > 0,\r\n    hasAppearanceConfig: Object.keys(appearanceConfig).length > 0,\r\n    metadataKeys: Object.keys(metadata),\r\n    fieldConfigKeys: Object.keys(fieldConfig),\r\n    appearanceConfigKeys: Object.keys(appearanceConfig)\r\n  });\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 1 : Migration depuis appearanceConfig (NOUVEAU syst\u00C3\u00A8me prioritaire)\r\n  if (Object.keys(appearanceConfig).length > 0) {\r\n    console.log('\u00F0\u0178\u201D\u201E [mapJSONToColumns] Traitement appearanceConfig:', appearanceConfig);\r\n    if (appearanceConfig.size) columnData.appearance_size = appearanceConfig.size;\r\n    if (appearanceConfig.width) columnData.appearance_width = appearanceConfig.width;\r\n    if (appearanceConfig.variant) columnData.appearance_variant = appearanceConfig.variant;\r\n    // Copier tous les autres champs d'apparence possibles\r\n    if (appearanceConfig.textSize) columnData.appearance_size = appearanceConfig.textSize;\r\n    if (appearanceConfig.fieldWidth) columnData.appearance_width = appearanceConfig.fieldWidth;\r\n    if (appearanceConfig.fieldVariant) columnData.appearance_variant = appearanceConfig.fieldVariant;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 1bis : Migration depuis metadata.appearance (fallback)\r\n  if (metadata.appearance && typeof metadata.appearance === 'object') {\r\n    const metaAppearance = metadata.appearance as Record<string, unknown>;\r\n    console.log('\u00F0\u0178\u201D\u201E [mapJSONToColumns] Traitement metadata.appearance:', metaAppearance);\r\n    if (metaAppearance.size && !columnData.appearance_size) columnData.appearance_size = metaAppearance.size;\r\n    if (metaAppearance.width && !columnData.appearance_width) columnData.appearance_width = metaAppearance.width;\r\n    if (metaAppearance.variant && !columnData.appearance_variant) columnData.appearance_variant = metaAppearance.variant;\r\n  }\r\n\r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 1ter : Migration depuis metadata.repeater (NOUVEAU)\r\n  if (metadata.repeater && typeof metadata.repeater === 'object') {\r\n    const repeaterMeta = metadata.repeater as Record<string, unknown>;\r\n    console.log('\u00F0\u0178\u201D\u201E [mapJSONToColumns] \u00F0\u0178\u201D\u00A5 Traitement metadata.repeater:', repeaterMeta);\r\n    \r\n    // Sauvegarder templateNodeIds en JSON dans la colonne d\u00C3\u00A9di\u00C3\u00A9e\r\n    if (repeaterMeta.templateNodeIds && Array.isArray(repeaterMeta.templateNodeIds)) {\r\n      columnData.repeater_templateNodeIds = JSON.stringify(repeaterMeta.templateNodeIds);\r\n      console.log('\u00E2\u0153\u2026 [mapJSONToColumns] repeater_templateNodeIds sauvegard\u00C3\u00A9:', repeaterMeta.templateNodeIds);\r\n    }\r\n    \r\n    // \u00F0\u0178\u008F\u00B7\u00EF\u00B8\u008F SAUVEGARDER templateNodeLabels en JSON dans la colonne d\u00C3\u00A9di\u00C3\u00A9e\r\n    if (repeaterMeta.templateNodeLabels && typeof repeaterMeta.templateNodeLabels === 'object') {\r\n      columnData.repeater_templateNodeLabels = JSON.stringify(repeaterMeta.templateNodeLabels);\r\n      console.log('\u00E2\u0153\u2026 [mapJSONToColumns] \u00F0\u0178\u008F\u00B7\u00EF\u00B8\u008F repeater_templateNodeLabels sauvegard\u00C3\u00A9:', repeaterMeta.templateNodeLabels);\r\n    } else if ('templateNodeLabels' in repeaterMeta) {\r\n      columnData.repeater_templateNodeLabels = null;\r\n    }\r\n    \r\n    if (repeaterMeta.minItems !== undefined) columnData.repeater_minItems = repeaterMeta.minItems;\r\n    if (repeaterMeta.maxItems !== undefined) columnData.repeater_maxItems = repeaterMeta.maxItems;\r\n    if (repeaterMeta.addButtonLabel) columnData.repeater_addButtonLabel = repeaterMeta.addButtonLabel;\r\n    if (repeaterMeta.buttonSize) columnData.repeater_buttonSize = repeaterMeta.buttonSize;\r\n    if (repeaterMeta.buttonWidth) columnData.repeater_buttonWidth = repeaterMeta.buttonWidth;\r\n    if (repeaterMeta.iconOnly !== undefined) columnData.repeater_iconOnly = repeaterMeta.iconOnly;\r\n  }\r\n\r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE X : Migration pour subTabs / subTab\r\n  if (Array.isArray(metadata.subTabs)) {\r\n    // Sauvegarder la liste en JSON dans la colonne d\u00E9di\u00E9e 'subtabs'\r\n    columnData.subtabs = JSON.stringify(metadata.subTabs);\r\n    console.log('\u00F0\u0178\u2019\u00A4 [mapJSONToColumns] subtabs column sauvegard\u00E9e:', metadata.subTabs);\r\n  }\r\n  if (metadata.subTab !== undefined) {\r\n    if (Array.isArray(metadata.subTab)) {\r\n      columnData.subtab = metadata.subTab.length ? JSON.stringify(metadata.subTab) : null;\r\n    } else {\r\n      columnData.subtab = metadata.subTab || null;\r\n    }\r\n    console.log('\u00F0\u0178\u2019\u00A4 [mapJSONToColumns] subtab column sauvegard\u00E9e:', metadata.subTab);\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 2 : Migration configuration champs texte\r\n  const textConfig = metadata.textConfig || fieldConfig.text || fieldConfig.textConfig || {};\r\n  if (Object.keys(textConfig).length > 0) {\r\n    if (textConfig.placeholder) columnData.text_placeholder = textConfig.placeholder;\r\n    if (textConfig.maxLength) columnData.text_maxLength = textConfig.maxLength;\r\n    if (textConfig.minLength) columnData.text_minLength = textConfig.minLength;\r\n    if (textConfig.mask) columnData.text_mask = textConfig.mask;\r\n    if (textConfig.regex) columnData.text_regex = textConfig.regex;\r\n    if (textConfig.rows) columnData.text_rows = textConfig.rows;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 3 : Migration configuration champs nombre\r\n  const numberConfig = metadata.numberConfig || fieldConfig.number || fieldConfig.numberConfig || {};\r\n  if (Object.keys(numberConfig).length > 0) {\r\n    if (numberConfig.min !== undefined) columnData.number_min = numberConfig.min;\r\n    if (numberConfig.max !== undefined) columnData.number_max = numberConfig.max;\r\n    if (numberConfig.step !== undefined) columnData.number_step = numberConfig.step;\r\n    if (numberConfig.decimals !== undefined) columnData.number_decimals = numberConfig.decimals;\r\n    if (numberConfig.prefix) columnData.number_prefix = numberConfig.prefix;\r\n    if (numberConfig.suffix) columnData.number_suffix = numberConfig.suffix;\r\n    if (numberConfig.unit) columnData.number_unit = numberConfig.unit;\r\n    if (numberConfig.defaultValue !== undefined) columnData.number_defaultValue = numberConfig.defaultValue;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 4 : Migration configuration champs s\u00C3\u00A9lection\r\n  const selectConfig = metadata.selectConfig || fieldConfig.select || fieldConfig.selectConfig || {};\r\n  if (Object.keys(selectConfig).length > 0) {\r\n    if (selectConfig.multiple !== undefined) columnData.select_multiple = selectConfig.multiple;\r\n    if (selectConfig.searchable !== undefined) columnData.select_searchable = selectConfig.searchable;\r\n    if (selectConfig.allowClear !== undefined) columnData.select_allowClear = selectConfig.allowClear;\r\n    if (selectConfig.defaultValue) columnData.select_defaultValue = selectConfig.defaultValue;\r\n    if (selectConfig.options) columnData.select_options = selectConfig.options;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 5 : Migration configuration champs bool\u00C3\u00A9en\r\n  const boolConfig = metadata.boolConfig || fieldConfig.bool || fieldConfig.boolConfig || {};\r\n  if (Object.keys(boolConfig).length > 0) {\r\n    if (boolConfig.trueLabel) columnData.bool_trueLabel = boolConfig.trueLabel;\r\n    if (boolConfig.falseLabel) columnData.bool_falseLabel = boolConfig.falseLabel;\r\n    if (boolConfig.defaultValue !== undefined) columnData.bool_defaultValue = boolConfig.defaultValue;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 6 : Migration configuration champs date\r\n  const dateConfig = metadata.dateConfig || fieldConfig.date || fieldConfig.dateConfig || {};\r\n  if (Object.keys(dateConfig).length > 0) {\r\n    if (dateConfig.format) columnData.date_format = dateConfig.format;\r\n    if (dateConfig.showTime !== undefined) columnData.date_showTime = dateConfig.showTime;\r\n    if (dateConfig.minDate) columnData.date_minDate = new Date(dateConfig.minDate);\r\n    if (dateConfig.maxDate) columnData.date_maxDate = new Date(dateConfig.maxDate);\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 7 : Migration configuration champs image\r\n  const imageConfig = metadata.imageConfig || fieldConfig.image || fieldConfig.imageConfig || {};\r\n  if (Object.keys(imageConfig).length > 0) {\r\n    if (imageConfig.maxSize) columnData.image_maxSize = imageConfig.maxSize;\r\n    if (imageConfig.ratio) columnData.image_ratio = imageConfig.ratio;\r\n    if (imageConfig.crop !== undefined) columnData.image_crop = imageConfig.crop;\r\n    if (imageConfig.thumbnails) columnData.image_thumbnails = imageConfig.thumbnails;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 8 : Migration configuration tooltips d'aide\r\n  if (Object.keys(appearanceConfig).length > 0) {\r\n    if (appearanceConfig.helpTooltipType !== undefined) columnData.text_helpTooltipType = appearanceConfig.helpTooltipType;\r\n    if (appearanceConfig.helpTooltipText !== undefined) columnData.text_helpTooltipText = appearanceConfig.helpTooltipText;\r\n    if (appearanceConfig.helpTooltipImage !== undefined) columnData.text_helpTooltipImage = appearanceConfig.helpTooltipImage;\r\n  }\r\n  \r\n  // \u00E2\u0153\u2026 \u00C3\u2030TAPE 9 : Types de champs sp\u00C3\u00A9cifiques\r\n  if (updateData.fieldType) columnData.fieldType = updateData.fieldType;\r\n  if (updateData.fieldSubType) columnData.fieldSubType = updateData.fieldSubType;\r\n  if (updateData.subType) columnData.fieldSubType = updateData.subType;\r\n  if (updateData.type) columnData.fieldType = updateData.type;\r\n  \r\n  console.log('\u00F0\u0178\u201D\u201E [mapJSONToColumns] Migration JSON vers colonnes:', {\r\n    input: { metadata: !!metadata, fieldConfig: !!fieldConfig },\r\n    output: Object.keys(columnData),\r\n    columnDataPreview: columnData\r\n  });\r\n  \r\n  return columnData;\r\n}\r\n\r\n/**\r\n * \u00F0\u0178\u201C\u00A4 NETTOYER LA R\u00C3\u2030PONSE : Colonnes d\u00C3\u00A9di\u00C3\u00A9es \u00E2\u2020\u2019 Interface frontend\r\n * Reconstruit les objets JSON pour la compatibilit\u00C3\u00A9 frontend MAIS depuis les colonnes\r\n */\r\nfunction buildResponseFromColumns(node: any): Record<string, unknown> {\r\n  type LegacyRepeaterMeta = {\r\n    templateNodeIds?: unknown;\r\n    templateNodeLabels?: unknown;\r\n    minItems?: number | null;\r\n    maxItems?: number | null;\r\n    addButtonLabel?: string | null;\r\n  };\r\n  // Construire l'objet appearance depuis les colonnes\r\n  const appearance = {\r\n    size: node.appearance_size || 'md',\r\n    width: node.appearance_width || null,\r\n    variant: node.appearance_variant || null,\r\n    // \u00F0\u0178\u201D\u00A5 TOOLTIP FIX : Inclure les champs tooltip dans metadata.appearance\r\n    helpTooltipType: node.text_helpTooltipType || 'none',\r\n    helpTooltipText: node.text_helpTooltipText || null,\r\n    helpTooltipImage: node.text_helpTooltipImage || null\r\n  };\r\n\r\n  // \u00F0\u0178\u201D\u00A5 NOUVEAU : Construire l'objet repeater depuis les colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n  const legacyRepeater: LegacyRepeaterMeta | null = (() => {\r\n    if (node.metadata && typeof node.metadata === 'object' && (node.metadata as Record<string, unknown>).repeater) {\r\n      const legacy = (node.metadata as Record<string, unknown>).repeater;\r\n      return typeof legacy === 'object' && legacy !== null ? legacy as LegacyRepeaterMeta : null;\r\n    }\r\n    return null;\r\n  })();\r\n\r\n  const repeater = {\r\n    templateNodeIds: (() => {\r\n      if (node.repeater_templateNodeIds) {\r\n        try {\r\n          const parsed = JSON.parse(node.repeater_templateNodeIds);\r\n          console.log('\u00E2\u0153\u2026 [buildResponseFromColumns] repeater_templateNodeIds reconstruit:', parsed);\r\n          return Array.isArray(parsed) ? parsed : [];\r\n        } catch (e) {\r\n          console.error('\u00E2\u009D\u0152 [buildResponseFromColumns] Erreur parse repeater_templateNodeIds:', e);\r\n          return [];\r\n        }\r\n      }\r\n      const legacyIds = legacyRepeater?.templateNodeIds;\r\n      if (Array.isArray(legacyIds)) {\r\n        return legacyIds as string[];\r\n      }\r\n      return [];\r\n    })(),\r\n    templateNodeLabels: (() => {\r\n      if (node.repeater_templateNodeLabels) {\r\n        try {\r\n          const parsedLabels = JSON.parse(node.repeater_templateNodeLabels);\r\n          return parsedLabels && typeof parsedLabels === 'object' ? parsedLabels : null;\r\n        } catch (e) {\r\n          console.error('\u00E2\u009D\u0152 [buildResponseFromColumns] Erreur parse repeater_templateNodeLabels:', e);\r\n        }\r\n      }\r\n      const legacyLabels = legacyRepeater?.templateNodeLabels;\r\n      if (legacyLabels && typeof legacyLabels === 'object') {\r\n        return legacyLabels as Record<string, string>;\r\n      }\r\n      return null;\r\n    })(),\r\n    minItems: node.repeater_minItems ?? legacyRepeater?.minItems ?? 0,\r\n    maxItems: node.repeater_maxItems ?? legacyRepeater?.maxItems ?? null,\r\n    addButtonLabel: node.repeater_addButtonLabel || legacyRepeater?.addButtonLabel || null,\r\n    buttonSize: node.repeater_buttonSize || legacyRepeater?.buttonSize || 'middle',\r\n    buttonWidth: node.repeater_buttonWidth || legacyRepeater?.buttonWidth || 'auto',\r\n    iconOnly: node.repeater_iconOnly ?? legacyRepeater?.iconOnly ?? false\r\n  };\r\n  \r\n  // \u00F0\u0178\u017D\u00AF CORRECTION CRITIQUE : Construire aussi appearanceConfig pour l'interface Parameters\r\n  const appearanceConfig = {\r\n    size: node.appearance_size || 'md',\r\n    variant: node.appearance_variant || 'singleline',\r\n    placeholder: node.text_placeholder || '',\r\n    maxLength: node.text_maxLength || 255,\r\n    mask: node.text_mask || '',\r\n    regex: node.text_regex || '',\r\n    helpTooltipType: node.text_helpTooltipType || 'none',\r\n    helpTooltipText: node.text_helpTooltipText || null,\r\n    helpTooltipImage: node.text_helpTooltipImage || null\r\n  };\r\n  \r\n  // Construire fieldConfig depuis les colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n  const fieldConfig = {\r\n    text: {\r\n      placeholder: node.text_placeholder || null,\r\n      maxLength: node.text_maxLength || null,\r\n      minLength: node.text_minLength || null,\r\n      mask: node.text_mask || null,\r\n      regex: node.text_regex || null,\r\n      rows: node.text_rows || 3\r\n    },\r\n    number: {\r\n      min: node.number_min || null,\r\n      max: node.number_max || null,\r\n      step: node.number_step || 1,\r\n      decimals: node.number_decimals || 0,\r\n      prefix: node.number_prefix || null,\r\n      suffix: node.number_suffix || null,\r\n      unit: node.number_unit || null,\r\n      defaultValue: node.number_defaultValue || null\r\n    },\r\n    select: {\r\n      multiple: node.select_multiple || false,\r\n      searchable: node.select_searchable !== false, // true par d\u00C3\u00A9faut\r\n      allowClear: node.select_allowClear !== false, // true par d\u00C3\u00A9faut\r\n      defaultValue: node.select_defaultValue || null,\r\n      options: node.select_options || []\r\n    },\r\n    bool: {\r\n      trueLabel: node.bool_trueLabel || null,\r\n      falseLabel: node.bool_falseLabel || null,\r\n      defaultValue: node.bool_defaultValue || null\r\n    },\r\n    date: {\r\n      format: node.date_format || 'DD/MM/YYYY',\r\n      showTime: node.date_showTime || false,\r\n      minDate: node.date_minDate || null,\r\n      maxDate: node.date_maxDate || null\r\n    },\r\n    image: {\r\n      maxSize: node.image_maxSize || null,\r\n      ratio: node.image_ratio || null,\r\n      crop: node.image_crop || false,\r\n      thumbnails: node.image_thumbnails || null\r\n    }\r\n  };\r\n  \r\n  // Nettoyer les objets vides\r\n  Object.keys(fieldConfig).forEach(key => {\r\n    const config = fieldConfig[key];\r\n    const hasValues = Object.values(config).some(val => val !== null && val !== undefined && val !== false && val !== 0 && val !== '');\r\n    if (!hasValues) delete fieldConfig[key];\r\n  });\r\n  \r\n  // Mettre \u00C3\u00A0 jour les m\u00C3\u00A9tadonn\u00C3\u00A9es avec les nouvelles donn\u00C3\u00A9es\r\n  const cleanedMetadata = {\r\n    ...(node.metadata || {}),\r\n    appearance\r\n  };\r\n\r\n  // Reconstruire les subTabs depuis la colonne `subtabs` si elle existe\r\n  if (node.subtabs) {\r\n    try {\r\n      const parsed = JSON.parse(node.subtabs as string);\r\n      if (Array.isArray(parsed)) {\r\n        (cleanedMetadata as any).subTabs = parsed;\r\n        console.log('\u00F0\u0178\u201D\u008D [buildResponseFromColumns] Reconstruit subTabs depuis colonne subtabs:', parsed);\r\n      }\r\n    } catch { /* noop */ }\r\n  }\r\n\r\n  // Reconstruire le subTab depuis la colonne `subtab` si elle existe\r\n  if (node.subtab !== undefined && node.subtab !== null) {\r\n    const rawSubTab = node.subtab as string;\r\n    let parsedSubTab: string | string[] = rawSubTab;\r\n    if (typeof rawSubTab === 'string') {\r\n      const trimmed = rawSubTab.trim();\r\n      if (trimmed.startsWith('[')) {\r\n        try {\r\n          const candidate = JSON.parse(trimmed);\r\n          if (Array.isArray(candidate)) {\r\n            parsedSubTab = candidate;\r\n          }\r\n        } catch {\r\n          parsedSubTab = rawSubTab;\r\n        }\r\n      } else if (trimmed.includes(',')) {\r\n        parsedSubTab = trimmed.split(',').map(part => part.trim()).filter(Boolean);\r\n      } else {\r\n        parsedSubTab = trimmed;\r\n      }\r\n    }\r\n    try {\r\n      (cleanedMetadata as any).subTab = parsedSubTab;\r\n      console.log('\u00F0\u0178\u201D\u008D [buildResponseFromColumns] Reconstruit subTab depuis colonne subtab:', (cleanedMetadata as any).subTab);\r\n    } catch { /* noop */ }\r\n  }\r\n  \r\n  // \u00F0\u0178\u201D\u008D DEBUG: Log metadata pour \"Test - liste\"\r\n  if (node.id === '131a7b51-97d5-4f40-8a5a-9359f38939e8') {\r\n    console.log('\u00F0\u0178\u201D\u008D [buildResponseFromColumns][Test - liste] node.metadata BRUT:', node.metadata);\r\n    console.log('\u00F0\u0178\u201D\u008D [buildResponseFromColumns][Test - liste] cleanedMetadata:', cleanedMetadata);\r\n    console.log('\u00F0\u0178\u201D\u008D [buildResponseFromColumns][Test - liste] metadata.capabilities:', \r\n      (node.metadata && typeof node.metadata === 'object') ? (node.metadata as any).capabilities : 'N/A');\r\n  }\r\n\r\n  if (cleanedMetadata && cleanedMetadata.subTabs) {\r\n    try {\r\n      console.log('\u00F0\u0178\u201D\u008D [buildResponseFromColumns] metadata.subTabs present for node', node.id, JSON.stringify((cleanedMetadata as any).subTabs));\r\n    } catch(e) { /* noop */ }\r\n  }\r\n  \r\n  // \u00F0\u0178\u201D\u00A5 INJECTER repeater dans cleanedMetadata\r\n  const metadataWithRepeater = {\r\n    ...cleanedMetadata,\r\n    repeater: repeater\r\n  };\r\n\r\n  // \u00F0\u0178\u201D\u008D LOG SP\u00C3\u2030CIAL POUR LES R\u00C3\u2030P\u00C3\u2030TABLES\r\n  if (repeater.templateNodeIds && repeater.templateNodeIds.length > 0) {\r\n    console.log('\u00F0\u0178\u201D\u0081\u00F0\u0178\u201D\u0081\u00F0\u0178\u201D\u0081 [REPEATER NODE FOUND]', {\r\n      nodeId: node.id,\r\n      nodeName: node.name,\r\n      nodeLabel: (node as any).label,\r\n      nodeType: (node as any).type,\r\n      parentId: node.parentId,\r\n      repeaterConfig: repeater\r\n    });\r\n  }\r\n\r\n  console.log('\u00F0\u0178\u017D\u00AF [buildResponseFromColumns] metadata.repeater final:', metadataWithRepeater.repeater);\r\n\r\n  const result = {\r\n    ...node,\r\n    metadata: metadataWithRepeater,\r\n    fieldConfig,\r\n    // Ajouter les champs d'interface pour compatibilit\u00C3\u00A9\r\n    appearance,\r\n    appearanceConfig, // \u00F0\u0178\u017D\u00AF CORRECTION : Ajouter appearanceConfig pour l'interface Parameters\r\n    // \u00E2\u0161\u00A0\u00EF\u00B8\u008F IMPORTANT : fieldType depuis les colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n    fieldType: node.fieldType || node.type,\r\n    fieldSubType: node.fieldSubType || node.subType,\r\n    // \u00F0\u0178\u201D\u00A5 TOOLTIP FIX : Ajouter les propri\u00C3\u00A9t\u00C3\u00A9s tooltip au niveau racine pour TBL\r\n    text_helpTooltipType: node.text_helpTooltipType,\r\n    text_helpTooltipText: node.text_helpTooltipText,\r\n    text_helpTooltipImage: node.text_helpTooltipImage,\r\n    // \u00F0\u0178\u201D\u00A5 TABLES : Inclure les tables avec leurs colonnes/lignes pour le lookup\r\n    tables: node.TreeBranchLeafNodeTable || [],\r\n    // \u00F0\u0178\u201D\u2014 SHARED REFERENCES : Inclure les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es pour les cascades\r\n    sharedReferenceIds: node.sharedReferenceIds || undefined\r\n  };\r\n\r\n  // =====================================================================\r\n  // \uD83E\uDDF1 ADAPTATEUR LEGACY CAPABILITIES (Reconstruit l'ancien objet attendu)\r\n  // =====================================================================\r\n  // Objectif: Fournir \u00E0 nouveau result.capabilities sans modifier le mod\u00E8le Prisma.\r\n  // On s'appuie UNIQUEMENT sur les colonnes d\u00C3\u00A9di\u00C3\u00A9es (hasFormula, formula_activeId, etc.).\r\n  // Si metadata.capabilities existe d\u00E9j\u00E0 (anciennes donn\u00E9es), on la pr\u00E9serve et on fusionne.\r\n\r\n  try {\r\n    const legacyMetaCaps = (node.metadata && typeof node.metadata === 'object') ? (node.metadata as any).capabilities : undefined;\r\n\r\n    const buildInstances = (raw: unknown): Record<string, unknown> | undefined => {\r\n      if (!raw) return undefined;\r\n      if (typeof raw === 'object' && raw !== null) return raw as Record<string, unknown>;\r\n      return undefined;\r\n    };\r\n\r\n    const capabilities: Record<string, unknown> = {\r\n      // Donn\u00E9es dynamiques / variables\r\n      data: (node.hasData || node.data_activeId || node.data_instances) ? {\r\n        enabled: !!node.hasData,\r\n        activeId: node.data_activeId || null,\r\n        instances: buildInstances(node.data_instances) || {},\r\n        unit: node.data_unit || null,\r\n        precision: typeof node.data_precision === 'number' ? node.data_precision : 2,\r\n        exposedKey: node.data_exposedKey || null,\r\n        displayFormat: node.data_displayFormat || null,\r\n        visibleToUser: node.data_visibleToUser === true\r\n      } : undefined,\r\n      // Formules\r\n      formula: (node.hasFormula || node.formula_activeId || node.formula_instances) ? {\r\n        enabled: !!node.hasFormula,\r\n        activeId: node.formula_activeId || null,\r\n        instances: buildInstances(node.formula_instances) || {},\r\n        tokens: buildInstances(node.formula_tokens) || undefined,\r\n        name: node.formula_name || null\r\n      } : undefined,\r\n      // Table lookup\r\n      table: (node.hasTable || node.table_activeId || node.table_instances) ? {\r\n        enabled: !!node.hasTable,\r\n        activeId: node.table_activeId || null,\r\n        instances: buildInstances(node.table_instances) || {},\r\n        name: node.table_name || null,\r\n        meta: buildInstances(node.table_meta) || {},\r\n        type: node.table_type || 'columns',\r\n        isImported: node.table_isImported === true,\r\n        importSource: node.table_importSource || null,\r\n        columns: Array.isArray(node.table_columns) ? node.table_columns : null,\r\n        rows: Array.isArray(node.table_rows) ? node.table_rows : null\r\n      } : undefined,\r\n      // Select (options statiques ou dynamiques d\u00E9j\u00E0 r\u00E9solues)\r\n      select: (node.select_options || node.select_defaultValue) ? {\r\n        options: Array.isArray(node.select_options) ? node.select_options : [],\r\n        allowClear: node.select_allowClear !== false,\r\n        multiple: node.select_multiple === true,\r\n        searchable: node.select_searchable !== false,\r\n        defaultValue: node.select_defaultValue || null\r\n      } : undefined,\r\n      // Nombre\r\n      number: (node.number_min !== undefined || node.number_max !== undefined || node.number_defaultValue !== undefined) ? {\r\n        min: node.number_min ?? null,\r\n        max: node.number_max ?? null,\r\n        step: node.number_step ?? 1,\r\n        decimals: node.number_decimals ?? 0,\r\n        unit: node.number_unit || null,\r\n        prefix: node.number_prefix || null,\r\n        suffix: node.number_suffix || null,\r\n        defaultValue: node.number_defaultValue || null\r\n      } : undefined,\r\n      // Bool\u00E9en\r\n      bool: (node.bool_trueLabel || node.bool_falseLabel || node.bool_defaultValue !== undefined) ? {\r\n        trueLabel: node.bool_trueLabel || null,\r\n        falseLabel: node.bool_falseLabel || null,\r\n        defaultValue: node.bool_defaultValue ?? null\r\n      } : undefined,\r\n      // Date\r\n      date: (node.date_format || node.date_showTime || node.date_minDate || node.date_maxDate) ? {\r\n        format: node.date_format || 'DD/MM/YYYY',\r\n        showTime: node.date_showTime === true,\r\n        minDate: node.date_minDate || null,\r\n        maxDate: node.date_maxDate || null\r\n      } : undefined,\r\n      // Image\r\n      image: (node.image_maxSize || node.image_ratio || node.image_crop || node.image_thumbnails) ? {\r\n        maxSize: node.image_maxSize || null,\r\n        ratio: node.image_ratio || null,\r\n        crop: node.image_crop === true,\r\n        thumbnails: node.image_thumbnails || null\r\n      } : undefined,\r\n      // Linking / navigation (simplifi\u00E9)\r\n      link: (node.link_activeId || node.link_instances) ? {\r\n        enabled: !!node.hasLink,\r\n        activeId: node.link_activeId || null,\r\n        instances: buildInstances(node.link_instances) || {},\r\n        mode: node.link_mode || 'JUMP',\r\n        name: node.link_name || null,\r\n        carryContext: node.link_carryContext === true,\r\n        params: buildInstances(node.link_params) || {},\r\n        targetNodeId: node.link_targetNodeId || null,\r\n        targetTreeId: node.link_targetTreeId || null\r\n      } : undefined,\r\n      // Markers\r\n      markers: (node.markers_activeId || node.markers_instances || node.markers_selectedIds) ? {\r\n        enabled: !!node.hasMarkers,\r\n        activeId: node.markers_activeId || null,\r\n        instances: buildInstances(node.markers_instances) || {},\r\n        available: buildInstances(node.markers_available) || {},\r\n        selectedIds: buildInstances(node.markers_selectedIds) || {}\r\n      } : undefined,\r\n      // API (legacy mapping minimal)\r\n      api: (node.api_activeId || node.api_instances) ? {\r\n        enabled: !!node.hasAPI,\r\n        activeId: node.api_activeId || null,\r\n        instances: buildInstances(node.api_instances) || {},\r\n        bodyVars: buildInstances(node.api_bodyVars) || {},\r\n        name: node.api_name || null\r\n      } : undefined\r\n    };\r\n\r\n    // Nettoyer les cl\u00E9s undefined\r\n    Object.keys(capabilities).forEach(key => {\r\n      if (capabilities[key] === undefined) delete capabilities[key];\r\n    });\r\n\r\n    // Fusion avec legacy metadata.capabilities si pr\u00E9sent\r\n    let mergedCaps: Record<string, unknown> = capabilities;\r\n    if (legacyMetaCaps && typeof legacyMetaCaps === 'object') {\r\n      mergedCaps = { ...legacyMetaCaps, ...capabilities };\r\n    }\r\n\r\n    // Injection dans result\r\n    (result as any).capabilities = mergedCaps;\r\n  } catch (e) {\r\n    console.error('\u274C [buildResponseFromColumns] Erreur adaptation legacy capabilities:', e);\r\n  }\r\n  \r\n  // \u00F0\u0178\u201D\u008D DEBUG SHARED REFERENCES : Log pour les options avec r\u00C3\u00A9f\u00C3\u00A9rences\r\n  if (node.sharedReferenceIds && node.sharedReferenceIds.length > 0) {\r\n    console.log('\u00F0\u0178\u201D\u2014 [buildResponseFromColumns] OPTION AVEC SHARED REFS:', {\r\n      nodeId: node.id,\r\n      label: node.label || node.option_label,\r\n      type: node.type,\r\n      sharedReferenceIds: node.sharedReferenceIds\r\n    });\r\n  }\r\n  \r\n  // \u00F0\u0178\u0161\u00A8 DEBUG TOOLTIP : Log si des tooltips sont trouv\u00C3\u00A9s\r\n  if (node.text_helpTooltipType && node.text_helpTooltipType !== 'none') {\r\n    console.log('\u00F0\u0178\u201D\u00A5 [buildResponseFromColumns] TOOLTIP TROUV\u00C3\u2030:', {\r\n      id: node.id,\r\n      name: node.name,\r\n      tooltipType: node.text_helpTooltipType,\r\n      hasTooltipText: !!node.text_helpTooltipText,\r\n      hasTooltipImage: !!node.text_helpTooltipImage,\r\n      textLength: node.text_helpTooltipText?.length || 0,\r\n      imageLength: node.text_helpTooltipImage?.length || 0\r\n    });\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u201E FONCTIONS UTILITAIRES POUR COLONNES\r\n// =============================================================================\r\n\r\n/**\r\n * \u00E2\u0161\u00A1 PR\u00C3\u2030SERVER LES CAPABILITIES : \u00C3\u2030criture hybride colonnes + metadata\r\n * Pr\u00C3\u00A9serve metadata.capabilities (formules multiples, etc.) tout en migrant le reste vers les colonnes\r\n */\r\nfunction removeJSONFromUpdate(updateData: Record<string, unknown>): Record<string, unknown> {\r\n  const { metadata, fieldConfig: _fieldConfig, appearanceConfig: _appearanceConfig, ...cleanData } = updateData;\r\n\r\n  // \uD83D\uDD27 PRESERVER metadata CAPABILITIES + SUBTABS/SUBTAB\r\n  // Nous autorisons explicitement certaines cl\u00E9s metadata \u00E0 traverser la suppression JSON\r\n  if (metadata && typeof metadata === 'object') {\r\n    const metaObj = metadata as Record<string, unknown>;\r\n    const preserved: Record<string, unknown> = {};\r\n    if (metaObj.capabilities) preserved.capabilities = metaObj.capabilities;\r\n    if (metaObj.subTabs) preserved.subTabs = metaObj.subTabs;\r\n    if (metaObj.subTab) preserved.subTab = metaObj.subTab;\r\n    // Si au moins une cl\u00E9 doit \u00EAtre pr\u00E9serv\u00E9e, renvoyer le cleanData avec metadata r\u00E9duit\r\n    if (Object.keys(preserved).length > 0) {\r\n      return {\r\n        ...cleanData,\r\n        metadata: preserved\r\n      };\r\n    }\r\n  }\r\n  \r\n  return cleanData;\r\n}\r\n\r\n/**\r\n * \u00F0\u0178\u00A7\u00A9 EXTRA: Normalisation des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es pour les COPIES\r\n * R\u00C3\u00A8gle m\u00C3\u00A9tier (confirm\u00C3\u00A9e par l'utilisateur): lorsqu'un n\u00C5\u201Cud est une copie dont l'id\r\n * se termine par un suffixe num\u00C3\u00A9rique \"-N\" (ex: \"...-1\", \"...-2\"), alors toute\r\n * r\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9e stock\u00C3\u00A9e dans les colonnes shared* doit pointer vers l'ID de la\r\n * COPIE correspondante (m\u00C3\u00AAme suffixe), pas vers l'original.\r\n *\r\n * Exemple: si ce n\u00C5\u201Cud (nodeId) = \"shared-ref-ABC-1\" et que l'utilisateur envoie\r\n * sharedReferenceId = \"shared-ref-XYZ\", on doit persister \"shared-ref-XYZ-1\".\r\n */\r\nfunction extractCopySuffixFromId(id: string | null | undefined): string | null {\r\n  if (!id) return null;\r\n  const m = String(id).match(/-(\\d+)$/);\r\n  return m ? m[0] : null; // renvoie \"-1\", \"-2\", etc. ou null\r\n}\r\n\r\nfunction applyCopySuffix(id: string, suffix: string): string {\r\n  // Retirer tout suffixe num\u00C3\u00A9rique existant et appliquer le suffixe souhait\u00C3\u00A9\r\n  const base = id.replace(/-(\\d+)$/, '');\r\n  return `${base}${suffix}`;\r\n}\r\n\r\nfunction normalizeSharedRefsForCopy(nodeId: string, updateObj: Record<string, unknown>) {\r\n  const suffix = extractCopySuffixFromId(nodeId);\r\n  if (!suffix) return; // pas une copie \u00E2\u2020\u2019 ne rien faire\r\n\r\n  // G\u00C3\u00A9rer single\r\n  if (typeof updateObj.sharedReferenceId === 'string' && updateObj.sharedReferenceId.length > 0) {\r\n    updateObj.sharedReferenceId = applyCopySuffix(updateObj.sharedReferenceId, suffix);\r\n  }\r\n\r\n  // G\u00C3\u00A9rer array\r\n  if (Array.isArray(updateObj.sharedReferenceIds)) {\r\n    const out: string[] = [];\r\n    for (const raw of updateObj.sharedReferenceIds as unknown[]) {\r\n      if (typeof raw !== 'string' || raw.length === 0) continue;\r\n      out.push(applyCopySuffix(raw, suffix));\r\n    }\r\n    // D\u00C3\u00A9dupliquer en conservant l'ordre\r\n    const seen = new Set<string>();\r\n    updateObj.sharedReferenceIds = out.filter(id => (seen.has(id) ? false : (seen.add(id), true)));\r\n  }\r\n}\r\n\r\n// Handler commun pour UPDATE/PATCH d'un n\u00C5\u201Cud (incluant le d\u00C3\u00A9placement avec r\u00C3\u00A9indexation)\r\nconst updateOrMoveNode = async (req, res) => {\r\n  try {\r\n    const { treeId, nodeId } = req.params;\r\n    const { organizationId } = req.user!;\r\n    const updateData = req.body || {};\r\n    // Flag: cascade subTab to descendants (server-side optimized variant)\r\n    const cascadeSubTab = !!updateData.cascadeSubTab;\r\n    if ('cascadeSubTab' in updateData) delete updateData.cascadeSubTab;\r\n    \r\n    console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] AVANT migration - donn\u00C3\u00A9es re\u00C3\u00A7ues:', {\r\n      hasMetadata: !!updateData.metadata,\r\n      hasFieldConfig: !!updateData.fieldConfig,\r\n      hasAppearanceConfig: !!updateData.appearanceConfig,\r\n      keys: Object.keys(updateData),\r\n      appearanceConfig: updateData.appearanceConfig,\r\n      'metadata.repeater': updateData.metadata?.repeater,\r\n      'metadata complet': JSON.stringify(updateData.metadata, null, 2)\r\n    });\r\n    \r\n    // \u00F0\u0178\u201D\u201E \u00C3\u2030TAPE 1 : Convertir JSON vers colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n    const columnData = mapJSONToColumns(updateData);\r\n    \r\n    // \u00F0\u0178\u0161\u20AC \u00C3\u2030TAPE 2 : \u00C3\u2030LIMINER le JSON et utiliser UNIQUEMENT les colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n    const cleanUpdateData = removeJSONFromUpdate(updateData);\r\n    \r\n    // \u00F0\u0178\u017D\u00AF \u00C3\u2030TAPE 3 : Fusionner donn\u00C3\u00A9es nettoy\u00C3\u00A9es + colonnes d\u00C3\u00A9di\u00C3\u00A9es\r\n    const updateObj: Record<string, unknown> = { ...cleanUpdateData, ...columnData };\r\n    \r\n    console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] APR\u00C3\u02C6S migration - donn\u00C3\u00A9es finales:', {\r\n      originalKeys: Object.keys(updateData),\r\n      cleanedKeys: Object.keys(cleanUpdateData),\r\n      columnKeys: Object.keys(columnData),\r\n      finalKeys: Object.keys(updateObj),\r\n      hasMetadataInFinal: !!updateObj.metadata,\r\n      hasFieldConfigInFinal: !!updateObj.fieldConfig,\r\n      columnData: columnData\r\n    });\r\n\r\n    // DEBUG: show the actual metadata object intended to be written\r\n    try {\r\n      console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] updateObj.metadata CONTENT:', JSON.stringify(updateObj.metadata || null));\r\n    } catch(e) {\r\n      console.warn('\u00F0\u0178\u201D\u201E [updateOrMoveNode] Failed to stringify updateObj.metadata', e);\r\n    }\r\n\r\n  // \u00F0\u0178\u00A7\u00A9 IMPORTANT: Normaliser les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es si le n\u00C5\u201Cud est une COPIE (ID avec suffixe \"-N\")\r\n  // Concerne les \u00C3\u00A9critures directes envoy\u00C3\u00A9es par le frontend (single/array)\r\n  normalizeSharedRefsForCopy(nodeId, updateObj);\r\n    \r\n  // Nettoyage de champs non support\u00C3\u00A9s par le mod\u00C3\u00A8le Prisma (\u00C3\u00A9vite les erreurs PrismaClientValidationError)\r\n  // Exemple: certains appels frontend envoient \"markers\" ou \"hasMarkers\" qui n'existent pas dans TreeBranchLeafNode\r\n    for (const k of ['markers', 'hasMarkers']) {\r\n      if (k in updateObj) delete updateObj[k];\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: { id: treeId, organizationId }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n  // Supprimer les champs non modifiables\r\n  delete updateObj.id;\r\n  delete updateObj.treeId;\r\n  delete updateObj.createdAt;\r\n\r\n    // Charger le n\u00C5\u201Cud existant (sera n\u00C3\u00A9cessaire pour la validation et la logique de d\u00C3\u00A9placement)\r\n    console.log('\u00F0\u0178\u201D\u008D [updateOrMoveNode] Recherche n\u00C5\u201Cud:', { nodeId, treeId, organizationId });\r\n    \r\n    const existingNode = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId, treeId }\r\n    });\r\n\r\n    // Si les colonnes d\u00E9di\u00E9es pour subTabs/subTab existent en base et ne sont pas dans updateObj,\r\n    // les pr\u00E9remplir pour \u00E9viter la perte involontaire lors de l'update.\r\n    try {\r\n      const selectedColumns = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: nodeId },\r\n        select: { subtabs: true, subtab: true }\r\n      });\r\n      if (selectedColumns) {\r\n        if (!('subtabs' in updateObj) && selectedColumns.subtabs !== undefined) {\r\n          updateObj.subtabs = selectedColumns.subtabs;\r\n          console.log('\u00F0\u0178\u2019\u00A4 [updateOrMoveNode] Pr\u00E9rempli updateObj.subtabs depuis la base');\r\n        }\r\n        if (!('subtab' in updateObj) && selectedColumns.subtab !== undefined) {\r\n          updateObj.subtab = selectedColumns.subtab;\r\n          console.log('\u00F0\u0178\u2019\u00A4 [updateOrMoveNode] Pr\u00E9rempli updateObj.subtab depuis la base');\r\n        }\r\n      }\r\n    } catch (e) { console.warn('\u00F0\u0178\u2019\u00A4 [updateOrMoveNode] Error while pre-filling subtabs/subtab from base', e); }\r\n\r\n    if (!existingNode) {\r\n      // \u00F0\u0178\u0161\u00A8 DEBUG: Chercher le n\u00C5\u201Cud sans contrainte de treeId pour voir s'il existe ailleurs\r\n      const nodeAnyTree = await prisma.treeBranchLeafNode.findFirst({\r\n        where: { id: nodeId }\r\n      });\r\n      \r\n      console.error('\u00E2\u009D\u0152 [updateOrMoveNode] N\u00C5\u201Cud non trouv\u00C3\u00A9 - DEBUG:', {\r\n        nodeId,\r\n        treeId,\r\n        organizationId,\r\n        nodeExistsElsewhere: !!nodeAnyTree,\r\n        nodeActualTreeId: nodeAnyTree?.treeId,\r\n        allNodesInTree: await prisma.treeBranchLeafNode.count({ where: { treeId } })\r\n      });\r\n      \r\n      return res.status(404).json({ \r\n        error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9',\r\n        debug: {\r\n          nodeId,\r\n          treeId,\r\n          nodeExistsElsewhere: !!nodeAnyTree,\r\n          nodeActualTreeId: nodeAnyTree?.treeId\r\n        }\r\n      });\r\n    }\r\n\r\n    // Extraire param\u00C3\u00A8tres potentiels de d\u00C3\u00A9placement\r\n  const targetId: string | undefined = updateData.targetId;\r\n  const position: 'before' | 'after' | 'child' | undefined = updateData.position;\r\n\r\n    // Si targetId/position sont fournis, on calcule parentId/insertIndex \u00C3\u00A0 partir de ceux-ci\r\n    let newParentId: string | null | undefined = updateData.parentId; // undefined = pas de changement\r\n    let desiredIndex: number | undefined = undefined; // index parmi les siblings (entier)\r\n\r\n    if (targetId) {\r\n      const targetNode = await prisma.treeBranchLeafNode.findFirst({ where: { id: targetId, treeId } });\r\n      if (!targetNode) {\r\n        return res.status(400).json({ error: 'Cible de d\u00C3\u00A9placement non trouv\u00C3\u00A9e' });\r\n      }\r\n      if (position === 'child') {\r\n        newParentId = targetNode.id; // enfant direct\r\n        // on met \u00C3\u00A0 la fin par d\u00C3\u00A9faut (sera calcul\u00C3\u00A9 plus bas)\r\n        desiredIndex = undefined;\r\n      } else {\r\n        // before/after -> m\u00C3\u00AAme parent que la cible\r\n        newParentId = targetNode.parentId || null;\r\n        // index d\u00C3\u00A9sir\u00C3\u00A9 relatif \u00C3\u00A0 la cible (sera calcul\u00C3\u00A9 plus bas)\r\n        // on signalera via un flag sp\u00C3\u00A9cial pour ajuster apr\u00C3\u00A8s\r\n        desiredIndex = -1; // marqueur: calculer en fonction de la cible\r\n      }\r\n    }\r\n\r\n  // \u00F0\u0178\u0161\u00A8 VALIDATION HI\u00C3\u2030RARCHIQUE si on change le parentId (d\u00C3\u00A9placement)\r\n    if (newParentId !== undefined) {\r\n      // R\u00C3\u00A9cup\u00C3\u00A9rer le n\u00C5\u201Cud existant pour conna\u00C3\u00AEtre son type\r\n      // existingNode d\u00C3\u00A9j\u00C3\u00A0 charg\u00C3\u00A9 ci-dessus\r\n\r\n      // Si on change le parent, appliquer les m\u00C3\u00AAmes r\u00C3\u00A8gles hi\u00C3\u00A9rarchiques que pour la cr\u00C3\u00A9ation\r\n      if (newParentId) {\r\n        // R\u00C3\u00A9cup\u00C3\u00A9rer le nouveau parent\r\n        const newParentNode = await prisma.treeBranchLeafNode.findFirst({\r\n          where: { id: newParentId, treeId }\r\n        });\r\n\r\n        if (!newParentNode) {\r\n          return res.status(400).json({ error: 'Parent non trouv\u00C3\u00A9' });\r\n        }\r\n\r\n        // Appliquer les r\u00C3\u00A8gles hi\u00C3\u00A9rarchiques actualis\u00C3\u00A9es\r\n        if (existingNode.type === 'leaf_option') {\r\n          // Les options peuvent \u00C3\u00AAtre sous :\r\n          // 1. Des champs SELECT (leaf_ avec subType='SELECT')\r\n          // 2. Des branches de niveau 2+ (branches sous branches = SELECT)\r\n          const isSelectField = newParentNode.type.startsWith('leaf_') && newParentNode.subType === 'SELECT';\r\n          const isSelectBranch = newParentNode.type === 'branch' && newParentNode.parentId !== null;\r\n          \r\n          if (!isSelectField && !isSelectBranch) {\r\n            return res.status(400).json({ \r\n              error: 'Les options ne peuvent \u00C3\u00AAtre d\u00C3\u00A9plac\u00C3\u00A9es que sous des champs SELECT ou des branches de niveau 2+' \r\n            });\r\n          }\r\n        } else if (existingNode.type.startsWith('leaf_')) {\r\n          // Les champs peuvent \u00C3\u00AAtre sous des branches ou d'autres champs\r\n          if (newParentNode.type !== 'branch' && !newParentNode.type.startsWith('leaf_')) {\r\n            return res.status(400).json({ \r\n              error: 'Les champs ne peuvent \u00C3\u00AAtre d\u00C3\u00A9plac\u00C3\u00A9s que sous des branches ou d\\'autres champs' \r\n            });\r\n          }\r\n        } else if (existingNode.type === 'branch') {\r\n          // Les branches peuvent \u00C3\u00AAtre sous l'arbre ou sous une autre branche\r\n          if (!(newParentNode.type === 'tree' || newParentNode.type === 'branch')) {\r\n            return res.status(400).json({ \r\n              error: 'Les branches doivent \u00C3\u00AAtre sous l\\'arbre ou sous une autre branche' \r\n            });\r\n          }\r\n        }\r\n      } else {\r\n        // parentId null = d\u00C3\u00A9placement vers la racine\r\n        // Seules les branches peuvent \u00C3\u00AAtre directement sous l'arbre racine\r\n        if (existingNode.type !== 'branch') {\r\n          return res.status(400).json({ \r\n            error: 'Seules les branches peuvent \u00C3\u00AAtre d\u00C3\u00A9plac\u00C3\u00A9es directement sous l\\'arbre racine (niveau 2)' \r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // D\u00C3\u00A9terminer si on doit effectuer une op\u00C3\u00A9ration de d\u00C3\u00A9placement avec r\u00C3\u00A9indexation\r\n  const isMoveOperation = (targetId && position) || (newParentId !== undefined) || (typeof updateObj.order === 'number');\r\n\r\n    if (isMoveOperation) {\r\n      // Calculer le parent cible final et la position d'insertion (index entier)\r\n      const destinationParentId = newParentId !== undefined ? newParentId : existingNode.parentId;\r\n\r\n      // R\u00C3\u00A9cup\u00C3\u00A9rer tous les siblings de la destination (exclure le n\u00C5\u201Cud en mouvement)\r\n      const siblings = await prisma.treeBranchLeafNode.findMany({\r\n        where: { treeId, parentId: destinationParentId || null, NOT: { id: nodeId } },\r\n        orderBy: [{ order: 'asc' }, { createdAt: 'asc' }]\r\n      });\r\n\r\n      let insertIndex: number;\r\n      if (targetId && (position === 'before' || position === 'after')) {\r\n        const idx = siblings.findIndex(s => s.id === targetId);\r\n        // si la cible n'est pas un sibling (ex: child), idx sera -1; fallback fin\r\n        if (idx >= 0) {\r\n          insertIndex = position === 'before' ? idx : idx + 1;\r\n        } else {\r\n          insertIndex = siblings.length;\r\n        }\r\n      } else if (position === 'child') {\r\n        insertIndex = siblings.length; // \u00C3\u00A0 la fin sous ce parent\r\n      } else if (typeof updateObj.order === 'number') {\r\n        // Si on re\u00C3\u00A7oit un order num\u00C3\u00A9rique, on tente d'ins\u00C3\u00A9rer au plus proche (born\u00C3\u00A9 entre 0 et len)\r\n        insertIndex = Math.min(Math.max(Math.round(updateObj.order as number), 0), siblings.length);\r\n      } else if (desiredIndex !== undefined && desiredIndex >= 0) {\r\n        insertIndex = Math.min(Math.max(desiredIndex, 0), siblings.length);\r\n      } else {\r\n        insertIndex = siblings.length; // d\u00C3\u00A9faut = fin\r\n      }\r\n\r\n      // Construire l'ordre final des IDs (siblings + nodeId ins\u00C3\u00A9r\u00C3\u00A9)\r\n      const finalOrder = [...siblings.map(s => s.id)];\r\n      finalOrder.splice(insertIndex, 0, nodeId);\r\n\r\n      // Effectuer la transaction: mettre \u00C3\u00A0 jour parentId du n\u00C5\u201Cud + r\u00C3\u00A9indexer les orders entiers\r\n      await prisma.$transaction(async (tx) => {\r\n        // Mettre \u00C3\u00A0 jour parentId si n\u00C3\u00A9cessaire\r\n        if (destinationParentId !== existingNode.parentId) {\r\n          await tx.treeBranchLeafNode.update({\r\n            where: { id: nodeId },\r\n            data: { parentId: destinationParentId || null, updatedAt: new Date() }\r\n          });\r\n        }\r\n\r\n        // R\u00C3\u00A9indexer: donner des valeurs enti\u00C3\u00A8res 0..N\r\n        for (let i = 0; i < finalOrder.length; i++) {\r\n          const id = finalOrder[i];\r\n          await tx.treeBranchLeafNode.update({\r\n            where: { id },\r\n            data: { order: i, updatedAt: new Date() }\r\n          });\r\n        }\r\n      });\r\n\r\n      const updatedNode = await prisma.treeBranchLeafNode.findFirst({ where: { id: nodeId, treeId } });\r\n      \r\n      console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] APR\u00C3\u02C6S d\u00C3\u00A9placement - reconstruction depuis colonnes');\r\n      const responseData = updatedNode ? buildResponseFromColumns(updatedNode) : updatedNode;\r\n      \r\n      return res.json(responseData);\r\n    }\r\n\r\n    // Cas simple: pas de d\u00C3\u00A9placement \u00E2\u2020\u2019 mise \u00C3\u00A0 jour directe\r\n    // \u00F0\u0178\u201D\u00A5 FIX : Reconstruire metadata.repeater depuis les colonnes pour synchroniser le JSON Prisma\r\n    if (updateObj.repeater_buttonSize || updateObj.repeater_maxItems !== undefined || updateObj.repeater_minItems !== undefined) {\r\n      const currentMetadata = existingNode.metadata as any || {};\r\n      const updatedRepeaterMetadata = {\r\n        ...(currentMetadata.repeater || {}),\r\n        ...(updateObj.repeater_addButtonLabel !== undefined ? { addButtonLabel: updateObj.repeater_addButtonLabel } : {}),\r\n        ...(updateObj.repeater_buttonSize !== undefined ? { buttonSize: updateObj.repeater_buttonSize } : {}),\r\n        ...(updateObj.repeater_buttonWidth !== undefined ? { buttonWidth: updateObj.repeater_buttonWidth } : {}),\r\n        ...(updateObj.repeater_iconOnly !== undefined ? { iconOnly: updateObj.repeater_iconOnly } : {}),\r\n        ...(updateObj.repeater_minItems !== undefined ? { minItems: updateObj.repeater_minItems } : {}),\r\n        ...(updateObj.repeater_maxItems !== undefined ? { maxItems: updateObj.repeater_maxItems } : {}),\r\n      };\r\n      \r\n      updateObj.metadata = {\r\n        ...currentMetadata,\r\n        repeater: updatedRepeaterMetadata\r\n      };\r\n      \r\n      console.warn('\u00F0\u0178\u201D\u00A5 [updateOrMoveNode] Synchronisation metadata.repeater:', updatedRepeaterMetadata);\r\n    }\r\n    \r\n    const result = await prisma.treeBranchLeafNode.updateMany({\r\n      where: { id: nodeId, treeId },\r\n      data: { ...(updateObj as Prisma.TreeBranchLeafNodeUpdateManyMutationInput), updatedAt: new Date() }\r\n    });\r\n\r\n    if (result.count === 0) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const updatedNode = await prisma.treeBranchLeafNode.findFirst({ where: { id: nodeId, treeId } });\r\n\r\n    // If requested, perform a server-side cascade update for subTab on descendants\r\n    try {\r\n      if (cascadeSubTab && updateObj.subtab !== undefined && updateObj.subtab !== null) {\r\n        const subTabStr = String(updateObj.subtab);\r\n        console.log('\u00F0\u0178\u201C\u2014 [updateOrMoveNode] CascadeSubTab activ\u00E9: mise \u00E0 jour SQL pour', nodeId, 'valeur:', subTabStr);\r\n        await prisma.$executeRaw`\r\n          WITH RECURSIVE descendants AS (\r\n            SELECT id FROM \"public\".\"TreeBranchLeafNode\" WHERE id = ${nodeId}\r\n            UNION ALL\r\n            SELECT n.id FROM \"public\".\"TreeBranchLeafNode\" n JOIN descendants d ON n.\"parentId\" = d.id\r\n          )\r\n          UPDATE \"public\".\"TreeBranchLeafNode\" t\r\n          SET \"subtab\" = ${subTabStr}, \"updatedAt\" = NOW()\r\n          WHERE t.id IN (SELECT id FROM descendants)\r\n            AND (\r\n              t.type LIKE 'leaf_%'\r\n              OR COALESCE(jsonb_array_length(t.subtabs), 0) = 0\r\n            );\r\n        `;\r\n      }\r\n    } catch (e) {\r\n      console.error('\u00E2\u009D\u0152 [updateOrMoveNode] Erreur lors du cascadeSubTab SQL:', e);\r\n    }\r\n    \r\n    console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] APR\u00C3\u02C6S mise \u00C3\u00A0 jour - n\u00C5\u201Cud brut Prisma:', {\r\n      'updatedNode.metadata': updatedNode?.metadata,\r\n      'updatedNode.metadata typeof': typeof updatedNode?.metadata\r\n    });\r\n    \r\n    console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] APR\u00C3\u02C6S mise \u00C3\u00A0 jour - reconstruction depuis colonnes');\r\n    const responseData = updatedNode ? buildResponseFromColumns(updatedNode) : updatedNode;\r\n    \r\n    console.log('\u00F0\u0178\u201D\u201E [updateOrMoveNode] APR\u00C3\u02C6S buildResponseFromColumns:', {\r\n      'responseData.metadata': responseData?.metadata,\r\n      'responseData.metadata.repeater': responseData?.metadata?.repeater\r\n    });\r\n    \r\n    return res.json(responseData);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 ERREUR D\u00C3\u2030TAILL\u00C3\u2030E lors de updateOrMoveNode:', {\r\n      error: error,\r\n      message: error.message,\r\n      stack: error.stack,\r\n      treeId: req.params?.treeId,\r\n      nodeId: req.params?.nodeId,\r\n      updateDataKeys: Object.keys(req.body || {}),\r\n      organizationId: req.user?.organizationId\r\n    });\r\n    res.status(500).json({ error: 'Impossible de mettre \u00C3\u00A0 jour le n\u00C5\u201Cud', details: error.message });\r\n  }\r\n};\r\n\r\n// PUT /api/treebranchleaf/trees/:treeId/nodes/:nodeId - Mettre \u00C3\u00A0 jour un n\u00C5\u201Cud\r\nrouter.put('/trees/:treeId/nodes/:nodeId', updateOrMoveNode);\r\n// PATCH (alias) pour compatibilit\u00C3\u00A9 c\u00C3\u00B4t\u00C3\u00A9 client\r\nrouter.patch('/trees/:treeId/nodes/:nodeId', updateOrMoveNode);\r\n\r\n// DELETE /api/treebranchleaf/trees/:treeId/nodes/:nodeId - Supprimer un n\u00C5\u201Cud\r\nrouter.delete('/trees/:treeId/nodes/:nodeId', async (req, res) => {\r\n  try {\r\n    const { treeId, nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = req.user! as { organizationId?: string; isSuperAdmin?: boolean };\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre appartient \u00C3\u00A0 l'organisation\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: { id: treeId }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // S\u00C3\u00A9curit\u00C3\u00A9 organisation\r\n    if (!isSuperAdmin && organizationId && tree.organizationId && tree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    // Charger tous les n\u00C5\u201Cuds de l'arbre pour calculer la sous-arborescence \u00C3\u00A0 supprimer\r\n    const allNodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId } });\r\n    const childrenByParent = new Map<string, string[]>();\r\n    for (const n of allNodes) {\r\n      if (!n.parentId) continue;\r\n      const arr = childrenByParent.get(n.parentId) || [];\r\n      arr.push(n.id);\r\n      childrenByParent.set(n.parentId, arr);\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'existence du n\u00C5\u201Cud cible\r\n    const exists = allNodes.find(n => n.id === nodeId);\r\n    if (!exists) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // Collecter tous les descendants (BFS)\r\n    const toDelete: string[] = [];\r\n    const queue: string[] = [nodeId];\r\n    const depth = new Map<string, number>();\r\n    depth.set(nodeId, 0);\r\n    while (queue.length) {\r\n      const cur = queue.shift()!;\r\n      toDelete.push(cur);\r\n      const children = childrenByParent.get(cur) || [];\r\n      for (const c of children) {\r\n        depth.set(c, (depth.get(cur) || 0) + 1);\r\n        queue.push(c);\r\n      }\r\n    }\r\n\r\n    // Avant suppression: collecter les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es point\u00C3\u00A9es par cette sous-arborescence\r\n    const referencedIds = new Set<string>();\r\n    for (const id of toDelete) {\r\n      const n = allNodes.find(x => x.id === id);\r\n      if (!n) continue;\r\n      if (n.sharedReferenceId) referencedIds.add(n.sharedReferenceId);\r\n      if (Array.isArray(n.sharedReferenceIds)) n.sharedReferenceIds.forEach(rid => rid && referencedIds.add(rid));\r\n    }\r\n\r\n    // Supprimer en partant des feuilles (profondeur d\u00C3\u00A9croissante) pour \u00C3\u00A9viter les contraintes FK parentId\r\n    toDelete.sort((a, b) => (depth.get(b)! - depth.get(a)!));\r\n\r\n    // Suppression transactionnelle\r\n    await prisma.$transaction(async (tx) => {\r\n      for (const id of toDelete) {\r\n        await tx.treeBranchLeafNode.delete({ where: { id } });\r\n      }\r\n    });\r\n\r\n    // Post-suppression: supprimer les r\u00C3\u00A9f\u00C3\u00A9rences suffix\u00C3\u00A9es orphelines (copies \"-1\") si elles ne sont plus r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9es ailleurs\r\n    let deletedOrphans = 0;\r\n    if (referencedIds.size > 0) {\r\n      const remaining = await prisma.treeBranchLeafNode.findMany({ where: { treeId } });\r\n      const stillRef = new Set<string>();\r\n      for (const n of remaining) {\r\n        if (n.sharedReferenceId && referencedIds.has(n.sharedReferenceId)) stillRef.add(n.sharedReferenceId);\r\n        if (Array.isArray(n.sharedReferenceIds)) for (const rid of n.sharedReferenceIds) if (referencedIds.has(rid)) stillRef.add(rid);\r\n      }\r\n\r\n      // Helper: v\u00C3\u00A9rifier suffixe de copie (ex: \"-1\", \"-2\")\r\n      const isCopySuffixed = (id: string) => /-\\d+$/.test(id);\r\n      const orphanRoots = Array.from(referencedIds).filter(id => !stillRef.has(id) && remaining.some(n => n.id === id) && isCopySuffixed(id));\r\n\r\n      if (orphanRoots.length > 0) {\r\n        // Construire ordre de suppression feuilles -> racines\r\n        const byParent = new Map<string, string[]>();\r\n        for (const n of remaining) {\r\n          if (!n.parentId) continue;\r\n          const arr = byParent.get(n.parentId) || [];\r\n          arr.push(n.id);\r\n          byParent.set(n.parentId, arr);\r\n        }\r\n        const delSet = new Set<string>();\r\n        const ddepth = new Map<string, number>();\r\n        for (const rid of orphanRoots) {\r\n          const q: string[] = [rid];\r\n          ddepth.set(rid, 0);\r\n          while (q.length) {\r\n            const cur = q.shift()!;\r\n            if (delSet.has(cur)) continue;\r\n            delSet.add(cur);\r\n            const d = ddepth.get(cur)!;\r\n            for (const c of (byParent.get(cur) || [])) { ddepth.set(c, d + 1); q.push(c); }\r\n          }\r\n        }\r\n        const ordered = Array.from(delSet).sort((a, b) => (ddepth.get(b)! - ddepth.get(a)!));\r\n        await prisma.$transaction(async (tx) => {\r\n          for (const id of ordered) {\r\n            await tx.treeBranchLeafNode.delete({ where: { id } });\r\n            deletedOrphans++;\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    // ------------------------------------------------------------------\r\n    // EXTRA CLEANUP: Supprimer les n\u0153uds d'affichage qui r\u00C3\u00A9f\u00C3\u00A9rencent les n\u0153uds supprim\u00E9s\r\n    // ------------------------------------------------------------------\r\n    try {\r\n      // Recharger l'arbre pour trouver d'eventuels nodes qui r\u00C3\u00A9f\u00C3\u00A9rencent les deleted IDs\r\n      const remainingNodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId } });\r\n      const nodesToScan = remainingNodes;\r\n      const removedSet = new Set(toDelete);\r\n\r\n      // Construire un set de template/roots potentiels li\u00C3\u00A9s (sourceTemplateId / copiedFromNodeId)\r\n      const relatedTemplateIds = new Set<string>();\r\n      const deletedSuffixes = new Set<string>(); // Suffixes des n\u0153uds supprim\u00E9s\r\n      const deletedParentIds = new Set<string>(); // ParentIds des n\u0153uds supprim\u00E9s (pour identifier la branche)\r\n      \r\n      console.log('\uD83D\uDDD1\uFE0F [DELETE DEBUG] N\u0153uds \u00E0 supprimer:', toDelete);\r\n      \r\n      for (const rid of toDelete) {\r\n        const n = allNodes.find(x => x.id === rid);\r\n        if (!n) continue;\r\n        const dm: any = n.metadata || {};\r\n        if (dm?.sourceTemplateId) relatedTemplateIds.add(String(dm.sourceTemplateId));\r\n        if (dm?.copiedFromNodeId) relatedTemplateIds.add(String(dm.copiedFromNodeId));\r\n        \r\n        // Extraire le suffixe du n\u0153ud supprim\u00E9 (ex: \"node-xyz-2\" \u2192 \"-2\")\r\n        const match = String(rid).match(/-(\\d+)$/);\r\n        if (match) {\r\n          deletedSuffixes.add(match[1]); // Stocker juste le num\u00E9ro (ex: \"2\")\r\n          console.log(`\uD83D\uDD22 [DELETE DEBUG] N\u0153ud ${rid} a le suffixe: -${match[1]}, parentId: ${n.parentId || 'N/A'}`);\r\n        }\r\n        \r\n        // Stocker le parentId pour identifier la branche\r\n        if (n.parentId) {\r\n          deletedParentIds.add(n.parentId);\r\n        }\r\n      }\r\n      \r\n      console.log('\uD83D\uDD22 [DELETE DEBUG] Suffixes d\u00E9tect\u00E9s:', Array.from(deletedSuffixes));\r\n      console.log('\uD83D\uDC68\u200D\uD83D\uDC69\u200D\uD83D\uDC67 [DELETE DEBUG] ParentIds des n\u0153uds supprim\u00E9s:', Array.from(deletedParentIds));\r\n\r\n      // Trouver candidats additionnels qui ressemblent \u00C3\u00A0 des n\u00C3\u00B8uds d'affichage\r\n      const extraCandidates = nodesToScan.filter(n => {\r\n        const meta: any = n.metadata || {};\r\n        const looksLikeDisplay = !!(meta?.autoCreateDisplayNode || meta?.copiedFromNodeId || meta?.fromVariableId || meta?.sourceTemplateId);\r\n        if (!looksLikeDisplay) return false;\r\n        if (removedSet.has(n.id)) return false;\r\n        \r\n        // 1. Champs d'affichage li\u00E9s par copiedFromNodeId/sourceTemplateId\r\n        // CORRECTIF CRITIQUE: V\u00E9rifier aussi que les suffixes correspondent\r\n        if (meta.copiedFromNodeId && (removedSet.has(String(meta.copiedFromNodeId)) || relatedTemplateIds.has(String(meta.copiedFromNodeId)))) {\r\n          // Extraire les suffixes pour comparaison\r\n          const copiedFromMatch = String(meta.copiedFromNodeId).match(/-(\\d+)$/);\r\n          const nodeMatch = String(n.id).match(/-(\\d+)$/);\r\n          const copiedFromSuffix = copiedFromMatch ? copiedFromMatch[1] : null;\r\n          const nodeSuffix = nodeMatch ? nodeMatch[1] : null;\r\n          \r\n          // R\u00C8GLE: Le n\u0153ud ne doit \u00EAtre supprim\u00E9 QUE si son suffixe correspond aux suffixes en cours de suppression\r\n          if (nodeSuffix) {\r\n            // Le n\u0153ud a un suffixe \u2192 v\u00E9rifier qu'il est dans deletedSuffixes\r\n            if (!deletedSuffixes.has(nodeSuffix)) {\r\n              console.log(`\u23ED\uFE0F [DELETE SKIP] N\u0153ud ${n.id} (${n.label}) \u2192 copiedFromNodeId match MAIS suffixe -${nodeSuffix} non supprim\u00E9 (on supprime: ${Array.from(deletedSuffixes).join(', ')})`);\r\n              return false;\r\n            }\r\n          }\r\n          \r\n          // Si les deux ont des suffixes, ils doivent \u00EAtre identiques\r\n          if (copiedFromSuffix && nodeSuffix && copiedFromSuffix !== nodeSuffix) {\r\n            console.log(`\u23ED\uFE0F [DELETE SKIP] N\u0153ud ${n.id} (${n.label}) \u2192 copiedFromNodeId match MAIS suffixe diff\u00E9rent (${nodeSuffix} != ${copiedFromSuffix})`);\r\n            return false; // Ne pas supprimer si les suffixes ne correspondent pas\r\n          }\r\n          \r\n          console.log(`\u2705 [DELETE MATCH] N\u0153ud ${n.id} (${n.label}) \u2192 copiedFromNodeId match (suffixe: ${nodeSuffix})`);\r\n          return true;\r\n        }\r\n        if (meta.sourceTemplateId && (removedSet.has(String(meta.sourceTemplateId)) || relatedTemplateIds.has(String(meta.sourceTemplateId)))) {\r\n          // M\u00EAme v\u00E9rification pour sourceTemplateId\r\n          const sourceMatch = String(meta.sourceTemplateId).match(/-(\\d+)$/);\r\n          const nodeMatch = String(n.id).match(/-(\\d+)$/);\r\n          const sourceSuffix = sourceMatch ? sourceMatch[1] : null;\r\n          const nodeSuffix = nodeMatch ? nodeMatch[1] : null;\r\n          \r\n          // R\u00C8GLE: Le n\u0153ud ne doit \u00EAtre supprim\u00E9 QUE si son suffixe correspond aux suffixes en cours de suppression\r\n          if (nodeSuffix) {\r\n            if (!deletedSuffixes.has(nodeSuffix)) {\r\n              console.log(`\u23ED\uFE0F [DELETE SKIP] N\u0153ud ${n.id} (${n.label}) \u2192 sourceTemplateId match MAIS suffixe -${nodeSuffix} non supprim\u00E9 (on supprime: ${Array.from(deletedSuffixes).join(', ')})`);\r\n              return false;\r\n            }\r\n          }\r\n          \r\n          if (sourceSuffix && nodeSuffix && sourceSuffix !== nodeSuffix) {\r\n            console.log(`\u23ED\uFE0F [DELETE SKIP] N\u0153ud ${n.id} (${n.label}) \u2192 sourceTemplateId match MAIS suffixe diff\u00E9rent (${nodeSuffix} != ${sourceSuffix})`);\r\n            return false;\r\n          }\r\n          \r\n          console.log(`\u2705 [DELETE MATCH] N\u0153ud ${n.id} (${n.label}) \u2192 sourceTemplateId match (suffixe: ${nodeSuffix})`);\r\n          return true;\r\n        }\r\n        \r\n        // 2. Champs d'affichage li\u00E9s par fromVariableId\r\n        if (meta.fromVariableId) {\r\n          const fromVarStr = String(meta.fromVariableId || '');\r\n          for (const rid of Array.from(removedSet)) {\r\n            const ridStr = String(rid);\r\n            if (fromVarStr === ridStr) {\r\n              console.log(`\u2705 [DELETE MATCH] N\u0153ud ${n.id} (${n.label}) \u2192 fromVariableId equals ${rid}`);\r\n              return true;\r\n            }\r\n            const m = ridStr.match(/-(\\d+)$/);\r\n            if (m && fromVarStr.endsWith(`-${m[1]}`)) {\r\n              console.log(`\u2705 [DELETE MATCH] N\u0153ud ${n.id} (${n.label}) \u2192 fromVariableId endsWith suffix -${m[1]} referencing ${rid}`);\r\n              return true;\r\n            }\r\n          }\r\n          for (const tid of Array.from(relatedTemplateIds)) {\r\n            const tidStr = String(tid);\r\n            if (fromVarStr === tidStr) {\r\n              console.log(`\u2705 [DELETE MATCH] N\u0153ud ${n.id} (${n.label}) \u2192 fromVariableId equals template ${tid}`);\r\n              return true;\r\n            }\r\n            const m = tidStr.match(/-(\\d+)$/);\r\n            if (m && fromVarStr.endsWith(`-${m[1]}`)) {\r\n              console.log(`\u2705 [DELETE MATCH] N\u0153ud ${n.id} (${n.label}) \u2192 fromVariableId endsWith suffix -${m[1]} referencing template ${tid}`);\r\n              return true;\r\n            }\r\n          }\r\n        }\r\n        \r\n        // 3. CORRECTIF: Supprimer les fr\u00E8res/s\u0153urs (m\u00EAme parentId) avec le m\u00EAme suffixe\r\n        // Ex: Si on supprime \"Versant-2\" (parent X), supprimer tous les champs du m\u00EAme parent avec \"-2\"\r\n        // \u26A0\uFE0F CRITIQUE: V\u00E9rifier AUSSI le suffixe pour \u00E9viter de supprimer -1 lors de suppression de -2\r\n        if (deletedSuffixes.size > 0 && n.parentId && deletedParentIds.has(n.parentId)) {\r\n          const nodeMatch = String(n.id).match(/-(\\d+)$/);\r\n          const nodeSuffix = nodeMatch ? nodeMatch[1] : null;\r\n          \r\n          // \u2705 R\u00C8GLE STRICTE: Le noeud doit avoir un suffixe ET ce suffixe doit \u00EAtre dans deletedSuffixes\r\n          if (nodeSuffix && deletedSuffixes.has(nodeSuffix)) {\r\n            console.log(`\u2705 [DELETE MATCH SUFFIXE] N\u0153ud ${n.id} (${n.label}) \u2192 m\u00EAme parent + suffixe -${nodeSuffix} (on supprime: -${Array.from(deletedSuffixes).join(', -')})`);\r\n            return true; // M\u00EAme branche + m\u00EAme suffixe \u2192 \u00E0 supprimer\r\n          }\r\n          \r\n          // Aussi v\u00E9rifier le label pour les display nodes\r\n          const labelMatch = String(n.label || '').match(/-(\\d+)$/);\r\n          const labelSuffix = labelMatch ? labelMatch[1] : null;\r\n          if (labelSuffix && deletedSuffixes.has(labelSuffix)) {\r\n            console.log(`\u2705 [DELETE MATCH SUFFIXE LABEL] N\u0153ud ${n.id} (${n.label}) \u2192 label avec suffixe -${labelSuffix} (on supprime: -${Array.from(deletedSuffixes).join(', -')})`);\r\n            return true;\r\n          }\r\n          \r\n          // V\u00E9rifier fromVariableId pour le suffixe\r\n          if (meta.fromVariableId) {\r\n            const varMatch = String(meta.fromVariableId).match(/-(\\d+)$/);\r\n            const varSuffix = varMatch ? varMatch[1] : null;\r\n            if (varSuffix && deletedSuffixes.has(varSuffix)) {\r\n              console.log(`\u2705 [DELETE MATCH SUFFIXE VAR] N\u0153ud ${n.id} (${n.label}) \u2192 fromVariableId avec suffixe -${varSuffix} (on supprime: -${Array.from(deletedSuffixes).join(', -')})`);\r\n              return true;\r\n            }\r\n          }\r\n          \r\n          // \u23ED\uFE0F Si le noeud a le m\u00EAme parent MAIS un suffixe diff\u00E9rent, NE PAS supprimer\r\n          if (nodeSuffix && !deletedSuffixes.has(nodeSuffix)) {\r\n            console.log(`\u23ED\uFE0F [DELETE SKIP SUFFIXE] N\u0153ud ${n.id} (${n.label}) \u2192 m\u00EAme parent MAIS suffixe -${nodeSuffix} diff\u00E9rent (on supprime seulement: -${Array.from(deletedSuffixes).join(', -')})`);\r\n          }\r\n        }\r\n        \r\n        return false;\r\n      });\r\n      \r\n      console.log(`\uD83D\uDCCA [DELETE DEBUG] ${extraCandidates.length} candidats suppl\u00E9mentaires trouv\u00E9s:`, extraCandidates.map(c => ({ id: c.id, label: c.label, parentId: c.parentId })));\r\n\r\n      if (extraCandidates.length > 0) {\r\n        // Supprimer ces candidats (ordre enfants -> parents)\r\n        const byParent = new Map<string, string[]>();\r\n        for (const n of remainingNodes) {\r\n          if (!n.parentId) continue;\r\n          const arr = byParent.get(n.parentId) || [];\r\n          arr.push(n.id);\r\n          byParent.set(n.parentId, arr);\r\n        }\r\n        const delSet = new Set<string>();\r\n        const ddepth = new Map<string, number>();\r\n        for (const cand of extraCandidates) {\r\n          const q: string[] = [cand.id];\r\n          ddepth.set(cand.id, 0);\r\n          while (q.length) {\r\n            const cur = q.shift()!;\r\n            if (delSet.has(cur)) continue;\r\n            delSet.add(cur);\r\n            const d = ddepth.get(cur)!;\r\n            for (const c of (byParent.get(cur) || [])) { ddepth.set(c, d + 1); q.push(c); }\r\n          }\r\n        }\r\n        const ordered = Array.from(delSet).sort((a, b) => (ddepth.get(b)! - ddepth.get(a)!));\r\n        let deletedExtra = 0;\r\n        const deletedExtraIds: string[] = [];\r\n        await prisma.$transaction(async (tx) => {\r\n          for (const id of ordered) {\r\n            try {\r\n              await tx.treeBranchLeafNode.delete({ where: { id } });\r\n              deletedExtra++;\r\n              deletedExtraIds.push(id);\r\n            } catch (e) {\r\n              console.warn('[DELETE EXTRA] Failed to delete node', id, (e as Error).message);\r\n            }\r\n          }\r\n        });\r\n        console.log('[DELETE] Extra display nodes deleted:', deletedExtra);\r\n        console.log(' [DELETE FINAL] Total supprim\u00E9:', toDelete.length, '+ extra:', deletedExtra, '= ', toDelete.length + deletedExtra);\r\n        \r\n        const allDeletedIds = [...toDelete, ...deletedExtraIds];\r\n        res.json({ \r\n          success: true, \r\n          message: `Sous-arbre supprim\u00E9 (${toDelete.length} n\u0153ud(s)), orphelines supprim\u00E9es: ${deletedOrphans}`, \r\n          deletedCount: allDeletedIds.length, \r\n          deletedOrphans,\r\n          deletedIds: allDeletedIds\r\n        });\r\n        return;\r\n      }\r\n    } catch (e) {\r\n      console.warn('[DELETE] Extra cleanup failed', (e as Error).message);\r\n    }\r\n\r\n    res.json({ \r\n      success: true, \r\n      message: `Sous-arbre supprim\u00E9 (${toDelete.length} n\u0153ud(s)), orphelines supprim\u00E9es: ${deletedOrphans}`, \r\n      deletedCount: toDelete.length, \r\n      deletedOrphans,\r\n      deletedIds: toDelete\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error deleting node subtree:', error);\r\n    res.status(500).json({ error: 'Impossible de supprimer le n\u00C5\u201Cud et ses descendants' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00EF\u00BF\u00BD NODE INFO - Infos d'un n\u00C5\u201Cud par ID\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId\r\n// Retourne des infos minimales du n\u00C5\u201Cud (pour r\u00C3\u00A9cup\u00C3\u00A9rer le treeId depuis nodeId)\r\nrouter.get('/nodes/:nodeId', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n  const { organizationId, isSuperAdmin } = req.user! as { organizationId?: string; isSuperAdmin?: boolean };\r\n\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      select: {\r\n        id: true,\r\n        treeId: true,\r\n        parentId: true,\r\n        type: true,\r\n        subType: true,\r\n        label: true,\r\n        TreeBranchLeafTree: { select: { organizationId: true } }\r\n      }\r\n    });\r\n\r\n    if (!node) return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    // Autoriser si super admin ou si aucune organisation n'est fournie (mode dev),\r\n    // sinon v\u00C3\u00A9rifier la correspondance des organisations\r\n    const nodeOrg = node.TreeBranchLeafTree?.organizationId;\r\n    const hasOrgCtx = typeof organizationId === 'string' && organizationId.length > 0;\r\n    if (!isSuperAdmin && hasOrgCtx && nodeOrg && nodeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    return res.json({ id: node.id, treeId: node.treeId, parentId: node.parentId, type: node.type, subType: node.subType, label: node.label });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node info:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u017D ANALYSE COMPL\u00C3\u02C6TE D'UNE BRANCHE (CASCADE + R\u00C3\u2030F\u00C3\u2030RENCES)\r\n// =============================================================================\r\n// GET /api/treebranchleaf/nodes/:nodeId/full\r\n// Retourne la branche compl\u00C3\u00A8te \u00C3\u00A0 partir d'un n\u00C5\u201Cud: tous les descendants, les options,\r\n// et les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es R\u00C3\u2030SOLUES (objets complets) sans doublons\r\nrouter.get('/nodes/:nodeId/full', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // Charger le n\u00C5\u201Cud et contr\u00C3\u00B4ler l'acc\u00C3\u00A8s via l'arbre parent\r\n    const root = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n    });\r\n    if (!root) return res.status(404).json({ error: 'N\u00C5\u201Cud introuvable' });\r\n    if (!isSuperAdmin && organizationId && root.TreeBranchLeafTree?.organizationId && root.TreeBranchLeafTree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s non autoris\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds de l'arbre pour construire les relations parent/enfants\r\n    const all = await prisma.treeBranchLeafNode.findMany({ where: { treeId: root.treeId } });\r\n    const byId = new Map(all.map(n => [n.id, n] as const));\r\n    const childrenByParent = new Map<string, string[]>();\r\n    for (const n of all) {\r\n      if (!n.parentId) continue;\r\n      const arr = childrenByParent.get(n.parentId) || [];\r\n      arr.push(n.id);\r\n      childrenByParent.set(n.parentId, arr);\r\n    }\r\n\r\n    // Parcours de la branche (descendants) sans doublons\r\n    const collected = new Set<string>();\r\n    const queue: string[] = [root.id];\r\n    while (queue.length) {\r\n      const cur = queue.shift()!;\r\n      if (collected.has(cur)) continue;\r\n      collected.add(cur);\r\n      const children = childrenByParent.get(cur) || [];\r\n      for (const c of children) queue.push(c);\r\n    }\r\n\r\n    // Collecter les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es li\u00C3\u00A9es \u00C3\u00A0 la branche et les r\u00C3\u00A9soudre (objets complets)\r\n    const sharedIds = new Set<string>();\r\n    for (const id of collected) {\r\n      const n = byId.get(id);\r\n      if (!n) continue;\r\n      if (n.sharedReferenceId) sharedIds.add(n.sharedReferenceId);\r\n      if (Array.isArray(n.sharedReferenceIds)) for (const rid of n.sharedReferenceIds) sharedIds.add(rid);\r\n    }\r\n\r\n    const sharedNodes = (sharedIds.size > 0)\r\n      ? await prisma.treeBranchLeafNode.findMany({ where: { id: { in: Array.from(sharedIds) } } })\r\n      : [];\r\n    const sharedById = new Map(sharedNodes.map(n => [n.id, n] as const));\r\n\r\n    // Construire la r\u00C3\u00A9ponse enrichie pour chaque n\u00C5\u201Cud de la branche\r\n    const nodes = Array.from(collected).map(id => {\r\n      const node = byId.get(id)!;\r\n      const response = buildResponseFromColumns(node);\r\n      const childIds = childrenByParent.get(id) || [];\r\n      const optionChildrenIds = childIds.filter(cid => (byId.get(cid)?.type || '').toLowerCase() === 'leaf_option'.toLowerCase());\r\n\r\n      // R\u00C3\u00A9solution des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es de ce n\u00C5\u201Cud\r\n      const resolvedShared = [] as Array<Record<string, unknown>>;\r\n      if (node.sharedReferenceId && sharedById.has(node.sharedReferenceId)) {\r\n        resolvedShared.push(buildResponseFromColumns(sharedById.get(node.sharedReferenceId)!));\r\n      }\r\n      if (Array.isArray(node.sharedReferenceIds)) {\r\n        for (const rid of node.sharedReferenceIds) {\r\n          if (sharedById.has(rid)) resolvedShared.push(buildResponseFromColumns(sharedById.get(rid)!));\r\n        }\r\n      }\r\n\r\n      return {\r\n        ...response,\r\n        childrenIds: childIds,\r\n        optionChildrenIds,\r\n        sharedReferencesResolved: resolvedShared\r\n      };\r\n    });\r\n\r\n    // Index rapide et racine enrichie\r\n    res.json({\r\n      rootId: root.id,\r\n      treeId: root.treeId,\r\n      count: nodes.length,\r\n      nodes\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [/nodes/:nodeId/full] Erreur:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\u00E2\u20AC\u2122analyse compl\u00C3\u00A8te de la branche' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u017D ANALYSE CIBL\u00C3\u2030E DES R\u00C3\u2030F\u00C3\u2030RENCES PARTAG\u00C3\u2030ES D'UN N\u00C5\u2019UD\r\n// =============================================================================\r\n// GET /api/treebranchleaf/nodes/:nodeId/shared-references\r\n// Inspecte uniquement les colonnes sharedReferenceId + sharedReferenceIds du n\u00C5\u201Cud cibl\u00C3\u00A9\r\n// et retourne les n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s (r\u00C3\u00A9solus), avec un indicateur de \"champ conditionnel\".\r\nrouter.get('/nodes/:nodeId/shared-references', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // 1) Charger le n\u00C5\u201Cud et contr\u00C3\u00B4ler l'acc\u00C3\u00A8s via l'arbre parent\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n    });\r\n    if (!node) return res.status(404).json({ error: 'N\u00C5\u201Cud introuvable' });\r\n    if (!isSuperAdmin && organizationId && node.TreeBranchLeafTree?.organizationId && node.TreeBranchLeafTree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s non autoris\u00C3\u00A9' });\r\n    }\r\n\r\n    // 2) Extraire les IDs des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es \u00C3\u00A0 partir du n\u00C5\u201Cud\r\n    const ids = new Set<string>();\r\n    if (node.sharedReferenceId) ids.add(node.sharedReferenceId);\r\n    if (Array.isArray(node.sharedReferenceIds)) for (const rid of node.sharedReferenceIds) ids.add(rid);\r\n\r\n    if (ids.size === 0) {\r\n      return res.json({ nodeId, count: 0, shared: { ids: { single: node.sharedReferenceId ?? null, multiple: [] }, resolved: [] } });\r\n    }\r\n\r\n    // 3) Charger les n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s et d\u00C3\u00A9terminer s'ils sont \"conditionnels\"\r\n    const refs = await prisma.treeBranchLeafNode.findMany({ where: { id: { in: Array.from(ids) } } });\r\n    const refIds = refs.map(r => r.id);\r\n    const conditionCounts = await prisma.treeBranchLeafNodeCondition.groupBy({\r\n      by: ['nodeId'],\r\n      _count: { nodeId: true },\r\n      where: { nodeId: { in: refIds } }\r\n    });\r\n    const condCountByNode = new Map(conditionCounts.map(c => [c.nodeId, c._count.nodeId] as const));\r\n\r\n    const resolved = refs.map(ref => {\r\n      const enriched = buildResponseFromColumns(ref);\r\n      const hasCondFlag = !!ref.hasCondition || (condCountByNode.get(ref.id) || 0) > 0;\r\n      return { ...enriched, isConditional: hasCondFlag, conditionCount: condCountByNode.get(ref.id) || 0 };\r\n    });\r\n\r\n    // 4) R\u00C3\u00A9ponse structur\u00C3\u00A9e\r\n    res.json({\r\n      nodeId,\r\n      count: resolved.length,\r\n      shared: {\r\n        ids: {\r\n          single: node.sharedReferenceId ?? null,\r\n          multiple: Array.isArray(node.sharedReferenceIds) ? node.sharedReferenceIds : []\r\n        },\r\n        resolved\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [/nodes/:nodeId/shared-references] Erreur:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\u00E2\u20AC\u2122analyse des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u0081 APPLIQUER LES R\u00C3\u2030F\u00C3\u2030RENCES PARTAG\u00C3\u2030ES DU GABARIT ORIGINAL \u00C3\u20AC LA COPIE\r\n// =============================================================================\r\n// POST /api/treebranchleaf/nodes/:nodeId/apply-shared-references-from-original\r\n// Pour un n\u00C5\u201Cud copi\u00C3\u00A9 (ayant metadata.copiedFromNodeId), propage les colonnes\r\n// sharedReferenceId/sharedReferenceIds de CHAQUE n\u00C5\u201Cud original vers le n\u00C5\u201Cud copi\u00C3\u00A9\r\n// correspondant (reconnu par metadata.copiedFromNodeId), sans cr\u00C3\u00A9er d'enfants.\r\nasync function applySharedReferencesFromOriginalInternal(req: MinimalReq, nodeId: string): Promise<{ success: true; applied: number; suffix: number }> {\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n  // 1) Charger la copie et l'arbre pour contr\u00C3\u00B4le d'acc\u00C3\u00A8s\r\n  const copyRoot = await prisma.treeBranchLeafNode.findFirst({\r\n    where: { id: nodeId },\r\n    include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n  });\r\n  if (!copyRoot) throw new Error('N\u00C5\u201Cud introuvable');\r\n  if (!isSuperAdmin && organizationId && copyRoot.TreeBranchLeafTree?.organizationId && copyRoot.TreeBranchLeafTree.organizationId !== organizationId) {\r\n    throw new Error('Acc\u00C3\u00A8s non autoris\u00C3\u00A9');\r\n  }\r\n\r\n  // 2) R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds de l'arbre et construire la sous-arborescence de la copie\r\n  const all = await prisma.treeBranchLeafNode.findMany({ where: { treeId: copyRoot.treeId } });\r\n  const byId = new Map(all.map(n => [n.id, n] as const));\r\n  const childrenByParent = new Map<string, string[]>();\r\n  for (const n of all) {\r\n    if (!n.parentId) continue;\r\n    const arr = childrenByParent.get(n.parentId) || [];\r\n    arr.push(n.id);\r\n    childrenByParent.set(n.parentId, arr);\r\n  }\r\n\r\n  const collectedCopyIds = new Set<string>();\r\n  const queue: string[] = [copyRoot.id];\r\n  while (queue.length) {\r\n    const cur = queue.shift()!;\r\n    if (collectedCopyIds.has(cur)) continue;\r\n    collectedCopyIds.add(cur);\r\n    for (const c of (childrenByParent.get(cur) || [])) queue.push(c);\r\n  }\r\n\r\n  // 3) Construire le mapping originalId -> copyId via metadata.copiedFromNodeId\r\n  const originalToCopy = new Map<string, string>();\r\n  for (const id of collectedCopyIds) {\r\n    const n = byId.get(id);\r\n    if (!n) continue;\r\n    const meta = (n.metadata || {}) as Record<string, unknown>;\r\n    const origId = String(meta.copiedFromNodeId || '');\r\n    if (origId) originalToCopy.set(origId, n.id);\r\n  }\r\n  if (originalToCopy.size === 0) return { success: true, applied: 0, suffix: 0 };\r\n\r\n  // 4) Charger les originaux concern\u00C3\u00A9s et pr\u00C3\u00A9parer les mises \u00C3\u00A0 jour\r\n  const originalIds = Array.from(originalToCopy.keys());\r\n  const originals = await prisma.treeBranchLeafNode.findMany({ where: { id: { in: originalIds } } });\r\n\r\n  // 4bis) Collecter toutes les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es point\u00C3\u00A9es par ces originaux\r\n  const allRefIds = new Set<string>();\r\n  for (const orig of originals) {\r\n    if (orig.sharedReferenceId) allRefIds.add(orig.sharedReferenceId);\r\n    if (Array.isArray(orig.sharedReferenceIds)) orig.sharedReferenceIds.forEach(id => id && allRefIds.add(id));\r\n  }\r\n\r\n  // 4ter) D\u00C3\u00A9terminer le suffixe \u00C3\u00A0 utiliser pour CETTE copie, puis construire/assurer les copies des r\u00C3\u00A9f\u00C3\u00A9rences (ID suffix\u00C3\u00A9 \"-N\")\r\n  // a) D\u00C3\u00A9terminer/attribuer le suffixe\r\n  const metaRoot = (copyRoot.metadata as any) || {};\r\n  let chosenSuffix: number | null = typeof metaRoot.copySuffix === 'number' ? metaRoot.copySuffix : null;\r\n  if (!chosenSuffix) {\r\n    // Chercher le prochain suffixe disponible en scannant les IDs de r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es existantes\r\n    let maxSuffix = 0;\r\n    const SUFFIX_RE = /^(shared-ref-[A-Za-z0-9_\\-]+)-(\\d+)$/;\r\n    for (const n of all) {\r\n      const m = typeof n.id === 'string' ? n.id.match(SUFFIX_RE) : null;\r\n      if (m) {\r\n        const num = Number(m[2]);\r\n        if (!Number.isNaN(num)) maxSuffix = Math.max(maxSuffix, num);\r\n      }\r\n    }\r\n    chosenSuffix = maxSuffix + 1 || 1;\r\n    // Persister ce suffixe sur la racine de la copie pour qu'il soit r\u00C3\u00A9utilis\u00C3\u00A9 ensuite\r\n    await prisma.treeBranchLeafNode.update({ where: { id: copyRoot.id }, data: { metadata: { ...metaRoot, copySuffix: chosenSuffix } as any } });\r\n  }\r\n\r\n  // b) Construire/assurer les copies des r\u00C3\u00A9f\u00C3\u00A9rences avec ce suffixe\r\n  const refCopyIdByOriginal = new Map<string, string>();\r\n  const desiredIds = Array.from(allRefIds).map(id => `${id}-${chosenSuffix}`);\r\n  const existingRefCopies = desiredIds.length > 0\r\n    ? await prisma.treeBranchLeafNode.findMany({ where: { id: { in: desiredIds } } })\r\n    : [];\r\n  const existingSet = new Set(existingRefCopies.map(n => n.id));\r\n\r\n  const ensureRefCopy = async (origRefId: string): Promise<string> => {\r\n    const desiredRootId = `${origRefId}-${chosenSuffix}`;\r\n    if (existingSet.has(desiredRootId)) {\r\n      refCopyIdByOriginal.set(origRefId, desiredRootId);\r\n      return desiredRootId;\r\n    }\r\n\r\n    // Construire le sous-arbre \u00C3\u00A0 copier (IDs originaux)\r\n    const subtreeIds: string[] = [];\r\n    const q: string[] = [origRefId];\r\n    const seen = new Set<string>();\r\n    while (q.length) {\r\n      const cur = q.shift()!;\r\n      if (seen.has(cur)) continue;\r\n      seen.add(cur);\r\n      subtreeIds.push(cur);\r\n      const kids = childrenByParent.get(cur) || [];\r\n      for (const cid of kids) q.push(cid);\r\n    }\r\n\r\n    const origSubtree = subtreeIds.map(id => byId.get(id)).filter(Boolean) as typeof all;\r\n    const desired = new Set(subtreeIds.map(id => `${id}-${chosenSuffix}`));\r\n    if (desired.size > 0) {\r\n      const already = await prisma.treeBranchLeafNode.findMany({ where: { id: { in: Array.from(desired) } } });\r\n      for (const n of already) desired.delete(n.id);\r\n    }\r\n\r\n    const idMap = new Map<string, string>();\r\n    for (const id of subtreeIds) idMap.set(id, `${id}-${chosenSuffix}`);\r\n\r\n    for (const orig of origSubtree) {\r\n      const newId = idMap.get(orig.id)!;\r\n      if (!desired.has(newId)) continue;\r\n      const newParentId = orig.parentId ? idMap.get(orig.parentId) ?? null : null;\r\n      const toCreate: Prisma.TreeBranchLeafNodeCreateInput = {\r\n        id: newId,\r\n        treeId: copyRoot.treeId,\r\n        type: orig.type,\r\n        subType: orig.subType,\r\n        fieldType: (orig as any).fieldType ?? 'TEXT',\r\n        label: orig.label,\r\n        description: orig.description,\r\n        parentId: newParentId,\r\n        order: orig.order ?? 9999,\r\n        isVisible: orig.isVisible ?? true,\r\n        isActive: orig.isActive ?? true,\r\n        isRequired: orig.isRequired ?? false,\r\n        isMultiple: orig.isMultiple ?? false,\r\n        hasData: false,\r\n        hasFormula: false,\r\n        hasCondition: false,\r\n        hasTable: false,\r\n        hasAPI: false,\r\n        hasLink: false,\r\n        hasMarkers: false,\r\n        isSharedReference: orig.id === origRefId ? true : (orig as any).isSharedReference ?? false,\r\n        sharedReferenceId: null,\r\n        sharedReferenceIds: [],\r\n        sharedReferenceName: orig.sharedReferenceName ?? orig.label ?? null,\r\n        sharedReferenceDescription: orig.sharedReferenceDescription ?? orig.description ?? null,\r\n        // \uD83D\uDD17 COLONNES LINKED*** : Copier les r\u00E9f\u00E9rences depuis le n\u0153ud original avec IDs suffix\u00E9s\r\n        linkedFormulaIds: Array.isArray((orig as any).linkedFormulaIds)\r\n          ? (orig as any).linkedFormulaIds.map((id: string) => `${id}-${chosenSuffix}`).filter(Boolean)\r\n          : [],\r\n        linkedConditionIds: Array.isArray((orig as any).linkedConditionIds)\r\n          ? (orig as any).linkedConditionIds.map((id: string) => `${id}-${chosenSuffix}`).filter(Boolean)\r\n          : [],\r\n        linkedTableIds: Array.isArray((orig as any).linkedTableIds)\r\n          ? (orig as any).linkedTableIds.map((id: string) => `${id}-${chosenSuffix}`).filter(Boolean)\r\n          : [],\r\n        linkedVariableIds: Array.isArray((orig as any).linkedVariableIds)\r\n          ? (orig as any).linkedVariableIds.map((id: string) => `${id}-${chosenSuffix}`).filter(Boolean)\r\n          : [],\r\n        metadata: { ...(orig.metadata as any || {}), copiedFromNodeId: orig.id } as any,\r\n        updatedAt: new Date(),\r\n      };\r\n      await prisma.treeBranchLeafNode.create({ data: toCreate });\r\n      \r\n      // \uD83D\uDD17 COPIER LES VARIABLES r\u00E9f\u00E9renc\u00E9es par ce n\u0153ud\r\n      if (Array.isArray((orig as any).linkedVariableIds) && (orig as any).linkedVariableIds.length > 0) {\r\n        console.log(`\uD83D\uDD17 [SHARED-REF] Copie de ${(orig as any).linkedVariableIds.length} variable(s) pour ${newId}`);\r\n        \r\n        const variableCopyCache = new Map<string, string>();\r\n        const formulaIdMap = new Map<string, string>();\r\n        const conditionIdMap = new Map<string, string>();\r\n        const tableIdMap = new Map<string, string>();\r\n        // \uD83D\uDD11 IMPORTANT : Utiliser originalToCopy qui contient TOUS les n\u0153uds copi\u00E9s (pas juste le shared-ref)\r\n        const globalNodeIdMap = new Map<string, string>([...originalToCopy, ...idMap]);\r\n        \r\n        for (const originalVarId of (orig as any).linkedVariableIds) {\r\n          try {\r\n            // Appeler copyVariableWithCapacities pour cr\u00E9er la variable\r\n            const copyResult = await copyVariableWithCapacities(\r\n              originalVarId,\r\n              chosenSuffix!,\r\n              newId, // Le nouveau n\u0153ud qui poss\u00E8de cette variable\r\n              prisma,\r\n              {\r\n                formulaIdMap,\r\n                conditionIdMap,\r\n                tableIdMap,\r\n                nodeIdMap: globalNodeIdMap, // Utiliser le mapping global\r\n                variableCopyCache,\r\n                autoCreateDisplayNode: true\r\n              }\r\n            );\r\n            \r\n            if (copyResult.success) {\r\n              console.log(`  \u2705 [SHARED-REF] Variable copi\u00E9e: ${copyResult.variableId}`);\r\n            } else {\r\n              console.warn(`  \u26A0\uFE0F [SHARED-REF] \u00C9chec copie variable ${originalVarId}: ${copyResult.error}`);\r\n            }\r\n          } catch (e) {\r\n            console.warn(`  \u26A0\uFE0F [SHARED-REF] Erreur copie variable ${originalVarId}:`, (e as Error).message);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    refCopyIdByOriginal.set(origRefId, desiredRootId);\r\n    return desiredRootId;\r\n  };\r\n\r\n  for (const rid of allRefIds) await ensureRefCopy(rid);\r\n\r\n  const updates: Array<Promise<unknown>> = [];\r\n  let applied = 0;\r\n  for (const orig of originals) {\r\n    const copyId = originalToCopy.get(orig.id)!;\r\n    const origMultiple = Array.isArray(orig.sharedReferenceIds) ? orig.sharedReferenceIds.filter(Boolean) : [];\r\n    const origSingle = orig.sharedReferenceId ?? null;\r\n    const mappedMultiple = origMultiple.map(id => refCopyIdByOriginal.get(id) || `${id}-${chosenSuffix}`);\r\n    const mappedSingle = origSingle ? (refCopyIdByOriginal.get(origSingle) || `${origSingle}-${chosenSuffix}`) : null;\r\n    const finalArray = mappedMultiple.length > 0 ? mappedMultiple : (mappedSingle ? [mappedSingle] : []);\r\n    const finalSingle = finalArray.length > 0 ? finalArray[0] : null;\r\n    updates.push(prisma.treeBranchLeafNode.update({\r\n      where: { id: copyId },\r\n      data: {\r\n        sharedReferenceId: finalSingle,\r\n        sharedReferenceIds: finalArray,\r\n        sharedReferenceName: orig.sharedReferenceName ?? null,\r\n        sharedReferenceDescription: orig.sharedReferenceDescription ?? null,\r\n        isSharedReference: false,\r\n        hasData: orig.hasData,\r\n        updatedAt: new Date()\r\n      }\r\n    }));\r\n    applied++;\r\n  }\r\n\r\n  await prisma.$transaction(updates);\r\n  return { success: true, applied, suffix: chosenSuffix! };\r\n}\r\n\r\n// Route HTTP qui appelle la fonction interne\r\nrouter.post('/nodes/:nodeId/apply-shared-references-from-original', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const result = await applySharedReferencesFromOriginalInternal(req as unknown as MinimalReq, nodeId);\r\n    return res.json(result);\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [/nodes/:nodeId/apply-shared-references-from-original] Erreur:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'application des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00B9 D\u00C3\u2030LIER (ET OPTIONNELLEMENT SUPPRIMER) LES R\u00C3\u2030F\u00C3\u2030RENCES PARTAG\u00C3\u2030ES D'UNE COPIE\r\n// =============================================================================\r\n// POST /api/treebranchleaf/nodes/:nodeId/unlink-shared-references\r\n// - D\u00C3\u00A9lie toutes les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es (sharedReferenceId/sharedReferenceIds) dans la sous-arborescence du n\u00C5\u201Cud\r\n// - Optionnel: supprime les sous-arbres de r\u00C3\u00A9f\u00C3\u00A9rences copi\u00C3\u00A9es (suffix\u00C3\u00A9es) devenues orphelines\r\nrouter.post('/nodes/:nodeId/unlink-shared-references', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { deleteOrphans } = (req.body || {}) as { deleteOrphans?: boolean };\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // 1) Charger le n\u00C5\u201Cud et contr\u00C3\u00B4ler l'acc\u00C3\u00A8s via l'arbre parent\r\n    const root = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n    });\r\n    if (!root) return res.status(404).json({ error: 'N\u00C5\u201Cud introuvable' });\r\n    if (!isSuperAdmin && organizationId && root.TreeBranchLeafTree?.organizationId && root.TreeBranchLeafTree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s non autoris\u00C3\u00A9' });\r\n    }\r\n\r\n    // 2) R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds de l'arbre pour relations parent/enfant\r\n    const all = await prisma.treeBranchLeafNode.findMany({ where: { treeId: root.treeId } });\r\n    const byId = new Map(all.map(n => [n.id, n] as const));\r\n    const childrenByParent = new Map<string, string[]>();\r\n    for (const n of all) {\r\n      if (!n.parentId) continue;\r\n      const arr = childrenByParent.get(n.parentId) || [];\r\n      arr.push(n.id);\r\n      childrenByParent.set(n.parentId, arr);\r\n    }\r\n\r\n    // 3) Collecter la sous-arborescence du n\u00C5\u201Cud\r\n    const collected = new Set<string>();\r\n    const queue: string[] = [root.id];\r\n    while (queue.length) {\r\n      const cur = queue.shift()!;\r\n      if (collected.has(cur)) continue;\r\n      collected.add(cur);\r\n      for (const c of (childrenByParent.get(cur) || [])) queue.push(c);\r\n    }\r\n\r\n    // 4) Collecter toutes les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es point\u00C3\u00A9es par cette sous-arborescence\r\n    const referencedIds = new Set<string>();\r\n    for (const id of collected) {\r\n      const n = byId.get(id);\r\n      if (!n) continue;\r\n      if (n.sharedReferenceId) referencedIds.add(n.sharedReferenceId);\r\n      if (Array.isArray(n.sharedReferenceIds)) n.sharedReferenceIds.forEach(rid => rid && referencedIds.add(rid));\r\n    }\r\n\r\n    // 5) D\u00C3\u00A9lier: mettre sharedReferenceId=null et sharedReferenceIds=[] sur TOUTE la sous-arborescence\r\n    const updates: Array<Promise<unknown>> = [];\r\n    for (const id of collected) {\r\n      updates.push(prisma.treeBranchLeafNode.update({ where: { id }, data: { sharedReferenceId: null, sharedReferenceIds: [] as string[] } }));\r\n    }\r\n    await prisma.$transaction(updates);\r\n\r\n    let deletedCount = 0;\r\n    let orphanCandidates: string[] = [];\r\n\r\n    // 6) Optionnel: supprimer les r\u00C3\u00A9f\u00C3\u00A9rences suffix\u00C3\u00A9es devenues orphelines\r\n    if (deleteOrphans && referencedIds.size > 0) {\r\n      // Candidats = r\u00C3\u00A9f\u00C3\u00A9rences existantes dont l'ID existe dans l'arbre\r\n      orphanCandidates = Array.from(referencedIds).filter(id => byId.has(id));\r\n\r\n      // V\u00C3\u00A9rifier si elles sont encore r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9es ailleurs dans l'arbre (hors sous-arborescence)\r\n      const elsewhereRefers = new Set<string>();\r\n      for (const n of all) {\r\n        if (collected.has(n.id)) continue; // on ignore la sous-arborescence d\u00C3\u00A9j\u00C3\u00A0 d\u00C3\u00A9lier\r\n        if (n.sharedReferenceId && referencedIds.has(n.sharedReferenceId)) elsewhereRefers.add(n.sharedReferenceId);\r\n        if (Array.isArray(n.sharedReferenceIds)) for (const rid of n.sharedReferenceIds) if (referencedIds.has(rid)) elsewhereRefers.add(rid);\r\n      }\r\n\r\n      // Supprimer uniquement celles qui ne sont plus r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9es\r\n      const toDeleteRoots = orphanCandidates.filter(id => !elsewhereRefers.has(id));\r\n\r\n      if (toDeleteRoots.length > 0) {\r\n        // Construire une profondeur pour supprimer feuilles -> racines\r\n        const delSet = new Set<string>();\r\n        const depth = new Map<string, number>();\r\n        for (const rid of toDeleteRoots) {\r\n          const q: string[] = [rid];\r\n          depth.set(rid, 0);\r\n          while (q.length) {\r\n            const cur = q.shift()!;\r\n            if (delSet.has(cur)) continue;\r\n            delSet.add(cur);\r\n            const d = depth.get(cur)!;\r\n            for (const c of (childrenByParent.get(cur) || [])) { depth.set(c, d + 1); q.push(c); }\r\n          }\r\n        }\r\n        const ordered = Array.from(delSet);\r\n        ordered.sort((a, b) => (depth.get(b)! - depth.get(a)!));\r\n\r\n        await prisma.$transaction(async (tx) => {\r\n          for (const id of ordered) {\r\n            await tx.treeBranchLeafNode.delete({ where: { id } });\r\n            deletedCount++;\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    return res.json({ success: true, unlinked: collected.size, orphanCandidates, deletedOrphans: deletedCount });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [/nodes/:nodeId/unlink-shared-references] Erreur:', error);\r\n    res.status(500).json({ error: 'Erreur lors du d\u00C3\u00A9lier/suppression des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/nodes/:tableNodeId/table/lookup - R\u00C3\u00A9cup\u00C3\u00A8re les donn\u00C3\u00A9es pour un select bas\u00C3\u00A9 sur une table\r\n// \u00E2\u0161\u00A0\u00EF\u00B8\u008F ANCIEN ENDPOINT - D\u00C3\u2030SACTIV\u00C3\u2030 CAR DOUBLON AVEC L'ENDPOINT LIGNE 6339 (NOUVELLE VERSION AVEC keyRow/keyColumn)\r\n/*\r\nrouter.get('/nodes/:tableNodeId/table/lookup', async (req, res) => {\r\n  const { tableNodeId } = req.params; // \u00E2\u0153\u2026 D\u00C3\u2030PLAC\u00C3\u2030 AVANT LE TRY pour \u00C3\u00AAtre accessible dans le catch\r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[table/lookup] D\u00C3\u00A9but pour tableNodeId: ${tableNodeId}`);\r\n    \r\n    // \u00F0\u0178\u201D\u008D DIAGNOSTIC: V\u00C3\u00A9rifier si Prisma est disponible\r\n    if (!prisma) {\r\n      console.error(`[table/lookup] \u00E2\u009D\u0152 ERREUR CRITIQUE: prisma est undefined !`);\r\n      console.error(`[table/lookup] Type de prisma:`, typeof prisma);\r\n      return res.status(500).json({ \r\n        error: 'Database connection not available',\r\n        details: 'Prisma client is not initialized. Please restart the server.'\r\n      });\r\n    }\r\n    \r\n    console.log(`[table/lookup] \u00E2\u0153\u2026 Prisma client disponible, type:`, typeof prisma);\r\n\r\n    // 1. R\u00C3\u00A9cup\u00C3\u00A9rer la configuration SELECT du champ pour savoir quelle table r\u00C3\u00A9f\u00C3\u00A9rencer\r\n    const selectConfig = await prisma.treeBranchLeafSelectConfig.findUnique({\r\n      where: { nodeId: tableNodeId },\r\n      select: {\r\n        tableReference: true,\r\n        valueColumn: true,\r\n        displayColumn: true,\r\n      },\r\n    });\r\n\r\n    if (!selectConfig || !selectConfig.tableReference) {\r\n      console.log(`[table/lookup] 404 - Aucune configuration de table r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9e pour le n\u00C5\u201Cud ${tableNodeId}`);\r\n      return res.status(404).json({ error: 'Configuration de la table de r\u00C3\u00A9f\u00C3\u00A9rence non trouv\u00C3\u00A9e.' });\r\n    }\r\n\r\n    const { tableReference } = selectConfig;\r\n    const _valueColumn = selectConfig.valueColumn; // Pour info (non utilis\u00C3\u00A9 en mode dynamique)\r\n    const _displayColumn = selectConfig.displayColumn; // Pour info (non utilis\u00C3\u00A9 en mode dynamique)\r\n\r\n    // 2. R\u00C3\u00A9cup\u00C3\u00A9rer les donn\u00C3\u00A9es de la table r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9e\r\n    const tableData = await prisma.treeBranchLeafNodeTable.findFirst({\r\n      where: { id: tableReference },\r\n      select: {\r\n        data: true,      // \u00E2\u0153\u2026 CORRECT: Donn\u00C3\u00A9es 2D du tableau\r\n        columns: true,   // Noms des colonnes\r\n        rows: true,      // Noms des lignes (pour info)\r\n        nodeId: true,\r\n      },\r\n    });\r\n\r\n    if (!tableData) {\r\n      console.log(`[table/lookup] 404 - Table r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9e ${tableReference} non trouv\u00C3\u00A9e`);\r\n      return res.status(404).json({ error: 'Table de r\u00C3\u00A9f\u00C3\u00A9rence non trouv\u00C3\u00A9e.' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s \u00C3\u00A0 l'arbre parent (s\u00C3\u00A9curit\u00C3\u00A9)\r\n    const parentNode = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: tableData.nodeId },\r\n      select: { TreeBranchLeafTree: { select: { organizationId: true } } }\r\n    });\r\n\r\n    const nodeOrg = parentNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && organizationId && nodeOrg && nodeOrg !== organizationId) {\r\n      console.log(`[table/lookup] 403 - Acc\u00C3\u00A8s non autoris\u00C3\u00A9. Org user: ${organizationId}, Org node: ${nodeOrg}`);\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s non autoris\u00C3\u00A9 \u00C3\u00A0 cette ressource.' });\r\n    }\r\n\r\n    // 3. Extraire les colonnes et les donn\u00C3\u00A9es\r\n    const _tableDataArray = Array.isArray(tableData.data) ? tableData.data : []; // Pour info (non utilis\u00C3\u00A9 en mode dynamique)\r\n    const dataColumns = Array.isArray(tableData.columns) ? tableData.columns : [];\r\n    const rowNames = Array.isArray(tableData.rows) ? tableData.rows : [];\r\n\r\n    console.log(`[table/lookup] \u00F0\u0178\u201D\u008D DEBUG - Colonnes:`, dataColumns);\r\n    console.log(`[table/lookup] \u00F0\u0178\u201D\u008D DEBUG - Noms des lignes:`, rowNames);\r\n\r\n    // \u00F0\u0178\u017D\u00AF R\u00C3\u00A9cup\u00C3\u00A9rer le mode et la configuration depuis le champ SELECT\r\n    const selectFieldNode = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: tableNodeId },\r\n      select: {\r\n        table_instances: true,\r\n        table_activeId: true,\r\n      }\r\n    });\r\n\r\n    let isRowBased = false;\r\n    let isColumnBased = false;\r\n    let tableMode: 'columns' | 'matrix' = 'columns';\r\n    let keyColumnFromLookup: string | undefined;\r\n    \r\n    if (selectFieldNode?.table_instances && typeof selectFieldNode.table_instances === 'object') {\r\n      const instances = selectFieldNode.table_instances as Record<string, any>;\r\n      const activeInstance = selectFieldNode.table_activeId ? instances[selectFieldNode.table_activeId] : null;\r\n      \r\n      if (activeInstance) {\r\n        isRowBased = activeInstance.rowBased === true;\r\n        isColumnBased = activeInstance.columnBased === true;\r\n        tableMode = activeInstance.mode || 'columns';\r\n        \r\n        // \u00F0\u0178\u017D\u00AF CRITIQUE: Lire keyColumn depuis l'instance active\r\n        keyColumnFromLookup = activeInstance.keyColumn || activeInstance.valueColumn || activeInstance.displayColumn;\r\n        \r\n        console.log(`[table/lookup] \u00F0\u0178\u201D\u008D Configuration compl\u00C3\u00A8te:`, { \r\n          isRowBased, \r\n          isColumnBased,\r\n          tableMode,\r\n          keyColumnFromLookup,\r\n          activeId: selectFieldNode.table_activeId,\r\n          activeInstance \r\n        });\r\n      }\r\n    }\r\n\r\n    // 4. Transformer selon le mode (rowBased ou columnBased)\r\n    let options: Array<{ label: string; value: string }>;\r\n\r\n    if (isRowBased) {\r\n      // Mode LIGNE: Retourner les noms des lignes\r\n      console.log(`[table/lookup] \u00F0\u0178\u017D\u00AF Mode LIGNE activ\u00C3\u00A9 - G\u00C3\u00A9n\u00C3\u00A9ration des options depuis les lignes`);\r\n      options = rowNames.map((rowName: string) => ({\r\n        label: String(rowName),\r\n        value: String(rowName)\r\n      }));\r\n    } else if (tableMode === 'columns' && keyColumnFromLookup) {\r\n      // \u00E2\u0153\u2026 Mode COLONNE avec keyColumn: Retourner les VALEURS de la colonne choisie\r\n      console.log(`[table/lookup] \u00F0\u0178\u017D\u00AF Mode COLONNE activ\u00C3\u00A9 - G\u00C3\u00A9n\u00C3\u00A9ration des options depuis la colonne \"${keyColumnFromLookup}\"`);\r\n      \r\n      const columnIndex = dataColumns.indexOf(keyColumnFromLookup);\r\n      if (columnIndex === -1) {\r\n        console.warn(`[table/lookup] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Colonne \"${keyColumnFromLookup}\" introuvable dans:`, dataColumns);\r\n        options = [];\r\n      } else {\r\n        // Extraire les valeurs de la colonne\r\n        const tableDataArray = Array.isArray(tableData.data) ? tableData.data : [];\r\n        options = tableDataArray\r\n          .map((row: unknown) => {\r\n            if (!Array.isArray(row)) return null;\r\n            const value = row[columnIndex];\r\n            if (value === null || value === undefined || value === '') return null;\r\n            return {\r\n              label: String(value),\r\n              value: String(value)\r\n            };\r\n          })\r\n          .filter((opt): opt is { label: string; value: string } => opt !== null);\r\n        \r\n        console.log(`[table/lookup] \u00E2\u0153\u2026 ${options.length} valeurs extraites de la colonne \"${keyColumnFromLookup}\":`, options);\r\n      }\r\n    } else {\r\n      // Mode COLONNE par d\u00C3\u00A9faut (ancien comportement): Retourner les noms des colonnes\r\n      console.log(`[table/lookup] \u00F0\u0178\u017D\u00AF Mode COLONNE (legacy) activ\u00C3\u00A9 - G\u00C3\u00A9n\u00C3\u00A9ration des options depuis les noms de colonnes`);\r\n      options = dataColumns.map((columnName: string) => ({\r\n        label: String(columnName),\r\n        value: String(columnName)\r\n      }));\r\n    }\r\n\r\n    console.log(`[table/lookup] Succ\u00C3\u00A8s - ${options.length} options ${isRowBased ? 'LIGNES' : 'COLONNES'} g\u00C3\u00A9n\u00C3\u00A9r\u00C3\u00A9es pour ${tableNodeId}`);\r\n    res.json({ options });\r\n\r\n  } catch (error) {\r\n    console.error(`[API] \u00F0\u0178\u2019\u00A5 Critical error in /table/lookup for tableNodeId: ${tableNodeId}`, error);\r\n    if (error instanceof Error) {\r\n        console.error(`[API] Error Name: ${error.name}`);\r\n        console.error(`[API] Error Message: ${error.message}`);\r\n        console.error(`[API] Error Stack: ${error.stack}`);\r\n    }\r\n    res.status(500).json({ \r\n        message: 'Internal Server Error', \r\n        error: error instanceof Error ? { name: error.name, message: error.message, stack: error.stack } : String(error) \r\n    });\r\n  }\r\n});\r\n*/\r\n// \u00E2\u0161\u00A0\u00EF\u00B8\u008F FIN DE L'ANCIEN ENDPOINT /table/lookup - Utiliser maintenant l'endpoint moderne ligne ~6339\r\n\r\n\r\n// =============================================================================\r\n// \u00EF\u00BF\u00BD\u00F0\u0178\u201D\u00A2 NODE DATA (VARIABLE EXPOS\u00C3\u2030E) - Donn\u00C3\u00A9e d'un n\u00C5\u201Cud\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/trees/:treeId/nodes/:nodeId/data\r\n// R\u00C3\u00A9cup\u00C3\u00A8re la configuration \"donn\u00C3\u00A9e\" (variable expos\u00C3\u00A9e) d'un n\u00C5\u201Cud\r\nrouter.get('/trees/:treeId/nodes/:nodeId/data', async (req, res) => {\r\n  try {\r\n    const { treeId, nodeId } = req.params;\r\n    const { organizationId } = req.user!;\r\n    console.log('\u00F0\u0178\u203A\u00B0\u00EF\u00B8\u008F [TBL NEW ROUTE][GET /data] treeId=%s nodeId=%s', treeId, nodeId);\r\n\r\n    // V\u00C3\u00A9rifier l'appartenance de l'arbre \u00C3\u00A0 l'organisation (ou acc\u00C3\u00A8s super admin)\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: organizationId ? { id: treeId, organizationId } : { id: treeId }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que le n\u00C5\u201Cud existe dans cet arbre\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: nodeId,\r\n        treeId,\r\n      },\r\n      select: { id: true, data_activeId: true },\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const variable = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n      where: { nodeId },\r\n      select: {\r\n  id: true,\r\n  displayName: true,\r\n        exposedKey: true,\r\n        displayFormat: true,\r\n        unit: true,\r\n        precision: true,\r\n        visibleToUser: true,\r\n        isReadonly: true,\r\n        defaultValue: true,\r\n        metadata: true,\r\n  // Exposer aussi la configuration de la source\r\n  sourceType: true,\r\n  sourceRef: true,\r\n  fixedValue: true,\r\n  selectedNodeId: true,\r\n      },\r\n    });\r\n\r\n    if (variable) {\r\n      const { sourceType, sourceRef, fixedValue, selectedNodeId, exposedKey } = variable as {\r\n        sourceType?: string | null;\r\n        sourceRef?: string | null;\r\n        fixedValue?: string | null;\r\n        selectedNodeId?: string | null;\r\n        exposedKey?: string | null;\r\n        [k: string]: unknown;\r\n      };\r\n      console.log('\u00F0\u0178\u203A\u00B0\u00EF\u00B8\u008F [TBL NEW ROUTE][GET /data] payload keys=%s hasSource=%s ref=%s fixed=%s selNode=%s',\r\n        Object.keys(variable).join(','), !!sourceType, sourceRef, fixedValue, selectedNodeId);\r\n      if (!sourceType && !sourceRef) {\r\n        console.log('\u00E2\u0161\u00A0\u00EF\u00B8\u008F [TBL NEW ROUTE][GET /data] Aucune sourceType/sourceRef retourn\u00C3\u00A9e pour nodeId=%s (exposedKey=%s)', nodeId, exposedKey);\r\n      }\r\n    } else {\r\n      console.log('\u00E2\u201E\u00B9\u00EF\u00B8\u008F [TBL NEW ROUTE][GET /data] variable inexistante nodeId=%s \u00E2\u2020\u2019 {}', nodeId);\r\n    }\r\n\r\n    // Construire une r\u00E9ponse qui expose aussi la variable r\u00E9ellement utilis\u00E9e par le n\u0153ud\r\n    const usedVariableId = node?.data_activeId || (variable ? (variable as { id?: string }).id || null : null);\r\n    // Retourner un objet vide si aucune variable n'existe encore (\u00C3\u00A9vite les 404 c\u00C3\u00B4t\u00C3\u00A9 client)\r\n    if (variable) {\r\n      return res.json({ ...variable, usedVariableId });\r\n    }\r\n    return res.json({ usedVariableId });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node data:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la donn\u00C3\u00A9e du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00E2\u0161\u2013\u00EF\u00B8\u008F NODE CONDITIONS - Conditions IF/ELSE d'un n\u00C5\u201Cud\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId/conditions\r\n// R\u00C3\u00A9cup\u00C3\u00A8re la configuration des conditions d'un n\u00C5\u201Cud (JSON libre pour l'instant)\r\n// (Moved export to bottom so routes below are mounted)\r\n\r\n// PUT /api/treebranchleaf/trees/:treeId/nodes/:nodeId/data\r\n// Cr\u00C3\u00A9e/met \u00C3\u00A0 jour la configuration \"donn\u00C3\u00A9e\" (variable expos\u00C3\u00A9e) d'un n\u00C5\u201Cud\r\nrouter.put('/trees/:treeId/nodes/:nodeId/data', async (req, res) => {\r\n  try {\r\n    const { treeId, nodeId } = req.params;\r\n    const { organizationId } = req.user!;\r\n    const { \r\n      exposedKey, displayFormat, unit, precision, visibleToUser, isReadonly, defaultValue, metadata,\r\n      // \u00F0\u0178\u017D\u00AF NOUVEAUX CHAMPS pour sourceType/sourceRef/fixedValue\r\n      sourceType, sourceRef, fixedValue, selectedNodeId \r\n    } = req.body || {};\r\n    console.log('\u00F0\u0178\u203A\u00B0\u00EF\u00B8\u008F [TBL NEW ROUTE][PUT /data] nodeId=%s body=%o', nodeId, { exposedKey, sourceType, sourceRef, fixedValue, selectedNodeId });\r\n\r\n    // V\u00C3\u00A9rifier l'appartenance de l'arbre \u00C3\u00A0 l'organisation (ou acc\u00C3\u00A8s super admin)\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: organizationId ? { id: treeId, organizationId } : { id: treeId }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que le n\u00C5\u201Cud existe dans cet arbre\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: nodeId,\r\n        treeId,\r\n      },\r\n      select: { id: true, label: true },\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // Normalisation des valeurs\r\n    const safeExposedKey: string | null = typeof exposedKey === 'string' && exposedKey.trim() ? exposedKey.trim() : null;\r\n    const displayName = safeExposedKey || node.label || `var_${String(nodeId).slice(0, 4)}`;\r\n\r\n    // \u00F0\u0178\u201D\u2014 R\u00C3\u2030CUP\u00C3\u2030RATION DE L'ANCIENNE VARIABLE pour comparaison des r\u00C3\u00A9f\u00C3\u00A9rences\r\n    const oldVariable = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n      where: { nodeId },\r\n      select: { id: true, sourceRef: true, metadata: true }\r\n    });\r\n\r\n    const updated = await prisma.$transaction(async (tx) => {\r\n      const variable = await tx.treeBranchLeafNodeVariable.upsert({\r\n        where: { nodeId },\r\n        update: {\r\n          exposedKey: safeExposedKey || undefined,\r\n          displayName,\r\n          displayFormat: typeof displayFormat === 'string' ? displayFormat : undefined,\r\n          unit: typeof unit === 'string' ? unit : undefined,\r\n          precision: typeof precision === 'number' ? precision : undefined,\r\n          visibleToUser: typeof visibleToUser === 'boolean' ? visibleToUser : undefined,\r\n          isReadonly: typeof isReadonly === 'boolean' ? isReadonly : undefined,\r\n          defaultValue: typeof defaultValue === 'string' ? defaultValue : undefined,\r\n          metadata: metadata && typeof metadata === 'object' ? metadata : undefined,\r\n          // \u00F0\u0178\u017D\u00AF NOUVEAUX CHAMPS source\r\n          sourceType: typeof sourceType === 'string' ? sourceType : undefined,\r\n          sourceRef: typeof sourceRef === 'string' ? sourceRef : undefined,\r\n          fixedValue: typeof fixedValue === 'string' ? fixedValue : undefined,\r\n          selectedNodeId: typeof selectedNodeId === 'string' ? selectedNodeId : undefined,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          id: randomUUID(),\r\n          nodeId,\r\n          exposedKey: safeExposedKey || `var_${String(nodeId).slice(0, 4)}`,\r\n          displayName,\r\n          displayFormat: typeof displayFormat === 'string' ? displayFormat : 'number',\r\n          unit: typeof unit === 'string' ? unit : null,\r\n          precision: typeof precision === 'number' ? precision : 2,\r\n          visibleToUser: typeof visibleToUser === 'boolean' ? visibleToUser : true,\r\n          isReadonly: typeof isReadonly === 'boolean' ? isReadonly : false,\r\n          defaultValue: typeof defaultValue === 'string' ? defaultValue : null,\r\n          metadata: metadata && typeof metadata === 'object' ? metadata : {},\r\n          // \u00F0\u0178\u017D\u00AF NOUVEAUX CHAMPS source\r\n          sourceType: typeof sourceType === 'string' ? sourceType : 'fixed',\r\n          sourceRef: typeof sourceRef === 'string' ? sourceRef : null,\r\n          fixedValue: typeof fixedValue === 'string' ? fixedValue : null,\r\n          selectedNodeId: typeof selectedNodeId === 'string' ? selectedNodeId : null,\r\n          updatedAt: new Date(),\r\n        },\r\n        select: {\r\n          id: true,\r\n          exposedKey: true,\r\n          displayFormat: true,\r\n          unit: true,\r\n          precision: true,\r\n          visibleToUser: true,\r\n          isReadonly: true,\r\n          defaultValue: true,\r\n          metadata: true,\r\n          // \u00F0\u0178\u017D\u00AF NOUVEAUX CHAMPS source\r\n          sourceType: true,\r\n          sourceRef: true,\r\n          fixedValue: true,\r\n          selectedNodeId: true,\r\n        },\r\n      });\r\n\r\n      // Marquer le n\u00C5\"ud comme ayant des donn\u00C3\u00A9es configur\u00C3\u00A9es (capacit\u00C3\u00A9 \"Donn\u00C3\u00A9e\" active)\r\n      // \uD83C\uDFAF NOUVEAU: Si sourceRef pointe vers une table, mettre \u00E0 jour table_activeId et table_instances\r\n      const nodeUpdateData: any = { hasData: true, updatedAt: new Date() };\r\n      \r\n      if (variable.sourceRef && variable.sourceRef.startsWith('@table.')) {\r\n        const tableId = variable.sourceRef.replace('@table.', '');\r\n        console.log(`[TBL] \uD83D\uDD27 Configuration lookup pour table ${tableId}`);\r\n\r\n        const instanceConfig = {\r\n          sourceType: variable.sourceType || 'tree',\r\n          sourceRef: variable.sourceRef,\r\n          displayFormat: variable.displayFormat || null,\r\n          unit: variable.unit ?? null,\r\n          precision: variable.precision ?? null,\r\n          visibleToUser: variable.visibleToUser ?? true,\r\n          exposedKey: variable.exposedKey || null,\r\n          metadata: {\r\n            sourceType: variable.sourceType || 'tree',\r\n            sourceRef: variable.sourceRef,\r\n            fixedValue: variable.fixedValue ?? null,\r\n            selectedNodeId: variable.selectedNodeId ?? null,\r\n            updatedAt: new Date().toISOString()\r\n          }\r\n        };\r\n\r\n        nodeUpdateData.data_activeId = tableId;\r\n        nodeUpdateData.data_instances = { [tableId]: instanceConfig };\r\n        nodeUpdateData.table_activeId = tableId;\r\n        nodeUpdateData.table_instances = { [tableId]: instanceConfig };\r\n        nodeUpdateData.hasTable = true;\r\n\r\n        console.log(`[TBL] \u2705 data_activeId/table_activeId=\"${tableId}\" configur\u00E9s`);\r\n      }\r\n      \r\n      await tx.treeBranchLeafNode.update({\r\n        where: { id: nodeId },\r\n        data: nodeUpdateData\r\n      });\r\n\r\n      // \u00F0\u0178\u201D\u2014 MAJ linkedVariableIds du n\u00C5\u201Cud propri\u00C3\u00A9taire\r\n      try {\r\n        await addToNodeLinkedField(tx, nodeId, 'linkedVariableIds', [variable.id]);\r\n      } catch (e) {\r\n        console.warn('[TreeBranchLeaf API] Warning updating owner linkedVariableIds:', (e as Error).message);\r\n      }\r\n\r\n      // \u00F0\u0178\u201D\u2014 NOUVEAU: MAJ des r\u00C3\u00A9f\u00C3\u00A9rences inverses (linkedVariableIds sur les n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s)\r\n      try {\r\n        const getReferencedIds = async (varData: { sourceRef?: string | null, metadata?: any }): Promise<Set<string>> => {\r\n          const ids = new Set<string>();\r\n          if (!varData) return ids;\r\n\r\n          const { sourceRef, metadata } = varData;\r\n\r\n          // 1. R\u00C3\u00A9f\u00C3\u00A9rence directe dans metadata.selectedNodeId\r\n          if (metadata?.selectedNodeId) {\r\n            ids.add(normalizeRefId(metadata.selectedNodeId));\r\n          }\r\n\r\n          // 2. R\u00C3\u00A9f\u00C3\u00A9rence dans sourceRef\r\n          const parsedRef = parseSourceRef(sourceRef);\r\n          if (parsedRef) {\r\n            if (parsedRef.type === 'formula') {\r\n              const formula = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsedRef.id }, select: { tokens: true } });\r\n              if (formula) {\r\n                extractNodeIdsFromTokens(formula.tokens).forEach(id => ids.add(normalizeRefId(id)));\r\n              }\r\n            } else if (parsedRef.type === 'condition') {\r\n              const condition = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsedRef.id }, select: { conditionSet: true } });\r\n              if (condition) {\r\n                extractNodeIdsFromConditionSet(condition.conditionSet).forEach(id => ids.add(normalizeRefId(id)));\r\n              }\r\n            } else {\r\n              // G\u00C3\u00A9rer les cas comme \"table:id\" ou \"node:id\"\r\n              ids.add(normalizeRefId(parsedRef.id));\r\n            }\r\n          } else if (sourceRef) {\r\n            // Si ce n'est pas un format \"type:id\", \u00C3\u00A7a peut \u00C3\u00AAtre un nodeId direct\r\n            ids.add(normalizeRefId(sourceRef));\r\n          }\r\n          \r\n          return ids;\r\n        };\r\n\r\n        const oldIds = await getReferencedIds(oldVariable);\r\n        const newIds = await getReferencedIds(variable);\r\n\r\n        const idsToAdd = [...newIds].filter(id => !oldIds.has(id));\r\n        const idsToRemove = [...oldIds].filter(id => !newIds.has(id));\r\n\r\n        if (idsToAdd.length > 0) {\r\n          console.log(`[TBL] Adding variable ref ${variable.id} to ${idsToAdd.length} nodes.`);\r\n          for (const refId of idsToAdd) {\r\n            await addToNodeLinkedField(tx, refId, 'linkedVariableIds', [variable.id]);\r\n          }\r\n        }\r\n        if (idsToRemove.length > 0) {\r\n          console.log(`[TBL] Removing variable ref ${variable.id} from ${idsToRemove.length} nodes.`);\r\n          for (const refId of idsToRemove) {\r\n            await removeFromNodeLinkedField(tx, refId, 'linkedVariableIds', [variable.id]);\r\n          }\r\n        }\r\n\r\n        // \u00F0\u0178\u2020\u2022 NOUVEAU: G\u00C3\u00A9rer aussi les r\u00C3\u00A9f\u00C3\u00A9rences vers les variables des n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s\r\n        const getNodeReferencedVariableIds = async (varData: { sourceRef?: string | null, metadata?: any }): Promise<Set<string>> => {\r\n          const variableIds = new Set<string>();\r\n          \r\n          // Extraire les n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s par cette variable\r\n          const referencedNodeIds = await getReferencedIds(varData);\r\n          \r\n          // Pour chaque n\u00C5\u201Cud r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9, r\u00C3\u00A9cup\u00C3\u00A9rer sa variable (si elle existe)\r\n          for (const refNodeId of referencedNodeIds) {\r\n            const refVariable = await tx.treeBranchLeafNodeVariable.findUnique({\r\n              where: { nodeId: refNodeId },\r\n              select: { id: true }\r\n            });\r\n            if (refVariable) {\r\n              variableIds.add(refVariable.id);\r\n            }\r\n          }\r\n          \r\n          return variableIds;\r\n        };\r\n\r\n        const oldVariableRefs = await getNodeReferencedVariableIds(oldVariable);\r\n        const newVariableRefs = await getNodeReferencedVariableIds(variable);\r\n\r\n        const variableIdsToAdd = [...newVariableRefs].filter(id => !oldVariableRefs.has(id));\r\n        const variableIdsToRemove = [...oldVariableRefs].filter(id => !newVariableRefs.has(id));\r\n\r\n        if (variableIdsToAdd.length > 0) {\r\n          console.log(`[TBL] Adding ${variableIdsToAdd.length} variable references to node ${nodeId}.`);\r\n          await addToNodeLinkedField(tx, nodeId, 'linkedVariableIds', variableIdsToAdd);\r\n        }\r\n        if (variableIdsToRemove.length > 0) {\r\n          console.log(`[TBL] Removing ${variableIdsToRemove.length} variable references from node ${nodeId}.`);\r\n          await removeFromNodeLinkedField(tx, nodeId, 'linkedVariableIds', variableIdsToRemove);\r\n        }\r\n\r\n        // \uD83D\uDD17 NOUVEAU: Backfill linkedVariableIds pour tous les lookups de la table associ\u00E9e\r\n        try {\r\n          // R\u00E9cup\u00E9rer le n\u0153ud propri\u00E9taire pour acc\u00E9der \u00E0 ses tables\r\n          const nodeData = await tx.treeBranchLeafNode.findUnique({\r\n            where: { id: nodeId },\r\n            select: { linkedTableIds: true }\r\n          });\r\n\r\n          if (nodeData && nodeData.linkedTableIds && nodeData.linkedTableIds.length > 0) {\r\n            console.log(`[TBL] \uD83D\uDD0D Traitement des lookups pour ${nodeData.linkedTableIds.length} table(s)...`);\r\n            \r\n            // Pour chaque table associ\u00E9e \u00E0 ce n\u0153ud\r\n            for (const tableId of nodeData.linkedTableIds) {\r\n              const table = await tx.treeBranchLeafNodeTable.findUnique({\r\n                where: { id: tableId },\r\n                select: { \r\n                  id: true,\r\n                  name: true,\r\n                  nodeId: true,\r\n                  lookupSelectColumn: true,\r\n                  lookupDisplayColumns: true\r\n                }\r\n              });\r\n\r\n              if (table) {\r\n                console.log(`[TBL] \uD83D\uDCCA Table trouv\u00E9e: \"${table.name}\" (ID: ${table.id})`);\r\n                \r\n                // Chercher tous les n\u0153uds Select/Cascader qui utilisent cette table\r\n                // Via la relation TreeBranchLeafSelectConfig.tableReference\r\n                const selectConfigsUsingTable = await tx.treeBranchLeafSelectConfig.findMany({\r\n                  where: { tableReference: table.id },\r\n                  select: { nodeId: true }\r\n                });\r\n\r\n                if (selectConfigsUsingTable.length > 0) {\r\n                  console.log(`[TBL] \u2728 ${selectConfigsUsingTable.length} champ(s) Select/Cascader utilise(nt) cette table`);\r\n                  \r\n                  for (const config of selectConfigsUsingTable) {\r\n                    const selectNode = await tx.treeBranchLeafNode.findUnique({\r\n                      where: { id: config.nodeId },\r\n                      select: { \r\n                        id: true,\r\n                        label: true,\r\n                        linkedVariableIds: true\r\n                      }\r\n                    });\r\n                    \r\n                    if (selectNode) {\r\n                      const currentLinkedIds = selectNode.linkedVariableIds || [];\r\n                      \r\n                      // Ajouter l'ID de la variable si pas d\u00E9j\u00E0 pr\u00E9sent\r\n                      if (!currentLinkedIds.includes(variable.id)) {\r\n                        const updatedLinkedIds = [...currentLinkedIds, variable.id];\r\n                        \r\n                        await tx.treeBranchLeafNode.update({\r\n                          where: { id: selectNode.id },\r\n                          data: { \r\n                            linkedVariableIds: updatedLinkedIds,\r\n                            updatedAt: new Date()\r\n                          }\r\n                        });\r\n                        \r\n                        console.log(`[TBL] \u2705 linkedVariableIds mis \u00E0 jour pour \"${selectNode.label}\" (${selectNode.id})`);\r\n                      } else {\r\n                        console.log(`[TBL] \u2139\uFE0F linkedVariableIds d\u00E9j\u00E0 \u00E0 jour pour \"${selectNode.label}\"`);\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        } catch (e) {\r\n          console.warn('[TreeBranchLeaf API] Warning updating lookup linkedVariableIds:', (e as Error).message);\r\n        }\r\n      } catch (e) {\r\n        console.warn('[TreeBranchLeaf API] Warning updating inverse linkedVariableIds:', (e as Error).message);\r\n      }\r\n\r\n      return variable;\r\n    });\r\n\r\n    // Exposer aussi l'identifiant effectivement utilis\u00E9 par le n\u0153ud (pr\u00E9f\u00E9rence \u00E0 data_activeId)\r\n    try {\r\n      const nodeAfter = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: nodeId },\r\n        select: { data_activeId: true }\r\n      });\r\n      return res.json({ ...updated, usedVariableId: nodeAfter?.data_activeId || (updated as { id?: string }).id || null });\r\n    } catch {\r\n      return res.json(updated);\r\n    }\r\n  } catch (error) {\r\n    const err = error as unknown as { code?: string };\r\n    if (err && err.code === 'P2002') {\r\n      return res.status(409).json({ error: 'La variable expos\u00C3\u00A9e (exposedKey) existe d\u00C3\u00A9j\u00C3\u00A0' });\r\n    }\r\n    console.error('[TreeBranchLeaf API] Error updating node data:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour de la donn\u00C3\u00A9e du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F DELETE VARIABLE - Suppression d'une variable avec cascade\r\n// =============================================================================\r\n\r\n// DELETE /api/treebranchleaf/trees/:treeId/nodes/:nodeId/data\r\n// Supprime une variable ET la capacit\u00C3\u00A9 (formule/condition/table) qu'elle r\u00C3\u00A9f\u00C3\u00A9rence\r\nrouter.delete('/trees/:treeId/nodes/:nodeId/data', async (req, res) => {\r\n  try {\r\n    const { treeId, nodeId } = req.params;\r\n    const { organizationId } = req.user!;\r\n\r\n    console.log(`\u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F [DELETE Variable] D\u00C3\u00A9but suppression pour nodeId=${nodeId}`);\r\n\r\n    // V\u00C3\u00A9rifier l'appartenance de l'arbre \u00C3\u00A0 l'organisation\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: organizationId ? { id: treeId, organizationId } : { id: treeId }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que le n\u00C5\u201Cud existe\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId, treeId },\r\n      select: { id: true }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la variable pour obtenir la sourceRef\r\n    const variable = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n      where: { nodeId },\r\n      select: { id: true, sourceRef: true }\r\n    });\r\n\r\n    if (!variable) {\r\n      return res.status(404).json({ error: 'Variable non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    console.log(`\u00F0\u0178\u201D\u008D [DELETE Variable] Variable trouv\u00C3\u00A9e avec sourceRef: ${variable.sourceRef}`);\r\n\r\n    // \u00E2\u009D\u0152 PAS de suppression en cascade : on garde les capacit\u00C3\u00A9s (formule/condition/table)\r\n    // On supprime uniquement la variable, la capacit\u00C3\u00A9 reste accessible directement\r\n    console.log(`\u00F0\u0178\u201D\u008D [DELETE Variable] Variable trouv\u00C3\u00A9e avec sourceRef: ${variable.sourceRef}`);\r\n    console.log(`\u00F0\u0178\u201C\u0152 [DELETE Variable] La capacit\u00C3\u00A9 r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9e sera conserv\u00C3\u00A9e`);\r\n\r\n    // Supprimer la variable elle-m\u00C3\u00AAme\r\n    await prisma.treeBranchLeafNodeVariable.delete({\r\n      where: { nodeId }\r\n    });\r\n\r\n    // D\u00C3\u00A9sactiver la capacit\u00C3\u00A9 \"Donn\u00C3\u00A9es\" sur le n\u00C5\u201Cud\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { hasData: false, updatedAt: new Date() }\r\n    });\r\n\r\n    // Nettoyer les r\u00C3\u00A9f\u00C3\u00A9rences \u00C3\u00A0 cette variable dans tout l'arbre\r\n    try {\r\n      // 1. Trouver tous les n\u00C5\u201Cuds qui r\u00C3\u00A9f\u00C3\u00A9rencent la variable en cours de suppression\r\n      const dependentNodes = await prisma.treeBranchLeafNode.findMany({\r\n        where: {\r\n          treeId,\r\n          linkedVariableIds: { has: variable.id }, // On cherche les n\u00C5\u201Cuds qui ont l'ID de notre variable\r\n        },\r\n        select: { id: true, linkedVariableIds: true },\r\n      });\r\n\r\n      console.log(`\u00F0\u0178\u00A7\u00B9 [DELETE Variable] ${dependentNodes.length} n\u00C5\u201Cud(s) d\u00C3\u00A9pendant(s) trouv\u00C3\u00A9(s) \u00C3\u00A0 nettoyer.`);\r\n\r\n      // 2. Pour chaque n\u00C5\u201Cud d\u00C3\u00A9pendant, retirer la r\u00C3\u00A9f\u00C3\u00A9rence \u00C3\u00A0 la variable supprim\u00C3\u00A9e\r\n      for (const nodeToClean of dependentNodes) {\r\n        const updatedLinkedIds = nodeToClean.linkedVariableIds.filter(id => id !== variable.id);\r\n        await prisma.treeBranchLeafNode.update({\r\n          where: { id: nodeToClean.id },\r\n          data: { linkedVariableIds: updatedLinkedIds },\r\n        });\r\n        console.log(`\u00E2\u0153\u2026 [DELETE Variable] Nettoyage de linkedVariableIds termin\u00C3\u00A9 pour le n\u00C5\u201Cud ${nodeToClean.id}`);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[DELETE Variable] Avertissement lors du nettoyage des linkedVariableIds:', (e as Error).message);\r\n    }\r\n\r\n    console.log(`\u00E2\u0153\u2026 [DELETE Variable] Variable ${variable.id} supprim\u00C3\u00A9e avec succ\u00C3\u00A8s (+ capacit\u00C3\u00A9 associ\u00C3\u00A9e si existante)`);\r\n    return res.json({ success: true, message: 'Variable supprim\u00C3\u00A9e avec succ\u00C3\u00A8s' });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [DELETE Variable] Erreur lors de la suppression:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de la variable' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00E2\u0161\u2013\u00EF\u00B8\u008F NODE CONDITIONS - Conditions d'un n\u00C5\u201Cud\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId/conditions\r\n// ANCIENNE ROUTE COMMENT\u00C3\u2030E - Utilisait conditionConfig du n\u00C5\u201Cud directement\r\n// Maintenant nous utilisons la table TreeBranchLeafNodeCondition (voir ligne ~1554)\r\n/*\r\nrouter.get('/nodes/:nodeId/conditions', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n  const { organizationId, isSuperAdmin } = req.user! as { organizationId?: string; isSuperAdmin?: boolean };\r\n\r\n    // Charger le n\u00C5\u201Cud et v\u00C3\u00A9rifier l'organisation via l'arbre\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      select: {\r\n        conditionConfig: true,\r\n        TreeBranchLeafTree: { select: { organizationId: true } }\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const nodeOrg = node.TreeBranchLeafTree?.organizationId;\r\n    const hasOrgCtx = typeof organizationId === 'string' && organizationId.length > 0;\r\n    if (!isSuperAdmin && hasOrgCtx && nodeOrg && nodeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    return res.json(node.conditionConfig || {});\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node conditions:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des conditions du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n*/\r\n\r\n// PUT /api/treebranchleaf/nodes/:nodeId/conditions\r\n// Met \u00C3\u00A0 jour (ou cr\u00C3\u00A9e) la configuration de conditions d'un n\u00C5\u201Cud\r\nrouter.put('/nodes/:nodeId/conditions', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n  const { organizationId, isSuperAdmin } = req.user! as { organizationId?: string; isSuperAdmin?: boolean };\r\n    const payload = req.body ?? {};\r\n\r\n    // Valider grossi\u00C3\u00A8rement le payload (doit \u00C3\u00AAtre un objet JSON)\r\n    const isObject = payload && typeof payload === 'object' && !Array.isArray(payload);\r\n    if (!isObject) {\r\n      return res.status(400).json({ error: 'Payload de conditions invalide' });\r\n    }\r\n\r\n    // Charger le n\u00C5\u201Cud et v\u00C3\u00A9rifier l'organisation via l'arbre\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      select: { id: true, TreeBranchLeafTree: { select: { organizationId: true } } }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const nodeOrg = node.TreeBranchLeafTree?.organizationId;\r\n    const hasOrgCtx = typeof organizationId === 'string' && organizationId.length > 0;\r\n    if (!isSuperAdmin && hasOrgCtx && nodeOrg && nodeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    const updated = await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        conditionConfig: payload as Prisma.InputJsonValue,\r\n        hasCondition: true,\r\n        updatedAt: new Date()\r\n      },\r\n      select: { conditionConfig: true, hasCondition: true }\r\n    });\r\n\r\n    return res.json(updated.conditionConfig || {});\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating node conditions:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour des conditions du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00AE NODE FORMULA - Formule d'un n\u00C5\u201Cud\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId/formula\r\n// R\u00C3\u00A9cup\u00C3\u00A8re la configuration de formule d'un n\u00C5\u201Cud (formulaConfig)\r\nrouter.get('/nodes/:nodeId/formula', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = req.user! as { organizationId?: string; isSuperAdmin?: boolean };\r\n\r\n    // Charger le n\u00C5\u201Cud et v\u00C3\u00A9rifier l'organisation via l'arbre\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      select: {\r\n        formulaConfig: true,\r\n        TreeBranchLeafTree: { select: { organizationId: true } }\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const nodeOrg = node.TreeBranchLeafTree?.organizationId;\r\n    const hasOrgCtx = typeof organizationId === 'string' && organizationId.length > 0;\r\n    if (!isSuperAdmin && hasOrgCtx && nodeOrg && nodeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    return res.json(node.formulaConfig || {});\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la formule du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// PUT /nodes/:nodeId/formula\r\n// Met \u00C3\u00A0 jour (ou cr\u00C3\u00A9e) la configuration de formule d'un n\u00C5\u201Cud\r\nrouter.put('/nodes/:nodeId/formula', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = req.user! as { organizationId?: string; isSuperAdmin?: boolean };\r\n    const payload = req.body ?? {};\r\n\r\n    // Valider grossi\u00C3\u00A8rement le payload (doit \u00C3\u00AAtre un objet JSON)\r\n    const isObject = payload && typeof payload === 'object' && !Array.isArray(payload);\r\n    if (!isObject) {\r\n      return res.status(400).json({ error: 'Payload de formule invalide' });\r\n    }\r\n\r\n    // Charger le n\u00C5\u201Cud et v\u00C3\u00A9rifier l'organisation via l'arbre\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      select: { id: true, TreeBranchLeafTree: { select: { organizationId: true } } }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const nodeOrg = node.TreeBranchLeafTree?.organizationId;\r\n    const hasOrgCtx = typeof organizationId === 'string' && organizationId.length > 0;\r\n    if (!isSuperAdmin && hasOrgCtx && nodeOrg && nodeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    const updated = await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        formulaConfig: payload as Prisma.InputJsonValue,\r\n        hasFormula: true,\r\n        updatedAt: new Date()\r\n      },\r\n      select: { formulaConfig: true, hasFormula: true }\r\n    });\r\n\r\n    return res.json(updated.formulaConfig || {});\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating node formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour de la formule du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00AE NODE FORMULAS - Formules sp\u00C3\u00A9cifiques \u00C3\u00A0 un n\u00C5\u201Cud (nouvelle table d\u00C3\u00A9di\u00C3\u00A9e)\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId/formulas\r\n// Liste les formules sp\u00C3\u00A9cifiques \u00C3\u00A0 un n\u00C5\u201Cud\r\nrouter.get('/nodes/:nodeId/formulas', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les formules de ce n\u00C5\u201Cud\r\n    const formulas = await prisma.treeBranchLeafNodeFormula.findMany({\r\n      where: { nodeId },\r\n      orderBy: { createdAt: 'asc' }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Formulas for node ${nodeId}:`, formulas.length);\r\n    return res.json({ formulas });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node formulas:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des formules du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// POST /nodes/:nodeId/formulas\r\n// Cr\u00C3\u00A9e une nouvelle formule pour un n\u00C5\u201Cud\r\nrouter.post('/nodes/:nodeId/formulas', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { name, tokens, description } = req.body || {};\r\n\r\n    // Debug: log des infos d'authentification\r\n    console.log('\u00F0\u0178\u201D\u008D Formula creation auth debug:', {\r\n      nodeId,\r\n      organizationId,\r\n      isSuperAdmin,\r\n      reqUser: req.user,\r\n      headers: req.headers['x-organization-id']\r\n    });\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    if (!name || !Array.isArray(tokens)) {\r\n      return res.status(400).json({ error: 'Name et tokens requis' });\r\n    }\r\n\r\n    // G\u00C3\u00A9n\u00C3\u00A9rer un nom unique en cas de conflit\r\n    let uniqueName = String(name);\r\n    let counter = 1;\r\n    \r\n    while (true) {\r\n      try {\r\n        const existingFormula = await prisma.treeBranchLeafNodeFormula.findFirst({\r\n          where: {\r\n            nodeId,\r\n            name: uniqueName\r\n          }\r\n        });\r\n        \r\n        if (!existingFormula) {\r\n          break; // Le nom est disponible\r\n        }\r\n        \r\n        // Si le nom existe, ajouter un suffixe num\u00C3\u00A9rique\r\n        uniqueName = `${name} (${counter})`;\r\n        counter++;\r\n        \r\n      } catch (error) {\r\n        console.error('Erreur lors de la v\u00C3\u00A9rification du nom de formule:', error);\r\n        break;\r\n      }\r\n    }\r\n\r\n    const formula = await prisma.treeBranchLeafNodeFormula.create({\r\n      data: {\r\n        id: randomUUID(),\r\n        nodeId,\r\n        organizationId: organizationId || null,\r\n        name: uniqueName,\r\n        tokens: tokens as unknown as Prisma.InputJsonValue,\r\n        description: description ? String(description) : null,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    // \u00F0\u0178\u017D\u00AF ACTIVATION AUTOMATIQUE : Configurer hasFormula ET formula_activeId\r\n    console.log(`[TreeBranchLeaf API] Activation automatique de la formule cr\u00C3\u00A9\u00C3\u00A9e pour le n\u00C5\u201Cud ${nodeId}`);\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { \r\n        hasFormula: true,\r\n        formula_activeId: formula.id  // \u00F0\u0178\u017D\u00AF NOUVEAU : Activer automatiquement la formule\r\n      }\r\n    });\r\n\r\n    // \u00F0\u0178\u201D\u2014 MAJ linkedFormulaIds du n\u00C5\u201Cud propri\u00C3\u00A9taire + des n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s\r\n    try {\r\n      await addToNodeLinkedField(prisma, nodeId, 'linkedFormulaIds', [formula.id]);\r\n      const refIds = Array.from(extractNodeIdsFromTokens(tokens));\r\n      for (const refId of refIds) {\r\n        await addToNodeLinkedField(prisma, normalizeRefId(refId), 'linkedFormulaIds', [formula.id]);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning updating linkedFormulaIds after create:', (e as Error).message);\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] Created formula for node ${nodeId}:`, formula.name);\r\n    return res.status(201).json(formula);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error creating node formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00C3\u00A9ation de la formule' });\r\n  }\r\n});\r\n\r\n// PUT /api/treebranchleaf/nodes/:nodeId/formulas/:formulaId\r\n// Met \u00C3\u00A0 jour une formule sp\u00C3\u00A9cifique\r\nrouter.put('/nodes/:nodeId/formulas/:formulaId', async (req, res) => {\r\n  try {\r\n    const { nodeId, formulaId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { name, tokens, description } = req.body || {};\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // V\u00C3\u00A9rifier que la formule appartient bien \u00C3\u00A0 ce n\u00C5\u201Cud\r\n    const existingFormula = await prisma.treeBranchLeafNodeFormula.findFirst({\r\n      where: { id: formulaId, nodeId }\r\n    });\r\n\r\n    if (!existingFormula) {\r\n      return res.status(404).json({ error: 'Formule non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    const updated = await prisma.treeBranchLeafNodeFormula.update({\r\n      where: { id: formulaId },\r\n      data: {\r\n        name: name ? String(name) : undefined,\r\n        tokens: Array.isArray(tokens) ? (tokens as unknown as Prisma.InputJsonValue) : undefined,\r\n        description: description !== undefined ? (description ? String(description) : null) : undefined,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Updated formula ${formulaId} for node ${nodeId}`);\r\n    // \u00F0\u0178\u201D\u201E MAJ des r\u00C3\u00A9f\u00C3\u00A9rences inverses si tokens ont chang\u00C3\u00A9\r\n    try {\r\n      const oldRefs = extractNodeIdsFromTokens(existingFormula.tokens);\r\n      const newRefs = extractNodeIdsFromTokens(Array.isArray(tokens) ? tokens : existingFormula.tokens);\r\n      const oldSet = new Set(Array.from(oldRefs).map(normalizeRefId));\r\n      const newSet = new Set(Array.from(newRefs).map(normalizeRefId));\r\n      const toAdd: string[] = Array.from(newSet).filter(id => !oldSet.has(id));\r\n      const toRemove: string[] = Array.from(oldSet).filter(id => !newSet.has(id));\r\n      if (toAdd.length) {\r\n        for (const refId of toAdd) await addToNodeLinkedField(prisma, refId, 'linkedFormulaIds', [formulaId]);\r\n      }\r\n      if (toRemove.length) {\r\n        for (const refId of toRemove) await removeFromNodeLinkedField(prisma, refId, 'linkedFormulaIds', [formulaId]);\r\n      }\r\n      // S'assurer que le n\u00C5\u201Cud propri\u00C3\u00A9taire contient bien la formule\r\n      await addToNodeLinkedField(prisma, nodeId, 'linkedFormulaIds', [formulaId]);\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning updating inverse linkedFormulaIds after update:', (e as Error).message);\r\n    }\r\n\r\n    return res.json(updated);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating node formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour de la formule' });\r\n  }\r\n});\r\n\r\n// DELETE /api/treebranchleaf/nodes/:nodeId/formulas/:formulaId\r\n// Supprime une formule sp\u00C3\u00A9cifique\r\nrouter.delete('/nodes/:nodeId/formulas/:formulaId', async (req, res) => {\r\n  try {\r\n    const { nodeId, formulaId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // V\u00C3\u00A9rifier que la formule appartient bien \u00C3\u00A0 ce n\u00C5\u201Cud\r\n    const existingFormula = await prisma.treeBranchLeafNodeFormula.findFirst({\r\n      where: { id: formulaId, nodeId }\r\n    });\r\n\r\n    if (!existingFormula) {\r\n      return res.status(404).json({ error: 'Formule non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    await prisma.treeBranchLeafNodeFormula.delete({\r\n      where: { id: formulaId }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Deleted formula ${formulaId} for node ${nodeId}`);\r\n    \r\n    // \u00F0\u0178\u201D\u00A5 NOUVEAU : Supprimer la variable qui r\u00C3\u00A9f\u00C3\u00A9rence cette formule\r\n    try {\r\n      const variableWithFormula = await prisma.treeBranchLeafNodeVariable.findFirst({\r\n        where: { \r\n          nodeId,\r\n          sourceRef: `node-formula:${formulaId}`\r\n        }\r\n      });\r\n      \r\n      if (variableWithFormula) {\r\n        await prisma.treeBranchLeafNodeVariable.delete({\r\n          where: { nodeId }\r\n        });\r\n        console.log(`\u00E2\u0153\u2026 [TreeBranchLeaf API] Variable associ\u00C3\u00A9e supprim\u00C3\u00A9e pour formule ${formulaId}`);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning deleting associated variable:', (e as Error).message);\r\n    }\r\n    \r\n    // \u00F0\u0178\u201D\u201E Nettoyage linkedFormulaIds du n\u00C5\u201Cud propri\u00C3\u00A9taire et des n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s\r\n    try {\r\n      await removeFromNodeLinkedField(prisma, nodeId, 'linkedFormulaIds', [formulaId]);\r\n      const refIds = Array.from(extractNodeIdsFromTokens(existingFormula.tokens));\r\n      for (const refId of refIds) {\r\n        await removeFromNodeLinkedField(prisma, normalizeRefId(refId), 'linkedFormulaIds', [formulaId]);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning cleaning linkedFormulaIds after delete:', (e as Error).message);\r\n    }\r\n\r\n    // \u00F0\u0178\u017D\u00AF CORRECTION : Mettre \u00C3\u00A0 jour hasFormula en fonction des formules restantes\r\n    const remainingFormulas = await prisma.treeBranchLeafNodeFormula.count({ where: { nodeId } });\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { hasFormula: remainingFormulas > 0 }\r\n    });\r\n    console.log(`[TreeBranchLeaf API] Updated hasFormula to ${remainingFormulas > 0} for node ${nodeId}`);\r\n\r\n    return res.json({ success: true, message: 'Formule supprim\u00C3\u00A9e avec succ\u00C3\u00A8s' });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error deleting node formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de la formule' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201C\u0161 REUSABLE FORMULAS - Formules r\u00C3\u00A9utilisables (persistance Prisma)\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/reusables/formulas\r\n// Liste TOUTES les formules de TreeBranchLeafNodeFormula (toutes sont r\u00C3\u00A9utilisables !)\r\nrouter.get('/reusables/formulas', async (req, res) => {\r\n  try {\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const hasOrg = typeof organizationId === 'string' && organizationId.length > 0;\r\n\r\n    // Formules de n\u00C5\u201Cuds (toutes sont r\u00C3\u00A9utilisables)\r\n    const whereFilter = isSuperAdmin\r\n      ? {}\r\n      : {\r\n          OR: [\r\n            { organizationId: null },\r\n            ...(hasOrg ? [{ organizationId }] : [])\r\n          ]\r\n        };\r\n\r\n    const allFormulas = await prisma.treeBranchLeafNodeFormula.findMany({\r\n      where: whereFilter,\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    // Ajouter les m\u00C3\u00A9tadonn\u00C3\u00A9es pour le frontend\r\n    const items = allFormulas.map(f => ({\r\n      ...f,\r\n      type: 'node',\r\n      nodeLabel: f.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n      treeId: f.TreeBranchLeafNode?.treeId || null\r\n    }));\r\n\r\n  console.log('[TreeBranchLeaf API] All formulas listing', { \r\n    org: organizationId, \r\n    isSuperAdmin, \r\n    totalCount: allFormulas.length \r\n  });\r\n    return res.json({ items });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error listing all formulas:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des formules' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/reusables/formulas/:id\r\n// R\u00C3\u00A9cup\u00C3\u00A8re une formule sp\u00C3\u00A9cifique par son ID depuis TreeBranchLeafNodeFormula\r\nrouter.get('/reusables/formulas/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    const item = await prisma.treeBranchLeafNodeFormula.findUnique({ \r\n      where: { id },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!item) return res.status(404).json({ error: 'Formule non trouv\u00C3\u00A9e' });\r\n\r\n    if (!isSuperAdmin) {\r\n      // Autoris\u00C3\u00A9 si globale ou m\u00C3\u00AAme organisation\r\n      if (item.organizationId && item.organizationId !== organizationId) {\r\n        return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n      }\r\n    }\r\n\r\n    return res.json({\r\n      ...item,\r\n      type: 'node',\r\n      nodeLabel: item.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n      treeId: item.TreeBranchLeafNode?.treeId || null\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la formule' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u201E REUSABLE CONDITIONS - Conditions r\u00C3\u00A9utilisables globales\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/reusables/conditions\r\n// Liste toutes les conditions r\u00C3\u00A9utilisables (\u00C3\u00A9quivalent aux formules r\u00C3\u00A9utilisables)\r\nrouter.get('/reusables/conditions', async (req, res) => {\r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const hasOrg = typeof organizationId === 'string' && organizationId.length > 0;\r\n\r\n    // Conditions de n\u00C5\u201Cuds (toutes sont r\u00C3\u00A9utilisables)\r\n    const whereFilter = isSuperAdmin\r\n      ? {}\r\n      : {\r\n          OR: [\r\n            { organizationId: null },\r\n            ...(hasOrg ? [{ organizationId }] : [])\r\n          ]\r\n        };\r\n\r\n    const allConditions = await prisma.treeBranchLeafNodeCondition.findMany({\r\n      where: whereFilter,\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    // Ajouter les m\u00C3\u00A9tadonn\u00C3\u00A9es pour le frontend\r\n    const items = allConditions.map(c => ({\r\n      ...c,\r\n      type: 'node',\r\n      nodeLabel: c.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n      treeId: c.TreeBranchLeafNode?.treeId || null,\r\n      nodeId: c.nodeId\r\n    }));\r\n\r\n    console.log('[TreeBranchLeaf API] All conditions listing', { \r\n      org: organizationId, \r\n      isSuperAdmin, \r\n      totalCount: items.length \r\n    });\r\n\r\n    return res.json({ items });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error listing reusable conditions:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des conditions r\u00C3\u00A9utilisables' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/reusables/conditions/:id\r\n// R\u00C3\u00A9cup\u00C3\u00A8re une condition sp\u00C3\u00A9cifique par son ID depuis TreeBranchLeafNodeCondition\r\nrouter.get('/reusables/conditions/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    const item = await prisma.treeBranchLeafNodeCondition.findUnique({ \r\n      where: { id },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n    if (!item) return res.status(404).json({ error: 'Condition non trouv\u00C3\u00A9e' });\r\n\r\n    if (!isSuperAdmin) {\r\n      // Autoris\u00C3\u00A9 si globale ou m\u00C3\u00AAme organisation\r\n      if (item.organizationId && item.organizationId !== organizationId) {\r\n        return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n      }\r\n    }\r\n\r\n    return res.json({\r\n      ...item,\r\n      type: 'node',\r\n      nodeLabel: item.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n      treeId: item.TreeBranchLeafNode?.treeId || null\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting condition:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la condition' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/reusables/tables\r\n// Liste TOUTES les tables r\u00C3\u00A9utilisables de TOUS les n\u00C5\u201Cuds (avec filtrage organisation)\r\nrouter.get('/reusables/tables', async (req, res) => {\r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const hasOrg = typeof organizationId === 'string' && organizationId.length > 0;\r\n\r\n    // Tables de n\u00C5\u201Cuds (toutes sont r\u00C3\u00A9utilisables)\r\n    const whereFilter = isSuperAdmin\r\n      ? {}\r\n      : {\r\n          OR: [\r\n            { organizationId: null },\r\n            ...(hasOrg ? [{ organizationId }] : [])\r\n          ]\r\n        };\r\n\r\n    const allTables = await prisma.treeBranchLeafNodeTable.findMany({\r\n      where: whereFilter,\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    // Ajouter les m\u00C3\u00A9tadonn\u00C3\u00A9es pour le frontend\r\n    const items = allTables.map(t => ({\r\n      id: t.id,\r\n      name: t.name,\r\n      type: t.type,\r\n      description: t.description,\r\n      nodeLabel: t.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n      treeId: t.TreeBranchLeafNode?.treeId || null,\r\n      nodeId: t.nodeId,\r\n      createdAt: t.createdAt,\r\n      updatedAt: t.updatedAt\r\n    }));\r\n\r\n    console.log('[TreeBranchLeaf API] All tables listing', { \r\n      org: organizationId, \r\n      isSuperAdmin, \r\n      totalCount: items.length \r\n    });\r\n\r\n    return res.json({ items });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error listing reusable tables:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des tables r\u00C3\u00A9utilisables' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00E2\u0161\u2013\u00EF\u00B8\u008F NODE CONDITIONS - Conditions sp\u00C3\u00A9cifiques \u00C3\u00A0 un n\u00C5\u201Cud (nouvelle table d\u00C3\u00A9di\u00C3\u00A9e)\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId/conditions\r\n// Liste les conditions sp\u00C3\u00A9cifiques \u00C3\u00A0 un n\u00C5\u201Cud\r\nrouter.get('/nodes/:nodeId/conditions', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D GET conditions for node ${nodeId}:`);\r\n    console.log(`[TreeBranchLeaf API] - organizationId: ${organizationId}`);\r\n    console.log(`[TreeBranchLeaf API] - isSuperAdmin: ${isSuperAdmin}`);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les conditions de ce n\u00C5\u201Cud avec filtre d'organisation\r\n    const whereClause: { nodeId: string; organizationId?: string } = { nodeId };\r\n    \r\n    // Ajouter le filtre d'organisation si ce n'est pas un super admin\r\n    if (!isSuperAdmin && organizationId) {\r\n      whereClause.organizationId = organizationId;\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] - whereClause:`, whereClause);\r\n\r\n    const conditions = await prisma.treeBranchLeafNodeCondition.findMany({\r\n      where: whereClause,\r\n      orderBy: { createdAt: 'asc' }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Conditions for node ${nodeId} (org: ${organizationId}):`, conditions.length);\r\n    console.log(`[TreeBranchLeaf API] Details:`, conditions.map(c => ({ id: c.id, name: c.name, organizationId: c.organizationId })));\r\n    \r\n    return res.json({ conditions });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node conditions:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des conditions du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/evaluate/condition/:conditionId\r\n// \u00C3\u2030value une condition sp\u00C3\u00A9cifique et retourne le r\u00C3\u00A9sultat\r\nrouter.post('/evaluate/condition/:conditionId', async (req, res) => {\r\n  try {\r\n    const { conditionId } = req.params;\r\n    const { fieldValues = {}, values = {}, submissionId, testMode = true } = req.body;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // Fusionner fieldValues et values pour compatibilit\u00C3\u00A9\r\n    const allValues = { ...fieldValues, ...values };\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE \u00C3\u2030valuation condition ${conditionId}:`, { allValues, submissionId, testMode });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la condition\r\n    const condition = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n      where: { id: conditionId },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!condition) {\r\n      return res.status(404).json({ error: 'Condition non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s organisation\r\n    if (!isSuperAdmin && condition.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette condition' });\r\n    }\r\n\r\n    // \u00F0\u0178\u0161\u20AC UTILISATION DU SYST\u00C3\u02C6ME UNIFI\u00C3\u2030 operation-interpreter\r\n    try {\r\n      const { evaluateVariableOperation } = await import('./operation-interpreter');\r\n      \r\n      // Convertir allValues en Map pour le mode preview\r\n      const valueMapLocal = new Map<string, unknown>();\r\n      Object.entries(allValues).forEach(([nodeId, value]) => {\r\n        valueMapLocal.set(nodeId, value);\r\n      });\r\n      \r\n      console.log('[TBL-PRISMA] \u00F0\u0178\u00A7\u00AE \u00C3\u2030valuation avec operation-interpreter:', { conditionId, values: Object.fromEntries(valueMapLocal) });\r\n      \r\n      // \u00E2\u0153\u00A8 Calculer avec le syst\u00C3\u00A8me unifi\u00C3\u00A9 (passe valueMapLocal pour mode preview)\r\n      const calculationResult = await evaluateVariableOperation(\r\n        condition.nodeId,\r\n        submissionId || conditionId,\r\n        prisma,\r\n        valueMapLocal\r\n      );\r\n      \r\n      console.log('[TBL-PRISMA] \u00E2\u0153\u2026 R\u00C3\u00A9sultat \u00C3\u00A9valuation:', calculationResult);\r\n      \r\n      // Construire la r\u00C3\u00A9ponse UNIQUEMENT avec TBL-prisma (pas de fallback !)\r\n      const result = {\r\n        conditionId: condition.id,\r\n        conditionName: condition.name,\r\n        nodeLabel: condition.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n        operationSource: calculationResult.operationSource,\r\n        operationDetail: calculationResult.operationDetail,\r\n        operationResult: calculationResult.operationResult,\r\n        evaluation: {\r\n          success: true,\r\n          mode: 'tbl-prisma',\r\n          timestamp: new Date().toISOString(),\r\n          testMode: testMode\r\n        }\r\n      };\r\n      \r\n      return res.json(result);\r\n      \r\n    } catch (error) {\r\n      console.error('[TBL-PRISMA] \u00E2\u009D\u0152 Erreur \u00C3\u00A9valuation TBL-prisma:', error);\r\n      \r\n      return res.status(500).json({\r\n        error: 'Erreur lors de l\\'\u00C3\u00A9valuation TBL-prisma',\r\n        details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error evaluating condition:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'\u00C3\u00A9valuation de la condition' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/nodes/:nodeId/conditions\r\n// Cr\u00C3\u00A9e une nouvelle condition pour un n\u00C5\u201Cud\r\nrouter.post('/nodes/:nodeId/conditions', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { name, conditionSet, description } = req.body || {};\r\n\r\n    // Debug: log des infos d'authentification\r\n    console.log('\u00F0\u0178\u201D\u008D Condition creation auth debug:', {\r\n      nodeId,\r\n      organizationId,\r\n      isSuperAdmin,\r\n      reqUser: req.user,\r\n      headers: req.headers['x-organization-id']\r\n    });\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    if (!name || !conditionSet) {\r\n      return res.status(400).json({ error: 'Name et conditionSet requis' });\r\n    }\r\n\r\n    // G\u00C3\u00A9n\u00C3\u00A9rer un nom unique si le nom existe d\u00C3\u00A9j\u00C3\u00A0\r\n    let uniqueName = String(name);\r\n    let counter = 1;\r\n    \r\n    while (true) {\r\n      const existingCondition = await prisma.treeBranchLeafNodeCondition.findFirst({\r\n        where: {\r\n          nodeId,\r\n          name: uniqueName,\r\n          organizationId: organizationId || null\r\n        }\r\n      });\r\n      \r\n      if (!existingCondition) {\r\n        break; // Le nom est unique\r\n      }\r\n      \r\n      // Le nom existe, ajouter un num\u00C3\u00A9ro\r\n      uniqueName = `${name} (${counter})`;\r\n      counter++;\r\n      \r\n      // S\u00C3\u00A9curit\u00C3\u00A9: \u00C3\u00A9viter une boucle infinie\r\n      if (counter > 100) {\r\n        uniqueName = `${name} (${Date.now()})`;\r\n        break;\r\n      }\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] Nom unique g\u00C3\u00A9n\u00C3\u00A9r\u00C3\u00A9: \"${uniqueName}\" (original: \"${name}\")`);\r\n\r\n    const condition = await prisma.treeBranchLeafNodeCondition.create({\r\n      data: {\r\n        id: randomUUID(),\r\n        nodeId,\r\n        organizationId: organizationId || null,\r\n        name: uniqueName,\r\n        conditionSet: conditionSet as unknown as Prisma.InputJsonValue,\r\n        description: description ? String(description) : null,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    // \u00F0\u0178\u017D\u00AF ACTIVATION AUTOMATIQUE : Configurer hasCondition ET condition_activeId\r\n    console.log(`[TreeBranchLeaf API] Activation automatique de la condition cr\u00C3\u00A9\u00C3\u00A9e pour le n\u00C5\u201Cud ${nodeId}`);\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { \r\n        hasCondition: true,\r\n        condition_activeId: condition.id  // \u00F0\u0178\u017D\u00AF NOUVEAU : Activer automatiquement la condition\r\n      }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Created condition for node ${nodeId}:`, condition.name);\r\n    // \u00F0\u0178\u201D\u2014 MAJ linkedConditionIds du n\u00C5\u201Cud propri\u00C3\u00A9taire + des n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s\r\n    try {\r\n      await addToNodeLinkedField(prisma, nodeId, 'linkedConditionIds', [condition.id]);\r\n      const refIds = Array.from(extractNodeIdsFromConditionSet(conditionSet));\r\n      for (const refId of refIds) {\r\n        await addToNodeLinkedField(prisma, normalizeRefId(refId), 'linkedConditionIds', [condition.id]);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning updating linkedConditionIds after create:', (e as Error).message);\r\n    }\r\n\r\n    return res.status(201).json(condition);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error creating node condition:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00C3\u00A9ation de la condition' });\r\n  }\r\n});\r\n\r\n// PUT /api/treebranchleaf/nodes/:nodeId/conditions/:conditionId\r\n// Met \u00C3\u00A0 jour une condition sp\u00C3\u00A9cifique\r\nrouter.put('/nodes/:nodeId/conditions/:conditionId', async (req, res) => {\r\n  try {\r\n    const { nodeId, conditionId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { name, conditionSet, description } = req.body || {};\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // V\u00C3\u00A9rifier que la condition appartient bien \u00C3\u00A0 ce n\u00C5\u201Cud\r\n    const existingCondition = await prisma.treeBranchLeafNodeCondition.findFirst({\r\n      where: { id: conditionId, nodeId }\r\n    });\r\n\r\n    if (!existingCondition) {\r\n      return res.status(404).json({ error: 'Condition non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    const updated = await prisma.treeBranchLeafNodeCondition.update({\r\n      where: { id: conditionId },\r\n      data: {\r\n        name: name ? String(name) : undefined,\r\n        conditionSet: conditionSet ? (conditionSet as unknown as Prisma.InputJsonValue) : undefined,\r\n        description: description !== undefined ? (description ? String(description) : null) : undefined,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Updated condition ${conditionId} for node ${nodeId}`);\r\n    // \u00F0\u0178\u201D\u201E MAJ des r\u00C3\u00A9f\u00C3\u00A9rences inverses si conditionSet a chang\u00C3\u00A9\r\n    try {\r\n      const oldRefs = extractNodeIdsFromConditionSet(existingCondition.conditionSet);\r\n      const newRefs = extractNodeIdsFromConditionSet(conditionSet ?? existingCondition.conditionSet);\r\n      const oldSet = new Set(Array.from(oldRefs).map(normalizeRefId));\r\n      const newSet = new Set(Array.from(newRefs).map(normalizeRefId));\r\n      const toAdd: string[] = Array.from(newSet).filter(id => !oldSet.has(id));\r\n      const toRemove: string[] = Array.from(oldSet).filter(id => !newSet.has(id));\r\n      if (toAdd.length) {\r\n        for (const refId of toAdd) await addToNodeLinkedField(prisma, refId, 'linkedConditionIds', [conditionId]);\r\n      }\r\n      if (toRemove.length) {\r\n        for (const refId of toRemove) await removeFromNodeLinkedField(prisma, refId, 'linkedConditionIds', [conditionId]);\r\n      }\r\n      // S'assurer que le n\u00C5\u201Cud propri\u00C3\u00A9taire contient bien la condition\r\n      await addToNodeLinkedField(prisma, nodeId, 'linkedConditionIds', [conditionId]);\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning updating inverse linkedConditionIds after update:', (e as Error).message);\r\n    }\r\n\r\n    return res.json(updated);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating node condition:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour de la condition' });\r\n  }\r\n});\r\n\r\n// DELETE /api/treebranchleaf/nodes/:nodeId/conditions/:conditionId\r\n// Supprime une condition sp\u00C3\u00A9cifique\r\nrouter.delete('/nodes/:nodeId/conditions/:conditionId', async (req, res) => {\r\n  try {\r\n    const { nodeId, conditionId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // V\u00C3\u00A9rifier que la condition appartient bien \u00C3\u00A0 ce n\u00C5\u201Cud\r\n    const existingCondition = await prisma.treeBranchLeafNodeCondition.findFirst({\r\n      where: { id: conditionId, nodeId }\r\n    });\r\n\r\n    if (!existingCondition) {\r\n      return res.status(404).json({ error: 'Condition non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    await prisma.treeBranchLeafNodeCondition.delete({\r\n      where: { id: conditionId }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] Deleted condition ${conditionId} for node ${nodeId}`);\r\n    \r\n    // \u00F0\u0178\u201D\u00A5 NOUVEAU : Supprimer la variable qui r\u00C3\u00A9f\u00C3\u00A9rence cette condition\r\n    try {\r\n      const variableWithCondition = await prisma.treeBranchLeafNodeVariable.findFirst({\r\n        where: { \r\n          nodeId,\r\n          sourceRef: `node-condition:${conditionId}`\r\n        }\r\n      });\r\n      \r\n      if (variableWithCondition) {\r\n        await prisma.treeBranchLeafNodeVariable.delete({\r\n          where: { nodeId }\r\n        });\r\n        console.log(`\u00E2\u0153\u2026 [TreeBranchLeaf API] Variable associ\u00C3\u00A9e supprim\u00C3\u00A9e pour condition ${conditionId}`);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning deleting associated variable:', (e as Error).message);\r\n    }\r\n    \r\n    // \u00F0\u0178\u201D\u201E Nettoyage linkedConditionIds du n\u00C5\u201Cud propri\u00C3\u00A9taire et des n\u00C5\u201Cuds r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9s\r\n    try {\r\n      await removeFromNodeLinkedField(prisma, nodeId, 'linkedConditionIds', [conditionId]);\r\n      const refIds = Array.from(extractNodeIdsFromConditionSet(existingCondition.conditionSet));\r\n      for (const refId of refIds) {\r\n        await removeFromNodeLinkedField(prisma, normalizeRefId(refId), 'linkedConditionIds', [conditionId]);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[TreeBranchLeaf API] Warning cleaning linkedConditionIds after delete:', (e as Error).message);\r\n    }\r\n\r\n    // \u00F0\u0178\u017D\u00AF CORRECTION : Mettre \u00C3\u00A0 jour hasCondition en fonction des conditions restantes\r\n    const remainingConditions = await prisma.treeBranchLeafNodeCondition.count({ where: { nodeId } });\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { hasCondition: remainingConditions > 0 }\r\n    });\r\n    console.log(`[TreeBranchLeaf API] Updated hasCondition to ${remainingConditions > 0} for node ${nodeId}`);\r\n\r\n    return res.json({ success: true, message: 'Condition supprim\u00C3\u00A9e avec succ\u00C3\u00A8s' });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error deleting node condition:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de la condition' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u2014\u201A\u00EF\u00B8\u008F NODE TABLES - Gestion des instances de tableaux d\u00C3\u00A9di\u00C3\u00A9es\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/tables/:id - D\u00C3\u00A9tails d'une table avec lignes pagin\u00C3\u00A9es\r\nrouter.get('/tables/:id', async (req, res) => {\r\n  const { id } = req.params;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n  \r\n  // Pagination\r\n  const page = parseInt(req.query.page as string) || 1;\r\n  const limit = parseInt(req.query.limit as string) || 100; // Par d\u00C3\u00A9faut, 100 lignes\r\n  const offset = (page - 1) * limit;\r\n\r\n  console.log(`[GET /tables/:id] R\u00C3\u00A9cup\u00C3\u00A9ration de la table ${id} avec pagination (page: ${page}, limit: ${limit})`);\r\n\r\n  try {\r\n    const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id },\r\n      include: {\r\n        node: {\r\n          select: {\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: {\r\n                organizationId: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!table) {\r\n      return res.status(404).json({ error: 'Table non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rification de l'organisation\r\n    const tableOrgId = table.node?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s non autoris\u00C3\u00A9 \u00C3\u00A0 cette table' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les lignes pagin\u00C3\u00A9es\r\n    const rows = await prisma.treeBranchLeafNodeTableRow.findMany({\r\n      where: { tableId: id },\r\n      orderBy: { rowIndex: 'asc' },\r\n      take: limit,\r\n      skip: offset,\r\n    });\r\n\r\n    console.log(`[GET /tables/:id] ${rows.length} lignes r\u00C3\u00A9cup\u00C3\u00A9r\u00C3\u00A9es pour la table ${id}.`);\r\n\r\n    // Renvoyer la r\u00C3\u00A9ponse\r\n    res.json({\r\n      ...table,\r\n      rows: rows.map(r => r.cells), // Renvoyer uniquement les donn\u00C3\u00A9es des cellules\r\n      page,\r\n      limit,\r\n      totalRows: table.rowCount,\r\n      totalPages: Math.ceil(table.rowCount / limit),\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(`\u00E2\u009D\u0152 [GET /tables/:id] Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la table ${id}:`, error);\r\n    res.status(500).json({ error: 'Impossible de r\u00C3\u00A9cup\u00C3\u00A9rer la table' });\r\n  }\r\n});\r\n\r\ntype TableJsonValue = Prisma.JsonValue;\r\ntype TableJsonObject = Prisma.JsonObject;\r\n\r\nconst isJsonObject = (value: TableJsonValue | null | undefined): value is TableJsonObject =>\r\n  !!value && typeof value === 'object' && !Array.isArray(value);\r\n\r\nconst jsonClone = <T>(value: T): T => JSON.parse(JSON.stringify(value ?? null)) as T;\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u2014\u0153\u00EF\u00B8\u008F COMPRESSION POUR GROS TABLEAUX\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n/**\r\n * \u00E2\u0161\u00A0\u00EF\u00B8\u008F FONCTION D\u00C3\u2030PR\u00C3\u2030CI\u00C3\u2030E - Utilisait l'ancienne architecture avec colonnes JSON\r\n * Maintenant que les tables sont normalis\u00C3\u00A9es (table-routes-new.ts), cette fonction n'est plus utilis\u00C3\u00A9e\r\n */\r\n/*\r\nconst compressIfNeeded = (data: TableJsonValue): TableJsonValue => {\r\n  if (!data || typeof data !== 'object') return data;\r\n  \r\n  const jsonString = JSON.stringify(data);\r\n  const sizeKB = jsonString.length / 1024;\r\n  \r\n  console.log('[compressIfNeeded] Taille non compress\u00C3\u00A9e:', Math.round(sizeKB), 'KB');\r\n  \r\n  // Si > 1MB, on compresse\r\n  if (sizeKB > 1024) {\r\n    console.log('[compressIfNeeded] \u00F0\u0178\u2014\u0153\u00EF\u00B8\u008F Compression activ\u00C3\u00A9e (taille > 1MB)');\r\n    const compressed = gzipSync(jsonString);\r\n    const compressedB64 = compressed.toString('base64');\r\n    const compressedSizeKB = compressedB64.length / 1024;\r\n    const ratio = Math.round((1 - compressedSizeKB / sizeKB) * 100);\r\n    \r\n    console.log('[compressIfNeeded] \u00E2\u0153\u2026 Taille compress\u00C3\u00A9e:', Math.round(compressedSizeKB), 'KB (r\u00C3\u00A9duction:', ratio + '%)');\r\n    \r\n    return {\r\n      _compressed: true,\r\n      _data: compressedB64\r\n    } as TableJsonValue;\r\n  }\r\n  \r\n  console.log('[compressIfNeeded] Pas de compression n\u00C3\u00A9cessaire');\r\n  return data;\r\n};\r\n*/\r\n\r\n/**\r\n * D\u00C3\u00A9compresse les donn\u00C3\u00A9es si elles \u00C3\u00A9taient compress\u00C3\u00A9es\r\n */\r\nconst _decompressIfNeeded = (value: TableJsonValue | null | undefined): TableJsonValue => {\r\n  if (!value || typeof value !== 'object') return value;\r\n  \r\n  const obj = value as TableJsonObject;\r\n  \r\n  if (obj._compressed && typeof obj._data === 'string') {\r\n  console.log('[decompressIfNeeded] \u00F0\u0178\u201D\u201C D\u00C3\u00A9compression des donn\u00C3\u00A9es...');\r\n    try {\r\n      const buffer = Buffer.from(obj._data, 'base64');\r\n      const decompressed = gunzipSync(buffer);\r\n      const jsonString = decompressed.toString('utf-8');\r\n      const result = JSON.parse(jsonString);\r\n  console.log('[decompressIfNeeded] \u00E2\u0153\u2026 D\u00C3\u00A9compression r\u00C3\u00A9ussie');\r\n      return result;\r\n    } catch (error) {\r\n  console.error('[decompressIfNeeded] \u00E2\u009D\u0152 Erreur d\u00C3\u00A9compression:', error);\r\n      return value;\r\n    }\r\n  }\r\n  \r\n  return value;\r\n};\r\n\r\n// \u00E2\u0161\u00A0\u00EF\u00B8\u008F OBSOL\u00C3\u02C6TE : readStringArray supprim\u00C3\u00A9e - Architecture normalis\u00C3\u00A9e utilise tableColumns\r\n\r\n// \u00E2\u0161\u00A0\u00EF\u00B8\u008F OBSOL\u00C3\u02C6TE : readMatrix et readStringArray supprim\u00C3\u00A9es - Architecture normalis\u00C3\u00A9e utilise tableRows/tableColumns\r\n\r\nconst readMeta = (value: TableJsonValue | null | undefined): Record<string, unknown> => {\r\n  if (!value) return {};\r\n  if (!isJsonObject(value)) return {};\r\n  return jsonClone(value);\r\n};\r\n\r\nconst buildRecordRows = (\r\n  columns: string[],\r\n  matrix: (string | number | boolean | null)[][]\r\n): Record<string, string | number | boolean | null>[] => {\r\n  console.log('[buildRecordRows] \u00F0\u0178\u201D\u008D ENTR\u00C3\u2030E:');\r\n  console.log('[buildRecordRows] columns:', columns.length);\r\n  console.log('[buildRecordRows] matrix:', matrix.length, 'lignes');\r\n  \r\n  const result = matrix.map((row) => {\r\n    const obj: Record<string, string | number | boolean | null> = {};\r\n    columns.forEach((col, index) => {\r\n      obj[col] = index < row.length ? row[index] ?? null : null;\r\n    });\r\n    return obj;\r\n  });\r\n  \r\n  console.log('[buildRecordRows] \u00F0\u0178\u017D\u00AF SORTIE:', result.length, 'records');\r\n  return result;\r\n};\r\n\r\ntype NormalizedTableInstance = {\r\n  id: string;\r\n  name: string;\r\n  description: string | null;\r\n  type: string;\r\n  columns: string[];\r\n  rows: string[];\r\n  matrix: (string | number | boolean | null)[][];\r\n  data: { matrix: (string | number | boolean | null)[][] };\r\n  records: Record<string, string | number | boolean | null>[];\r\n  meta: Record<string, unknown>;\r\n  order: number;\r\n  isDefault: boolean;\r\n};\r\n\r\nconst normalizeTableInstance = (\r\n  table: any // TableColumns et TableRows charg\u00C3\u00A9s via include\r\n): NormalizedTableInstance => {\r\n  try {\r\n    console.log('[normalizeTableInstance] \u00F0\u0178\u201D\u201E ARCHITECTURE NORMALIS\u00C3\u2030E');\r\n    console.log('[normalizeTableInstance] table.id:', table.id);\r\n    console.log('[normalizeTableInstance] tableColumns:', table.tableColumns?.length || 0);\r\n    console.log('[normalizeTableInstance] tableRows:', table.tableRows?.length || 0);\r\n    \r\n    // \u00F0\u0178\u201C\u0160 ARCHITECTURE NORMALIS\u00C3\u2030E : tableColumns et tableRows\r\n    const columns = (table.tableColumns || [])\r\n      .sort((a: any, b: any) => a.columnIndex - b.columnIndex)\r\n      .map((col: any) => col.name);\r\n    \r\n    const rows = (table.tableRows || [])\r\n      .sort((a: any, b: any) => a.rowIndex - b.rowIndex)\r\n      .map((row: any) => {\r\n        // \u00E2\u0153\u2026 NOUVEAU: Prisma Json type retourne directement l'objet\r\n        let cells: any;\r\n        \r\n        if (Array.isArray(row.cells)) {\r\n          // Format actuel: cells est d\u00C3\u00A9j\u00C3\u00A0 un array d'objets JS\r\n          cells = row.cells;\r\n        } else if (typeof row.cells === 'string') {\r\n          // Ancien format string BRUTE (pas JSON): \"Nord\", \"Sud-Est\"...\r\n          // C'est juste le label, pas un tableau !\r\n          return row.cells;\r\n        } else if (row.cells === null || row.cells === undefined) {\r\n          return '';\r\n        } else {\r\n          // Autre format inconnu\r\n          cells = [];\r\n        }\r\n        \r\n        // Extraire le label (premier \u00C3\u00A9l\u00C3\u00A9ment de l'array)\r\n        return Array.isArray(cells) && cells.length > 0 ? String(cells[0]) : '';\r\n      });\r\n    \r\n    const matrix = (table.tableRows || [])\r\n      .sort((a: any, b: any) => a.rowIndex - b.rowIndex)\r\n      .map((row: any) => {\r\n        // \u00E2\u0153\u2026 NOUVEAU: Prisma Json type retourne directement l'objet\r\n        let cells: any;\r\n        \r\n        if (Array.isArray(row.cells)) {\r\n          // Format actuel: cells est d\u00C3\u00A9j\u00C3\u00A0 un array d'objets JS\r\n          cells = row.cells;\r\n        } else if (typeof row.cells === 'string') {\r\n          // Ancien format string BRUTE: juste le label, pas de donn\u00C3\u00A9es\r\n          // Retourner array vide car pas de data numeric\r\n          return [];\r\n        } else {\r\n          cells = [];\r\n        }\r\n        \r\n        // Les donn\u00C3\u00A9es commencent \u00C3\u00A0 partir de l'index 1 (index 0 = label)\r\n        return Array.isArray(cells) ? cells.slice(1) : [];\r\n      });\r\n    \r\n    console.log('[normalizeTableInstance] \u00E2\u0153\u2026 columns:', columns.length, columns);\r\n    console.log('[normalizeTableInstance] \u00E2\u0153\u2026 rows:', rows.length, rows);\r\n    console.log('[normalizeTableInstance] \u00E2\u0153\u2026 matrix:', matrix.length);\r\n    \r\n    const meta = readMeta(table.meta);\r\n\r\n    const result = {\r\n      id: table.id,\r\n      name: table.name,\r\n      description: table.description ?? null,\r\n      type: table.type ?? 'columns',\r\n      columns,\r\n      rows,\r\n      matrix,\r\n      data: { matrix },\r\n      records: buildRecordRows(columns, matrix),\r\n      meta,\r\n      order: table.order ?? 0,\r\n      isDefault: Boolean(table.isDefault),\r\n    };\r\n\r\n    console.log('[normalizeTableInstance] \u00F0\u0178\u017D\u00AF SORTIE:');\r\n    console.log('[normalizeTableInstance] result.columns:', result.columns.length);\r\n    console.log('[normalizeTableInstance] result.rows:', result.rows.length);\r\n    console.log('[normalizeTableInstance] result.matrix:', result.matrix.length);\r\n    console.log('[normalizeTableInstance] result.records:', result.records.length);\r\n\r\n    return result;\r\n  } catch (error) {\r\n    console.error('[normalizeTableInstance] \u00E2\u009D\u0152 ERREUR FATALE:', error);\r\n    console.error('[normalizeTableInstance] table.id:', table?.id);\r\n    console.error('[normalizeTableInstance] table structure:', JSON.stringify(table, null, 2));\r\n    throw error;\r\n  }\r\n};\r\n\r\nconst syncNodeTableCapability = async (\r\n  nodeId: string,\r\n  client: PrismaClient | Prisma.TransactionClient = prisma\r\n) => {\r\n  const node = await client.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { id: true, table_activeId: true },\r\n  });\r\n\r\n  if (!node) return;\r\n\r\n  const tables = await client.treeBranchLeafNodeTable.findMany({\r\n    where: { nodeId },\r\n    orderBy: [{ order: 'asc' }, { createdAt: 'asc' }],\r\n  });\r\n\r\n  if (tables.length === 0) {\r\n    await client.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        hasTable: false,\r\n        table_instances: null,\r\n        table_activeId: null,\r\n        table_name: null,\r\n        table_type: null,\r\n        table_columns: null,\r\n        table_rows: null,\r\n        table_data: null,\r\n        table_meta: null,\r\n        table_isImported: false,\r\n        table_importSource: null,\r\n      },\r\n    });\r\n    return;\r\n  }\r\n\r\n  const normalizedList = tables.map(normalizeTableInstance);\r\n  const instances = normalizedList.reduce<Record<string, unknown>>((acc, instance) => {\r\n    acc[instance.id] = {\r\n      id: instance.id,\r\n      name: instance.name,\r\n      description: instance.description,\r\n      type: instance.type,\r\n      columns: instance.columns,\r\n      rows: instance.rows,\r\n      matrix: instance.matrix,\r\n      data: instance.data,\r\n      records: instance.records,\r\n      meta: instance.meta,\r\n      order: instance.order,\r\n      isDefault: instance.isDefault,\r\n    };\r\n    return acc;\r\n  }, {});\r\n\r\n  const active =\r\n    normalizedList.find((tbl) => tbl.id === node.table_activeId) ??\r\n    normalizedList.find((tbl) => tbl.isDefault) ??\r\n    normalizedList[0];\r\n\r\n  const activeMeta = (active?.meta ?? {}) as Record<string, unknown>;\r\n  const inferredIsImported =\r\n    typeof (activeMeta as { isImported?: unknown }).isImported === 'boolean'\r\n      ? (activeMeta as { isImported: boolean }).isImported\r\n      : Boolean((activeMeta as { isImported?: unknown }).isImported);\r\n  const inferredImportSource =\r\n    typeof (activeMeta as { importSource?: unknown }).importSource === 'string'\r\n      ? (activeMeta as { importSource: string }).importSource\r\n      : null;\r\n\r\n  await client.treeBranchLeafNode.update({\r\n    where: { id: nodeId },\r\n    data: {\r\n      hasTable: true,\r\n      table_instances: instances as Prisma.InputJsonValue,\r\n      table_activeId: active?.id ?? null,\r\n      table_name: active?.name ?? null,\r\n      table_type: active?.type ?? null,\r\n      table_columns: (active?.columns ?? null) as Prisma.InputJsonValue,\r\n      table_rows: (active?.rows ?? null) as Prisma.InputJsonValue,\r\n      table_data: (active?.matrix ?? null) as Prisma.InputJsonValue,\r\n      table_meta: (active?.meta ?? null) as Prisma.InputJsonValue,\r\n      table_isImported: inferredIsImported,\r\n      table_importSource: inferredImportSource,\r\n    },\r\n  });\r\n};\r\n\r\nconst fetchNormalizedTable = async (\r\n  nodeId: string,\r\n  options: { tableId?: string } = {},\r\n  client: PrismaClient | Prisma.TransactionClient = prisma\r\n): Promise<{ table: NormalizedTableInstance; tables: NormalizedTableInstance[] } | null> => {\r\n  const tablesRaw = await client.treeBranchLeafNodeTable.findMany({\r\n    where: { nodeId },\r\n    orderBy: [{ order: 'asc' }, { createdAt: 'asc' }],\r\n  });\r\n\r\n  if (!tablesRaw.length) {\r\n    return null;\r\n  }\r\n\r\n  const tables = tablesRaw.map(normalizeTableInstance);\r\n\r\n  let target = options.tableId ? tables.find((tbl) => tbl.id === options.tableId) : undefined;\r\n\r\n  if (!target) {\r\n    const nodeInfo = await client.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      select: { table_activeId: true },\r\n    });\r\n\r\n    if (nodeInfo?.table_activeId) {\r\n      target = tables.find((tbl) => tbl.id === nodeInfo.table_activeId) ?? target;\r\n    }\r\n  }\r\n\r\n  const table = target ?? tables[0];\r\n\r\n  return { table, tables };\r\n};\r\n\r\n// R\u00C3\u00A9cup\u00C3\u00A9rer toutes les instances de tableaux d'un n\u00C5\u201Cud\r\nrouter.get('/nodes/:nodeId/tables', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    const tables = await prisma.treeBranchLeafNodeTable.findMany({\r\n      where: { nodeId },\r\n      include: {\r\n        tableColumns: {\r\n          orderBy: { columnIndex: 'asc' }\r\n        },\r\n        tableRows: {\r\n          orderBy: { rowIndex: 'asc' }\r\n        }\r\n      },\r\n      orderBy: [{ order: 'asc' }, { createdAt: 'asc' }]\r\n    });\r\n\r\n    const normalized = tables.map(normalizeTableInstance);\r\n\r\n    console.log(`[TreeBranchLeaf API] Retrieved ${normalized.length} tables for node ${nodeId}`);\r\n    return res.json(normalized);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching node tables:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des tableaux' });\r\n  }\r\n});\r\n\r\n// \u00E2\u0161\u00A0\u00EF\u00B8\u008F ANCIENNE ROUTE D\u00C3\u2030SACTIV\u00C3\u2030E - Utilise maintenant table-routes-new.ts\r\n// La nouvelle architecture normalis\u00C3\u00A9e g\u00C3\u00A8re POST /nodes/:nodeId/tables\r\n/*\r\n// Cr\u00C3\u00A9er une nouvelle instance de tableau\r\nrouter.post('/nodes/:nodeId/tables', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { name, description, type = 'basic', columns = [], rows = [], data = {}, meta = {} } = req.body;\r\n\r\n    console.log('========================================');\r\n    console.log('[TreeBranchLeaf API] \u00F0\u0178\u201C\u00A5 POST /nodes/:nodeId/tables RE\u00C3\u2021U');\r\n    console.log('[TreeBranchLeaf API] nodeId:', nodeId);\r\n    console.log('[TreeBranchLeaf API] name:', name);\r\n    console.log('[TreeBranchLeaf API] type:', type);\r\n    console.log('[TreeBranchLeaf API] \u00F0\u0178\u201C\u0160 DONN\u00C3\u2030ES RE\u00C3\u2021UES:');\r\n    console.log('[TreeBranchLeaf API] columns:', Array.isArray(columns) ? columns.length : typeof columns, columns);\r\n    console.log('[TreeBranchLeaf API] rows:', Array.isArray(rows) ? rows.length : typeof rows);\r\n    console.log('[TreeBranchLeaf API] rows (10 premi\u00C3\u00A8res):', Array.isArray(rows) ? rows.slice(0, 10) : 'N/A');\r\n    console.log('[TreeBranchLeaf API] rows (10 derni\u00C3\u00A8res):', Array.isArray(rows) ? rows.slice(-10) : 'N/A');\r\n    console.log('[TreeBranchLeaf API] data type:', typeof data, Array.isArray(data) ? `array[${data.length}]` : 'object');\r\n    if (Array.isArray(data)) {\r\n      console.log('[TreeBranchLeaf API] data[0]:', data[0]);\r\n      console.log('[TreeBranchLeaf API] data[derni\u00C3\u00A8re]:', data[data.length - 1]);\r\n    } else if (data && typeof data === 'object') {\r\n      console.log('[TreeBranchLeaf API] data keys:', Object.keys(data));\r\n      if (data.matrix) {\r\n        console.log('[TreeBranchLeaf API] data.matrix length:', data.matrix.length);\r\n      }\r\n    }\r\n    console.log('========================================');\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // V\u00C3\u00A9rifier que le nom n'existe pas d\u00C3\u00A9j\u00C3\u00A0\r\n    const existing = await prisma.treeBranchLeafNodeTable.findFirst({\r\n      where: { nodeId, name }\r\n    });\r\n\r\n    if (existing) {\r\n      console.log('[TreeBranchLeaf API] \u00E2\u009D\u0152 Tableau avec ce nom existe d\u00C3\u00A9j\u00C3\u00A0');\r\n      return res.status(400).json({ error: 'Un tableau avec ce nom existe d\u00C3\u00A9j\u00C3\u00A0' });\r\n    }\r\n\r\n    // D\u00C3\u00A9terminer l'ordre\r\n    const lastTable = await prisma.treeBranchLeafNodeTable.findFirst({\r\n      where: { nodeId },\r\n      orderBy: { order: 'desc' }\r\n    });\r\n    const order = (lastTable?.order || 0) + 1;\r\n\r\n    // G\u00C3\u00A9n\u00C3\u00A9rer un ID unique pour le tableau\r\n    const tableId = randomUUID();\r\n\r\n    console.log('[TreeBranchLeaf API] \u00F0\u0178\u2019\u00BE AVANT PRISMA.CREATE:');\r\n    console.log('[TreeBranchLeaf API] tableId:', tableId);\r\n    console.log('[TreeBranchLeaf API] columns \u00C3\u00A0 sauver:', Array.isArray(columns) ? columns.length : typeof columns);\r\n    console.log('[TreeBranchLeaf API] rows \u00C3\u00A0 sauver:', Array.isArray(rows) ? rows.length : typeof rows);\r\n    console.log('[TreeBranchLeaf API] data \u00C3\u00A0 sauver:', Array.isArray(data) ? `array[${data.length}]` : typeof data);\r\n    \r\n    // Calculer la taille approximative du JSON\r\n    const jsonSize = JSON.stringify({ columns, rows, data }).length;\r\n    console.log('[TreeBranchLeaf API] \u00F0\u0178\u201C\u008F Taille JSON totale:', jsonSize, 'caract\u00C3\u00A8res (' + Math.round(jsonSize / 1024) + ' KB)');\r\n    \r\n    if (jsonSize > 10 * 1024 * 1024) {\r\n      console.log('[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F ATTENTION: Taille > 10MB, risque de probl\u00C3\u00A8me PostgreSQL');\r\n    }\r\n\r\n    // \u00F0\u0178\u2014\u0153\u00EF\u00B8\u008F Compresser les donn\u00C3\u00A9es volumineuses avant sauvegarde\r\n    const compressedColumns = compressIfNeeded(columns);\r\n    const compressedRows = compressIfNeeded(rows);\r\n    const compressedData = compressIfNeeded(data);\r\n    \r\n    console.log('[TreeBranchLeaf API] \u00F0\u0178\u2019\u00BE Donn\u00C3\u00A9es apr\u00C3\u00A8s compression:');\r\n    console.log('[TreeBranchLeaf API] columns compress\u00C3\u00A9:', typeof compressedColumns === 'object' && (compressedColumns as any)._compressed ? 'OUI' : 'NON');\r\n    console.log('[TreeBranchLeaf API] rows compress\u00C3\u00A9:', typeof compressedRows === 'object' && (compressedRows as any)._compressed ? 'OUI' : 'NON');\r\n    console.log('[TreeBranchLeaf API] data compress\u00C3\u00A9:', typeof compressedData === 'object' && (compressedData as any)._compressed ? 'OUI' : 'NON');\r\n\r\n    const newTable = await prisma.treeBranchLeafNodeTable.create({\r\n      data: {\r\n        id: tableId,\r\n        nodeId,\r\n        organizationId,\r\n        name,\r\n        description,\r\n        type,\r\n        columns: compressedColumns,\r\n        rows: compressedRows,\r\n        data: compressedData,\r\n        meta,\r\n        order,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log('[TreeBranchLeaf API] \u00E2\u0153\u2026 PRISMA.CREATE TERMIN\u00C3\u2030');\r\n    console.log('[TreeBranchLeaf API] Tableau cr\u00C3\u00A9\u00C3\u00A9 ID:', newTable.id);\r\n    console.log('[TreeBranchLeaf API] Colonnes sauv\u00C3\u00A9es:', Array.isArray(newTable.columns) ? newTable.columns.length : typeof newTable.columns);\r\n    console.log('[TreeBranchLeaf API] Rows sauv\u00C3\u00A9es:', Array.isArray(newTable.rows) ? newTable.rows.length : typeof newTable.rows);\r\n    console.log('[TreeBranchLeaf API] Data sauv\u00C3\u00A9es:', Array.isArray(newTable.data) ? newTable.data.length : typeof newTable.data);\r\n\r\n    await syncNodeTableCapability(nodeId);\r\n\r\n    const normalized = normalizeTableInstance(newTable);\r\n\r\n    console.log('[TreeBranchLeaf API] \u00F0\u0178\u201D\u201E APR\u00C3\u02C6S NORMALISATION:');\r\n    console.log('[TreeBranchLeaf API] normalized.columns:', normalized.columns?.length);\r\n    console.log('[TreeBranchLeaf API] normalized.rows:', normalized.rows?.length);\r\n    console.log('[TreeBranchLeaf API] normalized.matrix:', normalized.matrix?.length);\r\n    console.log('========================================');\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Created table ${newTable.id} for node ${nodeId}`);\r\n    return res.status(201).json(normalized);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error creating node table:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00C3\u00A9ation du tableau' });\r\n  }\r\n});\r\n*/\r\n// FIN DE L'ANCIENNE ROUTE - Utilise table-routes-new.ts maintenant\r\n\r\n// \u00E2\u0161\u00A0\u00EF\u00B8\u008F ANCIENNE ROUTE PUT D\u00C3\u2030SACTIV\u00C3\u2030E - Utilise maintenant table-routes-new.ts\r\n// Cette route utilisait les anciens champs columns/rows/data qui n'existent plus dans le sch\u00C3\u00A9ma normalis\u00C3\u00A9\r\n/*\r\nrouter.put('/nodes/:nodeId/tables/:tableId', async (req, res) => {\r\n  try {\r\n    const { nodeId, tableId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { name, description, type, columns, rows, data, meta } = req.body;\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    // V\u00C3\u00A9rifier que le tableau appartient bien \u00C3\u00A0 ce n\u00C5\u201Cud\r\n    const existingTable = await prisma.treeBranchLeafNodeTable.findFirst({\r\n      where: { id: tableId, nodeId }\r\n    });\r\n\r\n    if (!existingTable) {\r\n      return res.status(404).json({ error: 'Tableau non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'unicit\u00C3\u00A9 du nom si chang\u00C3\u00A9\r\n    if (name && name !== existingTable.name) {\r\n      const nameConflict = await prisma.treeBranchLeafNodeTable.findFirst({\r\n        where: { nodeId, name, id: { not: tableId } }\r\n      });\r\n\r\n      if (nameConflict) {\r\n        return res.status(400).json({ error: 'Un tableau avec ce nom existe d\u00C3\u00A9j\u00C3\u00A0' });\r\n      }\r\n    }\r\n\r\n    // \u00F0\u0178\u2014\u0153\u00EF\u00B8\u008F Compresser les donn\u00C3\u00A9es volumineuses si fournies\r\n    const updateData: any = {\r\n      ...(name !== undefined && { name }),\r\n      ...(description !== undefined && { description }),\r\n      ...(type !== undefined && { type }),\r\n      ...(columns !== undefined && { columns: compressIfNeeded(columns) }),\r\n      ...(rows !== undefined && { rows: compressIfNeeded(rows) }),\r\n      ...(data !== undefined && { data: compressIfNeeded(data) }),\r\n      ...(meta !== undefined && { meta }),\r\n      updatedAt: new Date()\r\n    };\r\n\r\n    const updatedTable = await prisma.treeBranchLeafNodeTable.update({\r\n      where: { id: tableId },\r\n      data: updateData\r\n    });\r\n\r\n    await syncNodeTableCapability(nodeId);\r\n\r\n    console.log(`[TreeBranchLeaf API] Updated table ${tableId} for node ${nodeId}`);\r\n    return res.json(normalizeTableInstance(updatedTable));\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating node table:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour du tableau' });\r\n  }\r\n});\r\n*/\r\n// FIN DE L'ANCIENNE ROUTE PUT\r\n\r\n// Supprimer une instance de tableau\r\nrouter.delete('/nodes/:nodeId/tables/:tableId', async (req, res) => {\r\n  const { tableId } = req.params;\r\n  console.log(`[DELETE /nodes/:nodeId/tables/:tableId] \uD83D\uDDD1\uFE0F Suppression table ${tableId} avec nettoyage complet`);\r\n  \r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // 1\uFE0F\u20E3 V\u00E9rifier l'existence et les permissions\r\n    const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id: tableId },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          include: { TreeBranchLeafTree: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!table) {\r\n      return res.status(404).json({ error: 'Table non trouv\u00E9e' });\r\n    }\r\n\r\n    const tableOrgId = table.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9' });\r\n    }\r\n\r\n    // 2\uFE0F\u20E3 Supprimer la table (colonnes et lignes supprim\u00E9es en cascade par Prisma)\r\n    await prisma.treeBranchLeafNodeTable.delete({ where: { id: tableId } });\r\n    console.log(`[DELETE Table] \u2705 Table ${tableId} supprim\u00E9e (+ colonnes/lignes en cascade)`);\r\n\r\n    // \uD83D\uDD0D Nettoyer les champs Select/Cascader qui utilisent cette table comme lookup\r\n    // \uD83D\uDCA1 UTILISER LA M\u00CAME LOGIQUE QUE LE BOUTON \"D\u00C9SACTIVER LOOKUP\" QUI FONCTIONNE PARFAITEMENT\r\n    try {\r\n      const selectConfigsUsingTable = await prisma.treeBranchLeafSelectConfig.findMany({\r\n        where: { tableReference: tableId },\r\n        select: { nodeId: true }\r\n      });\r\n\r\n      if (selectConfigsUsingTable.length > 0) {\r\n        console.log(`[DELETE Table] \uD83E\uDDF9 ${selectConfigsUsingTable.length} champ(s) Select/Cascader r\u00E9f\u00E9rencent cette table - D\u00C9SACTIVATION LOOKUP`);\r\n        \r\n        // Pour chaque champ, appliquer la M\u00CAME logique que le bouton \"D\u00E9sactiver lookup\"\r\n        for (const config of selectConfigsUsingTable) {\r\n          const selectNode = await prisma.treeBranchLeafNode.findUnique({\r\n            where: { id: config.nodeId },\r\n            select: { \r\n              label: true,\r\n              metadata: true\r\n            }\r\n          });\r\n\r\n          if (selectNode) {\r\n            console.log(`[DELETE Table] \uD83D\uDD27 D\u00E9sactivation lookup pour \"${selectNode.label}\" (${config.nodeId})`);\r\n            \r\n            // 1\uFE0F\u20E3 Nettoyer metadata.capabilities.table (comme le fait le bouton D\u00E9sactiver)\r\n            const oldMetadata = (selectNode.metadata || {}) as Record<string, unknown>;\r\n            const oldCapabilities = (oldMetadata.capabilities || {}) as Record<string, unknown>;\r\n            const newCapabilities = {\r\n              ...oldCapabilities,\r\n              table: {\r\n                enabled: false,\r\n                activeId: null,\r\n                instances: null,\r\n                currentTable: null,\r\n              }\r\n            };\r\n            const newMetadata = {\r\n              ...oldMetadata,\r\n              capabilities: newCapabilities\r\n            };\r\n\r\n            // 2\uFE0F\u20E3 Mettre \u00E0 jour le n\u0153ud (m\u00EAme logique que PUT /capabilities/table avec enabled: false)\r\n            await prisma.treeBranchLeafNode.update({\r\n              where: { id: config.nodeId },\r\n              data: {\r\n                hasTable: false,\r\n                table_activeId: null,\r\n                table_instances: null,\r\n                table_name: null,\r\n                table_type: null,\r\n                table_meta: null,\r\n                table_columns: null,\r\n                table_rows: null,\r\n                table_data: null,\r\n                metadata: JSON.parse(JSON.stringify(newMetadata)),\r\n                select_options: [],\r\n                updatedAt: new Date()\r\n              }\r\n            });\r\n\r\n            // 3\uFE0F\u20E3 Supprimer la configuration SELECT (comme le fait le bouton D\u00E9sactiver)\r\n            await prisma.treeBranchLeafSelectConfig.deleteMany({\r\n              where: { nodeId: config.nodeId }\r\n            });\r\n            \r\n            console.log(`[DELETE Table] \u2705 Lookup d\u00E9sactiv\u00E9 pour \"${selectNode.label}\" - champ d\u00E9bloqu\u00E9`);\r\n          }\r\n        }\r\n\r\n        console.log(`[DELETE Table] \u2705 ${selectConfigsUsingTable.length} champ(s) Select D\u00C9BLOQU\u00C9S (lookup d\u00E9sactiv\u00E9)`);\r\n      }\r\n    } catch (selectConfigError) {\r\n      console.error(`[DELETE Table] \u26A0\uFE0F Erreur d\u00E9sactivation lookups:`, selectConfigError);\r\n      // On continue quand m\u00EAme\r\n    }\r\n\r\n    // 3\uFE0F\u20E3 Nettoyer TOUS les champs li\u00E9s aux tables dans le n\u0153ud\r\n    if (table.nodeId) {\r\n      const node = await prisma.treeBranchLeafNode.findUnique({ \r\n        where: { id: table.nodeId }, \r\n        select: { \r\n          linkedTableIds: true,\r\n          table_activeId: true,\r\n          table_instances: true\r\n        } \r\n      });\r\n\r\n      const currentLinkedIds = node?.linkedTableIds ?? [];\r\n      const nextLinkedIds = currentLinkedIds.filter(x => x !== tableId);\r\n      const wasActiveTable = node?.table_activeId === tableId;\r\n      \r\n      let cleanedInstances = node?.table_instances ?? {};\r\n      if (typeof cleanedInstances === 'object' && cleanedInstances !== null) {\r\n        const instances = cleanedInstances as Record<string, unknown>;\r\n        if (instances[tableId]) {\r\n          delete instances[tableId];\r\n          cleanedInstances = instances;\r\n        }\r\n      }\r\n\r\n      const remainingTables = await prisma.treeBranchLeafNodeTable.count({\r\n        where: { nodeId: table.nodeId }\r\n      });\r\n\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: table.nodeId },\r\n        data: {\r\n          hasTable: remainingTables > 0,\r\n          linkedTableIds: { set: nextLinkedIds },\r\n          table_activeId: wasActiveTable ? null : undefined,\r\n          table_instances: cleanedInstances,\r\n          ...(remainingTables === 0 && {\r\n            table_name: null,\r\n            table_type: null,\r\n            table_meta: null,\r\n            table_columns: null,\r\n            table_rows: null,\r\n            table_data: null,\r\n            table_importSource: null,\r\n            table_isImported: false\r\n          })\r\n        }\r\n      });\r\n\r\n      console.log(`[DELETE Table] \u2705 N\u0153ud ${table.nodeId} enti\u00E8rement nettoy\u00E9`, {\r\n        hasTable: remainingTables > 0,\r\n        linkedTableIds: nextLinkedIds.length,\r\n        table_activeId_reset: wasActiveTable,\r\n        table_instances_cleaned: true,\r\n        all_fields_reset: remainingTables === 0\r\n      });\r\n    }\r\n\r\n    return res.json({ success: true, message: 'Tableau supprim\u00E9 avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('[DELETE Table] \u274C Erreur lors de la suppression:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression du tableau' });\r\n  }\r\n});\r\n\r\nrouter.get('/nodes/:nodeId/tables/options', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { tableId, dimension = 'columns' } = req.query as {\r\n      tableId?: string;\r\n      dimension?: string;\r\n    };\r\n\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    const normalized = await fetchNormalizedTable(nodeId, {\r\n      tableId: typeof tableId === 'string' && tableId ? tableId : undefined,\r\n    });\r\n\r\n    if (!normalized) {\r\n      return res.json({ items: [], table: null });\r\n    }\r\n\r\n    const { table, tables } = normalized;\r\n\r\n    if (dimension === 'rows') {\r\n      const items = table.rows.map((label, index) => ({ value: label, label, index }));\r\n      return res.json({ items, table: { id: table.id, type: table.type, name: table.name }, tables });\r\n    }\r\n\r\n    if (dimension === 'records') {\r\n      return res.json({\r\n        items: table.records,\r\n        table: { id: table.id, type: table.type, name: table.name },\r\n        tables,\r\n      });\r\n    }\r\n\r\n    // Par d\u00C3\u00A9faut: colonnes\r\n    const items = table.columns.map((label, index) => ({ value: label, label, index }));\r\n    return res.json({ items, table: { id: table.id, type: table.type, name: table.name }, tables });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching table options:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des options du tableau' });\r\n  }\r\n});\r\n\r\n// Lookup dynamique dans une instance de tableau\r\nrouter.get('/nodes/:nodeId/tables/lookup', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const {\r\n      tableId,\r\n      column,\r\n      row,\r\n      key,\r\n      keyColumn,\r\n      keyValue,\r\n      valueColumn,\r\n    } = req.query as Record<string, string | undefined>;\r\n\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    const normalized = await fetchNormalizedTable(nodeId, {\r\n      tableId: tableId && tableId.length ? tableId : undefined,\r\n    });\r\n\r\n    if (!normalized) {\r\n      return res.status(404).json({ error: 'Aucun tableau disponible pour ce n\u00C5\u201Cud' });\r\n    }\r\n\r\n    const { table } = normalized;\r\n    const rawLookup = (table.meta && typeof table.meta.lookup === 'object')\r\n      ? (table.meta.lookup as Record<string, unknown>)\r\n      : undefined;\r\n\r\n    if (table.type === 'matrix') {\r\n      const colLabel = column || (valueColumn && valueColumn === 'column' ? valueColumn : undefined);\r\n      const rowLabel = row;\r\n\r\n      if (!colLabel || !rowLabel) {\r\n        return res.status(400).json({ error: 'Param\u00C3\u00A8tres column et row requis pour un tableau crois\u00C3\u00A9' });\r\n      }\r\n\r\n      const columnIndex = table.columns.findIndex((c) => c === colLabel);\r\n      const rowIndex = table.rows.findIndex((r) => r === rowLabel);\r\n\r\n      if (columnIndex === -1) {\r\n        return res.status(404).json({ error: `Colonne \"${colLabel}\" introuvable` });\r\n      }\r\n      if (rowIndex === -1) {\r\n        return res.status(404).json({ error: `Ligne \"${rowLabel}\" introuvable` });\r\n      }\r\n\r\n      const value = table.matrix[rowIndex]?.[columnIndex] ?? null;\r\n\r\n      return res.json({\r\n        value,\r\n        rowIndex,\r\n        columnIndex,\r\n        column: table.columns[columnIndex],\r\n        row: table.rows[rowIndex],\r\n        table: { id: table.id, name: table.name, type: table.type },\r\n        meta: table.meta,\r\n      });\r\n    }\r\n\r\n    const resolvedKeyColumn =\r\n      (keyColumn && keyColumn.length ? keyColumn : undefined) ??\r\n      (rawLookup && typeof rawLookup.keyColumn === 'string' ? (rawLookup.keyColumn as string) : undefined);\r\n\r\n    if (!resolvedKeyColumn) {\r\n      return res.status(400).json({ error: 'Colonne cl\u00C3\u00A9 non d\u00C3\u00A9finie pour ce tableau' });\r\n    }\r\n\r\n    const lookupValue =\r\n      (keyValue && keyValue.length ? keyValue : undefined) ??\r\n      (key && key.length ? key : undefined) ??\r\n      (column && !table.columns.includes(column) ? column : undefined);\r\n\r\n    if (lookupValue === undefined) {\r\n      return res.status(400).json({ error: 'Valeur de cl\u00C3\u00A9 requise' });\r\n    }\r\n\r\n    const keyIndex = table.columns.findIndex((colName) => colName === resolvedKeyColumn);\r\n    if (keyIndex === -1) {\r\n      return res.status(404).json({ error: `Colonne cl\u00C3\u00A9 \"${resolvedKeyColumn}\" introuvable` });\r\n    }\r\n\r\n    let matchedIndex = -1;\r\n    for (let i = 0; i < table.matrix.length; i += 1) {\r\n      const current = table.matrix[i]?.[keyIndex];\r\n      if (current != null && String(current) === String(lookupValue)) {\r\n        matchedIndex = i;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (matchedIndex === -1) {\r\n      return res.status(404).json({ error: 'Aucune ligne correspondant \u00C3\u00A0 cette cl\u00C3\u00A9' });\r\n    }\r\n\r\n    const matchedRow = table.matrix[matchedIndex] ?? [];\r\n    const matchedRecord = table.records[matchedIndex] ?? null;\r\n\r\n    const resolvedValueColumn =\r\n      (valueColumn && valueColumn.length ? valueColumn : undefined) ??\r\n      (rawLookup && typeof rawLookup.valueColumn === 'string' ? (rawLookup.valueColumn as string) : undefined);\r\n\r\n    let resolvedValue: unknown = matchedRecord;\r\n\r\n    if (resolvedValueColumn) {\r\n      const valueIdx = table.columns.findIndex((colName) => colName === resolvedValueColumn);\r\n      if (valueIdx === -1) {\r\n        return res.status(404).json({ error: `Colonne \"${resolvedValueColumn}\" introuvable` });\r\n      }\r\n      resolvedValue = matchedRow[valueIdx] ?? null;\r\n    }\r\n\r\n    const exposeColumns = Array.isArray(rawLookup?.exposeColumns)\r\n      ? (rawLookup?.exposeColumns as Array<Record<string, unknown>>)\r\n      : [];\r\n\r\n    return res.json({\r\n      value: resolvedValue ?? null,\r\n      row: matchedRecord,\r\n      rowIndex: matchedIndex,\r\n      keyColumn: resolvedKeyColumn,\r\n      keyValue: lookupValue,\r\n      table: { id: table.id, name: table.name, type: table.type },\r\n      meta: table.meta,\r\n      exposeColumns,\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error performing table lookup:', error);\r\n    res.status(500).json({ error: 'Erreur lors du lookup dans le tableau' });\r\n  }\r\n});\r\n\r\n// G\u00C3\u00A9n\u00C3\u00A9rer automatiquement des champs SELECT d\u00C3\u00A9pendants d'un tableau\r\nrouter.post('/nodes/:nodeId/table/generate-selects', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const {\r\n      tableId: requestedTableId,\r\n      labelColumns,\r\n      labelRows,\r\n    } = (req.body || {}) as {\r\n      tableId?: string;\r\n      labelColumns?: string;\r\n      labelRows?: string;\r\n    };\r\n\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) return res.status(access.status).json({ error: access.error });\r\n\r\n    const normalized = await fetchNormalizedTable(nodeId, {\r\n      tableId:\r\n        typeof requestedTableId === 'string' && requestedTableId.trim().length\r\n          ? requestedTableId.trim()\r\n          : undefined,\r\n    });\r\n\r\n    if (!normalized) {\r\n      return res.status(404).json({ error: 'Aucun tableau disponible pour ce n\u00C5\u201Cud' });\r\n    }\r\n\r\n    const { table } = normalized;\r\n\r\n    if (!table.columns.length) {\r\n      return res.status(400).json({ error: 'Le tableau ne contient aucune colonne exploitable' });\r\n    }\r\n\r\n    const baseNode = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      select: { id: true, treeId: true, parentId: true },\r\n    });\r\n\r\n    if (!baseNode) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud de base introuvable' });\r\n    }\r\n\r\n    const parentId = baseNode.parentId ?? null;\r\n    const siblingsCount = await prisma.treeBranchLeafNode.count({\r\n      where: { treeId: baseNode.treeId, parentId },\r\n    });\r\n\r\n    const tableMeta = table.meta || {};\r\n    const metaNameRaw = typeof tableMeta['name'] === 'string' ? (tableMeta['name'] as string) : undefined;\r\n    const baseLabel = (metaNameRaw && metaNameRaw.trim()) || (table.name && table.name.trim()) || 'Tableau';\r\n\r\n    const fallbackColumnsLabel = typeof labelColumns === 'string' && labelColumns.trim().length\r\n      ? labelColumns.trim()\r\n      : `${baseLabel} - colonne`;\r\n    const fallbackRowsLabel = typeof labelRows === 'string' && labelRows.trim().length\r\n      ? labelRows.trim()\r\n      : `${baseLabel} - ligne`;\r\n\r\n    const toCreate: Array<{ label: string; dimension: 'columns' | 'rows' }> = [];\r\n\r\n    if (table.columns.length) {\r\n      toCreate.push({ label: fallbackColumnsLabel, dimension: 'columns' });\r\n    }\r\n\r\n    if (table.rows.length) {\r\n      toCreate.push({ label: fallbackRowsLabel, dimension: 'rows' });\r\n    }\r\n\r\n    if (!toCreate.length) {\r\n      return res.status(400).json({ error: 'Aucune dimension exploitable pour g\u00C3\u00A9n\u00C3\u00A9rer des champs SELECT' });\r\n    }\r\n\r\n    const created: Array<{ id: string; label: string; dimension: 'columns' | 'rows' }> = [];\r\n    let insertOrder = siblingsCount;\r\n    const now = new Date();\r\n\r\n    for (const item of toCreate) {\r\n      const newNodeId = randomUUID();\r\n\r\n      const nodeMetadata = {\r\n        generatedFrom: 'table_lookup',\r\n        tableNodeId: baseNode.id,\r\n        tableId: table.id,\r\n        tableDimension: item.dimension,\r\n      } as Record<string, unknown>;\r\n\r\n      const newNode = await prisma.treeBranchLeafNode.create({\r\n        data: {\r\n          id: newNodeId,\r\n          treeId: baseNode.treeId,\r\n          parentId,\r\n          type: 'leaf_select',\r\n          subType: 'SELECT',\r\n          fieldType: 'SELECT',\r\n          fieldSubType: 'SELECT',\r\n          label: item.label,\r\n          order: insertOrder,\r\n          isVisible: true,\r\n          isActive: true,\r\n          hasData: false,\r\n          hasFormula: false,\r\n          hasCondition: false,\r\n          hasTable: false,\r\n          hasAPI: false,\r\n          hasLink: false,\r\n          hasMarkers: false,\r\n          select_allowClear: true,\r\n          select_defaultValue: null,\r\n          select_multiple: false,\r\n          select_options: [] as Prisma.InputJsonValue,\r\n          select_searchable: false,\r\n          metadata: nodeMetadata as Prisma.InputJsonValue,\r\n          tbl_auto_generated: true,\r\n          updatedAt: now,\r\n        },\r\n      });\r\n\r\n      await prisma.treeBranchLeafSelectConfig.create({\r\n        data: {\r\n          id: randomUUID(),\r\n          nodeId: newNode.id,\r\n          options: [] as Prisma.InputJsonValue,\r\n          multiple: false,\r\n          searchable: false,\r\n          allowCustom: false,\r\n          optionsSource: `table_${item.dimension}`,\r\n          tableReference: `node-table:${table.id}`,\r\n          dependsOnNodeId: baseNode.id,\r\n          createdAt: now,\r\n          updatedAt: now,\r\n        },\r\n      });\r\n\r\n      created.push({ id: newNode.id, label: newNode.label, dimension: item.dimension });\r\n      insertOrder += 1;\r\n    }\r\n\r\n    return res.json({\r\n      created,\r\n      table: { id: table.id, name: table.name, type: table.type },\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error generating selects from table:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la g\u00C3\u00A9n\u00C3\u00A9ration des champs d\u00C3\u00A9pendants' });\r\n  }\r\n});\r\n\r\n// -------------------------------------------------------------\r\n// \u00E2\u0153\u2026 Endpoint valeurs effectives (prise en compte override manuel)\r\n// GET /api/treebranchleaf/effective-values?ids=a,b,c\r\nrouter.get('/effective-values', async (req, res) => {\r\n  try {\r\n    const idsParam = String(req.query.ids || '').trim();\r\n    if (!idsParam) return res.json({ success: true, data: {} });\r\n    const ids = idsParam.split(',').map(s => s.trim()).filter(Boolean);\r\n    if (!ids.length) return res.json({ success: true, data: {} });\r\n\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({ \r\n      where: { id: { in: ids } }, \r\n      include: { TreeBranchLeafNodeVariable: true } \r\n    });\r\n\r\n    const result: Record<string, { value: number | string | null; source: string; manualApplied: boolean }> = {};\r\n    for (const node of nodes) {\r\n      result[node.id] = {\r\n        value: null,\r\n        source: 'not_implemented',\r\n        manualApplied: false\r\n      };\r\n    }\r\n\r\n    return res.json({ success: true, data: result });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting effective values:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des valeurs effectives' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00AA FORMULA ENGINE DEBUG - Endpoints de d\u00C3\u00A9bogage\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/debug/formula-vars\r\n// Liste toutes les variables de formule pour d\u00C3\u00A9bogage\r\nrouter.get('/debug/formula-vars', async (req, res) => {\r\n  try {\r\n    const vars = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      include: {\r\n        node: {\r\n          select: {\r\n            id: true,\r\n            label: true,\r\n            treeId: true,\r\n            organizationId: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        updatedAt: 'desc'\r\n      }\r\n    });\r\n\r\n    return res.json(vars);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching formula variables:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des variables de formule' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/debug/formula-eval\r\n// \u00C3\u2030value une formule sp\u00C3\u00A9cifique (pour d\u00C3\u00A9bogage)\r\nrouter.get('/debug/formula-eval', async (req, res) => {\r\n  try {\r\n    const { formulaId, nodeId } = req.query;\r\n\r\n    if (typeof formulaId !== 'string' || typeof nodeId !== 'string') {\r\n      return res.status(400).json({ error: 'formulaId et nodeId requis' });\r\n    }\r\n\r\n    const formula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n      where: { id: formulaId as string }\r\n    });\r\n\r\n    if (!formula) {\r\n      return res.status(404).json({ error: 'Formule non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // Simuler des fieldValues basiques pour l'\u00C3\u00A9valuation\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId as string },\r\n      include: { TreeBranchLeafNodeVariable: true }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    const fieldValues: Record<string, unknown> = {\r\n      ...node.TreeBranchLeafNodeVariable?.reduce((acc, v) => {\r\n        if (v.exposedKey) {\r\n          acc[v.exposedKey] = v.fixedValue || null;\r\n        }\r\n        return acc;\r\n      }, {} as Record<string, unknown>),\r\n      // Ajouter des valeurs de test suppl\u00C3\u00A9mentaires si n\u00C3\u00A9cessaire\r\n    };\r\n\r\n    console.log('\u00F0\u0178\u00A7\u00AA [DEBUG] \u00C3\u2030valuation de la formule avec les fieldValues suivants:', fieldValues);\r\n\r\n    // \u00C3\u2030valuer la formule\r\n    const { value, errors } = await evalFormulaTokens(formula.tokens as unknown as FormulaToken[], {\r\n      resolveVariable: async (nodeId: string) => {\r\n        const found = Object.values(fieldValues).find(v => v.nodeId === nodeId);\r\n        return found ? found.value : 0;\r\n      },\r\n      divisionByZeroValue: 0\r\n    });\r\n\r\n    return res.json({ value, errors });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error evaluating formula in debug:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'\u00C3\u00A9valuation de la formule en mode d\u00C3\u00A9bogage' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201C\u02C6 FORMULA VERSION - Version des formules (pour cache frontend)\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/formulas-version\r\n// Retourne une version/timestamp pour permettre au frontend de g\u00C3\u00A9rer le cache\r\nrouter.get('/formulas-version', async (req, res) => {\r\n  try {\r\n    res.setHeader('X-TBL-Legacy-Deprecated', 'true');\r\n    if (process.env.NODE_ENV !== 'production') {\r\n      console.warn('[TBL LEGACY] /api/treebranchleaf/formulas-version appel\u00C3\u00A9 (d\u00C3\u00A9pr\u00C3\u00A9ci\u00C3\u00A9). Utiliser /api/tbl/evaluate avec futur cache d\u00C3\u00A9pendances.');\r\n    }\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    \r\n    // Pour maintenant, retourner un timestamp simple\r\n    const version = {\r\n      version: Date.now(),\r\n      timestamp: new Date().toISOString(),\r\n      organizationId: organizationId || null,\r\n      isSuperAdmin: Boolean(isSuperAdmin)\r\n    };\r\n    \r\n    console.log('[TreeBranchLeaf API] Formulas version requested:', version);\r\n    return res.json(version);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting formulas version:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la version des formules' });\r\n  }\r\n});\r\n\r\nrouter.post('/formulas/validate', (req, res) => {\r\n  try {\r\n    const { expression, rolesMap } = req.body ?? {};\r\n    if (typeof expression !== 'string' || !expression.trim()) {\r\n      return res.status(400).json({ error: 'expression_required' });\r\n    }\r\n    const tokens = parseExpression(expression, createRolesProxy(rolesMap), { enableCache: false });\r\n    const rpn = toRPN(tokens);\r\n    return res.json({\r\n      tokens,\r\n      rpn,\r\n      complexity: tokens.length\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error validating formula:', error);\r\n    return res.status(400).json({\r\n      error: 'Parse error',\r\n      details: error instanceof Error ? error.message : String(error)\r\n    });\r\n  }\r\n});\r\n\r\nrouter.get('/logic/version', (_req, res) => {\r\n  const payload = computeLogicVersion();\r\n  return res.json(payload);\r\n});\r\n\r\nrouter.post('/formulas/cache/clear', (_req, res) => {\r\n  clearRpnCache();\r\n  const stats = getRpnCacheStats();\r\n  return res.json({ cleared: true, stats });\r\n});\r\n\r\nrouter.post('/nodes/:nodeId/table/evaluate', (req, res) => {\r\n  // Fallback minimal implementation to ensure JSON response during integration tests.\r\n  // Permissions would normally apply upstream; we respond with a structured 404 so the\r\n  // caller never falls back to the SPA HTML payload.\r\n  return res.status(404).json({ error: 'node_not_found', nodeId: req.params.nodeId });\r\n});\r\n\r\nrouter.post('/evaluate/formula', async (req, res) => {\r\n  try {\r\n    const { expr, rolesMap, values, options } = req.body ?? {};\r\n    if (typeof expr !== 'string' || !expr.trim()) {\r\n      return res.status(400).json({ error: 'expr_required' });\r\n    }\r\n\r\n    const strict = Boolean(options?.strict);\r\n    const enableCache = options?.enableCache !== undefined ? Boolean(options.enableCache) : true;\r\n    const divisionByZeroValue = typeof options?.divisionByZeroValue === 'number' ? options.divisionByZeroValue : 0;\r\n    const precisionScale = typeof options?.precisionScale === 'number' ? options.precisionScale : undefined;\r\n    const valueStore = (values && typeof values === 'object') ? (values as Record<string, unknown>) : {};\r\n\r\n    const evaluation = await evaluateExpression(expr, createRolesProxy(rolesMap), {\r\n      resolveVariable: (nodeId) => coerceToNumber(valueStore[nodeId] ?? valueStore[nodeId.toLowerCase()]),\r\n      strictVariables: strict,\r\n      enableCache,\r\n      divisionByZeroValue,\r\n      precisionScale\r\n    });\r\n\r\n    const stats = getRpnCacheStats();\r\n    const metrics = getLogicMetrics();\r\n\r\n    return res.json({\r\n      value: evaluation.value,\r\n      errors: evaluation.errors,\r\n      stats,\r\n      metrics\r\n    });\r\n  } catch (error) {\r\n    if (error instanceof Error) {\r\n      return res.status(400).json({ error: 'Parse error', details: error.message });\r\n    }\r\n    console.error('[TreeBranchLeaf API] Error evaluating inline formula:', error);\r\n    return res.status(500).json({ error: 'Erreur \u00C3\u00A9valuation inline' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u00A7\u00AE FORMULA EVALUATION - \u00C3\u2030valuation de formules\r\n// =============================================================================\r\n\r\n// POST /api/treebranchleaf/evaluate/formula/:formulaId\r\n// \u00C3\u2030value une formule sp\u00C3\u00A9cifique et retourne le r\u00C3\u00A9sultat calcul\u00C3\u00A9\r\nrouter.post('/evaluate/formula/:formulaId', async (req, res) => {\r\n  try {\r\n    res.setHeader('X-TBL-Legacy-Deprecated', 'true');\r\n    if (process.env.NODE_ENV !== 'production') {\r\n      console.warn('[TBL LEGACY] /api/treebranchleaf/evaluate/formula/:id appel\u00C3\u00A9 (d\u00C3\u00A9pr\u00C3\u00A9ci\u00C3\u00A9). Utiliser POST /api/tbl/evaluate elementId=<exposedKey>.');\r\n    }\r\n    const { formulaId } = req.params;\r\n    const { fieldValues = {}, testMode = true } = req.body;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE \u00C3\u2030valuation formule ${formulaId}:`, { fieldValues, testMode });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la formule\r\n    const formula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n      where: { id: formulaId },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: { organizationId: true }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!formula) {\r\n      return res.status(404).json({ error: 'Formule non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s organisation\r\n    const nodeOrg = formula.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && nodeOrg && nodeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette formule' });\r\n    }\r\n\r\n    // \u00C3\u2030valuer la formule avec le moteur d'expressions\r\n    try {\r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE \u00C3\u2030VALUATION FORMULE ULTRA-D\u00C3\u2030TAILL\u00C3\u2030E:`, {\r\n        formulaId: formula.id,\r\n        formulaName: formula.name,\r\n        tokens: formula.tokens,\r\n        fieldValues: fieldValues\r\n      });\r\n      \r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D FIELDVALUES RE\u00C3\u2021UES:`, Object.entries(fieldValues));\r\n\r\n      // \u00F0\u0178\u017D\u00AF DEBUG G\u00C3\u2030N\u00C3\u2030RIQUE pour toutes les formules (sans ID hardcod\u00C3\u00A9)\r\n      const isDebugMode = process.env.NODE_ENV === 'development';\r\n      if (isDebugMode && formula) {\r\n        console.log(`[TreeBranchLeaf API] \u00EF\u00BF\u00BD === FORMULE EN COURS D'ANALYSE ===`);\r\n        console.log(`[TreeBranchLeaf API] \u00EF\u00BF\u00BD ID:`, formula.id);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D Expression:`, formula.expression || 'undefined');\r\n        console.log(`[TreeBranchLeaf API] \u00EF\u00BF\u00BD Tokens BRUTS:`, JSON.stringify(formula.tokens, null, 2));\r\n        \r\n        if (Array.isArray(formula.tokens)) {\r\n          formula.tokens.forEach((token, index) => {\r\n            console.log(`[TreeBranchLeaf API] \u00EF\u00BF\u00BD Token ${index}:`, {\r\n              type: token.type,\r\n              value: token.value,\r\n              name: token.name,\r\n              variableId: (token as { variableId?: string }).variableId,\r\n              allProps: Object.keys(token)\r\n            });\r\n          });\r\n        }\r\n        \r\n        console.log(`[TreeBranchLeaf API] \u00EF\u00BF\u00BD FieldValues pour cette formule:`);\r\n        Object.entries(fieldValues).forEach(([k, v]) => {\r\n          console.log(`[TreeBranchLeaf API] \u00EF\u00BF\u00BD   ${k}: \"${v}\" (${typeof v})`);\r\n        });\r\n      }\r\n\r\n      // Types pour les tokens de formule\r\n      interface FormulaToken {\r\n        type: 'value' | 'variable' | 'operator' | 'lparen' | 'rparen';\r\n        value?: string | number;\r\n        name?: string;\r\n      }\r\n\r\n      // Tokens de la formule (nouveau format)\r\n      const tokens = Array.isArray(formula.tokens) ? formula.tokens as FormulaToken[] : [];\r\n      \r\n      // Extraire les variables des tokens\r\n      const tokenVariables = tokens\r\n        .filter((t): t is FormulaToken => Boolean(t) && t.type === 'variable')\r\n        .map((t) => t.name)\r\n        .filter(Boolean) as string[];\r\n\r\n      console.log('[TreeBranchLeaf API] Variables dans les tokens:', tokenVariables);\r\n\r\n      // \u00F0\u0178\u00A7\u00A0 NOUVEL ORCHESTRATEUR \u00E2\u20AC\u201C remplace l'ancienne r\u00C3\u00A9solution ad-hoc\r\n      // Expression brute \u00C3\u00A9ventuellement stock\u00C3\u00A9e dans la formule\r\n      const rawExpression = (formula as { expression?: string; rawExpression?: string } | null)?.expression \r\n        || (formula as { expression?: string; rawExpression?: string } | null)?.rawExpression \r\n        || '';\r\n      let orchestrated: ReturnType<typeof evaluateFormulaOrchestrated> | null = null;\r\n      try {\r\n        orchestrated = evaluateFormulaOrchestrated({\r\n          fieldValues,\r\n          tokens,\r\n          rawExpression,\r\n          variableMap: req.body?.variableMap,\r\n          hasOperatorsOverride: req.body?.hasOperators\r\n        });\r\n        \r\n        // \u00F0\u0178\u017D\u00AF DEBUG MODE pour l'orchestrateur en d\u00C3\u00A9veloppement\r\n        if (process.env.NODE_ENV === 'development') {\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 === R\u00C3\u2030SULTAT ORCHESTRATEUR ===`);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 resolvedVariables:`, orchestrated.resolvedVariables);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 strategy:`, orchestrated.strategy);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 operatorsDetected:`, orchestrated.operatorsDetected);\r\n          \r\n          const variableCount = Object.keys(orchestrated.resolvedVariables).filter(k => orchestrated.resolvedVariables[k] !== 0).length;\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 Variable count (non-zero):`, variableCount);\r\n          \r\n          if (variableCount === 1) {\r\n            const singleValue = Object.values(orchestrated.resolvedVariables).find(v => v !== 0);\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 \u00E2\u009D\u0152 UNE SEULE VARIABLE \u00E2\u2020\u2019 RETOUR DIRECT: ${singleValue}`);\r\n          } else if (variableCount >= 2) {\r\n            const values = Object.values(orchestrated.resolvedVariables);\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 \u00E2\u0153\u2026 PLUSIEURS VARIABLES \u00E2\u2020\u2019 CALCUL: ${values[0]} / ${values[1]} = ${values[0] / values[1]}`);\r\n          }\r\n          \r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u00A8 Trace orchestrateur:`, orchestrated.trace);\r\n        }\r\n      } catch (orchestratorError) {\r\n        console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur orchestrateur:', orchestratorError);\r\n        return res.status(500).json({\r\n          error: 'Erreur orchestrateur formule',\r\n          details: (orchestratorError as Error).message || 'unknown',\r\n          debug: {\r\n            formulaId: formula.id,\r\n            rawExpression,\r\n            tokensCount: tokens.length,\r\n            receivedFieldValuesKeys: Object.keys(fieldValues)\r\n          }\r\n        });\r\n      }\r\n      const resolvedVariables = orchestrated.resolvedVariables;\r\n      console.log('[TreeBranchLeaf API] \u00F0\u0178\u017D\u00AF Variables finales r\u00C3\u00A9solues (orchestrateur):', resolvedVariables);\r\n      console.log('[TreeBranchLeaf API] \u00F0\u0178\u017D\u00AF Strat\u00C3\u00A9gie orchestrateur:', orchestrated.strategy, 'operatorsDetected=', orchestrated.operatorsDetected);\r\n      console.log('[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 FieldValues disponibles:', Object.keys(fieldValues));\r\n      console.log('[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 Valeurs FieldValues:', fieldValues);\r\n\r\n      // \u00F0\u0178\u00A7\u00A0 ANALYSEUR INTELLIGENT UNIVERSEL - SYST\u00C3\u02C6ME DYNAMIQUE COMPLET\r\n      const universalAnalyzer = (fieldValues: Record<string, string | number | null | undefined>) => {\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00A0 === ANALYSE INTELLIGENTE UNIVERSELLE ===`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00A0 Donn\u00C3\u00A9es re\u00C3\u00A7ues:`, fieldValues);\r\n        \r\n        // 1. CLASSIFICATION AUTOMATIQUE DES DONN\u00C3\u2030ES\r\n        interface ClassifiedBuckets {\r\n          userInputs: Record<string, unknown>;\r\n          systemRefs: Record<string, unknown>;\r\n          calculations: Record<string, unknown>;\r\n          conditions: Record<string, unknown>;\r\n          metadata: Record<string, unknown>;\r\n        }\r\n        const classified: ClassifiedBuckets = {\r\n          userInputs: {},\r\n            systemRefs: {},\r\n          calculations: {},\r\n          conditions: {},\r\n          metadata: {}\r\n        };\r\n        \r\n        // 2. ANALYSE DE CHAQUE DONN\u00C3\u2030E\r\n        Object.entries(fieldValues).forEach(([key, value]) => {\r\n          if (value == null || value === '') return;\r\n          \r\n          const strValue = String(value);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D Analyse \"${key}\": \"${strValue}\"`);\r\n          \r\n          // Valeurs utilisateur directes (champs de saisie)\r\n          if (key.includes('_field')) {\r\n            classified.userInputs[key] = value;\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u2018\u00A4 INPUT UTILISATEUR: \"${key}\" = \"${value}\"`);\r\n          }\r\n          // R\u00C3\u00A9f\u00C3\u00A9rences syst\u00C3\u00A8me (IDs, n\u00C5\u201Cuds)\r\n          else if (key.startsWith('node_') || key.includes('-') && key.length > 10) {\r\n            classified.systemRefs[key] = value;\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u2014 R\u00C3\u2030F\u00C3\u2030RENCE SYST\u00C3\u02C6ME: \"${key}\" = \"${value}\"`);\r\n          }\r\n          // Donn\u00C3\u00A9es miroir (pour sync)\r\n          else if (key.startsWith('__mirror_')) {\r\n            classified.metadata[key] = value;\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00AA\u017E M\u00C3\u2030TADONN\u00C3\u2030E: \"${key}\" = \"${value}\"`);\r\n          }\r\n          // Tout le reste = calculs/conditions\r\n          else {\r\n            classified.calculations[key] = value;\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE CALCUL/CONDITION: \"${key}\" = \"${value}\"`);\r\n          }\r\n        });\r\n        \r\n        return classified;\r\n      };\r\n      \r\n      // \u00F0\u0178\u017D\u00AF STRAT\u00C3\u02C6GE INTELLIGENT - D\u00C3\u2030CISION AUTOMATIQUE\r\n      const intelligentStrategy = (\r\n        classified: { userInputs: Record<string, unknown>; systemRefs: Record<string, unknown>; calculations: Record<string, unknown> },\r\n        resolvedVariables: Record<string, number>,\r\n        context: { tokenVariablesCount: number; tokensCount: number }\r\n      ) => {\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u017D\u00AF === STRAT\u00C3\u2030GIE INTELLIGENTE ===`);\r\n        \r\n        const userInputCount = Object.keys(classified.userInputs).length;\r\n        const systemRefCount = Object.keys(classified.systemRefs).length;\r\n        const calculationCount = Object.keys(classified.calculations).length;\r\n        // \u00F0\u0178\u201D\u00A7 CORRECTION CRITIQUE: Compter toutes les variables des tokens, pas seulement celles r\u00C3\u00A9solues \u00C3\u00A0 non-zero\r\n        // Le probl\u00C3\u00A8me \u00C3\u00A9tait qu'une variable non-r\u00C3\u00A9solue (mise \u00C3\u00A0 0) n'\u00C3\u00A9tait pas compt\u00C3\u00A9e, \r\n        // faisant passer de 2 variables \u00C3\u00A0 1 variable \u00E2\u2020\u2019 SINGLE_VALUE au lieu d'AUTO_CALCULATION\r\n        const tokenVariableCount = context.tokenVariablesCount;\r\n        const variableCount = Object.keys(resolvedVariables).filter(k => resolvedVariables[k] !== 0).length;\r\n        \r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u0160 COMPTAGE:`, {\r\n          userInputs: userInputCount,\r\n          systemRefs: systemRefCount,\r\n          calculations: calculationCount,\r\n          variables: variableCount,\r\n          tokenVariables: tokenVariableCount, // \u00F0\u0178\u201D\u00A7 UTILISER CETTE VALEUR\r\n          tokens: context.tokensCount\r\n        });\r\n        \r\n        // R\u00C3\u02C6GLE 1 (ADAPT\u00C3\u2030E): Priorit\u00C3\u00A9 utilisateur UNIQUEMENT si la formule n'a pas de variables (tokenVariablesCount=0)\r\n        // Avant: on retournait syst\u00C3\u00A9matiquement la premi\u00C3\u00A8re saisie (probl\u00C3\u00A8me: figeait la formule sur le premier chiffre tap\u00C3\u00A9)\r\n        if (userInputCount > 0 && context.tokenVariablesCount === 0) {\r\n          const userValue = Object.values(classified.userInputs)[0];\r\n          console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 STRAT\u00C3\u2030GIE: PRIORIT\u00C3\u2030 UTILISATEUR`);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D D\u00C3\u2030TAIL VALEUR UTILISATEUR:`);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - Type: ${typeof userValue}`);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - Valeur brute: \"${userValue}\"`);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - String conversion: \"${String(userValue)}\"`);\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - Longueur: ${String(userValue).length}`);\r\n          \r\n          return {\r\n            strategy: 'USER_PRIORITY',\r\n            value: userValue,\r\n            reason: 'L\\'utilisateur a entr\u00C3\u00A9 une valeur directe'\r\n          };\r\n        }\r\n        \r\n        // \u00F0\u0178\u201D\u00A7 CORRECTION CRITIQUE: Utiliser tokenVariableCount au lieu de variableCount\r\n        // R\u00C3\u02C6GLE 2: Si on a des variables pour calculer dans les tokens, on calcule\r\n        if (tokenVariableCount >= 2) {\r\n          console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 STRAT\u00C3\u2030GIE: CALCUL AUTOMATIQUE (${tokenVariableCount} variables dans les tokens, ${variableCount} r\u00C3\u00A9solues non-nulles)`);\r\n          return {\r\n            strategy: 'AUTO_CALCULATION',\r\n            value: null,\r\n            reason: `Calcul automatique avec ${tokenVariableCount} variables dans les tokens`\r\n          };\r\n        }\r\n        \r\n        // R\u00C3\u02C6GLE 3: Une seule variable = retour direct (mais seulement si vraiment une seule variable dans les tokens)\r\n        if (tokenVariableCount === 1) {\r\n          const singleValue = Object.values(resolvedVariables).find(v => v !== 0);\r\n          console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 STRAT\u00C3\u2030GIE: VALEUR UNIQUE (valeur: ${singleValue})`);\r\n          return {\r\n            strategy: 'SINGLE_VALUE',\r\n            value: singleValue,\r\n            reason: 'Une seule variable dans les tokens'\r\n          };\r\n        }\r\n        \r\n        // R\u00C3\u02C6GLE 4: Pas de donn\u00C3\u00A9es = neutre\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F STRAT\u00C3\u2030GIE: NEUTRE (aucune donn\u00C3\u00A9e significative)`);\r\n        return {\r\n          strategy: 'NEUTRAL',\r\n          value: 0,\r\n          reason: 'Aucune donn\u00C3\u00A9e disponible'\r\n        };\r\n      };\r\n      \r\n      // EX\u00C3\u2030CUTION DU SYST\u00C3\u02C6ME INTELLIGENT\r\n  const classified = universalAnalyzer(fieldValues);\r\n  const strategy = intelligentStrategy(classified, resolvedVariables, { tokenVariablesCount: tokenVariables.length, tokensCount: tokens.length });\r\n      \r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u20AC === EX\u00C3\u2030CUTION INTELLIGENTE ===`);\r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u20AC Strat\u00C3\u00A9gie choisie: ${strategy.strategy}`);\r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u0161\u20AC Raison: ${strategy.reason}`);\r\n      \r\n      // EX\u00C3\u2030CUTION SELON LA STRAT\u00C3\u2030GIE\r\n  if (strategy.strategy === 'USER_PRIORITY' || strategy.strategy === 'SINGLE_VALUE') {\r\n        // Retourner la valeur directement\r\n        const rawValue = strategy.value;\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 === RETOUR DIRECT ===`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D ANALYSE CONVERSION:`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - Valeur strategy.value: \"${rawValue}\"`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - Type de strategy.value: ${typeof rawValue}`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - String(rawValue): \"${String(rawValue)}\"`);\r\n        \r\n        const cleanedString = String(rawValue).replace(/\\s+/g, '').replace(/,/g, '.');\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - Apr\u00C3\u00A8s nettoyage: \"${cleanedString}\"`);\r\n        \r\n        const numValue = parseFloat(cleanedString);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - parseFloat r\u00C3\u00A9sultat: ${numValue}`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D - isNaN(numValue): ${isNaN(numValue)}`);\r\n        \r\n        const finalValue = isNaN(numValue) ? 0 : numValue;\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Valeur finale: ${finalValue}`);\r\n        \r\n        return res.json({\r\n          success: true,\r\n          result: finalValue,\r\n          strategy: strategy.strategy,\r\n          reason: strategy.reason,\r\n          source: rawValue,\r\n          analysis: classified,\r\n          orchestrator: orchestrated ? {\r\n            strategy: orchestrated.strategy,\r\n            operatorsDetected: orchestrated.operatorsDetected,\r\n            trace: orchestrated.trace,\r\n            resolvedVariables: orchestrated.resolvedVariables\r\n          } : null\r\n        });\r\n      }\r\n      \r\n      if (strategy.strategy === 'NEUTRAL') {\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F === RETOUR NEUTRE ===`);\r\n        return res.json({\r\n          success: true,\r\n          result: 0,\r\n          strategy: strategy.strategy,\r\n          reason: strategy.reason,\r\n          analysis: classified,\r\n          orchestrator: orchestrated ? {\r\n            strategy: orchestrated.strategy,\r\n            operatorsDetected: orchestrated.operatorsDetected,\r\n            trace: orchestrated.trace,\r\n            resolvedVariables: orchestrated.resolvedVariables\r\n          } : null\r\n        });\r\n      }\r\n      \r\n      // MODE CALCUL AUTOMATIQUE - Le syst\u00C3\u00A8me d\u00C3\u00A9tecte et calcule intelligemment\r\n      if (strategy.strategy === 'AUTO_CALCULATION') {\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE === MODE CALCUL AUTOMATIQUE ===`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE Variables pour calcul:`, resolvedVariables);\r\n        \r\n        // Le syst\u00C3\u00A8me continue avec l'\u00C3\u00A9valuation math\u00C3\u00A9matique de la formule\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE Proc\u00C3\u00A9dure automatique de calcul activ\u00C3\u00A9e`);\r\n      }\r\n\r\n      // MODE CALCUL: \u00C3\u2030valuation de la formule math\u00C3\u00A9matique\r\n  console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE === MODE CALCUL ===`);\r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE Formule \u00C3\u00A0 \u00C3\u00A9valuer avec variables:`, resolvedVariables);\r\n\r\n      // \u00F0\u0178\u00A7\u00AE \u00C3\u2030VALUATION ULTRA-ROBUSTE PAR PILE - Moteur Intelligent\r\n      const evaluateTokens = (tokens: FormulaToken[]): number => {\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE === D\u00C3\u2030BUT \u00C3\u2030VALUATION COMPL\u00C3\u02C6TE ===`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE Tokens \u00C3\u00A0 \u00C3\u00A9valuer:`, tokens);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE Variables disponibles:`, resolvedVariables);\r\n        const stack: number[] = [];\r\n        const operations: string[] = [];\r\n        \r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE D\u00C3\u00A9but \u00C3\u00A9valuation avec ${tokens.length} tokens:`, \r\n          tokens.map(t => `${t.type}:${t.value || t.name}`).join(' '));\r\n        \r\n        // \u00F0\u0178\u0161\u20AC CONVERSION INFIX \u00E2\u2020\u2019 POSTFIX pour expressions math\u00C3\u00A9matiques correctes\r\n        const convertToPostfix = (tokens: Array<{ type: string; value?: string; name?: string }>) => {\r\n          const outputQueue: Array<{ type: string; value?: string; name?: string }> = [];\r\n          const operatorStack: Array<{ type: string; value?: string; name?: string }> = [];\r\n          const precedence: { [key: string]: number } = { '+': 1, '-': 1, '*': 2, '/': 2 };\r\n          \r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u201E Conversion infix \u00E2\u2020\u2019 postfix pour:`, tokens.map(t => t.value || t.name).join(' '));\r\n          \r\n          for (const token of tokens) {\r\n            if (token.type === 'value' || token.type === 'variable') {\r\n              outputQueue.push(token);\r\n            } else if (token.type === 'operator' && token.value && precedence[token.value]) {\r\n              // Pop operators with higher or equal precedence\r\n              while (operatorStack.length > 0 && \r\n                     operatorStack[operatorStack.length - 1].type === 'operator' && \r\n                     operatorStack[operatorStack.length - 1].value &&\r\n                     precedence[operatorStack[operatorStack.length - 1].value!] >= precedence[token.value]) {\r\n                outputQueue.push(operatorStack.pop()!);\r\n              }\r\n              operatorStack.push(token);\r\n            }\r\n          }\r\n          \r\n          // Pop remaining operators\r\n          while (operatorStack.length > 0) {\r\n            outputQueue.push(operatorStack.pop()!);\r\n          }\r\n          \r\n          console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Postfix converti:`, outputQueue.map(t => t.value || t.variableId || t.name || 'unknown').join(' '));\r\n          return outputQueue;\r\n        };\r\n        \r\n        const postfixTokens = convertToPostfix(tokens);\r\n        \r\n        // \u00F0\u0178\u00A7\u00AE \u00C3\u2030VALUATION des tokens en notation postfix\r\n        for (let i = 0; i < postfixTokens.length; i++) {\r\n          const token = postfixTokens[i];\r\n          if (!token) continue;\r\n          \r\n          if (token.type === 'value') {\r\n            const value = parseFloat(String(token.value));\r\n            const finalValue = isNaN(value) ? 0 : value;\r\n            stack.push(finalValue);\r\n            operations.push(`PUSH(${finalValue})`);\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u0160 Valeur: ${finalValue}`);\r\n            \r\n          } else if (token.type === 'variable') {\r\n            // \u00F0\u0178\u0161\u20AC DYNAMIQUE: Support des deux formats de tokens (name ET variableId)\r\n            const varName = token.variableId || token.name || '';\r\n            const value = resolvedVariables[varName] || 0;\r\n            stack.push(value);\r\n            operations.push(`PUSH(${varName}=${value})`);\r\n            console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u00A2 Variable: ${varName} = ${value} (propri\u00C3\u00A9t\u00C3\u00A9: ${token.variableId ? 'variableId' : 'name'})`);\r\n            \r\n          } else if (token.type === 'operator' && ['+', '-', '*', '/'].includes(String(token.value))) {\r\n            // \u00C3\u2030valuation en notation postfix - l'op\u00C3\u00A9rateur vient apr\u00C3\u00A8s les op\u00C3\u00A9randes\r\n            if (stack.length >= 2) {\r\n              const b = stack.pop()!;\r\n              const a = stack.pop()!;\r\n              let result = 0;\r\n              const operator = String(token.value);\r\n              \r\n              switch (operator) {\r\n                case '+': \r\n                  result = a + b; \r\n                  operations.push(`${a} + ${b} = ${result}`);\r\n                  break;\r\n                case '-': \r\n                  result = a - b; \r\n                  operations.push(`${a} - ${b} = ${result}`);\r\n                  break;\r\n                case '*': \r\n                  result = a * b; \r\n                  operations.push(`${a} * ${b} = ${result}`);\r\n                  break;\r\n                case '/': \r\n                  if (b !== 0) {\r\n                    result = a / b;\r\n                    operations.push(`${a} / ${b} = ${result}`);\r\n                  } else {\r\n                    result = 0;\r\n                    operations.push(`${a} / ${b} = 0 (division par z\u00C3\u00A9ro \u00C3\u00A9vit\u00C3\u00A9e)`);\r\n                    console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Division par z\u00C3\u00A9ro \u00C3\u00A9vit\u00C3\u00A9e: ${a} / ${b}`);\r\n                  }\r\n                  break;\r\n              }\r\n              \r\n              stack.push(result);\r\n              console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A1 Op\u00C3\u00A9ration: ${a} ${operator} ${b} = ${result}`);\r\n              \r\n            } else {\r\n              console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Pile insuffisante pour l'op\u00C3\u00A9rateur ${token.value}, pile actuelle:`, stack);\r\n              operations.push(`ERREUR: Pile insuffisante pour ${token.value}`);\r\n            }\r\n          } else {\r\n            console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Token ignor\u00C3\u00A9:`, token);\r\n          }\r\n        }\r\n        \r\n        const finalResult = stack.length > 0 ? stack[0] : 0;\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u017D\u00AF R\u00C3\u00A9sultat final: ${finalResult}`);\r\n        console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u009D Op\u00C3\u00A9rations effectu\u00C3\u00A9es:`, operations);\r\n        \r\n        return finalResult;\r\n      };\r\n\r\n      let result: number | null = null;\r\n      \r\n      if (tokens.length > 0) {\r\n        result = evaluateTokens(tokens);\r\n      } else {\r\n        result = 0;\r\n      }\r\n\r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE R\u00C3\u00A9sultat du calcul:`, result);\r\n\r\n      const responseData = {\r\n        formulaId: formula.id,\r\n        formulaName: formula.name,\r\n        nodeLabel: formula.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n        evaluation: {\r\n          success: result !== null,\r\n          result: result,\r\n          tokens: tokens,\r\n          resolvedVariables: resolvedVariables,\r\n          details: {\r\n            fieldValues: fieldValues,\r\n            timestamp: new Date().toISOString(),\r\n            testMode: testMode,\r\n            tokenCount: tokens.length,\r\n            variableCount: tokenVariables.length\r\n          }\r\n        },\r\n        orchestrator: orchestrated ? {\r\n          strategy: orchestrated.strategy,\r\n          operatorsDetected: orchestrated.operatorsDetected,\r\n          trace: orchestrated.trace,\r\n          resolvedVariables: orchestrated.resolvedVariables\r\n        } : null\r\n      };\r\n\r\n      return res.json(responseData);\r\n    } catch (evaluationError) {\r\n      console.error(`[TreeBranchLeaf API] Erreur lors de l'\u00C3\u00A9valuation:`, evaluationError);\r\n      return res.status(500).json({ \r\n        error: 'Erreur lors de l\\'\u00C3\u00A9valuation de la formule',\r\n        details: (evaluationError as Error).message,\r\n        debug: {\r\n          formulaId,\r\n          hasTokens: (() => {\r\n            const maybeErr = evaluationError as unknown as { tokens?: unknown } | null;\r\n            if (maybeErr && Array.isArray(maybeErr.tokens)) return maybeErr.tokens.length;\r\n            return tokens.length;\r\n          })(),\r\n          receivedFieldValuesKeys: Object.keys(fieldValues),\r\n          orchestratorTrace: orchestrated?.trace?.slice?.(0, 10) || null\r\n        }\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error evaluating formula:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'\u00C3\u00A9valuation de la formule' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/evaluate/batch\r\n// \u00C3\u2030value plusieurs formules en une seule requ\u00C3\u00AAte\r\nrouter.post('/evaluate/batch', async (req, res) => {\r\n  try {\r\n    const { requests = [], nodeIds = [], fieldValues = {} } = req.body;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE \u00C3\u2030valuation batch - requests: ${requests.length}, nodeIds: ${nodeIds.length}`);\r\n\r\n    // Support de deux formats :\r\n    // 1. Format classique : { requests: [{ formulaId, fieldValues }] }\r\n    // 2. Format nodeIds : { nodeIds: ['id1', 'id2'], fieldValues: {...} }\r\n    \r\n    let finalRequests = [];\r\n    \r\n    if (Array.isArray(requests) && requests.length > 0) {\r\n      // Format classique\r\n      finalRequests = requests;\r\n    } else if (Array.isArray(nodeIds) && nodeIds.length > 0) {\r\n      // Format nodeIds - on doit r\u00C3\u00A9cup\u00C3\u00A9rer les formules des n\u00C5\u201Cuds\r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D R\u00C3\u00A9cup\u00C3\u00A9ration formules pour nodeIds:`, nodeIds);\r\n      \r\n      for (const nodeId of nodeIds) {\r\n        // R\u00C3\u00A9cup\u00C3\u00A9rer les formules du n\u00C5\u201Cud\r\n        const nodeFormulas = await prisma.treeBranchLeafNodeFormula.findMany({\r\n          where: { nodeId },\r\n          select: { id: true, name: true }\r\n        });\r\n        \r\n        for (const formula of nodeFormulas) {\r\n          finalRequests.push({\r\n            formulaId: formula.id,\r\n            fieldValues: fieldValues,\r\n            testMode: false\r\n          });\r\n        }\r\n      }\r\n      \r\n      console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D Formules trouv\u00C3\u00A9es: ${finalRequests.length} pour ${nodeIds.length} n\u00C5\u201Cuds`);\r\n    }\r\n\r\n    if (finalRequests.length === 0) {\r\n      return res.status(400).json({ error: 'Aucune formule \u00C3\u00A0 \u00C3\u00A9valuer dans la requ\u00C3\u00AAte batch' });\r\n    }\r\n\r\n    const results = [];\r\n\r\n    for (const request of finalRequests) {\r\n      const { formulaId, fieldValues = {}, testMode = true } = request;\r\n\r\n      if (!formulaId) {\r\n        results.push({\r\n          formulaId: null,\r\n          error: 'formulaId manquant',\r\n          success: false\r\n        });\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        // R\u00C3\u00A9cup\u00C3\u00A9rer la formule\r\n        const formula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n          where: { id: formulaId },\r\n          include: {\r\n            TreeBranchLeafNode: {\r\n              select: {\r\n                label: true,\r\n                treeId: true,\r\n                TreeBranchLeafTree: {\r\n                  select: { organizationId: true }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        });\r\n\r\n        if (!formula) {\r\n          results.push({\r\n            formulaId,\r\n            error: 'Formule non trouv\u00C3\u00A9e',\r\n            success: false\r\n          });\r\n          continue;\r\n        }\r\n\r\n        // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s organisation\r\n        const nodeOrg = formula.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n        if (!isSuperAdmin && nodeOrg && nodeOrg !== organizationId) {\r\n          results.push({\r\n            formulaId,\r\n            error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette formule',\r\n            success: false\r\n          });\r\n          continue;\r\n        }\r\n\r\n        // \u00C3\u2030valuer la formule (m\u00C3\u00AAme logique que l'endpoint individuel)\r\n        interface FormulaToken {\r\n          type: 'value' | 'variable' | 'operator' | 'lparen' | 'rparen';\r\n          value?: string | number;\r\n          name?: string;\r\n        }\r\n\r\n        const tokens = Array.isArray(formula.tokens) ? formula.tokens as FormulaToken[] : [];\r\n        \r\n        const tokenVariables = tokens\r\n          .filter((t): t is FormulaToken => Boolean(t) && t.type === 'variable')\r\n          .map((t) => t.name)\r\n          .filter(Boolean) as string[];\r\n\r\n        const resolvedVariables: Record<string, number> = {};\r\n        for (const varName of tokenVariables) {\r\n          const rawValue = fieldValues[varName];\r\n          const numValue = rawValue != null && rawValue !== '' \r\n            ? parseFloat(String(rawValue).replace(/\\s+/g, '').replace(/,/g, '.'))\r\n            : 0;\r\n          resolvedVariables[varName] = isNaN(numValue) ? 0 : numValue;\r\n        }\r\n\r\n        const evaluateTokens = (tokens: FormulaToken[]): number => {\r\n          const stack: number[] = [];\r\n          \r\n          for (const token of tokens) {\r\n            if (!token) continue;\r\n            \r\n            if (token.type === 'value') {\r\n              const value = parseFloat(String(token.value));\r\n              stack.push(isNaN(value) ? 0 : value);\r\n            } else if (token.type === 'variable') {\r\n              // \u00F0\u0178\u0161\u20AC DYNAMIQUE: Support des deux formats de tokens (variableId ET name)\r\n              const varName = token.variableId || token.name || '';\r\n              const value = resolvedVariables[varName] || 0;\r\n              stack.push(value);\r\n            } else if (token.type === 'operator' && ['+', '-', '*', '/'].includes(String(token.value))) {\r\n              if (stack.length >= 2) {\r\n                const b = stack.pop()!;\r\n                const a = stack.pop()!;\r\n                let result = 0;\r\n                \r\n                switch (token.value) {\r\n                  case '+': result = a + b; break;\r\n                  case '-': result = a - b; break;\r\n                  case '*': result = a * b; break;\r\n                  case '/': result = b !== 0 ? a / b : 0; break;\r\n                }\r\n                \r\n                stack.push(result);\r\n              }\r\n            }\r\n          }\r\n          \r\n          return stack.length > 0 ? stack[0] : 0;\r\n        };\r\n\r\n        let result: number | null = null;\r\n        \r\n        if (tokens.length > 0) {\r\n          result = evaluateTokens(tokens);\r\n        } else {\r\n          result = 0;\r\n        }\r\n\r\n        results.push({\r\n          formulaId: formula.id,\r\n          formulaName: formula.name,\r\n          nodeLabel: formula.TreeBranchLeafNode?.label || 'N\u00C5\u201Cud inconnu',\r\n          success: true,\r\n          evaluation: {\r\n            success: result !== null,\r\n            result: result,\r\n            tokens: tokens,\r\n            resolvedVariables: resolvedVariables,\r\n            details: {\r\n              fieldValues: fieldValues,\r\n              timestamp: new Date().toISOString(),\r\n              testMode: testMode,\r\n              tokenCount: tokens.length,\r\n              variableCount: tokenVariables.length\r\n            }\r\n          }\r\n        });\r\n\r\n      } catch (evaluationError) {\r\n        console.error(`[TreeBranchLeaf API] Erreur \u00C3\u00A9valuation batch formule ${formulaId}:`, evaluationError);\r\n        results.push({\r\n          formulaId,\r\n          error: `Erreur d'\u00C3\u00A9valuation: ${(evaluationError as Error).message}`,\r\n          success: false\r\n        });\r\n      }\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u00A7\u00AE Batch termin\u00C3\u00A9: ${results.filter(r => r.success).length}/${results.length} succ\u00C3\u00A8s`);\r\n\r\n    return res.json({\r\n      success: true,\r\n      totalRequests: finalRequests.length,\r\n      successCount: results.filter(r => r.success).length,\r\n      results: results\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error in batch evaluation:', error);\r\n    res.status(500).json({ error: 'Erreur lors de l\\'\u00C3\u00A9valuation batch' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u00A7 HELPER FUNCTIONS\r\n// =============================================================================\r\n\r\n// Fonction helper pour v\u00C3\u00A9rifier l'acc\u00C3\u00A8s \u00C3\u00A0 un n\u00C5\u201Cud par organisation\r\nasync function ensureNodeOrgAccess(\r\n  prisma: PrismaClient, \r\n  nodeId: string, \r\n  auth: { organizationId: string | null; isSuperAdmin: boolean }\r\n): Promise<{ ok: boolean; status?: number; error?: string }> {\r\n  try {\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer le node avec son treeId\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { id: nodeId },\r\n      select: { treeId: true }\r\n    });\r\n\r\n    if (!node) {\r\n      return { ok: false, status: 404, error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' };\r\n    }\r\n\r\n    // Super admin a acc\u00C3\u00A8s \u00C3\u00A0 tout\r\n    if (auth.isSuperAdmin) {\r\n      return { ok: true };\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer l'arbre pour v\u00C3\u00A9rifier l'organizationId\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: { id: node.treeId },\r\n      select: { organizationId: true }\r\n    });\r\n\r\n    if (!tree) {\r\n      return { ok: false, status: 404, error: 'Arbre non trouv\u00C3\u00A9' };\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier correspondance organisation\r\n    if (tree.organizationId && tree.organizationId !== auth.organizationId) {\r\n      return { ok: false, status: 403, error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' };\r\n    }\r\n\r\n    return { ok: true };\r\n  } catch (error) {\r\n    console.error('Error checking node org access:', error);\r\n    return { ok: false, status: 500, error: 'Erreur de v\u00C3\u00A9rification d\\'acc\u00C3\u00A8s' };\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u2020\u201D ENDPOINTS DIRECTS PAR ID - Pour r\u00C3\u00A9cup\u00C3\u00A9ration dynamique\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/conditions/:conditionId\r\n// R\u00C3\u00A9cup\u00C3\u00A8re une condition sp\u00C3\u00A9cifique par son ID\r\nrouter.get('/conditions/:conditionId', async (req, res) => {\r\n  try {\r\n    const { conditionId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D GET condition par ID: ${conditionId}`);\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la condition avec informations d'organisation\r\n    const condition = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n      where: { id: conditionId },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: { organizationId: true }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!condition) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Condition ${conditionId} non trouv\u00C3\u00A9e`);\r\n      return res.status(404).json({ error: 'Condition non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s organisation\r\n    const nodeOrg = condition.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && nodeOrg && nodeOrg !== organizationId) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 condition ${conditionId} (org: ${nodeOrg} vs ${organizationId})`);\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette condition' });\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Condition ${conditionId} trouv\u00C3\u00A9e et autoris\u00C3\u00A9e`);\r\n    return res.json(condition);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting condition by ID:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la condition' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/formulas/:formulaId\r\n// R\u00C3\u00A9cup\u00C3\u00A8re une formule sp\u00C3\u00A9cifique par son ID\r\nrouter.get('/formulas/:formulaId', async (req, res) => {\r\n  try {\r\n    const { formulaId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D GET formule par ID: ${formulaId}`);\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la formule avec informations d'organisation\r\n    const formula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n      where: { id: formulaId },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            label: true,\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: { organizationId: true }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!formula) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Formule ${formulaId} non trouv\u00C3\u00A9e`);\r\n      return res.status(404).json({ error: 'Formule non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s organisation\r\n    const nodeOrg = formula.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && nodeOrg && nodeOrg !== organizationId) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 formule ${formulaId} (org: ${nodeOrg} vs ${organizationId})`);\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette formule' });\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Formule ${formulaId} trouv\u00C3\u00A9e et autoris\u00C3\u00A9e`);\r\n    return res.json(formula);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting formula by ID:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la formule' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201C\u2039 SUBMISSIONS - Gestion des soumissions TreeBranchLeaf\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/submissions - Lister les soumissions avec filtres\r\nrouter.get('/submissions', async (req, res) => {\r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { treeId, leadId, userId } = req.query;\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 GET submissions avec filtres:`, { treeId, leadId, userId });\r\n\r\n    // Construire les conditions de filtrage\r\n    interface SubmissionWhereClause {\r\n      treeId?: string;\r\n      leadId?: string;\r\n      userId?: string;\r\n      TreeBranchLeafTree?: {\r\n        organizationId: string;\r\n      };\r\n    }\r\n    \r\n    const whereClause: SubmissionWhereClause = {};\r\n    \r\n    if (treeId) whereClause.treeId = treeId as string;\r\n    if (leadId) whereClause.leadId = leadId as string;\r\n    if (userId) whereClause.userId = userId as string;\r\n\r\n    // Filtrer par organisation si pas super admin\r\n    if (!isSuperAdmin && organizationId) {\r\n      whereClause.TreeBranchLeafTree = {\r\n        organizationId: organizationId\r\n      };\r\n    }\r\n\r\n    const submissions = await prisma.treeBranchLeafSubmission.findMany({\r\n      where: whereClause,\r\n      include: {\r\n        TreeBranchLeafTree: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            organizationId: true\r\n          }\r\n        },\r\n        TreeBranchLeafSubmissionData: {\r\n          include: {\r\n            TreeBranchLeafNode: {\r\n              select: {\r\n                id: true,\r\n                label: true,\r\n                type: true\r\n              }\r\n            }\r\n          }\r\n        },\r\n        Lead: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true,\r\n            company: true\r\n          }\r\n        },\r\n        User_TreeBranchLeafSubmission_userIdToUser: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 ${submissions.length} soumissions trouv\u00C3\u00A9es`);\r\n    res.json(submissions);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching submissions:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des soumissions' });\r\n  }\r\n});\r\n\r\n// GET /submissions/by-leads - R\u00C3\u00A9cup\u00C3\u00A9rer les devis group\u00C3\u00A9s par lead\r\nrouter.get('/submissions/by-leads', async (req, res) => {\r\n  try {\r\n    const authCtx = getAuthCtx(req);\r\n    const { organizationId, isSuperAdmin } = authCtx;\r\n    const { treeId, search, leadId } = req.query;\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 GET devis par leads - TreeId: ${treeId}, Search: ${search}, LeadId: ${leadId}`);\r\n\r\n    // Construire les filtres pour les soumissions\r\n    const submissionWhere: {\r\n      treeId?: string;\r\n      leadId?: string;\r\n      TreeBranchLeafTree?: { organizationId: string };\r\n    } = {};\r\n    if (treeId) {\r\n      submissionWhere.treeId = treeId as string;\r\n    }\r\n    if (leadId) {\r\n      submissionWhere.leadId = leadId as string;\r\n    }\r\n    if (!isSuperAdmin) {\r\n      submissionWhere.TreeBranchLeafTree = {\r\n        organizationId\r\n      };\r\n    }\r\n\r\n    // Construire les filtres pour les leads\r\n    const leadWhere: {\r\n      id?: string;\r\n      organizationId?: string;\r\n      OR?: Array<{\r\n        firstName?: { contains: string; mode: 'insensitive' };\r\n        lastName?: { contains: string; mode: 'insensitive' };\r\n        email?: { contains: string; mode: 'insensitive' };\r\n      }>;\r\n    } = {};\r\n    if (leadId) {\r\n      leadWhere.id = leadId as string;\r\n    }\r\n    if (!isSuperAdmin) {\r\n      leadWhere.organizationId = organizationId;\r\n    }\r\n    if (search) {\r\n      leadWhere.OR = [\r\n        { firstName: { contains: search as string, mode: 'insensitive' } },\r\n        { lastName: { contains: search as string, mode: 'insensitive' } },\r\n        { email: { contains: search as string, mode: 'insensitive' } }\r\n      ];\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les leads avec leurs devis\r\n    const leadsWithSubmissions = await prisma.lead.findMany({\r\n      where: {\r\n        ...leadWhere,\r\n        TreeBranchLeafSubmission: {\r\n          some: submissionWhere\r\n        }\r\n      },\r\n      include: {\r\n        TreeBranchLeafSubmission: {\r\n          where: submissionWhere,\r\n          select: {\r\n            id: true,\r\n            status: true,\r\n            summary: true,\r\n            createdAt: true,\r\n            updatedAt: true,\r\n            TreeBranchLeafTree: {\r\n              select: { id: true, name: true }\r\n            }\r\n          },\r\n          orderBy: { createdAt: 'desc' }\r\n        }\r\n      },\r\n      orderBy: [\r\n        { firstName: 'asc' },\r\n        { lastName: 'asc' }\r\n      ]\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u0160 Trouv\u00C3\u00A9 ${leadsWithSubmissions.length} leads avec devis`);\r\n\r\n    // Formater les donn\u00C3\u00A9es pour l'interface\r\n    const formattedData = leadsWithSubmissions.map(lead => ({\r\n      id: lead.id,\r\n      firstName: lead.firstName,\r\n      lastName: lead.lastName,\r\n      email: lead.email,\r\n      company: lead.company,\r\n      submissions: lead.TreeBranchLeafSubmission.map(submission => ({\r\n        id: submission.id,\r\n        name: (submission.summary as { name?: string })?.name || `Devis ${new Date(submission.createdAt).toLocaleDateString('fr-FR')}`,\r\n        status: submission.status,\r\n        createdAt: submission.createdAt,\r\n        updatedAt: submission.updatedAt,\r\n        treeName: submission.TreeBranchLeafTree?.name\r\n      }))\r\n    }));\r\n\r\n    res.json(formattedData);\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error getting submissions by leads:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des devis par leads' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/submissions/:id - R\u00C3\u00A9cup\u00C3\u00A9rer une soumission sp\u00C3\u00A9cifique\r\nrouter.get('/submissions/:id', async (req, res) => {\r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { id } = req.params;\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 GET submission par ID: ${id}`);\r\n\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      include: {\r\n        TreeBranchLeafTree: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            organizationId: true\r\n          }\r\n        },\r\n        TreeBranchLeafSubmissionData: {\r\n          include: {\r\n            TreeBranchLeafNode: {\r\n              select: {\r\n                id: true,\r\n                label: true,\r\n                type: true\r\n              }\r\n            }\r\n          }\r\n        },\r\n        Lead: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true,\r\n            company: true\r\n          }\r\n        },\r\n        User: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            firstName: true,\r\n            lastName: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!submission) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Soumission ${id} non trouv\u00C3\u00A9e`);\r\n      return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s organisation\r\n    const treeOrg = submission.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && treeOrg && treeOrg !== organizationId) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 soumission ${id} (org: ${treeOrg} vs ${organizationId})`);\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette soumission' });\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Soumission ${id} trouv\u00C3\u00A9e et autoris\u00C3\u00A9e`);\r\n    res.json(submission);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching submission:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la soumission' });\r\n  }\r\n});\r\n\r\n// \u00F0\u0178\u2014\u201A\u00EF\u00B8\u008F GET /api/treebranchleaf/submissions/:id/fields - R\u00C3\u00A9cup\u00C3\u00A9rer TOUS les champs d'une soumission\r\nrouter.get('/submissions/:id/fields', async (req, res) => {\r\n  try {\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const { id } = req.params;\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u2014\u201A\u00EF\u00B8\u008F GET /submissions/${id}/fields - R\u00C3\u00A9cup\u00C3\u00A9ration de tous les champs`);\r\n\r\n    // Charger la soumission avec contr\u00C3\u00B4le d'acc\u00C3\u00A8s\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      include: { \r\n        TreeBranchLeafTree: { select: { id: true, organizationId: true } },\r\n        Lead: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true,\r\n            phone: true,\r\n            street: true,\r\n            streetNumber: true,\r\n            postalCode: true,\r\n            city: true,\r\n            company: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!submission) {\r\n      return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    }\r\n\r\n    const treeOrg = submission.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && treeOrg && treeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer toutes les donn\u00C3\u00A9es de la soumission avec labels des n\u00C5\u201Cuds\r\n    const dataRows = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId: id },\r\n      include: {\r\n        TreeBranchLeafNode: { \r\n          select: { \r\n            id: true, \r\n            type: true, \r\n            label: true,\r\n            name: true,\r\n            fieldType: true,\r\n            fieldSubType: true\r\n          } \r\n        }\r\n      },\r\n      orderBy: { createdAt: 'asc' }\r\n    });\r\n\r\n    // Construire un objet avec tous les champs mapp\u00C3\u00A9s\r\n    const fieldsMap: Record<string, {\r\n      nodeId: string;\r\n      label: string;\r\n      name?: string;\r\n      type: string;\r\n      fieldType?: string;\r\n      fieldSubType?: string;\r\n      value: any;\r\n      rawValue: string;\r\n    }> = {};\r\n\r\n    for (const row of dataRows) {\r\n      const node = row.TreeBranchLeafNode;\r\n      if (!node) continue;\r\n\r\n      // D\u00C3\u00A9terminer la cl\u00C3\u00A9 (utiliser name si disponible, sinon label, sinon nodeId)\r\n      const key = node.name || node.label || node.id;\r\n\r\n      fieldsMap[key] = {\r\n        nodeId: node.id,\r\n        label: node.label || '',\r\n        name: node.name,\r\n        type: node.type || 'unknown',\r\n        fieldType: node.fieldType,\r\n        fieldSubType: node.fieldSubType,\r\n        value: row.value, // Valeur pars\u00C3\u00A9e (JSON)\r\n        rawValue: row.rawValue // Valeur brute (string)\r\n      };\r\n    }\r\n\r\n    // Retourner les donn\u00C3\u00A9es structur\u00C3\u00A9es\r\n    const response = {\r\n      submissionId: submission.id,\r\n      treeId: submission.treeId,\r\n      treeName: submission.TreeBranchLeafTree?.id,\r\n      leadId: submission.leadId,\r\n      lead: submission.Lead ? {\r\n        id: submission.Lead.id,\r\n        firstName: submission.Lead.firstName,\r\n        lastName: submission.Lead.lastName,\r\n        fullName: `${submission.Lead.firstName || ''} ${submission.Lead.lastName || ''}`.trim(),\r\n        email: submission.Lead.email,\r\n        phone: submission.Lead.phone,\r\n        street: submission.Lead.street,\r\n        streetNumber: submission.Lead.streetNumber,\r\n        postalCode: submission.Lead.postalCode,\r\n        city: submission.Lead.city,\r\n        company: submission.Lead.company,\r\n        fullAddress: [\r\n          submission.Lead.street,\r\n          submission.Lead.streetNumber,\r\n          submission.Lead.postalCode,\r\n          submission.Lead.city\r\n        ].filter(Boolean).join(', ')\r\n      } : null,\r\n      status: submission.status,\r\n      createdAt: submission.createdAt,\r\n      updatedAt: submission.updatedAt,\r\n      fields: fieldsMap, // Tous les champs de la soumission\r\n      totalFields: Object.keys(fieldsMap).length\r\n    };\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 ${response.totalFields} champs r\u00C3\u00A9cup\u00C3\u00A9r\u00C3\u00A9s pour soumission ${id}`);\r\n    res.json(response);\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur GET /submissions/:id/fields:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des champs' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/submissions/:id/summary - R\u00C3\u00A9sum\u00C3\u00A9 des donn\u00C3\u00A9es d'une soumission\r\nrouter.get('/submissions/:id/summary', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // Charger la soumission pour contr\u00C3\u00B4le d'acc\u00C3\u00A8s\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n    });\r\n\r\n    if (!submission) {\r\n      return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    }\r\n    const treeOrg = submission.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && treeOrg && treeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette soumission' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer toutes les lignes de donn\u00C3\u00A9es avec type du n\u00C5\u201Cud\r\n    const dataRows = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId: id },\r\n      include: {\r\n        TreeBranchLeafNode: { select: { id: true, type: true, label: true } }\r\n      }\r\n    });\r\n\r\n    const isFilled = (v: string | null) => v != null && String(v).trim() !== '';\r\n\r\n    const total = dataRows.length;\r\n    const filled = dataRows.filter(r => isFilled(r.value)).length;\r\n    const empty = total - filled;\r\n\r\n    const optionRows = dataRows.filter(r => {\r\n      const node = r.TreeBranchLeafNode as { type?: unknown } | null | undefined;\r\n      const t = node?.type;\r\n      return t === 'leaf_option_field' || t === 'option_field' || t === 5;\r\n    });\r\n    const optionTotal = optionRows.length;\r\n    const optionFilled = optionRows.filter(r => isFilled(r.value)).length;\r\n    const optionEmpty = optionTotal - optionFilled;\r\n\r\n    const variablesTotal = dataRows.filter(r => r.isVariable === true).length;\r\n\r\n    // Ratio compl\u00C3\u00A9tion simple\r\n    const completion = total > 0 ? Math.round((filled / total) * 100) : 0;\r\n\r\n    return res.json({\r\n      submissionId: id,\r\n      treeId: submission.treeId,\r\n      status: submission.status,\r\n      updatedAt: submission.updatedAt,\r\n      counts: {\r\n        total,\r\n        filled,\r\n        empty,\r\n        optionFields: { total: optionTotal, filled: optionFilled, empty: optionEmpty },\r\n        variables: { total: variablesTotal }\r\n      },\r\n      completion\r\n    });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur GET /submissions/:id/summary:', error);\r\n    return res.status(500).json({ error: 'Erreur lors du calcul du r\u00C3\u00A9sum\u00C3\u00A9 de la soumission' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/submissions/:id/operations - Timeline d\u00C3\u00A9taill\u00C3\u00A9e des op\u00C3\u00A9rations/data\r\nrouter.get('/submissions/:id/operations', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // Charger la soumission pour contr\u00C3\u00B4le d'acc\u00C3\u00A8s\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      select: { \r\n        id: true, \r\n        treeId: true,\r\n        TreeBranchLeafTree: { select: { id: true, organizationId: true } } \r\n      }\r\n    });\r\n    if (!submission) return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    const treeOrg = submission.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && treeOrg && treeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette soumission' });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer toutes les data rows enrichies\r\n    const rows = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId: id },\r\n      include: {\r\n        TreeBranchLeafNode: { select: { id: true, label: true, type: true } }\r\n      },\r\n      // TreeBranchLeafSubmissionData n'a pas de colonne updatedAt -> trier par lastResolved puis createdAt\r\n      orderBy: [\r\n        { lastResolved: 'desc' },\r\n        { createdAt: 'desc' }\r\n      ]\r\n    });\r\n\r\n    // \u00F0\u0178\u017D\u00AF AJOUT CRUCIAL: Si pas de donn\u00C3\u00A9es de soumission, r\u00C3\u00A9cup\u00C3\u00A9rer les variables configur\u00C3\u00A9es pour l'arbre\r\n    if (rows.length === 0) {\r\n      console.log(`[TBL Operations] Aucune donn\u00C3\u00A9e de soumission trouv\u00C3\u00A9e pour ${id}, r\u00C3\u00A9cup\u00C3\u00A9ration des variables configur\u00C3\u00A9es...`);\r\n      \r\n      if (submission?.treeId) {\r\n        const treeVariables = await prisma.treeBranchLeafNodeVariable.findMany({\r\n          where: { TreeBranchLeafNode: { treeId: submission.treeId } },\r\n          select: {\r\n            id: true,\r\n            nodeId: true,\r\n            exposedKey: true,\r\n            displayName: true,\r\n            unit: true,\r\n            defaultValue: true,\r\n            fixedValue: true,\r\n            sourceRef: true,\r\n            TreeBranchLeafNode: { select: { id: true, label: true, type: true } }\r\n          }\r\n        });\r\n        \r\n        // Cr\u00C3\u00A9er des pseudo-rows pour les variables configur\u00C3\u00A9es\r\n        const pseudoRows = treeVariables.map(v => ({\r\n          nodeId: v.nodeId,\r\n          submissionId: id,\r\n          isVariable: true,\r\n          fieldLabel: v.TreeBranchLeafNode?.label || null,\r\n        variableDisplayName: v.displayName,\r\n        variableKey: v.exposedKey,\r\n        variableUnit: v.unit,\r\n        sourceRef: v.sourceRef,\r\n        // \u00F0\u0178\u017D\u00AF CORRECTION: Utiliser fixedValue ou defaultValue comme valeur\r\n        // \u00F0\u0178\u0161\u00A7 TEMPORAIRE: Valeurs de test hardcod\u00C3\u00A9es pour validation\r\n        value: getTestValueForNode(v.nodeId, v.fixedValue, v.defaultValue),\r\n        operationSource: null,\r\n        operationDetail: null,\r\n        operationResult: null,\r\n        lastResolved: null,\r\n        createdAt: new Date(),\r\n        TreeBranchLeafNode: v.TreeBranchLeafNode\r\n      }));\r\n      \r\n      console.log(`[TBL Operations] ${pseudoRows.length} variables configur\u00C3\u00A9es trouv\u00C3\u00A9es`);\r\n      console.log(`[TBL Operations] Variables avec valeurs:`, pseudoRows.map(r => ({ nodeId: r.nodeId, label: r.fieldLabel, value: r.value })));\r\n      console.log(`[TBL Operations] Variables brutes:`, treeVariables.map(v => ({ nodeId: v.nodeId, displayName: v.displayName, fixedValue: v.fixedValue, defaultValue: v.defaultValue })));\r\n      rows.push(...pseudoRows);\r\n      }\r\n    }\r\n\r\n    const inferSource = (sourceRef?: string | null): 'formula' | 'condition' | 'table' | 'neutral' => {\r\n      const s = (sourceRef || '').toLowerCase();\r\n      if (s.includes('formula') || s.includes('formule')) return 'formula';\r\n      if (s.includes('condition')) return 'condition';\r\n      if (s.includes('table')) return 'table';\r\n      return 'neutral';\r\n    };\r\n\r\n    // \u00F0\u0178\u017D\u00AF CORRECTION MAJEURE: R\u00C3\u00A9cup\u00C3\u00A9rer TOUS les labels de l'arbre d'abord\r\n    const treeId = submission?.treeId;\r\n    if (!treeId) {\r\n      return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    }\r\n    \r\n    const allTreeNodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: { treeId },\r\n      select: { id: true, label: true }\r\n    });\r\n    \r\n    // Pr\u00C3\u00A9parer des maps pour labels et valeurs de la soumission\r\n    // Commencer avec TOUS les labels de l'arbre\r\n    const labelMap: LabelMap = new Map(allTreeNodes.map(n => [n.id, n.label || null]));\r\n    const valuesMap: ValuesMap = new Map(rows.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n    \r\n    // Compl\u00C3\u00A9ter avec les labels sp\u00C3\u00A9cifiques de la soumission si pr\u00C3\u00A9sents\r\n    for (const r of rows) {\r\n      const nodeLabel = r.TreeBranchLeafNode?.label || r.fieldLabel;\r\n      if (nodeLabel && nodeLabel !== labelMap.get(r.nodeId)) {\r\n        labelMap.set(r.nodeId, nodeLabel);\r\n      }\r\n    }\r\n\r\n    // Helper: assurer que labelMap contient les labels pour une liste d'IDs de n\u00C5\u201Cuds\r\n    const ensureNodeLabels = async (ids: Set<string> | string[]) => {\r\n      const list = Array.isArray(ids) ? ids : Array.from(ids);\r\n      const missing = list.filter(id => !!id && !labelMap.has(id));\r\n      if (missing.length === 0) return;\r\n      const extra = await prisma.treeBranchLeafNode.findMany({ where: { id: { in: missing } }, select: { id: true, label: true } });\r\n      for (const n of extra) labelMap.set(n.id, n.label || null);\r\n    };\r\n\r\n    // Helper de normalisation de l'op\u00C3\u00A9ration d\u00C3\u00A9taill\u00C3\u00A9e par ligne\r\n    const resolveDetailForRow = async (r: typeof rows[number]) => {\r\n      const det = r.operationDetail as unknown as { type?: string; conditionSet?: unknown; tokens?: unknown; id?: string; name?: string; nodeId?: string } | null;\r\n      // Si c'est un objet avec type mais payload potentiellement incomplet (ou stringifi\u00C3\u00A9 depuis .NET), recharger depuis la sourceRef\r\n      if (det && det.type) {\r\n        const parsed = parseSourceRef(r.sourceRef);\r\n        if (parsed?.type === 'condition') {\r\n          const rec = await prisma.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, conditionSet: true, nodeId: true } });\r\n          return buildOperationDetail('condition', rec) as unknown as Record<string, unknown>;\r\n        }\r\n        if (parsed?.type === 'formula') {\r\n          const rec = await prisma.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, tokens: true, nodeId: true } });\r\n          return buildOperationDetail('formula', rec) as unknown as Record<string, unknown>;\r\n        }\r\n        if (parsed?.type === 'table') {\r\n          const rec = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n          return buildOperationDetail('table', rec) as unknown as Record<string, unknown>;\r\n        }\r\n        return det; // laisser tel quel si pas de sourceRef exploitable\r\n      }\r\n      // Sinon, tenter via sourceRef\r\n      const parsed = parseSourceRef(r.sourceRef);\r\n      if (!parsed) return det || null;\r\n      if (parsed.type === 'condition') {\r\n        const rec = await prisma.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, conditionSet: true, nodeId: true } });\r\n        return buildOperationDetail('condition', rec) as unknown as Record<string, unknown>;\r\n      }\r\n      if (parsed.type === 'formula') {\r\n        const rec = await prisma.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, tokens: true, nodeId: true } });\r\n        return buildOperationDetail('formula', rec) as unknown as Record<string, unknown>;\r\n      }\r\n      if (parsed.type === 'table') {\r\n        const rec = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n        return buildOperationDetail('table', rec) as unknown as Record<string, unknown>;\r\n      }\r\n      return det || null;\r\n    };\r\n\r\n  const items = await Promise.all(rows.map(async r => {\r\n      const nodeLabel = r.fieldLabel || r.TreeBranchLeafNode?.label || labelMap.get(r.nodeId) || null;\r\n      const unit = r.variableUnit || null;\r\n      const val = r.value == null ? null : String(r.value);\r\n      const displayName = r.variableDisplayName || nodeLabel;\r\n      const response = val;\r\n\r\n      const source: 'formula' | 'condition' | 'table' | 'neutral' = r.isVariable ? inferSource(r.sourceRef) : 'neutral';\r\n      // Pr\u00C3\u00A9f\u00C3\u00A9rer l'objet d\u00C3\u00A9taill\u00C3\u00A9 stock\u00C3\u00A9 si pr\u00C3\u00A9sent, sinon fallback\r\n      const operationDetail = (r.operationDetail as unknown) ?? (r.isVariable ? (r.sourceRef || undefined) : (nodeLabel || undefined));\r\n      const labelForResult = displayName || nodeLabel || labelMap.get(r.nodeId) || r.TreeBranchLeafNode?.id || '\u00E2\u20AC\u201D';\r\n      const operationResult = unit && response ? `${labelForResult}: ${response} ${unit}` : `${labelForResult}: ${response ?? ''}`;\r\n\r\n      // R\u00C3\u00A9soudre l\u00E2\u20AC\u2122objet d\u00C3\u00A9taill\u00C3\u00A9 si absent/incomplet\r\n      const detNormalized = await resolveDetailForRow(r);\r\n      // R\u00C3\u00A9solution d\u00C3\u00A9taill\u00C3\u00A9e pour l\u00E2\u20AC\u2122affichage (labels + valeurs)\r\n  let operationDetailResolved: Prisma.InputJsonValue | undefined = undefined;\r\n  let operationResultResolved: Prisma.InputJsonValue | undefined = undefined;\r\n  let operationHumanText: string | undefined = undefined;\r\n  const det = detNormalized as { type?: string; conditionSet?: unknown; tokens?: unknown; id?: string; name?: string; nodeId?: string } | null;\r\n        if (det && det.type) {\r\n        if (det.type === 'condition') {\r\n          const set = det.conditionSet;\r\n          const refIds = extractNodeIdsFromConditionSet(set);\r\n          await ensureNodeLabels(refIds);\r\n          const _resolvedRefs = buildResolvedRefs(refIds, labelMap, valuesMap);\r\n          // \u00F0\u0178\u00A7\u00A0 Am\u00C3\u00A9lioration: certaines actions r\u00C3\u00A9f\u00C3\u00A9rencent node-formula:<id> \u00E2\u2020\u2019 retrouver le label du n\u00C5\u201Cud de cette formule\r\n          const extendLabelsWithFormulas = async (conditionSet: unknown, baseLabels: LabelMap): Promise<LabelMap> => {\r\n            const extended = new Map(baseLabels);\r\n            try {\r\n              const str = JSON.stringify(conditionSet) || '';\r\n              const ids = new Set<string>();\r\n              let m: RegExpExecArray | null;\r\n              const re = /node-formula:([a-f0-9-]{36})/gi;\r\n              while ((m = re.exec(str)) !== null) ids.add(m[1]);\r\n              if (ids.size === 0) return extended;\r\n              const list = Array.from(ids);\r\n              const formulas = await prisma.treeBranchLeafNodeFormula.findMany({ where: { id: { in: list } }, select: { id: true, nodeId: true } });\r\n              for (const f of formulas) {\r\n                const nodeLbl = labelMap.get(f.nodeId) ?? null;\r\n                if (nodeLbl) extended.set(f.id, nodeLbl);\r\n              }\r\n            } catch {\r\n              // ignore parse/query errors for label extension\r\n            }\r\n            return extended;\r\n          };\r\n          const labelsForText = await extendLabelsWithFormulas(set, labelMap);\r\n          // Essayer aussi de r\u00C3\u00A9soudre les actions -> labels\r\n          const setObj = (set && typeof set === 'object') ? (set as Record<string, unknown>) : {};\r\n          const branches = Array.isArray(setObj.branches) ? (setObj.branches as unknown[]) : [];\r\n          const _branchesResolved = branches.map(b => {\r\n            const bb = b as Record<string, unknown>;\r\n            const actions = bb.actions as unknown[] | undefined;\r\n            return {\r\n              label: (bb.label as string) || null,\r\n              when: bb.when || null,\r\n              actions: resolveActionsLabels(actions, labelsForText)\r\n            };\r\n          });\r\n          // \u00F0\u0178\u0161\u00AB D\u00C3\u00A9sactiv\u00C3\u00A9: buildConditionExpressionReadable - tout passe par TBL Prisma !\r\n          operationHumanText = '\u00F0\u0178\u201D\u201E Condition \u00C3\u00A9valu\u00C3\u00A9e via TBL Prisma (ligne 4755)';\r\n          \r\n          // \u00F0\u0178\u017D\u00AF NOUVELLE LOGIQUE: Utiliser buildDetailAndResultForOperation pour persister en base\r\n          const { detail, result } = buildDetailAndResultForOperation(det, operationHumanText, unit, labelForResult, response);\r\n          operationDetailResolved = detail;\r\n          operationResultResolved = result;\r\n        } else if (det.type === 'formula') {\r\n          const refIds = extractNodeIdsFromTokens(det.tokens);\r\n          await ensureNodeLabels(refIds);\r\n          const _resolvedRefs = buildResolvedRefs(refIds, labelMap, valuesMap);\r\n          {\r\n            let expr = buildTextFromTokens(det.tokens, labelMap, valuesMap);\r\n            operationHumanText = expr;\r\n          }\r\n          \r\n          // \u00F0\u0178\u017D\u00AF NOUVELLE LOGIQUE: Utiliser buildDetailAndResultForOperation pour persister en base\r\n          const { detail, result } = buildDetailAndResultForOperation(det, operationHumanText, unit, labelForResult, response);\r\n          operationDetailResolved = detail;\r\n          operationResultResolved = result;\r\n        } else if (det.type === 'table') {\r\n          // Tables: on peut juste renvoyer la structure et les ids concern\u00C3\u00A9s si pr\u00C3\u00A9sents dans type/description\r\n          const refIds = new Set<string>();\r\n          const str = JSON.stringify(det);\r\n          if (str) {\r\n            let m: RegExpExecArray | null;\r\n            const re = /@value\\.([a-f0-9-]{36})/gi;\r\n            while ((m = re.exec(str)) !== null) refIds.add(m[1]);\r\n          }\r\n          await ensureNodeLabels(refIds);\r\n          {\r\n            const expr = buildTextFromTableRecord(det, labelMap, valuesMap);\r\n            const unitSuffix = unit ? ` ${unit}` : '';\r\n            operationHumanText = expr ? `${expr} (=) ${labelForResult} (${response ?? ''}${unitSuffix})` : `${labelForResult} (${response ?? ''}${unitSuffix})`;\r\n          }\r\n          \r\n          // \u00F0\u0178\u017D\u00AF NOUVELLE LOGIQUE: Utiliser buildDetailAndResultForOperation pour persister en base\r\n          const { detail, result } = buildDetailAndResultForOperation(det, operationHumanText, unit, labelForResult, response);\r\n          operationDetailResolved = detail;\r\n          operationResultResolved = result;\r\n        }\r\n      }\r\n\r\n      return {\r\n        nodeId: r.nodeId,\r\n        isVariable: r.isVariable,\r\n        fieldLabel: nodeLabel,\r\n        variableDisplayName: r.variableDisplayName || null,\r\n        variableKey: r.variableKey || null,\r\n        unit,\r\n        sourceRef: r.sourceRef || null,\r\n    operationSource: source,\r\n    operationDetail: operationDetailResolved || detNormalized || operationDetail,\r\n  operationResult: operationResultResolved || operationResult,\r\n  // Pour les conditions, operationHumanText contient d\u00C3\u00A9j\u00C3\u00A0 l'expression compl\u00C3\u00A8te souhait\u00C3\u00A9e\r\n  operationResultText: operationHumanText ? operationHumanText : null,\r\n        operationResultResolved,\r\n        operationDetailResolved,\r\n        response,\r\n        lastResolved: r.lastResolved,\r\n      };\r\n    }));\r\n\r\n    return res.json({ submissionId: id, items });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur GET /submissions/:id/operations:', error);\r\n    return res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des op\u00C3\u00A9rations' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/submissions/:id/repair-ops - Backfill operationDetail/operationResult/lastResolved pour une soumission\r\nrouter.post('/submissions/:id/repair-ops', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // Charger la soumission pour contr\u00C3\u00B4le d'acc\u00C3\u00A8s\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n    });\r\n    if (!submission) return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    const treeId = submission.treeId;\r\n    const treeOrg = submission.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && treeOrg && treeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette soumission' });\r\n    }\r\n\r\n    // Pr\u00C3\u00A9parer les m\u00C3\u00A9tadonn\u00C3\u00A9es n\u00C3\u00A9cessaires\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId }, select: { id: true, label: true } });\r\n    const labelMap = new Map(nodes.map(n => [n.id, n.label]));\r\n    const variables = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      where: { TreeBranchLeafNode: { treeId } },\r\n      include: { TreeBranchLeafNode: { select: { label: true } } }\r\n    });\r\n    const varMetaByNodeId = new Map(\r\n      variables.map(v => [\r\n        v.nodeId,\r\n        {\r\n          displayName: v.displayName || v.TreeBranchLeafNode?.label || v.exposedKey || v.nodeId,\r\n          unit: v.unit || null,\r\n          sourceRef: v.sourceRef || null\r\n        }\r\n      ])\r\n    );\r\n\r\n    const inferSource = (sourceRef?: string | null): 'formula' | 'condition' | 'table' | 'neutral' => {\r\n      const s = (sourceRef || '').toLowerCase();\r\n      if (s.includes('formula') || s.includes('formule')) return 'formula';\r\n      if (s.includes('condition')) return 'condition';\r\n      if (s.includes('table')) return 'table';\r\n      return 'neutral';\r\n    };\r\n\r\n    const rows = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId: id },\r\n      select: { nodeId: true, isVariable: true, value: true, sourceRef: true }\r\n    });\r\n    // Carte de toutes les valeurs pr\u00C3\u00A9sentes dans la soumission (pour r\u00C3\u00A9solution des refs)\r\n    const submissionValues = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId: id },\r\n      select: { nodeId: true, value: true }\r\n    });\r\n    const valuesMapAll: ValuesMap = new Map(submissionValues.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n    const now = new Date();\r\n    for (const row of rows) {\r\n      const isVar = row.isVariable;\r\n      const meta = isVar ? varMetaByNodeId.get(row.nodeId) : undefined;\r\n      const label = labelMap.get(row.nodeId) || undefined;\r\n      const valueStr = row.value == null ? null : String(row.value);\r\n      const opSrc = isVar ? inferSource(meta?.sourceRef || null) : 'neutral';\r\n      const display = isVar ? (meta?.displayName || label || row.nodeId) : (label || row.nodeId);\r\n      // Par d\u00C3\u00A9faut, r\u00C3\u00A9sultat lisible\r\n      let opRes: Prisma.InputJsonValue = meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n      // R\u00C3\u00A9soudre operationDetail si variable et sourceRef\r\n      let opDetail: Prisma.InputJsonValue | undefined = undefined;\r\n      const parsed = parseSourceRef(row.sourceRef);\r\n      if (isVar && parsed) {\r\n        if (parsed.type === 'condition') {\r\n          const rec = await prisma.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, conditionSet: true, nodeId: true } });\r\n          const { detail, result } = await buildDetailAndResultForOperation('condition', rec, display, valueStr, meta?.unit || null, labelMap, valuesMapAll, prisma, id, organizationId || '', req.user?.id || '');\r\n          opDetail = detail;\r\n          opRes = result;\r\n        } else if (parsed.type === 'formula') {\r\n          const rec = await prisma.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, tokens: true, nodeId: true } });\r\n          const { detail, result } = await buildDetailAndResultForOperation('formula', rec, display, valueStr, meta?.unit || null, labelMap, valuesMapAll, prisma, id, organizationId || '', req.user?.id || '');\r\n          opDetail = detail;\r\n          opRes = result;\r\n        } else if (parsed.type === 'table') {\r\n          const rec = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n          const { detail, result } = await buildDetailAndResultForOperation('table', rec, display, valueStr, meta?.unit || null, labelMap, valuesMapAll, prisma, id, organizationId || '', req.user?.id || '');\r\n          opDetail = detail;\r\n          opRes = result;\r\n        }\r\n      }\r\n      await prisma.treeBranchLeafSubmissionData.updateMany({\r\n        where: { submissionId: id, nodeId: row.nodeId },\r\n        data: {\r\n          operationSource: opSrc,\r\n          // Fallback prioritaire: row.sourceRef (pr\u00C3\u00A9sent c\u00C3\u00B4t\u00C3\u00A9 submissionData), puis meta.sourceRef, sinon label\r\n          operationDetail: isVar ? (opDetail ?? (row.sourceRef || meta?.sourceRef || undefined)) : (label || undefined),\r\n          operationResult: opRes,\r\n          lastResolved: now\r\n        }\r\n      });\r\n    }\r\n\r\n    return res.json({ success: true, updated: rows.length });\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur POST /submissions/:id/repair-ops:', error);\r\n    return res.status(500).json({ error: 'Erreur lors du backfill des op\u00C3\u00A9rations' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/submissions - Cr\u00C3\u00A9er une nouvelle soumission\r\nrouter.post('/submissions', async (req, res) => {\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n  const userId = (req.user as { id?: string })?.id;\r\n  const { treeId, leadId, name, data } = req.body as { treeId?: string; leadId?: string | null; name?: string; data?: unknown };\r\n\r\n  // Normalisation des types attendus c\u00C3\u00B4t\u00C3\u00A9 DB (ids sous forme de cha\u00C3\u00AEnes)\r\n  const normalizedTreeId: string = treeId != null ? String(treeId) : '';\r\n  const normalizedLeadId: string | null = leadId != null && leadId !== '' ? String(leadId) : null;\r\n\r\n  try {\r\n    const approxBytes = (() => {\r\n      try { return JSON.stringify(data)?.length ?? 0; } catch { return 0; }\r\n    })();\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 POST nouvelle soumission (entr\u00C3\u00A9e)`, {\r\n      treeId: normalizedTreeId,\r\n      leadId: normalizedLeadId,\r\n      providedName: name,\r\n      dataKeys: Object.keys(data),\r\n      approxBytes,\r\n      userId,\r\n      organizationId,\r\n      isSuperAdmin\r\n    });\r\n\r\n    // Validation des param\u00C3\u00A8tres requis\r\n    if (!normalizedTreeId) {\r\n      return res.status(400).json({ error: 'treeId est requis' });\r\n    }\r\n    // L'utilisateur peut \u00C3\u00AAtre mock\u00C3\u00A9 et ne pas exister en DB; on ne bloque pas la cr\u00C3\u00A9ation\r\n    if (!userId) {\r\n      console.warn('[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Aucun userId dans la requ\u00C3\u00AAte (mode anonyme/mock) \u00E2\u20AC\u201C poursuite sans liaison utilisateur');\r\n    }\r\n    // LeadId est optionnel - peut \u00C3\u00AAtre undefined pour des devis sans lead associ\u00C3\u00A9\r\n    if (!name || typeof name !== 'string') {\r\n      return res.status(400).json({ error: 'name est requis et doit \u00C3\u00AAtre une cha\u00C3\u00AEne' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que l'arbre existe et appartient \u00C3\u00A0 l'organisation\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: { \r\n        id: normalizedTreeId,\r\n        ...(isSuperAdmin ? {} : { organizationId })\r\n      }\r\n    });\r\n\r\n    if (!tree) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Arbre ${treeId} non trouv\u00C3\u00A9 ou acc\u00C3\u00A8s refus\u00C3\u00A9`);\r\n      return res.status(404).json({ error: 'Arbre non trouv\u00C3\u00A9 ou acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier que le lead existe et appartient \u00C3\u00A0 l'organisation (seulement si leadId fourni)\r\n    let lead = null;\r\n    if (normalizedLeadId) {\r\n      lead = await prisma.lead.findFirst({\r\n        where: { \r\n          id: normalizedLeadId,\r\n          ...(isSuperAdmin ? {} : { organizationId })\r\n        }\r\n      });\r\n\r\n      if (!lead) {\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Lead ${leadId} non trouv\u00C3\u00A9 ou acc\u00C3\u00A8s refus\u00C3\u00A9`);\r\n        return res.status(404).json({ error: 'Lead non trouv\u00C3\u00A9 ou acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n      }\r\n    } else {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u201E\u00B9\u00EF\u00B8\u008F Cr\u00C3\u00A9ation de soumission sans lead associ\u00C3\u00A9`);\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer les n\u00C5\u201Cuds valides pour ce tree pour valider les nodeIds\r\n    const validNodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: { treeId: normalizedTreeId },\r\n      select: { id: true }\r\n    });\r\n    const validNodeIds = new Set(validNodes.map(node => node.id));\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 N\u00C5\u201Cuds valides trouv\u00C3\u00A9s: ${validNodeIds.size}`);\r\n\r\n    // Normaliser le payload data (accepte objet { nodeId: value } OU tableau [{ nodeId, value, calculatedValue }])\r\n    type DataItem = { nodeId: string; value?: unknown; calculatedValue?: unknown };\r\n    const rawEntries: DataItem[] = (() => {\r\n      if (Array.isArray(data)) {\r\n        return (data as unknown[])\r\n          .map((it): DataItem | null => {\r\n            if (it && typeof it === 'object' && 'nodeId' in (it as Record<string, unknown>)) {\r\n              const obj = it as Record<string, unknown>;\r\n              return { nodeId: String(obj.nodeId), value: obj.value, calculatedValue: obj.calculatedValue };\r\n            }\r\n            return null;\r\n          })\r\n          .filter((x): x is DataItem => !!x);\r\n      }\r\n      if (data && typeof data === 'object') {\r\n        return Object.entries(data as Record<string, unknown>).map(([nodeId, value]) => ({ nodeId, value }));\r\n      }\r\n      return [];\r\n    })();\r\n\r\n    // Filtrer par nodeIds valides\r\n    const filteredEntries = rawEntries.filter(({ nodeId }) => {\r\n      const isValid = validNodeIds.has(nodeId);\r\n      if (!isValid) console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F NodeId invalide ignor\u00C3\u00A9: ${nodeId}`);\r\n      return isValid;\r\n    });\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 Donn\u00C3\u00A9es filtr\u00C3\u00A9es: ${filteredEntries.length}/${rawEntries.length}`);\r\n\r\n    // Cr\u00C3\u00A9er la soumission avec Prisma (fiable pour les JSON et enums)\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u00A7 Cr\u00C3\u00A9ation Prisma de la soumission`);\r\n\r\n    try {\r\n      // V\u00C3\u00A9rifier l'existence de l'utilisateur en base pour \u00C3\u00A9viter une violation de FK\r\n      let safeUserId: string | null = null;\r\n      if (userId) {\r\n        try {\r\n          const existingUser = await prisma.user.findUnique({ where: { id: userId } });\r\n          if (existingUser) {\r\n            safeUserId = userId;\r\n          } else {\r\n            console.warn('[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F userId fourni mais introuvable en base \u00E2\u20AC\u201C cr\u00C3\u00A9ation avec userId NULL');\r\n          }\r\n        } catch (checkErr) {\r\n          console.warn('[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F \u00C3\u2030chec de v\u00C3\u00A9rification userId \u00E2\u20AC\u201C cr\u00C3\u00A9ation avec userId NULL:', (checkErr as Error)?.message);\r\n        }\r\n      }\r\n\r\n      const now = new Date();\r\n      const created = await prisma.treeBranchLeafSubmission.create({\r\n        data: {\r\n          id: randomUUID(),\r\n          treeId: normalizedTreeId,\r\n          userId: safeUserId,\r\n          leadId: normalizedLeadId,\r\n          status: 'draft',\r\n          updatedAt: now\r\n        }\r\n      });\r\n\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Soumission cr\u00C3\u00A9\u00C3\u00A9e: ${created.id}`);\r\n\r\n      // 2. Persister toutes les valeurs de champs re\u00C3\u00A7ues (y compris champs conditionnels)\r\n      if (filteredEntries.length > 0) {\r\n        // R\u00C3\u00A9cup\u00C3\u00A9rer les \u00C3\u00A9tiquettes des n\u00C5\u201Cuds pour les enregistrements cr\u00C3\u00A9\u00C3\u00A9s\r\n        const keys = filteredEntries.map(({ nodeId }) => nodeId);\r\n        const nodesForLabels = await prisma.treeBranchLeafNode.findMany({\r\n          where: { id: { in: keys as string[] } },\r\n          select: { id: true, label: true }\r\n        });\r\n        const labelMap = new Map(nodesForLabels.map(n => [n.id, n.label]));\r\n\r\n        // Charger les enregistrements existants (par ex. variables auto-cr\u00C3\u00A9\u00C3\u00A9es par trigger)\r\n        const existing = await prisma.treeBranchLeafSubmissionData.findMany({\r\n          where: { submissionId: created.id, nodeId: { in: keys as string[] } },\r\n          select: { nodeId: true }\r\n        });\r\n        const existingSet = new Set(existing.map(e => e.nodeId));\r\n\r\n        const toCreate = filteredEntries.filter(({ nodeId }) => !existingSet.has(nodeId));\r\n        const toUpdate = filteredEntries.filter(({ nodeId }) => existingSet.has(nodeId));\r\n\r\n        await prisma.$transaction(async (tx) => {\r\n          if (toCreate.length > 0) {\r\n            await tx.treeBranchLeafSubmissionData.createMany({\r\n              data: toCreate.map(({ nodeId, value: raw }) => ({\r\n                id: randomUUID(),\r\n                submissionId: created.id,\r\n                nodeId,\r\n                value: raw == null ? null : String(raw),\r\n                fieldLabel: labelMap.get(nodeId) || null,\r\n                isVariable: false\r\n              }))\r\n            });\r\n          }\r\n          if (toUpdate.length > 0) {\r\n            // Mettre \u00C3\u00A0 jour la valeur existante (une requ\u00C3\u00AAte par nodeId)\r\n            for (const { nodeId, value: raw } of toUpdate) {\r\n              try {\r\n                await tx.treeBranchLeafSubmissionData.update({\r\n                  where: { submissionId_nodeId: { submissionId: created.id, nodeId } },\r\n                  data: { value: raw == null ? null : String(raw), fieldLabel: labelMap.get(nodeId) || undefined }\r\n                });\r\n              } catch {\r\n                // Si le client Prisma n'expose pas la cl\u00C3\u00A9 compos\u00C3\u00A9e, fallback en updateMany\r\n                await tx.treeBranchLeafSubmissionData.updateMany({\r\n                  where: { submissionId: created.id, nodeId },\r\n                  data: { value: raw == null ? null : String(raw), fieldLabel: labelMap.get(nodeId) || undefined }\r\n                });\r\n              }\r\n            }\r\n          }\r\n        });\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Champs persist\u00C3\u00A9s: create=${toCreate.length}, update=${toUpdate.length}`);\r\n      } else {\r\n        console.log('[TreeBranchLeaf API] \u00E2\u201E\u00B9\u00EF\u00B8\u008F Aucun champ utilisateur \u00C3\u00A0 persister (payload data vide apr\u00C3\u00A8s filtrage)');\r\n      }\r\n\r\n      // 3. Enrichir imm\u00C3\u00A9diatement les m\u00C3\u00A9tadonn\u00C3\u00A9es d'op\u00C3\u00A9ration pour cette soumission (backfill rapide post-cr\u00C3\u00A9ation)\r\n      try {\r\n        const treeIdForBackfill = created.treeId;\r\n        const [nodesForBackfill, varsForBackfill] = await Promise.all([\r\n          prisma.treeBranchLeafNode.findMany({ where: { treeId: treeIdForBackfill }, select: { id: true, label: true } }),\r\n          prisma.treeBranchLeafNodeVariable.findMany({ where: { TreeBranchLeafNode: { treeId: treeIdForBackfill } }, include: { TreeBranchLeafNode: { select: { label: true } } } })\r\n        ]);\r\n        const labelMapBF = new Map(nodesForBackfill.map(n => [n.id, n.label]));\r\n        const varMetaByNodeIdBF = new Map(\r\n          varsForBackfill.map(v => [\r\n            v.nodeId,\r\n            {\r\n              displayName: v.displayName || v.TreeBranchLeafNode?.label || v.exposedKey || v.nodeId,\r\n              unit: v.unit || null,\r\n              sourceRef: v.sourceRef || null\r\n            }\r\n          ])\r\n        );\r\n        const rowsBF = await prisma.treeBranchLeafSubmissionData.findMany({\r\n          where: { submissionId: created.id },\r\n          select: { nodeId: true, isVariable: true, value: true, sourceRef: true }\r\n        });\r\n        // Construire une map de toutes les valeurs pour r\u00C3\u00A9solution des r\u00C3\u00A9f\u00C3\u00A9rences\r\n        const valuesMapBF: ValuesMap = new Map(rowsBF.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n        const nowBF = new Date();\r\n        for (const row of rowsBF) {\r\n          if (!row.isVariable) continue;\r\n          const meta = varMetaByNodeIdBF.get(row.nodeId);\r\n          const label = labelMapBF.get(row.nodeId) || undefined;\r\n          const valueStr = row.value == null ? null : String(row.value);\r\n          const opSrc = (() => {\r\n            const s = (meta?.sourceRef || '').toLowerCase();\r\n            if (s.includes('formula') || s.includes('formule')) return 'formula' as const;\r\n            if (s.includes('condition')) return 'condition' as const;\r\n            if (s.includes('table')) return 'table' as const;\r\n            return 'neutral' as const;\r\n          })();\r\n          const display = meta?.displayName || label || row.nodeId;\r\n          // Par d\u00C3\u00A9faut cha\u00C3\u00AEne lisible, remplac\u00C3\u00A9e par JSON si on peut r\u00C3\u00A9soudre la source\r\n          let opRes: Prisma.InputJsonValue = meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n          // R\u00C3\u00A9soudre operationDetail\r\n          let opDetail: Prisma.InputJsonValue | undefined = undefined;\r\n          const parsed = parseSourceRef(row.sourceRef || meta?.sourceRef || null);\r\n          if (parsed) {\r\n            if (parsed.type === 'condition') {\r\n              const rec = await prisma.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, conditionSet: true, nodeId: true } });\r\n              const { detail, result } = await buildDetailAndResultForOperation('condition', rec, display, valueStr, meta?.unit || null, labelMapBF, valuesMapBF, prisma, created.id, organizationId || '', userId || '');\r\n              opDetail = detail;\r\n              opRes = result;\r\n            } else if (parsed.type === 'formula') {\r\n              const rec = await prisma.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, tokens: true, nodeId: true } });\r\n              const { detail, result } = await buildDetailAndResultForOperation('formula', rec, display, valueStr, meta?.unit || null, labelMapBF, valuesMapBF, prisma, created.id, organizationId || '', userId || '');\r\n              opDetail = detail;\r\n              opRes = result;\r\n            } else if (parsed.type === 'table') {\r\n              const rec = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n              const { detail, result } = await buildDetailAndResultForOperation('table', rec, display, valueStr, meta?.unit || null, labelMapBF, valuesMapBF, prisma, created.id, organizationId || '', userId || '');\r\n              opDetail = detail;\r\n              opRes = result;\r\n            }\r\n          }\r\n          await prisma.treeBranchLeafSubmissionData.updateMany({\r\n            where: { submissionId: created.id, nodeId: row.nodeId },\r\n            data: {\r\n              operationSource: opSrc,\r\n              operationDetail: opDetail ?? (row.sourceRef || meta?.sourceRef || undefined),\r\n              operationResult: opRes,\r\n              lastResolved: nowBF\r\n            }\r\n          });\r\n        }\r\n      } catch (enrichErr) {\r\n        console.warn('[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Backfill post-cr\u00C3\u00A9ation des op\u00C3\u00A9rations non critique a \u00C3\u00A9chou\u00C3\u00A9:', (enrichErr as Error)?.message);\r\n      }\r\n\r\n      // 4. Recharger la soumission compl\u00C3\u00A8te pour la r\u00C3\u00A9ponse\r\n      const full = await prisma.treeBranchLeafSubmission.findUnique({\r\n        where: { id: created.id },\r\n        include: {\r\n          TreeBranchLeafTree: { select: { id: true, name: true } },\r\n          Lead: { select: { id: true, firstName: true, lastName: true, email: true } },\r\n          TreeBranchLeafSubmissionData: {\r\n            include: {\r\n              TreeBranchLeafNode: { select: { id: true, label: true, type: true } }\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      if (!full) {\r\n        throw new Error('Soumission non trouv\u00C3\u00A9e apr\u00C3\u00A8s cr\u00C3\u00A9ation');\r\n      }\r\n\r\n      const responsePayload = {\r\n        id: full.id,\r\n        treeId: full.treeId,\r\n        userId: full.userId,\r\n        leadId: full.leadId,\r\n        status: full.status,\r\n        summary: full.summary,\r\n        updatedAt: full.updatedAt,\r\n        TreeBranchLeafTree: full.TreeBranchLeafTree,\r\n        Lead: full.Lead || null,\r\n        TreeBranchLeafSubmissionData: full.TreeBranchLeafSubmissionData\r\n      };\r\n\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Devis cr\u00C3\u00A9\u00C3\u00A9 et recharg\u00C3\u00A9: ${full.id}`);\r\n      res.status(201).json(responsePayload);\r\n\r\n    } catch (error) {\r\n      const err = error as unknown as { message?: string; stack?: string; code?: string; meta?: unknown };\r\n      console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 ERREUR D\u00C3\u2030TAILL\u00C3\u2030E lors de la cr\u00C3\u00A9ation:', {\r\n        message: err?.message,\r\n        code: err?.code,\r\n        meta: err?.meta\r\n      });\r\n      if (err?.stack) console.error(err.stack);\r\n\r\n      // Log sp\u00C3\u00A9cifique pour erreurs Prisma\r\n      if (err && err.code) {\r\n        console.error('[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D Code erreur Prisma:', err.code);\r\n        if (err.meta) {\r\n          console.error('[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D M\u00C3\u00A9tadonn\u00C3\u00A9es:', err.meta);\r\n        }\r\n      }\r\n\r\n      return res.status(500).json({ \r\n        error: 'Erreur lors de la cr\u00C3\u00A9ation de la soumission',\r\n        details: process.env.NODE_ENV === 'development' ? err?.message : undefined\r\n      });\r\n    }\r\n  } catch (outerErr) {\r\n    // Garde-fou si une erreur se produit AVANT le bloc try interne\r\n    const e = outerErr as unknown as { message?: string };\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur inattendue en entr\u00C3\u00A9e de route /submissions:', e?.message);\r\n    return res.status(500).json({ error: 'Erreur interne inattendue' });\r\n  }\r\n});\r\n\r\n// DELETE /api/treebranchleaf/submissions/:id - Supprimer une soumission\r\nrouter.delete('/submissions/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F DELETE submission ${id}`);\r\n\r\n    // V\u00C3\u00A9rifier que la soumission existe et appartient \u00C3\u00A0 l'organisation\r\n    const submission = await prisma.treeBranchLeafSubmission.findFirst({\r\n      where: { \r\n        id,\r\n        ...(isSuperAdmin ? {} : { Lead: { organizationId } })\r\n      },\r\n      include: {\r\n        Lead: {\r\n          select: { organizationId: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!submission) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u009D\u0152 Submission ${id} non trouv\u00C3\u00A9e ou acc\u00C3\u00A8s refus\u00C3\u00A9`);\r\n      return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e ou acc\u00C3\u00A8s refus\u00C3\u00A9' });\r\n    }\r\n\r\n    // Supprimer les donn\u00C3\u00A9es associ\u00C3\u00A9es d'abord\r\n    await prisma.treeBranchLeafSubmissionData.deleteMany({\r\n      where: { submissionId: id }\r\n    });\r\n\r\n    // Puis supprimer la soumission\r\n    await prisma.treeBranchLeafSubmission.delete({\r\n      where: { id }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Submission ${id} supprim\u00C3\u00A9e avec succ\u00C3\u00A8s`);\r\n    res.json({ success: true, message: 'Soumission supprim\u00C3\u00A9e avec succ\u00C3\u00A8s' });\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error deleting submission:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression de la soumission' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u2014 TABLE LOOKUP - R\u00C3\u00A9cup\u00C3\u00A9ration de la configuration SELECT pour les champs\r\n// =============================================================================\r\n\r\n// GET /api/treebranchleaf/nodes/:fieldId/select-config\r\n// R\u00C3\u00A9cup\u00C3\u00A8re la configuration TreeBranchLeafSelectConfig d'un champ\r\nrouter.get('/nodes/:fieldId/select-config', async (req, res) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D GET select-config for field: ${fieldId}`);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, fieldId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) {\r\n      return res.status(access.status).json({ error: access.error });\r\n    }\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la configuration SELECT\r\n    let selectConfig = await prisma.treeBranchLeafSelectConfig.findFirst({\r\n      where: { nodeId: fieldId },\r\n    });\r\n\r\n    if (!selectConfig) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Pas de configuration SELECT pour le champ ${fieldId}`);\r\n      \r\n      // \u00F0\u0178\u017D\u00AF CR\u00C3\u2030ATION DYNAMIQUE : V\u00C3\u00A9rifier si le champ a une capacit\u00C3\u00A9 Table avec lookup\r\n      const node = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: fieldId },\r\n        select: { \r\n          id: true,\r\n          hasTable: true,\r\n          table_activeId: true,\r\n          table_instances: true\r\n        }\r\n      });\r\n\r\n      if (node?.hasTable && node.table_activeId && node.table_instances) {\r\n        const instances = node.table_instances as Record<string, any>;\r\n        const activeInstance = instances[node.table_activeId];\r\n        \r\n        const isRowBased = activeInstance?.rowBased === true;\r\n        const isColumnBased = activeInstance?.columnBased === true;\r\n        \r\n        if (isRowBased || isColumnBased) {\r\n          console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u00A7 Cr\u00C3\u00A9ation dynamique de la config SELECT pour lookup ${isRowBased ? 'LIGNE' : 'COLONNE'}`);\r\n          \r\n          // Cr\u00C3\u00A9er automatiquement la configuration SELECT\r\n          selectConfig = await prisma.treeBranchLeafSelectConfig.create({\r\n            data: {\r\n              id: randomUUID(),\r\n              nodeId: fieldId,\r\n              options: [] as Prisma.InputJsonValue,\r\n              multiple: false,\r\n              searchable: true,\r\n              allowCustom: false,\r\n              optionsSource: 'table',\r\n              tableReference: node.table_activeId,\r\n              keyColumn: null,\r\n              valueColumn: null,\r\n              displayColumn: null,\r\n              dependsOnNodeId: null,\r\n              createdAt: new Date(),\r\n              updatedAt: new Date(),\r\n            }\r\n          });\r\n          \r\n          console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Configuration SELECT cr\u00C3\u00A9\u00C3\u00A9e dynamiquement:`, selectConfig.id);\r\n        }\r\n      }\r\n      \r\n      if (!selectConfig) {\r\n        return res.status(404).json({ error: 'Configuration SELECT introuvable' });\r\n      }\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Configuration SELECT trouv\u00C3\u00A9e:`, selectConfig);\r\n    return res.json(selectConfig);\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching select config:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de la configuration SELECT' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/nodes/:fieldId/select-config\r\n// Cr\u00C3\u00A9e ou met \u00C3\u00A0 jour la configuration TreeBranchLeafSelectConfig d'un champ\r\nrouter.post('/nodes/:fieldId/select-config', async (req, res) => {\r\n  try {\r\n    const { fieldId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n    const {\r\n      optionsSource,\r\n      tableReference,\r\n      keyColumn,\r\n      keyRow,\r\n      valueColumn,\r\n      valueRow,\r\n      displayColumn,\r\n      displayRow,\r\n      dependsOnNodeId,\r\n    } = req.body;\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u009D POST select-config for field: ${fieldId}`, {\r\n      keyColumn,\r\n      keyRow,\r\n      valueColumn,\r\n      valueRow,\r\n      displayColumn,\r\n      displayRow,\r\n    });\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, fieldId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) {\r\n      return res.status(access.status).json({ error: access.error });\r\n    }\r\n\r\n    // Upsert la configuration SELECT\r\n    const selectConfig = await prisma.treeBranchLeafSelectConfig.upsert({\r\n      where: { nodeId: fieldId },\r\n      create: {\r\n        id: randomUUID(),\r\n        nodeId: fieldId,\r\n        options: [] as Prisma.InputJsonValue,\r\n        multiple: false,\r\n        searchable: true,\r\n        allowCustom: false,\r\n        optionsSource: optionsSource || 'table',\r\n        tableReference: tableReference || null,\r\n        keyColumn: keyColumn || null,\r\n        keyRow: keyRow || null,\r\n        valueColumn: valueColumn || null,\r\n        valueRow: valueRow || null,\r\n        displayColumn: displayColumn || null,\r\n        displayRow: displayRow || null,\r\n        dependsOnNodeId: dependsOnNodeId || null,\r\n        createdAt: new Date(),\r\n        updatedAt: new Date(),\r\n      },\r\n      update: {\r\n        optionsSource: optionsSource || 'table',\r\n        tableReference: tableReference || null,\r\n        keyColumn: keyColumn || null,\r\n        keyRow: keyRow || null,\r\n        valueColumn: valueColumn || null,\r\n        valueRow: valueRow || null,\r\n        displayColumn: displayColumn || null,\r\n        displayRow: displayRow || null,\r\n        dependsOnNodeId: dependsOnNodeId || null,\r\n        updatedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Configuration SELECT cr\u00C3\u00A9\u00C3\u00A9e/mise \u00C3\u00A0 jour:`, selectConfig);\r\n    return res.json(selectConfig);\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error creating select config:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la cr\u00C3\u00A9ation de la configuration SELECT' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/nodes/:nodeId/table/lookup\r\n// R\u00C3\u00A9cup\u00C3\u00A8re le tableau ACTIF d'un noeud pour lookup (utilis\u00C3\u00A9 par useTBLTableLookup)\r\nrouter.get('/nodes/:nodeId/table/lookup', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u008D GET active table/lookup for node: ${nodeId}`);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) {\r\n      return res.status(access.status).json({ error: access.error });\r\n    }\r\n\r\n    // \u00F0\u0178\u017D\u00AF \u00C3\u2030TAPE 1: R\u00C3\u00A9cup\u00C3\u00A9rer la configuration SELECT pour savoir QUEL tableau charger\r\n    let selectConfig = await prisma.treeBranchLeafSelectConfig.findFirst({\r\n      where: { nodeId },\r\n      select: {\r\n        tableReference: true,\r\n        keyColumn: true,\r\n        keyRow: true,\r\n        valueColumn: true,\r\n        valueRow: true,\r\n        displayColumn: true,\r\n        displayRow: true,\r\n      }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201C\u2039 Configuration SELECT:`, selectConfig);\r\n\r\n    // \u00F0\u0178\u201D\u00A7 Fallback automatique: si pas de config, essayer de la cr\u00C3\u00A9er depuis capabilities.table\r\n    if (!selectConfig?.tableReference) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Pas de tableReference dans la config SELECT \u00E2\u2020\u2019 tentative de fallback via capabilities.table`);\r\n\r\n      const node = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: nodeId },\r\n        select: { hasTable: true, table_activeId: true, table_instances: true }\r\n      });\r\n\r\n      if (node?.hasTable && node.table_activeId) {\r\n        // Cr\u00C3\u00A9er \u00C3\u00A0 la vol\u00C3\u00A9e une configuration minimale bas\u00C3\u00A9e sur l'instance active\r\n        await prisma.treeBranchLeafSelectConfig.upsert({\r\n          where: { nodeId },\r\n          create: {\r\n            id: randomUUID(),\r\n            nodeId,\r\n            options: [] as Prisma.InputJsonValue,\r\n            multiple: false,\r\n            searchable: true,\r\n            allowCustom: false,\r\n            optionsSource: 'table',\r\n            tableReference: node.table_activeId,\r\n            keyColumn: null,\r\n            keyRow: null,\r\n            valueColumn: null,\r\n            valueRow: null,\r\n            displayColumn: null,\r\n            displayRow: null,\r\n            dependsOnNodeId: null,\r\n            createdAt: new Date(),\r\n            updatedAt: new Date(),\r\n          },\r\n          update: {\r\n            optionsSource: 'table',\r\n            tableReference: node.table_activeId,\r\n            updatedAt: new Date(),\r\n          },\r\n        });\r\n\r\n        // Recharger la config pour continuer le flux normal\r\n        selectConfig = await prisma.treeBranchLeafSelectConfig.findFirst({\r\n          where: { nodeId },\r\n          select: {\r\n            tableReference: true,\r\n            keyColumn: true,\r\n            keyRow: true,\r\n            valueColumn: true,\r\n            valueRow: true,\r\n            displayColumn: true,\r\n            displayRow: true,\r\n          }\r\n        });\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Fallback SELECT config cr\u00C3\u00A9\u00C3\u00A9 depuis capabilities.table:`, selectConfig);\r\n      }\r\n    }\r\n\r\n    if (!selectConfig?.tableReference) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Pas de tableReference dans la config SELECT (apr\u00C3\u00A8s fallback)`);\r\n      return res.status(404).json({ error: 'Pas de tableau r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9 pour ce lookup' });\r\n    }\r\n\r\n    // \u00F0\u0178\u017D\u00AF \u00C3\u2030TAPE 2: Charger le TABLEAU r\u00C3\u00A9f\u00C3\u00A9renc\u00C3\u00A9 avec l'architecture NORMALIS\u00C3\u2030E\r\n    const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id: selectConfig.tableReference },\r\n      select: {\r\n        id: true,\r\n        nodeId: true,\r\n        name: true,\r\n        type: true,\r\n        meta: true,\r\n        tableColumns: {\r\n          select: { id: true, name: true, columnIndex: true },\r\n          orderBy: { columnIndex: 'asc' as const },\r\n        },\r\n        tableRows: {\r\n          select: { id: true, rowIndex: true, cells: true },\r\n          orderBy: { rowIndex: 'asc' as const },\r\n        },\r\n      }\r\n    });\r\n\r\n    if (!table) {\r\n      console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Tableau introuvable: ${selectConfig.tableReference}`);\r\n      return res.status(404).json({ error: 'Tableau introuvable' });\r\n    }\r\n\r\n    // \u00F0\u0178\u201D\u201E Reconstituer les colonnes/rows/data depuis l'architecture normalis\u00C3\u00A9e\r\n    const columns = table.tableColumns.map(col => col.name);\r\n    \r\n    // \u00F0\u0178\u017D\u00AF Extraire rows[] et data[] depuis cells\r\n    const rows: string[] = [];\r\n    const data: any[][] = [];\r\n    \r\n    table.tableRows.forEach(row => {\r\n      try {\r\n        let cellsData: any;\r\n        \r\n        // \u00F0\u0178\u201D\u008D Tentative 1: Parse JSON si c'est une string\r\n        if (typeof row.cells === 'string') {\r\n          try {\r\n            cellsData = JSON.parse(row.cells);\r\n          } catch {\r\n            // \u00F0\u0178\u201D\u00A7 Fallback: Si ce n'est PAS du JSON, c'est juste une valeur simple (premi\u00C3\u00A8re colonne uniquement)\r\n            // Cela arrive pour les anciennes donn\u00C3\u00A9es o\u00C3\u00B9 cells = \"Orientation\" au lieu de [\"Orientation\", ...]\r\n            cellsData = [row.cells]; // Envelopper dans un array\r\n          }\r\n        } else {\r\n          cellsData = row.cells || [];\r\n        }\r\n        \r\n        if (Array.isArray(cellsData) && cellsData.length > 0) {\r\n          // \u00F0\u0178\u201D\u2018 cellsData[0] = label de ligne (colonne A)\r\n          // \u00F0\u0178\u201C\u0160 cellsData[1...] = donn\u00C3\u00A9es (colonnes B, C, D...)\r\n          rows.push(String(cellsData[0] || ''));\r\n          data.push(cellsData.slice(1)); // Donn\u00C3\u00A9es sans le label\r\n        } else {\r\n          rows.push('');\r\n          data.push([]);\r\n        }\r\n      } catch (error) {\r\n        console.error('[TreeBranchLeaf API] Erreur parsing cells:', error);\r\n        rows.push('');\r\n        data.push([]);\r\n      }\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Tableau charg\u00C3\u00A9 (normalis\u00C3\u00A9):`, {\r\n      id: table.id,\r\n      name: table.name,\r\n      type: table.type,\r\n      columnsCount: columns.length,\r\n      rowsCount: rows.length,\r\n      firstColumns: columns.slice(0, 3),\r\n      firstRows: rows.slice(0, 3),\r\n    });\r\n\r\n    // \u00F0\u0178\u017D\u00AF \u00C3\u2030TAPE 3: G\u00C3\u00A9n\u00C3\u00A9rer les options selon la configuration\r\n    if (table.type === 'matrix') {\r\n\r\n      // CAS 1: keyRow d\u00C3\u00A9fini \u00E2\u2020\u2019 Extraire les VALEURS de cette ligne\r\n      if (selectConfig?.keyRow) {\r\n        const rowIndex = rows.indexOf(selectConfig.keyRow);\r\n        \r\n        if (rowIndex === -1) {\r\n          console.warn(`\u00E2\u0161\u00A0\u00EF\u00B8\u008F [TreeBranchLeaf API] Ligne \"${selectConfig.keyRow}\" introuvable`);\r\n          return res.json({ options: [] });\r\n        }\r\n\r\n        // \u00F0\u0178\u017D\u00AF R\u00C3\u02C6GLE A1: rows[0] = A1 (\"Orientation\"), rows[1] = \"Nord\", etc.\r\n        // data[0] correspond \u00C3\u00A0 rows[1], donc il faut d\u00C3\u00A9caler : dataRowIndex = rowIndex - 1\r\n        // Si rowIndex === 0 (A1), on doit extraire les en-t\u00C3\u00AAtes de colonnes (columns[]), pas data[]\r\n        let options;\r\n        \r\n        if (rowIndex === 0) {\r\n          // Ligne A1 s\u00C3\u00A9lectionn\u00C3\u00A9e \u00E2\u2020\u2019 Extraire les en-t\u00C3\u00AAtes de colonnes (SANS A1 lui-m\u00C3\u00AAme)\r\n          options = columns.slice(1).map((colName) => {\r\n            return {\r\n              value: colName,\r\n              label: selectConfig.displayRow ? colName : colName,\r\n            };\r\n          }).filter(opt => opt.value !== 'undefined' && opt.value !== 'null' && opt.value !== '');\r\n        } else {\r\n          // Autre ligne \u00E2\u2020\u2019 Extraire depuis data[rowIndex - 1]\r\n          const dataRowIndex = rowIndex - 1;\r\n          const rowData = data[dataRowIndex] || [];\r\n          options = columns.slice(1).map((colName, colIdx) => {\r\n            const value = rowData[colIdx];\r\n            return {\r\n              value: String(value),\r\n              label: selectConfig.displayRow ? `${colName}: ${value}` : String(value),\r\n            };\r\n          }).filter(opt => opt.value !== 'undefined' && opt.value !== 'null' && opt.value !== '');\r\n        }\r\n\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Options extraites depuis ligne \"${selectConfig.keyRow}\":`, {\r\n          rowIndex,\r\n          isRowA1: rowIndex === 0,\r\n          optionsCount: options.length,\r\n          sample: options.slice(0, 3)\r\n        });\r\n\r\n        return res.json({ options });\r\n      }\r\n\r\n      // CAS 2: keyColumn d\u00C3\u00A9fini \u00E2\u2020\u2019 Extraire les VALEURS de cette colonne\r\n      if (selectConfig?.keyColumn) {\r\n        const colIndex = columns.indexOf(selectConfig.keyColumn);\r\n        \r\n        if (colIndex === -1) {\r\n          console.warn(`\u00E2\u0161\u00A0\u00EF\u00B8\u008F [TreeBranchLeaf API] Colonne \"${selectConfig.keyColumn}\" introuvable`);\r\n          return res.json({ options: [] });\r\n        }\r\n\r\n        // \u00F0\u0178\u017D\u00AF R\u00C3\u02C6GLE A1 EXCEL: Si colIndex = 0, c'est la colonne A (labels des lignes)\r\n        // Ces labels sont dans rows[], PAS dans data[][0] !\r\n        // \u00E2\u0161\u00A0\u00EF\u00B8\u008F IMPORTANT: rows[0] = A1 (ex: \"Orientation\"), rows[1...] = labels de lignes r\u00C3\u00A9els\r\n        let options;\r\n        if (colIndex === 0) {\r\n          // Colonne A = labels des lignes \u00E2\u2020\u2019 Extraire depuis rows[] SAUF rows[0] (qui est A1)\r\n          options = rows.slice(1).map((rowLabel) => {\r\n            return {\r\n              value: rowLabel,\r\n              label: selectConfig.displayColumn ? rowLabel : rowLabel,\r\n            };\r\n          }).filter(opt => opt.value !== 'undefined' && opt.value !== 'null' && opt.value !== '');\r\n        } else {\r\n          // Autre colonne \u00E2\u2020\u2019 Extraire depuis data[][colIndex - 1]\r\n          // \u00E2\u0161\u00A0\u00EF\u00B8\u008F ATTENTION: data ne contient PAS la colonne 0, donc colIndex doit \u00C3\u00AAtre d\u00C3\u00A9cal\u00C3\u00A9 de -1\r\n          const dataColIndex = colIndex - 1;\r\n          options = data.map((row, rowIdx) => {\r\n            const value = row[dataColIndex];\r\n            const rowLabel = rows[rowIdx] || '';\r\n            return {\r\n              value: String(value),\r\n              label: selectConfig.displayColumn ? `${rowLabel}: ${value}` : String(value),\r\n            };\r\n          }).filter(opt => opt.value !== 'undefined' && opt.value !== 'null' && opt.value !== '');\r\n        }\r\n\r\n        console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 Options extraites depuis colonne \"${selectConfig.keyColumn}\" (index ${colIndex}):`, {\r\n          colIndex,\r\n          isColumnA: colIndex === 0,\r\n          optionsCount: options.length,\r\n          sample: options.slice(0, 3)\r\n        });\r\n\r\n        return res.json({ options });\r\n      }\r\n    }\r\n\r\n    // Fallback: Si pas de keyRow/keyColumn, retourner le tableau complet\r\n    // \u00F0\u0178\u201D\u00A5 AUTO-DEFAULT MATRIX (Orientation / Inclinaison) : G\u00E9n\u00E9rer options dynamiques si structure A1 d\u00E9tect\u00E9e\r\n    if (table.type === 'matrix') {\r\n      const hasNoConfig = !selectConfig?.keyRow && !selectConfig?.keyColumn;\r\n      const a1 = rows[0];\r\n      const firstColHeader = columns[0];\r\n      // Heuristique : si A1 est identique au header de la premi\u00E8re colonne, on suppose colonne A = labels (Orientation, Nord, ...)\r\n      if (hasNoConfig && firstColHeader && a1 && firstColHeader === a1) {\r\n        const autoOptions = rows.slice(1)\r\n          .filter(r => r && r !== 'undefined' && r !== 'null')\r\n          .map(r => ({ value: r, label: r }));\r\n        console.log(`[TreeBranchLeaf API] \u2699\uFE0F AUTO-DEFAULT lookup (matrix, colonne A) g\u00E9n\u00E9r\u00E9`, {\r\n          nodeId,\r\n          autoCount: autoOptions.length,\r\n          sample: autoOptions.slice(0, 5)\r\n        });\r\n        // Upsert automatique d'une configuration SELECT minimale bas\u00E9e sur la colonne A (A1)\r\n        try {\r\n          await prisma.treeBranchLeafSelectConfig.upsert({\r\n            where: { nodeId },\r\n            create: {\r\n              id: randomUUID(),\r\n              nodeId,\r\n              options: [] as Prisma.InputJsonValue,\r\n              multiple: false,\r\n              searchable: true,\r\n              allowCustom: false,\r\n              optionsSource: 'table',\r\n              tableReference: table.id,\r\n              keyColumn: firstColHeader,\r\n              keyRow: null,\r\n              valueColumn: null,\r\n              valueRow: null,\r\n              displayColumn: null,\r\n              displayRow: null,\r\n              dependsOnNodeId: null,\r\n              createdAt: new Date(),\r\n              updatedAt: new Date(),\r\n            },\r\n            update: {\r\n              optionsSource: 'table',\r\n              tableReference: table.id,\r\n              keyColumn: firstColHeader,\r\n              keyRow: null,\r\n              valueColumn: null,\r\n              valueRow: null,\r\n              displayColumn: null,\r\n              displayRow: null,\r\n              updatedAt: new Date(),\r\n            }\r\n          });\r\n          console.log(`[TreeBranchLeaf API] \u2705 AUTO-UPSERT select-config: nodeId=${nodeId}, table=${table.id}, keyColumn=${firstColHeader}`);\r\n        } catch (e) {\r\n          console.warn(`[TreeBranchLeaf API] \u26A0\uFE0F Auto-upsert select-config a \u00E9chou\u00E9 (non bloquant):`, e);\r\n        }\r\n        return res.json({ options: autoOptions, autoDefault: { source: 'columnA', keyColumnCandidate: firstColHeader } });\r\n      }\r\n    }\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0161\u00A0\u00EF\u00B8\u008F Aucun keyRow/keyColumn configur\u00C3\u00A9, retour tableau brut (pas d'auto-default applicable)`);\r\n    return res.json(table);\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error fetching table for lookup:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration du tableau' });\r\n  }\r\n});\r\n\r\n// PATCH /api/treebranchleaf/nodes/:nodeId\r\n// Met \u00C3\u00A0 jour les propri\u00C3\u00A9t\u00C3\u00A9s d'un n\u00C5\u201Cud (type, fieldType, etc.)\r\nrouter.patch('/nodes/:nodeId', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00F0\u0178\u201D\u00A7 PATCH node: ${nodeId}`, req.body);\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const access = await ensureNodeOrgAccess(prisma, nodeId, { organizationId, isSuperAdmin });\r\n    if (!access.ok) {\r\n      return res.status(access.status).json({ error: access.error });\r\n    }\r\n\r\n    // Mettre \u00C3\u00A0 jour le n\u00C5\u201Cud\r\n    const updatedNode = await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        ...req.body,\r\n        updatedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    console.log(`[TreeBranchLeaf API] \u00E2\u0153\u2026 N\u00C5\u201Cud mis \u00C3\u00A0 jour:`, updatedNode.id);\r\n    return res.json(updatedNode);\r\n\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] Error updating node:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour du n\u00C5\u201Cud' });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u017D\u00AF PUT /nodes/:nodeId/capabilities/table\r\n * Active/d\u00C3\u00A9sactive la capacit\u00C3\u00A9 Table sur un champ\r\n * Appel\u00C3\u00A9 depuis TablePanel quand on s\u00C3\u00A9lectionne un champ dans le lookup\r\n */\r\nrouter.put('/nodes/:nodeId/capabilities/table', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { enabled, activeId, currentTable } = req.body;\r\n\r\n    console.log(`\u00F0\u0178\u017D\u00AF [TablePanel API] PUT /nodes/${nodeId}/capabilities/table`, { enabled, activeId, currentTable });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer le n\u00C5\u201Cud existant\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      select: { \r\n        id: true,\r\n        hasTable: true,\r\n        metadata: true\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud non trouv\u00C3\u00A9' });\r\n    }\r\n\r\n    // Construire le nouvel objet metadata avec capabilities.table mis \u00C3\u00A0 jour\r\n    const oldMetadata = (node.metadata || {}) as Record<string, unknown>;\r\n    const oldCapabilities = (oldMetadata.capabilities || {}) as Record<string, unknown>;\r\n    \r\n    // \u00F0\u0178\u017D\u00AF CRITICAL FIX: Cr\u00C3\u00A9er une instance dans table_instances pour que le hook d\u00C3\u00A9tecte enabled=true\r\n    const tableInstances = enabled && activeId ? {\r\n      [activeId]: currentTable || { mode: 'matrix', tableId: activeId }\r\n    } : null;\r\n    \r\n    const newCapabilities = {\r\n      ...oldCapabilities,\r\n      table: {\r\n        enabled: enabled === true,\r\n        activeId: enabled ? (activeId || null) : null,\r\n        instances: tableInstances,\r\n        currentTable: enabled ? (currentTable || null) : null,\r\n      }\r\n    };\r\n\r\n    const newMetadata = {\r\n      ...oldMetadata,\r\n      capabilities: newCapabilities\r\n    };\r\n\r\n    console.log(`\u00E2\u0153\u2026 [TablePanel API] Nouvelle metadata.capabilities.table:`, newCapabilities.table);\r\n\r\n    // Mettre \u00C3\u00A0 jour le n\u00C5\u201Cud avec metadata seulement - FORCE JSON serialization\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        hasTable: enabled === true,\r\n        table_activeId: enabled ? (activeId || null) : null,\r\n        table_instances: tableInstances ? JSON.parse(JSON.stringify(tableInstances)) : null,\r\n        metadata: JSON.parse(JSON.stringify(newMetadata)), // Force serialization\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`\u00E2\u0153\u2026 [TablePanel API] Capacit\u00C3\u00A9 Table mise \u00C3\u00A0 jour pour n\u00C5\u201Cud ${nodeId}`);\r\n    \r\n    // \u00F0\u0178\u017D\u00AF CR\u00C3\u2030ATION/UPDATE AUTOMATIQUE DE LA CONFIGURATION SELECT pour le lookup dynamique\r\n    if (enabled && activeId) {\r\n      const keyColumn = currentTable?.keyColumn || null;\r\n      const keyRow = currentTable?.keyRow || null;\r\n      const valueColumn = currentTable?.valueColumn || null;\r\n      const valueRow = currentTable?.valueRow || null;\r\n      const displayColumn = currentTable?.displayColumn || null;\r\n      const displayRow = currentTable?.displayRow || null;\r\n      \r\n      console.log(`\u00F0\u0178\u201D\u00A7 [TablePanel API] Upsert configuration SELECT`, {\r\n        nodeId,\r\n        activeId,\r\n        keyColumn,\r\n        keyRow,\r\n        valueColumn,\r\n        valueRow,\r\n        displayColumn,\r\n        displayRow,\r\n      });\r\n      \r\n      try {\r\n        // UPSERT la configuration SELECT avec tous les champs\r\n        await prisma.treeBranchLeafSelectConfig.upsert({\r\n          where: { nodeId },\r\n          create: {\r\n            id: randomUUID(),\r\n            nodeId: nodeId,\r\n            options: [] as Prisma.InputJsonValue,\r\n            multiple: false,\r\n            searchable: true,\r\n            allowCustom: false,\r\n            optionsSource: 'table',\r\n            tableReference: activeId,\r\n            keyColumn,\r\n            keyRow,\r\n            valueColumn,\r\n            valueRow,\r\n            displayColumn,\r\n            displayRow,\r\n            dependsOnNodeId: null,\r\n            createdAt: new Date(),\r\n            updatedAt: new Date(),\r\n          },\r\n          update: {\r\n            tableReference: activeId,\r\n            keyColumn,\r\n            keyRow,\r\n            valueColumn,\r\n            valueRow,\r\n            displayColumn,\r\n            displayRow,\r\n            updatedAt: new Date(),\r\n          },\r\n        });\r\n        console.log(`\u00E2\u0153\u2026 [TablePanel API] Configuration SELECT upsert\u00C3\u00A9e pour ${nodeId}`, {\r\n          keyColumn,\r\n          keyRow,\r\n          displayColumn,\r\n          displayRow,\r\n        });\r\n      } catch (selectConfigError) {\r\n        console.error(`\u00E2\u0161\u00A0\u00EF\u00B8\u008F [TablePanel API] Erreur upsert config SELECT (non-bloquant):`, selectConfigError);\r\n        // Non-bloquant : on continue m\u00C3\u00AAme si la cr\u00C3\u00A9ation \u00C3\u00A9choue\r\n      }\r\n    } else if (!enabled) {\r\n      // \u00F0\u0178\u201D\u00B4 D\u00C3\u2030SACTIVATION : Supprimer la configuration SELECT\r\n      console.log(`\u00F0\u0178\u201D\u00B4 [TablePanel API] Suppression configuration SELECT pour ${nodeId}`);\r\n      try {\r\n        await prisma.treeBranchLeafSelectConfig.deleteMany({\r\n          where: { nodeId }\r\n        });\r\n        console.log(`\u00E2\u0153\u2026 [TablePanel API] Configuration SELECT supprim\u00C3\u00A9e pour ${nodeId}`);\r\n      } catch (deleteError) {\r\n        console.error(`\u00E2\u0161\u00A0\u00EF\u00B8\u008F [TablePanel API] Erreur suppression config SELECT (non-bloquant):`, deleteError);\r\n      }\r\n    }\r\n    \r\n    // \u00F0\u0178\u201D\u008D V\u00C3\u2030RIFICATION IMM\u00C3\u2030DIATE : Relire depuis la DB pour confirmer persistance\r\n    const verifyNode = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      select: { metadata: true, hasTable: true }\r\n    });\r\n    \r\n    console.log(`\u00F0\u0178\u201D\u008D [TablePanel API] V\u00C3\u2030RIFICATION apr\u00C3\u00A8s UPDATE:`, {\r\n      nodeId,\r\n      hasTable: verifyNode?.hasTable,\r\n      metadataCapabilitiesTable: (verifyNode?.metadata as any)?.capabilities?.table\r\n    });\r\n\r\n    return res.json({ \r\n      success: true, \r\n      nodeId, \r\n      capabilities: {\r\n        table: newCapabilities.table\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[TablePanel API] \u00E2\u009D\u0152 Erreur PUT /nodes/:nodeId/capabilities/table:', error);\r\n    return res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour de la capacit\u00C3\u00A9 Table' });\r\n  }\r\n});\r\n\r\n// PUT /api/treebranchleaf/submissions/:id - Mettre \u00C3\u00A0 jour les donn\u00C3\u00A9es d'une soumission (upsert champs + backfill variables)\r\nrouter.put('/submissions/:id', async (req, res) => {\r\n  const { id } = req.params;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n  const { data, status } = req.body as { data?: unknown; status?: string };\r\n\r\n  try {\r\n    // Charger la soumission avec l'arbre pour contr\u00C3\u00B4le d'acc\u00C3\u00A8s\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      include: { TreeBranchLeafTree: { select: { id: true, organizationId: true } } }\r\n    });\r\n    if (!submission) {\r\n      return res.status(404).json({ error: 'Soumission non trouv\u00C3\u00A9e' });\r\n    }\r\n    const treeId = submission.treeId;\r\n    const treeOrg = submission.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && treeOrg && treeOrg !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette soumission' });\r\n    }\r\n\r\n    // N\u00C5\u201Cuds valides pour l'arbre\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId }, select: { id: true, label: true } });\r\n    const validNodeIds = new Set(nodes.map(n => n.id));\r\n    const labelMap = new Map(nodes.map(n => [n.id, n.label]));\r\n    // Variables connues (pour faire la correspondance exposedKey -> nodeId et r\u00C3\u00A9cup\u00C3\u00A9rer unit/source)\r\n    const variablesMeta = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      where: { TreeBranchLeafNode: { treeId } },\r\n      include: { TreeBranchLeafNode: { select: { label: true } } }\r\n    });\r\n    const varByExposedKey = new Map(\r\n      variablesMeta\r\n        .filter(v => !!v.exposedKey)\r\n        .map(v => [\r\n          v.exposedKey as string,\r\n          {\r\n            nodeId: v.nodeId,\r\n            displayName: v.displayName || v.TreeBranchLeafNode?.label || v.exposedKey || v.nodeId,\r\n            unit: v.unit || null,\r\n            sourceRef: v.sourceRef || null\r\n          }\r\n        ])\r\n    );\r\n    const varMetaByNodeId = new Map(\r\n      variablesMeta.map(v => [\r\n        v.nodeId,\r\n        {\r\n          displayName: v.displayName || v.TreeBranchLeafNode?.label || v.exposedKey || v.nodeId,\r\n          unit: v.unit || null,\r\n          sourceRef: v.sourceRef || null\r\n        }\r\n      ])\r\n    );\r\n\r\n    // Normaliser payload (objet ou tableau)\r\n    type DataItem = { nodeId: string; value?: unknown; calculatedValue?: unknown };\r\n    const rawEntries: DataItem[] = (() => {\r\n      if (Array.isArray(data)) {\r\n        return (data as unknown[])\r\n          .map((it): DataItem | null => {\r\n            if (it && typeof it === 'object' && 'nodeId' in (it as Record<string, unknown>)) {\r\n              const obj = it as Record<string, unknown>;\r\n              return { nodeId: String(obj.nodeId), value: obj.value, calculatedValue: (obj as Record<string, unknown>).calculatedValue };\r\n            }\r\n            return null;\r\n          })\r\n          .filter((x): x is DataItem => !!x);\r\n      }\r\n      if (data && typeof data === 'object') {\r\n        return Object.entries(data as Record<string, unknown>).map(([nodeId, value]) => ({ nodeId, value }));\r\n      }\r\n      return [];\r\n    })();\r\n\r\n    // Remap: si nodeId n'est pas un node r\u00C3\u00A9el mais est un exposedKey de variable, le remapper vers le nodeId de la variable\r\n    const mappedEntries = rawEntries.map(e => {\r\n      if (!validNodeIds.has(e.nodeId) && varByExposedKey.has(e.nodeId)) {\r\n        const vm = varByExposedKey.get(e.nodeId)!;\r\n        return { nodeId: vm.nodeId, value: e.value, calculatedValue: e.calculatedValue };\r\n      }\r\n      return e;\r\n    });\r\n\r\n    // Construire la liste finale avec valeur effective (calculatedValue prioritaire)\r\n    const entries = mappedEntries\r\n      .filter(({ nodeId }) => validNodeIds.has(nodeId))\r\n      .map(e => ({ ...e, effectiveValue: e.calculatedValue !== undefined ? e.calculatedValue : e.value }));\r\n\r\n    await prisma.$transaction(async (tx) => {\r\n      const now = new Date();\r\n      const inferSource = (sourceRef?: string | null): 'formula' | 'condition' | 'table' | 'neutral' => {\r\n        const s = (sourceRef || '').toLowerCase();\r\n        if (s.includes('formula') || s.includes('formule')) return 'formula';\r\n        if (s.includes('condition')) return 'condition';\r\n        if (s.includes('table')) return 'table';\r\n        return 'neutral';\r\n      };\r\n      // Resolver scoped to transaction\r\n      const resolveOperationDetail = async (sourceRef?: string | null): Promise<Prisma.InputJsonValue | null> => {\r\n        const parsed = parseSourceRef(sourceRef);\r\n        if (!parsed) return null;\r\n        if (parsed.type === 'condition') {\r\n          const rec = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, conditionSet: true, nodeId: true } });\r\n          return buildOperationDetail('condition', rec);\r\n        }\r\n        if (parsed.type === 'formula') {\r\n          const rec = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, tokens: true, nodeId: true } });\r\n          return buildOperationDetail('formula', rec);\r\n        }\r\n        if (parsed.type === 'table') {\r\n          const rec = await tx.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n          return buildOperationDetail('table', rec);\r\n        }\r\n        return null;\r\n      };\r\n      if (entries.length > 0) {\r\n        // Existence actuelle\r\n        const existing = await tx.treeBranchLeafSubmissionData.findMany({\r\n          where: { submissionId: id, nodeId: { in: entries.map(({ nodeId }) => nodeId) as string[] } },\r\n          select: { nodeId: true, fieldLabel: true }\r\n        });\r\n        const existingLabelMap = new Map(existing.map(e => [e.nodeId, e.fieldLabel] as const));\r\n        const existingSet = new Set(existing.map(e => e.nodeId));\r\n        const toCreate = entries.filter(({ nodeId }) => !existingSet.has(nodeId));\r\n        const toUpdate = entries.filter(({ nodeId }) => existingSet.has(nodeId));\r\n\r\n        if (toCreate.length > 0) {\r\n          // Construire une map des valeurs actuelles connues pour r\u00C3\u00A9solution des refs\r\n          const existingAll = await tx.treeBranchLeafSubmissionData.findMany({ where: { submissionId: id }, select: { nodeId: true, value: true } });\r\n          const valuesMapTx: ValuesMap = new Map(existingAll.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n          const createRows = await Promise.all(toCreate.map(async ({ nodeId, effectiveValue }) => {\r\n            const isVar = varMetaByNodeId.has(nodeId);\r\n            const meta = isVar ? varMetaByNodeId.get(nodeId)! : undefined;\r\n            const label = labelMap.get(nodeId) || existingLabelMap.get(nodeId) || null;\r\n            const valueStr = effectiveValue == null ? null : String(effectiveValue);\r\n            const opSrc = isVar ? inferSource(meta?.sourceRef || null) : 'neutral';\r\n            const display = isVar ? (meta?.displayName || label || nodeId) : (label || nodeId);\r\n            // Par d\u00C3\u00A9faut une cha\u00C3\u00AEne lisible; si variable et source, produire un JSON d\u00C3\u00A9taill\u00C3\u00A9\r\n            let opRes: Prisma.InputJsonValue = meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n            const opDetail = isVar ? (await resolveOperationDetail(meta?.sourceRef || null)) : (label as Prisma.InputJsonValue | null);\r\n            if (isVar && meta?.sourceRef) {\r\n              const parsed = parseSourceRef(meta.sourceRef);\r\n              if (parsed?.type === 'condition') {\r\n                const rec = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { conditionSet: true } });\r\n                const ids = extractNodeIdsFromConditionSet(rec?.conditionSet);\r\n                // inclure la valeur qu'on est en train d'\u00C3\u00A9crire\r\n                valuesMapTx.set(nodeId, valueStr);\r\n                const refsRaw = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                const refs = refsRaw.map(r => ({ label: r.label ?? null, value: r.value ?? null }));\r\n                const expr = '\u00F0\u0178\u201D\u201E Condition \u00C3\u00A9valu\u00C3\u00A9e via TBL Prisma (ligne 5456)'; // D\u00C3\u00A9sactiv\u00C3\u00A9: await buildConditionExpressionReadable(...)\r\n                opRes = { type: 'condition', label: display, value: valueStr, unit: meta?.unit || null, refs, text: expr } as const;\r\n              } else if (parsed?.type === 'formula') {\r\n                const rec = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { tokens: true } });\r\n                const ids = extractNodeIdsFromTokens(rec?.tokens);\r\n                valuesMapTx.set(nodeId, valueStr);\r\n                const refsRaw = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                const refs = refsRaw.map(r => ({ label: r.label ?? null, value: r.value ?? null }));\r\n                let expr = buildTextFromTokens(rec?.tokens, labelMap, valuesMapTx);\r\n                \r\n                // Calculer le r\u00C3\u00A9sultat de l'expression math\u00C3\u00A9matique\r\n                const calculatedResult = calculateResult(expr);\r\n                if (calculatedResult !== null) {\r\n                  expr += ` = ${calculatedResult}`;\r\n                }\r\n                \r\n                const finalText = expr;\r\n                opRes = { type: 'formula', label: display, value: valueStr, unit: meta?.unit || null, refs, text: finalText } as const;\r\n              } else if (parsed?.type === 'table') {\r\n                const rec = await tx.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n                const str = JSON.stringify(rec);\r\n                const ids = new Set<string>();\r\n                if (str) { let m: RegExpExecArray | null; const re = /@value\\.([a-f0-9-]{36})/gi; while ((m = re.exec(str)) !== null) ids.add(m[1]); }\r\n                valuesMapTx.set(nodeId, valueStr);\r\n                const refsRaw = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                const refs = refsRaw.map(r => ({ label: r.label ?? null, value: r.value ?? null }));\r\n                const expr = buildTextFromTableRecord(rec, labelMap, valuesMapTx);\r\n                const unitSuffix = meta?.unit ? ` ${meta.unit}` : '';\r\n                const finalText = expr ? `${expr} (=) ${display} (${valueStr ?? ''}${unitSuffix})` : `${display} (${valueStr ?? ''}${unitSuffix})`;\r\n                opRes = { type: 'table', label: display, value: valueStr, unit: meta?.unit || null, refs, text: finalText } as const;\r\n              }\r\n            }\r\n            return {\r\n              id: randomUUID(),\r\n              submissionId: id,\r\n              nodeId,\r\n              value: valueStr,\r\n              fieldLabel: label,\r\n              isVariable: isVar,\r\n              variableDisplayName: isVar ? meta?.displayName ?? null : null,\r\n              variableKey: null,\r\n              variableUnit: isVar ? meta?.unit ?? null : null,\r\n              sourceRef: isVar ? meta?.sourceRef ?? null : null,\r\n              operationSource: opSrc,\r\n              operationDetail: opDetail,\r\n              operationResult: opRes,\r\n              lastResolved: now\r\n            };\r\n          }));\r\n          await tx.treeBranchLeafSubmissionData.createMany({ data: createRows });\r\n        }\r\n        for (const { nodeId, effectiveValue } of toUpdate) {\r\n          const isVar = varMetaByNodeId.has(nodeId);\r\n          const meta = isVar ? varMetaByNodeId.get(nodeId)! : undefined;\r\n          const label = labelMap.get(nodeId) || existingLabelMap.get(nodeId) || undefined;\r\n          const valueStr = effectiveValue == null ? null : String(effectiveValue);\r\n          // reconstruire une petite map des valeurs (inclure la valeur mise \u00C3\u00A0 jour) pour les refs\r\n          const existingAll = await tx.treeBranchLeafSubmissionData.findMany({ where: { submissionId: id }, select: { nodeId: true, value: true } });\r\n          const valuesMapTx: ValuesMap = new Map(existingAll.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n          valuesMapTx.set(nodeId, valueStr);\r\n          try {\r\n            await tx.treeBranchLeafSubmissionData.update({\r\n              where: { submissionId_nodeId: { submissionId: id, nodeId } },\r\n              data: {\r\n                value: valueStr,\r\n                fieldLabel: label,\r\n                operationSource: isVar ? inferSource(meta?.sourceRef || null) : 'neutral',\r\n                operationDetail: isVar ? ((await resolveOperationDetail(meta?.sourceRef || null)) ?? undefined) : (label || undefined),\r\n                operationResult: (() => {\r\n                  const display = isVar ? (meta?.displayName || label || nodeId) : (label || nodeId);\r\n                  if (!isVar || !meta?.sourceRef) {\r\n                    return meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n                  }\r\n                  const parsed = parseSourceRef(meta.sourceRef);\r\n                  if (parsed?.type === 'condition') {\r\n                    return (async () => {\r\n                      const rec = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { conditionSet: true } });\r\n                      const ids = extractNodeIdsFromConditionSet(rec?.conditionSet);\r\n                      const refsRaw = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                      const refs = refsRaw.map(r => ({ label: r.label ?? null, value: r.value ?? null }));\r\n                      const expr = '\u00F0\u0178\u201D\u201E Condition \u00C3\u00A9valu\u00C3\u00A9e via TBL Prisma (ligne 5545)';\r\n                      return { type: 'condition', label: display, value: valueStr, unit: meta?.unit || null, refs, text: expr } as const;\r\n                    })();\r\n                  }\r\n                  if (parsed?.type === 'formula') {\r\n                    return (async () => {\r\n                      const rec = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { tokens: true } });\r\n                      const ids = extractNodeIdsFromTokens(rec?.tokens);\r\n                      const refsRaw = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                      const refs = refsRaw.map(r => ({ label: r.label ?? null, value: r.value ?? null }));\r\n                      let expr = buildTextFromTokens(rec?.tokens, labelMap, valuesMapTx);\r\n                      \r\n                      // Calculer le r\u00C3\u00A9sultat de l'expression math\u00C3\u00A9matique\r\n                      const calculatedResult = calculateResult(expr);\r\n                      if (calculatedResult !== null) {\r\n                        expr += ` = ${calculatedResult}`;\r\n                      }\r\n                      \r\n                      return { type: 'formula', label: display, value: valueStr, unit: meta?.unit || null, refs, text: expr } as const;\r\n                    })();\r\n                  }\r\n                  if (parsed?.type === 'table') {\r\n                    return (async () => {\r\n                      const rec = await tx.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n                      const str = JSON.stringify(rec);\r\n                      const ids = new Set<string>();\r\n                      if (str) { let m: RegExpExecArray | null; const re = /@value\\.([a-f0-9-]{36})/gi; while ((m = re.exec(str)) !== null) ids.add(m[1]); }\r\n                      const refsRaw = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                      const refs = refsRaw.map(r => ({ label: r.label ?? null, value: r.value ?? null }));\r\n                      const expr = buildTextFromTableRecord(rec, labelMap, valuesMapTx);\r\n                      const unitSuffix = meta?.unit ? ` ${meta.unit}` : '';\r\n                      const finalText = expr ? `${expr} (=) ${display} (${valueStr ?? ''}${unitSuffix})` : `${display} (${valueStr ?? ''}${unitSuffix})`;\r\n                      return { type: 'table', label: display, value: valueStr, unit: meta?.unit || null, refs, text: finalText } as const;\r\n                    })();\r\n                  }\r\n                  return meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n                })(),\r\n                lastResolved: now\r\n              }\r\n            });\r\n          } catch {\r\n            await tx.treeBranchLeafSubmissionData.updateMany({\r\n              where: { submissionId: id, nodeId },\r\n              data: {\r\n                value: valueStr,\r\n                fieldLabel: label,\r\n                operationSource: isVar ? inferSource(meta?.sourceRef || null) : 'neutral',\r\n                operationDetail: isVar ? ((await resolveOperationDetail(meta?.sourceRef || null)) ?? undefined) : (label || undefined),\r\n                operationResult: (() => {\r\n                  const display = isVar ? (meta?.displayName || label || nodeId) : (label || nodeId);\r\n                  if (!isVar || !meta?.sourceRef) {\r\n                    return meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n                  }\r\n                  const parsed = parseSourceRef(meta.sourceRef);\r\n                  if (parsed?.type === 'condition') {\r\n                    return (async () => {\r\n                      const rec = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { conditionSet: true } });\r\n                      const ids = extractNodeIdsFromConditionSet(rec?.conditionSet);\r\n                      const refs = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                      return { type: 'condition', label: display, value: valueStr, unit: meta?.unit || null, refs } as const;\r\n                    })();\r\n                  }\r\n                  if (parsed?.type === 'formula') {\r\n                    return (async () => {\r\n                      const rec = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { tokens: true } });\r\n                      const ids = extractNodeIdsFromTokens(rec?.tokens);\r\n                      const refs = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                      return { type: 'formula', label: display, value: valueStr, unit: meta?.unit || null, refs } as const;\r\n                    })();\r\n                  }\r\n                  if (parsed?.type === 'table') {\r\n                    return (async () => {\r\n                      const rec = await tx.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n                      const str = JSON.stringify(rec);\r\n                      const ids = new Set<string>();\r\n                      if (str) { let m: RegExpExecArray | null; const re = /@value\\.([a-f0-9-]{36})/gi; while ((m = re.exec(str)) !== null) ids.add(m[1]); }\r\n                      const refs = buildResolvedRefs(ids, labelMap, valuesMapTx);\r\n                      return { type: 'table', label: display, value: valueStr, unit: meta?.unit || null, refs } as const;\r\n                    })();\r\n                  }\r\n                  return meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n                })(),\r\n                lastResolved: now\r\n              }\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      // Backfill des variables manquantes (au cas o\u00C3\u00B9 de nouvelles variables ont \u00C3\u00A9t\u00C3\u00A9 ajout\u00C3\u00A9es au tree depuis la cr\u00C3\u00A9ation)\r\n      const variables = await tx.treeBranchLeafNodeVariable.findMany({\r\n        where: { TreeBranchLeafNode: { treeId } },\r\n        include: { TreeBranchLeafNode: { select: { id: true, label: true } } }\r\n      });\r\n      const existingVarRows = await tx.treeBranchLeafSubmissionData.findMany({ where: { submissionId: id, nodeId: { in: variables.map(v => v.nodeId) } }, select: { nodeId: true } });\r\n      const existingVarSet = new Set(existingVarRows.map(r => r.nodeId));\r\n      const missingVars = variables.filter(v => !existingVarSet.has(v.nodeId));\r\n      if (missingVars.length > 0) {\r\n        // Construire valuesMap pour r\u00C3\u00A9solution (actuel en BD)\r\n        const allRows = await tx.treeBranchLeafSubmissionData.findMany({ where: { submissionId: id }, select: { nodeId: true, value: true } });\r\n        const valuesMapTxAll: ValuesMap = new Map(allRows.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n        const missingRows = await Promise.all(missingVars.map(async v => ({\r\n          id: randomUUID(),\r\n          submissionId: id,\r\n          nodeId: v.nodeId,\r\n          value: null,\r\n          fieldLabel: v.TreeBranchLeafNode?.label || null,\r\n          isVariable: true,\r\n          variableDisplayName: v.displayName,\r\n          variableKey: v.exposedKey,\r\n          variableUnit: v.unit,\r\n          sourceRef: v.sourceRef || null,\r\n          operationSource: inferSource(v.sourceRef || null),\r\n          operationDetail: await resolveOperationDetail(v.sourceRef || null),\r\n          operationResult: (() => {\r\n            const display = (v.displayName || v.TreeBranchLeafNode?.label || v.exposedKey || v.nodeId);\r\n            if (!v.sourceRef) return `${display}: `;\r\n            const parsed = parseSourceRef(v.sourceRef);\r\n            if (parsed?.type === 'condition') {\r\n              return (async () => {\r\n                const rec = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { conditionSet: true } });\r\n                const ids = extractNodeIdsFromConditionSet(rec?.conditionSet);\r\n                const refs = buildResolvedRefs(ids, labelMap, valuesMapTxAll);\r\n                const human = `${display}`;\r\n                return { type: 'condition', label: display, value: null, unit: v.unit || null, refs, text: buildResultText(human, null, v.unit || null) } as const;\r\n              })();\r\n            }\r\n            if (parsed?.type === 'formula') {\r\n              return (async () => {\r\n                const rec = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { tokens: true } });\r\n                const ids = extractNodeIdsFromTokens(rec?.tokens);\r\n                const refs = buildResolvedRefs(ids, labelMap, valuesMapTxAll);\r\n                const human = `${display}`;\r\n                return { type: 'formula', label: display, value: null, unit: v.unit || null, refs, text: buildResultText(human, null, v.unit || null) } as const;\r\n              })();\r\n            }\r\n            if (parsed?.type === 'table') {\r\n              return (async () => {\r\n                const rec = await tx.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n                const str = JSON.stringify(rec);\r\n                const ids = new Set<string>();\r\n                if (str) { let m: RegExpExecArray | null; const re = /@value\\.([a-f0-9-]{36})/gi; while ((m = re.exec(str)) !== null) ids.add(m[1]); }\r\n                const refs = buildResolvedRefs(ids, labelMap, valuesMapTxAll);\r\n                const human = `${display}`;\r\n                return { type: 'table', label: display, value: null, unit: v.unit || null, refs, text: buildResultText(human, null, v.unit || null) } as const;\r\n              })();\r\n            }\r\n            return `${display}: `;\r\n          })(),\r\n          lastResolved: now\r\n        })));\r\n        await tx.treeBranchLeafSubmissionData.createMany({ data: missingRows });\r\n      }\r\n\r\n      // Backfill des champs d'op\u00C3\u00A9ration manquants sur les lignes existantes (variables et non-variables)\r\n      const allRows = await tx.treeBranchLeafSubmissionData.findMany({\r\n        where: {\r\n          submissionId: id\r\n        },\r\n        select: { \r\n          nodeId: true, \r\n          isVariable: true, \r\n          value: true, \r\n          sourceRef: true,\r\n          operationDetail: true,\r\n          operationResult: true,\r\n          lastResolved: true\r\n        }\r\n      });\r\n      \r\n      // Filtrer en m\u00C3\u00A9moire les lignes qui ont besoin d'un backfill\r\n      const rowsNeeding = allRows.filter(row => \r\n        row.operationDetail === null || \r\n        row.operationResult === null || \r\n        row.lastResolved === null\r\n      );\r\n      for (const row of rowsNeeding) {\r\n        const isVar = row.isVariable;\r\n        const meta = isVar ? varMetaByNodeId.get(row.nodeId) : undefined;\r\n        const label = labelMap.get(row.nodeId) || undefined;\r\n        const valueStr = row.value == null ? null : String(row.value);\r\n        const opSrc = isVar ? inferSource(meta?.sourceRef || null) : 'neutral';\r\n        const display = isVar ? (meta?.displayName || label || row.nodeId) : (label || row.nodeId);\r\n        // Construire valuesMap pour refs\r\n        const allRows = await tx.treeBranchLeafSubmissionData.findMany({ where: { submissionId: id }, select: { nodeId: true, value: true } });\r\n        const valuesMapTxAll: ValuesMap = new Map(allRows.map(r => [r.nodeId, r.value == null ? null : String(r.value)]));\r\n        valuesMapTxAll.set(row.nodeId, valueStr);\r\n        let opRes: Prisma.InputJsonValue = meta?.unit && valueStr ? `${display}: ${valueStr} ${meta.unit}` : `${display}: ${valueStr ?? ''}`;\r\n        const opDetail = isVar ? (await resolveOperationDetail(row.sourceRef || null)) : (label as Prisma.InputJsonValue | undefined);\r\n        \r\n        if (isVar && (row.sourceRef || meta?.sourceRef)) {\r\n          // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n          // \u00F0\u0178\u017D\u00AF NOUVEAU : Utiliser le syst\u00C3\u00A8me universel d'interpr\u00C3\u00A9tation\r\n          // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n          try {\r\n            console.log(`[UNIVERSAL] \u00F0\u0178\u201D\u201E \u00C3\u2030valuation de la variable: ${row.nodeId} (${display})`);\r\n            \r\n            // Appeler le syst\u00C3\u00A8me universel\r\n            const evaluation = await evaluateVariableOperation(\r\n              row.nodeId,\r\n              id, // submissionId\r\n              tx as any // Utiliser la transaction Prisma\r\n            );\r\n            \r\n            console.log(`[UNIVERSAL] \u00E2\u0153\u2026 R\u00C3\u00A9sultat: ${evaluation.value}`);\r\n            \r\n            // Utiliser le r\u00C3\u00A9sultat du syst\u00C3\u00A8me universel\r\n            opRes = evaluation.operationResult;\r\n            \r\n            // Mettre \u00C3\u00A0 jour la valeur calcul\u00C3\u00A9e dans la base\r\n            await tx.treeBranchLeafSubmissionData.updateMany({\r\n              where: { submissionId: id, nodeId: row.nodeId },\r\n              data: { value: evaluation.value }\r\n            });\r\n            \r\n          } catch (error) {\r\n            console.error(`[UNIVERSAL] \u00E2\u009D\u0152 Erreur \u00C3\u00A9valuation variable ${row.nodeId}:`, error);\r\n            \r\n            // Fallback vers l'ancien syst\u00C3\u00A8me en cas d'erreur\r\n            const parsed = parseSourceRef(row.sourceRef || meta?.sourceRef || null);\r\n            if (parsed?.type === 'condition') {\r\n              const rec = await tx.treeBranchLeafNodeCondition.findUnique({ where: { id: parsed.id }, select: { conditionSet: true } });\r\n              const ids = extractNodeIdsFromConditionSet(rec?.conditionSet);\r\n              const refs = buildResolvedRefs(ids, labelMap, valuesMapTxAll);\r\n              const human = `${display}`;\r\n              opRes = { type: 'condition', label: display, value: valueStr, unit: meta?.unit || null, refs, text: buildResultText(human, valueStr, meta?.unit || null) } as const;\r\n            } else if (parsed?.type === 'formula') {\r\n              const rec = await tx.treeBranchLeafNodeFormula.findUnique({ where: { id: parsed.id }, select: { tokens: true } });\r\n              const ids = extractNodeIdsFromTokens(rec?.tokens);\r\n              const refs = buildResolvedRefs(ids, labelMap, valuesMapTxAll);\r\n              const human = `${display}`;\r\n              opRes = { type: 'formula', label: display, value: valueStr, unit: meta?.unit || null, refs, text: buildResultText(human, valueStr, meta?.unit || null) } as const;\r\n            } else if (parsed?.type === 'table') {\r\n              const rec = await tx.treeBranchLeafNodeTable.findUnique({ where: { id: parsed.id }, select: { id: true, name: true, description: true, type: true, nodeId: true } });\r\n              const str = JSON.stringify(rec);\r\n              const ids = new Set<string>();\r\n              if (str) { let m: RegExpExecArray | null; const re = /@value\\.([a-f0-9-]{36})/gi; while ((m = re.exec(str)) !== null) ids.add(m[1]); }\r\n              const refs = buildResolvedRefs(ids, labelMap, valuesMapTxAll);\r\n              const human = `${display}`;\r\n              opRes = { type: 'table', label: display, value: valueStr, unit: meta?.unit || null, refs, text: buildResultText(human, valueStr, meta?.unit || null) } as const;\r\n            }\r\n          }\r\n        }\r\n        await tx.treeBranchLeafSubmissionData.updateMany({\r\n          where: { submissionId: id, nodeId: row.nodeId },\r\n          data: {\r\n            operationSource: opSrc,\r\n            operationDetail: opDetail ?? (isVar ? (meta?.sourceRef || undefined) : (label || undefined)),\r\n            operationResult: opRes,\r\n            lastResolved: now\r\n          }\r\n        });\r\n      }\r\n\r\n      // Mettre \u00C3\u00A0 jour le statut si fourni\r\n      if (status && typeof status === 'string') {\r\n        await tx.treeBranchLeafSubmission.update({ where: { id }, data: { status, updatedAt: new Date() } });\r\n      } else {\r\n        await tx.treeBranchLeafSubmission.update({ where: { id }, data: { updatedAt: new Date() } });\r\n      }\r\n    });\r\n\r\n    // Recharger et renvoyer\r\n    const full = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      include: {\r\n        TreeBranchLeafTree: { select: { id: true, name: true } },\r\n        Lead: { select: { id: true, firstName: true, lastName: true, email: true } },\r\n        TreeBranchLeafSubmissionData: { include: { TreeBranchLeafNode: { select: { id: true, label: true, type: true } } } }\r\n      }\r\n    });\r\n    return res.json(full);\r\n  } catch (error) {\r\n    console.error('[TreeBranchLeaf API] \u00E2\u009D\u0152 Erreur PUT /submissions/:id:', error);\r\n    return res.status(500).json({ error: 'Erreur lors de la mise \u00C3\u00A0 jour de la soumission' });\r\n  }\r\n});\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u017D\u00AF NOUVELLES ROUTES - SYST\u00C3\u02C6ME UNIVERSEL D'INTERPR\u00C3\u2030TATION TBL\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// Ces routes utilisent le syst\u00C3\u00A8me moderne operation-interpreter.ts\r\n// Elles sont IND\u00C3\u2030PENDANTES des anciens syst\u00C3\u00A8mes (CapacityCalculator, etc.)\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n/**\r\n * \u00F0\u0178\u017D\u00AF POST /api/treebranchleaf/v2/variables/:variableNodeId/evaluate\r\n * \r\n * \u00C3\u2030VALUE UNE VARIABLE avec le syst\u00C3\u00A8me universel d'interpr\u00C3\u00A9tation\r\n * \r\n * Cette route est le POINT D'ENTR\u00C3\u2030E PRINCIPAL pour \u00C3\u00A9valuer n'importe quelle\r\n * variable (condition, formule, table) de mani\u00C3\u00A8re r\u00C3\u00A9cursive et compl\u00C3\u00A8te.\r\n * \r\n * PARAM\u00C3\u02C6TRES :\r\n * ------------\r\n * - variableNodeId : ID du n\u00C5\u201Cud TreeBranchLeafNode qui contient la Variable\r\n * - submissionId (body) : ID de la soumission en cours\r\n * \r\n * RETOUR :\r\n * --------\r\n * {\r\n *   success: true,\r\n *   variable: { nodeId, displayName, exposedKey },\r\n *   result: {\r\n *     value: \"73\",              // Valeur calcul\u00C3\u00A9e finale\r\n *     operationDetail: {...},    // Structure d\u00C3\u00A9taill\u00C3\u00A9e compl\u00C3\u00A8te\r\n *     operationResult: \"Si...\",  // Texte explicatif en fran\u00C3\u00A7ais\r\n *     operationSource: \"table\"   // Type d'op\u00C3\u00A9ration source\r\n *   },\r\n *   evaluation: {\r\n *     mode: 'universal-interpreter',\r\n *     timestamp: \"2025-01-06T...\",\r\n *     depth: 0\r\n *   }\r\n * }\r\n * \r\n * EXEMPLES D'UTILISATION :\r\n * ------------------------\r\n * 1. Variable qui pointe vers une condition :\r\n *    POST /api/treebranchleaf/v2/variables/10bfb6d2.../evaluate\r\n *    Body: { submissionId: \"tbl-1759750447813-xxx\" }\r\n *    \u00E2\u2020\u2019 \u00C3\u2030value r\u00C3\u00A9cursivement la condition et retourne le r\u00C3\u00A9sultat\r\n * \r\n * 2. Variable qui pointe vers une table :\r\n *    POST /api/treebranchleaf/v2/variables/abc123.../evaluate\r\n *    Body: { submissionId: \"tbl-xxx\" }\r\n *    \u00E2\u2020\u2019 Effectue le lookup dans la table et retourne la valeur\r\n * \r\n * 3. Variable qui pointe vers une formule :\r\n *    POST /api/treebranchleaf/v2/variables/def456.../evaluate\r\n *    Body: { submissionId: \"tbl-xxx\" }\r\n *    \u00E2\u2020\u2019 Calcule la formule et retourne le r\u00C3\u00A9sultat\r\n */\r\nrouter.post('/v2/variables/:variableNodeId/evaluate', async (req, res) => {\r\n  try {\r\n    const { variableNodeId } = req.params;\r\n    const { submissionId } = req.body;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log('\\n' + '\u00E2\u2022\u0090'.repeat(80));\r\n    console.log('\u00F0\u0178\u017D\u00AF [V2 API] \u00C3\u2030VALUATION VARIABLE UNIVERSELLE');\r\n    console.log('\u00E2\u2022\u0090'.repeat(80));\r\n    console.log('\u00F0\u0178\u201C\u2039 Param\u00C3\u00A8tres:');\r\n    console.log('   - variableNodeId:', variableNodeId);\r\n    console.log('   - submissionId:', submissionId);\r\n    console.log('   - organizationId:', organizationId);\r\n    console.log('   - isSuperAdmin:', isSuperAdmin);\r\n    console.log('\u00E2\u2022\u0090'.repeat(80) + '\\n');\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00E2\u0153\u2026 \u00C3\u2030TAPE 1 : Validation des param\u00C3\u00A8tres\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    if (!variableNodeId) {\r\n      console.error('\u00E2\u009D\u0152 [V2 API] variableNodeId manquant');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'variableNodeId requis'\r\n      });\r\n    }\r\n\r\n    if (!submissionId) {\r\n      console.error('\u00E2\u009D\u0152 [V2 API] submissionId manquant');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'submissionId requis dans le body'\r\n      });\r\n    }\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201D\u008D \u00C3\u2030TAPE 2 : V\u00C3\u00A9rifier que le n\u00C5\u201Cud existe et est accessible\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: variableNodeId },\r\n      include: {\r\n        TreeBranchLeafTree: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            organizationId: true\r\n          }\r\n        },\r\n        TreeBranchLeafNodeVariable: {\r\n          select: {\r\n            id: true,\r\n            nodeId: true,\r\n            exposedKey: true,\r\n            displayName: true,\r\n            sourceType: true,\r\n            sourceRef: true,\r\n            fixedValue: true,\r\n            defaultValue: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      console.error('\u00E2\u009D\u0152 [V2 API] N\u00C5\u201Cud introuvable:', variableNodeId);\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'N\u00C5\u201Cud introuvable'\r\n      });\r\n    }\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] N\u00C5\u201Cud trouv\u00C3\u00A9:', node.label);\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201D\u2019 \u00C3\u2030TAPE 3 : V\u00C3\u00A9rifier les permissions d'organisation\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    if (!isSuperAdmin && node.TreeBranchLeafTree?.organizationId !== organizationId) {\r\n      console.error('\u00E2\u009D\u0152 [V2 API] Acc\u00C3\u00A8s refus\u00C3\u00A9 - mauvaise organisation');\r\n      return res.status(403).json({\r\n        success: false,\r\n        error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 ce n\u00C5\u201Cud'\r\n      });\r\n    }\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] Permissions valid\u00C3\u00A9es');\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201C\u0160 \u00C3\u2030TAPE 4 : V\u00C3\u00A9rifier qu'il y a bien une Variable associ\u00C3\u00A9e\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const variable = node.TreeBranchLeafNodeVariable?.[0];\r\n\r\n    if (!variable) {\r\n      console.error('\u00E2\u009D\u0152 [V2 API] Pas de variable associ\u00C3\u00A9e \u00C3\u00A0 ce n\u00C5\u201Cud');\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Ce n\u00C5\u201Cud ne contient pas de variable'\r\n      });\r\n    }\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] Variable trouv\u00C3\u00A9e:', variable.displayName);\r\n    console.log('   - sourceType:', variable.sourceType);\r\n    console.log('   - sourceRef:', variable.sourceRef);\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201D\u008D \u00C3\u2030TAPE 5 : V\u00C3\u00A9rifier que la soumission existe et est accessible\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id: submissionId },\r\n      select: {\r\n        id: true,\r\n        treeId: true,\r\n        leadId: true,\r\n        status: true\r\n      }\r\n    });\r\n\r\n    if (!submission) {\r\n      console.error('\u00E2\u009D\u0152 [V2 API] Soumission introuvable:', submissionId);\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Soumission introuvable'\r\n      });\r\n    }\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] Soumission trouv\u00C3\u00A9e:', submissionId);\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u0161\u20AC \u00C3\u2030TAPE 6 : \u00C3\u2030VALUATION UNIVERSELLE avec operation-interpreter\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    console.log('\\n' + '\u00E2\u201D\u20AC'.repeat(80));\r\n    console.log('\u00F0\u0178\u0161\u20AC [V2 API] D\u00C3\u00A9marrage \u00C3\u00A9valuation universelle...');\r\n    console.log('\u00E2\u201D\u20AC'.repeat(80) + '\\n');\r\n\r\n    const startTime = Date.now();\r\n\r\n    // Appel de la fonction principale du syst\u00C3\u00A8me universel\r\n    const evaluationResult = await evaluateVariableOperation(\r\n      variableNodeId,\r\n      submissionId,\r\n      prisma\r\n    );\r\n\r\n    const duration = Date.now() - startTime;\r\n\r\n    console.log('\\n' + '\u00E2\u201D\u20AC'.repeat(80));\r\n    console.log('\u00E2\u0153\u2026 [V2 API] \u00C3\u2030valuation termin\u00C3\u00A9e avec succ\u00C3\u00A8s !');\r\n    console.log('   - Dur\u00C3\u00A9e:', duration, 'ms');\r\n    console.log('   - R\u00C3\u00A9sultat:', evaluationResult.value);\r\n    console.log('   - OperationSource:', evaluationResult.operationSource);\r\n    console.log('\u00E2\u201D\u20AC'.repeat(80) + '\\n');\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u2019\u00BE \u00C3\u2030TAPE 7 : Sauvegarder le r\u00C3\u00A9sultat dans SubmissionData\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    console.log('\u00F0\u0178\u2019\u00BE [V2 API] Sauvegarde dans SubmissionData...');\r\n\r\n    await prisma.treeBranchLeafSubmissionData.upsert({\r\n      where: {\r\n        submissionId_nodeId: {\r\n          submissionId,\r\n          nodeId: variableNodeId\r\n        }\r\n      },\r\n      update: {\r\n        value: evaluationResult.value,\r\n        operationDetail: evaluationResult.operationDetail as Prisma.InputJsonValue,\r\n        operationResult: evaluationResult.operationResult,\r\n        operationSource: evaluationResult.operationSource,\r\n        lastResolved: new Date(),\r\n        updatedAt: new Date()\r\n      },\r\n      create: {\r\n        submissionId,\r\n        nodeId: variableNodeId,\r\n        value: evaluationResult.value,\r\n        operationDetail: evaluationResult.operationDetail as Prisma.InputJsonValue,\r\n        operationResult: evaluationResult.operationResult,\r\n        operationSource: evaluationResult.operationSource,\r\n        lastResolved: new Date(),\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] Sauvegarde effectu\u00C3\u00A9e\\n');\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201C\u00A4 \u00C3\u2030TAPE 8 : Retourner la r\u00C3\u00A9ponse compl\u00C3\u00A8te\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const response = {\r\n      success: true,\r\n      variable: {\r\n        nodeId: variable.nodeId,\r\n        displayName: variable.displayName,\r\n        exposedKey: variable.exposedKey,\r\n        sourceType: variable.sourceType,\r\n        sourceRef: variable.sourceRef\r\n      },\r\n      result: {\r\n        value: evaluationResult.value,\r\n        operationDetail: evaluationResult.operationDetail,\r\n        operationResult: evaluationResult.operationResult,\r\n        operationSource: evaluationResult.operationSource,\r\n        sourceRef: evaluationResult.sourceRef\r\n      },\r\n      evaluation: {\r\n        mode: 'universal-interpreter',\r\n        version: '1.0.0',\r\n        timestamp: new Date().toISOString(),\r\n        duration: `${duration}ms`,\r\n        submissionId,\r\n        nodeLabel: node.label\r\n      }\r\n    };\r\n\r\n    console.log('\u00E2\u2022\u0090'.repeat(80));\r\n    console.log('\u00F0\u0178\u201C\u00A4 [V2 API] R\u00C3\u00A9ponse envoy\u00C3\u00A9e avec succ\u00C3\u00A8s');\r\n    console.log('\u00E2\u2022\u0090'.repeat(80) + '\\n');\r\n\r\n    return res.json(response);\r\n\r\n  } catch (error) {\r\n    console.error('\\n' + '\u00E2\u2022\u0090'.repeat(80));\r\n    console.error('\u00E2\u009D\u0152 [V2 API] ERREUR CRITIQUE');\r\n    console.error('\u00E2\u2022\u0090'.repeat(80));\r\n    console.error(error);\r\n    console.error('\u00E2\u2022\u0090'.repeat(80) + '\\n');\r\n\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'\u00C3\u00A9valuation de la variable',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue',\r\n      stack: process.env.NODE_ENV === 'development' && error instanceof Error ? error.stack : undefined\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u201D\u008D GET /api/treebranchleaf/v2/submissions/:submissionId/variables\r\n * \r\n * R\u00C3\u2030CUP\u00C3\u02C6RE TOUTES LES VARIABLES d'une soumission avec leurs valeurs \u00C3\u00A9valu\u00C3\u00A9es\r\n * \r\n * Cette route permet d'obtenir un aper\u00C3\u00A7u complet de toutes les variables\r\n * d'une soumission, avec leurs valeurs calcul\u00C3\u00A9es et leurs textes explicatifs.\r\n * \r\n * RETOUR :\r\n * --------\r\n * {\r\n *   success: true,\r\n *   submissionId: \"tbl-xxx\",\r\n *   tree: { id, name },\r\n *   variables: [\r\n *     {\r\n *       nodeId: \"xxx\",\r\n *       displayName: \"Prix Kw/h test\",\r\n *       exposedKey: \"prix_kwh_test\",\r\n *       value: \"73\",\r\n *       operationResult: \"Si Prix > 10...\",\r\n *       operationSource: \"condition\",\r\n *       lastResolved: \"2025-01-06T...\"\r\n *     },\r\n *     ...\r\n *   ]\r\n * }\r\n */\r\nrouter.get('/v2/submissions/:submissionId/variables', async (req, res) => {\r\n  try {\r\n    const { submissionId } = req.params;\r\n    const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log('\\n\u00F0\u0178\u201D\u008D [V2 API] R\u00C3\u2030CUP\u00C3\u2030RATION VARIABLES:', submissionId);\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201D\u008D \u00C3\u2030TAPE 1 : R\u00C3\u00A9cup\u00C3\u00A9rer la soumission avec son tree\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id: submissionId },\r\n      include: {\r\n        TreeBranchLeafTree: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            organizationId: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!submission) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Soumission introuvable'\r\n      });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier les permissions\r\n    if (!isSuperAdmin && submission.TreeBranchLeafTree?.organizationId !== organizationId) {\r\n      return res.status(403).json({\r\n        success: false,\r\n        error: 'Acc\u00C3\u00A8s refus\u00C3\u00A9 \u00C3\u00A0 cette soumission'\r\n      });\r\n    }\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201C\u0160 \u00C3\u2030TAPE 2 : R\u00C3\u00A9cup\u00C3\u00A9rer toutes les variables du tree\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const variables = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      where: {\r\n        TreeBranchLeafNode: {\r\n          treeId: submission.treeId\r\n        }\r\n      },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            id: true,\r\n            label: true,\r\n            type: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] Variables trouv\u00C3\u00A9es:', variables.length);\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u2019\u00BE \u00C3\u2030TAPE 3 : R\u00C3\u00A9cup\u00C3\u00A9rer les valeurs depuis SubmissionData\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const submissionData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: {\r\n        submissionId,\r\n        nodeId: {\r\n          in: variables.map(v => v.nodeId)\r\n        }\r\n      }\r\n    });\r\n\r\n    // Cr\u00C3\u00A9er un Map pour lookup rapide\r\n    const dataMap = new Map(\r\n      submissionData.map(d => [d.nodeId, d])\r\n    );\r\n\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    // \u00F0\u0178\u201C\u2039 \u00C3\u2030TAPE 4 : Construire la r\u00C3\u00A9ponse\r\n    // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n    const variablesResponse = variables.map(variable => {\r\n      const data = dataMap.get(variable.nodeId);\r\n\r\n      return {\r\n        nodeId: variable.nodeId,\r\n        displayName: variable.displayName,\r\n        exposedKey: variable.exposedKey,\r\n        sourceType: variable.sourceType,\r\n        sourceRef: variable.sourceRef,\r\n        value: data?.value || null,\r\n        operationResult: data?.operationResult || null,\r\n        operationSource: data?.operationSource || null,\r\n        operationDetail: data?.operationDetail || null,\r\n        lastResolved: data?.lastResolved || null,\r\n        nodeLabel: variable.TreeBranchLeafNode?.label || 'Inconnu',\r\n        nodeType: variable.TreeBranchLeafNode?.type || 'unknown'\r\n      };\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [V2 API] R\u00C3\u00A9ponse construite\\n');\r\n\r\n    return res.json({\r\n      success: true,\r\n      submissionId,\r\n      tree: {\r\n        id: submission.TreeBranchLeafTree?.id,\r\n        name: submission.TreeBranchLeafTree?.name\r\n      },\r\n      variables: variablesResponse,\r\n      meta: {\r\n        totalVariables: variables.length,\r\n        evaluatedVariables: submissionData.length\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [V2 API] Erreur r\u00C3\u00A9cup\u00C3\u00A9ration variables:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des variables',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u201C\u00A4 FIN DU SYST\u00C3\u02C6ME UNIVERSEL V2\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u2019\u00BE SYST\u00C3\u02C6ME DE SAUVEGARDE TBL AVANC\u00C3\u2030 - Brouillons & Versioning\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n/**\r\n * \u00F0\u0178\u017D\u00AF POST /api/tbl/submissions/stage\r\n * Cr\u00C3\u00A9e ou met \u00C3\u00A0 jour un brouillon temporaire (stage)\r\n * TTL: 24h - Auto-renouvel\u00C3\u00A9 lors des modifications\r\n */\r\nrouter.post('/submissions/stage', async (req, res) => {\r\n  try {\r\n    const { stageId, treeId, submissionId, leadId, formData, baseVersion } = req.body;\r\n    const userId = (req as any).user?.id || 'system';\r\n\r\n    console.log('\u00F0\u0178\u201C\u009D [STAGE] Cr\u00C3\u00A9ation/Update brouillon:', { stageId, treeId, submissionId, leadId, userId });\r\n\r\n    // Calculer expiration (+24h)\r\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);\r\n\r\n    let stage;\r\n\r\n    if (stageId) {\r\n      // Mise \u00C3\u00A0 jour d'un stage existant\r\n      stage = await prisma.treeBranchLeafStage.update({\r\n        where: { id: stageId },\r\n        data: {\r\n          formData: formData || {},\r\n          lastActivity: new Date(),\r\n          expiresAt, // Renouvelle l'expiration\r\n        }\r\n      });\r\n      console.log('\u00E2\u0153\u2026 [STAGE] Brouillon mis \u00C3\u00A0 jour:', stage.id);\r\n    } else {\r\n      // Cr\u00C3\u00A9ation d'un nouveau stage\r\n      if (!treeId || !leadId) {\r\n        return res.status(400).json({\r\n          success: false,\r\n          error: 'treeId et leadId sont requis pour cr\u00C3\u00A9er un stage'\r\n        });\r\n      }\r\n\r\n      // R\u00C3\u00A9cup\u00C3\u00A9rer la version de base si submissionId fourni\r\n      let currentBaseVersion = baseVersion || 1;\r\n      if (submissionId && !baseVersion) {\r\n        const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n          where: { id: submissionId },\r\n          select: { currentVersion: true }\r\n        });\r\n        currentBaseVersion = submission?.currentVersion || 1;\r\n      }\r\n\r\n      stage = await prisma.treeBranchLeafStage.create({\r\n        data: {\r\n          id: randomUUID(),\r\n          treeId,\r\n          submissionId,\r\n          leadId,\r\n          userId,\r\n          formData: formData || {},\r\n          baseVersion: currentBaseVersion,\r\n          expiresAt\r\n        }\r\n      });\r\n      console.log('\u00E2\u0153\u2026 [STAGE] Nouveau brouillon cr\u00C3\u00A9\u00C3\u00A9:', stage.id);\r\n    }\r\n\r\n    return res.json({\r\n      success: true,\r\n      stage: {\r\n        id: stage.id,\r\n        expiresAt: stage.expiresAt,\r\n        lastActivity: stage.lastActivity\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [STAGE] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la gestion du brouillon',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u201D\u008D POST /api/tbl/submissions/stage/preview\r\n * Pr\u00C3\u00A9visualise les calculs d'un stage sans sauvegarder\r\n * Utilise operation-interpreter pour \u00C3\u00A9valuer toutes les formules\r\n */\r\nrouter.post('/submissions/stage/preview', async (req, res) => {\r\n  try {\r\n    const { stageId } = req.body;\r\n\r\n    if (!stageId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'stageId requis'\r\n      });\r\n    }\r\n\r\n    console.log('\u00F0\u0178\u201D\u008D [STAGE PREVIEW] Pr\u00C3\u00A9visualisation pour:', stageId);\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer le stage\r\n    const stage = await prisma.treeBranchLeafStage.findUnique({\r\n      where: { id: stageId }\r\n    });\r\n\r\n    if (!stage) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Stage non trouv\u00C3\u00A9'\r\n      });\r\n    }\r\n\r\n    // \u00E2\u0153\u00A8 \u00C3\u2030valuer tous les n\u00C5\u201Cuds variables avec operation-interpreter\r\n    const { evaluateVariableOperation } = await import('./operation-interpreter');\r\n    \r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds variables de l'arbre\r\n    const variableNodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: { \r\n        treeId: stage.treeId,\r\n        subType: 'variable'\r\n      },\r\n      select: { id: true, label: true }\r\n    });\r\n\r\n    // Cr\u00C3\u00A9er une valueMap \u00C3\u00A0 partir du formData du stage\r\n    const valueMapLocal = new Map<string, unknown>();\r\n    Object.entries(stage.formData as Record<string, unknown>).forEach(([nodeId, value]) => {\r\n      valueMapLocal.set(nodeId, value);\r\n    });\r\n\r\n    // \u00C3\u2030valuer chaque variable\r\n    const results = await Promise.all(\r\n      variableNodes.map(async (node) => {\r\n        try {\r\n          const evalResult = await evaluateVariableOperation(\r\n            node.id,\r\n            stage.submissionId || stage.id,\r\n            prisma,\r\n            valueMapLocal\r\n          );\r\n          return {\r\n            nodeId: node.id,\r\n            nodeLabel: node.label,\r\n            sourceRef: evalResult.sourceRef,\r\n            operationSource: evalResult.operationSource,\r\n            operationResult: evalResult.operationResult,\r\n            operationDetail: evalResult.operationDetail\r\n          };\r\n        } catch (error) {\r\n          console.error(`\u00E2\u009D\u0152 Erreur \u00C3\u00A9valuation ${node.id}:`, error);\r\n          return {\r\n            nodeId: node.id,\r\n            nodeLabel: node.label,\r\n            sourceRef: '',\r\n            operationSource: 'field' as const,\r\n            operationResult: 'ERROR',\r\n            operationDetail: null\r\n          };\r\n        }\r\n      })\r\n    );\r\n\r\n    console.log('\u00E2\u0153\u2026 [STAGE PREVIEW] R\u00C3\u00A9sultats:', results.length, 'noeuds \u00C3\u00A9valu\u00C3\u00A9s');\r\n\r\n    return res.json({\r\n      success: true,\r\n      stageId: stage.id,\r\n      results: results.map(r => ({\r\n        nodeId: r.nodeId,\r\n        nodeLabel: r.nodeLabel,\r\n        sourceRef: r.sourceRef,\r\n        operationSource: r.operationSource,\r\n        operationResult: r.operationResult,\r\n        operationDetail: r.operationDetail\r\n      }))\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [STAGE PREVIEW] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la pr\u00C3\u00A9visualisation',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u2019\u00BE POST /api/tbl/submissions/stage/commit\r\n * Commit un stage vers une submission d\u00C3\u00A9finitive\r\n * G\u00C3\u00A8re les conflits multi-utilisateurs et le versioning\r\n */\r\nrouter.post('/submissions/stage/commit', async (req, res) => {\r\n  try {\r\n    const { stageId, asNew } = req.body;\r\n    const userId = (req as any).user?.id || 'system';\r\n\r\n    if (!stageId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'stageId requis'\r\n      });\r\n    }\r\n\r\n    console.log('\u00F0\u0178\u2019\u00BE [STAGE COMMIT] Commit brouillon:', { stageId, asNew, userId });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer le stage\r\n    const stage = await prisma.treeBranchLeafStage.findUnique({\r\n      where: { id: stageId }\r\n    });\r\n\r\n    if (!stage) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Stage non trouv\u00C3\u00A9'\r\n      });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier si le stage n'a pas expir\u00C3\u00A9\r\n    if (stage.expiresAt < new Date()) {\r\n      return res.status(410).json({\r\n        success: false,\r\n        error: 'Ce brouillon a expir\u00C3\u00A9',\r\n        expired: true\r\n      });\r\n    }\r\n\r\n    let submissionId: string;\r\n    let newVersion = 1;\r\n\r\n    if (asNew || !stage.submissionId) {\r\n      // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090 CR\u00C3\u2030ATION NOUVELLE SUBMISSION \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n      console.log('\u00F0\u0178\u2020\u2022 [STAGE COMMIT] Cr\u00C3\u00A9ation nouvelle submission');\r\n\r\n      // \u00E2\u0153\u00A8 \u00C3\u2030valuer avec operation-interpreter\r\n      const { evaluateVariableOperation } = await import('./operation-interpreter');\r\n      \r\n      // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds variables de l'arbre\r\n      const variableNodes = await prisma.treeBranchLeafNode.findMany({\r\n        where: { \r\n          treeId: stage.treeId,\r\n          subType: 'variable'\r\n        },\r\n        select: { id: true, label: true }\r\n      });\r\n\r\n      // Cr\u00C3\u00A9er une valueMap \u00C3\u00A0 partir du formData du stage\r\n      const valueMapLocal = new Map<string, unknown>();\r\n      Object.entries(stage.formData as Record<string, unknown>).forEach(([nodeId, value]) => {\r\n        valueMapLocal.set(nodeId, value);\r\n      });\r\n\r\n      // \u00C3\u2030valuer chaque variable\r\n      const results = await Promise.all(\r\n        variableNodes.map(async (node) => {\r\n          try {\r\n            const evalResult = await evaluateVariableOperation(\r\n              node.id,\r\n              stage.id,\r\n              prisma,\r\n              valueMapLocal\r\n            );\r\n            return {\r\n              nodeId: node.id,\r\n              nodeLabel: node.label,\r\n              value: evalResult.value,\r\n              operationSource: evalResult.operationSource,\r\n              operationResult: evalResult.operationResult,\r\n              operationDetail: evalResult.operationDetail\r\n            };\r\n          } catch (error) {\r\n            console.error(`\u00E2\u009D\u0152 Erreur \u00C3\u00A9valuation ${node.id}:`, error);\r\n            return null;\r\n          }\r\n        })\r\n      ).then(res => res.filter(r => r !== null));\r\n\r\n      // Cr\u00C3\u00A9er la submission dans une transaction\r\n      const result = await prisma.$transaction(async (tx) => {\r\n        // Cr\u00C3\u00A9er la submission\r\n        const submission = await tx.treeBranchLeafSubmission.create({\r\n          data: {\r\n            id: randomUUID(),\r\n            treeId: stage.treeId,\r\n            userId: stage.userId,\r\n            leadId: stage.leadId,\r\n            status: 'draft',\r\n            currentVersion: 1,\r\n            lastEditedBy: userId,\r\n            summary: {},\r\n            updatedAt: new Date()\r\n          }\r\n        });\r\n\r\n        // Cr\u00C3\u00A9er les donn\u00C3\u00A9es de soumission\r\n        if (results.length > 0) {\r\n          await tx.treeBranchLeafSubmissionData.createMany({\r\n            data: results.map(r => ({\r\n              id: randomUUID(),\r\n              submissionId: submission.id,\r\n              nodeId: r.nodeId,\r\n              value: String(r.operationResult || ''),\r\n              fieldLabel: r.nodeLabel,\r\n              sourceRef: r.sourceRef,\r\n              operationSource: r.operationSource,\r\n              operationResult: r.operationResult as Prisma.JsonValue,\r\n              operationDetail: r.operationDetail as Prisma.JsonValue,\r\n              lastResolved: new Date()\r\n            }))\r\n          });\r\n        }\r\n\r\n        // Cr\u00C3\u00A9er la premi\u00C3\u00A8re version\r\n        await tx.treeBranchLeafSubmissionVersion.create({\r\n          data: {\r\n            id: randomUUID(),\r\n            submissionId: submission.id,\r\n            version: 1,\r\n            formData: stage.formData,\r\n            summary: 'Version initiale',\r\n            createdBy: userId\r\n          }\r\n        });\r\n\r\n        // Supprimer le stage\r\n        await tx.treeBranchLeafStage.delete({\r\n          where: { id: stageId }\r\n        });\r\n\r\n        return submission;\r\n      });\r\n\r\n      submissionId = result.id;\r\n      newVersion = 1;\r\n\r\n      console.log('\u00E2\u0153\u2026 [STAGE COMMIT] Nouvelle submission cr\u00C3\u00A9\u00C3\u00A9e:', submissionId);\r\n\r\n    } else {\r\n      // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090 MISE \u00C3\u20AC JOUR SUBMISSION EXISTANTE \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n      console.log('\u00F0\u0178\u201D\u201E [STAGE COMMIT] Mise \u00C3\u00A0 jour submission existante:', stage.submissionId);\r\n\r\n      // R\u00C3\u00A9cup\u00C3\u00A9rer la submission actuelle\r\n      const currentSubmission = await prisma.treeBranchLeafSubmission.findUnique({\r\n        where: { id: stage.submissionId },\r\n        select: {\r\n          id: true,\r\n          currentVersion: true,\r\n          lastEditedBy: true,\r\n          updatedAt: true,\r\n          lockedBy: true,\r\n          lockedAt: true\r\n        }\r\n      });\r\n\r\n      if (!currentSubmission) {\r\n        return res.status(404).json({\r\n          success: false,\r\n          error: 'Submission originale non trouv\u00C3\u00A9e'\r\n        });\r\n      }\r\n\r\n      // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090 D\u00C3\u2030TECTION CONFLITS \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n      if (currentSubmission.currentVersion > stage.baseVersion) {\r\n        console.log('\u00E2\u0161\u00A0\u00EF\u00B8\u008F [STAGE COMMIT] Conflit d\u00C3\u00A9tect\u00C3\u00A9!', {\r\n          baseVersion: stage.baseVersion,\r\n          currentVersion: currentSubmission.currentVersion\r\n        });\r\n\r\n        // R\u00C3\u00A9cup\u00C3\u00A9rer les donn\u00C3\u00A9es actuelles pour comparaison\r\n        const currentData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n          where: { submissionId: stage.submissionId },\r\n          select: { nodeId: true, value: true }\r\n        });\r\n\r\n        const currentDataMap = new Map(currentData.map(d => [d.nodeId, d.value]));\r\n        const stageFormData = stage.formData as Record<string, unknown>;\r\n\r\n        // D\u00C3\u00A9tecter les conflits champ par champ\r\n        const conflicts = [];\r\n        for (const [nodeId, stageValue] of Object.entries(stageFormData)) {\r\n          const currentValue = currentDataMap.get(nodeId);\r\n          // Conflit si la valeur a chang\u00C3\u00A9 des deux c\u00C3\u00B4t\u00C3\u00A9s\r\n          if (currentValue !== undefined && String(stageValue) !== currentValue) {\r\n            conflicts.push({\r\n              nodeId,\r\n              yourValue: stageValue,\r\n              theirValue: currentValue\r\n            });\r\n          }\r\n        }\r\n\r\n        if (conflicts.length > 0) {\r\n          console.log('\u00E2\u009D\u0152 [STAGE COMMIT] Conflits \u00C3\u00A0 r\u00C3\u00A9soudre:', conflicts.length);\r\n          return res.status(409).json({\r\n            success: false,\r\n            conflict: true,\r\n            conflicts,\r\n            lastEditedBy: currentSubmission.lastEditedBy,\r\n            lastEditedAt: currentSubmission.updatedAt,\r\n            message: 'Des modifications ont \u00C3\u00A9t\u00C3\u00A9 faites par un autre utilisateur'\r\n          });\r\n        }\r\n\r\n        console.log('\u00E2\u0153\u2026 [STAGE COMMIT] Pas de conflit r\u00C3\u00A9el - merge automatique');\r\n      }\r\n\r\n      // V\u00C3\u00A9rifier le verrouillage\r\n      if (currentSubmission.lockedBy && currentSubmission.lockedBy !== userId) {\r\n        const lockAge = currentSubmission.lockedAt ? \r\n          Date.now() - new Date(currentSubmission.lockedAt).getTime() : 0;\r\n        \r\n        // Lock expire apr\u00C3\u00A8s 1h\r\n        if (lockAge < 60 * 60 * 1000) {\r\n          return res.status(423).json({\r\n            success: false,\r\n            locked: true,\r\n            lockedBy: currentSubmission.lockedBy,\r\n            message: 'Ce devis est en cours d\\'\u00C3\u00A9dition par un autre utilisateur'\r\n          });\r\n        }\r\n      }\r\n\r\n      // \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090 COMMIT AVEC VERSIONING \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n      const result = await prisma.$transaction(async (tx) => {\r\n        // \u00E2\u0153\u00A8 \u00C3\u2030valuer avec operation-interpreter\r\n        const { evaluateVariableOperation } = await import('./operation-interpreter');\r\n        \r\n        // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds variables de l'arbre\r\n        const variableNodes = await tx.treeBranchLeafNode.findMany({\r\n          where: { \r\n            treeId: stage.treeId,\r\n            subType: 'variable'\r\n          },\r\n          select: { id: true, label: true }\r\n        });\r\n\r\n        // Cr\u00C3\u00A9er une valueMap \u00C3\u00A0 partir du formData du stage\r\n        const valueMapLocal = new Map<string, unknown>();\r\n        Object.entries(stage.formData as Record<string, unknown>).forEach(([nodeId, value]) => {\r\n          valueMapLocal.set(nodeId, value);\r\n        });\r\n\r\n        // \u00C3\u2030valuer chaque variable\r\n        const results = await Promise.all(\r\n          variableNodes.map(async (node) => {\r\n            try {\r\n              const evalResult = await evaluateVariableOperation(\r\n                node.id,\r\n                stage.submissionId!,\r\n                tx as any,\r\n                valueMapLocal\r\n              );\r\n              return {\r\n                nodeId: node.id,\r\n                nodeLabel: node.label,\r\n                value: evalResult.value,\r\n                operationSource: evalResult.operationSource,\r\n                operationResult: evalResult.operationResult,\r\n                operationDetail: evalResult.operationDetail\r\n              };\r\n            } catch (error) {\r\n              console.error(`\u00E2\u009D\u0152 Erreur \u00C3\u00A9valuation ${node.id}:`, error);\r\n              return null;\r\n            }\r\n          })\r\n        ).then(res => res.filter(r => r !== null));\r\n\r\n        const nextVersion = currentSubmission.currentVersion + 1;\r\n\r\n        // Mettre \u00C3\u00A0 jour la submission\r\n        const updated = await tx.treeBranchLeafSubmission.update({\r\n          where: { id: stage.submissionId },\r\n          data: {\r\n            currentVersion: nextVersion,\r\n            lastEditedBy: userId,\r\n            lockedBy: null, // Lib\u00C3\u00A9rer le lock\r\n            lockedAt: null,\r\n            updatedAt: new Date()\r\n          }\r\n        });\r\n\r\n        // Supprimer les anciennes donn\u00C3\u00A9es\r\n        await tx.treeBranchLeafSubmissionData.deleteMany({\r\n          where: { submissionId: stage.submissionId }\r\n        });\r\n\r\n        // Cr\u00C3\u00A9er les nouvelles donn\u00C3\u00A9es\r\n        if (results.length > 0) {\r\n          await tx.treeBranchLeafSubmissionData.createMany({\r\n            data: results.map(r => ({\r\n              id: randomUUID(),\r\n              submissionId: updated.id,\r\n              nodeId: r.nodeId,\r\n              value: String(r.operationResult || ''),\r\n              fieldLabel: r.nodeLabel,\r\n              sourceRef: r.sourceRef,\r\n              operationSource: r.operationSource,\r\n              operationResult: r.operationResult as Prisma.JsonValue,\r\n              operationDetail: r.operationDetail as Prisma.JsonValue,\r\n              lastResolved: new Date()\r\n            }))\r\n          });\r\n        }\r\n\r\n        // Cr\u00C3\u00A9er la nouvelle version\r\n        await tx.treeBranchLeafSubmissionVersion.create({\r\n          data: {\r\n            id: randomUUID(),\r\n            submissionId: updated.id,\r\n            version: nextVersion,\r\n            formData: stage.formData,\r\n            createdBy: userId\r\n          }\r\n        });\r\n\r\n        // Nettoyer les vieilles versions (garder 20 derni\u00C3\u00A8res)\r\n        const versions = await tx.treeBranchLeafSubmissionVersion.findMany({\r\n          where: { submissionId: updated.id },\r\n          orderBy: { version: 'desc' },\r\n          skip: 20,\r\n          select: { id: true }\r\n        });\r\n\r\n        if (versions.length > 0) {\r\n          await tx.treeBranchLeafSubmissionVersion.deleteMany({\r\n            where: { id: { in: versions.map(v => v.id) } }\r\n          });\r\n          console.log(`\u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F [STAGE COMMIT] ${versions.length} anciennes versions supprim\u00C3\u00A9es`);\r\n        }\r\n\r\n        // Supprimer le stage\r\n        await tx.treeBranchLeafStage.delete({\r\n          where: { id: stageId }\r\n        });\r\n\r\n        return { submission: updated, version: nextVersion };\r\n      });\r\n\r\n      submissionId = result.submission.id;\r\n      newVersion = result.version;\r\n\r\n      console.log('\u00E2\u0153\u2026 [STAGE COMMIT] Submission mise \u00C3\u00A0 jour:', submissionId, 'v' + newVersion);\r\n    }\r\n\r\n    return res.json({\r\n      success: true,\r\n      submissionId,\r\n      version: newVersion,\r\n      message: 'Devis enregistr\u00C3\u00A9 avec succ\u00C3\u00A8s'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [STAGE COMMIT] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la sauvegarde',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F POST /api/tbl/submissions/stage/discard\r\n * Supprime un brouillon (annulation)\r\n */\r\nrouter.post('/submissions/stage/discard', async (req, res) => {\r\n  try {\r\n    const { stageId } = req.body;\r\n\r\n    if (!stageId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'stageId requis'\r\n      });\r\n    }\r\n\r\n    console.log('\u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F [STAGE DISCARD] Suppression brouillon:', stageId);\r\n\r\n    await prisma.treeBranchLeafStage.delete({\r\n      where: { id: stageId }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [STAGE DISCARD] Brouillon supprim\u00C3\u00A9');\r\n\r\n    return res.json({\r\n      success: true,\r\n      message: 'Brouillon supprim\u00C3\u00A9'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [STAGE DISCARD] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la suppression du brouillon',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u201C\u2039 GET /api/tbl/submissions/my-drafts\r\n * R\u00C3\u00A9cup\u00C3\u00A8re les brouillons non sauvegard\u00C3\u00A9s de l'utilisateur\r\n * Pour r\u00C3\u00A9cup\u00C3\u00A9ration automatique au retour\r\n */\r\nrouter.get('/submissions/my-drafts', async (req, res) => {\r\n  try {\r\n    const userId = (req as any).user?.id || 'system';\r\n    const { leadId, treeId } = req.query;\r\n\r\n    console.log('\u00F0\u0178\u201C\u2039 [MY DRAFTS] R\u00C3\u00A9cup\u00C3\u00A9ration brouillons:', { userId, leadId, treeId });\r\n\r\n    const where: any = {\r\n      userId,\r\n      expiresAt: { gt: new Date() } // Seulement les non-expir\u00C3\u00A9s\r\n    };\r\n\r\n    if (leadId) where.leadId = leadId;\r\n    if (treeId) where.treeId = treeId;\r\n\r\n    const drafts = await prisma.treeBranchLeafStage.findMany({\r\n      where,\r\n      orderBy: { lastActivity: 'desc' },\r\n      include: {\r\n        Lead: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            company: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [MY DRAFTS] Trouv\u00C3\u00A9:', drafts.length, 'brouillons');\r\n\r\n    return res.json({\r\n      success: true,\r\n      drafts: drafts.map(d => ({\r\n        stageId: d.id,\r\n        treeId: d.treeId,\r\n        submissionId: d.submissionId,\r\n        leadId: d.leadId,\r\n        leadName: d.Lead ? \r\n          `${d.Lead.firstName || ''} ${d.Lead.lastName || ''}`.trim() || d.Lead.company || 'Lead' \r\n          : 'Lead',\r\n        lastActivity: d.lastActivity,\r\n        expiresAt: d.expiresAt,\r\n        formData: d.formData\r\n      }))\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [MY DRAFTS] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration des brouillons',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u201C\u0153 GET /api/tbl/submissions/:id/versions\r\n * R\u00C3\u00A9cup\u00C3\u00A8re l'historique des versions d'une submission\r\n */\r\nrouter.get('/submissions/:id/versions', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    console.log('\u00F0\u0178\u201C\u0153 [VERSIONS] R\u00C3\u00A9cup\u00C3\u00A9ration historique:', id);\r\n\r\n    const versions = await prisma.treeBranchLeafSubmissionVersion.findMany({\r\n      where: { submissionId: id },\r\n      orderBy: { version: 'desc' },\r\n      include: {\r\n        User: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [VERSIONS] Trouv\u00C3\u00A9:', versions.length, 'versions');\r\n\r\n    return res.json({\r\n      success: true,\r\n      submissionId: id,\r\n      versions: versions.map(v => ({\r\n        id: v.id,\r\n        version: v.version,\r\n        summary: v.summary,\r\n        createdAt: v.createdAt,\r\n        createdBy: {\r\n          id: v.User.id,\r\n          name: `${v.User.firstName || ''} ${v.User.lastName || ''}`.trim() || v.User.email\r\n        }\r\n      }))\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [VERSIONS] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00C3\u00A9cup\u00C3\u00A9ration de l\\'historique',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u00F0\u0178\u201D\u2122 POST /api/tbl/submissions/:id/restore/:version\r\n * Restaure une version ant\u00C3\u00A9rieure d'une submission\r\n */\r\nrouter.post('/submissions/:id/restore/:version', async (req, res) => {\r\n  try {\r\n    const { id, version } = req.params;\r\n    const userId = (req as any).user?.id || 'system';\r\n\r\n    console.log('\u00F0\u0178\u201D\u2122 [RESTORE] Restauration version:', { id, version, userId });\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer la version \u00C3\u00A0 restaurer\r\n    const versionToRestore = await prisma.treeBranchLeafSubmissionVersion.findUnique({\r\n      where: {\r\n        submissionId_version: {\r\n          submissionId: id,\r\n          version: parseInt(version)\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!versionToRestore) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Version non trouv\u00C3\u00A9e'\r\n      });\r\n    }\r\n\r\n    // Cr\u00C3\u00A9er un stage avec les donn\u00C3\u00A9es de cette version\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id },\r\n      select: { treeId: true, leadId: true, currentVersion: true }\r\n    });\r\n\r\n    if (!submission) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Submission non trouv\u00C3\u00A9e'\r\n      });\r\n    }\r\n\r\n    const stage = await prisma.treeBranchLeafStage.create({\r\n      data: {\r\n        id: randomUUID(),\r\n        treeId: submission.treeId,\r\n        submissionId: id,\r\n        leadId: submission.leadId || 'unknown',\r\n        userId,\r\n        formData: versionToRestore.formData,\r\n        baseVersion: submission.currentVersion,\r\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [RESTORE] Stage cr\u00C3\u00A9\u00C3\u00A9 pour restauration:', stage.id);\r\n\r\n    return res.json({\r\n      success: true,\r\n      stageId: stage.id,\r\n      message: `Version ${version} charg\u00C3\u00A9e en brouillon. Enregistrez pour confirmer la restauration.`\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [RESTORE] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la restauration',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u2019\u00BE FIN DU SYST\u00C3\u02C6ME DE SAUVEGARDE TBL AVANC\u00C3\u2030\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u201D\u2014 SYST\u00C3\u02C6ME DE R\u00C3\u2030F\u00C3\u2030RENCES PARTAG\u00C3\u2030ES (SHARED REFERENCES)\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n// GET /api/treebranchleaf/shared-references - Liste toutes les r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es disponibles\r\nrouter.get('/shared-references', async (req, res) => {\r\n  try {\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // R\u00C3\u00A9cup\u00C3\u00A9rer tous les n\u00C5\u201Cuds marqu\u00C3\u00A9s comme templates (sources de r\u00C3\u00A9f\u00C3\u00A9rences)\r\n    // \u00F0\u0178\u017D\u00AF FILTRER les options SELECT pour qu'elles n'apparaissent pas dans les choix\r\n    const templates = await prisma.treeBranchLeafNode.findMany({\r\n      where: {\r\n        isSharedReference: true,\r\n        sharedReferenceId: null, // C'est une source, pas une r\u00C3\u00A9f\u00C3\u00A9rence\r\n        type: {\r\n          not: 'leaf_option' // \u00E2\u009D\u0152 Exclure les options de SELECT\r\n        },\r\n        TreeBranchLeafTree: {\r\n          organizationId\r\n        }\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        sharedReferenceName: true,\r\n        // \u00E2\u0153\u2026 sharedReferenceCategory SUPPRIM\u00C3\u2030\r\n        sharedReferenceDescription: true,\r\n        referenceUsages: {\r\n          select: {\r\n            id: true,\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: {\r\n                name: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    console.log(`\u00F0\u0178\u201C\u0160 [SHARED REF] ${templates.length} r\u00C3\u00A9f\u00C3\u00A9rences trouv\u00C3\u00A9es en base`);\r\n    templates.forEach((t, i) => {\r\n      console.log(`  ${i + 1}. ID: ${t.id}, Nom: ${t.sharedReferenceName}, Label: ${t.label}`);\r\n    });\r\n\r\n    const formatted = templates.map(template => ({\r\n      id: template.id,\r\n      label: template.sharedReferenceName || template.label,\r\n      // \u00E2\u0153\u2026 category SUPPRIM\u00C3\u2030\r\n      description: template.sharedReferenceDescription,\r\n      usageCount: template.referenceUsages.length,\r\n      usages: template.referenceUsages.map(usage => ({\r\n        treeId: usage.treeId,\r\n        path: `${usage.TreeBranchLeafTree.name}`\r\n      }))\r\n    }));\r\n\r\n    console.log(`\u00F0\u0178\u201C\u00A4 [SHARED REF] Retour au frontend: ${JSON.stringify(formatted, null, 2)}`);\r\n    res.json(formatted);\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur liste:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// GET /api/treebranchleaf/shared-references/:refId - D\u00C3\u00A9tails d'une r\u00C3\u00A9f\u00C3\u00A9rence\r\nrouter.get('/shared-references/:refId', async (req, res) => {\r\n  try {\r\n    const { refId } = req.params;\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    const template = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: refId,\r\n        isSharedReference: true,\r\n        sharedReferenceId: null,\r\n        TreeBranchLeafTree: {\r\n          organizationId\r\n        }\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        sharedReferenceName: true,\r\n        // \u00E2\u0153\u2026 sharedReferenceCategory SUPPRIM\u00C3\u2030\r\n        sharedReferenceDescription: true,\r\n        referenceUsages: {\r\n          select: {\r\n            id: true,\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: {\r\n                name: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!template) {\r\n      return res.status(404).json({ error: 'R\u00C3\u00A9f\u00C3\u00A9rence introuvable' });\r\n    }\r\n\r\n    res.json({\r\n      id: template.id,\r\n      label: template.sharedReferenceName || template.label,\r\n      // \u00E2\u0153\u2026 category SUPPRIM\u00C3\u2030\r\n      description: template.sharedReferenceDescription,\r\n      usageCount: template.referenceUsages.length,\r\n      usages: template.referenceUsages.map(usage => ({\r\n        treeId: usage.treeId,\r\n        path: `${usage.TreeBranchLeafTree.name}`\r\n      }))\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur d\u00C3\u00A9tails:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// PUT /api/treebranchleaf/shared-references/:refId - Modifier une r\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9e\r\nrouter.put('/shared-references/:refId', async (req, res) => {\r\n  try {\r\n    const { refId } = req.params;\r\n    const { name, description } = req.body;\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier que la r\u00C3\u00A9f\u00C3\u00A9rence existe et appartient \u00C3\u00A0 l'organisation\r\n    const template = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: refId,\r\n        isSharedReference: true,\r\n        sharedReferenceId: null,\r\n        TreeBranchLeafTree: {\r\n          organizationId\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!template) {\r\n      return res.status(404).json({ error: 'R\u00C3\u00A9f\u00C3\u00A9rence introuvable' });\r\n    }\r\n\r\n    // Mettre \u00C3\u00A0 jour la r\u00C3\u00A9f\u00C3\u00A9rence\r\n    const updated = await prisma.treeBranchLeafNode.update({\r\n      where: { id: refId },\r\n      data: {\r\n        sharedReferenceName: name || template.sharedReferenceName,\r\n        sharedReferenceDescription: description !== undefined ? description : template.sharedReferenceDescription,\r\n        label: name || template.label,\r\n        updatedAt: new Date()\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        sharedReferenceName: true,\r\n        sharedReferenceDescription: true\r\n      }\r\n    });\r\n\r\n    console.log(`\u00E2\u0153\u2026 [SHARED REF] R\u00C3\u00A9f\u00C3\u00A9rence ${refId} modifi\u00C3\u00A9e:`, updated);\r\n    res.json({ success: true, reference: updated });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur modification:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la modification' });\r\n  }\r\n});\r\n\r\n// DELETE /api/treebranchleaf/shared-references/:refId - Supprimer une r\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9e\r\nrouter.delete('/shared-references/:refId', async (req, res) => {\r\n  try {\r\n    const { refId } = req.params;\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    // V\u00C3\u00A9rifier que la r\u00C3\u00A9f\u00C3\u00A9rence existe et appartient \u00C3\u00A0 l'organisation\r\n    const template = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: refId,\r\n        isSharedReference: true,\r\n        sharedReferenceId: null,\r\n        TreeBranchLeafTree: {\r\n          organizationId\r\n        }\r\n      },\r\n      include: {\r\n        referenceUsages: true\r\n      }\r\n    });\r\n\r\n    if (!template) {\r\n      return res.status(404).json({ error: 'R\u00C3\u00A9f\u00C3\u00A9rence introuvable' });\r\n    }\r\n\r\n    // Si la r\u00C3\u00A9f\u00C3\u00A9rence est utilis\u00C3\u00A9e, d\u00C3\u00A9tacher tous les usages avant de supprimer\r\n    if (template.referenceUsages.length > 0) {\r\n      console.log(`\u00E2\u0161\u00A0\u00EF\u00B8\u008F [SHARED REF] D\u00C3\u00A9tachement de ${template.referenceUsages.length} usage(s) avant suppression`);\r\n      \r\n      // D\u00C3\u00A9tacher tous les n\u00C5\u201Cuds qui utilisent cette r\u00C3\u00A9f\u00C3\u00A9rence\r\n      await prisma.treeBranchLeafNode.updateMany({\r\n        where: {\r\n          sharedReferenceId: refId\r\n        },\r\n        data: {\r\n          sharedReferenceId: null,\r\n          sharedReferenceName: null,\r\n          sharedReferenceDescription: null,\r\n          isSharedReference: false\r\n        }\r\n      });\r\n    }\r\n\r\n    // Supprimer la r\u00C3\u00A9f\u00C3\u00A9rence\r\n    await prisma.treeBranchLeafNode.delete({\r\n      where: { id: refId }\r\n    });\r\n\r\n    console.log(`\u00F0\u0178\u2014\u2018\u00EF\u00B8\u008F [SHARED REF] R\u00C3\u00A9f\u00C3\u00A9rence ${refId} supprim\u00C3\u00A9e`);\r\n    res.json({ success: true, message: 'R\u00C3\u00A9f\u00C3\u00A9rence supprim\u00C3\u00A9e avec succ\u00C3\u00A8s' });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur suppression:', error);\r\n    res.status(500).json({ error: 'Erreur lors de la suppression' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/trees/:treeId/create-shared-reference - Cr\u00C3\u00A9er un nouveau n\u00C5\u201Cud r\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9\r\nrouter.post('/trees/:treeId/create-shared-reference', async (req, res) => {\r\n  try {\r\n    const { treeId } = req.params;\r\n    const { name, description, fieldType, label } = req.body;\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log('\u00F0\u0178\u201C\u009D [SHARED REF] Cr\u00C3\u00A9ation nouveau n\u00C5\u201Cud r\u00C3\u00A9f\u00C3\u00A9rence:', { treeId, name, description, fieldType, label });\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s \u00C3\u00A0 l'arbre\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({\r\n      where: {\r\n        id: treeId,\r\n        organizationId\r\n      }\r\n    });\r\n\r\n    if (!tree) {\r\n      return res.status(404).json({ error: 'Arbre introuvable' });\r\n    }\r\n\r\n    // G\u00C3\u00A9n\u00C3\u00A9rer un nouvel ID unique\r\n    const newNodeId = `shared-ref-${Date.now()}-${Math.random().toString(36).substring(7)}`;\r\n\r\n    // Cr\u00C3\u00A9er le n\u00C5\u201Cud r\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9\r\n    const newNode = await prisma.treeBranchLeafNode.create({\r\n      data: {\r\n        id: newNodeId,\r\n        treeId,\r\n        type: 'leaf_field', // \u00E2\u0153\u2026 OBLIGATOIRE : type du n\u00C5\u201Cud\r\n        label: label || name,\r\n        fieldType: fieldType || 'TEXT',\r\n        parentId: null, // \u00E2\u0153\u2026 CORRECTION: null au lieu de 'ROOT' (contrainte de cl\u00C3\u00A9 \u00C3\u00A9trang\u00C3\u00A8re)\r\n        order: 9999, // Ordre \u00C3\u00A9lev\u00C3\u00A9 pour les mettre \u00C3\u00A0 la fin\r\n        isSharedReference: true,\r\n        sharedReferenceId: null, // C'est une source\r\n        sharedReferenceName: name,\r\n        sharedReferenceDescription: description,\r\n        updatedAt: new Date() // \u00E2\u0153\u2026 OBLIGATOIRE : timestamp de mise \u00C3\u00A0 jour\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [SHARED REF] Nouveau n\u00C5\u201Cud r\u00C3\u00A9f\u00C3\u00A9rence cr\u00C3\u00A9\u00C3\u00A9:', newNode.id);\r\n    res.json({ \r\n      success: true,\r\n      id: newNode.id,\r\n      node: {\r\n        id: newNode.id,\r\n        label: newNode.label,\r\n        fieldType: newNode.fieldType,\r\n        sharedReferenceName: newNode.sharedReferenceName,\r\n        sharedReferenceDescription: newNode.sharedReferenceDescription\r\n      },\r\n      message: 'R\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9e cr\u00C3\u00A9\u00C3\u00A9e avec succ\u00C3\u00A8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur cr\u00C3\u00A9ation:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/nodes/:nodeId/link-shared-references - Lier des r\u00C3\u00A9f\u00C3\u00A9rences partag\u00C3\u00A9es \u00C3\u00A0 un n\u00C5\u201Cud\r\nrouter.post('/nodes/:nodeId/link-shared-references', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { referenceIds } = req.body; // Array d'IDs de r\u00C3\u00A9f\u00C3\u00A9rences \u00C3\u00A0 lier\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log('\u00F0\u0178\u201D\u2014 [SHARED REF] Liaison r\u00C3\u00A9f\u00C3\u00A9rences:', { nodeId, referenceIds });\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au n\u00C5\u201Cud\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: nodeId,\r\n        TreeBranchLeafTree: {\r\n          organizationId\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud introuvable' });\r\n    }\r\n\r\n    // Mettre \u00C3\u00A0 jour le n\u00C5\u201Cud avec les IDs des r\u00C3\u00A9f\u00C3\u00A9rences\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        sharedReferenceIds: referenceIds\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [SHARED REF] R\u00C3\u00A9f\u00C3\u00A9rences li\u00C3\u00A9es avec succ\u00C3\u00A8s:', nodeId);\r\n    res.json({ \r\n      success: true,\r\n      message: `${referenceIds.length} r\u00C3\u00A9f\u00C3\u00A9rence(s) li\u00C3\u00A9e(s) avec succ\u00C3\u00A8s`\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur liaison:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/treebranchleaf/nodes/:nodeId/convert-to-reference - Convertir un n\u00C5\u201Cud en r\u00C3\u00A9f\u00C3\u00A9rence partag\u00C3\u00A9e\r\nrouter.post('/nodes/:nodeId/convert-to-reference', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { name, description } = req.body; // \u00E2\u0153\u2026 CATEGORY SUPPRIM\u00C3\u2030E\r\n    const { organizationId } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n    console.log('\u00F0\u0178\u201C\u009D [SHARED REF] Conversion n\u00C5\u201Cud en r\u00C3\u00A9f\u00C3\u00A9rence:', { nodeId, name, description });\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: nodeId,\r\n        TreeBranchLeafTree: {\r\n          organizationId\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u00C5\u201Cud introuvable' });\r\n    }\r\n\r\n    // Convertir en source de r\u00C3\u00A9f\u00C3\u00A9rence\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        isSharedReference: true,\r\n        sharedReferenceId: null, // C'est une source\r\n        sharedReferenceName: name,\r\n        // \u00E2\u0153\u2026 sharedReferenceCategory SUPPRIM\u00C3\u2030\r\n        sharedReferenceDescription: description\r\n      }\r\n    });\r\n\r\n    console.log('\u00E2\u0153\u2026 [SHARED REF] R\u00C3\u00A9f\u00C3\u00A9rence cr\u00C3\u00A9\u00C3\u00A9e avec succ\u00C3\u00A8s:', nodeId);\r\n    res.json({ \r\n      success: true,\r\n      id: nodeId,\r\n      message: 'R\u00C3\u00A9f\u00C3\u00A9rence cr\u00C3\u00A9\u00C3\u00A9e avec succ\u00C3\u00A8s'\r\n    });\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [SHARED REF] Erreur conversion:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n// \u00F0\u0178\u201D\u2014 FIN DU SYST\u00C3\u02C6ME DE R\u00C3\u2030F\u00C3\u2030RENCES PARTAG\u00C3\u2030ES\r\n// \u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\u00E2\u2022\u0090\r\n\r\n\r\n\r\n\r\n// =============================================================================\r\n// \u00F0\u0178\u201D\u201E COPIE DE VARIABLE AVEC CAPACIT\u00C3\u2030S - Syst\u00C3\u00A8me de suffixe -N\r\n// =============================================================================\r\n/**\r\n * POST /api/treebranchleaf/nodes/:nodeId/copy-linked-variable\r\n * Copie une variable avec toutes ses capacit\u00C3\u00A9s (formules, conditions, tables)\r\n * \r\n * Body:\r\n *   - variableId: ID de la variable \u00C3\u00A0 copier (peut avoir suffixe -N)\r\n *   - newSuffix: Nouveau num\u00C3\u00A9ro de suffixe pour la copie (ex: 2)\r\n * \r\n * Retourne:\r\n * {\r\n *   success: boolean,\r\n *   variableId: string,\r\n *   formulaIds: string[],\r\n *   conditionIds: string[],\r\n *   tableIds: string[],\r\n *   error?: string\r\n * }\r\n */\r\n// (revert) suppression des routes utilitaires ajout\u00E9es au niveau sup\u00E9rieur\r\n\r\nrouter.post('/nodes/:nodeId/copy-linked-variable', async (req, res) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { variableId, newSuffix, duplicateNode, targetNodeId: bodyTargetNodeId } = req.body as {\r\n      variableId?: string;\r\n      newSuffix?: number;\r\n      duplicateNode?: boolean;\r\n      targetNodeId?: string;\r\n    };\r\n\r\n    console.log('\u00F0\u0178\u201D\u201E [COPY-LINKED-VAR] D\u00C3\u00A9but - nodeId:', nodeId, 'variableId:', variableId, 'newSuffix:', newSuffix);\r\n\r\n    // IMPORTANT (stabilit\u00E9 routes): cette petite route utilitaire a \u00E9t\u00E9 plac\u00E9e\r\n    // ici historiquement. Ne pas \"remonter\" ce handler en top-level sans\r\n    // revalider l\u2019ordre d\u2019enregistrement et le scoping middleware.\r\n    // Des d\u00E9placements h\u00E2tifs avaient provoqu\u00E9 des comportements non d\u00E9sir\u00E9s.\r\n    // Si un refactor est n\u00E9cessaire, le faire dans une PR d\u00E9di\u00E9e avec tests.\r\n    // (revert) route utilitaire initialement plac\u00E9e ici\r\n    router.post('/variables/:variableId/create-display', async (req, res) => {\r\n      try {\r\n        const { variableId } = req.params as { variableId: string };\r\n        const { label } = (req.body || {}) as { label?: string };\r\n        const result = await createDisplayNodeForExistingVariable(variableId, prisma, label || 'Nouveau Section');\r\n        res.status(201).json(result);\r\n      } catch (error) {\r\n        const msg = error instanceof Error ? error.message : String(error);\r\n        console.error('\u274C [/variables/:variableId/create-display] Erreur:', msg);\r\n        res.status(400).json({ error: msg });\r\n      }\r\n    });\r\n\r\n\r\n    if (!variableId || newSuffix === undefined) {\r\n      return res.status(400).json({\r\n        error: 'variableId et newSuffix requis dans le corps de la requ\u00C3\u00AAte'\r\n      });\r\n    }\r\n\r\n    if (!Number.isInteger(newSuffix) || newSuffix < 1) {\r\n      return res.status(400).json({\r\n        error: 'newSuffix doit \u00C3\u00AAtre un nombre entier positif'\r\n      });\r\n    }\r\n\r\n    // V\u00C3\u00A9rifier l'acc\u00C3\u00A8s au noeud\r\n    const node = await prisma.treeBranchLeafNode.findFirst({\r\n      where: {\r\n        id: nodeId,\r\n        TreeBranchLeafTree: {\r\n          organizationId: getAuthCtx(req as unknown as MinimalReq).organizationId\r\n        }\r\n      },\r\n      include: { TreeBranchLeafTree: true }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'Noeud introuvable' });\r\n    }\r\n\r\n  console.log('\u2705 Noeud trouv\u00E9:', node.label || nodeId);\r\n\r\n    // D\u00E9terminer le n\u0153ud cible: soit le nodeId fourni, soit une copie du n\u0153ud propri\u00E9taire de la variable\r\n  let targetNodeId = nodeId;\r\n  const shouldDuplicateNode = duplicateNode === undefined ? true : Boolean(duplicateNode);\r\n  // Mapping minimal pour r\u00E9\u00E9crire les r\u00E9f\u00E9rences dans les capacit\u00E9s (ownerNode \u2192 targetNode)\r\n  let ownerNodeIdForMap: string | null = null;\r\n\r\n  // Si un targetNodeId explicite est fourni et qu'on ne duplique pas, l'utiliser comme cible\r\n  if (!shouldDuplicateNode && bodyTargetNodeId) {\r\n      const targetNode = await prisma.treeBranchLeafNode.findUnique({ where: { id: bodyTargetNodeId } });\r\n      if (!targetNode) {\r\n        return res.status(404).json({ error: 'targetNodeId introuvable' });\r\n      }\r\n      // V\u00E9rifier m\u00EAme arbre\r\n      if (targetNode.treeId !== node.treeId) {\r\n        return res.status(400).json({ error: 'targetNodeId doit appartenir au m\u00EAme arbre' });\r\n      }\r\n      targetNodeId = targetNode.id;\r\n      console.log(`\uD83C\uDFAF [COPY-LINKED-VAR] Cible explicite fournie: ${targetNodeId}`);\r\n      // D\u00E9terminer l'ownerNode d'origine de la variable pour construire le nodeIdMap\r\n      if (variableId) {\r\n        const originalVarForMap = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { id: variableId } });\r\n        if (originalVarForMap) ownerNodeIdForMap = originalVarForMap.nodeId;\r\n      }\r\n  } else if (shouldDuplicateNode) {\r\n      // Charger la variable originale pour conna\u00EEtre son n\u0153ud propri\u00E9taire\r\n      const originalVar = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { id: variableId! } });\r\n      if (!originalVar) {\r\n        return res.status(404).json({ error: 'Variable introuvable' });\r\n      }\r\n      const ownerNode = await prisma.treeBranchLeafNode.findUnique({ where: { id: originalVar.nodeId } });\r\n      if (!ownerNode) {\r\n        return res.status(404).json({ error: 'N\u0153ud propri\u00E9taire introuvable' });\r\n      }\r\n      ownerNodeIdForMap = ownerNode.id;\r\n      const candidateId = `${ownerNode.id}-${newSuffix}`;\r\n      const exists = await prisma.treeBranchLeafNode.findUnique({ where: { id: candidateId } });\r\n      targetNodeId = exists ? `${candidateId}-${Date.now()}` : candidateId;\r\n\r\n      await prisma.treeBranchLeafNode.create({\r\n        data: {\r\n          id: targetNodeId,\r\n          treeId: ownerNode.treeId,\r\n          parentId: ownerNode.parentId,\r\n          type: ownerNode.type,\r\n          subType: ownerNode.subType,\r\n          label: `${ownerNode.label || 'Node'}-${newSuffix}`,\r\n          description: ownerNode.description,\r\n          value: null,\r\n          order: (ownerNode.order ?? 0) + 1,\r\n          isRequired: ownerNode.isRequired ?? false,\r\n          isVisible: ownerNode.isVisible ?? true,\r\n          isActive: ownerNode.isActive ?? true,\r\n          isMultiple: ownerNode.isMultiple ?? false,\r\n          hasData: ownerNode.hasData ?? false,\r\n          metadata: ownerNode.metadata as any,\r\n          createdAt: new Date(),\r\n          updatedAt: new Date(),\r\n        }\r\n      });\r\n      console.log(`\uD83D\uDCC4 [COPY-LINKED-VAR] N\u0153ud dupliqu\u00E9: ${ownerNode.id} -> ${targetNodeId}`);\r\n  }\r\n\r\n    // Copier la variable avec ses capacit\u00E9s vers le n\u0153ud cible\r\n    // Pr\u00E9parer des maps pour r\u00E9\u00E9crire les r\u00E9f\u00E9rences internes\r\n    const nodeIdMap = new Map<string, string>();\r\n    if (ownerNodeIdForMap) nodeIdMap.set(ownerNodeIdForMap, targetNodeId);\r\n    const formulaIdMap = new Map<string, string>();\r\n    const conditionIdMap = new Map<string, string>();\r\n    const tableIdMap = new Map<string, string>();\r\n\r\n    const result = await copyVariableWithCapacities(\r\n      variableId,\r\n      newSuffix,\r\n      targetNodeId,\r\n      prisma,\r\n      {\r\n        autoCreateDisplayNode: true,\r\n        nodeIdMap,\r\n        formulaIdMap,\r\n        conditionIdMap,\r\n        tableIdMap\r\n      }\r\n    );\r\n\r\n    if (!result.success) {\r\n      return res.status(400).json({ error: result.error || 'Erreur lors de la copie' });\r\n    }\r\n\r\n    // Ajouter la variable copi\u00E9e aux linkedVariableIds du n\u0153ud cible\r\n    try {\r\n      await addToNodeLinkedField(prisma, targetNodeId, 'linkedVariableIds', [result.variableId]);\r\n    } catch (e) {\r\n      console.warn('\u26A0\uFE0F [COPY-LINKED-VAR] \u00C9chec MAJ linkedVariableIds:', (e as Error).message);\r\n    }\r\n\r\n    console.log('\u2705 [COPY-LINKED-VAR] Copie r\u00E9ussie:', { ...result, targetNodeId });\r\n    res.status(201).json({ ...result, targetNodeId });\r\n\r\n  } catch (error) {\r\n    console.error('\u00E2\u009D\u0152 [COPY-LINKED-VAR] Erreur:', error);\r\n    const msg = error instanceof Error ? error.message : String(error);\r\n    res.status(500).json({ error: msg });\r\n  }\r\n});\r\n\r\n// ==================================================================================\r\n// \uD83D\uDD0E ROUTE UTILITAIRE: rechercher des variables par displayName (partiel)\r\n// ==================================================================================\r\nrouter.get('/variables/search', async (req, res) => {\r\n  try {\r\n    const q = String(req.query.displayName || '').trim();\r\n    if (!q) return res.status(400).json({ error: 'displayName query string requis' });\r\n    const found = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      where: { displayName: { contains: q, mode: 'insensitive' as any } },\r\n      select: { id: true, nodeId: true, exposedKey: true, displayName: true, sourceType: true, sourceRef: true }\r\n    });\r\n    res.json({ count: found.length, items: found });\r\n  } catch (error) {\r\n    const msg = error instanceof Error ? error.message : String(error);\r\n    res.status(500).json({ error: msg });\r\n  }\r\n});\r\n\r\n\r\n// Exporter les helpers utiles pour les tests et la logique externe\r\nexport {\r\n  mapJSONToColumns,\r\n  removeJSONFromUpdate,\r\n  buildResponseFromColumns\r\n};\r\n\r\nexport default router;\r\n\r\n\r\n\r\n", "// Formula Engine avec pr\u00E9c\u00E9dence, parenth\u00E8ses et variables nodeId\r\n// Fournit parsing d'expressions d\u00E9j\u00E0 \"templatis\u00E9es\" sous forme de tokens ou string.\r\n// Con\u00E7u pour remplacer l'\u00E9valuation gauche->droite simpliste.\r\n\r\nexport type FormulaToken =\r\n  | { type: 'number'; value: number }\r\n  | { type: 'variable'; name: string } // name = nodeId\r\n  | { type: 'operator'; value: string }\r\n  | { type: 'paren'; value: '(' | ')' }\r\n  | { type: 'func'; name: string; argCount?: number }\r\n  | { type: 'comma' };\r\n\r\nexport interface EvaluateOptions {\r\n  resolveVariable: (nodeId: string) => Promise<number | null> | number | null;\r\n  onError?: (code: string, context?: Record<string, unknown>) => void;\r\n  divisionByZeroValue?: number; // d\u00E9faut 0\r\n  strictVariables?: boolean; // erreur unknown_variable si variable non r\u00E9solue\r\n  enableCache?: boolean; // activer cache RPN (par d\u00E9faut true)\r\n  maxExpressionLength?: number; // s\u00E9curit\u00E9 (d\u00E9faut 500)\r\n  allowedCharsRegex?: RegExp; // whitelist (d\u00E9faut fourni)\r\n  precisionScale?: number; // si d\u00E9fini (>1), applique un scaling entier pour + - * / et round (sauf pow) pour r\u00E9duire erreurs FP\r\n}\r\n\r\n// Ajout: op\u00E9rateurs comparaison g\u00E9r\u00E9s en phase de parsing (transform\u00E9s en fonctions bool\u00E9ennes)\r\n// Ils ne sont PAS ajout\u00E9s \u00E0 OP_PRECEDENCE pour \u00E9viter de modifier la logique arithm\u00E9tique: au lieu de cela,\r\n// on r\u00E9\u00E9crit 'a > b' en gt(a,b) directement sous forme de tokens fonction.\r\nconst OP_PRECEDENCE: Record<string, number> = {\r\n  '+': 1,\r\n  '-': 1,\r\n  '*': 2,\r\n  '/': 2,\r\n  '^': 3,\r\n  and: 0,\r\n  or: 0\r\n};\r\nconst OP_ASSOC: Record<string, 'L' | 'R'> = {\r\n  '+': 'L',\r\n  '-': 'L',\r\n  '*': 'L',\r\n  '/': 'L',\r\n  '^': 'R',\r\n  and: 'L',\r\n  or: 'L'\r\n};\r\n\r\n// Cache RPN bas\u00E9 sur empreinte des tokens\r\nconst rpnCache = new Map<string, FormulaToken[]>();\r\nlet rpnParseCount = 0; // compteur pour tests / diagnostics\r\nexport function getRpnCacheStats() { return { entries: rpnCache.size, parseCount: rpnParseCount }; }\r\nexport function clearRpnCache() { rpnCache.clear(); }\r\n\r\n// ---- Metrics Logique ----\r\ninterface LogicMetrics {\r\n  evaluations: number;\r\n  totalEvalMs: number;\r\n  functions: Record<string, number>;\r\n  divisionByZero: number;\r\n  unknownVariables: number;\r\n  parseErrors: number;\r\n  invalidResults: number;\r\n}\r\nconst logicMetrics: LogicMetrics = {\r\n  evaluations: 0,\r\n  totalEvalMs: 0,\r\n  functions: {},\r\n  divisionByZero: 0,\r\n  unknownVariables: 0,\r\n  parseErrors: 0,\r\n  invalidResults: 0\r\n};\r\nexport function getLogicMetrics() {\r\n  return { ...logicMetrics, avgEvalMs: logicMetrics.evaluations ? logicMetrics.totalEvalMs / logicMetrics.evaluations : 0 };\r\n}\r\nexport function resetLogicMetrics() {\r\n  logicMetrics.evaluations = 0;\r\n  logicMetrics.totalEvalMs = 0;\r\n  logicMetrics.functions = {};\r\n  logicMetrics.divisionByZero = 0;\r\n  logicMetrics.unknownVariables = 0;\r\n  logicMetrics.parseErrors = 0;\r\n  logicMetrics.invalidResults = 0;\r\n}\r\n\r\nfunction tokensFingerprint(tokens: FormulaToken[]): string {\r\n  return tokens.map(t => {\r\n    switch (t.type) {\r\n      case 'number': return `n:${t.value}`;\r\n      case 'variable': return `v:${t.name}`;\r\n      case 'operator': return `o:${t.value}`;\r\n      case 'paren': return `p:${t.value}`;\r\n      case 'func': return `f:${t.name}:${t.argCount ?? '?'}`;\r\n      case 'comma': return 'c';\r\n    }\r\n  }).join('|');\r\n}\r\n\r\n// Validation s\u00E9curit\u00E9\r\nfunction validateExpression(expr: string, opts?: EvaluateOptions) {\r\n  const maxLen = opts?.maxExpressionLength ?? 500;\r\n  if (expr.length > maxLen) throw new Error('Expression trop longue');\r\n  const allowed = opts?.allowedCharsRegex || /^[0-9A-Za-z_\\s+*\\-/^(),.{}:<>!=]+$/;\r\n  if (!allowed.test(expr)) throw new Error('Caract\u00E8res non autoris\u00E9s dans l\\'expression');\r\n}\r\n\r\nexport function parseExpression(expr: string, roleToNodeId: Record<string,string>, opts?: EvaluateOptions): FormulaToken[] {\r\n  validateExpression(expr, opts);\r\n  // Remplacer {{role}} par un marqueur unique pour scanning\r\n  const working = expr.replace(/\\{\\{\\s*(.+?)\\s*\\}\\}/g, (_, v) => `__VAR__${v.trim()}__`);\r\n  const tokens: FormulaToken[] = [];\r\n  let i = 0;\r\n  let parenBalance = 0;\r\n  // Stack des fonctions en cours pour compter les arguments (liaison par parenth\u00E8se)\r\n  const funcParenStack: Array<{ name: string; argCount: number }> = [];\r\n  let lastToken: FormulaToken | null = null;\r\n  while (i < working.length) {\r\n    const ch = working[i];\r\n    if (/\\s/.test(ch)) { i++; continue; }\r\n    // Variable marqu\u00E9e\r\n    if (working.startsWith('__VAR__', i)) {\r\n      const end = working.indexOf('__', i + 7);\r\n      if (end === -1) throw new Error('Marqueur variable mal form\u00E9');\r\n      const role = working.substring(i + 7, end);\r\n      const nodeId = roleToNodeId[role];\r\n      if (!nodeId) throw new Error('Variable inconnue dans expression: ' + role);\r\n      tokens.push({ type: 'variable', name: nodeId });\r\n      i = end + 2;\r\n      lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    // Nombre\r\n    if (/[0-9]/.test(ch)) {\r\n      let j = i + 1;\r\n      while (j < working.length && /[0-9.]/.test(working[j])) j++;\r\n      const numStr = working.slice(i, j);\r\n      tokens.push({ type: 'number', value: parseFloat(numStr) });\r\n      i = j; lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    // Identifiant (potentiellement fonction)\r\n    if (/[A-Za-z_]/.test(ch)) {\r\n      let j = i + 1;\r\n      while (j < working.length && /[A-Za-z0-9_]/.test(working[j])) j++;\r\n      const ident = working.slice(i, j);\r\n      const lowerIdent = ident.toLowerCase();\r\n      if (lowerIdent === 'true' || lowerIdent === 'false') {\r\n        tokens.push({ type: 'number', value: lowerIdent === 'true' ? 1 : 0 });\r\n        i = j; lastToken = tokens[tokens.length - 1];\r\n        continue;\r\n      }\r\n      const canUseAsBinary = Boolean(lastToken && (\r\n        (lastToken.type === 'number') ||\r\n        (lastToken.type === 'variable') ||\r\n        (lastToken.type === 'paren' && lastToken.value === ')')\r\n      ));\r\n      if ((lowerIdent === 'and' || lowerIdent === 'or') && canUseAsBinary) {\r\n        tokens.push({ type: 'operator', value: lowerIdent });\r\n        i = j; lastToken = tokens[tokens.length - 1];\r\n        continue;\r\n      }\r\n      // Fonction si prochaine non-espace est (\r\n      let k = j; while (k < working.length && /\\s/.test(working[k])) k++;\r\n      if (working[k] === '(') {\r\n        tokens.push({ type: 'func', name: lowerIdent });\r\n        // La parenth\u00E8se sera trait\u00E9e dans cycle suivant\r\n        i = j; lastToken = tokens[tokens.length - 1];\r\n        continue;\r\n      } else {\r\n        // Identifiant seul non support\u00E9 (on pourrait l'\u00E9tendre plus tard)\r\n        throw new Error('Identifiant inattendu: ' + ident);\r\n      }\r\n    }\r\n    // Parenth\u00E8ses\r\n    if (ch === '(') {\r\n      tokens.push({ type: 'paren', value: '(' });\r\n      // Lier \u00E0 une fonction pr\u00E9c\u00E9dente (si lastToken func sans paren encore ouverte)\r\n      const prev = lastToken;\r\n      if (prev && prev.type === 'func') {\r\n        funcParenStack.push({ name: prev.name, argCount: 0 });\r\n      }\r\n      parenBalance++;\r\n      i++; lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    if (ch === ')') {\r\n      tokens.push({ type: 'paren', value: ')' });\r\n      parenBalance--;\r\n      if (parenBalance < 0) throw new Error('Parenth\u00E8ses d\u00E9s\u00E9quilibr\u00E9es');\r\n      // Si on ferme une fonction: incr\u00E9menter argCount si la derni\u00E8re chose n'\u00E9tait pas '(' (i.e. au moins une expr)\r\n      if (funcParenStack.length) {\r\n        // On d\u00E9cidera dans toRPN lequel associer\r\n      }\r\n      i++; lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    // Virgule\r\n    if (ch === ',') {\r\n      tokens.push({ type: 'comma' });\r\n      // Incr\u00E9menter compteur arg de la fonction en haut de pile\r\n      if (funcParenStack.length) {\r\n        const top = funcParenStack[funcParenStack.length - 1];\r\n        top.argCount++;\r\n      }\r\n      i++; lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    // Op\u00E9rateurs simples arithm\u00E9tiques\r\n    if ('+-*/^'.includes(ch)) {\r\n      tokens.push({ type: 'operator', value: ch });\r\n      i++; lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    // Op\u00E9rateurs comparaison multi-caract\u00E8res (>=, <=, ==, !=)\r\n    if ((ch === '>' || ch === '<' || ch === '=' || ch === '!') && i + 1 < working.length) {\r\n      const two = working.slice(i, i + 2);\r\n      if (['>=', '<=', '==', '!='].includes(two)) {\r\n        tokens.push({ type: 'operator', value: two });\r\n        i += 2; lastToken = tokens[tokens.length - 1];\r\n        continue;\r\n      }\r\n    }\r\n    // Op\u00E9rateurs comparaison simples (>, <)\r\n    if (ch === '>' || ch === '<') {\r\n      tokens.push({ type: 'operator', value: ch });\r\n      i++; lastToken = tokens[tokens.length - 1];\r\n      continue;\r\n    }\r\n    throw new Error('Caract\u00E8re inattendu: ' + ch);\r\n  }\r\n  if (parenBalance !== 0) throw new Error('Parenth\u00E8ses d\u00E9s\u00E9quilibr\u00E9es');\r\n  // R\u00E9\u00E9criture comparaison \u2192 fonctions (gt, gte, lt, lte, eq, neq)\r\n  if (tokens.some(t => t.type === 'operator' && ['>','>=','<','<=','==','!='].includes((t as { type:'operator'; value:string }).value))) {\r\n    const rewritten: FormulaToken[] = [];\r\n    for (let idx = 0; idx < tokens.length; idx++) {\r\n      const tk = tokens[idx];\r\n      if (tk.type === 'operator' && ['>','>=','<','<=','==','!='].includes(tk.value)) {\r\n        // On suppose forme binaire: pr\u00E9c\u00E9dent est une valeur/variable/paren fermante ou fonction d\u00E9j\u00E0 sortie,\r\n        // suivant est une valeur/variable/paren ouvrante ou fonction; on va transformer A op B en func(A,B)\r\n        // Strat\u00E9gie: On remonte \u00E0 l'\u00E9l\u00E9ment imm\u00E9diatement pr\u00E9c\u00E9dent dans rewritten pour extraire l'op\u00E9rande gauche\r\n        const op = tk.value;\r\n        const left = rewritten.pop();\r\n        const right = tokens[idx + 1];\r\n        if (!left || !right) throw new Error('Expression comparaison mal form\u00E9e');\r\n        // Consommer le token de droite en avan\u00E7ant idx\r\n        idx++;\r\n        // Construire tokens fonction: name(left,right)\r\n        const funcName = op === '>' ? 'gt'\r\n          : op === '>=' ? 'gte'\r\n          : op === '<' ? 'lt'\r\n          : op === '<=' ? 'lte'\r\n          : op === '==' ? 'eq'\r\n          : op === '!=' ? 'neq' : 'eq';\r\n        // Mod\u00E8le: func( left , right ) => [func, '(', left, ',', right, ')']\r\n        rewritten.push({ type: 'func', name: funcName });\r\n        rewritten.push({ type: 'paren', value: '(' });\r\n        rewritten.push(left);\r\n        rewritten.push({ type: 'comma' });\r\n        rewritten.push(right);\r\n        rewritten.push({ type: 'paren', value: ')' });\r\n      } else {\r\n        rewritten.push(tk);\r\n      }\r\n    }\r\n    return rewritten;\r\n  }\r\n  return tokens;\r\n}\r\n\r\nexport function toRPN(tokens: FormulaToken[]): FormulaToken[] {\r\n  const output: FormulaToken[] = [];\r\n  const stack: FormulaToken[] = [];\r\n  // pile pour compter les arguments par fonction (index align\u00E9 avec parenth\u00E8se ouvrante associ\u00E9e)\r\n  const funcStack: Array<{ name: string; argCount: number }> = [];\r\n  for (let idx = 0; idx < tokens.length; idx++) {\r\n    const tk = tokens[idx];\r\n    switch (tk.type) {\r\n      case 'number':\r\n      case 'variable':\r\n        output.push(tk);\r\n        // Si nous sommes dans une fonction et que le token pr\u00E9c\u00E9dent est '(' ou ',' on compte cet argument\r\n        if (funcStack.length) {\r\n          // incr\u00E9ment implicite si dernier arg d\u00E9marre; on g\u00E8re en sortie parenth\u00E8se\r\n        }\r\n        break;\r\n      case 'func':\r\n        stack.push(tk); // fonction en pile\r\n        break;\r\n      case 'operator': {\r\n        while (stack.length) {\r\n          const top = stack[stack.length - 1];\r\n            if (top.type === 'operator') {\r\n              const pTop = OP_PRECEDENCE[top.value] || 0;\r\n              const pCur = OP_PRECEDENCE[tk.value] || 0;\r\n              if ((OP_ASSOC[tk.value] === 'L' && pCur <= pTop) || (OP_ASSOC[tk.value] === 'R' && pCur < pTop)) {\r\n                output.push(stack.pop() as FormulaToken);\r\n                continue;\r\n              }\r\n            }\r\n          break;\r\n        }\r\n        stack.push(tk);\r\n        break; }\r\n      case 'paren':\r\n        if (tk.value === '(') {\r\n          stack.push(tk);\r\n          // Si le token pr\u00E9c\u00E9dent sur la pile est une fonction, initialiser compteur args=1 provisoire\r\n          const prev = stack[stack.length - 2];\r\n          if (prev && prev.type === 'func') {\r\n            funcStack.push({ name: prev.name, argCount: 1 });\r\n          }\r\n        } else { // ')'\r\n          let found = false;\r\n          while (stack.length) {\r\n            const top = stack.pop() as FormulaToken;\r\n            if (top.type === 'paren' && top.value === '(') { found = true; break; }\r\n            output.push(top);\r\n          }\r\n          if (!found) throw new Error('Parenth\u00E8ses d\u00E9s\u00E9quilibr\u00E9es');\r\n          // Si juste apr\u00E8s '(' il y avait une fonction\r\n          const maybeFunc = stack[stack.length - 1];\r\n          if (maybeFunc && maybeFunc.type === 'func') {\r\n            // Finaliser fonction (argCount obtenu)\r\n            stack.pop();\r\n            const fMeta = funcStack.pop();\r\n            const argCount = fMeta ? fMeta.argCount : 0;\r\n            output.push({ type: 'func', name: maybeFunc.name, argCount });\r\n          }\r\n        }\r\n        break;\r\n      case 'comma':\r\n        // vider la pile jusqu'\u00E0 la parenth\u00E8se ouvrante\r\n        while (stack.length) {\r\n          const top = stack[stack.length - 1];\r\n          if (top.type === 'paren' && top.value === '(') break;\r\n          output.push(stack.pop() as FormulaToken);\r\n        }\r\n        // Incr\u00E9menter compteur args\r\n        if (funcStack.length) funcStack[funcStack.length - 1].argCount++;\r\n        break;\r\n    }\r\n  }\r\n  while (stack.length) {\r\n    const top = stack.pop() as FormulaToken;\r\n    if (top.type === 'paren') throw new Error('Parenth\u00E8ses d\u00E9s\u00E9quilibr\u00E9es (fin)');\r\n    output.push(top);\r\n  }\r\n  return output;\r\n}\r\n\r\nexport async function evaluateTokens(tokens: FormulaToken[], opts: EvaluateOptions): Promise<{ value: number; errors: string[] }> {\r\n  const errors: string[] = [];\r\n  const pushError = (c: string, ctx?: Record<string, unknown>) => {\r\n    errors.push(c);\r\n    if (opts.onError) opts.onError(c, ctx);\r\n    if (c === 'division_by_zero') logicMetrics.divisionByZero++;\r\n    else if (c === 'unknown_variable') logicMetrics.unknownVariables++;\r\n    else if (c === 'invalid_result') logicMetrics.invalidResults++;\r\n  };\r\n  const t0 = Date.now();\r\n  const useCache = opts.enableCache !== false;\r\n  let rpn: FormulaToken[] | undefined;\r\n  if (useCache) {\r\n    const fp = tokensFingerprint(tokens);\r\n    const cached = rpnCache.get(fp);\r\n    if (cached) rpn = cached;\r\n    else {\r\n      rpn = toRPN(tokens);\r\n      rpnCache.set(fp, rpn);\r\n      rpnParseCount++;\r\n    }\r\n  } else {\r\n    rpn = toRPN(tokens);\r\n    rpnParseCount++;\r\n  }\r\n  const stack: number[] = [];\r\n  const scale = (opts.precisionScale && opts.precisionScale > 1) ? Math.floor(opts.precisionScale) : null;\r\n  const toInternal = (v: number) => scale ? Math.round(v * scale) : v;\r\n  const fromInternal = (v: number) => scale ? v / scale : v;\r\n  for (const tk of rpn) {\r\n    if (tk.type === 'number') stack.push(tk.value);\r\n    else if (tk.type === 'variable') {\r\n      let v: number | null;\r\n      try { v = await opts.resolveVariable(tk.name); } catch { v = null; }\r\n      if (v == null || !Number.isFinite(v)) {\r\n        if (opts.strictVariables) pushError('unknown_variable', { nodeId: tk.name });\r\n        v = 0;\r\n      }\r\n      stack.push(v);\r\n    } else if (tk.type === 'operator') {\r\n      const b = stack.pop();\r\n      const a = stack.pop();\r\n      if (typeof a !== 'number' || typeof b !== 'number') { pushError('stack_underflow', { op: tk.value }); return { value: 0, errors }; }\r\n      let r = 0;\r\n      switch (tk.value) {\r\n        case '+':\r\n          if (scale) r = fromInternal(toInternal(a) + toInternal(b)); else r = a + b; break;\r\n        case '-':\r\n          if (scale) r = fromInternal(toInternal(a) - toInternal(b)); else r = a - b; break;\r\n        case '*':\r\n          if (scale) r = fromInternal(Math.round(toInternal(a) * toInternal(b) / scale)); else r = a * b; break;\r\n        case '/':\r\n          if (b === 0) { pushError('division_by_zero', { a, b }); r = opts.divisionByZeroValue ?? 0; }\r\n          else {\r\n            if (scale) r = fromInternal(Math.round(toInternal(a) * scale / toInternal(b)));\r\n            else r = a / b;\r\n          }\r\n          break;\r\n        case '^':\r\n          // Utiliser Math.pow (peut g\u00E9n\u00E9rer Infinity si grand)\r\n          r = Math.pow(a, b);\r\n          if (!Number.isFinite(r)) { pushError('invalid_result', { op: '^', a, b }); r = 0; }\r\n          break;\r\n        case 'and':\r\n          r = (a !== 0 && b !== 0) ? 1 : 0;\r\n          break;\r\n        case 'or':\r\n          r = (a !== 0 || b !== 0) ? 1 : 0;\r\n          break;\r\n        default:\r\n          pushError('unknown_operator', { op: tk.value });\r\n      }\r\n      stack.push(r);\r\n    } else if (tk.type === 'func') {\r\n      const argc = tk.argCount ?? 0;\r\n      if (stack.length < argc) { pushError('stack_underflow', { func: tk.name }); return { value: 0, errors }; }\r\n      const args: number[] = [];\r\n      for (let i = 0; i < argc; i++) args.unshift(stack.pop() as number);\r\n      let r = 0;\r\n      logicMetrics.functions[tk.name] = (logicMetrics.functions[tk.name] || 0) + 1;\r\n      switch (tk.name) {\r\n        case 'min':\r\n          r = Math.min(...args);\r\n          break;\r\n        case 'max':\r\n          r = Math.max(...args);\r\n          break;\r\n        case 'eq':\r\n          r = (args[0] ?? 0) === (args[1] ?? 0) ? 1 : 0; break;\r\n        case 'neq':\r\n          r = (args[0] ?? 0) !== (args[1] ?? 0) ? 1 : 0; break;\r\n        case 'gt':\r\n          r = (args[0] ?? 0) > (args[1] ?? 0) ? 1 : 0; break;\r\n        case 'gte':\r\n          r = (args[0] ?? 0) >= (args[1] ?? 0) ? 1 : 0; break;\r\n        case 'lt':\r\n          r = (args[0] ?? 0) < (args[1] ?? 0) ? 1 : 0; break;\r\n        case 'lte':\r\n          r = (args[0] ?? 0) <= (args[1] ?? 0) ? 1 : 0; break;\r\n        case 'round': {\r\n          const value = args[0] ?? 0;\r\n          const decimals = Math.max(0, Math.min(12, Math.floor(args[1] ?? 0)));\r\n          const factor = Math.pow(10, decimals);\r\n          r = Math.round(value * factor) / factor;\r\n          if (scale) r = fromInternal(toInternal(r));\r\n          break; }\r\n        case 'abs':\r\n          r = Math.abs(args[0] ?? 0);\r\n          break;\r\n        case 'ceil':\r\n          r = Math.ceil(args[0] ?? 0);\r\n          break;\r\n        case 'floor':\r\n          r = Math.floor(args[0] ?? 0);\r\n          break;\r\n        case 'if': {\r\n          // if(condition, a, b) -> condition != 0 ? a : b\r\n          const cond = args[0] ?? 0;\r\n          const aVal = args[1] ?? 0;\r\n            const bVal = args[2] ?? 0;\r\n          if (argc < 2) { pushError('invalid_result', { func: 'if', reason: 'missing_args' }); r = 0; }\r\n          else r = cond !== 0 ? aVal : bVal;\r\n          break; }\r\n        case 'and': {\r\n          // and(a,b,...) -> 1 si tous != 0\r\n          r = args.every(v => (v ?? 0) !== 0) ? 1 : 0;\r\n          break; }\r\n        case 'or': {\r\n          // or(a,b,...) -> 1 si au moins un != 0\r\n          r = args.some(v => (v ?? 0) !== 0) ? 1 : 0;\r\n          break; }\r\n        case 'not': {\r\n          // not(a) -> 1 si a == 0\r\n          r = (args[0] ?? 0) === 0 ? 1 : 0;\r\n          break; }\r\n        case 'present': {\r\n          // present(a) -> 1 si a != 0\r\n          r = (args[0] ?? 0) !== 0 ? 1 : 0;\r\n          break; }\r\n        case 'empty': {\r\n          // empty(a) -> 1 si a == 0\r\n          r = (args[0] ?? 0) === 0 ? 1 : 0;\r\n          break; }\r\n        case 'sum': {\r\n          // sum(a,b,...) -> somme (ignore NaN)\r\n          r = args.reduce((acc, v) => acc + (Number.isFinite(v) ? v : 0), 0);\r\n          break; }\r\n        case 'avg': {\r\n          // avg(a,b,...) -> moyenne (0 si aucun argument)\r\n          if (!args.length) r = 0; else {\r\n            const valid = args.filter(v => Number.isFinite(v));\r\n            r = valid.length ? valid.reduce((a,b)=>a+b,0) / valid.length : 0;\r\n          }\r\n          break; }\r\n        case 'ifnull': {\r\n          // ifnull(a,b) -> a si a != 0 sinon b\r\n          r = (args[0] ?? 0) !== 0 ? (args[0] ?? 0) : (args[1] ?? 0);\r\n          break; }\r\n        case 'coalesce': {\r\n          // coalesce(a,b,c,...) -> premier != 0\r\n            let found = 0;\r\n            for (const v of args) { if ((v ?? 0) !== 0) { found = v ?? 0; break; } }\r\n            r = found;\r\n            break; }\r\n        case 'safediv': {\r\n          // safediv(a,b, fallback=0)\r\n          const aVal = args[0] ?? 0; const bVal = args[1] ?? 0; const fb = args[2] ?? 0;\r\n          if (bVal === 0) r = fb; else r = aVal / bVal;\r\n          break; }\r\n        case 'percentage': {\r\n          // percentage(part, total) -> (part / total) * 100\r\n          const part = args[0] ?? 0; const total = args[1] ?? 0;\r\n          r = total === 0 ? 0 : (part / total) * 100;\r\n          break; }\r\n        case 'ratio': {\r\n          // ratio(a,b) -> a / b\r\n          const aVal = args[0] ?? 0; const bVal = args[1] ?? 0;\r\n          r = bVal === 0 ? 0 : aVal / bVal;\r\n          break; }\r\n        default:\r\n          pushError('unknown_function', { func: tk.name });\r\n          r = 0;\r\n      }\r\n      if (!Number.isFinite(r)) { pushError('invalid_result', { func: tk.name }); r = 0; }\r\n      stack.push(r);\r\n    }\r\n  }\r\n  const out = stack.pop();\r\n  if (stack.length || typeof out !== 'number' || !Number.isFinite(out)) {\r\n    pushError('invalid_result');\r\n    const dt = Date.now() - t0;\r\n    logicMetrics.evaluations++;\r\n    logicMetrics.totalEvalMs += dt;\r\n    return { value: 0, errors };\r\n  }\r\n  const dt = Date.now() - t0;\r\n  logicMetrics.evaluations++;\r\n  logicMetrics.totalEvalMs += dt;\r\n  return { value: out, errors };\r\n}\r\n\r\n// Helper haut-niveau: compile & \u00E9value en une \u00E9tape (utilis\u00E9 potentiellement ailleurs)\r\nexport async function evaluateExpression(expr: string, roleToNodeId: Record<string,string>, opts: EvaluateOptions): Promise<{ value: number; errors: string[] }> {\r\n  try {\r\n    const tokens = parseExpression(expr, roleToNodeId, opts);\r\n    return evaluateTokens(tokens, opts);\r\n  } catch (e) {\r\n    logicMetrics.parseErrors++;\r\n    throw e;\r\n  }\r\n}\r\n", "// Orchestrateur d'\u00E9valuation TBL \u2013 v1\r\n// Focalis\u00E9 sur la r\u00E9solution am\u00E9lior\u00E9e des variables pour les formules.\r\n\r\nexport interface OrchestratorOptions {\r\n  fieldValues: Record<string, unknown>;\r\n  tokens: FormulaToken[];\r\n  variableMap?: Record<string, { raw: unknown; numeric?: number; source?: string }>;\r\n  rawExpression?: string;\r\n  hasOperatorsOverride?: boolean;\r\n}\r\n\r\nexport interface FormulaToken {\r\n  type: 'value' | 'variable' | 'operator' | 'lparen' | 'rparen';\r\n  value?: string | number;\r\n  name?: string;\r\n}\r\n\r\ninterface TraceEntry {\r\n  step: string;\r\n  input?: unknown;\r\n  output?: unknown;\r\n  meta?: Record<string, unknown>;\r\n}\r\n\r\nexport interface OrchestratorResult {\r\n  resolvedVariables: Record<string, number>;\r\n  strategy: 'DIRECT_VALUE' | 'FULL_CALCULATION';\r\n  operatorsDetected: boolean;\r\n  trace: TraceEntry[];\r\n}\r\n\r\nconst normalize = (s: string) => s.toLowerCase().normalize('NFD').replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');\r\n\r\nconst isNumericLike = (v: unknown) => {\r\n  if (v == null || v === '') return false;\r\n  const str = String(v).trim().replace(/\\s+/g, '').replace(/,/g, '.');\r\n  return str !== '' && !isNaN(Number(str));\r\n};\r\n\r\nconst toNumber = (v: unknown): number => {\r\n  if (!isNumericLike(v)) return 0;\r\n  const n = parseFloat(String(v).replace(/\\s+/g, '').replace(/,/g, '.'));\r\n  return isNaN(n) ? 0 : n;\r\n};\r\n\r\nexport function evaluateFormulaOrchestrated(opts: OrchestratorOptions): OrchestratorResult {\r\n  const trace: TraceEntry[] = [];\r\n  const { fieldValues, tokens, variableMap, rawExpression, hasOperatorsOverride } = opts;\r\n\r\n  const tokenVariables = tokens.filter(t => t.type === 'variable' && t.name).map(t => t.name!) as string[];\r\n  trace.push({ step: 'extract_token_variables', output: tokenVariables });\r\n\r\n  const operatorsDetected = hasOperatorsOverride ?? (rawExpression ? /[+\\-*/]/.test(rawExpression) : tokens.some(t => t.type === 'operator'));\r\n  trace.push({ step: 'detect_operators', output: operatorsDetected, meta: { rawExpression } });\r\n\r\n  // Mirroirs\r\n  const mirrors = Object.entries(fieldValues).filter(([k]) => k.startsWith('__mirror_data_'));\r\n  const mirrorsByNorm: Record<string, { key: string; value: unknown }[]> = {};\r\n  for (const [k, v] of mirrors) {\r\n    const norm = normalize(k.replace(/^__mirror_data_/, ''));\r\n    mirrorsByNorm[norm] = mirrorsByNorm[norm] || [];\r\n    mirrorsByNorm[norm].push({ key: k, value: v });\r\n  }\r\n  trace.push({ step: 'collect_mirrors', output: Object.keys(mirrorsByNorm) });\r\n\r\n  const resolvedVariables: Record<string, number> = {};\r\n\r\n  const pickBest = (cands: { value: unknown; source: string }[]) => {\r\n    const scored = cands.filter(c => isNumericLike(c.value)).map(c => ({ ...c, num: toNumber(c.value), len: String(c.value).length })).sort((a, b) => b.len - a.len);\r\n    if (scored.length === 0) return { value: 0, source: 'none' };\r\n    return { value: scored[0].num, source: scored[0].source };\r\n  };\r\n\r\n  for (const varName of tokenVariables) {\r\n    const varTrace: TraceEntry = { step: 'resolve_variable', input: varName, meta: {} };\r\n    const candidates: { value: unknown; source: string }[] = [];\r\n\r\n    if (variableMap && variableMap[varName]) {\r\n      candidates.push({ value: variableMap[varName].numeric ?? variableMap[varName].raw, source: 'variableMap' });\r\n      varTrace.meta!.variableMap = true;\r\n    }\r\n    if (fieldValues[varName] != null) candidates.push({ value: fieldValues[varName], source: 'direct' });\r\n    const suffixKey = `${varName}_field`;\r\n    if (fieldValues[suffixKey] != null) candidates.push({ value: fieldValues[suffixKey], source: '_field_suffix' });\r\n\r\n    // Contains pattern\r\n    Object.entries(fieldValues).forEach(([k, v]) => {\r\n      if (k !== varName && k !== suffixKey && k.includes(varName) && v != null) {\r\n        candidates.push({ value: v, source: 'contains_pattern' });\r\n      }\r\n    });\r\n\r\n    const norm = normalize(varName);\r\n    if (mirrorsByNorm[norm]) {\r\n      mirrorsByNorm[norm].forEach(m => candidates.push({ value: m.value, source: 'mirror' }));\r\n      varTrace.meta!.mirrorMatched = true;\r\n    }\r\n\r\n    // Generic fallback (legacy)\r\n    if (!candidates.some(c => c.source === '_field_suffix')) {\r\n      const anyField = Object.keys(fieldValues).find(k => k.endsWith('_field') && fieldValues[k] != null && fieldValues[k] !== '');\r\n      if (anyField) candidates.push({ value: fieldValues[anyField], source: 'generic_field_fallback' });\r\n    }\r\n\r\n    const chosen = pickBest(candidates);\r\n    resolvedVariables[varName] = chosen.value;\r\n    varTrace.output = chosen.value;\r\n    varTrace.meta!.candidates = candidates.slice(0, 6).map(c => ({ source: c.source, sample: String(c.value).slice(0, 20) }));\r\n    varTrace.meta!.chosenSource = chosen.source;\r\n    trace.push(varTrace);\r\n  }\r\n\r\n  let strategy: OrchestratorResult['strategy'] = 'FULL_CALCULATION';\r\n  if (!operatorsDetected) {\r\n    const nonZero = Object.values(resolvedVariables).filter(v => v !== 0);\r\n    if (nonZero.length === 1 && tokenVariables.length === 1) strategy = 'DIRECT_VALUE';\r\n  }\r\n  trace.push({ step: 'select_strategy', output: strategy });\r\n\r\n  return { resolvedVariables, strategy, operatorsDetected, trace };\r\n}\r\n", "/**\r\n * \uD83C\uDF33 SYST\u00C8ME DE VALIDATION HI\u00C9RARCHIQUE AVANC\u00C9 - TreeBranchLeaf\r\n * \r\n * Syst\u00E8me de validation g\u00E9n\u00E9alogique complet pour \u00E9viter toute erreur de structure\r\n * \r\n * ARCHITECTURE (mise \u00E0 jour) :\r\n * - Niveau 1 : Arbre (racine unique)\r\n * - Niveau 2+ : Branches (peuvent \u00EAtre imbriqu\u00E9es \u00E0 l'infini sous l'arbre ou d'autres branches)\r\n * - Niveau 3+ : Champs/Options/Champs+Options (d\u00E9marrent au niveau 3, puis imbrication infinie)\r\n */\r\n\r\n// =============================================================================\r\n// \uD83C\uDFAF TYPES DE BASE\r\n// =============================================================================\r\n\r\nexport type NodeType = 'tree' | 'branch' | 'section' | 'leaf_field' | 'leaf_option' | 'leaf_option_field' | 'leaf_repeater';\r\nexport type NodeSubType = 'data' | 'SELECT' | 'TEXT' | 'NUMBER' | 'EMAIL' | 'TEL' | 'DATE' | 'TEXTAREA' | 'CHECKBOX' | 'RADIO';\r\n\r\nexport interface TreeNode {\r\n  id: string;\r\n  parentId: string | null;\r\n  type: NodeType;\r\n  subType?: NodeSubType;\r\n  label: string;\r\n  treeId: string;\r\n  order: number;\r\n}\r\n\r\nexport interface ValidationResult {\r\n  isValid: boolean;\r\n  reason?: string;\r\n  level?: number;\r\n  genealogy?: string[];\r\n  errorCode?: string;\r\n  suggestion?: string;\r\n}\r\n\r\nexport interface TreeIntegrityResult {\r\n  isValid: boolean;\r\n  errors: string[];\r\n  warnings: string[];\r\n  nodeCount: number;\r\n  maxDepth: number;\r\n}\r\n\r\n// =============================================================================\r\n// \uD83E\uDDEE CALCUL DE G\u00C9N\u00C9ALOGIE ET NIVEAUX AVANC\u00C9\r\n// =============================================================================\r\n\r\n/**\r\n * Calcule la g\u00E9n\u00E9alogie compl\u00E8te d'un n\u0153ud (chemin depuis la racine)\r\n * Retourne un tableau des IDs depuis la racine jusqu'au n\u0153ud\r\n */\r\nexport function calculateGenealogy(nodeId: string, nodesMap: Map<string, TreeNode>): string[] {\r\n  const genealogy: string[] = [];\r\n  let currentNode = nodesMap.get(nodeId);\r\n  const visitedNodes = new Set<string>(); // Protection contre les cycles\r\n  \r\n  // Remonter la hi\u00E9rarchie jusqu'\u00E0 la racine\r\n  while (currentNode) {\r\n    // Protection contre les cycles infinis\r\n    if (visitedNodes.has(currentNode.id)) {\r\n      throw new Error(`\uD83D\uDD04 Cycle d\u00E9tect\u00E9 dans la hi\u00E9rarchie au n\u0153ud ${currentNode.id} (${currentNode.label})`);\r\n    }\r\n    visitedNodes.add(currentNode.id);\r\n    \r\n    genealogy.unshift(currentNode.id); // Ajouter au d\u00E9but pour avoir l'ordre racine -> enfant\r\n    \r\n    if (!currentNode.parentId) {\r\n      break; // Racine atteinte\r\n    }\r\n    \r\n    currentNode = nodesMap.get(currentNode.parentId);\r\n    \r\n    // Protection suppl\u00E9mentaire contre la profondeur excessive\r\n    if (genealogy.length > 100) {\r\n      throw new Error('\uD83D\uDEAB Profondeur hi\u00E9rarchique excessive d\u00E9tect\u00E9e (>100 niveaux)');\r\n    }\r\n  }\r\n  \r\n  return genealogy;\r\n}\r\n\r\n/**\r\n * Calcule le niveau hi\u00E9rarchique d'un n\u0153ud dans l'arbre\r\n * Le niveau 1 = racine, niveau 2 = branches, niveau 3+ = champs/options\r\n */\r\nexport function calculateNodeLevel(nodeId: string, nodesMap: Map<string, TreeNode>): number {\r\n  try {\r\n    const genealogy = calculateGenealogy(nodeId, nodesMap);\r\n    return genealogy.length;\r\n  } catch (error) {\r\n    console.error('\u274C Erreur lors du calcul du niveau:', error);\r\n    return -1; // Erreur\r\n  }\r\n}\r\n\r\n/**\r\n * V\u00E9rifie qu'un n\u0153ud ne deviendrait pas son propre anc\u00EAtre (pr\u00E9vention des cycles)\r\n */\r\nexport function wouldCreateCycle(childId: string, newParentId: string, nodesMap: Map<string, TreeNode>): boolean {\r\n  if (childId === newParentId) return true;\r\n  \r\n  try {\r\n    const parentGenealogy = calculateGenealogy(newParentId, nodesMap);\r\n    return parentGenealogy.includes(childId);\r\n  } catch {\r\n    return true; // En cas d'erreur, consid\u00E9rer comme un cycle potentiel\r\n  }\r\n}\r\n\r\n/**\r\n * Obtient le chemin textuel depuis la racine (pour debug et messages d'erreur)\r\n */\r\nexport function getGenealogyPath(nodeId: string, nodesMap: Map<string, TreeNode>): string {\r\n  try {\r\n    const genealogy = calculateGenealogy(nodeId, nodesMap);\r\n    const labels = genealogy\r\n      .map(id => nodesMap.get(id)?.label || `[${id}]`)\r\n      .join(' > ');\r\n    return labels || 'N\u0153ud isol\u00E9';\r\n  } catch (error) {\r\n    return `\u274C Erreur: ${error instanceof Error ? error.message : 'Chemin invalide'}`;\r\n  }\r\n}\r\n\r\n/**\r\n * Calcule les statistiques d'un arbre\r\n */\r\nexport function getTreeStatistics(nodesMap: Map<string, TreeNode>): {\r\n  totalNodes: number;\r\n  nodesByType: Record<NodeType, number>;\r\n  maxDepth: number;\r\n  rootNodes: number;\r\n  orphanNodes: number;\r\n} {\r\n  const stats = {\r\n    totalNodes: nodesMap.size,\r\n    nodesByType: {\r\n      tree: 0,\r\n      branch: 0,\r\n      leaf_field: 0,\r\n      leaf_option: 0,\r\n      leaf_option_field: 0,\r\n      leaf_repeater: 0\r\n    } as Record<NodeType, number>,\r\n    maxDepth: 0,\r\n    rootNodes: 0,\r\n    orphanNodes: 0\r\n  };\r\n\r\n  for (const [nodeId, node] of nodesMap) {\r\n    // Compter par type\r\n    stats.nodesByType[node.type]++;\r\n    \r\n    // Compter les racines\r\n    if (!node.parentId) {\r\n      stats.rootNodes++;\r\n    }\r\n    \r\n    // Calculer la profondeur maximale\r\n    const level = calculateNodeLevel(nodeId, nodesMap);\r\n    if (level > stats.maxDepth) {\r\n      stats.maxDepth = level;\r\n    }\r\n    \r\n    // D\u00E9tecter les orphelins\r\n    if (node.parentId && !nodesMap.has(node.parentId)) {\r\n      stats.orphanNodes++;\r\n    }\r\n  }\r\n\r\n  return stats;\r\n}\r\n\r\n// =============================================================================\r\n// \uD83C\uDFAF VALIDATION HI\u00C9RARCHIQUE ROBUSTE\r\n// =============================================================================\r\n\r\n/**\r\n * Valide qu'un type de n\u0153ud peut exister \u00E0 un niveau donn\u00E9\r\n */\r\nexport function validateNodeTypeAtLevel(nodeType: NodeType, level: number): boolean {\r\n  switch (nodeType) {\r\n    case 'tree':\r\n      return level === 1; // Racine uniquement\r\n    \r\n    case 'branch':\r\n      // Les branches sont autoris\u00E9es \u00E0 n'importe quel niveau (racine ou imbriqu\u00E9e)\r\n      return level >= 1;\r\n    \r\n    case 'section':\r\n      // Les sections sont autoris\u00E9es \u00E0 partir du niveau 1 (sous une branche)\r\n      return level >= 1;\r\n    \r\n    case 'leaf_field':\r\n    case 'leaf_option':\r\n    case 'leaf_option_field':\r\n      // Les champs sont autoris\u00E9s \u00E0 partir du niveau 1 (sous une branche/section)\r\n      return level >= 1;\r\n    \r\n    case 'leaf_repeater':\r\n      // Les blocs r\u00E9p\u00E9tables sont autoris\u00E9s \u00E0 partir du niveau 1 (sous une branche/section)\r\n      return level >= 1;\r\n    \r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Obtient la r\u00E8gle d\u00E9taill\u00E9e pour un type de n\u0153ud\r\n */\r\nfunction getDetailedLevelRule(nodeType: NodeType): string {\r\n  switch (nodeType) {\r\n    case 'tree':\r\n      return 'Les arbres sont des racines (niveau 1 uniquement)';\r\n    case 'branch':\r\n  return 'Les branches peuvent \u00EAtre cr\u00E9\u00E9es \u00E0 partir du niveau 2, sous l\\'arbre ou sous une autre branche';\r\n    case 'leaf_field':\r\n      return 'Les champs doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_option':\r\n      return 'Les options doivent \u00EAtre cr\u00E9\u00E9es au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_option_field':\r\n      return 'Les champs+options doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_repeater':\r\n      return 'Les blocs r\u00E9p\u00E9tables doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches/sections)';\r\n    case 'leaf_select':\r\n      return 'Les s\u00E9lecteurs doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_text':\r\n      return 'Les champs texte doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_email':\r\n      return 'Les champs email doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_phone':\r\n      return 'Les champs t\u00E9l\u00E9phone doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_date':\r\n      return 'Les champs date doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_number':\r\n      return 'Les champs num\u00E9riques doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_checkbox':\r\n      return 'Les cases \u00E0 cocher doivent \u00EAtre cr\u00E9\u00E9es au niveau 2 ou plus (sous des branches)';\r\n    case 'leaf_radio':\r\n      return 'Les boutons radio doivent \u00EAtre cr\u00E9\u00E9s au niveau 2 ou plus (sous des branches)';\r\n    default:\r\n      return 'Type de n\u0153ud inconnu';\r\n  }\r\n}\r\n\r\n/**\r\n * Validation sp\u00E9cialis\u00E9e pour les \u00E9l\u00E9ments leaf (champs, options, champs+options)\r\n */\r\nfunction validateLeafElement(\r\n  parentType: NodeType,\r\n  parentLevel: number,\r\n  childType: NodeType,\r\n  childLevel: number,\r\n  elementName: string\r\n): ValidationResult {\r\n  \r\n  // \u274C NIVEAU 3+ OBLIGATOIRE : Pas directement sous l'arbre !\r\n  if (parentType === 'tree') {\r\n    return {\r\n      isValid: false,\r\n      reason: `Les ${elementName} ne peuvent pas \u00EAtre cr\u00E9\u00E9s directement sous l'arbre`,\r\n      level: childLevel,\r\n      errorCode: 'LEAF_NEEDS_BRANCH_PARENT',\r\n      suggestion: 'Cr\u00E9ez d\\'abord une branche au niveau 2, puis ajoutez vos \u00E9l\u00E9ments dedans'\r\n    };\r\n  }\r\n  \r\n  // \u2705 NIVEAU 2+ : Sous des branches, sections ou autres leaf_* \r\n  if (parentType === 'branch' || parentType === 'section' || parentType.startsWith('leaf_')) {\r\n    return {\r\n      isValid: true,\r\n      level: childLevel,\r\n      errorCode: undefined\r\n    };\r\n  }\r\n  \r\n  return {\r\n    isValid: false,\r\n    reason: `Les ${elementName} ne peuvent \u00EAtre cr\u00E9\u00E9s que sous des branches ou d'autres \u00E9l\u00E9ments leaf (niveau 3+)`,\r\n    level: childLevel,\r\n    errorCode: 'INVALID_LEAF_PARENT',\r\n    suggestion: 'Glissez cet \u00E9l\u00E9ment vers une branche ou un autre champ'\r\n  };\r\n}\r\n\r\n/**\r\n * Validation principale des relations parent-enfant avec g\u00E9n\u00E9alogie compl\u00E8te\r\n */\r\nexport function validateParentChildRelation(\r\n  parentType: NodeType,\r\n  parentSubType: NodeSubType,\r\n  childType: NodeType,\r\n  childSubType: NodeSubType,\r\n  parentLevel?: number,\r\n  nodesMap?: Map<string, TreeNode>,\r\n  parentId?: string\r\n): ValidationResult {\r\n  \r\n  // Calculer le niveau du parent avec validation\r\n  let actualParentLevel: number;\r\n  if (parentLevel !== undefined) {\r\n    actualParentLevel = parentLevel;\r\n  } else if (nodesMap && parentId) {\r\n    actualParentLevel = calculateNodeLevel(parentId, nodesMap);\r\n    if (actualParentLevel === -1) {\r\n      return {\r\n        isValid: false,\r\n        reason: 'Impossible de calculer le niveau du parent (structure corrompue)',\r\n        errorCode: 'CORRUPTED_HIERARCHY',\r\n        suggestion: 'Rechargez la page ou contactez le support'\r\n      };\r\n    }\r\n  } else {\r\n    // Niveau par d\u00E9faut bas\u00E9 sur le type\r\n    actualParentLevel = parentType === 'tree' ? 1 : parentType === 'branch' ? 2 : 3;\r\n  }\r\n  \r\n  const childLevel = actualParentLevel + 1;\r\n  \r\n  // Validation du niveau enfant\r\n  if (!validateNodeTypeAtLevel(childType, childLevel)) {\r\n    return {\r\n      isValid: false,\r\n      reason: `Le type ${childType} ne peut pas \u00EAtre plac\u00E9 au niveau ${childLevel}. ${getDetailedLevelRule(childType)}`,\r\n      level: childLevel,\r\n      errorCode: 'INVALID_LEVEL'\r\n    };\r\n  }\r\n  \r\n  // V\u00E9rification des cycles si les donn\u00E9es sont disponibles\r\n  if (nodesMap && parentId) {\r\n    try {\r\n      const genealogy = calculateGenealogy(parentId, nodesMap);\r\n      return {\r\n        isValid: true,\r\n        level: childLevel,\r\n        genealogy,\r\n        errorCode: undefined\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        isValid: false,\r\n        reason: error instanceof Error ? error.message : 'Erreur de g\u00E9n\u00E9alogie',\r\n        level: childLevel,\r\n        errorCode: 'GENEALOGY_ERROR'\r\n      };\r\n    }\r\n  }\r\n  \r\n  // Validation des relations sp\u00E9cifiques avec codes d'erreur\r\n  switch (childType) {\r\n    case 'tree':\r\n      return {\r\n        isValid: false,\r\n        reason: 'Un arbre ne peut pas avoir de parent (c\\'est la racine)',\r\n        level: childLevel,\r\n        errorCode: 'TREE_CANNOT_HAVE_PARENT',\r\n        suggestion: 'Les arbres sont des \u00E9l\u00E9ments racines et ne peuvent \u00EAtre imbriqu\u00E9s'\r\n      };\r\n    \r\n    case 'branch':\r\n    case 'section':\r\n      // Autoriser les branches et sections sous l'arbre, une autre branche ou une autre section\r\n      if (parentType === 'tree' || parentType === 'branch' || parentType === 'section') {\r\n        return {\r\n          isValid: true,\r\n          level: childLevel,\r\n          errorCode: undefined\r\n        };\r\n      }\r\n      return {\r\n        isValid: false,\r\n        reason: `Les branches/sections doivent \u00EAtre sous l'arbre ou une autre branche/section (parent actuel: ${parentType})`,\r\n        level: childLevel,\r\n        errorCode: 'BRANCH_INVALID_PARENT',\r\n        suggestion: 'Placez cet \u00E9l\u00E9ment sous l\\'arbre ou une branche/section existante'\r\n      };\r\n    \r\n    case 'leaf_field':\r\n    case 'leaf_option_field':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, \r\n        childType === 'leaf_field' ? 'champs' : 'champs+options');\r\n    \r\n    case 'leaf_option':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'options');\r\n    \r\n    case 'leaf_select':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 's\u00E9lecteurs');\r\n    \r\n    case 'leaf_text':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'champs texte');\r\n    \r\n    case 'leaf_email':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'champs email');\r\n    \r\n    case 'leaf_phone':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'champs t\u00E9l\u00E9phone');\r\n    \r\n    case 'leaf_date':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'champs date');\r\n    \r\n    case 'leaf_number':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'champs num\u00E9riques');\r\n    \r\n    case 'leaf_checkbox':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'cases \u00E0 cocher');\r\n    \r\n    case 'leaf_radio':\r\n      return validateLeafElement(parentType, actualParentLevel, childType, childLevel, 'boutons radio');\r\n    \r\n    case 'leaf_repeater':\r\n      // Le repeater est un conteneur qui peut \u00EAtre sous une branche/section\r\n      if (parentType === 'tree') {\r\n        return {\r\n          isValid: false,\r\n          reason: 'Les blocs r\u00E9p\u00E9tables ne peuvent pas \u00EAtre cr\u00E9\u00E9s directement sous l\\'arbre',\r\n          level: childLevel,\r\n          errorCode: 'REPEATER_NEEDS_BRANCH_PARENT',\r\n          suggestion: 'Cr\u00E9ez d\\'abord une branche, puis ajoutez le bloc r\u00E9p\u00E9table dedans'\r\n        };\r\n      }\r\n      // Sous une branche, section ou autre leaf_* : OK\r\n      if (parentType === 'branch' || parentType === 'section' || parentType.startsWith('leaf_')) {\r\n        return {\r\n          isValid: true,\r\n          level: childLevel,\r\n          errorCode: undefined\r\n        };\r\n      }\r\n      return {\r\n        isValid: false,\r\n        reason: 'Les blocs r\u00E9p\u00E9tables ne peuvent \u00EAtre cr\u00E9\u00E9s que sous des branches ou sections',\r\n        level: childLevel,\r\n        errorCode: 'REPEATER_INVALID_PARENT'\r\n      };\r\n    \r\n    default:\r\n      return {\r\n        isValid: false,\r\n        reason: `Type de n\u0153ud non reconnu: ${childType}`,\r\n        level: childLevel,\r\n        errorCode: 'UNKNOWN_NODE_TYPE',\r\n        suggestion: 'Contactez le support technique'\r\n      };\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// \uD83D\uDE80 FONCTIONS UTILITAIRES AVANC\u00C9ES\r\n// =============================================================================\r\n\r\n/**\r\n * Valide une op\u00E9ration de d\u00E9placement de n\u0153ud avec v\u00E9rification compl\u00E8te\r\n */\r\nexport function validateNodeMove(\r\n  sourceNodeId: string,\r\n  targetNodeId: string,\r\n  nodesMap: Map<string, TreeNode>\r\n): ValidationResult {\r\n  \r\n  const sourceNode = nodesMap.get(sourceNodeId);\r\n  const targetNode = nodesMap.get(targetNodeId);\r\n  \r\n  if (!sourceNode) {\r\n    return {\r\n      isValid: false,\r\n      reason: 'N\u0153ud source introuvable',\r\n      errorCode: 'SOURCE_NOT_FOUND',\r\n      suggestion: 'Actualisez la page et r\u00E9essayez'\r\n    };\r\n  }\r\n  \r\n  if (!targetNode) {\r\n    return {\r\n      isValid: false,\r\n      reason: 'N\u0153ud cible introuvable', \r\n      errorCode: 'TARGET_NOT_FOUND',\r\n      suggestion: 'Actualisez la page et r\u00E9essayez'\r\n    };\r\n  }\r\n  \r\n  // V\u00E9rification des cycles AVANT validation hi\u00E9rarchique\r\n  if (wouldCreateCycle(sourceNodeId, targetNodeId, nodesMap)) {\r\n    return {\r\n      isValid: false,\r\n      reason: `Impossible de d\u00E9placer \"${sourceNode.label}\" vers \"${targetNode.label}\" : cela cr\u00E9erait un cycle dans l'arbre`,\r\n      errorCode: 'WOULD_CREATE_CYCLE',\r\n      suggestion: 'Choisissez une cible qui n\\'est pas un descendant du n\u0153ud \u00E0 d\u00E9placer'\r\n    };\r\n  }\r\n  \r\n  // Validation hi\u00E9rarchique avec informations compl\u00E8tes\r\n  const validation = validateParentChildRelation(\r\n    targetNode.type,\r\n    targetNode.subType || 'data',\r\n    sourceNode.type,\r\n    sourceNode.subType || 'data',\r\n    undefined,\r\n    nodesMap,\r\n    targetNodeId\r\n  );\r\n  \r\n  // Ajouter des informations de contexte\r\n  if (!validation.isValid && targetNode && sourceNode) {\r\n    validation.reason += ` (Source: \"${sourceNode.label}\", Cible: \"${targetNode.label}\")`;\r\n  }\r\n  \r\n  return validation;\r\n}\r\n\r\n/**\r\n * Obtient la liste des types de n\u0153uds autoris\u00E9s pour un parent donn\u00E9\r\n */\r\nexport function getAllowedChildTypes(\r\n  parentType: NodeType,\r\n  parentSubType: NodeSubType = 'data',\r\n  parentLevel?: number\r\n): NodeType[] {\r\n  \r\n  const allowedTypes: NodeType[] = [];\r\n  const allTypes: NodeType[] = ['tree', 'branch', 'section', 'leaf_field', 'leaf_option', 'leaf_option_field', 'leaf_repeater'];\r\n  \r\n  for (const childType of allTypes) {\r\n    const validation = validateParentChildRelation(\r\n      parentType, \r\n      parentSubType, \r\n      childType, \r\n      'data', \r\n      parentLevel\r\n    );\r\n    if (validation.isValid) {\r\n      allowedTypes.push(childType);\r\n    }\r\n  }\r\n  \r\n  return allowedTypes;\r\n}\r\n\r\n/**\r\n * G\u00E9n\u00E8re un message d'erreur d\u00E9taill\u00E9 et localis\u00E9\r\n */\r\nexport function getValidationErrorMessage(\r\n  parentType: NodeType,\r\n  parentSubType: NodeSubType,\r\n  childType: NodeType,\r\n  childSubType: NodeSubType,\r\n  parentLevel?: number\r\n): string {\r\n  const validation = validateParentChildRelation(\r\n    parentType, \r\n    parentSubType, \r\n    childType, \r\n    childSubType, \r\n    parentLevel\r\n  );\r\n  \r\n  if (validation.isValid) {\r\n    return '\u2705 Op\u00E9ration valide';\r\n  }\r\n\r\n  // Messages personnalis\u00E9s selon le code d'erreur\r\n  switch (validation.errorCode) {\r\n    case 'BRANCH_ONLY_UNDER_TREE':\r\n      return '\uD83D\uDEAB R\u00E8gle mise \u00E0 jour: les branches sont permises \u00E0 partir du niveau 2 sous l\\'arbre ou une autre branche';\r\n    case 'BRANCH_INVALID_PARENT':\r\n      return '\uD83D\uDEAB Les branches doivent \u00EAtre sous l\\'arbre ou une autre branche';\r\n    \r\n    case 'LEAF_NEEDS_BRANCH_PARENT': {\r\n      const elementName = childType === 'leaf_field' ? 'champs' : \r\n                         childType === 'leaf_option' ? 'options' : 'champs+options';\r\n      return `\uD83D\uDEAB Les ${elementName} doivent \u00EAtre cr\u00E9\u00E9s au niveau 3 ou plus. Cr\u00E9ez d'abord une branche`;\r\n    }\r\n    \r\n    case 'TREE_CANNOT_HAVE_PARENT':\r\n      return '\uD83D\uDEAB Un arbre est une racine et ne peut pas avoir de parent';\r\n    \r\n    case 'WOULD_CREATE_CYCLE':\r\n      return '\uD83D\uDD04 Cette op\u00E9ration cr\u00E9erait un cycle dans l\\'arbre (n\u0153ud qui deviendrait son propre parent)';\r\n    \r\n    case 'CORRUPTED_HIERARCHY':\r\n      return '\uD83D\uDCA5 Structure d\\'arbre corrompue d\u00E9tect\u00E9e. Rechargez la page';\r\n    \r\n    case 'INVALID_LEVEL':\r\n      return `\uD83D\uDCCF Niveau incorrect pour ce type de n\u0153ud. ${validation.reason}`;\r\n    \r\n    default: {\r\n      const message = validation.reason || '\u274C Relation parent-enfant non autoris\u00E9e';\r\n      return validation.suggestion ? `${message} (\uD83D\uDCA1 ${validation.suggestion})` : message;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * V\u00E9rifie l'int\u00E9grit\u00E9 compl\u00E8te d'un arbre\r\n */\r\nexport function validateTreeIntegrity(nodesMap: Map<string, TreeNode>): TreeIntegrityResult {\r\n  const errors: string[] = [];\r\n  const warnings: string[] = [];\r\n  let maxDepth = 0;\r\n  \r\n  // Statistiques de base\r\n  const stats = getTreeStatistics(nodesMap);\r\n  \r\n  // V\u00E9rifications globales\r\n  if (stats.rootNodes === 0) {\r\n    errors.push('\u274C Aucun n\u0153ud racine trouv\u00E9');\r\n  } else if (stats.rootNodes > 1) {\r\n    warnings.push(`\u26A0\uFE0F Plusieurs n\u0153uds racines d\u00E9tect\u00E9s (${stats.rootNodes})`);\r\n  }\r\n  \r\n  if (stats.orphanNodes > 0) {\r\n    errors.push(`\u274C ${stats.orphanNodes} n\u0153ud(s) orphelin(s) d\u00E9tect\u00E9(s)`);\r\n  }\r\n  \r\n  // V\u00E9rifier chaque n\u0153ud individuellement\r\n  for (const [nodeId, node] of nodesMap) {\r\n    try {\r\n      // V\u00E9rifier que le niveau correspond au type\r\n      const level = calculateNodeLevel(nodeId, nodesMap);\r\n      maxDepth = Math.max(maxDepth, level);\r\n      \r\n      if (level === -1) {\r\n        errors.push(`\u274C Impossible de calculer le niveau du n\u0153ud \"${node.label}\"`);\r\n        continue;\r\n      }\r\n      \r\n      if (!validateNodeTypeAtLevel(node.type, level)) {\r\n        errors.push(`\u274C N\u0153ud \"${node.label}\" (${node.type}) au niveau ${level} incorrect. ${getDetailedLevelRule(node.type)}`);\r\n      }\r\n      \r\n      // V\u00E9rifier la relation avec le parent\r\n      if (node.parentId) {\r\n        const parent = nodesMap.get(node.parentId);\r\n        if (parent) {\r\n          const validation = validateParentChildRelation(\r\n            parent.type,\r\n            parent.subType || 'data',\r\n            node.type,\r\n            node.subType || 'data'\r\n          );\r\n          if (!validation.isValid) {\r\n            errors.push(`\u274C Relation invalide: \"${parent.label}\" -> \"${node.label}\": ${validation.reason}`);\r\n          }\r\n        } else {\r\n          errors.push(`\u274C N\u0153ud \"${node.label}\" r\u00E9f\u00E9rence un parent inexistant: ${node.parentId}`);\r\n        }\r\n      }\r\n      \r\n      // V\u00E9rifications sp\u00E9cifiques par type\r\n      switch (node.type) {\r\n        case 'tree':\r\n          if (node.parentId) {\r\n            errors.push(`\u274C L'arbre \"${node.label}\" ne peut pas avoir de parent`);\r\n          }\r\n          break;\r\n        \r\n        case 'branch':\r\n          if (level < 2) {\r\n            errors.push(`\u274C La branche \"${node.label}\" doit \u00EAtre au niveau 2 ou plus (actuellement: ${level})`);\r\n          }\r\n          break;\r\n        \r\n        case 'leaf_field':\r\n        case 'leaf_option':\r\n        case 'leaf_option_field':\r\n          if (level < 3) {\r\n            errors.push(`\u274C L'\u00E9l\u00E9ment \"${node.label}\" (${node.type}) doit \u00EAtre au niveau 3 ou plus (actuellement: ${level})`);\r\n          }\r\n          break;\r\n      }\r\n      \r\n    } catch (error) {\r\n      errors.push(`\u274C Erreur lors de la validation du n\u0153ud \"${node.label}\": ${error instanceof Error ? error.message : 'Erreur inconnue'}`);\r\n    }\r\n  }\r\n  \r\n  // V\u00E9rifications de performance\r\n  if (maxDepth > 20) {\r\n    warnings.push(`\u26A0\uFE0F Profondeur importante d\u00E9tect\u00E9e (${maxDepth} niveaux). Cela pourrait affecter les performances.`);\r\n  }\r\n  \r\n  if (nodesMap.size > 1000) {\r\n    warnings.push(`\u26A0\uFE0F Nombre important de n\u0153uds (${nodesMap.size}). Consid\u00E9rez diviser en plusieurs arbres.`);\r\n  }\r\n  \r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors,\r\n    warnings,\r\n    nodeCount: nodesMap.size,\r\n    maxDepth\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// \uD83D\uDCCB R\u00C8GLES D'INTERFACE ET CONFIGURATION\r\n// =============================================================================\r\n\r\n/**\r\n * R\u00E8gles sp\u00E9cifiques pour l'affichage et l'UI\r\n */\r\nexport const UI_RULES = {\r\n  /**\r\n   * Types de n\u0153uds qui peuvent \u00EAtre gliss\u00E9s depuis la palette\r\n   */\r\n  DRAGGABLE_PALETTE_TYPES: ['branch', 'leaf_field', 'leaf_option', 'leaf_option_field'] as NodeType[],\r\n  \r\n  /**\r\n   * Types de n\u0153uds qui acceptent des drops\r\n   */\r\n  DROPPABLE_TYPES: ['tree', 'branch', 'leaf_field', 'leaf_option_field'] as NodeType[],\r\n  \r\n  /**\r\n   * Niveaux maximum autoris\u00E9s (0 = illimit\u00E9)\r\n   */\r\n  MAX_LEVELS: 0, // Infini pour les niveaux 3+\r\n  \r\n  /**\r\n   * Messages d'erreur standardis\u00E9s pour l'UI\r\n   */\r\n  ERROR_MESSAGES: {\r\n    INVALID_LEVEL: 'Ce type de n\u0153ud ne peut pas \u00EAtre plac\u00E9 \u00E0 ce niveau',\r\n  BRANCH_ONLY_LEVEL_2: 'Les branches sont autoris\u00E9es \u00E0 partir du niveau 2 (sous l\\'arbre ou une autre branche)',\r\n    FIELDS_LEVEL_3_PLUS: 'Les champs/options ne peuvent \u00EAtre cr\u00E9\u00E9s qu\\'\u00E0 partir du niveau 3',\r\n    WOULD_CREATE_CYCLE: 'Cette action cr\u00E9erait un cycle dans l\\'arbre',\r\n    CORRUPTED_STRUCTURE: 'Structure d\\'arbre corrompue d\u00E9tect\u00E9e'\r\n  },\r\n\r\n  /**\r\n   * Styles de validation pour l'UI\r\n   */\r\n  VALIDATION_STYLES: {\r\n    VALID_DROP: 'border-green-500 bg-green-50',\r\n    INVALID_DROP: 'border-red-500 bg-red-50',\r\n    NEUTRAL: 'border-gray-300 bg-white'\r\n  }\r\n} as const;\r\n\r\n/**\r\n * Configuration des types de champs disponibles avec m\u00E9tadonn\u00E9es\r\n */\r\nexport const FIELD_TYPES_CONFIG = {\r\n  TEXT: { \r\n    label: 'Texte', \r\n    icon: '\uD83D\uDCDD', \r\n    category: 'input',\r\n    description: 'Champ de saisie de texte simple',\r\n    validation: ['required', 'minLength', 'maxLength', 'pattern']\r\n  },\r\n  NUMBER: { \r\n    label: 'Nombre', \r\n    icon: '\uD83D\uDD22', \r\n    category: 'input',\r\n    description: 'Champ num\u00E9rique avec validation',\r\n    validation: ['required', 'min', 'max', 'step']\r\n  },\r\n  EMAIL: { \r\n    label: 'Email', \r\n    icon: '\uD83D\uDCE7', \r\n    category: 'input',\r\n    description: 'Champ email avec validation automatique',\r\n    validation: ['required', 'email']\r\n  },\r\n  TEL: { \r\n    label: 'T\u00E9l\u00E9phone', \r\n    icon: '\uD83D\uDCDE', \r\n    category: 'input',\r\n    description: 'Champ t\u00E9l\u00E9phone avec formatage',\r\n    validation: ['required', 'phone']\r\n  },\r\n  DATE: { \r\n    label: 'Date', \r\n    icon: '\uD83D\uDCC5', \r\n    category: 'input',\r\n    description: 'S\u00E9lecteur de date',\r\n    validation: ['required', 'dateFormat', 'minDate', 'maxDate']\r\n  },\r\n  TEXTAREA: { \r\n    label: 'Texte long', \r\n    icon: '\uD83D\uDCC4', \r\n    category: 'input',\r\n    description: 'Zone de texte multi-lignes',\r\n    validation: ['required', 'minLength', 'maxLength']\r\n  },\r\n  SELECT: { \r\n    label: 'Liste d\u00E9roulante', \r\n    icon: '\uD83D\uDCCB', \r\n    category: 'select',\r\n    description: 'Liste de choix avec options',\r\n    validation: ['required'],\r\n    requiresOptions: true\r\n  },\r\n  CHECKBOX: { \r\n    label: 'Case \u00E0 cocher', \r\n    icon: '\u2611\uFE0F', \r\n    category: 'choice',\r\n    description: 'Case \u00E0 cocher bool\u00E9enne',\r\n    validation: ['required']\r\n  },\r\n  RADIO: { \r\n    label: 'Bouton radio', \r\n    icon: '\uD83D\uDD18', \r\n    category: 'choice',\r\n    description: 'S\u00E9lection unique parmi plusieurs choix',\r\n    validation: ['required'],\r\n    requiresOptions: true\r\n  }\r\n} as const;\r\n\r\n/**\r\n * Th\u00E8mes de couleur pour les diff\u00E9rents types de n\u0153uds\r\n */\r\nexport const NODE_THEMES = {\r\n  tree: {\r\n    backgroundColor: '#1f2937',\r\n    textColor: '#ffffff',\r\n    borderColor: '#374151',\r\n    icon: '\uD83C\uDF33'\r\n  },\r\n  branch: {\r\n    backgroundColor: '#3b82f6',\r\n    textColor: '#ffffff', \r\n    borderColor: '#2563eb',\r\n    icon: '\uD83C\uDF3F'\r\n  },\r\n  leaf_field: {\r\n    backgroundColor: '#10b981',\r\n    textColor: '#ffffff',\r\n    borderColor: '#059669',\r\n    icon: '\uD83D\uDCDD'\r\n  },\r\n  leaf_option: {\r\n    backgroundColor: '#f59e0b',\r\n    textColor: '#ffffff',\r\n    borderColor: '#d97706',\r\n    icon: '\u26AA'\r\n  },\r\n  leaf_option_field: {\r\n    backgroundColor: '#8b5cf6',\r\n    textColor: '#ffffff',\r\n    borderColor: '#7c3aed',\r\n    icon: '\uD83C\uDFAF'\r\n  },\r\n  section: {\r\n    backgroundColor: '#6b7280',\r\n    textColor: '#ffffff',\r\n    borderColor: '#4b5563',\r\n    icon: '\uD83D\uDCCB'\r\n  }\r\n} as const;\r\n", "/**\r\n * \uD83E\uDDEE Syst\u00E8me de copie des FORMULES\r\n * \r\n * Ce module g\u00E8re la copie compl\u00E8te d'une formule (TreeBranchLeafNodeFormula)\r\n * avec r\u00E9\u00E9criture des tokens pour pointer vers les nouveaux IDs.\r\n * \r\n * PRINCIPES :\r\n * -----------\r\n * 1. Copier la formule avec suffixe\r\n * 2. R\u00E9\u00E9crire les tokens (@value.ID \u2192 @value.ID-suffix)\r\n * 3. Mettre \u00E0 jour linkedFormulaIds du n\u0153ud propri\u00E9taire\r\n * 4. Synchroniser les param\u00E8tres de capacit\u00E9 (hasFormula, formula_activeId, etc.)\r\n * \r\n * @author System TBL\r\n * @version 1.0.0\r\n */\r\n\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCB TYPES ET INTERFACES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Options pour la copie de formule\r\n */\r\nexport interface CopyFormulaOptions {\r\n  /** Map des n\u0153uds copi\u00E9s (ancien ID \u2192 nouveau ID) pour r\u00E9\u00E9crire les tokens */\r\n  nodeIdMap?: Map<string, string>;\r\n  /** Map des formules d\u00E9j\u00E0 copi\u00E9es (cache pour \u00E9viter doublons) */\r\n  formulaCopyCache?: Map<string, string>;\r\n}\r\n\r\n/**\r\n * R\u00E9sultat de la copie d'une formule\r\n */\r\nexport interface CopyFormulaResult {\r\n  /** ID de la formule copi\u00E9e */\r\n  newFormulaId: string;\r\n  /** ID du n\u0153ud propri\u00E9taire */\r\n  nodeId: string;\r\n  /** Tokens r\u00E9\u00E9crits */\r\n  tokens: Prisma.InputJsonValue;\r\n  /** Succ\u00E8s de l'op\u00E9ration */\r\n  success: boolean;\r\n  /** Message d'erreur \u00E9ventuel */\r\n  error?: string;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES DE R\u00C9\u00C9CRITURE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * R\u00E9\u00E9crire les tokens d'une formule pour remplacer les anciens IDs par les nouveaux\r\n * \r\n * Format des tokens :\r\n * - Array de strings/objets : [\"@value.abc-123\", \"+\", \"@value.def-456\"]\r\n * - Peut contenir des UUIDs ou des node_xxx\r\n * \r\n * @param tokens - Tokens originaux\r\n * @param idMap - Map ancien ID \u2192 nouveau ID\r\n * @param suffix - Suffixe \u00E0 ajouter si ID pas trouv\u00E9 dans la map\r\n * @returns Tokens r\u00E9\u00E9crits\r\n * \r\n * @example\r\n * rewriteFormulaTokens(\r\n *   [\"@value.abc\", \"+\", \"@value.def\"],\r\n *   new Map([[\"abc\", \"abc-1\"]]),\r\n *   1\r\n * )\r\n * \u2192 [\"@value.abc-1\", \"+\", \"@value.def-1\"]\r\n */\r\nfunction rewriteFormulaTokens(\r\n  tokens: unknown,\r\n  idMap: Map<string, string>,\r\n  suffix?: string | number\r\n): Prisma.InputJsonValue {\r\n  if (!tokens) return tokens as Prisma.InputJsonValue;\r\n\r\n  const rewriteString = (str: string): string => {\r\n    // Regex pour capturer @value.<ID> avec UUID ou node_xxx\r\n    return str.replace(/@value\\.([A-Za-z0-9_:-]+)/g, (_match, nodeId: string) => {\r\n      // 1. Chercher dans la map\r\n      const mappedId = idMap.get(nodeId);\r\n      if (mappedId) {\r\n        return `@value.${mappedId}`;\r\n      }\r\n      \r\n      // 2. Si pas dans la map et qu'on a un suffixe, l'ajouter automatiquement\r\n      if (suffix !== undefined) {\r\n        // V\u00E9rifier si l'ID a d\u00E9j\u00E0 un suffixe\r\n        const hasSuffix = /-\\d+$/.test(nodeId);\r\n        if (!hasSuffix) {\r\n          return `@value.${nodeId}-${suffix}`;\r\n        }\r\n      }\r\n      \r\n      // 3. Sinon garder tel quel\r\n      return `@value.${nodeId}`;\r\n    });\r\n  };\r\n\r\n  // Si tokens est un array\r\n  if (Array.isArray(tokens)) {\r\n    return tokens.map(token => {\r\n      if (typeof token === 'string') {\r\n        return rewriteString(token);\r\n      }\r\n      // Si c'est un objet, stringify puis rewrite puis parse\r\n      if (token && typeof token === 'object') {\r\n        try {\r\n          const str = JSON.stringify(token);\r\n          const rewritten = rewriteString(str);\r\n          return JSON.parse(rewritten);\r\n        } catch {\r\n          return token;\r\n        }\r\n      }\r\n      return token;\r\n    }) as Prisma.InputJsonValue;\r\n  }\r\n\r\n  // Si tokens est une string\r\n  if (typeof tokens === 'string') {\r\n    return rewriteString(tokens) as Prisma.InputJsonValue;\r\n  }\r\n\r\n  // Si tokens est un objet\r\n  if (tokens && typeof tokens === 'object') {\r\n    try {\r\n      const str = JSON.stringify(tokens);\r\n      const rewritten = rewriteString(str);\r\n      return JSON.parse(rewritten) as Prisma.InputJsonValue;\r\n    } catch {\r\n      return tokens as Prisma.InputJsonValue;\r\n    }\r\n  }\r\n\r\n  return tokens as Prisma.InputJsonValue;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD04 FONCTION PRINCIPALE DE COPIE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Copie une formule avec r\u00E9\u00E9criture des tokens\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. V\u00E9rifier le cache (\u00E9viter doublons)\r\n * 2. R\u00E9cup\u00E9rer la formule originale\r\n * 3. G\u00E9n\u00E9rer le nouvel ID avec suffixe\r\n * 4. R\u00E9\u00E9crire les tokens (@value.ID \u2192 @value.ID-suffix)\r\n * 5. Cr\u00E9er la nouvelle formule\r\n * 6. Mettre \u00E0 jour linkedFormulaIds du n\u0153ud\r\n * 7. Synchroniser les param\u00E8tres de capacit\u00E9\r\n * 8. Mettre en cache\r\n * \r\n * @param originalFormulaId - ID de la formule \u00E0 copier\r\n * @param newNodeId - ID du nouveau n\u0153ud propri\u00E9taire\r\n * @param suffix - Suffixe num\u00E9rique \u00E0 appliquer\r\n * @param prisma - Instance Prisma Client\r\n * @param options - Options avec nodeIdMap\r\n * @returns R\u00E9sultat de la copie\r\n * \r\n * @example\r\n * const result = await copyFormulaCapacity(\r\n *   'formula-abc',\r\n *   'node-xyz-1',\r\n *   1,\r\n *   prisma,\r\n *   { nodeIdMap: new Map([['node-a', 'node-a-1']]) }\r\n * );\r\n * // result.newFormulaId = 'formula-abc-1'\r\n * // result.tokens = [\"@value.node-a-1\", \"+\", \"5\"]\r\n */\r\nexport async function copyFormulaCapacity(\r\n  originalFormulaId: string,\r\n  newNodeId: string,\r\n  suffix: number,\r\n  prisma: PrismaClient,\r\n  options: CopyFormulaOptions = {}\r\n): Promise<CopyFormulaResult> {\r\n  \r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uD83E\uDDEE COPIE FORMULE: ${originalFormulaId}`);\r\n  console.log(`   Suffixe: ${suffix}`);\r\n  console.log(`   Nouveau n\u0153ud: ${newNodeId}`);\r\n  console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n  const {\r\n    nodeIdMap = new Map(),\r\n    formulaCopyCache = new Map()\r\n  } = options;\r\n\r\n  try {\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD0D \u00C9TAPE 1 : V\u00E9rifier le cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    if (formulaCopyCache.has(originalFormulaId)) {\r\n      const cachedId = formulaCopyCache.get(originalFormulaId)!;\r\n      console.log(`\u267B\uFE0F Formule d\u00E9j\u00E0 copi\u00E9e (cache): ${originalFormulaId} \u2192 ${cachedId}`);\r\n      \r\n      const cached = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n        where: { id: cachedId }\r\n      });\r\n      \r\n      if (cached) {\r\n        return {\r\n          newFormulaId: cached.id,\r\n          nodeId: cached.nodeId,\r\n          tokens: cached.tokens,\r\n          success: true\r\n        };\r\n      }\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCE5 \u00C9TAPE 2 : R\u00E9cup\u00E9rer la formule originale PAR ID (enlever suffixe si pr\u00E9sent)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // originalFormulaId peut contenir un suffixe si c'est d\u00E9j\u00E0 une copie\r\n    // On enl\u00E8ve le suffixe pour trouver l'original\r\n    const cleanFormulaId = originalFormulaId.replace(/-\\d+$/, '');\r\n    console.log(`\uD83D\uDD0D Recherche formule avec id: ${cleanFormulaId} (original: ${originalFormulaId})`);\r\n    \r\n    const originalFormula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n      where: { id: cleanFormulaId }\r\n    });\r\n\r\n    if (!originalFormula) {\r\n      console.error(`\u274C Formule introuvable avec id: ${cleanFormulaId}`);\r\n      return {\r\n        newFormulaId: '',\r\n        nodeId: '',\r\n        tokens: null,\r\n        success: false,\r\n        error: `Formule introuvable avec id: ${cleanFormulaId}`\r\n      };\r\n    }\r\n\r\n    console.log(`\u2705 Formule trouv\u00E9e: ${originalFormula.name || originalFormula.id}`);\r\n    console.log(`   NodeId original: ${originalFormula.nodeId}`);\r\n    console.log(`   Tokens originaux:`, originalFormula.tokens);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83C\uDD94 \u00C9TAPE 3 : G\u00E9n\u00E9rer le nouvel ID (pour la formule elle-m\u00EAme)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // On utilise l'id original de la formule avec suffixe\r\n    const newFormulaId = `${originalFormula.id}-${suffix}`;\r\n    console.log(`\uD83D\uDCDD Nouvel ID formule: ${newFormulaId}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD04 \u00C9TAPE 4 : R\u00E9\u00E9crire les tokens\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    console.log(`\\n\uD83D\uDD04 R\u00E9\u00E9criture des tokens...`);\r\n    console.log(`   Nombre d'IDs dans la map: ${nodeIdMap.size}`);\r\n    \r\n    const rewrittenTokens = rewriteFormulaTokens(originalFormula.tokens, nodeIdMap, suffix);\r\n    \r\n    console.log(`\u2705 Tokens r\u00E9\u00E9crits:`, rewrittenTokens);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCBE \u00C9TAPE 5 : Cr\u00E9er la nouvelle formule\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    const newFormula = await prisma.treeBranchLeafNodeFormula.create({\r\n      data: {\r\n        id: newFormulaId,\r\n        nodeId: newNodeId,\r\n        organizationId: originalFormula.organizationId,\r\n        name: originalFormula.name ? `${originalFormula.name}-${suffix}` : null,\r\n        description: originalFormula.description,\r\n        tokens: rewrittenTokens,\r\n        metadata: originalFormula.metadata as Prisma.InputJsonValue,\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`\u2705 Formule cr\u00E9\u00E9e: ${newFormula.id}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 6 : Mettre \u00E0 jour linkedFormulaIds du n\u0153ud\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      await addToNodeLinkedField(prisma, newNodeId, 'linkedFormulaIds', [newFormulaId]);\r\n      console.log(`\u2705 linkedFormulaIds mis \u00E0 jour pour n\u0153ud ${newNodeId}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur MAJ linkedFormulaIds:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCDD \u00C9TAPE 7 : Synchroniser les param\u00E8tres de capacit\u00E9\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: newNodeId },\r\n        data: {\r\n          hasFormula: true,\r\n          formula_activeId: newFormulaId,\r\n          formula_name: newFormula.name,\r\n          formula_description: newFormula.description\r\n        }\r\n      });\r\n      console.log(`\u2705 Param\u00E8tres capacit\u00E9 (formula) mis \u00E0 jour pour n\u0153ud ${newNodeId}`);\r\n      console.log(`   - formula_activeId: ${newFormulaId}`);\r\n      console.log(`   - formula_name: ${newFormula.name || 'null'}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur lors de la mise \u00E0 jour des param\u00E8tres capacit\u00E9:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 8 : Mettre en cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    formulaCopyCache.set(originalFormulaId, newFormulaId);\r\n\r\n    console.log(`\\n${'\u2550'.repeat(80)}`);\r\n    console.log(`\u2705 COPIE FORMULE TERMIN\u00C9E`);\r\n    console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n    return {\r\n      newFormulaId,\r\n      nodeId: newNodeId,\r\n      tokens: rewrittenTokens,\r\n      success: true\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur lors de la copie de la formule:`, error);\r\n    return {\r\n      newFormulaId: '',\r\n      nodeId: '',\r\n      tokens: null,\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error)\r\n    };\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES POUR LINKED FIELDS\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Ajoute des IDs \u00E0 un champ linked... d'un n\u0153ud (sans doublons)\r\n */\r\nasync function addToNodeLinkedField(\r\n  prisma: PrismaClient,\r\n  nodeId: string,\r\n  field: 'linkedFormulaIds' | 'linkedConditionIds' | 'linkedTableIds' | 'linkedVariableIds',\r\n  idsToAdd: string[]\r\n): Promise<void> {\r\n  if (!idsToAdd || idsToAdd.length === 0) return;\r\n\r\n  const node = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { [field]: true }\r\n  });\r\n\r\n  if (!node) {\r\n    console.warn(`\u26A0\uFE0F N\u0153ud ${nodeId} introuvable pour MAJ ${field}`);\r\n    return;\r\n  }\r\n\r\n  const current = (node[field] || []) as string[];\r\n  const newIds = [...new Set([...current, ...idsToAdd])]; // D\u00E9dupliquer\r\n\r\n  await prisma.treeBranchLeafNode.update({\r\n    where: { id: nodeId },\r\n    data: { [field]: { set: newIds } }\r\n  });\r\n}\r\n", "/**\r\n * \uD83D\uDD00 Syst\u00E8me de copie des CONDITIONS\r\n * \r\n * Ce module g\u00E8re la copie compl\u00E8te d'une condition (TreeBranchLeafNodeCondition)\r\n * avec r\u00E9\u00E9criture du conditionSet pour pointer vers les nouveaux IDs.\r\n * \r\n * PRINCIPES :\r\n * -----------\r\n * 1. Copier la condition avec suffixe\r\n * 2. R\u00E9\u00E9crire le conditionSet (@value.ID \u2192 @value.ID-suffix)\r\n * 3. R\u00E9\u00E9crire les r\u00E9f\u00E9rences de formules (node-formula:ID \u2192 node-formula:ID-suffix)\r\n * 4. Mettre \u00E0 jour linkedConditionIds du n\u0153ud propri\u00E9taire\r\n * 5. Synchroniser les param\u00E8tres de capacit\u00E9 (hasCondition, condition_activeId, etc.)\r\n * \r\n * @author System TBL\r\n * @version 1.0.0\r\n */\r\n\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCB TYPES ET INTERFACES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Options pour la copie de condition\r\n */\r\nexport interface CopyConditionOptions {\r\n  /** Map des n\u0153uds copi\u00E9s (ancien ID \u2192 nouveau ID) pour r\u00E9\u00E9crire les @value.ID */\r\n  nodeIdMap?: Map<string, string>;\r\n  /** Map des formules copi\u00E9es (ancien ID \u2192 nouveau ID) pour r\u00E9\u00E9crire node-formula:ID */\r\n  formulaIdMap?: Map<string, string>;\r\n  /** Map des conditions d\u00E9j\u00E0 copi\u00E9es (cache pour \u00E9viter doublons) */\r\n  conditionCopyCache?: Map<string, string>;\r\n}\r\n\r\n/**\r\n * R\u00E9sultat de la copie d'une condition\r\n */\r\nexport interface CopyConditionResult {\r\n  /** ID de la condition copi\u00E9e */\r\n  newConditionId: string;\r\n  /** ID du n\u0153ud propri\u00E9taire */\r\n  nodeId: string;\r\n  /** conditionSet r\u00E9\u00E9crit */\r\n  conditionSet: Prisma.InputJsonValue;\r\n  /** Succ\u00E8s de l'op\u00E9ration */\r\n  success: boolean;\r\n  /** Message d'erreur \u00E9ventuel */\r\n  error?: string;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uFFFD FONCTIONS D'EXTRACTION D'IDs\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Extrait TOUS les IDs de n\u0153uds r\u00E9f\u00E9renc\u00E9s dans un conditionSet\r\n * (utilis\u00E9 pour les mises \u00E0 jour bidirectionnelles)\r\n * \r\n * @param conditionSet - conditionSet \u00E0 analyser\r\n * @returns Set des IDs de n\u0153uds trouv\u00E9s\r\n */\r\nfunction extractNodeIdsFromConditionSet(conditionSet: unknown): Set<string> {\r\n  const ids = new Set<string>();\r\n  if (!conditionSet || typeof conditionSet !== 'object') return ids;\r\n  \r\n  const obj = conditionSet as Record<string, unknown>;\r\n  const str = JSON.stringify(obj);\r\n  \r\n  // Extraire tous les @value.<id>\r\n  const uuidRegex = /@value\\.([a-f0-9-]{36})/gi;\r\n  let match;\r\n  while ((match = uuidRegex.exec(str)) !== null) {\r\n    ids.add(match[1]);\r\n  }\r\n  \r\n  // Extraire les node_xxx\r\n  const nodeRegex = /@value\\.(node_[a-z0-9_-]+)/gi;\r\n  while ((match = nodeRegex.exec(str)) !== null) {\r\n    ids.add(match[1]);\r\n  }\r\n  \r\n  return ids;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uFFFD\uD83D\uDD27 FONCTIONS UTILITAIRES DE R\u00C9\u00C9CRITURE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * R\u00E9\u00E9crire le conditionSet d'une condition pour remplacer les anciens IDs par les nouveaux\r\n * \r\n * Format du conditionSet :\r\n * - branches[].when.left/right.ref : \"@value.<nodeId>\"\r\n * - branches[].actions[].nodeIds : [\"node-xxx\", \"uuid-yyy\"]\r\n * - fallback.actions[].nodeIds\r\n * - R\u00E9f\u00E9rences de formules : \"node-formula:<formulaId>\"\r\n * \r\n * @param conditionSet - conditionSet original\r\n * @param nodeIdMap - Map ancien ID n\u0153ud \u2192 nouveau ID n\u0153ud\r\n * @param formulaIdMap - Map ancien ID formule \u2192 nouveau ID formule\r\n * @returns conditionSet r\u00E9\u00E9crit\r\n * \r\n * @example\r\n * rewriteConditionSet(\r\n *   { branches: [{ when: { left: { ref: \"@value.abc\" } } }] },\r\n *   new Map([[\"abc\", \"abc-1\"]]),\r\n *   new Map()\r\n * )\r\n * \u2192 { branches: [{ when: { left: { ref: \"@value.abc-1\" } } }] }\r\n */\r\nfunction rewriteConditionSet(\r\n  conditionSet: unknown,\r\n  nodeIdMap: Map<string, string>,\r\n  formulaIdMap: Map<string, string>,\r\n  suffix?: number\r\n): Prisma.InputJsonValue {\r\n  if (!conditionSet || typeof conditionSet !== 'object') {\r\n    return conditionSet as Prisma.InputJsonValue;\r\n  }\r\n\r\n  try {\r\n    // 0\uFE0F\u20E3 Travaux de r\u00E9\u00E9criture en deux passes: regex globaux puis parcours cibl\u00E9\r\n    let str = JSON.stringify(conditionSet);\r\n\r\n    // 1\uFE0F\u20E3 R\u00E9\u00E9crire les @value.<nodeId> (avec fallback suffix si non mapp\u00E9)\r\n    str = str.replace(/@value\\.([A-Za-z0-9_:-]+)/g, (_match, nodeId: string) => {\r\n      const mapped = nodeIdMap.get(nodeId);\r\n      if (mapped) return `@value.${mapped}`;\r\n      if (suffix !== undefined && !/-\\d+$/.test(nodeId)) return `@value.${nodeId}-${suffix}`;\r\n      return `@value.${nodeId}`;\r\n    });\r\n\r\n    // 2\uFE0F\u20E3 R\u00E9\u00E9crire les node-formula:<id> (IDs CUID/UUID support\u00E9s) avec fallback suffix\r\n    str = str.replace(/node-formula:([A-Za-z0-9_-]+)/g, (_match, formulaId: string) => {\r\n      const mapped = formulaIdMap.get(formulaId);\r\n      if (mapped) return `node-formula:${mapped}`;\r\n      if (suffix !== undefined && !/-\\d+$/.test(formulaId)) return `node-formula:${formulaId}-${suffix}`;\r\n      return `node-formula:${formulaId}`;\r\n    });\r\n\r\n    // 3\uFE0F\u20E3 R\u00E9\u00E9crire aussi d'\u00E9ventuels node-condition:/condition: en suffix fallback (pas de map d\u00E9di\u00E9e ici)\r\n    str = str.replace(/(node-condition:|condition:)([A-Za-z0-9_-]+)/g, (_m, pref: string, condId: string) => {\r\n      if (suffix !== undefined && !/-\\d+$/.test(condId)) return `${pref}${condId}-${suffix}`;\r\n      return `${pref}${condId}`;\r\n    });\r\n\r\n    // 4\uFE0F\u20E3 Parser pour traiter pr\u00E9cis\u00E9ment actions[].nodeIds (r\u00E9f\u00E9rences nues)\r\n    const parsed = JSON.parse(str);\r\n\r\n    const mapNodeIdString = (raw: string): string => {\r\n      if (typeof raw !== 'string') return raw as unknown as string;\r\n      // Cas 1: node-formula d\u00E9j\u00E0 couvert mais double s\u00E9curit\u00E9\r\n      if (raw.startsWith('node-formula:')) {\r\n        const id = raw.replace('node-formula:', '');\r\n        const mapped = formulaIdMap.get(id);\r\n        if (mapped) return `node-formula:${mapped}`;\r\n        return suffix !== undefined && !/-\\d+$/.test(id) ? `node-formula:${id}-${suffix}` : raw;\r\n      }\r\n      // Cas 2: field id (UUID ou node_...)\r\n      const uuidRegex = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;\r\n      const isNodeGen = /^node_[A-Za-z0-9_-]+$/i.test(raw);\r\n      if (uuidRegex.test(raw) || isNodeGen) {\r\n        const mapped = nodeIdMap.get(raw);\r\n        if (mapped) return mapped;\r\n        return suffix !== undefined && !/-\\d+$/.test(raw) ? `${raw}-${suffix}` : raw;\r\n      }\r\n      // Cas 3: condition ref en clair\r\n      if (raw.startsWith('node-condition:') || raw.startsWith('condition:')) {\r\n        const pref = raw.startsWith('node-condition:') ? 'node-condition:' : 'condition:';\r\n        const id = raw.replace('node-condition:', '').replace('condition:', '');\r\n        return suffix !== undefined && !/-\\d+$/.test(id) ? `${pref}${id}-${suffix}` : raw;\r\n      }\r\n      return raw;\r\n    };\r\n\r\n    const walk = (obj: any): any => {\r\n      if (!obj || typeof obj !== 'object') return obj;\r\n      if (Array.isArray(obj)) return obj.map(walk);\r\n      const out: any = Array.isArray(obj) ? [] : { ...obj };\r\n      for (const key of Object.keys(obj)) {\r\n        const val = obj[key];\r\n        if (key === 'nodeIds' && Array.isArray(val)) {\r\n          out[key] = val.map((s: any) => (typeof s === 'string' ? mapNodeIdString(s) : s));\r\n        } else if (key === 'when' && val && typeof val === 'object') {\r\n          // when.left.ref / when.right.ref d\u00E9j\u00E0 trait\u00E9s via regex, mais on parcourt par s\u00E9curit\u00E9\r\n          out[key] = walk(val);\r\n        } else {\r\n          out[key] = walk(val);\r\n        }\r\n      }\r\n      return out;\r\n    };\r\n\r\n    const rewritten = walk(parsed);\r\n    return rewritten as Prisma.InputJsonValue;\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur lors de la r\u00E9\u00E9criture du conditionSet:`, error);\r\n    return conditionSet as Prisma.InputJsonValue;\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD04 FONCTION PRINCIPALE DE COPIE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Copie une condition avec r\u00E9\u00E9criture du conditionSet\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. V\u00E9rifier le cache (\u00E9viter doublons)\r\n * 2. R\u00E9cup\u00E9rer la condition originale\r\n * 3. G\u00E9n\u00E9rer le nouvel ID avec suffixe\r\n * 4. R\u00E9\u00E9crire le conditionSet (@value.ID + node-formula:ID)\r\n * 5. Cr\u00E9er la nouvelle condition\r\n * 6. Mettre \u00E0 jour linkedConditionIds du n\u0153ud\r\n * 7. Synchroniser les param\u00E8tres de capacit\u00E9\r\n * 8. Mettre en cache\r\n * \r\n * @param originalConditionId - ID de la condition \u00E0 copier\r\n * @param newNodeId - ID du nouveau n\u0153ud propri\u00E9taire\r\n * @param suffix - Suffixe num\u00E9rique \u00E0 appliquer\r\n * @param prisma - Instance Prisma Client\r\n * @param options - Options avec nodeIdMap et formulaIdMap\r\n * @returns R\u00E9sultat de la copie\r\n * \r\n * @example\r\n * const result = await copyConditionCapacity(\r\n *   'condition-abc',\r\n *   'node-xyz-1',\r\n *   1,\r\n *   prisma,\r\n *   { \r\n *     nodeIdMap: new Map([['node-a', 'node-a-1']]),\r\n *     formulaIdMap: new Map([['formula-x', 'formula-x-1']])\r\n *   }\r\n * );\r\n * // result.newConditionId = 'condition-abc-1'\r\n * // result.conditionSet = { ... avec IDs r\u00E9\u00E9crits ... }\r\n */\r\nexport async function copyConditionCapacity(\r\n  originalConditionId: string,\r\n  newNodeId: string,\r\n  suffix: number,\r\n  prisma: PrismaClient,\r\n  options: CopyConditionOptions = {}\r\n): Promise<CopyConditionResult> {\r\n  \r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uD83D\uDD00 COPIE CONDITION: ${originalConditionId}`);\r\n  console.log(`   Suffixe: ${suffix}`);\r\n  console.log(`   Nouveau n\u0153ud: ${newNodeId}`);\r\n  console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n  const {\r\n    nodeIdMap = new Map(),\r\n    formulaIdMap = new Map(),\r\n    conditionCopyCache = new Map()\r\n  } = options;\r\n\r\n  try {\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD0D \u00C9TAPE 1 : V\u00E9rifier le cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    if (conditionCopyCache.has(originalConditionId)) {\r\n      const cachedId = conditionCopyCache.get(originalConditionId)!;\r\n      console.log(`\u267B\uFE0F Condition d\u00E9j\u00E0 copi\u00E9e (cache): ${originalConditionId} \u2192 ${cachedId}`);\r\n      \r\n      const cached = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n        where: { id: cachedId }\r\n      });\r\n      \r\n      if (cached) {\r\n        return {\r\n          newConditionId: cached.id,\r\n          nodeId: cached.nodeId,\r\n          conditionSet: cached.conditionSet,\r\n          success: true\r\n        };\r\n      }\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCE5 \u00C9TAPE 2 : R\u00E9cup\u00E9rer la condition originale PAR ID (enlever suffixe si pr\u00E9sent)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // originalConditionId peut contenir un suffixe si c'est d\u00E9j\u00E0 une copie\r\n    // On enl\u00E8ve le suffixe pour trouver l'original\r\n    const cleanConditionId = originalConditionId.replace(/-\\d+$/, '');\r\n    console.log(`\uD83D\uDD0D Recherche condition avec id: ${cleanConditionId} (original: ${originalConditionId})`);\r\n    \r\n    const originalCondition = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n      where: { id: cleanConditionId }\r\n    });\r\n\r\n    if (!originalCondition) {\r\n      console.error(`\u274C Condition introuvable avec id: ${cleanConditionId}`);\r\n      return {\r\n        newConditionId: '',\r\n        nodeId: '',\r\n        conditionSet: null,\r\n        success: false,\r\n        error: `Condition introuvable avec id: ${cleanConditionId}`\r\n      };\r\n    }\r\n\r\n    console.log(`\u2705 Condition trouv\u00E9e: ${originalCondition.name || originalCondition.id}`);\r\n    console.log(`   NodeId original: ${originalCondition.nodeId}`);\r\n    console.log(`   conditionSet original:`, originalCondition.conditionSet);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83C\uDD94 \u00C9TAPE 3 : G\u00E9n\u00E9rer le nouvel ID (pour la condition elle-m\u00EAme)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // On utilise l'id original de la condition avec suffixe\r\n    const newConditionId = `${originalCondition.id}-${suffix}`;\r\n    console.log(`\uD83D\uDCDD Nouvel ID condition: ${newConditionId}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD04 \u00C9TAPE 4 : R\u00E9\u00E9crire le conditionSet\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    console.log(`\\n\uD83D\uDD04 R\u00E9\u00E9criture du conditionSet...`);\r\n    console.log(`   Nombre d'IDs n\u0153uds dans la map: ${nodeIdMap.size}`);\r\n    console.log(`   Nombre d'IDs formules dans la map: ${formulaIdMap.size}`);\r\n    \r\n    const rewrittenConditionSet = rewriteConditionSet(\r\n      originalCondition.conditionSet,\r\n      nodeIdMap,\r\n      formulaIdMap,\r\n      suffix\r\n    );\r\n    \r\n    console.log(`\u2705 conditionSet r\u00E9\u00E9crit:`, rewrittenConditionSet);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCBE \u00C9TAPE 5 : Cr\u00E9er (ou mettre \u00E0 jour) la nouvelle condition \u2014 idempotent\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    let newCondition = await prisma.treeBranchLeafNodeCondition.findUnique({ where: { id: newConditionId } });\r\n    if (newCondition) {\r\n      // Mise \u00E0 jour minimale pour garder l'id stable entre r\u00E9-ex\u00E9cutions\r\n      newCondition = await prisma.treeBranchLeafNodeCondition.update({\r\n        where: { id: newConditionId },\r\n        data: {\r\n          nodeId: newNodeId,\r\n          name: originalCondition.name ? `${originalCondition.name}-${suffix}` : null,\r\n          description: originalCondition.description,\r\n          conditionSet: rewrittenConditionSet,\r\n          metadata: originalCondition.metadata as Prisma.InputJsonValue,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    } else {\r\n      newCondition = await prisma.treeBranchLeafNodeCondition.create({\r\n        data: {\r\n          id: newConditionId,\r\n          nodeId: newNodeId,\r\n          organizationId: originalCondition.organizationId,\r\n          name: originalCondition.name ? `${originalCondition.name}-${suffix}` : null,\r\n          description: originalCondition.description,\r\n          conditionSet: rewrittenConditionSet,\r\n          metadata: originalCondition.metadata as Prisma.InputJsonValue,\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(`\u2705 Condition cr\u00E9\u00E9e: ${newCondition.id}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 6 : Mettre \u00E0 jour linkedConditionIds du n\u0153ud\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      await addToNodeLinkedField(prisma, newNodeId, 'linkedConditionIds', [newConditionId]);\r\n      console.log(`\u2705 linkedConditionIds mis \u00E0 jour pour n\u0153ud ${newNodeId}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur MAJ linkedConditionIds:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uFFFD \u00C9TAPE 6B : MISES \u00C0 JOUR BIDIRECTIONNELLES (r\u00E9f\u00E9rences dans la condition)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    console.log(`\\n\uD83D\uDD00 Mises \u00E0 jour bidirectionnelles pour condition ${newConditionId}...`);\r\n    \r\n    try {\r\n      // Extraire les n\u0153uds r\u00E9f\u00E9renc\u00E9s dans la condition\r\n      const referencedNodeIds = extractNodeIdsFromConditionSet(rewrittenConditionSet);\r\n      console.log(`   N\u0153uds r\u00E9f\u00E9renc\u00E9s: ${referencedNodeIds.size} trouv\u00E9s`);\r\n      \r\n      for (const refNodeId of referencedNodeIds) {\r\n        if (refNodeId && refNodeId !== newNodeId) {\r\n          try {\r\n            await addToNodeLinkedField(prisma, refNodeId, 'linkedConditionIds', [newConditionId]);\r\n            console.log(`   \u2705 linkedConditionIds mis \u00E0 jour pour n\u0153ud r\u00E9f\u00E9renc\u00E9 ${refNodeId}`);\r\n          } catch (e) {\r\n            console.warn(`   \u26A0\uFE0F Impossible de MAJ n\u0153ud ${refNodeId}: ${(e as Error).message}`);\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur lors des mises \u00E0 jour bidirectionnelles:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uFFFD\uD83D\uDCDD \u00C9TAPE 7 : Synchroniser les param\u00E8tres de capacit\u00E9\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: newNodeId },\r\n        data: {\r\n          hasCondition: true,\r\n          condition_activeId: newConditionId,\r\n          condition_name: newCondition.name,\r\n          condition_description: newCondition.description\r\n        }\r\n      });\r\n      console.log(`\u2705 Param\u00E8tres capacit\u00E9 (condition) mis \u00E0 jour pour n\u0153ud ${newNodeId}`);\r\n      console.log(`   - condition_activeId: ${newConditionId}`);\r\n      console.log(`   - condition_name: ${newCondition.name || 'null'}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur lors de la mise \u00E0 jour des param\u00E8tres capacit\u00E9:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 8 : Mettre en cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    conditionCopyCache.set(originalConditionId, newConditionId);\r\n\r\n    console.log(`\\n${'\u2550'.repeat(80)}`);\r\n    console.log(`\u2705 COPIE CONDITION TERMIN\u00C9E`);\r\n    console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n    return {\r\n      newConditionId,\r\n      nodeId: newNodeId,\r\n      conditionSet: rewrittenConditionSet,\r\n      success: true\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur lors de la copie de la condition:`, error);\r\n    return {\r\n      newConditionId: '',\r\n      nodeId: '',\r\n      conditionSet: null,\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error)\r\n    };\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES POUR LINKED FIELDS\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Ajoute des IDs \u00E0 un champ linked... d'un n\u0153ud (sans doublons)\r\n */\r\nasync function addToNodeLinkedField(\r\n  prisma: PrismaClient,\r\n  nodeId: string,\r\n  field: 'linkedFormulaIds' | 'linkedConditionIds' | 'linkedTableIds' | 'linkedVariableIds',\r\n  idsToAdd: string[]\r\n): Promise<void> {\r\n  if (!idsToAdd || idsToAdd.length === 0) return;\r\n\r\n  const node = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { [field]: true }\r\n  });\r\n\r\n  if (!node) {\r\n    console.warn(`\u26A0\uFE0F N\u0153ud ${nodeId} introuvable pour MAJ ${field}`);\r\n    return;\r\n  }\r\n\r\n  const current = (node[field] || []) as string[];\r\n  const newIds = [...new Set([...current, ...idsToAdd])]; // D\u00E9dupliquer\r\n\r\n  await prisma.treeBranchLeafNode.update({\r\n    where: { id: nodeId },\r\n    data: { [field]: { set: newIds } }\r\n  });\r\n}\r\n", "/**\r\n * \uD83D\uDCCA Syst\u00E8me de copie des TABLES\r\n * \r\n * Ce module g\u00E8re la copie compl\u00E8te d'une table (TreeBranchLeafNodeTable)\r\n * avec toutes ses sous-entit\u00E9s : colonnes, lignes et cellules.\r\n * \r\n * PRINCIPES :\r\n * -----------\r\n * 1. Copier la table principale avec suffixe\r\n * 2. Copier toutes les colonnes (TreeBranchLeafNodeTableColumn)\r\n * 3. Copier toutes les lignes (TreeBranchLeafNodeTableRow)\r\n * 4. Copier toutes les cellules (TreeBranchLeafNodeTableCell)\r\n * 5. R\u00E9\u00E9crire les IDs dans les configs JSON\r\n * 6. Mettre \u00E0 jour linkedTableIds du n\u0153ud propri\u00E9taire\r\n * 7. Synchroniser les param\u00E8tres de capacit\u00E9 (hasTable, table_activeId, etc.)\r\n * \r\n * @author System TBL\r\n * @version 1.0.0\r\n */\r\n\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCB TYPES ET INTERFACES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Options pour la copie de table\r\n */\r\nexport interface CopyTableOptions {\r\n  /** Map des n\u0153uds copi\u00E9s (ancien ID \u2192 nouveau ID) pour r\u00E9\u00E9crire les configs */\r\n  nodeIdMap?: Map<string, string>;\r\n  /** Map des tables d\u00E9j\u00E0 copi\u00E9es (cache pour \u00E9viter doublons) */\r\n  tableCopyCache?: Map<string, string>;\r\n  /** Map des tables copi\u00E9es (ancien ID \u2192 nouveau ID) pour remapper table_instances */\r\n  tableIdMap?: Map<string, string>;\r\n}\r\n\r\n/**\r\n * R\u00E9sultat de la copie d'une table\r\n */\r\nexport interface CopyTableResult {\r\n  /** ID de la table copi\u00E9e */\r\n  newTableId: string;\r\n  /** ID du n\u0153ud propri\u00E9taire */\r\n  nodeId: string;\r\n  /** Nombre de colonnes copi\u00E9es */\r\n  columnsCount: number;\r\n  /** Nombre de lignes copi\u00E9es */\r\n  rowsCount: number;\r\n  /** Nombre de cellules copi\u00E9es */\r\n  cellsCount: number;\r\n  /** Succ\u00E8s de l'op\u00E9ration */\r\n  success: boolean;\r\n  /** Message d'erreur \u00E9ventuel */\r\n  error?: string;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES DE R\u00C9\u00C9CRITURE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * R\u00E9\u00E9crire les IDs dans un objet JSON (configs de colonnes/cellules)\r\n * G\u00E8re :\r\n * - UUIDs: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\r\n * - node_xxx : r\u00E9f\u00E9rences g\u00E9n\u00E9r\u00E9es\r\n * - @value.ID : r\u00E9f\u00E9rences de champs\r\n * - node-formula:ID : r\u00E9f\u00E9rences de formules\r\n * \r\n * @param obj - Objet \u00E0 r\u00E9\u00E9crire\r\n * @param idMap - Map ancien ID \u2192 nouveau ID\r\n * @param suffix - Suffixe \u00E0 appliquer si ID non mapp\u00E9\r\n * @returns Objet r\u00E9\u00E9crit\r\n */\r\nfunction rewriteIdsInJson(\r\n  obj: unknown,\r\n  idMap: Map<string, string>,\r\n  suffix?: number\r\n): Prisma.InputJsonValue {\r\n  if (!obj) return obj as Prisma.InputJsonValue;\r\n\r\n  try {\r\n    let str = JSON.stringify(obj);\r\n    \r\n    // 1\uFE0F\u20E3 R\u00E9\u00E9crire les @value.<nodeId> (r\u00E9f\u00E9rences de champs)\r\n    str = str.replace(/@value\\.([A-Za-z0-9_:-]+)/g, (_match, nodeId: string) => {\r\n      const mapped = idMap.get(nodeId);\r\n      if (mapped) return `@value.${mapped}`;\r\n      if (suffix !== undefined && !/-\\d+$/.test(nodeId)) return `@value.${nodeId}-${suffix}`;\r\n      return `@value.${nodeId}`;\r\n    });\r\n    \r\n    // 2\uFE0F\u20E3 R\u00E9\u00E9crire les node-formula:<id> (r\u00E9f\u00E9rences de formules)\r\n    str = str.replace(/node-formula:([A-Za-z0-9_-]+)/g, (_match, formulaId: string) => {\r\n      const mapped = idMap.get(formulaId);\r\n      if (mapped) return `node-formula:${mapped}`;\r\n      if (suffix !== undefined && !/-\\d+$/.test(formulaId)) return `node-formula:${formulaId}-${suffix}`;\r\n      return `node-formula:${formulaId}`;\r\n    });\r\n\r\n    // 3\uFE0F\u20E3 R\u00E9\u00E9crire les UUIDs (r\u00E9f\u00E9rences de n\u0153uds)\r\n    str = str.replace(/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/gi, (uuid: string) => {\r\n      const mapped = idMap.get(uuid);\r\n      if (mapped) return mapped;\r\n      if (suffix !== undefined && !/-\\d+$/.test(uuid)) return `${uuid}-${suffix}`;\r\n      return uuid;\r\n    });\r\n    \r\n    // 4\uFE0F\u20E3 R\u00E9\u00E9crire les node_xxx (r\u00E9f\u00E9rences g\u00E9n\u00E9r\u00E9es)\r\n    str = str.replace(/(node_[a-z0-9_-]+)/gi, (id: string) => {\r\n      const mapped = idMap.get(id);\r\n      if (mapped) return mapped;\r\n      if (suffix !== undefined && !/-\\d+$/.test(id)) return `${id}-${suffix}`;\r\n      return id;\r\n    });\r\n    \r\n    return JSON.parse(str) as Prisma.InputJsonValue;\r\n  } catch {\r\n    return obj as Prisma.InputJsonValue;\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD04 FONCTION PRINCIPALE DE COPIE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Copie une table avec toutes ses colonnes, lignes et cellules\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. V\u00E9rifier le cache (\u00E9viter doublons)\r\n * 2. R\u00E9cup\u00E9rer la table originale + colonnes + lignes + cellules\r\n * 3. G\u00E9n\u00E9rer les nouveaux IDs avec suffixe\r\n * 4. Cr\u00E9er la nouvelle table\r\n * 5. Copier toutes les colonnes\r\n * 6. Copier toutes les lignes\r\n * 7. Copier toutes les cellules\r\n * 8. Mettre \u00E0 jour linkedTableIds du n\u0153ud\r\n * 9. Synchroniser les param\u00E8tres de capacit\u00E9\r\n * 10. Mettre en cache\r\n * \r\n * @param originalTableId - ID de la table \u00E0 copier\r\n * @param newNodeId - ID du nouveau n\u0153ud propri\u00E9taire\r\n * @param suffix - Suffixe num\u00E9rique \u00E0 appliquer\r\n * @param prisma - Instance Prisma Client\r\n * @param options - Options avec nodeIdMap\r\n * @returns R\u00E9sultat de la copie\r\n * \r\n * @example\r\n * const result = await copyTableCapacity(\r\n *   'table-abc',\r\n *   'node-xyz-1',\r\n *   1,\r\n *   prisma,\r\n *   { nodeIdMap: new Map([['node-a', 'node-a-1']]) }\r\n * );\r\n * // result.newTableId = 'table-abc-1'\r\n * // result.columnsCount = 3\r\n * // result.rowsCount = 5\r\n * // result.cellsCount = 15\r\n */\r\nexport async function copyTableCapacity(\r\n  originalTableId: string,\r\n  newNodeId: string,\r\n  suffix: number,\r\n  prisma: PrismaClient,\r\n  options: CopyTableOptions = {}\r\n): Promise<CopyTableResult> {\r\n  \r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uD83D\uDCCA COPIE TABLE: ${originalTableId}`);\r\n  console.log(`   Suffixe: ${suffix}`);\r\n  console.log(`   Nouveau n\u0153ud: ${newNodeId}`);\r\n  console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n  const {\r\n    nodeIdMap = new Map(),\r\n    tableCopyCache = new Map(),\r\n    tableIdMap = new Map()\r\n  } = options;\r\n\r\n  try {\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD0D \u00C9TAPE 1 : V\u00E9rifier le cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    if (tableCopyCache.has(originalTableId)) {\r\n      const cachedId = tableCopyCache.get(originalTableId)!;\r\n      console.log(`\u267B\uFE0F Table d\u00E9j\u00E0 copi\u00E9e (cache): ${originalTableId} \u2192 ${cachedId}`);\r\n      \r\n      const cached = await prisma.treeBranchLeafNodeTable.findUnique({\r\n        where: { id: cachedId },\r\n        include: {\r\n          tableColumns: true,\r\n          tableRows: true\r\n        }\r\n      });\r\n      \r\n      if (cached) {\r\n        // Compter le total des cellules depuis les rows\r\n        let totalCells = 0;\r\n        for (const row of cached.tableRows) {\r\n          const cells = (row.cells as any) || [];\r\n          totalCells += Array.isArray(cells) ? cells.length : Object.keys(cells).length;\r\n        }\r\n        \r\n        return {\r\n          newTableId: cached.id,\r\n          nodeId: cached.nodeId,\r\n          columnsCount: cached.tableColumns.length,\r\n          rowsCount: cached.tableRows.length,\r\n          cellsCount: totalCells,\r\n          success: true\r\n        };\r\n      }\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCE5 \u00C9TAPE 2 : R\u00E9cup\u00E9rer la table originale PAR ID (enlever suffixe si pr\u00E9sent) + sous-entit\u00E9s\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // originalTableId peut contenir un suffixe si c'est d\u00E9j\u00E0 une copie\r\n    // On enl\u00E8ve le suffixe pour trouver l'original\r\n    const cleanTableId = originalTableId.replace(/-\\d+$/, '');\r\n    console.log(`\uD83D\uDD0D Recherche table avec id: ${cleanTableId} (original: ${originalTableId})`);\r\n    \r\n    const originalTable = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id: cleanTableId },\r\n      include: {\r\n        tableColumns: { orderBy: { columnIndex: 'asc' } },\r\n        tableRows: { orderBy: { rowIndex: 'asc' } }\r\n      }\r\n    });\r\n\r\n    if (!originalTable) {\r\n      console.error(`\u274C Table introuvable avec id: ${cleanTableId}`);\r\n      return {\r\n        newTableId: '',\r\n        nodeId: '',\r\n        columnsCount: 0,\r\n        rowsCount: 0,\r\n        cellsCount: 0,\r\n        success: false,\r\n        error: `Table introuvable avec id: ${cleanTableId}`\r\n      };\r\n    }\r\n\r\n    console.log(`\u2705 Table trouv\u00E9e: ${originalTable.name || originalTable.id}`);\r\n    console.log(`   NodeId original: ${originalTable.nodeId}`);\r\n    console.log(`   Colonnes: ${originalTable.tableColumns.length}`);\r\n    console.log(`   Lignes: ${originalTable.tableRows.length}`);\r\n    \r\n    // Compter le total des cellules depuis les rows\r\n    let originalTotalCells = 0;\r\n    for (const row of originalTable.tableRows) {\r\n      const cells = (row.cells as any) || [];\r\n      originalTotalCells += Array.isArray(cells) ? cells.length : Object.keys(cells).length;\r\n    }\r\n    console.log(`   Cellules (total): ${originalTotalCells}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83C\uDD94 \u00C9TAPE 3 : G\u00E9n\u00E9rer les nouveaux IDs (pour la table elle-m\u00EAme)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // On utilise l'id original de la table avec suffixe\r\n    const newTableId = `${originalTable.id}-${suffix}`;\r\n    console.log(`\uD83D\uDCDD Nouvel ID table: ${newTableId}`);\r\n\r\n    // Maps pour les sous-entit\u00E9s (colonne/ligne/cellule)\r\n    const columnIdMap = new Map<string, string>();\r\n    const rowIdMap = new Map<string, string>();\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCBE \u00C9TAPE 4 : Cr\u00E9er (ou mettre \u00E0 jour) la nouvelle table \u2014 idempotent\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    let newTable = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id: newTableId } });\r\n    if (newTable) {\r\n      newTable = await prisma.treeBranchLeafNodeTable.update({\r\n        where: { id: newTableId },\r\n        data: {\r\n          nodeId: newNodeId,\r\n          name: originalTable.name ? `${originalTable.name}-${suffix}` : null,\r\n          description: originalTable.description,\r\n          type: originalTable.type,\r\n          meta: rewriteIdsInJson(originalTable.meta, nodeIdMap, suffix),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    } else {\r\n      newTable = await prisma.treeBranchLeafNodeTable.create({\r\n        data: {\r\n          id: newTableId,\r\n          nodeId: newNodeId,\r\n          organizationId: originalTable.organizationId,\r\n          name: originalTable.name ? `${originalTable.name}-${suffix}` : null,\r\n          description: originalTable.description,\r\n          type: originalTable.type,\r\n          meta: rewriteIdsInJson(originalTable.meta, nodeIdMap),\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(`\u2705 Table cr\u00E9\u00E9e: ${newTable.id}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCCB \u00C9TAPE 5 : Copier toutes les colonnes (EXACT comme copy-table-final.cjs)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    console.log(`\\n\uD83D\uDCCB Copie de ${originalTable.tableColumns.length} colonnes...`);\r\n    \r\n    // Utiliser une query brute pour obtenir les colonnes (m\u00EAme pattern que le script)\r\n    // \u26A0\uFE0F NE PAS copier config - juste les champs de base !\r\n    const originalColumnsRaw = await prisma.$queryRaw<any[]>`\r\n      SELECT \"id\", \"tableId\", \"columnIndex\", \"name\", \"type\", \"width\", \"format\", \"metadata\"\r\n      FROM \"TreeBranchLeafNodeTableColumn\"\r\n      WHERE \"tableId\" = ${originalTable.id}\r\n      ORDER BY \"columnIndex\" ASC\r\n    `;\r\n\r\n    let columnsCount = 0;\r\n    for (const col of originalColumnsRaw) {\r\n      try {\r\n        // G\u00E9n\u00E9rer un ID unique (pas de suffixe)\r\n        const newColumnId = `${Math.random().toString(36).substring(2, 15)}${Math.random().toString(36).substring(2, 15)}`;\r\n        columnIdMap.set(col.id, newColumnId);\r\n\r\n        // Cr\u00E9er directement - SANS r\u00E9\u00E9crire le metadata/config (comme le script)\r\n        await prisma.treeBranchLeafNodeTableColumn.create({\r\n          data: {\r\n            id: newColumnId,\r\n            tableId: newTableId,\r\n            columnIndex: col.columnIndex,\r\n            name: col.name,\r\n            type: col.type || 'text',\r\n            width: col.width,\r\n            format: col.format,\r\n            metadata: col.metadata  // Copie brute, pas de r\u00E9\u00E9criture\r\n          }\r\n        });\r\n\r\n        columnsCount++;\r\n        console.log(`  \u2713 [${col.columnIndex}] \"${col.name}\" \u2192 ${newColumnId}`);\r\n      } catch (e) {\r\n        console.warn(`  \u26A0\uFE0F [${col.columnIndex}] Erreur: ${(e as Error).message.split('\\n')[0].substring(0, 80)}`);\r\n      }\r\n    }\r\n\r\n    console.log(`\u2705 ${columnsCount} colonnes copi\u00E9es`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCC4 \u00C9TAPE 6 : Copier toutes les lignes (EXACT comme copy-table-final.cjs)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    console.log(`\\n\uD83D\uDCC4 Copie de ${originalTable.tableRows.length} lignes...`);\r\n    \r\n    // Utiliser une query brute pour obtenir les lignes (m\u00EAme pattern que le script)\r\n    // \u26A0\uFE0F NE PAS copier metadata - juste les cells !\r\n    const originalRowsRaw = await prisma.$queryRaw<any[]>`\r\n      SELECT \"id\", \"tableId\", \"rowIndex\", \"cells\"\r\n      FROM \"TreeBranchLeafNodeTableRow\"\r\n      WHERE \"tableId\" = ${originalTable.id}\r\n      ORDER BY \"rowIndex\" ASC\r\n    `;\r\n\r\n    let rowsCount = 0;\r\n    for (const row of originalRowsRaw) {\r\n      try {\r\n        // G\u00E9n\u00E9rer un ID unique (pas de suffixe)\r\n        const newRowId = `${Math.random().toString(36).substring(2, 15)}${Math.random().toString(36).substring(2, 15)}`;\r\n        rowIdMap.set(row.id, newRowId);\r\n\r\n        // Cr\u00E9er directement - SANS r\u00E9\u00E9crire les cells (comme le script)\r\n        await prisma.treeBranchLeafNodeTableRow.create({\r\n          data: {\r\n            id: newRowId,\r\n            tableId: newTableId,\r\n            rowIndex: row.rowIndex,\r\n            cells: row.cells  // Copie brute, pas de r\u00E9\u00E9criture\r\n          }\r\n        });\r\n\r\n        rowsCount++;\r\n        if (rowsCount % 5 === 0) {\r\n          console.log(`  \u2713 ${rowsCount}/${originalRowsRaw.length} lignes copi\u00E9es...`);\r\n        }\r\n      } catch (e) {\r\n        console.warn(`  \u26A0\uFE0F [${row.rowIndex}] Erreur: ${(e as Error).message.split('\\n')[0].substring(0, 80)}`);\r\n      }\r\n    }\r\n\r\n    console.log(`\u2705 ${rowsCount} lignes copi\u00E9es`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD22 \u00C9TAPE 7 : Mettre \u00E0 jour les m\u00E9tadonn\u00E9es rowCount et columnCount\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    await prisma.treeBranchLeafNodeTable.update({\r\n      where: { id: newTableId },\r\n      data: {\r\n        rowCount: rowsCount,\r\n        columnCount: columnsCount,\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`\u2705 M\u00E9tadonn\u00E9es mises \u00E0 jour:`);\r\n    console.log(`   - rowCount: ${rowsCount}`);\r\n    console.log(`   - columnCount: ${columnsCount}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 8 : Mettre \u00E0 jour linkedTableIds du n\u0153ud\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      await addToNodeLinkedField(prisma, newNodeId, 'linkedTableIds', [newTableId]);\r\n      console.log(`\u2705 linkedTableIds mis \u00E0 jour pour n\u0153ud ${newNodeId}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur MAJ linkedTableIds:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCDD \u00C9TAPE 9 : Synchroniser les param\u00E8tres de capacit\u00E9 + copier table_instances\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      // R\u00E9cup\u00E9rer le n\u0153ud original pour copier table_instances\r\n      const originalNode = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: originalTable.nodeId },\r\n        select: {\r\n          table_activeId: true,\r\n          table_instances: true\r\n        }\r\n      });\r\n\r\n      console.log(`\uD83D\uDD0D N\u0153ud original trouv\u00E9, r\u00E9cup\u00E9ration table_instances...`);\r\n      console.log(`   - table_activeId original: ${originalNode?.table_activeId}`);\r\n      console.log(`   - table_instances:`, originalNode?.table_instances ? Object.keys(originalNode.table_instances as any).length + ' cl\u00E9s' : 'null');\r\n\r\n      // Copier table_instances en remappant les cl\u00E9s (ancien tableId \u2192 nouveau tableId)\r\n      let newTableInstances: Record<string, any> = {};\r\n      if (originalNode?.table_instances && typeof originalNode.table_instances === 'object') {\r\n        const originalInstances = originalNode.table_instances as Record<string, any>;\r\n        \r\n        for (const [tableId, config] of Object.entries(originalInstances)) {\r\n          // Remapper l'ID de la table\r\n          const mappedTableId = tableIdMap.has(tableId) ? tableIdMap.get(tableId)! : `${tableId}-${suffix}`;\r\n          \r\n          // Remapper les IDs dans la config (au cas o\u00F9 il y aurait des r\u00E9f\u00E9rences)\r\n          const remappedConfig = rewriteIdsInJson(config, nodeIdMap, suffix);\r\n          \r\n          newTableInstances[mappedTableId] = remappedConfig;\r\n          console.log(`   \uD83D\uDCCB Instance remapp\u00E9e: ${tableId} \u2192 ${mappedTableId}`);\r\n        }\r\n      }\r\n\r\n      // D\u00E9terminer la nouvelle table_activeId\r\n      const oldActiveId = originalNode?.table_activeId;\r\n      let newActiveId = newTableId; // Par d\u00E9faut, la nouvelle table devient active\r\n      \r\n      if (oldActiveId && tableIdMap.has(oldActiveId)) {\r\n        newActiveId = tableIdMap.get(oldActiveId)!;\r\n        console.log(`   \uD83D\uDD04 table_activeId remapp\u00E9e: ${oldActiveId} \u2192 ${newActiveId}`);\r\n      } else if (oldActiveId) {\r\n        newActiveId = `${oldActiveId}-${suffix}`;\r\n      }\r\n\r\n      // Ajouter la nouvelle table aux instances si pas d\u00E9j\u00E0 l\u00E0\r\n      if (!newTableInstances[newTableId]) {\r\n        newTableInstances[newTableId] = {};\r\n        console.log(`   \u2705 Instance ajout\u00E9e pour nouvelle table: ${newTableId}`);\r\n      }\r\n\r\n      // Mettre \u00E0 jour le n\u0153ud copi\u00E9 avec tous les param\u00E8tres\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: newNodeId },\r\n        data: {\r\n          hasTable: true,\r\n          table_activeId: newTableId,  // \u2705 La nouvelle table est l'active\r\n          table_instances: newTableInstances as any,  // \u2705 Copi\u00E9 et remapp\u00E9\r\n          table_name: newTable.name,\r\n          table_description: newTable.description,\r\n          table_type: newTable.type\r\n        }\r\n      });\r\n      console.log(`\u2705 Param\u00E8tres capacit\u00E9 (table) mis \u00E0 jour pour n\u0153ud ${newNodeId}`);\r\n      console.log(`   - table_activeId: ${newTableId}`);\r\n      console.log(`   - table_instances: ${Object.keys(newTableInstances).length} cl\u00E9(s) copi\u00E9e(s)`);\r\n      console.log(`   - table_name: ${newTable.name || 'null'}`);\r\n      console.log(`   - table_type: ${newTable.type || 'null'}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur lors de la mise \u00E0 jour des param\u00E8tres capacit\u00E9:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83C\uDFAF \u00C9TAPE 10 (NOUVELLE) : Mettre \u00E0 jour table_activeId + table_instances sur les n\u0153uds selectors\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    console.log(`\\n${'\u2550'.repeat(80)}`);\r\n    console.log(`\uD83C\uDFAF \u00C9TAPE 10: Activation des selectors avec lookup`);\r\n    console.log(`${'\u2550'.repeat(80)}`);\r\n    // Selectors mis \u00E0 jour automatiquement via \u00C9TAPE 9\r\n    console.log(`\u2705 \u00C9TAPE 10: Selectors mis \u00E0 jour via l'\u00C9TAPE 9`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 11 : Mettre en cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    tableCopyCache.set(originalTableId, newTableId);\r\n\r\n    console.log(`\\n${'\u2550'.repeat(80)}`);\r\n    console.log(`\u2705 COPIE TABLE TERMIN\u00C9E`);\r\n    console.log(`   \uD83D\uDCCA Table: ${newTableId}`);\r\n    console.log(`   \uD83D\uDCCB Colonnes: ${originalTable.tableColumns.length}`);\r\n    console.log(`   \uD83D\uDCC4 Lignes: ${originalTable.tableRows.length}`);\r\n    console.log(`   \uD83D\uDD22 Cellules: ${cellsCopied}`);\r\n    console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n    return {\r\n      newTableId,\r\n      nodeId: newNodeId,\r\n      columnsCount: originalTable.tableColumns.length,\r\n      rowsCount: originalTable.tableRows.length,\r\n      cellsCount: cellsCopied,\r\n      success: true\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur lors de la copie de la table:`, error);\r\n    return {\r\n      newTableId: '',\r\n      nodeId: '',\r\n      columnsCount: 0,\r\n      rowsCount: 0,\r\n      cellsCount: 0,\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error)\r\n    };\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES POUR LINKED FIELDS\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Ajoute des IDs \u00E0 un champ linked... d'un n\u0153ud (sans doublons)\r\n */\r\nasync function addToNodeLinkedField(\r\n  prisma: PrismaClient,\r\n  nodeId: string,\r\n  field: 'linkedFormulaIds' | 'linkedConditionIds' | 'linkedTableIds' | 'linkedVariableIds',\r\n  idsToAdd: string[]\r\n): Promise<void> {\r\n  if (!idsToAdd || idsToAdd.length === 0) return;\r\n\r\n  const node = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { [field]: true }\r\n  });\r\n\r\n  if (!node) {\r\n    console.warn(`\u26A0\uFE0F N\u0153ud ${nodeId} introuvable pour MAJ ${field}`);\r\n    return;\r\n  }\r\n\r\n  const current = (node[field] || []) as string[];\r\n  const newIds = [...new Set([...current, ...idsToAdd])]; // D\u00E9dupliquer\r\n\r\n  await prisma.treeBranchLeafNode.update({\r\n    where: { id: nodeId },\r\n    data: { [field]: { set: newIds } }\r\n  });\r\n}\r\n", "\uFEFF/**\r\n * \uD83D\uDD27 Syst\u00E8me de copie des variables avec leurs capacit\u00E9s\r\n * \r\n * Ce module g\u00E8re la copie compl\u00E8te des variables (TreeBranchLeafNodeVariable)\r\n * et de leurs capacit\u00E9s associ\u00E9es (formules, conditions, tables).\r\n * \r\n * PRINCIPES :\r\n * -----------\r\n * 1. Une variable peut avoir une \"capacit\u00E9\" d\u00E9finie par sourceType + sourceRef\r\n * 2. Les formats de sourceRef sont :\r\n *    - \"node-formula:ID\" \u2192 Formule\r\n *    - \"condition:ID\" ou \"node-condition:ID\" \u2192 Condition\r\n *    - \"@table.ID\" ou \"node-table:ID\" \u2192 Table\r\n *    - UUID simple \u2192 Champ (field)\r\n * 3. Lors de la copie, on applique un suffixe sur TOUS les IDs\r\n * 4. Les r\u00E9f\u00E9rences sont mises \u00E0 jour pour pointer vers les capacit\u00E9s copi\u00E9es\r\n * 5. Les colonnes linked... sont synchronis\u00E9es dans les deux sens\r\n * \r\n * \u26A0\uFE0F PI\u00C8GE CRITIQUE (D\u00E9j\u00E0 cass\u00E9 par le pass\u00E9):\r\n * ------------------------------------------------\r\n * La variable newSourceRef DOIT \u00EAtre MUTABLE (let) car elle est r\u00E9assign\u00E9e\r\n * dans plusieurs branches (condition/table/field) lors de la copie.\r\n * Si on la repasse en const, la cr\u00E9ation plantera au runtime (reassignation d'un const)\r\n * et la variable ne sera PAS cr\u00E9\u00E9e. Ne pas modifier \"let newSourceRef\" en const.\r\n * \r\n * @author System TBL\r\n * @version 1.0.0\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD17 IMPORTS DES MODULES DE COPIE DE CAPACIT\u00C9S\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\nimport { copyFormulaCapacity } from './copy-capacity-formula.js';\r\nimport { copyConditionCapacity } from './copy-capacity-condition.js';\r\nimport { copyTableCapacity } from './copy-capacity-table.js';\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDCCB TYPES ET INTERFACES\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * R\u00E9sultat d'un parsing de sourceRef\r\n */\r\nexport interface ParsedSourceRef {\r\n  /** Type de r\u00E9f\u00E9rence : 'formula', 'condition', 'table', 'field' */\r\n  type: 'formula' | 'condition' | 'table' | 'field';\r\n  /** ID extrait (sans pr\u00E9fixe) */\r\n  id: string;\r\n  /** Pr\u00E9fixe original pour reconstruction */\r\n  prefix: string;\r\n}\r\n\r\n/**\r\n * R\u00E9sultat de la copie d'une variable\r\n */\r\nexport interface CopyVariableResult {\r\n  /** ID de la variable copi\u00E9e */\r\n  variableId: string;\r\n  /** Nouvelle exposedKey */\r\n  exposedKey: string;\r\n  /** Type de capacit\u00E9 copi\u00E9e (null si fixe) */\r\n  capacityType: 'formula' | 'condition' | 'table' | 'field' | null;\r\n  /** Nouveau sourceRef */\r\n  sourceRef: string | null;\r\n  /** Succ\u00E8s de l'op\u00E9ration */\r\n  success: boolean;\r\n  /** Message d'erreur \u00E9ventuel */\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Options pour la copie de variable\r\n */\r\nexport interface CopyVariableOptions {\r\n  /** Maps des IDs de formules copi\u00E9es (ancien ID \u2192 nouveau ID) */\r\n  formulaIdMap?: Map<string, string>;\r\n  /** Maps des IDs de conditions copi\u00E9es (ancien ID \u2192 nouveau ID) */\r\n  conditionIdMap?: Map<string, string>;\r\n  /** Maps des IDs de tables copi\u00E9es (ancien ID \u2192 nouveau ID) */\r\n  tableIdMap?: Map<string, string>;\r\n  /** Map globale des n\u0153uds copi\u00E9s (ancien ID \u2192 nouveau ID) */\r\n  nodeIdMap?: Map<string, string>;\r\n  /** Cache des variables d\u00E9j\u00E0 copi\u00E9es pour \u00E9viter doublons */\r\n  variableCopyCache?: Map<string, string>;\r\n  /** Cr\u00E9er automatiquement un n\u0153ud d'affichage dans \"Nouveau Section\" */\r\n  autoCreateDisplayNode?: boolean;\r\n  /** Libell\u00E9 de la section cible pour l'affichage (par d\u00E9faut: \"Nouveau Section\") */\r\n  displaySectionLabel?: string;\r\n  /** Lier la variable copi\u00E9e \u00E0 la section d'affichage (sans cr\u00E9er de n\u0153ud/variable) */\r\n  linkToDisplaySection?: boolean;\r\n  /** \u26A0\uFE0F CRITIQUE: Est-ce que le n\u0153ud d'affichage EST D\u00C9J\u00C0 CR\u00C9\u00C9 par deepCopyNodeInternal ? */\r\n  displayNodeAlreadyCreated?: boolean;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES DE PARSING\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Parse un sourceRef pour extraire le type et l'ID\r\n * \r\n * @param sourceRef - R\u00E9f\u00E9rence \u00E0 parser\r\n * @returns Objet avec type, id et prefix\r\n * \r\n * @example\r\n * parseSourceRef(\"node-formula:abc123\") \r\n * \u2192 { type: 'formula', id: 'abc123', prefix: 'node-formula:' }\r\n * \r\n * parseSourceRef(\"condition:def456\")\r\n * \u2192 { type: 'condition', id: 'def456', prefix: 'condition:' }\r\n * \r\n * parseSourceRef(\"@table.ghi789\")\r\n * \u2192 { type: 'table', id: 'ghi789', prefix: '@table.' }\r\n * \r\n * parseSourceRef(\"702d1b09-abc9-4096-9aaa-77155ac5294f\")\r\n * \u2192 { type: 'field', id: '702d1b09...', prefix: '' }\r\n */\r\nexport function parseSourceRef(sourceRef: string | null | undefined): ParsedSourceRef | null {\r\n  if (!sourceRef || typeof sourceRef !== 'string') return null;\r\n\r\n  const cleaned = sourceRef.trim();\r\n  if (!cleaned) return null;\r\n\r\n  // \uD83E\uDDEE Formule\r\n  if (cleaned.startsWith('node-formula:')) {\r\n    return {\r\n      type: 'formula',\r\n      id: cleaned.replace('node-formula:', ''),\r\n      prefix: 'node-formula:'\r\n    };\r\n  }\r\n\r\n  // \uD83D\uDD00 Condition\r\n  if (cleaned.startsWith('condition:')) {\r\n    return {\r\n      type: 'condition',\r\n      id: cleaned.replace('condition:', ''),\r\n      prefix: 'condition:'\r\n    };\r\n  }\r\n\r\n  if (cleaned.startsWith('node-condition:')) {\r\n    return {\r\n      type: 'condition',\r\n      id: cleaned.replace('node-condition:', ''),\r\n      prefix: 'node-condition:'\r\n    };\r\n  }\r\n\r\n  // \uD83D\uDCCA Table\r\n  if (cleaned.startsWith('@table.')) {\r\n    return {\r\n      type: 'table',\r\n      id: cleaned.replace('@table.', ''),\r\n      prefix: '@table.'\r\n    };\r\n  }\r\n\r\n  if (cleaned.startsWith('node-table:')) {\r\n    return {\r\n      type: 'table',\r\n      id: cleaned.replace('node-table:', ''),\r\n      prefix: 'node-table:'\r\n    };\r\n  }\r\n\r\n  // \uD83D\uDCDD Champ (UUID ou node_xxx)\r\n  return {\r\n    type: 'field',\r\n    id: cleaned,\r\n    prefix: ''\r\n  };\r\n}\r\n\r\n/**\r\n * Applique un suffixe \u00E0 un sourceRef\r\n * \r\n * @param sourceRef - R\u00E9f\u00E9rence originale\r\n * @param suffix - Suffixe num\u00E9rique \u00E0 appliquer\r\n * @returns sourceRef avec suffixe appliqu\u00E9\r\n * \r\n * @example\r\n * applySuffixToSourceRef(\"node-formula:abc123\", 1)\r\n * \u2192 \"node-formula:abc123-1\"\r\n * \r\n * applySuffixToSourceRef(\"@table.def456\", 2)\r\n * \u2192 \"@table.def456-2\"\r\n */\r\nexport function applySuffixToSourceRef(\r\n  sourceRef: string | null | undefined,\r\n  suffix: number\r\n): string | null {\r\n  if (!sourceRef) return null;\r\n\r\n  const parsed = parseSourceRef(sourceRef);\r\n  if (!parsed) return sourceRef;\r\n\r\n  // Appliquer le suffixe \u00E0 l'ID\r\n  const newId = `${parsed.id}-${suffix}`;\r\n  return `${parsed.prefix}${newId}`;\r\n}\r\n\r\n/**\r\n * Extrait le nodeId depuis un sourceRef\r\n * Utile pour mettre \u00E0 jour les colonnes linked... bidirectionnellement\r\n * \r\n * @param sourceRef - R\u00E9f\u00E9rence\r\n * @returns nodeId extrait ou null\r\n */\r\nexport function extractNodeIdFromSourceRef(\r\n  sourceRef: string | null | undefined\r\n): string | null {\r\n  const parsed = parseSourceRef(sourceRef);\r\n  return parsed ? parsed.id : null;\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD04 FONCTION PRINCIPALE DE COPIE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Copie une variable avec sa capacit\u00E9 associ\u00E9e\r\n * \r\n * PROCESSUS :\r\n * -----------\r\n * 1. R\u00E9cup\u00E8re la variable originale\r\n * 2. V\u00E9rifie si d\u00E9j\u00E0 copi\u00E9e (cache)\r\n * 3. G\u00E9n\u00E8re les nouveaux IDs avec suffixe\r\n * 4. Parse le sourceRef pour identifier la capacit\u00E9\r\n * 5. Mappe vers la capacit\u00E9 copi\u00E9e (si disponible dans les maps)\r\n * 6. Cr\u00E9e la nouvelle variable\r\n * 7. Met \u00E0 jour linkedVariableIds du n\u0153ud propri\u00E9taire\r\n * 8. Met \u00E0 jour linkedXxxIds de la capacit\u00E9 (bidirectionnel)\r\n * \r\n * @param originalVarId - ID de la variable \u00E0 copier\r\n * @param suffix - Suffixe num\u00E9rique \u00E0 appliquer\r\n * @param newNodeId - ID du nouveau n\u0153ud propri\u00E9taire\r\n * @param prisma - Instance Prisma Client\r\n * @param options - Options avec les maps de r\u00E9f\u00E9rences\r\n * @returns R\u00E9sultat de la copie\r\n */\r\nexport async function copyVariableWithCapacities(\r\n  originalVarId: string,\r\n  suffix: string | number,\r\n  newNodeId: string,\r\n  prisma: PrismaClient,\r\n  options: CopyVariableOptions = {}\r\n): Promise<CopyVariableResult> {\r\n  \r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uFFFD\uD83D\uDE80\uD83D\uDE80 [ENTRY] copyVariableWithCapacities APPEL\u00C9E !`);\r\n  console.log(`\uFFFD\uD83D\uDD17 COPIE VARIABLE: ${originalVarId}`);\r\n  console.log(`   Suffixe: ${suffix}`);\r\n  console.log(`   Nouveau n\u0153ud: ${newNodeId}`);\r\n  console.log(`   Options:`, {\r\n    formulaIdMapSize: options.formulaIdMap?.size,\r\n    conditionIdMapSize: options.conditionIdMap?.size,\r\n    tableIdMapSize: options.tableIdMap?.size,\r\n    nodeIdMapSize: options.nodeIdMap?.size,\r\n    variableCopyCacheSize: options.variableCopyCache?.size,\r\n    autoCreateDisplayNode: options.autoCreateDisplayNode\r\n  });\r\n  console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n  const {\r\n    formulaIdMap = new Map(),\r\n    conditionIdMap = new Map(),\r\n    tableIdMap = new Map(),\r\n    nodeIdMap = new Map(),\r\n    variableCopyCache = new Map(),\r\n    autoCreateDisplayNode = false,\r\n    displaySectionLabel = 'Nouveau Section',\r\n    linkToDisplaySection = false,\r\n  // displayNodeAlreadyCreated is not used anymore in this function; keep options API stable without reassigning\r\n  } = options;\r\n\r\n  try {\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD0D \u00C9TAPE 1 : V\u00E9rifier le cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    if (variableCopyCache.has(originalVarId)) {\r\n      const cachedId = variableCopyCache.get(originalVarId)!;\r\n      console.log(`\u267B\uFE0F Variable d\u00E9j\u00E0 copi\u00E9e (cache): ${originalVarId} \u2192 ${cachedId}`);\r\n      \r\n      // R\u00E9cup\u00E9rer les infos depuis la base pour retourner un r\u00E9sultat complet\r\n      const cached = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n        where: { id: cachedId }\r\n      });\r\n      \r\n      if (cached) {\r\n        const parsed = parseSourceRef(cached.sourceRef);\r\n        return {\r\n          variableId: cached.id,\r\n          exposedKey: cached.exposedKey,\r\n          capacityType: parsed?.type || null,\r\n          sourceRef: cached.sourceRef,\r\n          success: true\r\n        };\r\n      }\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCE5 \u00C9TAPE 2 : R\u00E9cup\u00E9rer la variable originale\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    const originalVar = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n      where: { id: originalVarId }\r\n    });\r\n\r\n    if (!originalVar) {\r\n      console.error(`\u274C Variable introuvable: ${originalVarId}`);\r\n      return {\r\n        variableId: '',\r\n        exposedKey: '',\r\n        capacityType: null,\r\n        sourceRef: null,\r\n        success: false,\r\n        error: `Variable introuvable: ${originalVarId}`\r\n      };\r\n    }\r\n\r\n    console.log(`\u2705 Variable trouv\u00E9e: ${originalVar.displayName}`);\r\n    console.log(`   sourceType: ${originalVar.sourceType}`);\r\n    console.log(`   sourceRef: ${originalVar.sourceRef || 'null'}`);\r\n    console.log(`   \uD83D\uDCCD DEBUG: newVariable.displayName sera utilis\u00E9 pour le label du n\u0153ud d'affichage`);\r\n\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83C\uDD94 \u00C9TAPE 3 : Pr\u00E9parer les IDs cibles (peuvent \u00EAtre adapt\u00E9s plus loin si collision)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  let newVarId = `${originalVarId}-${suffix}`;\r\n  let newExposedKey = `${originalVar.exposedKey}-${suffix}`;\r\n\r\n  console.log(`\uD83D\uDCDD Pr\u00E9paration des IDs:`);\r\n  console.log(`   Variable (pr\u00E9liminaire): ${newVarId}`);\r\n  console.log(`   ExposedKey (pr\u00E9liminaire): ${newExposedKey}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD0D \u00C9TAPE 4 : Analyser et COPIER la capacit\u00E9 si n\u00E9cessaire\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \u26A0\uFE0F IMPORTANT: On NE MODIFIE PAS le sourceRef ! Il reste identique \u00E0 l'original\r\n  // IMPORTANT: NE PAS convertir en const. Cette variable est r\u00E9assign\u00E9e plus bas.\r\n  // Laisser \"let\" et ignorer les suggestions automatiques de \"prefer-const\".\r\n  let newSourceRef = originalVar.sourceRef;\r\n    let capacityType: 'formula' | 'condition' | 'table' | 'field' | null = null;\r\n\r\n  console.log(`\\n\uD83D\uDD0D [COPY-VAR] Analyse sourceType=\"${originalVar.sourceType}\" sourceRef=\"${originalVar.sourceRef}\"`);\r\n  // IMPORTANT: on traite TOUT sourceRef non vide (pas uniquement sourceType === 'tree').\r\n  // Les conditions et tables peuvent avoir d'autres sourceType; on s'appuie sur parseSourceRef.\r\n  if (originalVar.sourceRef) {\r\n      const parsed = parseSourceRef(originalVar.sourceRef);\r\n      \r\n      if (parsed) {\r\n        capacityType = parsed.type;\r\n        console.log(`\uD83D\uDD0D [COPY-VAR] Capacit\u00E9 d\u00E9tect\u00E9e: ${capacityType} (ID: ${parsed.id})`);\r\n        console.log(`\uD83D\uDCE6 [COPY-VAR] Maps disponibles - formulas: ${formulaIdMap.size}, conditions: ${conditionIdMap.size}, tables: ${tableIdMap.size}, nodes: ${nodeIdMap.size}`);\r\n\r\n        // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        // \uD83E\uDDEE COPIE FORMULE\r\n        // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        if (capacityType === 'formula') {\r\n          console.log(`\uD83E\uDDEE [COPY-VAR] Traitement FORMULE: ${parsed.id}`);\r\n          // V\u00E9rifier si la formule a d\u00E9j\u00E0 \u00E9t\u00E9 copi\u00E9e\r\n          if (formulaIdMap.has(parsed.id)) {\r\n            const mappedFormulaId = formulaIdMap.get(parsed.id)!;\r\n            newSourceRef = `${parsed.prefix}${mappedFormulaId}`;\r\n            console.log(`\u2705 [COPY-VAR] Formule d\u00E9j\u00E0 mapp\u00E9e: ${parsed.id} \u2192 ${mappedFormulaId}`);\r\n          } else {\r\n            // \u2B50 COPIER LA FORMULE MAINTENANT\r\n            console.log(`\\n\uD83E\uDDEE [COPY-VAR] Lancement copie formule ${parsed.id}...`);\r\n            try {\r\n              const formulaResult = await copyFormulaCapacity(\r\n                parsed.id,\r\n                newNodeId,\r\n                suffix,\r\n                prisma,\r\n                { nodeIdMap, formulaCopyCache: formulaIdMap }\r\n              );\r\n\r\n              if (formulaResult.success) {\r\n                // Ajouter au map pour les prochaines copies\r\n                formulaIdMap.set(parsed.id, formulaResult.newFormulaId);\r\n                newSourceRef = `${parsed.prefix}${formulaResult.newFormulaId}`;\r\n                console.log(`\u2705 [COPY-VAR] Formule copi\u00E9e et mapp\u00E9e: ${parsed.id} \u2192 ${formulaResult.newFormulaId}`);\r\n              } else {\r\n                newSourceRef = applySuffixToSourceRef(originalVar.sourceRef, Number(suffix));\r\n                console.log(`\u26A0\uFE0F [COPY-VAR] \u00C9chec copie formule (${formulaResult.error}), suffixe appliqu\u00E9: ${newSourceRef}`);\r\n              }\r\n            } catch (e) {\r\n              console.error(`\u274C [COPY-VAR] Exception copie formule:`, (e as Error).message, (e as Error).stack);\r\n              newSourceRef = applySuffixToSourceRef(originalVar.sourceRef, Number(suffix));\r\n            }\r\n          }\r\n        } \r\n        // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        // \uD83D\uDD00 COPIE CONDITION\r\n        // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        else if (capacityType === 'condition') {\r\n          if (conditionIdMap.has(parsed.id)) {\r\n            const mappedConditionId = conditionIdMap.get(parsed.id)!;\r\n            newSourceRef = `${parsed.prefix}${mappedConditionId}`;\r\n            console.log(`\u2705 Condition d\u00E9j\u00E0 mapp\u00E9e: ${parsed.id} \u2192 ${mappedConditionId}`);\r\n          } else {\r\n            // \u2B50 COPIER LA CONDITION MAINTENANT\r\n            console.log(`\\n\uD83D\uDD00 Copie de la condition ${parsed.id}...`);\r\n            try {\r\n              const conditionResult = await copyConditionCapacity(\r\n                parsed.id,\r\n                newNodeId,\r\n                suffix,\r\n                prisma,\r\n                { nodeIdMap, formulaIdMap, conditionCopyCache: conditionIdMap }\r\n              );\r\n\r\n              if (conditionResult.success) {\r\n                // Ajouter au map\r\n                conditionIdMap.set(parsed.id, conditionResult.newConditionId);\r\n                newSourceRef = `${parsed.prefix}${conditionResult.newConditionId}`;\r\n                console.log(`\u2705 Condition copi\u00E9e et mapp\u00E9e: ${parsed.id} \u2192 ${conditionResult.newConditionId}`);\r\n              } else {\r\n                newSourceRef = applySuffixToSourceRef(originalVar.sourceRef, suffix);\r\n                console.log(`\u26A0\uFE0F \u00C9chec copie condition, suffixe appliqu\u00E9: ${newSourceRef}`);\r\n              }\r\n            } catch (e) {\r\n              console.error(`\u274C Exception copie condition:`, (e as Error).message);\r\n              newSourceRef = applySuffixToSourceRef(originalVar.sourceRef, suffix);\r\n            }\r\n          }\r\n        }\r\n        // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        // \uD83D\uDCCA COPIE TABLE\r\n        // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        else if (capacityType === 'table') {\r\n          if (tableIdMap.has(parsed.id)) {\r\n            const mappedTableId = tableIdMap.get(parsed.id)!;\r\n            newSourceRef = `${parsed.prefix}${mappedTableId}`;\r\n            console.log(`\u2705 Table d\u00E9j\u00E0 mapp\u00E9e: ${parsed.id} \u2192 ${mappedTableId}`);\r\n          } else {\r\n            // \u2B50 COPIER LA TABLE MAINTENANT\r\n            console.log(`\\n\uD83D\uDCCA Copie de la table ${parsed.id}...`);\r\n            try {\r\n              const tableResult = await copyTableCapacity(\r\n                parsed.id,\r\n                newNodeId,\r\n                suffix,\r\n                prisma,\r\n                { nodeIdMap, tableCopyCache: tableIdMap, tableIdMap }\r\n              );\r\n\r\n              if (tableResult.success) {\r\n                // Ajouter au map\r\n                tableIdMap.set(parsed.id, tableResult.newTableId);\r\n                newSourceRef = `${parsed.prefix}${tableResult.newTableId}`;\r\n                console.log(`\u2705 Table copi\u00E9e et mapp\u00E9e: ${parsed.id} \u2192 ${tableResult.newTableId}`);\r\n                console.log(`   \uD83D\uDCCB ${tableResult.columnsCount} colonnes, ${tableResult.rowsCount} lignes, ${tableResult.cellsCount} cellules`);\r\n              } else {\r\n                newSourceRef = applySuffixToSourceRef(originalVar.sourceRef, suffix);\r\n                console.log(`\u26A0\uFE0F \u00C9chec copie table, suffixe appliqu\u00E9: ${newSourceRef}`);\r\n              }\r\n            } catch (e) {\r\n              console.error(`\u274C Exception copie table:`, (e as Error).message);\r\n              newSourceRef = applySuffixToSourceRef(originalVar.sourceRef, suffix);\r\n            }\r\n          }\r\n        }\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n  // \uD83D\uDCDD CHAMP (pas de copie, juste mapping)\r\n  // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n        else if (capacityType === 'field') {\r\n          // Mapper le nodeId du champ si disponible\r\n          if (nodeIdMap.has(parsed.id)) {\r\n            newSourceRef = nodeIdMap.get(parsed.id)!;\r\n            console.log(`\u2705 Champ mapp\u00E9: ${parsed.id} \u2192 ${newSourceRef}`);\r\n          } else {\r\n            newSourceRef = `${parsed.id}-${suffix}`;\r\n            console.log(`\u26A0\uFE0F Champ non mapp\u00E9, suffixe appliqu\u00E9: ${newSourceRef}`);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`\uD83D\uDCCD sourceRef final: ${newSourceRef}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCBE \u00C9TAPE 5 : Cr\u00E9er la nouvelle variable\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    \r\n    // \uD83D\uDD0D D\u00E9terminer le nodeId du n\u0153ud PROPRI\u00C9TAIRE de la variable (n\u0153ud d'affichage)\r\n    // 1) Si l'ancien nodeId de la variable a \u00E9t\u00E9 copi\u00E9 (pr\u00E9sent dans nodeIdMap), on utilise ce nouveau nodeId\r\n    // 2) Sinon, si l'auto-cr\u00E9ation est activ\u00E9e, on cr\u00E9e un n\u0153ud d'affichage d\u00E9di\u00E9 et on l'utilise\r\n    // 3) Sinon, fallback sur newNodeId (peut causer des collisions si plusieurs variables par n\u0153ud)\r\n  let finalNodeId = newNodeId;\r\n    if (originalVar.nodeId && nodeIdMap.has(originalVar.nodeId)) {\r\n      finalNodeId = nodeIdMap.get(originalVar.nodeId)!;\r\n      console.log(`\uD83D\uDCCD nodeId mapp\u00E9: ${originalVar.nodeId} \u2192 ${finalNodeId}`);\r\n    } else if (autoCreateDisplayNode) {\r\n      // Cr\u00E9er un n\u0153ud d'affichage D\u00C9DI\u00C9 avec un ID unique d\u00E9riv\u00E9 de l'ancien nodeId + suffixe\r\n      try {\r\n        const parseJsonIfNeeded = (value: unknown): unknown => {\r\n          if (typeof value !== 'string') return value ?? undefined;\r\n          const trimmed = value.trim();\r\n          if (!trimmed) return undefined;\r\n          const first = trimmed[0];\r\n          const last = trimmed[trimmed.length - 1];\r\n          const looksJson = (first === '[' && last === ']') || (first === '{' && last === '}');\r\n          if (!looksJson) return value;\r\n          try {\r\n            return JSON.parse(trimmed);\r\n          } catch {\r\n            return value;\r\n          }\r\n        };\r\n\r\n        const originalOwnerNode = await prisma.treeBranchLeafNode.findUnique({\r\n          where: { id: originalVar.nodeId! },\r\n          select: {\r\n            id: true,\r\n            parentId: true,\r\n            treeId: true,\r\n            order: true,\r\n            linkedTableIds: true,\r\n            hasTable: true,\r\n            table_name: true,\r\n            table_activeId: true,\r\n            table_instances: true,\r\n            metadata: true,\r\n            subtab: true,\r\n            subtabs: true,\r\n          }\r\n        });\r\n        if (originalOwnerNode) {\r\n          // Chercher ou cr\u00E9er la section d'affichage sous le m\u00EAme parent\r\n          let displayParentId: string | null = originalOwnerNode.parentId || null;\r\n          if (originalOwnerNode.parentId) {\r\n            const existingSection = await prisma.treeBranchLeafNode.findFirst({\r\n              where: { treeId: originalOwnerNode.treeId, parentId: originalOwnerNode.parentId, type: 'section', label: { equals: displaySectionLabel } },\r\n              select: { id: true, order: true }\r\n            });\r\n            if (existingSection) {\r\n              displayParentId = existingSection.id;\r\n            } else {\r\n              // Cr\u00E9er la section d'affichage manquante\r\n              const nowCreate = new Date();\r\n              const secId = `section-${originalOwnerNode.parentId}-nouveau`;\r\n              try {\r\n                try {\r\n                const createdSection = await prisma.treeBranchLeafNode.create({\r\n                  data: {\r\n                    id: secId,\r\n                    treeId: originalOwnerNode.treeId,\r\n                    parentId: originalOwnerNode.parentId,\r\n                    type: 'section' as any,\r\n                    subType: null as any,\r\n                    label: displaySectionLabel,\r\n                    description: null,\r\n                    order: (originalOwnerNode.order ?? 0) + 0.5,\r\n                    isRequired: false,\r\n                    isVisible: true,\r\n                    isActive: true,\r\n                    isMultiple: false as any,\r\n                    fieldConfig: null as any,\r\n                    conditionConfig: null as any,\r\n                    formulaConfig: null as any,\r\n                    tableConfig: null as any,\r\n                    apiConfig: null as any,\r\n                    linkConfig: null as any,\r\n                    defaultValue: null as any,\r\n                    calculatedValue: null as any,\r\n                    metadata: { autoCreated: true, reason: 'display-section-missing' } as any,\r\n                    createdAt: nowCreate,\r\n                    updatedAt: nowCreate,\r\n                    hasAPI: false,\r\n                    hasCondition: false,\r\n                    hasData: false,\r\n                    hasFormula: false,\r\n                    hasLink: false,\r\n                    hasMarkers: false,\r\n                    hasTable: false,\r\n                    linkedTableIds: [] as any,\r\n                    linkedConditionIds: [] as any,\r\n                    linkedFormulaIds: [] as any,\r\n                    linkedVariableIds: [] as any,\r\n                    appearance_size: 'md' as any,\r\n                    appearance_variant: null as any,\r\n                    appearance_width: '100%' as any,\r\n                    fieldType: null as any,\r\n                    fieldSubType: null as any,\r\n                    field_label: null as any,\r\n                  }\r\n                });\r\n                displayParentId = createdSection.id;\r\n                console.log(`\u2705 Section d'affichage cr\u00E9\u00E9e automatiquement: ${displaySectionLabel} (${createdSection.id}`);\r\n              } catch (sectionErr) {\r\n                // Si la section existe d\u00E9j\u00E0 (race condition), rester sous le parent direct\r\n                console.warn(`\u26A0\uFE0F Impossible de cr\u00E9er la section (probablement existe d\u00E9j\u00E0): ${(sectionErr as Error).message}`);\r\n                // displayParentId reste = originalOwnerNode.parentId\r\n              }\r\n              } catch (e) {\r\n                console.warn(`\u26A0\uFE0F Impossible de cr\u00E9er la section d'affichage manquante: ${(e as Error).message}`);\r\n              }\r\n            }\r\n          }\r\n\r\n          // G\u00E9n\u00E9rer un ID unique pour le n\u0153ud d'affichage (ex: <oldVarNodeId>-<suffix>)\r\n          const displayNodeId = `${originalVar.nodeId}-${suffix}`;\r\n          finalNodeId = displayNodeId;\r\n\r\n          const now = new Date();\r\n          const ownerMetadata = originalOwnerNode.metadata && typeof originalOwnerNode.metadata === 'object'\r\n            ? JSON.parse(JSON.stringify(originalOwnerNode.metadata)) as Record<string, unknown>\r\n            : {};\r\n\r\n          const ownerSubTabRaw = ownerMetadata?.subTab\r\n            ?? ownerMetadata?.subTabKey\r\n            ?? parseJsonIfNeeded(originalOwnerNode.subtab ?? undefined);\r\n          const ownerSubTabsRaw = ownerMetadata?.subTabs\r\n            ?? parseJsonIfNeeded(originalOwnerNode.subtabs ?? undefined);\r\n\r\n          const ownerSubTabsArray = Array.isArray(ownerSubTabsRaw)\r\n            ? (ownerSubTabsRaw as unknown[]).map(entry => String(entry))\r\n            : undefined;\r\n\r\n          const metadataForDisplay: Record<string, unknown> = {\r\n            ...ownerMetadata,\r\n            fromVariableId: `${originalVar.id}-${suffix}`,\r\n            autoCreatedDisplayNode: true,\r\n          };\r\n\r\n          if (ownerSubTabRaw !== undefined) {\r\n            metadataForDisplay.subTab = ownerSubTabRaw;\r\n          }\r\n          if (ownerSubTabsArray?.length) {\r\n            metadataForDisplay.subTabs = ownerSubTabsArray;\r\n          }\r\n\r\n          const formatSubTabColumn = (value: unknown): string | null => {\r\n            if (value === null || value === undefined) return null;\r\n            if (Array.isArray(value)) {\r\n              return value.length ? JSON.stringify(value) : null;\r\n            }\r\n            return typeof value === 'string' ? value : String(value);\r\n          };\r\n\r\n          const displayNodeData = {\r\n            id: displayNodeId,\r\n            treeId: originalOwnerNode.treeId,\r\n            parentId: displayParentId,\r\n            type: 'leaf_field' as const,\r\n            subType: null as any,\r\n            label: originalVar.displayName || 'Donn\u00E9e',\r\n            description: null as string | null,\r\n            value: null as string | null,\r\n            order: (originalOwnerNode.order ?? 0) + 1,\r\n            isRequired: false,\r\n            isVisible: true,\r\n            isActive: true,\r\n            isMultiple: false as any,\r\n            fieldConfig: null as any,\r\n            conditionConfig: null as any,\r\n            formulaConfig: null as any,\r\n            tableConfig: null as any,\r\n            apiConfig: null as any,\r\n            linkConfig: null as any,\r\n            defaultValue: null as any,\r\n            calculatedValue: null as any,\r\n            metadata: metadataForDisplay as any,\r\n            subtab: formatSubTabColumn(ownerSubTabRaw),\r\n            subtabs: ownerSubTabsArray?.length ? JSON.stringify(ownerSubTabsArray) : null,\r\n            createdAt: now,\r\n            updatedAt: now,\r\n            hasAPI: false,\r\n            hasCondition: false,\r\n            hasData: false,\r\n            hasFormula: false,\r\n            hasLink: false,\r\n            hasMarkers: false,\r\n            // \uD83D\uDCCA TABLE: Copier les colonnes table du n\u0153ud original\r\n            // \u2705 IMPORTANT: Ajouter le suffixe aux IDs de table pour pointer aux tables copi\u00E9es\r\n            hasTable: originalOwnerNode.hasTable ?? false,\r\n            table_name: originalOwnerNode.table_name,\r\n            table_activeId: originalOwnerNode.table_activeId ? `${originalOwnerNode.table_activeId}-${suffix}` : null,\r\n            table_instances: (() => {\r\n              if (!originalOwnerNode.table_instances) {\r\n                return originalOwnerNode.table_instances;\r\n              }\r\n              // \uD83D\uDD11 CRITIQUE: G\u00E9rer les deux cas - objet ou STRING JSON (Prisma retourne parfois string)\r\n              let rawInstances: Record<string, unknown>;\r\n              if (typeof originalOwnerNode.table_instances === 'object') {\r\n                rawInstances = JSON.parse(JSON.stringify(originalOwnerNode.table_instances));\r\n              } else if (typeof originalOwnerNode.table_instances === 'string') {\r\n                // Si c'est une string JSON, parser d'abord\r\n                try {\r\n                  rawInstances = JSON.parse(originalOwnerNode.table_instances);\r\n                } catch {\r\n                  // Si parse \u00E9choue, retourner tel quel\r\n                  return originalOwnerNode.table_instances;\r\n                }\r\n              } else {\r\n                return originalOwnerNode.table_instances;\r\n              }\r\n              \r\n              const updatedInstances: Record<string, unknown> = {};\r\n              for (const [key, value] of Object.entries(rawInstances)) {\r\n                // \u2705 FIX: V\u00E9rifier si la cl\u00E9 a D\u00C9J\u00C0 un suffixe num\u00E9rique (-1, -2, etc.)\r\n                // Ne pas utiliser includes('-') car UUIDs contiennent des tirets!\r\n                const hasSuffixRegex = /-\\d+$/;  // Suffixe num\u00E9rique \u00E0 la fin\r\n                const newKey = hasSuffixRegex.test(key) ? key : `${key}-${suffix}`;\r\n                \r\n                // AUSSI ajouter le suffixe au tableId INT\u00C9RIEUR si pr\u00E9sent\r\n                if (value && typeof value === 'object') {\r\n                  const tableInstanceObj = value as Record<string, unknown>;\r\n                  const updatedObj = { ...tableInstanceObj };\r\n                  if (tableInstanceObj.tableId && typeof tableInstanceObj.tableId === 'string') {\r\n                    // \u2705 FIX: M\u00EAme chose pour le tableId\r\n                    updatedObj.tableId = hasSuffixRegex.test(tableInstanceObj.tableId)\r\n                      ? tableInstanceObj.tableId \r\n                      : `${tableInstanceObj.tableId}-${suffix}`;\r\n                  }\r\n                  updatedInstances[newKey] = updatedObj;\r\n                } else {\r\n                  updatedInstances[newKey] = value;\r\n                }\r\n              }\r\n              return updatedInstances;\r\n            })() as any,\r\n            linkedTableIds: Array.isArray(originalOwnerNode.linkedTableIds) \r\n              // \u2705 AJOUTER LES SUFFIXES aux IDs de table ici aussi!\r\n              ? originalOwnerNode.linkedTableIds.map(id => `${id}-${suffix}`)\r\n              : [] as any,\r\n            linkedConditionIds: [] as any,\r\n            linkedFormulaIds: [] as any,\r\n            linkedVariableIds: [] as any,\r\n            appearance_size: 'md' as any,\r\n            appearance_variant: null as any,\r\n            appearance_width: '100%' as any,\r\n            fieldType: 'TEXT' as any,\r\n            fieldSubType: null as any,\r\n            field_label: originalVar.displayName as any,\r\n          };\r\n\r\n          const maybeExisting = await prisma.treeBranchLeafNode.findUnique({ where: { id: displayNodeId } });\r\n          if (maybeExisting) {\r\n            await prisma.treeBranchLeafNode.update({ where: { id: displayNodeId }, data: { ...displayNodeData, createdAt: maybeExisting.createdAt, updatedAt: now } });\r\n            console.log(`\u2705 N\u0153ud d'affichage existant mis \u00E0 jour: ${displayNodeId}`);\r\n          } else {\r\n            await prisma.treeBranchLeafNode.create({ data: displayNodeData as any });\r\n            console.log(`\u2705 N\u0153ud d'affichage cr\u00E9\u00E9: ${displayNodeId}`);\r\n          }\r\n        } else {\r\n          console.warn(`\u26A0\uFE0F Impossible de r\u00E9cup\u00E9rer le n\u0153ud propri\u00E9taire original ${originalVar.nodeId}. Fallback newNodeId.`);\r\n        }\r\n      } catch (e) {\r\n        console.warn(`\u26A0\uFE0F Erreur lors de la cr\u00E9ation du n\u0153ud d'affichage d\u00E9di\u00E9:`, (e as Error).message);\r\n      }\r\n      console.log(`\uD83D\uDCCD nodeId utilis\u00E9 (display auto): ${finalNodeId}`);\r\n    } else {\r\n      console.log(`\uD83D\uDCCD nodeId utilis\u00E9 (fallback): ${finalNodeId}`);\r\n    }\r\n    \r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDEE1\uFE0F \u00C9TAPE 5A : \u00C9viter les collisions d'ID (conflits inter-templates)\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // Cas rencontr\u00E9: plusieurs templates peuvent r\u00E9f\u00E9rencer la m\u00EAme variable d'origine\r\n    // et utiliser le m\u00EAme suffixe num\u00E9rique (ex: 1), provoquant un conflit unique\r\n    // sur id et/ou exposedKey. On s\u00E9curise en ajoutant un discriminant bas\u00E9 sur\r\n    // le n\u0153ud d'affichage final si collision d\u00E9tect\u00E9e.\r\n    try {\r\n      const existingById = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { id: newVarId } });\r\n      if (existingById) {\r\n        const tail = (finalNodeId || newNodeId || '').slice(-6) || `${Date.now()}`;\r\n        const adjusted = `${originalVarId}-${suffix}-${tail}`;\r\n        console.warn(`\u26A0\uFE0F Conflit sur id variable (${newVarId}), ajustement \u2192 ${adjusted}`);\r\n        newVarId = adjusted;\r\n      }\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F V\u00E9rification collision id variable \u00E9chou\u00E9e:`, (e as Error).message);\r\n    }\r\n\r\n    try {\r\n      const existingByKey = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { exposedKey: newExposedKey } });\r\n      if (existingByKey) {\r\n        const tail = (finalNodeId || newNodeId || '').slice(-6) || `${Date.now()}`;\r\n        const adjustedKey = `${originalVar.exposedKey}-${suffix}-${tail}`;\r\n        console.warn(`\u26A0\uFE0F Conflit sur exposedKey (${newExposedKey}), ajustement \u2192 ${adjustedKey}`);\r\n        newExposedKey = adjustedKey;\r\n      }\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F V\u00E9rification collision exposedKey \u00E9chou\u00E9e:`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD01 \u00C9TAPE 5A-bis : R\u00E9utiliser une variable existante pour ce n\u0153ud si pr\u00E9sente\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \u00C9vite la violation d'unicit\u00E9 sur nodeId (1 variable par n\u0153ud) quand\r\n    // plusieurs duplications pointent vers le m\u00EAme n\u0153ud d'affichage d\u00E9di\u00E9.\r\n    let _reusingExistingVariable = false;\r\n    let _existingVariableForReuse: any = null;\r\n    \r\n    try {\r\n      const existingForNode = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { nodeId: finalNodeId } });\r\n      if (existingForNode) {\r\n        console.log(`\u267B\uFE0F Variable d\u00E9j\u00E0 existante pour display node ${finalNodeId}, r\u00E9utilisation: ${existingForNode.id}`);\r\n        _reusingExistingVariable = true;\r\n        _existingVariableForReuse = existingForNode;\r\n        \r\n        // Harmoniser le n\u0153ud d'affichage avec les donn\u00E9es de la variable existante\r\n        try {\r\n          await prisma.treeBranchLeafNode.update({\r\n            where: { id: finalNodeId },\r\n            data: {\r\n              hasData: true,\r\n              data_activeId: existingForNode.id,\r\n              data_exposedKey: existingForNode.exposedKey,\r\n              data_displayFormat: existingForNode.displayFormat,\r\n              data_precision: existingForNode.precision,\r\n              data_unit: existingForNode.unit,\r\n              data_visibleToUser: existingForNode.visibleToUser,\r\n              label: existingForNode.displayName || undefined,\r\n              field_label: (existingForNode.displayName as any) || undefined\r\n            }\r\n          });\r\n          await addToNodeLinkedField(prisma, finalNodeId, 'linkedVariableIds', [existingForNode.id]);\r\n        } catch (e) {\r\n          console.warn(`\u26A0\uFE0F Erreur MAJ display node (r\u00E9utilisation):`, (e as Error).message);\r\n        }\r\n\r\n        // Mettre en cache l'ID r\u00E9utilis\u00E9 pour \u00E9viter d'autres cr\u00E9ations\r\n        variableCopyCache.set(originalVarId, existingForNode.id);\r\n        \r\n        // \u26A0\uFE0F NE PAS RETOURNER ICI - Continuer pour copier les capacit\u00E9s de cette variable\r\n        // pour ce nouveau n\u0153ud/contexte !\r\n      }\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F V\u00E9rification variable existante par nodeId \u00E9chou\u00E9e:`, (e as Error).message);\r\n    }\r\n\r\n    // Utiliser la variable r\u00E9utilis\u00E9e ou en cr\u00E9er une nouvelle\r\n    let newVariable: any;\r\n    \r\n    if (_reusingExistingVariable && _existingVariableForReuse) {\r\n      console.log(`\u267B\uFE0F [COPY-VAR] Utilisation de variable existante: ${_existingVariableForReuse.id}`);\r\n      newVariable = _existingVariableForReuse;\r\n    } else {\r\n      console.log(`\\n\uD83D\uDD28 [COPY-VAR] CR\u00C9ATION DE LA VARIABLE EN BASE...`);\r\n      console.log(`   ID: ${newVarId}`);\r\n      console.log(`   nodeId: ${finalNodeId}`);\r\n      console.log(`   exposedKey: ${newExposedKey}`);\r\n      console.log(`   displayName: ${originalVar.displayName ? `${originalVar.displayName}-${suffix}` : originalVar.displayName}`);\r\n      console.log(`   sourceRef: ${newSourceRef}`);\r\n      console.log(`   sourceType: ${originalVar.sourceType}`);\r\n      \r\n      newVariable = await prisma.treeBranchLeafNodeVariable.create({\r\n        data: {\r\n          id: newVarId,\r\n          nodeId: finalNodeId,\r\n          exposedKey: newExposedKey,\r\n          displayName: originalVar.displayName ? `${originalVar.displayName}-${suffix}` : originalVar.displayName,\r\n          displayFormat: originalVar.displayFormat,\r\n          unit: originalVar.unit,\r\n          precision: originalVar.precision,\r\n          visibleToUser: originalVar.visibleToUser,\r\n          isReadonly: originalVar.isReadonly,\r\n          defaultValue: originalVar.defaultValue,\r\n          fixedValue: originalVar.fixedValue,\r\n          selectedNodeId: originalVar.selectedNodeId \r\n            ? (nodeIdMap.get(originalVar.selectedNodeId) || `${originalVar.selectedNodeId}-${suffix}`)\r\n            : null,\r\n          sourceRef: newSourceRef,\r\n          sourceType: originalVar.sourceType,\r\n          metadata: originalVar.metadata as any,\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log(`\u2705\u2705\u2705 VARIABLE CR\u00C9\u00C9E AVEC SUCC\u00C8S EN BASE !`);\r\n    console.log(`   ID cr\u00E9\u00E9: ${newVariable.id}`);\r\n    console.log(`   nodeId: ${newVariable.nodeId}`);\r\n    console.log(`   exposedKey: ${newVariable.exposedKey}`);\r\n    console.log(`   \uD83D\uDCCD DEBUG displayName cr\u00E9\u00E9: \"${newVariable.displayName}\"`);\r\n    \r\n    // \uD83D\uDD0D V\u00C9RIFICATION: Re-chercher la variable pour confirmer qu'elle existe bien\r\n    const verification = await prisma.treeBranchLeafNodeVariable.findUnique({\r\n      where: { id: newVariable.id }\r\n    });\r\n    if (verification) {\r\n      console.log(`\u2705 V\u00C9RIFICATION OK: Variable ${newVariable.id} existe bien en base`);\r\n    } else {\r\n      console.error(`\u274C\u274C\u274C PROBL\u00C8ME GRAVE: Variable ${newVariable.id} N'EXISTE PAS apr\u00E8s cr\u00E9ation !`);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCDD \u00C9TAPE 5B : Mettre \u00E0 jour le N\u0152UD D'AFFICHAGE (finalNodeId) avec les param\u00E8tres data\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    try {\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: finalNodeId },\r\n        data: {\r\n          hasData: true,\r\n          data_activeId: newVariable.id,\r\n          data_exposedKey: newVariable.exposedKey,\r\n          data_displayFormat: newVariable.displayFormat,\r\n          data_precision: newVariable.precision,\r\n          data_unit: newVariable.unit,\r\n          data_visibleToUser: newVariable.visibleToUser,\r\n          // Harmoniser le label du n\u0153ud d'affichage sur le displayName de la variable\r\n          label: newVariable.displayName || undefined,\r\n          field_label: (newVariable.displayName as any) || undefined\r\n        }\r\n      });\r\n      console.log(`\u2705 Param\u00E8tres capacit\u00E9 (data) mis \u00E0 jour pour n\u0153ud d'affichage ${finalNodeId}`);\r\n    } catch (e) {\r\n      console.warn(`\u26A0\uFE0F Erreur lors de la mise \u00E0 jour des param\u00E8tres capacit\u00E9 (display node):`, (e as Error).message);\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83E\uDDE9 \u00C9TAPE 5C : Lier \u00E0 la section d'affichage (sans cr\u00E9ation) OU cr\u00E9er un n\u0153ud d'affichage\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    if (linkToDisplaySection) {\r\n      try {\r\n        // Trouver la section d'affichage \"Nouveau Section\" dans le contexte du parent d'origine\r\n        const originalOwnerNode = await prisma.treeBranchLeafNode.findUnique({\r\n          where: { id: originalVar.nodeId },\r\n          select: { parentId: true, treeId: true }\r\n        });\r\n        if (originalOwnerNode?.parentId) {\r\n          const displaySection = await prisma.treeBranchLeafNode.findFirst({\r\n            where: {\r\n              treeId: originalOwnerNode.treeId,\r\n              parentId: originalOwnerNode.parentId,\r\n              type: 'section',\r\n              label: { equals: displaySectionLabel }\r\n            },\r\n            select: { id: true }\r\n          });\r\n          if (displaySection) {\r\n            await addToNodeLinkedField(prisma, displaySection.id, 'linkedVariableIds', [newVariable.id]);\r\n            console.log(`\u2705 Variable li\u00E9e \u00E0 la section d'affichage ${displaySectionLabel}: ${displaySection.id}`);\r\n          } else {\r\n            console.log(`\u2139\uFE0F Section d'affichage \"${displaySectionLabel}\" introuvable sous le parent.`);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.warn(`\u26A0\uFE0F Erreur lors du linkage vers la section d'affichage:`, (e as Error).message);\r\n      }\r\n    } else if (autoCreateDisplayNode) {\r\n      // D\u00E9j\u00E0 g\u00E9r\u00E9 ci-dessus: finalNodeId pointe vers le n\u0153ud d'affichage (copi\u00E9 ou cr\u00E9\u00E9)\r\n      // On s'assure simplement que le lien variable \u2192 n\u0153ud est en place\r\n      try {\r\n        await addToNodeLinkedField(prisma, finalNodeId, 'linkedVariableIds', [newVariable.id]);\r\n      } catch (e) {\r\n        console.warn(`\u26A0\uFE0F Erreur linkage variable\u2192display node:`, (e as Error).message);\r\n      }\r\n      // Hydratation capacit\u00E9s condition/table si applicable\r\n      try {\r\n        if (capacityType && newSourceRef) {\r\n          const parsedCap = parseSourceRef(newSourceRef);\r\n          const capId = parsedCap?.id;\r\n          if (parsedCap && capId) {\r\n            if (parsedCap.type === 'condition') {\r\n              const cond = await prisma.treeBranchLeafNodeCondition.findUnique({ where: { id: capId }, select: { name: true, description: true } });\r\n              await prisma.treeBranchLeafNode.update({\r\n                where: { id: finalNodeId },\r\n                data: {\r\n                  hasCondition: true,\r\n                  condition_activeId: capId,\r\n                  condition_name: cond?.name || null,\r\n                  condition_description: cond?.description || null\r\n                }\r\n              });\r\n              await addToNodeLinkedField(prisma, finalNodeId, 'linkedConditionIds', [capId]);\r\n            } else if (parsedCap.type === 'table') {\r\n              const tbl = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id: capId }, select: { name: true, description: true, type: true } });\r\n              await prisma.treeBranchLeafNode.update({\r\n                where: { id: finalNodeId },\r\n                data: {\r\n                  hasTable: true,\r\n                  table_activeId: capId,\r\n                  table_name: tbl?.name || null,\r\n                  table_description: tbl?.description || null,\r\n                  table_type: (tbl?.type as any) || null\r\n                }\r\n              });\r\n              await addToNodeLinkedField(prisma, finalNodeId, 'linkedTableIds', [capId]);\r\n            }\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.warn(`\u26A0\uFE0F Synchronisation capacit\u00E9s condition/table sur le n\u0153ud d'affichage:`, (e as Error).message);\r\n      }\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD17 \u00C9TAPE 6 : Mettre en cache\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    variableCopyCache.set(originalVarId, newVariable.id);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDD04 \u00C9TAPE 7 : Mise \u00E0 jour bidirectionnelle des linked...\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    \r\n    // NOTE: linkedVariableIds du n\u0153ud propri\u00E9taire est g\u00E9r\u00E9 par le code appelant\r\n    // (treebranchleaf-routes.ts) qui fait un UPDATE global apr\u00E8s toutes les copies\r\n    \r\n    // 7B. Mise \u00E0 jour inverse : ajouter dans la capacit\u00E9 r\u00E9f\u00E9renc\u00E9e\r\n    if (capacityType && newSourceRef) {\r\n      const parsed = parseSourceRef(newSourceRef);\r\n      if (parsed && parsed.id) {\r\n        try {\r\n          // Pour une formule/condition/table, on doit trouver le nodeId propri\u00E9taire\r\n          // de cette capacit\u00E9 pour mettre \u00E0 jour son linkedXxxIds\r\n          \r\n          if (capacityType === 'formula') {\r\n            const formula = await prisma.treeBranchLeafNodeFormula.findUnique({\r\n              where: { id: parsed.id },\r\n              select: { nodeId: true }\r\n            });\r\n            if (formula) {\r\n              await addToNodeLinkedField(prisma, formula.nodeId, 'linkedFormulaIds', [parsed.id]);\r\n              console.log(`\u2705 linkedFormulaIds mis \u00E0 jour pour formule ${parsed.id}`);\r\n            }\r\n          }\r\n          else if (capacityType === 'condition') {\r\n            const condition = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n              where: { id: parsed.id },\r\n              select: { nodeId: true }\r\n            });\r\n            if (condition) {\r\n              await addToNodeLinkedField(prisma, condition.nodeId, 'linkedConditionIds', [parsed.id]);\r\n              console.log(`\u2705 linkedConditionIds mis \u00E0 jour pour condition ${parsed.id}`);\r\n            }\r\n          }\r\n          else if (capacityType === 'table') {\r\n            const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n              where: { id: parsed.id },\r\n              select: { nodeId: true }\r\n            });\r\n            if (table) {\r\n              await addToNodeLinkedField(prisma, table.nodeId, 'linkedTableIds', [parsed.id]);\r\n              console.log(`\u2705 linkedTableIds mis \u00E0 jour pour table ${parsed.id}`);\r\n            }\r\n          }\r\n        } catch (e) {\r\n          console.warn(`\u26A0\uFE0F Erreur MAJ bidirectionnelle:`, (e as Error).message);\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`\\n${'\u2550'.repeat(80)}`);\r\n    console.log(`\u2705 COPIE VARIABLE TERMIN\u00C9E`);\r\n    console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n    return {\r\n      variableId: newVariable.id,\r\n      exposedKey: newExposedKey,\r\n      capacityType,\r\n      sourceRef: newSourceRef,\r\n      success: true\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur lors de la copie de la variable:`, error);\r\n    return {\r\n      variableId: '',\r\n      exposedKey: '',\r\n      capacityType: null,\r\n      sourceRef: null,\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error)\r\n    };\r\n  }\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83E\uDDE9 CR\u00C9ER UN N\u0152UD D'AFFICHAGE POUR UNE VARIABLE EXISTANTE\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n/**\r\n * Cr\u00E9e (ou met \u00E0 jour) un n\u0153ud d'affichage pour une variable existante.\r\n * N'implique pas de duplication de variable.\r\n */\r\nexport async function createDisplayNodeForExistingVariable(\r\n  variableId: string,\r\n  prisma: PrismaClient,\r\n  displaySectionLabel = 'Nouveau Section'\r\n): Promise<{ displayNodeId: string; created: boolean }>\r\n{\r\n  const v = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { id: variableId } });\r\n  if (!v) throw new Error(`Variable introuvable: ${variableId}`);\r\n\r\n  const owner = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: v.nodeId },\r\n    select: { id: true, parentId: true, treeId: true, order: true, linkedTableIds: true, hasTable: true, table_name: true, table_activeId: true, table_instances: true }\r\n  });\r\n  if (!owner) throw new Error(`N\u0153ud propri\u00E9taire introuvable: ${v.nodeId}`);\r\n\r\n  // Trouver/Cr\u00E9er la section d'affichage\r\n  let displayParentId: string | null = owner.parentId;\r\n  if (owner.parentId) {\r\n    const section = await prisma.treeBranchLeafNode.findFirst({\r\n      where: { treeId: owner.treeId, parentId: owner.parentId, type: 'section', label: { equals: displaySectionLabel } },\r\n      select: { id: true }\r\n    });\r\n    if (section) {\r\n      displayParentId = section.id;\r\n    } else {\r\n      // Cr\u00E9er si manquante\r\n      const now = new Date();\r\n      const newSectionId = `section-${owner.parentId}-nouveau`;\r\n      try {\r\n        await prisma.treeBranchLeafNode.create({\r\n          data: {\r\n            id: newSectionId,\r\n            treeId: owner.treeId,\r\n            parentId: owner.parentId,\r\n            type: 'section' as any,\r\n            subType: null as any,\r\n            label: displaySectionLabel,\r\n            description: null,\r\n            order: (owner.order ?? 0) + 0.5,\r\n            isRequired: false,\r\n            isVisible: true,\r\n            isActive: true,\r\n            isMultiple: false as any,\r\n            fieldConfig: null as any,\r\n            conditionConfig: null as any,\r\n            formulaConfig: null as any,\r\n            tableConfig: null as any,\r\n            apiConfig: null as any,\r\n            linkConfig: null as any,\r\n            defaultValue: null as any,\r\n            calculatedValue: null as any,\r\n            metadata: { autoCreated: true, reason: 'display-section-missing' } as any,\r\n            createdAt: now,\r\n            updatedAt: now,\r\n            hasAPI: false,\r\n            hasCondition: false,\r\n            hasData: false,\r\n            hasFormula: false,\r\n            hasLink: false,\r\n            hasMarkers: false,\r\n            hasTable: false,\r\n            linkedTableIds: [] as any,\r\n            linkedConditionIds: [] as any,\r\n            linkedFormulaIds: [] as any,\r\n            linkedVariableIds: [] as any,\r\n            appearance_size: 'md' as any,\r\n            appearance_variant: null as any,\r\n            appearance_width: '100%' as any,\r\n            fieldType: null as any,\r\n            fieldSubType: null as any,\r\n            field_label: null as any,\r\n          }\r\n        });\r\n        displayParentId = newSectionId;\r\n      } catch {\r\n        // Fallback: rester sous le parent direct\r\n        displayParentId = owner.parentId;\r\n      }\r\n    }\r\n  }\r\n\r\n  const now = new Date();\r\n  const baseData = {\r\n    id: displayNodeId,\r\n    treeId: owner.treeId,\r\n    parentId: displayParentId,\r\n    type: 'leaf_field' as const,\r\n    subType: null as any,\r\n    label: v.displayName || 'Donn\u00E9e',\r\n    description: null as string | null,\r\n    value: null as string | null,\r\n    order: (owner.order ?? 0) + 1,\r\n    isRequired: false,\r\n    isVisible: true,\r\n    isActive: true,\r\n    isMultiple: false as any,\r\n    fieldConfig: null as any,\r\n    conditionConfig: null as any,\r\n    formulaConfig: null as any,\r\n    tableConfig: null as any,\r\n    apiConfig: null as any,\r\n    linkConfig: null as any,\r\n    defaultValue: null as any,\r\n    calculatedValue: null as any,\r\n    metadata: { fromVariableId: variableId } as any,\r\n    createdAt: now,\r\n    updatedAt: now,\r\n    hasAPI: false,\r\n    hasCondition: false,\r\n    hasData: false,\r\n    hasFormula: false,\r\n    hasLink: false,\r\n    hasMarkers: false,\r\n    // \uD83D\uDCCA TABLE: Copier les colonnes table du n\u0153ud original\r\n    hasTable: owner.hasTable ?? false,\r\n    table_name: owner.table_name,\r\n    table_activeId: owner.table_activeId,\r\n    table_instances: owner.table_instances as any,\r\n    linkedTableIds: Array.isArray(owner.linkedTableIds) ? owner.linkedTableIds : [] as any,\r\n    linkedConditionIds: [] as any,\r\n    linkedFormulaIds: [] as any,\r\n    linkedVariableIds: [variableId] as any,\r\n    appearance_size: 'md' as any,\r\n    appearance_variant: null as any,\r\n    appearance_width: '100%' as any,\r\n    fieldType: 'TEXT' as any,\r\n    fieldSubType: null as any,\r\n    field_label: v.displayName as any,\r\n  };\r\n\r\n  const existing = await prisma.treeBranchLeafNode.findUnique({ where: { id: displayNodeId } });\r\n  if (existing) {\r\n    await prisma.treeBranchLeafNode.update({ where: { id: displayNodeId }, data: { ...baseData, createdAt: existing.createdAt, updatedAt: now } });\r\n  } else {\r\n    await prisma.treeBranchLeafNode.create({ data: baseData as any });\r\n  }\r\n\r\n  await prisma.treeBranchLeafNode.update({\r\n    where: { id: displayNodeId },\r\n    data: {\r\n      hasData: true,\r\n      data_activeId: variableId,\r\n      data_exposedKey: v.exposedKey,\r\n      data_displayFormat: v.displayFormat,\r\n      data_precision: v.precision,\r\n      data_unit: v.unit,\r\n      data_visibleToUser: v.visibleToUser\r\n    }\r\n  });\r\n\r\n  return { displayNodeId, created: !existing };\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD27 FONCTIONS UTILITAIRES POUR LINKED FIELDS\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * Ajoute des IDs \u00E0 un champ linked... d'un n\u0153ud (sans doublons)\r\n * \r\n * @param prisma - Instance Prisma\r\n * @param nodeId - ID du n\u0153ud\r\n * @param field - Nom du champ ('linkedFormulaIds', 'linkedConditionIds', etc.)\r\n * @param idsToAdd - IDs \u00E0 ajouter\r\n */\r\nasync function addToNodeLinkedField(\r\n  prisma: PrismaClient,\r\n  nodeId: string,\r\n  field: 'linkedFormulaIds' | 'linkedConditionIds' | 'linkedTableIds' | 'linkedVariableIds',\r\n  idsToAdd: string[]\r\n): Promise<void> {\r\n  if (!idsToAdd || idsToAdd.length === 0) return;\r\n\r\n  const node = await prisma.treeBranchLeafNode.findUnique({\r\n    where: { id: nodeId },\r\n    select: { [field]: true }\r\n  });\r\n\r\n  if (!node) {\r\n    console.warn(`\u26A0\uFE0F N\u0153ud ${nodeId} introuvable pour MAJ ${field}`);\r\n    return;\r\n  }\r\n\r\n  const current = (node[field] || []) as string[];\r\n  const newIds = [...new Set([...current, ...idsToAdd])]; // D\u00E9dupliquer\r\n\r\n  await prisma.treeBranchLeafNode.update({\r\n    where: { id: nodeId },\r\n    data: { [field]: { set: newIds } }\r\n  });\r\n}\r\n\r\n/**\r\n * Version simplifi\u00E9e pour compatibilit\u00E9 avec l'ancien code\r\n * qui passe parseSourceRef et addToNodeLinkedField en param\u00E8tres\r\n */\r\nexport async function copyVariableWithCapacitiesLegacy(\r\n  originalVarId: string,\r\n  suffix: number,\r\n  newNodeId: string,\r\n  prisma: PrismaClient,\r\n  _parseSourceRefFn: typeof parseSourceRef,\r\n  _addToNodeLinkedFieldFn: typeof addToNodeLinkedField\r\n): Promise<CopyVariableResult> {\r\n  // Appeler la version moderne\r\n  return copyVariableWithCapacities(originalVarId, suffix, newNodeId, prisma);\r\n}\r\n\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n// \uD83D\uDD17 COPIE DES VARIABLES LI\u00C9ES DEPUIS linkedVariableIds\r\n// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n\r\n/**\r\n * R\u00E9sultat de la copie de variables li\u00E9es\r\n */\r\nexport interface CopyLinkedVariablesResult {\r\n  /** Nombre de variables copi\u00E9es */\r\n  count: number;\r\n  /** Map des anciennes IDs vers les nouvelles IDs */\r\n  variableIdMap: Map<string, string>;\r\n  /** R\u00E9sultats individuels de copie */\r\n  results: CopyVariableResult[];\r\n  /** Succ\u00E8s global */\r\n  success: boolean;\r\n  /** Message d'erreur \u00E9ventuel */\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * \uD83D\uDD17 COPIE MASSIVE DE VARIABLES LI\u00C9ES\r\n * \r\n * Cette fonction :\r\n * 1. Lit l'ID du n\u0153ud source avec ses linkedVariableIds\r\n * 2. Pour chaque ID de variable li\u00E9, r\u00E9cup\u00E8re la variable\r\n * 3. Copie la variable avec son suffixe\r\n * 4. Copie les donn\u00E9es associ\u00E9es (capacit\u00E9s, formules, conditions, tables)\r\n * 5. Met \u00E0 jour les r\u00E9f\u00E9rences bidirectionnelles\r\n * \r\n * CONTEXTE D'UTILISATION :\r\n * Si un n\u0153ud a des linkedVariableIds = ['varA', 'varB', 'varC'],\r\n * cette fonction va copier ces 3 variables + toutes leurs capacit\u00E9s.\r\n * Les champs existent d\u00E9j\u00E0 dans le nouveau n\u0153ud avec le suffixe.\r\n * \r\n * @param sourceNodeId - ID du n\u0153ud source (contient linkedVariableIds)\r\n * @param newNodeId - ID du nouveau n\u0153ud destination\r\n * @param suffix - Suffixe num\u00E9rique \u00E0 appliquer\r\n * @param prisma - Instance Prisma Client\r\n * @param options - Options avec maps de r\u00E9f\u00E9rences (formules, conditions, tables)\r\n * @returns R\u00E9sultat de la copie massif\r\n * \r\n * @example\r\n * // Copier toutes les variables li\u00E9es du n\u0153ud 'node-abc' vers 'node-abc-1'\r\n * const result = await copyLinkedVariablesFromNode(\r\n *   'node-abc',\r\n *   'node-abc-1',\r\n *   1,\r\n *   prisma,\r\n *   { formulaIdMap, conditionIdMap, tableIdMap }\r\n * );\r\n * console.log(`${result.count} variables copi\u00E9es`);\r\n * // Acc\u00E9der \u00E0 la map : result.variableIdMap.get('oldVarId') \u2192 'oldVarId-1'\r\n */\r\nexport async function copyLinkedVariablesFromNode(\r\n  sourceNodeId: string,\r\n  newNodeId: string,\r\n  suffix: number,\r\n  prisma: PrismaClient,\r\n  options: CopyVariableOptions = {}\r\n): Promise<CopyLinkedVariablesResult> {\r\n\r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uD83D\uDD17 COPIE VARIABLES LI\u00C9ES DU N\u0152UD`);\r\n  console.log(`   Source: ${sourceNodeId}`);\r\n  console.log(`   Destination: ${newNodeId}`);\r\n  console.log(`   Suffixe: ${suffix}`);\r\n  console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n  try {\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // 1\uFE0F\u20E3 R\u00C9CUP\u00C9RER LE N\u0152UD SOURCE ET SES linkedVariableIds\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    const sourceNode = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: sourceNodeId },\r\n      select: { linkedVariableIds: true }\r\n    });\r\n\r\n    if (!sourceNode) {\r\n      console.error(`\u274C N\u0153ud source introuvable: ${sourceNodeId}`);\r\n      return {\r\n        count: 0,\r\n        variableIdMap: new Map(),\r\n        results: [],\r\n        success: false,\r\n        error: `N\u0153ud source introuvable: ${sourceNodeId}`\r\n      };\r\n    }\r\n\r\n    const linkedVarIds = sourceNode.linkedVariableIds || [];\r\n    console.log(`\uD83D\uDCCB ${linkedVarIds.length} variables li\u00E9es trouv\u00E9es`);\r\n    \r\n    if (linkedVarIds.length === 0) {\r\n      console.log(`\u26A0\uFE0F Aucune variable li\u00E9e \u00E0 copier`);\r\n      return {\r\n        count: 0,\r\n        variableIdMap: new Map(),\r\n        results: [],\r\n        success: true\r\n      };\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // 2\uFE0F\u20E3 COPIER CHAQUE VARIABLE LI\u00C9E\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    const variableIdMap = new Map<string, string>();\r\n    const results: CopyVariableResult[] = [];\r\n\r\n    console.log(`\\n\uD83D\uDCDD Copie de ${linkedVarIds.length} variables...`);\r\n\r\n    for (let i = 0; i < linkedVarIds.length; i++) {\r\n      const varId = linkedVarIds[i];\r\n      console.log(`\\n[${i + 1}/${linkedVarIds.length}] \uD83D\uDD04 Copie variable: ${varId}`);\r\n\r\n      try {\r\n        // Copier la variable avec toutes ses capacit\u00E9s\r\n        const result = await copyVariableWithCapacities(\r\n          varId,\r\n          suffix,\r\n          newNodeId,\r\n          prisma,\r\n          options\r\n        );\r\n\r\n        if (result.success) {\r\n          variableIdMap.set(varId, result.variableId);\r\n          console.log(`\u2705 Variable copi\u00E9e: ${varId} \u2192 ${result.variableId}`);\r\n        } else {\r\n          console.error(`\u274C \u00C9chec copie: ${result.error}`);\r\n        }\r\n\r\n        results.push(result);\r\n      } catch (e) {\r\n        console.error(`\u274C Exception lors de la copie: ${(e as Error).message}`);\r\n        results.push({\r\n          variableId: '',\r\n          exposedKey: '',\r\n          capacityType: null,\r\n          sourceRef: null,\r\n          success: false,\r\n          error: (e as Error).message\r\n        });\r\n      }\r\n    }\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // 3\uFE0F\u20E3 MISE \u00C0 JOUR DU N\u0152UD DESTINATION : linkedVariableIds\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    const newVarIds = Array.from(variableIdMap.values());\r\n    \r\n    console.log(`\\n\uD83D\uDD17 Mise \u00E0 jour linkedVariableIds du n\u0153ud destination...`);\r\n    console.log(`   IDs \u00E0 ajouter: ${newVarIds.join(', ')}`);\r\n\r\n    await addToNodeLinkedField(prisma, newNodeId, 'linkedVariableIds', newVarIds);\r\n    \r\n    console.log(`\u2705 linkedVariableIds mis \u00E0 jour pour le n\u0153ud ${newNodeId}`);\r\n\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    // \uD83D\uDCCA R\u00C9SUM\u00C9\r\n    // \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n    const successCount = results.filter(r => r.success).length;\r\n    const failureCount = results.length - successCount;\r\n\r\n    console.log(`\\n${'\u2550'.repeat(80)}`);\r\n    console.log(`\uD83D\uDCCA R\u00C9SUM\u00C9 COPIE VARIABLES LI\u00C9ES`);\r\n    console.log(`   \u2705 Succ\u00E8s: ${successCount}/${linkedVarIds.length}`);\r\n    console.log(`   \u274C \u00C9checs: ${failureCount}/${linkedVarIds.length}`);\r\n    console.log(`   \uD83D\uDDFA\uFE0F Map: ${variableIdMap.size} entr\u00E9es`);\r\n    console.log(`${'\u2550'.repeat(80)}\\n`);\r\n\r\n    return {\r\n      count: successCount,\r\n      variableIdMap,\r\n      results,\r\n      success: failureCount === 0\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C Erreur globale lors de la copie de variables li\u00E9es:`, error);\r\n    return {\r\n      count: 0,\r\n      variableIdMap: new Map(),\r\n      results: [],\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error)\r\n    };\r\n  }\r\n}\r\n ", "/**\r\n * \uD83C\uDFAF Copier les tables des SELECTORS apr\u00E8s la copie de n\u0153uds\r\n * \r\n * Quand on duplique un repeater qui contient des selecteurs,\r\n * les selecteurs sont copi\u00E9s comme des n\u0153uds (avec leurs IDs remapp\u00E9s),\r\n * mais leurs tables associ\u00E9es (linkedTableIds) ne sont PAS copi\u00E9es!\r\n * \r\n * Cette fonction g\u00E8re \u00E7a:\r\n * 1. Cherche tous les n\u0153uds SELECTORS dans la copie\r\n * 2. Pour chaque selector avec table_activeId, copie sa table\r\n * 3. Met \u00E0 jour le selector avec la nouvelle table copi\u00E9e\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { copyTableCapacity } from './copy-capacity-table.js';\r\n\r\nexport interface CopySelectorTablesOptions {\r\n  nodeIdMap: Map<string, string>;\r\n  tableCopyCache: Map<string, string>;\r\n  tableIdMap: Map<string, string>;\r\n}\r\n\r\n/**\r\n * Copie les tables des selectors APR\u00C8S la duplication de n\u0153uds\r\n */\r\nexport async function copySelectorTablesAfterNodeCopy(\r\n  prisma: PrismaClient,\r\n  copiedRootNodeId: string,\r\n  originalRootNodeId: string,\r\n  options: CopySelectorTablesOptions,\r\n  suffix: number\r\n): Promise<void> {\r\n  console.log(`\\n${'\u2550'.repeat(80)}`);\r\n  console.log(`\uD83C\uDFAF COPIE DES TABLES DES SELECTORS`);\r\n  console.log(`   copiedRootNodeId: ${copiedRootNodeId}`);\r\n  console.log(`   suffix: ${suffix}`);\r\n  console.log(`${'\u2550'.repeat(80)}`);\r\n\r\n  try {\r\n    // 1\uFE0F\u20E3 Chercher le n\u0153ud copi\u00E9 et tous ses descendants\r\n    const getAllDescendants = async (nodeId: string): Promise<string[]> => {\r\n      const results: string[] = [];\r\n      const queue = [nodeId];\r\n\r\n      while (queue.length > 0) {\r\n        const currentId = queue.shift()!;\r\n        results.push(currentId);\r\n\r\n        const children = await prisma.treeBranchLeafNode.findMany({\r\n          where: { parentId: currentId },\r\n          select: { id: true }\r\n        });\r\n\r\n        queue.push(...children.map(c => c.id));\r\n      }\r\n\r\n      return results;\r\n    };\r\n\r\n    // AUSSI chercher les descendants ORIGINAUX pour les mapper\r\n    const originalNodeIds = await getAllDescendants(originalRootNodeId);\r\n    const copiedNodeIds = await getAllDescendants(copiedRootNodeId);\r\n    \r\n    console.log(`\uD83D\uDCCB ${copiedNodeIds.length} n\u0153uds trouv\u00E9s dans l'arborescence copi\u00E9e`);\r\n    console.log(`\uD83D\uDCCB ${originalNodeIds.length} n\u0153uds trouv\u00E9s dans l'arborescence originale`);\r\n\r\n    // 2\uFE0F\u20E3 Chercher les n\u0153uds ORIGINAUX avec table_activeId\r\n    const selectorsInOriginal = await prisma.treeBranchLeafNode.findMany({\r\n      where: {\r\n        id: { in: originalNodeIds },\r\n        table_activeId: { not: null }\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        type: true,\r\n        table_activeId: true,\r\n        linkedTableIds: true\r\n      }\r\n    });\r\n\r\n    console.log(`\uD83D\uDD0D ${selectorsInOriginal.length} selector(s) trouv\u00E9(s) dans l'ORIGINAL`);\r\n\r\n    // 3\uFE0F\u20E3 Pour chaque selector ORIGINAL, trouver son \u00E9quivalent COPI\u00C9 et copier sa table\r\n    for (const originalSelector of selectorsInOriginal) {\r\n      const originalTableId = originalSelector.table_activeId;\r\n      if (!originalTableId) continue;\r\n\r\n      // Trouver le selector copi\u00E9 (via nodeIdMap)\r\n      const copiedSelectorId = options.nodeIdMap.get(originalSelector.id);\r\n      if (!copiedSelectorId) {\r\n        console.log(`   \u26A0\uFE0F Selector ${originalSelector.label}: pas trouv\u00E9 dans nodeIdMap`);\r\n        continue;\r\n      }\r\n\r\n      console.log(`\\n   \uD83D\uDCCD Selector: ${originalSelector.label}`);\r\n      console.log(`      - Original ID: ${originalSelector.id.substring(0, 12)}...`);\r\n      console.log(`      - Copi\u00E9 ID: ${copiedSelectorId.substring(0, 12)}...`);\r\n      console.log(`      - Table originale: ${originalTableId}`);\r\n\r\n      // Chercher la table originale du selector\r\n      const originalTable = await prisma.treeBranchLeafNodeTable.findUnique({\r\n        where: { id: originalTableId },\r\n        select: {\r\n          id: true,\r\n          nodeId: true,\r\n          name: true,\r\n          meta: true,\r\n          type: true,\r\n          description: true,\r\n          displayInline: true,\r\n          tableColumns: { select: { id: true } },\r\n          tableRows: { select: { id: true, cells: true } }\r\n        }\r\n      });\r\n\r\n      if (!originalTable) {\r\n        console.log(`      \u274C Table ${originalTableId} NOT FOUND`);\r\n        continue;\r\n      }\r\n\r\n      console.log(`      \u2705 Table trouv\u00E9e: ${originalTable.name} (${originalTable.tableRows.length} lignes)`);\r\n\r\n      // Copier la table avec la bonne signature\r\n      try {\r\n        console.log(`      \uD83D\uDD04 Appel copyTableCapacity...`);\r\n        console.log(`         - originalTableId: ${originalTableId}`);\r\n        console.log(`         - copiedSelectorId (newNodeId): ${copiedSelectorId}`);\r\n        console.log(`         - suffix: ${suffix}`);\r\n        \r\n        const result = await copyTableCapacity(\r\n          originalTableId,  // ID de la table originale\r\n          copiedSelectorId, // \uD83D\uDC48 Le n\u0153ud selector copi\u00E9 sera propri\u00E9taire de la table copi\u00E9e\r\n          suffix,\r\n          prisma,\r\n          {\r\n            nodeIdMap: options.nodeIdMap,\r\n            tableCopyCache: options.tableCopyCache,\r\n            tableIdMap: options.tableIdMap\r\n          }\r\n        );\r\n\r\n        if (result.success) {\r\n          console.log(`      \u2705 Table copi\u00E9e: ${result.newTableId}`);\r\n          console.log(`         - Colonnes: ${result.columnsCount}`);\r\n          console.log(`         - Lignes: ${result.rowsCount}`);\r\n          console.log(`         - Cellules: ${result.cellsCount}`);\r\n\r\n          // \uD83C\uDFAF Les donn\u00E9es ont d\u00E9j\u00E0 \u00E9t\u00E9 copi\u00E9es par copyTableCapacity !\r\n          // On juste confirme que le selector pointe vers la nouvelle table\r\n          console.log(`      \u2705 Selector COPI\u00C9 automatiquement mis \u00E0 jour via copyTableCapacity`);\r\n          console.log(`         - table_activeId = ${result.newTableId}`);\r\n          console.log(`         - table_instances peupl\u00E9 avec donn\u00E9es`);\r\n        } else {\r\n          console.log(`      \u274C Erreur copie table: ${result.error}`);\r\n        }\r\n      } catch (e) {\r\n        console.warn(`      \u26A0\uFE0F Erreur lors de la copie:`, (e as Error).message);\r\n      }\r\n    }\r\n\r\n    console.log(`\\n\u2705 Copie des tables des selectors termin\u00E9e\\n`);\r\n  } catch (e) {\r\n    console.warn(`\u26A0\uFE0F Erreur dans copySelectorTablesAfterNodeCopy:`, (e as Error).message);\r\n  }\r\n}\r\n", "/**\r\n * \uD83D\uDDC2\uFE0F NOUVELLES ROUTES POUR LES TABLES - ARCHITECTURE NORMALIS\u00C9E\r\n * \r\n * Cette version utilise une architecture 100% normalis\u00E9e :\r\n * - TreeBranchLeafNodeTable : M\u00E9tadonn\u00E9es de la table\r\n * - TreeBranchLeafNodeTableColumn : Chaque colonne est une entr\u00E9e s\u00E9par\u00E9e\r\n * - TreeBranchLeafNodeTableRow : Chaque ligne est une entr\u00E9e s\u00E9par\u00E9e\r\n * \r\n * Plus de JSON volumineux, tout est stock\u00E9 de mani\u00E8re relationnelle !\r\n */\r\n\r\nimport { Router } from 'express';\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\nimport { randomUUID } from 'crypto';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\ntype MinimalReqUser = { organizationId?: string | null; isSuperAdmin?: boolean; role?: string; userRole?: string };\r\ntype MinimalReq = { user?: MinimalReqUser; headers?: Record<string, unknown> };\r\n\r\nfunction getAuthCtx(req: MinimalReq): { organizationId: string | null; isSuperAdmin: boolean } {\r\n  const user: MinimalReqUser = (req && req.user) || {};\r\n  const headerOrg: string | undefined = (req?.headers?.['x-organization-id'] as string)\r\n    || (req?.headers?.['x-organization'] as string)\r\n    || (req?.headers?.['organization-id'] as string);\r\n  const role: string | undefined = user.role || user.userRole;\r\n  const isSuperAdmin = Boolean(user.isSuperAdmin || role === 'super_admin' || role === 'superadmin');\r\n  const organizationId: string | null = (user.organizationId as string) || headerOrg || null;\r\n  return { organizationId, isSuperAdmin };\r\n}\r\n\r\n// =============================================================================\r\n// POST /api/treebranchleaf/nodes/:nodeId/tables - Cr\u00E9er une table\r\n// =============================================================================\r\nrouter.post('/nodes/:nodeId/tables', async (req, res) => {\r\n  const { nodeId } = req.params;\r\n  const { name, description, columns, rows, type = 'static' } = req.body;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n  console.log(`[NEW POST /tables] \uD83D\uDE80 D\u00E9but cr\u00E9ation table pour node ${nodeId}`);\r\n  console.log(`[NEW POST /tables] \uD83D\uDCCA Donn\u00E9es re\u00E7ues: ${Array.isArray(columns) ? columns.length : 0} colonnes, ${Array.isArray(rows) ? rows.length : 0} lignes`);\r\n\r\n  if (!name) {\r\n    return res.status(400).json({ error: 'Le nom de la table est requis' });\r\n  }\r\n  if (!Array.isArray(columns)) {\r\n    return res.status(400).json({ error: 'La d\u00E9finition des colonnes est requise (array)' });\r\n  }\r\n  if (!Array.isArray(rows)) {\r\n    return res.status(400).json({ error: 'Les donn\u00E9es (rows) sont requises (array)' });\r\n  }\r\n\r\n  try {\r\n    // V\u00E9rifier que le n\u0153ud existe et appartient \u00E0 l'organisation\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      include: { TreeBranchLeafTree: true }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u0153ud non trouv\u00E9' });\r\n    }\r\n    if (!isSuperAdmin && organizationId && node.TreeBranchLeafTree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9 \u00E0 ce n\u0153ud' });\r\n    }\r\n\r\n    const tableId = randomUUID();\r\n    console.log(`[NEW POST /tables] \uD83C\uDD94 Nouvel ID de table g\u00E9n\u00E9r\u00E9: ${tableId}`);\r\n\r\n    // Pr\u00E9parer les donn\u00E9es pour la transaction\r\n    const tableData = {\r\n      id: tableId,\r\n      nodeId,\r\n      organizationId: node.TreeBranchLeafTree.organizationId,\r\n      name,\r\n      description: description || null,\r\n      type,\r\n      rowCount: rows.length,\r\n      columnCount: columns.length,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    // Pr\u00E9parer les colonnes\r\n    const tableColumnsData = columns.map((col: any, index: number) => {\r\n      const colName = typeof col === 'string' ? col : (col.name || `Colonne ${index + 1}`);\r\n      const colType = typeof col === 'object' && col.type ? col.type : 'text';\r\n      const colWidth = typeof col === 'object' && col.width ? col.width : null;\r\n      const colFormat = typeof col === 'object' && col.format ? col.format : null;\r\n      const colMetadata = typeof col === 'object' && col.metadata ? col.metadata : {};\r\n\r\n      return {\r\n        tableId: tableId,\r\n        columnIndex: index,\r\n        name: colName,\r\n        type: colType,\r\n        width: colWidth,\r\n        format: colFormat,\r\n        metadata: colMetadata as Prisma.InputJsonValue,\r\n      };\r\n    });\r\n\r\n    // Pr\u00E9parer les lignes\r\n    const tableRowsData = rows.map((row, index) => ({\r\n      tableId: tableId,\r\n      rowIndex: index,\r\n      cells: row as Prisma.InputJsonValue,\r\n    }));\r\n\r\n    console.log(`[NEW POST /tables] \uD83D\uDCE6 Transaction pr\u00E9par\u00E9e: 1 table + ${tableColumnsData.length} colonnes + ${tableRowsData.length} lignes`);\r\n    console.log(`[NEW POST /tables] \uD83D\uDD0D ANALYSE D\u00C9TAILL\u00C9E DES ROWS:`);\r\n    console.log(`[NEW POST /tables]    - Type de rows re\u00E7u: ${Array.isArray(rows) ? 'array' : typeof rows}`);\r\n    console.log(`[NEW POST /tables]    - rows.length: ${rows.length}`);\r\n    console.log(`[NEW POST /tables]    - rows[0] (premi\u00E8re ligne):`, rows[0]);\r\n    console.log(`[NEW POST /tables]    - rows[0][0] (A1):`, rows[0]?.[0]);\r\n    console.log(`[NEW POST /tables]    - rows[0][1-3] (premi\u00E8res donn\u00E9es):`, rows[0]?.slice(1, 4));\r\n    console.log(`[NEW POST /tables]    - rows[1] (deuxi\u00E8me ligne):`, rows[1]);\r\n    console.log(`[NEW POST /tables]    - rows[1][0] (label ligne 2):`, rows[1]?.[0]);\r\n    console.log(`[NEW POST /tables]    - rows[derni\u00E8re]:`, rows[rows.length - 1]);\r\n    console.log(`[NEW POST /tables] \uD83D\uDD0D ANALYSE TABLEROWSDATA (apr\u00E8s map):`);\r\n    console.log(`[NEW POST /tables]    - tableRowsData[0].cells:`, tableRowsData[0].cells);\r\n    console.log(`[NEW POST /tables]    - tableRowsData[1].cells:`, tableRowsData[1].cells);\r\n    console.log(`[NEW POST /tables]    - tableRowsData[derni\u00E8re].cells:`, tableRowsData[tableRowsData.length - 1].cells);\r\n\r\n    // Ex\u00E9cuter la cr\u00E9ation dans une transaction atomique\r\n    // \u26A0\uFE0F TIMEOUT AUGMENT\u00C9 pour les gros fichiers (43k+ lignes)\r\n    const result = await prisma.$transaction(async (tx) => {\r\n      console.log(`[NEW POST /tables] \uD83D\uDD04 \u00C9tape 1/3: Cr\u00E9ation de la table principale...`);\r\n      const newTable = await tx.treeBranchLeafNodeTable.create({\r\n        data: tableData,\r\n      });\r\n\r\n      if (tableColumnsData.length > 0) {\r\n        console.log(`[NEW POST /tables] \uD83D\uDD04 \u00C9tape 2/3: Insertion de ${tableColumnsData.length} colonnes...`);\r\n        await tx.treeBranchLeafNodeTableColumn.createMany({\r\n          data: tableColumnsData,\r\n        });\r\n      }\r\n\r\n      if (tableRowsData.length > 0) {\r\n        console.log(`[NEW POST /tables] \uD83D\uDD04 \u00C9tape 3/3: Insertion de ${tableRowsData.length} lignes...`);\r\n        \r\n        // \u26A0\uFE0F IMPORTANT: createMany ne supporte PAS les champs JSONB !\r\n        // Il faut utiliser create() en boucle pour pr\u00E9server les arrays JSON\r\n        for (const rowData of tableRowsData) {\r\n          await tx.treeBranchLeafNodeTableRow.create({\r\n            data: rowData,\r\n          });\r\n        }\r\n        \r\n        console.log(`[NEW POST /tables] \u2705 Lignes ins\u00E9r\u00E9es ! V\u00E9rification...`);\r\n        // V\u00E9rifier les 3 premi\u00E8res lignes ins\u00E9r\u00E9es\r\n        const verif = await tx.treeBranchLeafNodeTableRow.findMany({\r\n          where: { tableId },\r\n          orderBy: { rowIndex: 'asc' },\r\n          take: 3\r\n        });\r\n        console.log(`[NEW POST /tables] \uD83D\uDD0D V\u00C9RIFICATION POST-INSERTION:`);\r\n        verif.forEach((row, idx) => {\r\n          console.log(`[NEW POST /tables]    - Ligne ${idx} (rowIndex=${row.rowIndex}):`);\r\n          console.log(`[NEW POST /tables]      cells type:`, typeof row.cells);\r\n          console.log(`[NEW POST /tables]      cells value:`, row.cells);\r\n          if (typeof row.cells === 'string') {\r\n            try {\r\n              const parsed = JSON.parse(row.cells);\r\n              console.log(`[NEW POST /tables]      cells[0] apr\u00E8s parse:`, parsed[0]);\r\n            } catch (e) {\r\n              console.log(`[NEW POST /tables]      \u274C Erreur parse:`, e.message);\r\n            }\r\n          } else if (Array.isArray(row.cells)) {\r\n            console.log(`[NEW POST /tables]      cells[0]:`, row.cells[0]);\r\n            console.log(`[NEW POST /tables]      cells.length:`, row.cells.length);\r\n          }\r\n        });\r\n      }\r\n\r\n      return newTable;\r\n    }, {\r\n      timeout: 60000, // 60 secondes pour les gros fichiers (43k+ lignes)\r\n    });\r\n\r\n    console.log(`[NEW POST /tables] \u2705 Transaction termin\u00E9e avec succ\u00E8s ! Table ${result.id} cr\u00E9\u00E9e.`);\r\n\r\n    // \uD83C\uDFAF Mettre \u00E0 jour hasTable du n\u0153ud\r\n    await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: { hasTable: true }\r\n    });\r\n    console.log(`[NEW POST /tables] \u2705 hasTable mis \u00E0 jour pour node ${nodeId}`);\r\n\r\n    // \uD83D\uDCCA MAJ linkedTableIds du n\u0153ud propri\u00E9taire\r\n    try {\r\n      const node = await prisma.treeBranchLeafNode.findUnique({ where: { id: nodeId }, select: { linkedTableIds: true } });\r\n      const current = node?.linkedTableIds ?? [];\r\n      const next = Array.from(new Set([...(current || []), result.id]));\r\n      await prisma.treeBranchLeafNode.update({ where: { id: nodeId }, data: { linkedTableIds: { set: next } } });\r\n    } catch (e) {\r\n      console.warn('[NEW POST /tables] Warning updating linkedTableIds:', (e as Error).message);\r\n    }\r\n\r\n    // \uFFFD\uD83D\uDD04 MISE \u00C0 JOUR AUTOMATIQUE DES SELECT CONFIGS\r\n    // Si d'autres champs r\u00E9f\u00E9rencent une ancienne table pour ce m\u00EAme n\u0153ud,\r\n    // on les met \u00E0 jour pour pointer vers la nouvelle table\r\n    try {\r\n      console.log(`[NEW POST /tables] \uD83D\uDD0D Recherche des SelectConfigs \u00E0 mettre \u00E0 jour pour nodeId: ${nodeId}`);\r\n      \r\n      // Trouver la SelectConfig de ce n\u0153ud (s'il en a une)\r\n      const selectConfig = await prisma.treeBranchLeafSelectConfig.findFirst({\r\n        where: { nodeId },\r\n      });\r\n      \r\n      if (selectConfig) {\r\n        const oldTableRef = selectConfig.tableReference;\r\n        \r\n        // Mettre \u00E0 jour vers la nouvelle table\r\n        await prisma.treeBranchLeafSelectConfig.update({\r\n          where: { id: selectConfig.id },\r\n          data: { tableReference: result.id },\r\n        });\r\n        \r\n        console.log(`[NEW POST /tables] \u2705 SelectConfig mis \u00E0 jour: ${selectConfig.id}`);\r\n        console.log(`[NEW POST /tables]    - Ancien tableau: ${oldTableRef}`);\r\n        console.log(`[NEW POST /tables]    - Nouveau tableau: ${result.id}`);\r\n        \r\n        // Chercher d'autres champs qui utilisaient l'ancien tableau (crossover tables)\r\n        if (oldTableRef) {\r\n          const otherConfigs = await prisma.treeBranchLeafSelectConfig.findMany({\r\n            where: { \r\n              tableReference: oldTableRef,\r\n              nodeId: { not: nodeId } // Exclure celui qu'on vient de mettre \u00E0 jour\r\n            },\r\n          });\r\n          \r\n          if (otherConfigs.length > 0) {\r\n            console.log(`[NEW POST /tables] \uD83D\uDD0D ${otherConfigs.length} autres SelectConfigs r\u00E9f\u00E9rencent l'ancien tableau`);\r\n            \r\n            // Mettre \u00E0 jour tous les autres\r\n            const updateResult = await prisma.treeBranchLeafSelectConfig.updateMany({\r\n              where: { \r\n                tableReference: oldTableRef,\r\n                nodeId: { not: nodeId }\r\n              },\r\n              data: { tableReference: result.id }\r\n            });\r\n            \r\n            console.log(`[NEW POST /tables] \u2705 ${updateResult.count} SelectConfigs suppl\u00E9mentaires mis \u00E0 jour`);\r\n            otherConfigs.forEach(cfg => {\r\n              console.log(`[NEW POST /tables]    - NodeId: ${cfg.nodeId} (keyColumn: ${cfg.keyColumn}, keyRow: ${cfg.keyRow})`);\r\n            });\r\n          }\r\n        }\r\n      } else {\r\n        console.log(`[NEW POST /tables] \u2139\uFE0F Pas de SelectConfig trouv\u00E9e pour ce n\u0153ud`);\r\n      }\r\n    } catch (updateError) {\r\n      console.error(`[NEW POST /tables] \u26A0\uFE0F Erreur lors de la mise \u00E0 jour des SelectConfigs:`, updateError);\r\n      // Ne pas bloquer la r\u00E9ponse m\u00EAme si la mise \u00E0 jour \u00E9choue\r\n    }\r\n\r\n    // \uD83D\uDD04 Recharger la table avec colonnes et lignes pour renvoyer au frontend\r\n    const createdTable = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id: result.id },\r\n      include: {\r\n        tableColumns: {\r\n          orderBy: { columnIndex: 'asc' },\r\n        },\r\n        tableRows: {\r\n          orderBy: { rowIndex: 'asc' },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!createdTable) {\r\n      throw new Error('Table cr\u00E9\u00E9e mais introuvable lors de la relecture');\r\n    }\r\n\r\n    // Formater la r\u00E9ponse avec colonnes et lignes\r\n    res.status(201).json({\r\n      id: createdTable.id,\r\n      nodeId: createdTable.nodeId,\r\n      name: createdTable.name,\r\n      description: createdTable.description,\r\n      type: createdTable.type,\r\n      columns: createdTable.tableColumns.map(c => c.name),\r\n      rows: createdTable.tableRows.map(r => {\r\n        // Convertir JSONB Prisma \u2192 Array JavaScript natif\r\n        const cells = r.cells;\r\n        if (Array.isArray(cells)) {\r\n          return cells;\r\n        }\r\n        if (typeof cells === 'string') {\r\n          try {\r\n            const parsed = JSON.parse(cells);\r\n            return Array.isArray(parsed) ? parsed : [String(parsed)];\r\n          } catch {\r\n            return [String(cells)];\r\n          }\r\n        }\r\n        if (cells && typeof cells === 'object') {\r\n          return Object.values(cells);\r\n        }\r\n        return [String(cells || '')];\r\n      }),\r\n      meta: createdTable.meta || {},\r\n      rowCount: createdTable.rowCount,\r\n      columnCount: createdTable.columnCount,\r\n      createdAt: createdTable.createdAt,\r\n      updatedAt: createdTable.updatedAt,\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C [NEW POST /tables] Erreur lors de la cr\u00E9ation de la table:`, error);\r\n    if (error instanceof Prisma.PrismaClientKnownRequestError) {\r\n      return res.status(500).json({ \r\n        error: 'Erreur de base de donn\u00E9es lors de la cr\u00E9ation de la table.',\r\n        code: error.code,\r\n        meta: error.meta,\r\n      });\r\n    }\r\n    res.status(500).json({ error: 'Impossible de cr\u00E9er la table' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// GET /api/treebranchleaf/tables/:id - R\u00E9cup\u00E9rer une table avec pagination\r\n// =============================================================================\r\nrouter.get('/tables/:id', async (req, res) => {\r\n  const { id } = req.params;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n  \r\n  // Param\u00E8tres de pagination\r\n  const page = parseInt(req.query.page as string) || 1;\r\n  const limit = parseInt(req.query.limit as string) || 100;\r\n  const offset = (page - 1) * limit;\r\n\r\n  console.log(`[NEW GET /tables/:id] \uD83D\uDCD6 R\u00E9cup\u00E9ration table ${id} (page ${page}, limit ${limit})`);\r\n\r\n  try {\r\n    // R\u00E9cup\u00E9rer la table\r\n    const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            treeId: true,\r\n            TreeBranchLeafTree: {\r\n              select: { organizationId: true }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!table) {\r\n      return res.status(404).json({ error: 'Table non trouv\u00E9e' });\r\n    }\r\n\r\n    // V\u00E9rification de l'organisation\r\n    const tableOrgId = table.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9 \u00E0 cette table' });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer les colonnes\r\n    const columns = await prisma.treeBranchLeafNodeTableColumn.findMany({\r\n      where: { tableId: id },\r\n      orderBy: { columnIndex: 'asc' },\r\n    });\r\n\r\n    // R\u00E9cup\u00E9rer les lignes pagin\u00E9es\r\n    const rows = await prisma.treeBranchLeafNodeTableRow.findMany({\r\n      where: { tableId: id },\r\n      orderBy: { rowIndex: 'asc' },\r\n      take: limit,\r\n      skip: offset,\r\n    });\r\n\r\n    console.log(`[NEW GET /tables/:id] \u2705 R\u00E9cup\u00E9r\u00E9: ${columns.length} colonnes et ${rows.length} lignes (sur ${table.rowCount} total)`);\r\n\r\n    // Renvoyer la r\u00E9ponse compl\u00E8te\r\n    res.json({\r\n      id: table.id,\r\n      nodeId: table.nodeId,\r\n      name: table.name,\r\n      description: table.description,\r\n      type: table.type,\r\n      columns: columns.map(c => ({\r\n        name: c.name,\r\n        type: c.type,\r\n        width: c.width,\r\n        format: c.format,\r\n        metadata: c.metadata,\r\n      })),\r\n      rows: rows.map(r => r.cells),\r\n      page,\r\n      limit,\r\n      totalRows: table.rowCount,\r\n      totalPages: Math.ceil(table.rowCount / limit),\r\n      createdAt: table.createdAt,\r\n      updatedAt: table.updatedAt,\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C [NEW GET /tables/:id] Erreur lors de la r\u00E9cup\u00E9ration de la table:`, error);\r\n    res.status(500).json({ error: 'Impossible de r\u00E9cup\u00E9rer la table' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// PUT /api/treebranchleaf/tables/:id - Mettre \u00E0 jour une table\r\n// =============================================================================\r\nrouter.put('/tables/:id', async (req, res) => {\r\n  const { id } = req.params;\r\n  const { name, description, columns, rows, type, lookupSelectColumn, lookupDisplayColumns } = req.body;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n  console.log(`[NEW PUT /tables/:id] \uD83D\uDD04 Mise \u00E0 jour table ${id}`);\r\n  console.log(`[NEW PUT /tables/:id] Nouvelles donn\u00E9es: ${Array.isArray(columns) ? columns.length : 'N/A'} colonnes, ${Array.isArray(rows) ? rows.length : 'N/A'} lignes`);\r\n  console.log(`[NEW PUT /tables/:id] Lookup config: selectColumn=${lookupSelectColumn}, displayColumns=${JSON.stringify(lookupDisplayColumns)}`);\r\n\r\n  try {\r\n    const updatedTable = await prisma.$transaction(async (tx) => {\r\n      // V\u00E9rifier l'existence et les permissions\r\n      const table = await tx.treeBranchLeafNodeTable.findUnique({\r\n        where: { id },\r\n        include: {\r\n          TreeBranchLeafNode: {\r\n            include: { TreeBranchLeafTree: true }\r\n          }\r\n        }\r\n      });\r\n\r\n      if (!table) {\r\n        throw new Error('Table non trouv\u00E9e');\r\n      }\r\n\r\n      const tableOrgId = table.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n      if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n        throw new Error('Acc\u00E8s non autoris\u00E9');\r\n      }\r\n\r\n      // Pr\u00E9parer les donn\u00E9es de mise \u00E0 jour\r\n      const updateData: Prisma.TreeBranchLeafNodeTableUpdateInput = {\r\n        updatedAt: new Date(),\r\n      };\r\n      if (name) updateData.name = name;\r\n      if (description !== undefined) updateData.description = description;\r\n      if (type) updateData.type = type;\r\n      if (Array.isArray(columns)) updateData.columnCount = columns.length;\r\n      if (Array.isArray(rows)) updateData.rowCount = rows.length;\r\n      \r\n      // \uD83D\uDD25 AJOUT: Sauvegarder la configuration du lookup\r\n      if (lookupSelectColumn !== undefined) updateData.lookupSelectColumn = lookupSelectColumn;\r\n      if (Array.isArray(lookupDisplayColumns)) updateData.lookupDisplayColumns = lookupDisplayColumns;\r\n\r\n      // Mettre \u00E0 jour la table principale\r\n      const tableUpdated = await tx.treeBranchLeafNodeTable.update({\r\n        where: { id },\r\n        data: updateData,\r\n      });\r\n      console.log(`[NEW PUT /tables/:id] \u2705 \u00C9tape 1: Table principale mise \u00E0 jour`);\r\n\r\n      // Si de nouvelles colonnes sont fournies, les remplacer\r\n      if (Array.isArray(columns)) {\r\n        console.log(`[NEW PUT /tables/:id] \uD83D\uDD04 Remplacement des colonnes...`);\r\n        await tx.treeBranchLeafNodeTableColumn.deleteMany({ where: { tableId: id } });\r\n        \r\n        if (columns.length > 0) {\r\n          const newColumnsData = columns.map((col: any, index: number) => ({\r\n            tableId: id,\r\n            columnIndex: index,\r\n            name: typeof col === 'string' ? col : (col.name || `Colonne ${index + 1}`),\r\n            type: typeof col === 'object' ? col.type : 'text',\r\n            width: typeof col === 'object' ? col.width : null,\r\n            format: typeof col === 'object' ? col.format : null,\r\n            metadata: typeof col === 'object' && col.metadata ? col.metadata : {},\r\n          }));\r\n          await tx.treeBranchLeafNodeTableColumn.createMany({ data: newColumnsData });\r\n        }\r\n        console.log(`[NEW PUT /tables/:id] \u2705 \u00C9tape 2: ${columns.length} colonnes remplac\u00E9es`);\r\n      }\r\n\r\n      // Si de nouvelles lignes sont fournies, les remplacer\r\n      if (Array.isArray(rows)) {\r\n        console.log(`[NEW PUT /tables/:id] \uD83D\uDD04 Remplacement des lignes...`);\r\n        await tx.treeBranchLeafNodeTableRow.deleteMany({ where: { tableId: id } });\r\n        \r\n        if (rows.length > 0) {\r\n          // \u26A0\uFE0F CRITIQUE: Utiliser create() en boucle au lieu de createMany()\r\n          // Prisma createMany() NE SUPPORTE PAS les champs JSONB correctement !\r\n          console.log(`[NEW PUT /tables/:id] \uD83D\uDD04 Cr\u00E9ation de ${rows.length} lignes (boucle create)...`);\r\n          for (let index = 0; index < rows.length; index++) {\r\n            const row = rows[index];\r\n            await tx.treeBranchLeafNodeTableRow.create({\r\n              data: {\r\n                tableId: id,\r\n                rowIndex: index,\r\n                cells: row as Prisma.InputJsonValue,\r\n              }\r\n            });\r\n            console.log(`[PUT /tables/:id] Row ${index} created, cells.length:`, Array.isArray(row) ? row.length : 'N/A');\r\n          }\r\n        }\r\n        console.log(`[NEW PUT /tables/:id] \u2705 \u00C9tape 3: ${rows.length} lignes remplac\u00E9es`);\r\n      }\r\n\r\n      return tableUpdated;\r\n    });\r\n\r\n    console.log(`[NEW PUT /tables/:id] \uD83C\uDF89 Transaction de mise \u00E0 jour termin\u00E9e avec succ\u00E8s`);\r\n    \r\n    const finalTableData = await prisma.treeBranchLeafNodeTable.findUnique({ where: { id } });\r\n    res.json(finalTableData);\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C [NEW PUT /tables/:id] Erreur lors de la mise \u00E0 jour:`, error);\r\n    if (error instanceof Error && (error.message === 'Table non trouv\u00E9e' || error.message === 'Acc\u00E8s non autoris\u00E9')) {\r\n      const status = error.message === 'Table non trouv\u00E9e' ? 404 : 403;\r\n      return res.status(status).json({ error: error.message });\r\n    }\r\n    res.status(500).json({ error: 'Impossible de mettre \u00E0 jour la table' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// DELETE /api/treebranchleaf/tables/:id - Supprimer une table\r\n// =============================================================================\r\nrouter.delete('/tables/:id', async (req, res) => {\r\n  const { id } = req.params;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n  console.log(`[NEW DELETE /tables/:id] \uD83D\uDDD1\uFE0F Suppression table ${id}`);\r\n\r\n  try {\r\n    // V\u00E9rifier l'existence et les permissions\r\n    const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          include: { TreeBranchLeafTree: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!table) {\r\n      return res.status(404).json({ error: 'Table non trouv\u00E9e' });\r\n    }\r\n\r\n    const tableOrgId = table.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n    if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9' });\r\n    }\r\n\r\n    // 1\uFE0F\u20E3 Supprimer la table (les colonnes et lignes seront supprim\u00E9es en cascade via Prisma)\r\n    await prisma.treeBranchLeafNodeTable.delete({ where: { id } });\r\n    console.log(`[NEW DELETE /tables/:id] \u2705 Table ${id} supprim\u00E9e (+ colonnes/lignes en cascade)`);\r\n\r\n    // \uD83D\uDD0D Nettoyer les champs Select/Cascader qui utilisent cette table comme lookup\r\n    // \uD83D\uDCA1 UTILISER LA M\u00CAME LOGIQUE QUE LE BOUTON \"D\u00C9SACTIVER LOOKUP\" QUI FONCTIONNE PARFAITEMENT\r\n    try {\r\n      const selectConfigsUsingTable = await prisma.treeBranchLeafSelectConfig.findMany({\r\n        where: { tableReference: id },\r\n        select: { nodeId: true }\r\n      });\r\n\r\n      if (selectConfigsUsingTable.length > 0) {\r\n        console.log(`[NEW DELETE /tables/:id] \uD83E\uDDF9 ${selectConfigsUsingTable.length} champ(s) Select/Cascader r\u00E9f\u00E9rencent cette table - D\u00C9SACTIVATION LOOKUP`);\r\n        \r\n        // Pour chaque champ, appliquer la M\u00CAME logique que le bouton \"D\u00E9sactiver lookup\"\r\n        for (const config of selectConfigsUsingTable) {\r\n          const selectNode = await prisma.treeBranchLeafNode.findUnique({\r\n            where: { id: config.nodeId },\r\n            select: { \r\n              label: true,\r\n              metadata: true\r\n            }\r\n          });\r\n\r\n          if (selectNode) {\r\n            console.log(`[NEW DELETE /tables/:id] \uD83D\uDD27 D\u00E9sactivation lookup pour \"${selectNode.label}\" (${config.nodeId})`);\r\n            \r\n            // 1\uFE0F\u20E3 Nettoyer metadata.capabilities.table (comme le fait le bouton D\u00E9sactiver)\r\n            const oldMetadata = (selectNode.metadata || {}) as Record<string, unknown>;\r\n            const oldCapabilities = (oldMetadata.capabilities || {}) as Record<string, unknown>;\r\n            const newCapabilities = {\r\n              ...oldCapabilities,\r\n              table: {\r\n                enabled: false,\r\n                activeId: null,\r\n                instances: null,\r\n                currentTable: null,\r\n              }\r\n            };\r\n            const newMetadata = {\r\n              ...oldMetadata,\r\n              capabilities: newCapabilities\r\n            };\r\n\r\n            // 2\uFE0F\u20E3 Mettre \u00E0 jour le n\u0153ud (m\u00EAme logique que PUT /capabilities/table avec enabled: false)\r\n            await prisma.treeBranchLeafNode.update({\r\n              where: { id: config.nodeId },\r\n              data: {\r\n                hasTable: false,\r\n                table_activeId: null,\r\n                table_instances: null,\r\n                table_name: null,\r\n                table_type: null,\r\n                table_meta: null,\r\n                table_columns: null,\r\n                table_rows: null,\r\n                table_data: null,\r\n                metadata: JSON.parse(JSON.stringify(newMetadata)),\r\n                select_options: [],\r\n                updatedAt: new Date()\r\n              }\r\n            });\r\n\r\n            // 3\uFE0F\u20E3 Supprimer la configuration SELECT (comme le fait le bouton D\u00E9sactiver)\r\n            await prisma.treeBranchLeafSelectConfig.deleteMany({\r\n              where: { nodeId: config.nodeId }\r\n            });\r\n            \r\n            console.log(`[NEW DELETE /tables/:id] \u2705 Lookup d\u00E9sactiv\u00E9 pour \"${selectNode.label}\" - champ d\u00E9bloqu\u00E9`);\r\n          }\r\n        }\r\n\r\n        console.log(`[NEW DELETE /tables/:id] \u2705 ${selectConfigsUsingTable.length} champ(s) Select D\u00C9BLOQU\u00C9S (lookup d\u00E9sactiv\u00E9)`);\r\n      }\r\n    } catch (selectConfigError) {\r\n      console.error(`[NEW DELETE /tables/:id] \u26A0\uFE0F Erreur d\u00E9sactivation lookups:`, selectConfigError);\r\n      // On continue quand m\u00EAme\r\n    }\r\n\r\n    // 2\uFE0F\u20E3 Nettoyer TOUS les champs li\u00E9s aux tables dans le n\u0153ud\r\n    if (table.nodeId) {\r\n      const node = await prisma.treeBranchLeafNode.findUnique({ \r\n        where: { id: table.nodeId }, \r\n        select: { \r\n          linkedTableIds: true,\r\n          table_activeId: true,\r\n          table_instances: true\r\n        } \r\n      });\r\n\r\n      // \uD83D\uDD04 Nettoyer linkedTableIds\r\n      const currentLinkedIds = node?.linkedTableIds ?? [];\r\n      const nextLinkedIds = currentLinkedIds.filter(x => x !== id);\r\n\r\n      // \uD83D\uDD04 Si la table supprim\u00E9e \u00E9tait active, r\u00E9initialiser table_activeId\r\n      const wasActiveTable = node?.table_activeId === id;\r\n      \r\n      // \uD83D\uDD04 Nettoyer table_instances (retirer l'instance de cette table)\r\n      let cleanedInstances = node?.table_instances ?? {};\r\n      if (typeof cleanedInstances === 'object' && cleanedInstances !== null) {\r\n        const instances = cleanedInstances as Record<string, unknown>;\r\n        if (instances[id]) {\r\n          delete instances[id];\r\n          cleanedInstances = instances;\r\n        }\r\n      }\r\n\r\n      // \uD83D\uDD04 Compter les tables restantes pour hasTable\r\n      const remainingTables = await prisma.treeBranchLeafNodeTable.count({\r\n        where: { nodeId: table.nodeId }\r\n      });\r\n\r\n      // \uD83D\uDCDD Mise \u00E0 jour du n\u0153ud avec TOUS les nettoyages\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: table.nodeId },\r\n        data: {\r\n          hasTable: remainingTables > 0,\r\n          linkedTableIds: { set: nextLinkedIds },\r\n          table_activeId: wasActiveTable ? null : undefined, // R\u00E9initialiser si c'\u00E9tait la table active\r\n          table_instances: cleanedInstances,\r\n          // R\u00E9initialiser les autres champs si plus de tables\r\n          ...(remainingTables === 0 && {\r\n            table_name: null,\r\n            table_type: null,\r\n            table_meta: null,\r\n            table_columns: null,\r\n            table_rows: null,\r\n            table_data: null,\r\n            table_importSource: null,\r\n            table_isImported: false\r\n          })\r\n        }\r\n      });\r\n\r\n      console.log(`[NEW DELETE /tables/:id] \u2705 N\u0153ud ${table.nodeId} nettoy\u00E9:`, {\r\n        hasTable: remainingTables > 0,\r\n        linkedTableIds: nextLinkedIds.length,\r\n        table_activeId_reset: wasActiveTable,\r\n        table_instances_cleaned: true,\r\n        all_fields_reset: remainingTables === 0\r\n      });\r\n    }\r\n\r\n    console.log(`[NEW DELETE /tables/:id] \u2705 Table ${id} supprim\u00E9e avec succ\u00E8s (+ colonnes et lignes en cascade)`);\r\n    res.json({ success: true, message: 'Table supprim\u00E9e avec succ\u00E8s' });\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C [NEW DELETE /tables/:id] Erreur lors de la suppression:`, error);\r\n    res.status(500).json({ error: 'Impossible de supprimer la table' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// ALIASES POUR COMPATIBILIT\u00C9 AVEC L'ANCIEN FORMAT D'URL\r\n// =============================================================================\r\n\r\n// Alias PUT: /nodes/:nodeId/tables/:tableId \u2192 /tables/:id\r\nrouter.put('/nodes/:nodeId/tables/:tableId', async (req, res) => {\r\n  const { tableId } = req.params;\r\n  const { name, description, columns, rows, type, meta } = req.body;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n  console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \uD83D\uDD04 Alias route - redirection vers PUT /tables/${tableId}`);\r\n  console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \uD83D\uDCCA Donn\u00E9es re\u00E7ues:`, {\r\n    hasColumns: !!columns,\r\n    hasRows: !!rows,\r\n    hasMeta: !!meta,\r\n    type\r\n  });\r\n\r\n  try {\r\n    // Si le body contient seulement meta (mise \u00E0 jour de configuration lookup)\r\n    // On ne touche PAS aux colonnes/lignes, juste les m\u00E9tadonn\u00E9es\r\n    if (meta && !columns && !rows) {\r\n      console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \u2699\uFE0F Mise \u00E0 jour m\u00E9tadonn\u00E9es uniquement (lookup config)`);\r\n      \r\n      const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n        where: { id: tableId },\r\n        include: {\r\n          TreeBranchLeafNode: {\r\n            include: { TreeBranchLeafTree: true }\r\n          }\r\n        }\r\n      });\r\n\r\n      if (!table) {\r\n        return res.status(404).json({ error: 'Table non trouv\u00E9e' });\r\n      }\r\n\r\n      const tableOrgId = table.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n      if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n        return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9' });\r\n      }\r\n\r\n      // Mise \u00E0 jour des m\u00E9tadonn\u00E9es seulement\r\n      const updatedTable = await prisma.treeBranchLeafNodeTable.update({\r\n        where: { id: tableId },\r\n        data: {\r\n          meta: meta as Prisma.InputJsonValue,\r\n          updatedAt: new Date(),\r\n        },\r\n      });\r\n\r\n      console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \u2705 M\u00E9tadonn\u00E9es mises \u00E0 jour avec succ\u00E8s`);\r\n      return res.json(updatedTable);\r\n    }\r\n\r\n    // Sinon, mise \u00E0 jour compl\u00E8te (colonnes + lignes)\r\n    const updatedTable = await prisma.$transaction(async (tx) => {\r\n      const table = await tx.treeBranchLeafNodeTable.findUnique({\r\n        where: { id: tableId },\r\n        include: {\r\n          TreeBranchLeafNode: {\r\n            include: { TreeBranchLeafTree: true }\r\n          }\r\n        }\r\n      });\r\n\r\n      if (!table) {\r\n        throw new Error('Table non trouv\u00E9e');\r\n      }\r\n\r\n      const tableOrgId = table.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n      if (!isSuperAdmin && organizationId && tableOrgId !== organizationId) {\r\n        throw new Error('Acc\u00E8s non autoris\u00E9');\r\n      }\r\n\r\n      const updateData: Prisma.TreeBranchLeafNodeTableUpdateInput = {\r\n        updatedAt: new Date(),\r\n      };\r\n      if (name) updateData.name = name;\r\n      if (description !== undefined) updateData.description = description;\r\n      if (type) updateData.type = type;\r\n      if (meta) updateData.meta = meta as Prisma.InputJsonValue;\r\n      // NE mettre \u00E0 jour columnCount/rowCount QUE si les arrays contiennent r\u00E9ellement des donn\u00E9es\r\n      if (Array.isArray(columns) && columns.length > 0) updateData.columnCount = columns.length;\r\n      if (Array.isArray(rows) && rows.length > 0) updateData.rowCount = rows.length;\r\n\r\n      const tableUpdated = await tx.treeBranchLeafNodeTable.update({\r\n        where: { id: tableId },\r\n        data: updateData,\r\n      });\r\n\r\n      // \u26A0\uFE0F IMPORTANT: Ne remplacer les colonnes QUE si l'array n'est PAS vide\r\n      // Un array vide signifie g\u00E9n\u00E9ralement que le frontend ne veut pas modifier les colonnes\r\n      if (Array.isArray(columns) && columns.length > 0) {\r\n        console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \uD83D\uDD04 Remplacement des colonnes...`);\r\n        await tx.treeBranchLeafNodeTableColumn.deleteMany({ where: { tableId } });\r\n        \r\n        const newColumnsData = columns.map((col: any, index: number) => ({\r\n          tableId,\r\n          columnIndex: index,\r\n          name: typeof col === 'string' ? col : (col.name || `Colonne ${index + 1}`),\r\n          type: typeof col === 'object' ? col.type : 'text',\r\n          width: typeof col === 'object' ? col.width : null,\r\n          format: typeof col === 'object' ? col.format : null,\r\n          metadata: typeof col === 'object' && col.metadata ? col.metadata : {},\r\n        }));\r\n        await tx.treeBranchLeafNodeTableColumn.createMany({ data: newColumnsData });\r\n        console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \u2705 ${columns.length} colonnes remplac\u00E9es`);\r\n      }\r\n\r\n      // \u26A0\uFE0F IMPORTANT: Ne remplacer les lignes QUE si l'array n'est PAS vide\r\n      // Un array vide signifie g\u00E9n\u00E9ralement que le frontend ne veut pas modifier les lignes\r\n      if (Array.isArray(rows) && rows.length > 0) {\r\n        console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \uD83D\uDD04 Remplacement des lignes...`);\r\n        console.log(`[PUT ALIAS] \uD83D\uDD0D ANALYSE ROWS RE\u00C7UES DU FRONTEND:`);\r\n        console.log(`[PUT ALIAS]    - rows.length:`, rows.length);\r\n        console.log(`[PUT ALIAS]    - rows[0] type:`, typeof rows[0]);\r\n        console.log(`[PUT ALIAS]    - rows[0] isArray:`, Array.isArray(rows[0]));\r\n        console.log(`[PUT ALIAS]    - rows[0] value:`, rows[0]);\r\n        if (rows.length > 1) {\r\n          console.log(`[PUT ALIAS]    - rows[1] type:`, typeof rows[1]);\r\n          console.log(`[PUT ALIAS]    - rows[1] isArray:`, Array.isArray(rows[1]));\r\n          console.log(`[PUT ALIAS]    - rows[1] value:`, rows[1]);\r\n        }\r\n        \r\n        await tx.treeBranchLeafNodeTableRow.deleteMany({ where: { tableId } });\r\n        \r\n        // \u26A0\uFE0F CRITIQUE: Utiliser create() en boucle au lieu de createMany()\r\n        // Prisma createMany() NE SUPPORTE PAS les champs JSONB correctement !\r\n        // Il convertit les arrays JSON en simple strings, perdant les donn\u00E9es\r\n        console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \uD83D\uDD04 Cr\u00E9ation de ${rows.length} lignes (boucle create)...`);\r\n        for (let index = 0; index < rows.length; index++) {\r\n          const row = rows[index];\r\n          console.log(`[PUT ALIAS] Row ${index} AVANT create - type:`, typeof row, 'isArray:', Array.isArray(row), 'value:', row);\r\n          await tx.treeBranchLeafNodeTableRow.create({\r\n            data: {\r\n              tableId,\r\n              rowIndex: index,\r\n              cells: row as Prisma.InputJsonValue,\r\n            }\r\n          });\r\n          console.log(`[PUT ALIAS] Row ${index} created, cells.length:`, Array.isArray(row) ? row.length : 'N/A');\r\n        }\r\n        console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \u2705 ${rows.length} lignes remplac\u00E9es`);\r\n      }\r\n\r\n      return tableUpdated;\r\n    });\r\n\r\n    console.log(`[NEW PUT /nodes/:nodeId/tables/:tableId] \uD83C\uDF89 Mise \u00E0 jour termin\u00E9e avec succ\u00E8s`);\r\n    res.json(updatedTable);\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C [NEW PUT /nodes/:nodeId/tables/:tableId] Erreur:`, error);\r\n    if (error instanceof Error && (error.message === 'Table non trouv\u00E9e' || error.message === 'Acc\u00E8s non autoris\u00E9')) {\r\n      const status = error.message === 'Table non trouv\u00E9e' ? 404 : 403;\r\n      return res.status(status).json({ error: error.message });\r\n    }\r\n    res.status(500).json({ error: 'Impossible de mettre \u00E0 jour la table' });\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// GET /api/treebranchleaf/nodes/:nodeId/tables - Liste des tables d'un n\u0153ud\r\n// =============================================================================\r\nrouter.get('/nodes/:nodeId/tables', async (req, res) => {\r\n  const { nodeId } = req.params;\r\n  const { organizationId, isSuperAdmin } = getAuthCtx(req as unknown as MinimalReq);\r\n\r\n  console.log(`[NEW GET /nodes/:nodeId/tables] \uD83D\uDCCB R\u00E9cup\u00E9ration des tables pour node ${nodeId}`);\r\n\r\n  try {\r\n    // V\u00E9rifier que le n\u0153ud existe et appartient \u00E0 l'organisation\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      include: { TreeBranchLeafTree: true }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u0153ud non trouv\u00E9' });\r\n    }\r\n    if (!isSuperAdmin && organizationId && node.TreeBranchLeafTree.organizationId !== organizationId) {\r\n      return res.status(403).json({ error: 'Acc\u00E8s non autoris\u00E9 \u00E0 ce n\u0153ud' });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer toutes les tables de ce n\u0153ud avec colonnes et lignes\r\n    const tables = await prisma.treeBranchLeafNodeTable.findMany({\r\n      where: { nodeId },\r\n      include: {\r\n        tableColumns: {\r\n          orderBy: { columnIndex: 'asc' },\r\n        },\r\n        tableRows: {\r\n          orderBy: { rowIndex: 'asc' },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n\r\n    console.log(`[NEW GET /nodes/:nodeId/tables] \u2705 ${tables.length} table(s) trouv\u00E9e(s)`);\r\n\r\n    // Reformater la r\u00E9ponse pour correspondre au format attendu par le frontend\r\n    const formattedTables = tables.map(table => ({\r\n      id: table.id,\r\n      name: table.name,\r\n      description: table.description,\r\n      type: table.type,\r\n      columns: table.tableColumns.map(c => c.name),\r\n      rows: table.tableRows.map(r => {\r\n        // \u2705 Convertir JSONB Prisma \u2192 Array JavaScript natif\r\n        const cells = r.cells;\r\n        if (Array.isArray(cells)) {\r\n          return cells;\r\n        }\r\n        // Si cells n'est pas d\u00E9j\u00E0 un array, essayer de le parser\r\n        if (typeof cells === 'string') {\r\n          try {\r\n            const parsed = JSON.parse(cells);\r\n            return Array.isArray(parsed) ? parsed : [String(parsed)];\r\n          } catch {\r\n            return [String(cells)];\r\n          }\r\n        }\r\n        // Si cells est un objet (JSONB), v\u00E9rifier s'il a une structure d'array\r\n        if (cells && typeof cells === 'object') {\r\n          return Object.values(cells);\r\n        }\r\n        return [String(cells || '')];\r\n      }),\r\n      meta: table.meta || {},\r\n      order: table.createdAt ? new Date(table.createdAt).getTime() : 0,\r\n      createdAt: table.createdAt,\r\n      updatedAt: table.updatedAt,\r\n    }));\r\n\r\n    res.json(formattedTables);\r\n\r\n  } catch (error) {\r\n    console.error(`\u274C [NEW GET /nodes/:nodeId/tables] Erreur:`, error);\r\n    res.status(500).json({ error: 'Impossible de r\u00E9cup\u00E9rer les tables' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import express from 'express';\r\nimport { authMiddleware, requireRole, type AuthenticatedRequest } from '../../../../../middlewares/auth';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = express.Router();\r\n\r\n/**\r\n * \uD83D\uDD27 ENDPOINTS DE CONFIGURATION TBL (DYNAMIQUES)\r\n * Objectif: fournir 0 code en dur. Toutes les donn\u00E9es proviennent de Prisma.\r\n *\r\n * Sources de v\u00E9rit\u00E9 utilis\u00E9es:\r\n * - treeBranchLeafNodeVariable      \u2192 variables expos\u00E9es (exposedKey, displayName...)\r\n * - treeBranchLeafNode (fields)     \u2192 extraction des champs (leaf_*) pour construire une config minimale\r\n * - (calculation-modes)             \u2192 Pas encore de table d\u00E9di\u00E9e: construit dynamiquement via heuristique de regroupement\r\n *\r\n * Contrats de r\u00E9ponse:\r\n * GET /api/tbl/variables -> { variables: Array<{ id, nodeId, exposedKey, displayName, sourceRef, displayFormat, unit, precision }> }\r\n * GET /api/tbl/fields -> { fields: Array<{ id, nodeId, type, label, required, defaultValue }> }\r\n * GET /api/tbl/calculation-modes -> { modes: Array<{ id, code, label, fields: Array<{ id, code, label, type, unit? }> }> }\r\n * GET /api/tbl/modes (alias)\r\n *\r\n * Filtres d'organisation:\r\n * - Si super_admin \u2192 visibilit\u00E9 globale\r\n * - Sinon \u2192 restreint aux nodes dont l'arbre appartient \u00E0 l'organisation de l'utilisateur\r\n */\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface AuthCtx { isSuperAdmin: boolean; organizationId: string | null }\r\nfunction getAuthCtx(req: AuthenticatedRequest): AuthCtx {\r\n  const role = (req.user?.role || '').toLowerCase();\r\n  // @ts-expect-error propri\u00E9t\u00E9 potentielle c\u00F4t\u00E9 backend\r\n  const possibleFlag: unknown = req.user?.isSuperAdmin;\r\n  const isSuperAdmin = role === 'super_admin' || possibleFlag === true;\r\n  const organizationId = req.user?.organizationId || null;\r\n  return { isSuperAdmin, organizationId };\r\n}\r\n\r\n// \u2705 Variables expos\u00E9es dynamiques\r\nrouter.get('/variables', authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { isSuperAdmin, organizationId } = getAuthCtx(req);\r\n\r\n    // Relation correcte = \"TreeBranchLeafNode\" (et non \"node\").\r\n    const raw = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            id: true,\r\n            treeId: true,\r\n            TreeBranchLeafTree: { select: { organizationId: true } }\r\n          }\r\n        }\r\n      },\r\n      orderBy: { updatedAt: 'desc' }\r\n    });\r\n\r\n    interface RawVarWithRelations {\r\n      id: string;\r\n      nodeId: string;\r\n      exposedKey: string;\r\n      displayName: string;\r\n      displayFormat: string;\r\n      unit: string | null;\r\n      precision: number | null;\r\n      sourceRef: string | null;\r\n      sourceType: string | null;\r\n      updatedAt: Date;\r\n      TreeBranchLeafNode?: {\r\n        id: string;\r\n        treeId: string;\r\n        TreeBranchLeafTree?: { organizationId: string } | null;\r\n      } | null;\r\n    }\r\n\r\n    const variables = (raw as unknown as RawVarWithRelations[])\r\n      .filter(v => {\r\n        if (isSuperAdmin) return true;\r\n        const nodeOrg = v.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n        return !organizationId || !nodeOrg || nodeOrg === organizationId;\r\n      })\r\n      .map(v => ({\r\n        id: v.id,\r\n        nodeId: v.nodeId,\r\n        exposedKey: v.exposedKey,\r\n        displayName: v.displayName,\r\n        sourceRef: v.sourceRef ?? null,\r\n        sourceType: v.sourceType ?? null,\r\n        displayFormat: v.displayFormat,\r\n        unit: v.unit ?? null,\r\n        precision: v.precision ?? null,\r\n        updatedAt: v.updatedAt\r\n      }));\r\n\r\n    return res.json({ variables, count: variables.length, source: 'database' });\r\n  } catch (e) {\r\n    const err = e as Error;\r\n    console.error('\u274C [TBL API] Erreur GET /variables:', err.message, err.stack);\r\n    return res.status(500).json({ error: 'Erreur serveur variables', details: err.message });\r\n  }\r\n});\r\n\r\n// \u2705 Modes / Capacit\u00E9s dynamiques (VRAIE d\u00E9tection, pas d'heuristique par unit\u00E9)\r\n// R\u00E8gle: on d\u00E9rive une \"capacit\u00E9\" \u00E0 partir de sourceRef / tables associ\u00E9es.\r\n// Capacit\u00E9s: 1=neutre (variable simple), 2=formule, 3=condition, 4=tableau\r\n// R\u00E9ponse: { modes: [{ id, code, label, capacity, fields: [{ id, code, label, type, capacity }] }] }\r\nrouter.get(['/calculation-modes', '/modes'], authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { isSuperAdmin, organizationId } = getAuthCtx(req);\r\n\r\n    const rawVariables = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            id: true,\r\n            treeId: true,\r\n            parentId: true,\r\n            type: true,\r\n            TreeBranchLeafTree: { select: { organizationId: true } }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    type RawVar = typeof rawVariables[number] & { TreeBranchLeafNode?: { TreeBranchLeafTree?: { organizationId: string } | null } | null };\r\n    const accessible = (rawVariables as RawVar[]).filter(v => {\r\n      if (isSuperAdmin) return true;\r\n      const nodeOrg = v.TreeBranchLeafNode?.TreeBranchLeafTree?.organizationId;\r\n      return !organizationId || !nodeOrg || nodeOrg === organizationId;\r\n    });\r\n\r\n    interface CapacityField { id: string; code: string; label: string; type: string; capacity: string; sourceRef: string | null }\r\n    interface Mode { id: string; code: string; label: string; capacity: string; fields: CapacityField[] }\r\n\r\n    const capacityBuckets: Record<string, CapacityField[]> = { '1': [], '2': [], '3': [], '4': [] };\r\n\r\n    function detectCapacity(sourceRef: string | null | undefined): string {\r\n      if (!sourceRef) return '1';\r\n      if (sourceRef.startsWith('formula:')) return '2';\r\n      if (sourceRef.startsWith('condition:')) return '3';\r\n      if (sourceRef.startsWith('table:')) return '4';\r\n      // UUID direct => neutre\r\n      return '1';\r\n    }\r\n\r\n    for (const v of accessible) {\r\n      const capacity = detectCapacity(v.sourceRef as string | null | undefined);\r\n      const fieldType = (v.displayFormat || '').startsWith('number') ? 'number' : 'text';\r\n      const f: CapacityField = {\r\n        id: v.id,\r\n        code: v.exposedKey || v.id,\r\n        label: v.displayName || v.exposedKey || v.id,\r\n        type: fieldType,\r\n        capacity,\r\n        sourceRef: v.sourceRef || null\r\n      };\r\n      capacityBuckets[capacity].push(f);\r\n    }\r\n\r\n    // Construire un mode par capacit\u00E9 existante (non vide)\r\n    const capacityMeta: Record<string, { code: string; label: string }> = {\r\n      '1': { code: 'neutral', label: 'Variables neutres' },\r\n      '2': { code: 'formulas', label: 'Formules' },\r\n      '3': { code: 'conditions', label: 'Conditions' },\r\n      '4': { code: 'tables', label: 'Tableaux' }\r\n    };\r\n\r\n    const modes: Mode[] = Object.entries(capacityBuckets)\r\n      .filter(([, list]) => list.length > 0)\r\n      .map(([cap, list]) => ({\r\n        id: `capacity_${cap}`,\r\n        code: capacityMeta[cap].code,\r\n        label: capacityMeta[cap].label,\r\n        capacity: cap,\r\n        fields: list.slice(0, 100) // limite de s\u00E9curit\u00E9\r\n      }));\r\n\r\n    // Si aucune variable \u2192 mode vide neutre\r\n    if (modes.length === 0) {\r\n      modes.push({ id: 'capacity_1', code: 'neutral', label: 'Variables neutres', capacity: '1', fields: [] });\r\n    }\r\n\r\n    return res.json({ modes, count: modes.length, source: 'derived_capacity', generatedAt: new Date().toISOString() });\r\n  } catch (e) {\r\n    const err = e as Error;\r\n    console.error('\u274C [TBL API] Erreur GET /calculation-modes (capacity detection):', err.message, err.stack);\r\n    return res.status(500).json({ error: 'Erreur serveur calculation-modes', details: err.message });\r\n  }\r\n});\r\n\r\n// \u2705 Fields dynamiques: extraction des nodes de type leaf_* (ou avec hasData=true)\r\nrouter.get('/fields', authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { isSuperAdmin, organizationId } = getAuthCtx(req);\r\n    // R\u00E9cup\u00E8re n\u0153uds potentiels de champs\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: {\r\n        OR: [\r\n          { type: { startsWith: 'leaf_' } },\r\n          { hasData: true }\r\n        ]\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        type: true,\r\n        fieldType: true,\r\n        fieldSubType: true,\r\n        hasData: true,\r\n        treeId: true,\r\n        parentId: true,\r\n        order: true,\r\n        // \uD83C\uDFF7\uFE0F COLONNES TOOLTIP - CRITIQUES POUR TBL\r\n        text_helpTooltipType: true,\r\n        text_helpTooltipText: true,\r\n        text_helpTooltipImage: true,\r\n        TreeBranchLeafTree: { select: { organizationId: true } }\r\n      },\r\n      orderBy: { updatedAt: 'desc' }\r\n    });\r\n\r\n    type RawNode = typeof nodes[number];\r\n    const filtered = (nodes as RawNode[]).filter(n => {\r\n      if (isSuperAdmin) return true;\r\n      const nodeOrg = n.TreeBranchLeafTree?.organizationId;\r\n      return !organizationId || !nodeOrg || nodeOrg === organizationId;\r\n    });\r\n\r\n    const fields = filtered.map(n => ({\r\n      id: n.id,\r\n      nodeId: n.id,\r\n      type: (n.fieldType || n.fieldSubType || n.type || '').replace(/^leaf_/, '') || 'text',\r\n      label: n.label || n.id,\r\n      required: false,\r\n      defaultValue: null,\r\n      category: n.fieldSubType || null,\r\n      order: n.order,\r\n      // \uD83C\uDFF7\uFE0F DONN\u00C9ES TOOLTIP - ESSENTIELLES POUR TBL\r\n      text_helpTooltipType: n.text_helpTooltipType,\r\n      text_helpTooltipText: n.text_helpTooltipText,\r\n      text_helpTooltipImage: n.text_helpTooltipImage\r\n    }));\r\n\r\n    return res.json({ fields, count: fields.length, source: 'database' });\r\n  } catch (e) {\r\n    console.error('\u274C [TBL API] Erreur GET /fields:', e);\r\n    return res.status(500).json({ error: 'Erreur serveur fields' });\r\n  }\r\n});\r\n\r\n// POST /api/tbl/devis - Sauvegarder un devis TBL\r\nrouter.post('/devis', authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { clientId, treeId, organizationId, userId, projectName, notes, isDraft, formData, metadata } = req.body || {};\r\n\r\n    if (req.user?.organizationId && organizationId && req.user.organizationId !== organizationId) {\r\n      return res.status(403).json({ success: false, error: 'Acc\u00E8s refus\u00E9 \u00E0 cette organisation' });\r\n    }\r\n\r\n    // G\u00E9n\u00E8re un ID interne (pas encore de persistance table devis d\u00E9di\u00E9e)\r\n    const devisId = `tbl_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\r\n    const payload = {\r\n      devisId,\r\n      clientId: clientId || null,\r\n      treeId: treeId || null,\r\n      organizationId: organizationId || req.user?.organizationId || null,\r\n      userId: userId || req.user?.id || null,\r\n      projectName: projectName || `Projet TBL ${new Date().toLocaleDateString()}`,\r\n      notes: notes || '',\r\n      isDraft: Boolean(isDraft),\r\n      formData: typeof formData === 'object' && formData ? formData : {},\r\n      metadata: { ...(metadata || {}), savedAt: new Date().toISOString(), version: '1.0' },\r\n      createdAt: new Date().toISOString(),\r\n      updatedAt: new Date().toISOString()\r\n    };\r\n\r\n    return res.json({ success: true, ...payload, message: 'Devis TBL sauvegard\u00E9 (simulation)' });\r\n  } catch (error) {\r\n    console.error('\u274C [TBL API] Erreur sauvegarde devis:', error);\r\n    return res.status(500).json({ success: false, error: 'Erreur serveur lors de la sauvegarde du devis' });\r\n  }\r\n});\r\n\r\n// \u2705 Endpoint de sant\u00E9 / meta configuration TBL\r\nrouter.get('/config/health', authMiddleware, requireRole(['user','admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const [varCount, formulaCount, conditionCount, tableCount] = await Promise.all([\r\n      prisma.treeBranchLeafNodeVariable.count(),\r\n      prisma.treeBranchLeafNodeFormula.count().catch(() => 0),\r\n  // @ts-expect-error table potentielle condition pas toujours g\u00E9n\u00E9r\u00E9e\r\n      prisma.treeBranchLeafNodeCondition?.count?.().catch?.(() => 0) || 0,\r\n  // @ts-expect-error table potentielle table pas toujours g\u00E9n\u00E9r\u00E9e\r\n      prisma.treeBranchLeafNodeTable?.count?.().catch?.(() => 0) || 0\r\n    ]);\r\n\r\n    // Distribution capacit\u00E9s (re-scan rapide limit\u00E9 500 pour performance)\r\n    const sample = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      select: { id: true, sourceRef: true },\r\n      take: 500,\r\n      orderBy: { updatedAt: 'desc' }\r\n    });\r\n    const capacityCounts = { '1': 0, '2': 0, '3': 0, '4': 0 };\r\n    for (const v of sample) {\r\n      const sr = v.sourceRef || '';\r\n      if (sr.startsWith('formula:')) capacityCounts['2']++; else if (sr.startsWith('condition:')) capacityCounts['3']++; else if (sr.startsWith('table:')) capacityCounts['4']++; else capacityCounts['1']++;\r\n    }\r\n    return res.json({\r\n      success: true,\r\n      timestamp: new Date().toISOString(),\r\n      counts: {\r\n        variables: varCount,\r\n        formulas: formulaCount,\r\n        conditions: conditionCount,\r\n        tables: tableCount\r\n      },\r\n      capacitySample: capacityCounts,\r\n      sampleSize: sample.length\r\n    });\r\n  } catch (e) {\r\n    const err = e as Error;\r\n    return res.status(500).json({ success: false, error: 'Erreur health config', details: err.message });\r\n  }\r\n});\r\n// GET /api/tbl/devis/client/:clientId - R\u00E9cup\u00E9rer les devis d'un client\r\nrouter.get('/devis/client/:clientId', authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (_req: AuthenticatedRequest, res) => {\r\n  try {\r\n    // const { clientId } = req.params; // (non utilis\u00E9 pour l'instant)\r\n\r\n    // Pour l'instant, retourner un tableau vide\r\n    \r\n    res.json([]);\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [TBL API] Erreur r\u00E9cup\u00E9ration devis client:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur serveur lors de la r\u00E9cup\u00E9ration des devis'\r\n    });\r\n  }\r\n});\r\n// GET /api/tbl/devis/:devisId - Charger un devis sp\u00E9cifique\r\nrouter.get('/devis/:devisId', authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { devisId } = req.params;\r\n\r\n    // console.log('\uD83D\uDCD6 [TBL API] Chargement devis:', devisId); // \u2728 Log r\u00E9duit\r\n\r\n    // Pour l'instant, retourner un devis vide\r\n    res.json({\r\n      devisId,\r\n      clientId: null,\r\n      treeId: null,\r\n      organizationId: null,\r\n      userId: null,\r\n      projectName: '',\r\n      notes: '',\r\n      isDraft: true,\r\n      formData: {},\r\n      metadata: {},\r\n      createdAt: new Date().toISOString(),\r\n      updatedAt: new Date().toISOString()\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [TBL API] Erreur chargement devis:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur serveur lors du chargement du devis'\r\n    });\r\n  }\r\n});\r\n// GET /api/clients/:clientId/access-check - V\u00E9rifier l'acc\u00E8s \u00E0 un client\r\nrouter.get('/clients/:clientId/access-check', authMiddleware, requireRole(['user', 'admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { clientId } = req.params;\r\n    const { role } = req.user || {};\r\n\r\n    // console.log('\uD83D\uDD0D [TBL API] V\u00E9rification acc\u00E8s client:', { clientId, userRole: role }); // \u2728 Log r\u00E9duit\r\n\r\n    // Pour l'instant, toujours autoriser l'acc\u00E8s\r\n    res.json({\r\n      hasAccess: true,\r\n      clientId,\r\n      userRole: role\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [TBL API] Erreur v\u00E9rification acc\u00E8s client:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur serveur lors de la v\u00E9rification d\\'acc\u00E8s'\r\n    });\r\n  }\r\n});\r\nexport default router;\r\n", "/**\r\n * \uD83C\uDF10 TBL API V2.0 - ROUTES INTELLIGENTES\r\n * \r\n * \u26A0\uFE0F AVERTISSEMENT : Ce fichier contient du code obsol\u00E8te utilisant l'ancien CapacityCalculator.\r\n * Il a \u00E9t\u00E9 partiellement migr\u00E9 vers operation-interpreter mais n\u00E9cessite une refonte compl\u00E8te.\r\n * \r\n * Nouvelles routes API qui remplacent TOUT l'ancien syst\u00E8me !\r\n * - \u00C9valuation par codes TBL\r\n * - R\u00E9solution intelligente des d\u00E9pendances\r\n * - Support complet formules/conditions/tableaux\r\n * \r\n * TODO: Refactoriser compl\u00E8tement pour utiliser operation-interpreter partout\r\n */\r\n\r\nimport express from 'express';\r\nimport TBLEvaluationEngine from '../intelligence/TBLEvaluationEngine';\r\nimport { evaluateVariableOperation } from '../../treebranchleaf-new/api/operation-interpreter';\r\n\r\nconst router = express.Router();\r\nconsole.log('\uD83E\uDDE0 [TBL INTELLIGENCE] Initialisation du routeur tbl-intelligence-routes (avec operation-interpreter)');\r\nconst evaluationEngine = new TBLEvaluationEngine();\r\n\r\n// Petit helper interne pour log\r\nfunction logRouteHit(route: string) {\r\n  console.log(`\uD83D\uDEF0\uFE0F  [TBL INTELLIGENCE] Hit ${route} @ ${new Date().toISOString()}`);\r\n}\r\n\r\n/**\r\n * \uD83D\uDE80 POST /api/tbl/evaluate\r\n * R\u00E9activ\u00E9e en mode MINIMAL pour ne pas bloquer le frontend.\r\n * Fournit uniquement un echo des \u00E9l\u00E9ments re\u00E7us + structure standard.\r\n */\r\nrouter.post('/evaluate', async (req, res) => {\r\n  logRouteHit('POST /api/tbl/evaluate');\r\n  const { PrismaClient } = await import('@prisma/client');\r\n  const prisma = new PrismaClient();\r\n  try {\r\n    const { elementId, elementIds, contextData = {}, evalType } = req.body || {};\r\n\r\n    // === MODE BATCH =========================================================\r\n    if (Array.isArray(elementIds) && elementIds.length > 0) {\r\n      const startedAt = Date.now();\r\n      const results: Record<string, unknown> = {};\r\n      const traces: Record<string, unknown> = {};\r\n      for (const id of elementIds) {\r\n        if (!id || typeof id !== 'string') {\r\n          results[id || ''] = { success: false, error: 'elementId invalide' };\r\n          continue;\r\n        }\r\n        try {\r\n          // R\u00E9utiliser la logique r\u00E9solution mono-id via fonction utilitaire interne\r\n          const single = await resolveSingleEvaluation(prisma, id, contextData);\r\n          results[id] = single.payload;\r\n          traces[id] = single.trace;\r\n        } catch (e) {\r\n          results[id] = { success: false, error: 'Erreur interne (batch item)', details: e instanceof Error ? e.message : 'unknown' };\r\n        }\r\n      }\r\n      return res.json({\r\n        success: true,\r\n        mode: 'batch',\r\n        evalType: evalType || 'batch',\r\n        count: elementIds.length,\r\n        durationMs: Date.now() - startedAt,\r\n        results,\r\n        traces\r\n      });\r\n    }\r\n\r\n    // === MODE SINGLE ========================================================\r\n    if (!elementId || typeof elementId !== 'string') {\r\n      return res.status(400).json({ success: false, error: 'Param\u00E8tre elementId manquant ou invalide (ni elementIds[] fourni).' });\r\n    }\r\n\r\n  const trace: Array<{ step: string; info: string; success: boolean }> = [];\r\n    let resolvedNodeId: string | null = null;\r\n    let variable: { exposedKey: string; displayName: string | null; sourceRef: string | null } | null = null;\r\n\r\n    // 1. Chercher variable via exposedKey direct\r\n    const byKey = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { exposedKey: elementId }, select: { nodeId: true, exposedKey: true, displayName: true, sourceRef: true } });\r\n    if (byKey) {\r\n      resolvedNodeId = byKey.nodeId;\r\n      variable = { exposedKey: byKey.exposedKey, displayName: byKey.displayName, sourceRef: byKey.sourceRef };\r\n      trace.push({ step: 'variable_exposedKey', info: 'R\u00E9solu via variable.exposedKey', success: true });\r\n    } else {\r\n      trace.push({ step: 'variable_exposedKey', info: 'Aucune variable avec cet exposedKey', success: false });\r\n    }\r\n\r\n    // 2. Node direct\r\n    if (!resolvedNodeId) {\r\n      const node = await prisma.treeBranchLeafNode.findUnique({ where: { id: elementId }, select: { id: true } });\r\n      if (node) {\r\n        resolvedNodeId = node.id;\r\n        trace.push({ step: 'node_direct', info: 'Correspondance trouv\u00E9e dans TreeBranchLeafNode', success: true });\r\n      } else {\r\n        trace.push({ step: 'node_direct', info: 'Pas de node avec cet id', success: false });\r\n      }\r\n    }\r\n\r\n    // 3. Formule par id\r\n    if (!resolvedNodeId) {\r\n      const formula = await prisma.treeBranchLeafNodeFormula.findUnique({ where: { id: elementId }, select: { nodeId: true } });\r\n      if (formula) {\r\n        resolvedNodeId = formula.nodeId;\r\n        trace.push({ step: 'formula_id', info: 'Formule trouv\u00E9e via id', success: true });\r\n      } else {\r\n        trace.push({ step: 'formula_id', info: 'Aucune formule avec cet id', success: false });\r\n      }\r\n    }\r\n\r\n    // 4. Variable via sourceRef formula:<id>\r\n    if (!resolvedNodeId) {\r\n      const viaSourceFormula = await prisma.treeBranchLeafNodeVariable.findFirst({ where: { sourceRef: `formula:${elementId}` }, select: { nodeId: true, exposedKey: true, displayName: true, sourceRef: true } });\r\n      if (viaSourceFormula) {\r\n        resolvedNodeId = viaSourceFormula.nodeId;\r\n        variable = { exposedKey: viaSourceFormula.exposedKey, displayName: viaSourceFormula.displayName, sourceRef: viaSourceFormula.sourceRef };\r\n        trace.push({ step: 'variable_sourceRef_formula', info: 'R\u00E9solu via variable.sourceRef=formula:<id>', success: true });\r\n      } else {\r\n        trace.push({ step: 'variable_sourceRef_formula', info: 'Aucune variable.sourceRef=formula:<id>', success: false });\r\n      }\r\n    }\r\n\r\n    // 5. Variable via sourceRef direct id\r\n    if (!resolvedNodeId) {\r\n      const viaSourceRaw = await prisma.treeBranchLeafNodeVariable.findFirst({ where: { sourceRef: elementId }, select: { nodeId: true, exposedKey: true, displayName: true, sourceRef: true } });\r\n      if (viaSourceRaw) {\r\n        resolvedNodeId = viaSourceRaw.nodeId;\r\n        variable = { exposedKey: viaSourceRaw.exposedKey, displayName: viaSourceRaw.displayName, sourceRef: viaSourceRaw.sourceRef };\r\n        trace.push({ step: 'variable_sourceRef_raw', info: 'R\u00E9solu via variable.sourceRef = id', success: true });\r\n      } else {\r\n        trace.push({ step: 'variable_sourceRef_raw', info: 'Aucune variable.sourceRef = id', success: false });\r\n      }\r\n    }\r\n\r\n    if (!resolvedNodeId) {\r\n      return res.status(422).json({ \r\n        success: false, \r\n        error: 'Impossible de r\u00E9soudre elementId', \r\n        code: 'ELEMENT_UNRESOLVED',\r\n        hint: 'V\u00E9rifier que la variable ou formule est cr\u00E9\u00E9e avant l\\'\u00E9valuation',\r\n        trace \r\n      });\r\n    }\r\n\r\n    // Si variable pas encore obtenue, la r\u00E9cup\u00E9rer via nodeId\r\n    if (!variable) {\r\n      const v = await prisma.treeBranchLeafNodeVariable.findFirst({ where: { nodeId: resolvedNodeId }, select: { exposedKey: true, displayName: true, sourceRef: true } });\r\n      if (v) {\r\n        variable = { exposedKey: v.exposedKey, displayName: v.displayName, sourceRef: v.sourceRef };\r\n        trace.push({ step: 'variable_from_node', info: 'Variable trouv\u00E9e via nodeId', success: true });\r\n      }\r\n    }\r\n\r\n    if (!variable || !variable.exposedKey) {\r\n      return res.status(422).json({ success: false, error: 'Variable associ\u00E9e introuvable ou sans exposedKey', trace });\r\n    }\r\n\r\n    // D\u00E9tection capacit\u00E9 par sourceRef\r\n    const sr = variable.sourceRef || '';\r\n    let capacity: '1' | '2' | '3' | '4' = '1';\r\n    if (sr.startsWith('formula:')) capacity = '2';\r\n    else if (sr.startsWith('condition:')) capacity = '3';\r\n    else if (sr.startsWith('table:')) capacity = '4';\r\n    trace.push({ step: 'capacity_detect', info: `Capacit\u00E9 d\u00E9tect\u00E9e=${capacity}`, success: true });\r\n\r\n    // Pour l'instant on n'impl\u00E9mente r\u00E9ellement que les formules via engine\r\n    if (capacity === '2') {\r\n      const result = await evaluationEngine.evaluate({\r\n        element_code: variable.exposedKey,\r\n        context_values: contextData,\r\n        evaluation_mode: 'auto',\r\n        deep_resolution: true\r\n      });\r\n      if (result.success) {\r\n        return res.json({ success: true, type: 'formula', capacity, value: result.final_value, dependencies: result.dependencies_used, performance: result.performance, trace });\r\n      }\r\n      return res.status(422).json({ success: false, type: 'formula', capacity, error: '\u00C9chec moteur', details: result.errors, trace });\r\n    }\r\n\r\n    if (capacity === '3') {\r\n      // TODO: impl\u00E9menter moteur conditions\r\n      return res.json({ success: true, type: 'condition', capacity, status: 'not_implemented', value: null, trace });\r\n    }\r\n    if (capacity === '4') {\r\n      // TODO: impl\u00E9menter moteur tableaux\r\n      return res.json({ success: true, type: 'table', capacity, status: 'not_implemented', value: null, trace });\r\n    }\r\n\r\n    // Neutre\r\n    return res.json({ success: true, type: 'neutral', capacity, value: null, trace });\r\n  } catch (e) {\r\n    console.error('\uD83D\uDCA5 [TBL INTELLIGENCE] Erreur /evaluate:', e);\r\n    return res.status(500).json({ success: false, error: 'Erreur interne /evaluate', details: e instanceof Error ? e.message : 'unknown' });\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n});\r\n\r\n// ================== FONCTION INTERNE (factorisation batch) ==================\r\n// Type minimal pour prisma (\u00E9viter any tout en restant l\u00E9ger). On pourrait importer PrismaClient mais cela recr\u00E9erait une instance.\r\ntype MinimalPrisma = {\r\n  treeBranchLeafNodeVariable: {\r\n    findUnique: (args: unknown) => Promise<unknown>;\r\n    findFirst: (args: unknown) => Promise<unknown>;\r\n  };\r\n  treeBranchLeafNode: { findUnique: (args: unknown) => Promise<unknown> };\r\n  treeBranchLeafNodeFormula: { findUnique: (args: unknown) => Promise<unknown> };\r\n};\r\n\r\nasync function resolveSingleEvaluation(prisma: MinimalPrisma, elementId: string, contextData: Record<string, unknown>) {\r\n  const evaluationEngine = new TBLEvaluationEngine();\r\n  const trace: Array<{ step: string; info: string; success: boolean }> = [];\r\n  let resolvedNodeId: string | null = null;\r\n  let variable: { exposedKey: string; displayName: string | null; sourceRef: string | null } | null = null;\r\n\r\n  // 1. Chercher variable via exposedKey direct\r\n  const byKey = await prisma.treeBranchLeafNodeVariable.findUnique({ where: { exposedKey: elementId }, select: { nodeId: true, exposedKey: true, displayName: true, sourceRef: true } });\r\n  if (byKey) {\r\n    resolvedNodeId = byKey.nodeId;\r\n    variable = { exposedKey: byKey.exposedKey, displayName: byKey.displayName, sourceRef: byKey.sourceRef };\r\n    trace.push({ step: 'variable_exposedKey', info: 'R\u00E9solu via variable.exposedKey', success: true });\r\n  } else {\r\n    trace.push({ step: 'variable_exposedKey', info: 'Aucune variable avec cet exposedKey', success: false });\r\n  }\r\n\r\n  // 2. Node direct\r\n  if (!resolvedNodeId) {\r\n    const node = await prisma.treeBranchLeafNode.findUnique({ where: { id: elementId }, select: { id: true } });\r\n    if (node) {\r\n      resolvedNodeId = node.id;\r\n      trace.push({ step: 'node_direct', info: 'Correspondance trouv\u00E9e dans TreeBranchLeafNode', success: true });\r\n    } else {\r\n      trace.push({ step: 'node_direct', info: 'Pas de node avec cet id', success: false });\r\n    }\r\n  }\r\n\r\n  // 3. Formule par id\r\n  if (!resolvedNodeId) {\r\n    const formula = await prisma.treeBranchLeafNodeFormula.findUnique({ where: { id: elementId }, select: { nodeId: true } });\r\n    if (formula) {\r\n      resolvedNodeId = formula.nodeId;\r\n      trace.push({ step: 'formula_id', info: 'Formule trouv\u00E9e via id', success: true });\r\n    } else {\r\n      trace.push({ step: 'formula_id', info: 'Aucune formule avec cet id', success: false });\r\n    }\r\n  }\r\n\r\n  // 4. Variable via sourceRef formula:<id>\r\n  if (!resolvedNodeId) {\r\n    const viaSourceFormula = await prisma.treeBranchLeafNodeVariable.findFirst({ where: { sourceRef: `formula:${elementId}` }, select: { nodeId: true, exposedKey: true, displayName: true, sourceRef: true } });\r\n    if (viaSourceFormula) {\r\n      resolvedNodeId = viaSourceFormula.nodeId;\r\n      variable = { exposedKey: viaSourceFormula.exposedKey, displayName: viaSourceFormula.displayName, sourceRef: viaSourceFormula.sourceRef };\r\n      trace.push({ step: 'variable_sourceRef_formula', info: 'R\u00E9solu via variable.sourceRef=formula:<id>', success: true });\r\n    } else {\r\n      trace.push({ step: 'variable_sourceRef_formula', info: 'Aucune variable.sourceRef=formula:<id>', success: false });\r\n    }\r\n  }\r\n\r\n  // 5. Variable via sourceRef direct id\r\n  if (!resolvedNodeId) {\r\n    const viaSourceRaw = await prisma.treeBranchLeafNodeVariable.findFirst({ where: { sourceRef: elementId }, select: { nodeId: true, exposedKey: true, displayName: true, sourceRef: true } });\r\n    if (viaSourceRaw) {\r\n      resolvedNodeId = viaSourceRaw.nodeId;\r\n      variable = { exposedKey: viaSourceRaw.exposedKey, displayName: viaSourceRaw.displayName, sourceRef: viaSourceRaw.sourceRef };\r\n      trace.push({ step: 'variable_sourceRef_raw', info: 'R\u00E9solu via variable.sourceRef = id', success: true });\r\n    } else {\r\n      trace.push({ step: 'variable_sourceRef_raw', info: 'Aucune variable.sourceRef = id', success: false });\r\n    }\r\n  }\r\n\r\n  if (!resolvedNodeId) {\r\n    return { payload: { success: false, error: 'Impossible de r\u00E9soudre elementId', trace }, trace };\r\n  }\r\n\r\n  if (!variable) {\r\n    const v = await prisma.treeBranchLeafNodeVariable.findFirst({ where: { nodeId: resolvedNodeId }, select: { exposedKey: true, displayName: true, sourceRef: true } });\r\n    if (v) {\r\n      variable = { exposedKey: v.exposedKey, displayName: v.displayName, sourceRef: v.sourceRef };\r\n      trace.push({ step: 'variable_from_node', info: 'Variable trouv\u00E9e via nodeId', success: true });\r\n    }\r\n  }\r\n\r\n  if (!variable || !variable.exposedKey) {\r\n    return { payload: { success: false, error: 'Variable associ\u00E9e introuvable ou sans exposedKey', trace }, trace };\r\n  }\r\n\r\n  const sr = variable.sourceRef || '';\r\n  let capacity: '1' | '2' | '3' | '4' = '1';\r\n  if (sr.startsWith('formula:')) capacity = '2';\r\n  else if (sr.startsWith('condition:')) capacity = '3';\r\n  else if (sr.startsWith('table:')) capacity = '4';\r\n  trace.push({ step: 'capacity_detect', info: `Capacit\u00E9 d\u00E9tect\u00E9e=${capacity}`, success: true });\r\n\r\n  if (capacity === '2') {\r\n    const result = await evaluationEngine.evaluate({\r\n      element_code: variable.exposedKey,\r\n      context_values: contextData,\r\n      evaluation_mode: 'auto',\r\n      deep_resolution: true\r\n    });\r\n    if (result.success) {\r\n      return { payload: { success: true, type: 'formula', capacity, value: result.final_value, dependencies: result.dependencies_used, performance: result.performance }, trace };\r\n    }\r\n    return { payload: { success: false, type: 'formula', capacity, error: '\u00C9chec moteur', details: result.errors }, trace };\r\n  }\r\n\r\n  if (capacity === '3') {\r\n    return { payload: { success: true, type: 'condition', capacity, status: 'not_implemented', value: null }, trace };\r\n  }\r\n  if (capacity === '4') {\r\n    return { payload: { success: true, type: 'table', capacity, status: 'not_implemented', value: null }, trace };\r\n  }\r\n  return { payload: { success: true, type: 'neutral', capacity, value: null }, trace };\r\n}\r\n\r\n// Route de debug pour confirmer le montage c\u00F4t\u00E9 serveur\r\nrouter.get('/_debug_list', (req, res) => {\r\n  logRouteHit('GET /api/tbl/_debug_list');\r\n  return res.json({\r\n    routes: [\r\n      'POST /api/tbl/evaluate (minimal)',\r\n      'POST /api/tbl/evaluate/formula/:tblCode (disabled)',\r\n      'POST /api/tbl/condition (\u2705 ACTIVE avec CapacityCalculator)',\r\n      'POST /api/tbl/evaluate/condition/:tblCode (\u2705 ACTIVE avec CapacityCalculator)',\r\n      'POST /api/tbl/evaluate/table/:tblCode (disabled)',\r\n      'GET /api/tbl/analyze/:tblCode (disabled)',\r\n      'GET /api/tbl/status (disabled)'\r\n    ],\r\n    timestamp: new Date().toISOString()\r\n  });\r\n});\r\n\r\n\r\n\r\n/**\r\n * \uD83E\uDDEE POST /api/tbl/evaluate/formula/:tblCode\r\n * \u26A0\uFE0F D\u00C9SACTIV\u00C9E TEMPORAIREMENT\r\n */\r\nrouter.post('/evaluate/formula/:tblCode', async (req, res) => {\r\n  return res.status(503).json({ success: false, error: 'Route d\u00E9sactiv\u00E9e pour d\u00E9bogage.' });\r\n});\r\n\r\n/**\r\n * \u2696\uFE0F POST /api/tbl/condition\r\n * R\u00C9ACTIV\u00C9E avec CapacityCalculator\r\n */\r\nrouter.post('/condition', async (req, res) => {\r\n  logRouteHit('POST /api/tbl/condition');\r\n  \r\n  try {\r\n    const { elementId, contextData = {}, submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182' } = req.body || {};\r\n    \r\n    if (!elementId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        error: 'elementId requis' \r\n      });\r\n    }\r\n\r\n    console.log('\uD83D\uDD27 [TBL CONDITION] \u00C9valuation avec CapacityCalculator:', elementId);\r\n    \r\n    // Utiliser le CapacityCalculator corrig\u00E9\r\n    const calculator = new CapacityCalculator();\r\n    \r\n    const context = {\r\n      submissionId,\r\n      organizationId: 'test-org',\r\n      userId: 'test-user'\r\n    };\r\n\r\n    const result = await calculator.evaluateCondition(elementId, context);\r\n    \r\n    console.log('\u2705 [TBL CONDITION] R\u00E9sultat CapacityCalculator:', result);\r\n    \r\n    return res.json({\r\n      success: true,\r\n      evaluation: result,\r\n      elementId,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL CONDITION] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \u2696\uFE0F POST /api/tbl/evaluate/condition/:tblCode\r\n * R\u00C9ACTIV\u00C9E avec CapacityCalculator\r\n */\r\nrouter.post('/evaluate/condition/:tblCode', async (req, res) => {\r\n  logRouteHit('POST /api/tbl/evaluate/condition/:tblCode');\r\n  \r\n  const { tblCode } = req.params;\r\n  const { submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182' } = req.body || {};\r\n  \r\n  if (!tblCode) {\r\n    return res.status(400).json({ \r\n      success: false, \r\n      error: 'tblCode requis' \r\n    });\r\n  }\r\n\r\n  console.log('\uD83D\uDD27 [TBL EVALUATE CONDITION] \u00C9valuation avec operation-interpreter:', tblCode);\r\n  \r\n  // \u2728 Utiliser le syst\u00E8me unifi\u00E9 operation-interpreter\r\n  const { PrismaClient } = await import('@prisma/client');\r\n  const prisma = new PrismaClient();\r\n  \r\n  try {\r\n    // Trouver le nodeId de la condition\r\n    const conditionRecord = await prisma.treeBranchLeafNodeCondition.findUnique({\r\n      where: { id: tblCode },\r\n      select: { nodeId: true }\r\n    });\r\n    \r\n    if (!conditionRecord?.nodeId) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: `Condition ${tblCode} introuvable`\r\n      });\r\n    }\r\n    \r\n    // \u00C9valuer avec operation-interpreter\r\n    const result = await evaluateVariableOperation(\r\n      conditionRecord.nodeId,\r\n      submissionId || tblCode,\r\n      prisma\r\n    );\r\n    \r\n    console.log('\u2705 [TBL EVALUATE CONDITION] R\u00E9sultat operation-interpreter:', result);\r\n    \r\n    return res.json({\r\n      success: true,\r\n      evaluation: result,\r\n      operationResult: result.operationResult,\r\n      operationDetail: result.operationDetail,\r\n      operationSource: result.operationSource,\r\n      tblCode,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [TBL EVALUATE CONDITION] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCA POST /api/tbl/evaluate/table/:tblCode\r\n * \u26A0\uFE0F D\u00C9SACTIV\u00C9E TEMPORAIREMENT\r\n */\r\nrouter.post('/evaluate/table/:tblCode', async (req, res) => {\r\n  return res.status(503).json({ success: false, error: 'Route d\u00E9sactiv\u00E9e pour d\u00E9bogage.' });\r\n});\r\n\r\n/**\r\n * \uD83D\uDD0D GET /api/tbl/analyze/:tblCode\r\n * \u26A0\uFE0F D\u00C9SACTIV\u00C9E TEMPORAIREMENT\r\n */\r\nrouter.get('/analyze/:tblCode', async (req, res) => {\r\n  return res.status(503).json({ success: false, error: 'Route d\u00E9sactiv\u00E9e pour d\u00E9bogage.' });\r\n});\r\n\r\n/**\r\n * \uD83D\uDCC8 GET /api/tbl/status\r\n * \u26A0\uFE0F D\u00C9SACTIV\u00C9E TEMPORAIREMENT\r\n */\r\nrouter.get('/status', async (req, res) => {\r\n  return res.status(503).json({ success: false, error: 'Route d\u00E9sactiv\u00E9e pour d\u00E9bogage.' });\r\n});\r\n\r\n/**\r\n * \uD83D\uDD04 POST /api/tbl/update-database-results\r\n * NOUVEAU : Met \u00E0 jour la base de donn\u00E9es avec les r\u00E9sultats du CapacityCalculator\r\n */\r\nrouter.post('/update-database-results', async (req, res) => {\r\n  logRouteHit('POST /api/tbl/update-database-results');\r\n  \r\n  try {\r\n    const { submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182' } = req.body || {};\r\n    \r\n    console.log('\uD83D\uDD04 [TBL UPDATE] D\u00E9but mise \u00E0 jour base de donn\u00E9es avec CapacityCalculator');\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    // R\u00E9cup\u00E9rer toutes les donn\u00E9es de submission pour les conditions\r\n    const submissionData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: {\r\n        submissionId: submissionId,\r\n        operationSource: 'condition' // Seulement les conditions (en minuscules)\r\n      }\r\n    });\r\n    \r\n    console.log(`\uD83D\uDD04 [TBL UPDATE] Trouv\u00E9 ${submissionData.length} donn\u00E9es de conditions \u00E0 mettre \u00E0 jour`);\r\n    \r\n    const calculator = new CapacityCalculator();\r\n    const context = {\r\n      submissionId,\r\n      organizationId: 'test-org',\r\n      userId: 'test-user'\r\n    };\r\n    \r\n    let updated = 0;\r\n    const errors = [];\r\n    \r\n    for (const data of submissionData) {\r\n      try {\r\n        const conditionId = data.sourceRef;\r\n        if (!conditionId) {\r\n          console.log(`\u26A0\uFE0F [TBL UPDATE] Pas de sourceRef pour ${data.id}, ignor\u00E9`);\r\n          continue;\r\n        }\r\n        \r\n        // \u00C9valuer avec CapacityCalculator\r\n        const result = await calculator.evaluateCondition(conditionId, context);\r\n        \r\n        // Cr\u00E9er le nouveau operationResult bas\u00E9 sur l'\u00E9valuation\r\n        const newOperationResult = result.success \r\n          ? {\r\n              success: true,\r\n              conditionId,\r\n              result: result.result,\r\n              evaluated: true,\r\n              timestamp: new Date().toISOString(),\r\n              method: 'CapacityCalculator'\r\n            }\r\n          : {\r\n              success: false,\r\n              conditionId,\r\n              error: result.error,\r\n              timestamp: new Date().toISOString(),\r\n              method: 'CapacityCalculator'\r\n            };\r\n        \r\n        // Mettre \u00E0 jour en base dans TreeBranchLeafSubmissionData\r\n        await prisma.treeBranchLeafSubmissionData.update({\r\n          where: { id: data.id },\r\n          data: {\r\n            operationResult: newOperationResult\r\n          }\r\n        });\r\n        \r\n        updated++;\r\n        console.log(`\u2705 [TBL UPDATE] Condition ${conditionId} mise \u00E0 jour:`, newOperationResult);\r\n        \r\n      } catch (error) {\r\n        errors.push({\r\n          dataId: data.id,\r\n          sourceRef: data.sourceRef,\r\n          error: error instanceof Error ? error.message : 'unknown'\r\n        });\r\n        console.error(`\u274C [TBL UPDATE] Erreur data ${data.id}:`, error);\r\n      }\r\n    }\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    return res.json({\r\n      success: true,\r\n      updated,\r\n      total: submissionData.length,\r\n      errors,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL UPDATE] Erreur globale:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD0D POST /api/tbl/check-submission-data\r\n * NOUVEAU : Inspecter les donn\u00E9es de soumission\r\n */\r\nrouter.post('/check-submission-data', async (req, res) => {\r\n  logRouteHit('POST /api/tbl/check-submission-data');\r\n  \r\n  try {\r\n    const { submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182' } = req.body || {};\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    // R\u00E9cup\u00E9rer toutes les donn\u00E9es de cette submission\r\n    const allData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId: submissionId }\r\n    });\r\n    \r\n    // Grouper par operationSource\r\n    const grouped = allData.reduce((acc, item) => {\r\n      const source = item.operationSource || 'null';\r\n      if (!acc[source]) acc[source] = [];\r\n      acc[source].push({\r\n        id: item.id,\r\n        sourceRef: item.sourceRef,\r\n        operationResult: item.operationResult\r\n      });\r\n      return acc;\r\n    }, {} as Record<string, any[]>);\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    return res.json({\r\n      success: true,\r\n      submissionId,\r\n      total: allData.length,\r\n      bySource: grouped,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL CHECK] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD04 POST /api/tbl/update-database-with-intelligent-translations\r\n * NOUVEAU : Met \u00E0 jour la base de donn\u00E9es avec les traductions intelligentes\r\n */\r\nrouter.post('/update-database-with-intelligent-translations', async (req, res) => {\r\n  logRouteHit('POST /api/tbl/update-database-with-intelligent-translations');\r\n  \r\n  try {\r\n    const { submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182' } = req.body || {};\r\n    \r\n    console.log('\uD83E\uDDE0 [TBL INTELLIGENT UPDATE] D\u00E9but mise \u00E0 jour avec traductions intelligentes');\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    // Import dynamique du traducteur\r\n    let TBLIntelligentTranslator;\r\n    try {\r\n      const translatorModule = await import('../../../../../../tbl-intelligent-translator.cjs');\r\n      TBLIntelligentTranslator = translatorModule.default;\r\n    } catch (error) {\r\n      console.error('\u274C [TBL INTELLIGENT] Impossible de charger TBLIntelligentTranslator:', error);\r\n      return res.status(500).json({ \r\n        success: false, \r\n        error: 'TBLIntelligentTranslator non disponible' \r\n      });\r\n    }\r\n    \r\n    const translator = new TBLIntelligentTranslator(prisma);\r\n    \r\n    // R\u00E9cup\u00E9rer toutes les donn\u00E9es de submission \u00E0 traduire\r\n    const submissionData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: {\r\n        submissionId: submissionId,\r\n        operationSource: {\r\n          in: ['condition', 'formula', 'table']\r\n        },\r\n        operationDetail: {\r\n          not: null\r\n        }\r\n      },\r\n      include: {\r\n        TreeBranchLeafNode: true\r\n      }\r\n    });\r\n    \r\n    console.log(`\uD83E\uDDE0 [TBL INTELLIGENT UPDATE] Trouv\u00E9 ${submissionData.length} donn\u00E9es \u00E0 traduire`);\r\n    \r\n    let updated = 0;\r\n    const errors = [];\r\n    \r\n    for (const data of submissionData) {\r\n      try {\r\n        console.log(`\uD83D\uDD27 [TBL INTELLIGENT] Traduction: ${data.TreeBranchLeafNode?.label || 'Sans nom'} (${data.operationSource})`);\r\n        \r\n        // G\u00E9n\u00E9rer la traduction intelligente\r\n        const intelligentResult = await translator.translateCapacity(\r\n          data.operationSource,\r\n          data.operationDetail,\r\n          data.sourceRef || data.nodeId,\r\n          data.submissionId\r\n        );\r\n        \r\n        console.log(`\u2705 [TBL INTELLIGENT] Traduction g\u00E9n\u00E9r\u00E9e: ${intelligentResult.substring(0, 100)}...`);\r\n        \r\n        // Mettre \u00E0 jour en base\r\n        await prisma.treeBranchLeafSubmissionData.update({\r\n          where: { id: data.id },\r\n          data: {\r\n            operationResult: intelligentResult,\r\n            lastResolved: new Date()\r\n          }\r\n        });\r\n        \r\n        updated++;\r\n        console.log(`\u2705 [TBL INTELLIGENT] Mis \u00E0 jour: ${data.id}`);\r\n        \r\n      } catch (error) {\r\n        errors.push({\r\n          dataId: data.id,\r\n          nodeLabel: data.TreeBranchLeafNode?.label,\r\n          error: error instanceof Error ? error.message : 'unknown'\r\n        });\r\n        console.error(`\u274C [TBL INTELLIGENT] Erreur data ${data.id}:`, error);\r\n      }\r\n    }\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    return res.json({\r\n      success: true,\r\n      message: 'Traductions intelligentes appliqu\u00E9es',\r\n      updated,\r\n      total: submissionData.length,\r\n      errors,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL INTELLIGENT UPDATE] Erreur globale:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD0D GET /api/tbl/check-intelligent-translations\r\n * NOUVEAU : V\u00E9rifier les traductions intelligentes en base\r\n */\r\nrouter.get('/check-intelligent-translations', async (req, res) => {\r\n  logRouteHit('GET /api/tbl/check-intelligent-translations');\r\n  \r\n  try {\r\n    const { submissionId = 'df833cac-0b44-4b2b-bb1c-de3878f00182' } = req.query;\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    // R\u00E9cup\u00E9rer les donn\u00E9es avec traductions r\u00E9centes\r\n    const recentData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { \r\n        submissionId: submissionId as string,\r\n        operationSource: {\r\n          in: ['condition', 'formula', 'table']\r\n        },\r\n        operationResult: {\r\n          not: null\r\n        }\r\n      },\r\n      include: {\r\n        TreeBranchLeafNode: true\r\n      },\r\n      orderBy: {\r\n        lastResolved: 'desc'\r\n      },\r\n      take: 10\r\n    });\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    const translations = recentData.map(data => ({\r\n      id: data.id,\r\n      nodeLabel: data.TreeBranchLeafNode?.label,\r\n      operationSource: data.operationSource,\r\n      operationResult: data.operationResult,\r\n      lastResolved: data.lastResolved,\r\n      isIntelligent: typeof data.operationResult === 'string' && \r\n                     !data.operationResult.includes('\u00C9valu\u00E9 dynamiquement par TBL Prisma') &&\r\n                     (data.operationResult.includes('Si ') || \r\n                      data.operationResult.includes('(/)') || \r\n                      data.operationResult.includes('Tableau'))\r\n    }));\r\n    \r\n    return res.json({\r\n      success: true,\r\n      submissionId,\r\n      total: recentData.length,\r\n      translations,\r\n      stats: {\r\n        intelligent: translations.filter(t => t.isIntelligent).length,\r\n        old: translations.filter(t => !t.isIntelligent).length\r\n      },\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL CHECK INTELLIGENT] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\nrouter.get('/nodes/:nodeId', async (req, res) => {\r\n  logRouteHit('GET /api/tbl/nodes/:nodeId');\r\n  \r\n  try {\r\n    const { nodeId } = req.params;\r\n    \r\n    console.log('\uD83D\uDD04 [TBL NODES] R\u00E9cup\u00E9ration node via TBL:', nodeId);\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId }\r\n    });\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    if (!node) {\r\n      return res.status(404).json({ success: false, error: 'Node non trouv\u00E9' });\r\n    }\r\n    \r\n    return res.json(node);\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL NODES] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD04 GET /api/tbl/reusables/conditions\r\n * NOUVEAU : Remplace /api/treebranchleaf/reusables/conditions\r\n */\r\nrouter.get('/reusables/conditions', async (req, res) => {\r\n  logRouteHit('GET /api/tbl/reusables/conditions');\r\n  \r\n  try {\r\n    console.log('\uD83D\uDD04 [TBL CONDITIONS] R\u00E9cup\u00E9ration conditions via TBL');\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    const conditions = await prisma.treeBranchLeafNodeCondition.findMany({\r\n      include: {\r\n        node: true\r\n      }\r\n    });\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    return res.json({\r\n      success: true,\r\n      conditions,\r\n      count: conditions.length\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL CONDITIONS] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD04 GET /api/tbl/reusables/formulas\r\n * NOUVEAU : Remplace /api/treebranchleaf/reusables/formulas\r\n */\r\nrouter.get('/reusables/formulas', async (req, res) => {\r\n  logRouteHit('GET /api/tbl/reusables/formulas');\r\n  \r\n  try {\r\n    console.log('\uD83D\uDD04 [TBL FORMULAS] R\u00E9cup\u00E9ration formules via TBL');\r\n    \r\n    const { PrismaClient } = await import('@prisma/client');\r\n    const prisma = new PrismaClient();\r\n    \r\n    const formulas = await prisma.treeBranchLeafNodeFormula.findMany({\r\n      include: {\r\n        node: true\r\n      }\r\n    });\r\n    \r\n    await prisma.$disconnect();\r\n    \r\n    return res.json({\r\n      success: true,\r\n      formulas,\r\n      count: formulas.length\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL FORMULAS] Erreur:', error);\r\n    return res.status(500).json({ \r\n      success: false, \r\n      error: 'Erreur interne', \r\n      details: error instanceof Error ? error.message : 'unknown' \r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83E\uDDE0 TBL BRIDGE INTELLIGENCE V2.0\r\n * \r\n * Extension du TBL Bridge pour g\u00E9rer intelligemment :\r\n * - Formules avec reconnaissance des codes TBL\r\n * - Conditions avec compr\u00E9hension des options + champs\r\n * - Tableaux avec mapping des donn\u00E9es sources\r\n * \r\n * Ce syst\u00E8me remplace TOUS les anciens syst\u00E8mes d'\u00E9valuation !\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\ninterface TBLElement {\r\n  id: string;\r\n  label: string;\r\n  tbl_code: string;\r\n  tbl_type: number;\r\n  tbl_capacity: number;\r\n  type: string;\r\n  parent_id?: string;\r\n}\r\n\r\ninterface TBLFormula {\r\n  id: string;\r\n  formula_content: string;\r\n  referenced_fields: string[]; // Codes TBL des champs r\u00E9f\u00E9renc\u00E9s\r\n  dependencies: TBLDependency[];\r\n}\r\n\r\ninterface TBLCondition {\r\n  id: string;\r\n  condition_logic: string;\r\n  trigger_elements: string[]; // Codes TBL des \u00E9l\u00E9ments d\u00E9clencheurs\r\n  target_elements: string[]; // Codes TBL des \u00E9l\u00E9ments cibles\r\n  option_mappings: TBLOptionMapping[];\r\n}\r\n\r\ninterface TBLTable {\r\n  id: string;\r\n  data_sources: string[]; // Codes TBL des sources de donn\u00E9es\r\n  computed_columns: string[]; // Codes TBL des colonnes calcul\u00E9es\r\n  relationships: TBLRelationship[];\r\n}\r\n\r\ninterface TBLDependency {\r\n  source_code: string; // Code TBL source\r\n  target_code: string; // Code TBL cible\r\n  dependency_type: 'formula' | 'condition' | 'data_flow';\r\n  relationship: 'affects' | 'depends_on' | 'triggers';\r\n}\r\n\r\ninterface TBLOptionMapping {\r\n  option_code: string; // Code TBL de l'option\r\n  field_code: string; // Code TBL du champ conditionnel\r\n  show_when_selected: boolean;\r\n}\r\n\r\ninterface TBLRelationship {\r\n  from_code: string;\r\n  to_code: string;\r\n  relationship_type: 'one_to_one' | 'one_to_many' | 'many_to_many';\r\n}\r\n\r\nexport class TBLIntelligence {\r\n  private prisma: PrismaClient;\r\n  private elementRegistry: Map<string, TBLElement> = new Map();\r\n  private formulaRegistry: Map<string, TBLFormula> = new Map();\r\n  private conditionRegistry: Map<string, TBLCondition> = new Map();\r\n  private tableRegistry: Map<string, TBLTable> = new Map();\r\n  private dataCache: Map<string, any> = new Map();\r\n\r\n  constructor() {\r\n    this.prisma = new PrismaClient();\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCD6 LECTURE ET D\u00C9CODAGE DES DONN\u00C9ES ENCOD\u00C9ES\r\n   * Lit les donn\u00E9es stock\u00E9es dans la base et les d\u00E9code pour \u00E9valuation\r\n   */\r\n  async readAndDecodeElementData(elementId: string, elementType: string): Promise<any> {\r\n    const cacheKey = `${elementType}_${elementId}`;\r\n    \r\n    // V\u00E9rifier le cache d'abord\r\n    if (this.dataCache.has(cacheKey)) {\r\n      console.log(`\uD83D\uDCD6 [TBL Intelligence] Donn\u00E9es en cache pour ${cacheKey}`);\r\n      return this.dataCache.get(cacheKey);\r\n    }\r\n\r\n    console.log(`\uD83D\uDCD6 [TBL Intelligence] Lecture donn\u00E9es encod\u00E9es pour ${elementType} ${elementId}`);\r\n    \r\n    let decodedData: any = {};\r\n\r\n    try {\r\n      switch (elementType) {\r\n        case 'formula':\r\n          decodedData = await this.readFormulaData(elementId);\r\n          break;\r\n        case 'condition':\r\n          decodedData = await this.readConditionData(elementId);\r\n          break;\r\n        case 'table':\r\n          decodedData = await this.readTableData(elementId);\r\n          break;\r\n        case 'field':\r\n          decodedData = await this.readFieldData(elementId);\r\n          break;\r\n        default:\r\n          console.warn(`Type d'\u00E9l\u00E9ment non support\u00E9 pour lecture donn\u00E9es: ${elementType}`);\r\n      }\r\n\r\n      // Mettre en cache\r\n      this.dataCache.set(cacheKey, decodedData);\r\n      \r\n      console.log(`\uD83D\uDCD6 [TBL Intelligence] Donn\u00E9es d\u00E9cod\u00E9es pour ${cacheKey}:`, decodedData);\r\n      return decodedData;\r\n\r\n    } catch (error) {\r\n      console.error(`\uD83D\uDCD6 [TBL Intelligence] Erreur lecture donn\u00E9es ${cacheKey}:`, error);\r\n      return {};\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE LECTURE DES DONN\u00C9ES DE FORMULE\r\n   */\r\n  private async readFormulaData(formulaId: string): Promise<any> {\r\n    const formula = await this.prisma.treeBranchLeafNodeFormula.findFirst({\r\n      where: { nodeId: formulaId }\r\n    });\r\n\r\n    if (!formula) return {};\r\n\r\n    // D\u00E9coder les tokens JSON\r\n    let tokens = [];\r\n    try {\r\n      tokens = formula.tokens ? JSON.parse(formula.tokens) : [];\r\n    } catch (e) {\r\n      console.warn('Erreur d\u00E9codage tokens formule:', e);\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer les variables et valeurs depuis les tokens\r\n    const variables: Record<string, any> = {};\r\n    const sequence = [];\r\n    \r\n    for (const token of tokens) {\r\n      if (token.type === 'variable' && token.variable_name && token.value !== null) {\r\n        variables[token.variable_name] = this.parseValue(token.value);\r\n      }\r\n      // Construire la s\u00E9quence d'\u00E9valuation\r\n      sequence.push(token.value || token.variable_name || token.operator);\r\n    }\r\n\r\n    return {\r\n      formula_content: formula.name || '',\r\n      tokens,\r\n      sequence,\r\n      variables,\r\n      description: formula.description\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD27 PARSEUR DE VALEURS\r\n   */\r\n  private parseValue(value: any): any {\r\n    if (value === null || value === undefined) return null;\r\n    \r\n    // Si c'est d\u00E9j\u00E0 un type primitif\r\n    if (typeof value === 'number' || typeof value === 'boolean') {\r\n      return value;\r\n    }\r\n    \r\n    if (typeof value === 'string') {\r\n      // Essayer de parser en JSON si \u00E7a ressemble \u00E0 du JSON\r\n      if ((value.startsWith('{') && value.endsWith('}')) || \r\n          (value.startsWith('[') && value.endsWith(']'))) {\r\n        try {\r\n          return JSON.parse(value);\r\n        } catch (e) {\r\n          return value;\r\n        }\r\n      }\r\n      \r\n      // Essayer de convertir en nombre\r\n      const num = parseFloat(value);\r\n      if (!isNaN(num) && isFinite(num)) {\r\n        return num;\r\n      }\r\n      \r\n      // Essayer de convertir en boolean\r\n      const lower = value.toLowerCase();\r\n      if (lower === 'true') return true;\r\n      if (lower === 'false') return false;\r\n      \r\n      return value;\r\n    }\r\n    \r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * \u2696\uFE0F LECTURE DES DONN\u00C9ES DE CONDITION\r\n   */\r\n  private async readConditionData(conditionId: string): Promise<any> {\r\n    const condition = await this.prisma.treeBranchLeafNodeCondition.findFirst({\r\n      where: { nodeId: conditionId }\r\n    });\r\n\r\n    if (!condition) return {};\r\n\r\n    // D\u00E9coder le conditionSet JSON\r\n    let conditionSet = {};\r\n    try {\r\n      conditionSet = condition.conditionSet ? JSON.parse(condition.conditionSet) : {};\r\n    } catch (e) {\r\n      console.warn('Erreur d\u00E9codage conditionSet:', e);\r\n    }\r\n\r\n    // Extraire les r\u00E8gles du conditionSet\r\n    const rules = Array.isArray(conditionSet.rules) ? conditionSet.rules : [];\r\n\r\n    return {\r\n      condition_type: condition.name,\r\n      conditionSet,\r\n      rules,\r\n      logic: conditionSet.logic || 'AND'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA LECTURE DES DONN\u00C9ES DE TABLEAU\r\n   */\r\n  private async readTableData(tableId: string): Promise<any> {\r\n    const table = await this.prisma.treeBranchLeafNodeTable.findFirst({\r\n      where: { nodeId: tableId }\r\n    });\r\n\r\n    if (!table) return {};\r\n\r\n    // D\u00E9coder les donn\u00E9es du tableau\r\n    let tableData = [];\r\n    let columns = [];\r\n    try {\r\n      tableData = table.data ? (typeof table.data === 'string' ? JSON.parse(table.data) : table.data) : [];\r\n      columns = table.columns ? (typeof table.columns === 'string' ? JSON.parse(table.columns) : table.columns) : [];\r\n    } catch (e) {\r\n      console.warn('Erreur d\u00E9codage donn\u00E9es tableau:', e);\r\n    }\r\n\r\n    return {\r\n      table_type: table.type,\r\n      columns: columns,\r\n      data: tableData,\r\n      metadata: {\r\n        rows: Array.isArray(tableData) ? tableData.length : 0,\r\n        has_formulas: Array.isArray(columns) ? columns.some((col: any) => col.formula) : false\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFF7\uFE0F LECTURE DES DONN\u00C9ES DE CHAMP\r\n   */\r\n  private async readFieldData(fieldId: string): Promise<any> {\r\n    const field = await this.prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: fieldId },\r\n      include: {\r\n        other_TreeBranchLeafNode: {\r\n          select: {\r\n            id: true,\r\n            label: true,\r\n            tbl_code: true,\r\n            value: true,\r\n            type: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!field) return {};\r\n\r\n    return {\r\n      field_type: field.type,\r\n      tbl_code: field.tbl_code,\r\n      value: this.parseValue(field.value),\r\n      options: field.other_TreeBranchLeafNode?.map(child => ({\r\n        id: child.id,\r\n        label: child.label,\r\n        tbl_code: child.tbl_code,\r\n        value: this.parseValue(child.value),\r\n        type: child.type\r\n      })) || []\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE MOTEUR DE CALCUL POUR FORMULES\r\n   * Ex\u00E9cute les calculs math\u00E9matiques avec support des variables TBL\r\n   */\r\n  async calculateFormula(formulaId: string, contextData: Record<string, unknown> = {}): Promise<{\r\n    result: number | string | boolean | null;\r\n    success: boolean;\r\n    error?: string;\r\n    steps: string[];\r\n  }> {\r\n    console.log(`\uD83E\uDDEE [TBL Intelligence] Calcul formule ${formulaId}`);\r\n    \r\n    const steps: string[] = [];\r\n    \r\n    try {\r\n      // Lire les donn\u00E9es de la formule\r\n      const formulaData = await this.readAndDecodeElementData(formulaId, 'formula');\r\n      if (!formulaData.sequence || !Array.isArray(formulaData.sequence)) {\r\n        throw new Error('S\u00E9quence de formule invalide');\r\n      }\r\n\r\n      steps.push(`\uD83D\uDCD6 Formule charg\u00E9e: ${formulaData.formula_content}`);\r\n      steps.push(`\uD83D\uDD22 Variables disponibles: ${Object.keys(formulaData.variables).join(', ')}`);\r\n\r\n      // Merger les variables avec le contexte\r\n      const allVariables = { ...formulaData.variables, ...contextData };\r\n      steps.push(`\uD83D\uDD17 Variables totales: ${Object.keys(allVariables).length}`);\r\n\r\n      // \u00C9valuer la s\u00E9quence\r\n      const result = await this.evaluateFormulaSequence(formulaData.sequence, allVariables, steps);\r\n      \r\n      steps.push(`\u2705 R\u00E9sultat final: ${result}`);\r\n      \r\n      return {\r\n        result,\r\n        success: true,\r\n        steps\r\n      };\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';\r\n      steps.push(`\u274C Erreur: ${errorMessage}`);\r\n      \r\n      return {\r\n        result: null,\r\n        success: false,\r\n        error: errorMessage,\r\n        steps\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDE9 \u00C9VALUATEUR DE S\u00C9QUENCE DE FORMULE\r\n   */\r\n  private async evaluateFormulaSequence(\r\n    sequence: unknown[], \r\n    variables: Record<string, unknown>, \r\n    steps: string[]\r\n  ): Promise<number | string | boolean | null> {\r\n    const stack: (number | string | boolean)[] = [];\r\n    \r\n    for (let i = 0; i < sequence.length; i++) {\r\n      const token = sequence[i];\r\n      steps.push(`\uD83D\uDD04 Token ${i}: ${JSON.stringify(token)}`);\r\n\r\n      if (typeof token === 'number') {\r\n        stack.push(token);\r\n        steps.push(`\uD83D\uDCCA Nombre ajout\u00E9: ${token}`);\r\n      } \r\n      else if (typeof token === 'string') {\r\n        // Variable TBL\r\n        if (token.startsWith('TBL_') && variables[token] !== undefined) {\r\n          const value = this.convertToNumber(variables[token]);\r\n          stack.push(value);\r\n          steps.push(`\uD83C\uDFF7\uFE0F Variable ${token} = ${value}`);\r\n        }\r\n        // Op\u00E9rateur\r\n        else if (['+', '-', '*', '/', '^', '>', '<', '>=', '<=', '==', '!=', 'AND', 'OR'].includes(token)) {\r\n          const result = this.executeOperation(token, stack, steps);\r\n          if (result !== null) {\r\n            stack.push(result);\r\n          }\r\n        }\r\n        // Fonction\r\n        else if (token.includes('(')) {\r\n          const result = await this.executeFunction(token, stack, variables, steps);\r\n          if (result !== null) {\r\n            stack.push(result);\r\n          }\r\n        }\r\n        // Constante string\r\n        else {\r\n          stack.push(token);\r\n          steps.push(`\uD83D\uDCDD String ajout\u00E9e: \"${token}\"`);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (stack.length === 1) {\r\n      return stack[0];\r\n    } else if (stack.length === 0) {\r\n      throw new Error('\u00C9valuation vide');\r\n    } else {\r\n      throw new Error(`\u00C9valuation ambigu\u00EB: ${stack.length} r\u00E9sultats`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u2699\uFE0F EX\u00C9CUTEUR D'OP\u00C9RATIONS\r\n   */\r\n  private executeOperation(operator: string, stack: (number | string | boolean)[], steps: string[]): number | boolean | null {\r\n    if (stack.length < 2) {\r\n      steps.push(`\u274C Pas assez d'op\u00E9randes pour ${operator}`);\r\n      return null;\r\n    }\r\n\r\n    const b = stack.pop();\r\n    const a = stack.pop();\r\n    \r\n    const numA = this.convertToNumber(a);\r\n    const numB = this.convertToNumber(b);\r\n    \r\n    let result: number | boolean;\r\n    \r\n    switch (operator) {\r\n      case '+': result = numA + numB; break;\r\n      case '-': result = numA - numB; break;\r\n      case '*': result = numA * numB; break;\r\n      case '/': \r\n        if (numB === 0) {\r\n          steps.push(`\u274C Division par z\u00E9ro`);\r\n          return null;\r\n        }\r\n        result = numA / numB; \r\n        break;\r\n      case '^': result = Math.pow(numA, numB); break;\r\n      case '>': result = numA > numB; break;\r\n      case '<': result = numA < numB; break;\r\n      case '>=': result = numA >= numB; break;\r\n      case '<=': result = numA <= numB; break;\r\n      case '==': result = a === b; break;\r\n      case '!=': result = a !== b; break;\r\n      case 'AND': result = Boolean(a) && Boolean(b); break;\r\n      case 'OR': result = Boolean(a) || Boolean(b); break;\r\n      default:\r\n        steps.push(`\u274C Op\u00E9rateur inconnu: ${operator}`);\r\n        return null;\r\n    }\r\n    \r\n    steps.push(`\uD83D\uDD22 ${a} ${operator} ${b} = ${result}`);\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD27 EX\u00C9CUTEUR DE FONCTIONS\r\n   */\r\n  private async executeFunction(\r\n    functionCall: string, \r\n    stack: (number | string | boolean)[], \r\n    variables: Record<string, unknown>, \r\n    steps: string[]\r\n  ): Promise<number | string | boolean | null> {\r\n    const match = functionCall.match(/^(\\w+)\\((.*)\\)$/);\r\n    if (!match) {\r\n      steps.push(`\u274C Format de fonction invalide: ${functionCall}`);\r\n      return null;\r\n    }\r\n\r\n    const funcName = match[1];\r\n    const argsStr = match[2];\r\n    \r\n    // Parser les arguments\r\n    const args: (number | string | boolean)[] = [];\r\n    if (argsStr.trim()) {\r\n      const argTokens = argsStr.split(',').map(s => s.trim());\r\n      for (const argToken of argTokens) {\r\n        if (argToken.startsWith('TBL_') && variables[argToken] !== undefined) {\r\n          args.push(this.convertToNumber(variables[argToken]));\r\n        } else if (!isNaN(Number(argToken))) {\r\n          args.push(Number(argToken));\r\n        } else {\r\n          args.push(argToken.replace(/['\"]/g, ''));\r\n        }\r\n      }\r\n    }\r\n\r\n    // Fonctions depuis la pile si pas d'arguments explicites\r\n    const requiredArgs = this.getFunctionArity(funcName);\r\n    while (args.length < requiredArgs && stack.length > 0) {\r\n      args.unshift(stack.pop()!);\r\n    }\r\n\r\n    let result: number | string | boolean | null = null;\r\n\r\n    switch (funcName.toUpperCase()) {\r\n      case 'SUM':\r\n        result = args.reduce((sum, val) => sum + this.convertToNumber(val), 0);\r\n        break;\r\n      case 'AVG':\r\n        result = args.length > 0 ? args.reduce((sum, val) => sum + this.convertToNumber(val), 0) / args.length : 0;\r\n        break;\r\n      case 'MIN':\r\n        result = Math.min(...args.map(val => this.convertToNumber(val)));\r\n        break;\r\n      case 'MAX':\r\n        result = Math.max(...args.map(val => this.convertToNumber(val)));\r\n        break;\r\n      case 'ROUND':\r\n        const num = this.convertToNumber(args[0]);\r\n        const decimals = args[1] ? this.convertToNumber(args[1]) : 0;\r\n        result = Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);\r\n        break;\r\n      case 'IF':\r\n        const condition = Boolean(args[0]);\r\n        result = condition ? args[1] : args[2];\r\n        break;\r\n      case 'CONCAT':\r\n        result = args.map(val => String(val)).join('');\r\n        break;\r\n      case 'LEN':\r\n        result = String(args[0]).length;\r\n        break;\r\n      default:\r\n        steps.push(`\u274C Fonction inconnue: ${funcName}`);\r\n        return null;\r\n    }\r\n\r\n    steps.push(`\uD83D\uDD27 ${funcName}(${args.join(', ')}) = ${result}`);\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA CONVERTISSEUR NUM\u00C9RIQUE INTELLIGENT\r\n   */\r\n  private convertToNumber(value: unknown): number {\r\n    if (typeof value === 'number') return value;\r\n    if (typeof value === 'boolean') return value ? 1 : 0;\r\n    if (typeof value === 'string') {\r\n      const num = parseFloat(value);\r\n      return isNaN(num) ? 0 : num;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * \u2696\uFE0F MOTEUR D'\u00C9VALUATION DES CONDITIONS\r\n   * \u00C9value les conditions logiques avec support des options et comparaisons\r\n   */\r\n  async evaluateCondition(conditionId: string, contextData: Record<string, unknown> = {}): Promise<{\r\n    result: boolean;\r\n    success: boolean;\r\n    error?: string;\r\n    details: string[];\r\n  }> {\r\n    console.log(`\u2696\uFE0F [TBL Intelligence] \u00C9valuation condition ${conditionId}`);\r\n    \r\n    const details: string[] = [];\r\n    \r\n    try {\r\n      // Lire les donn\u00E9es de la condition\r\n      const conditionData = await this.readAndDecodeElementData(conditionId, 'condition');\r\n      if (!conditionData.rules || !Array.isArray(conditionData.rules)) {\r\n        throw new Error('R\u00E8gles de condition invalides');\r\n      }\r\n\r\n      details.push(`\uD83D\uDCD6 Condition charg\u00E9e: ${conditionData.condition_type}`);\r\n      details.push(`\uD83D\uDCCB Nombre de r\u00E8gles: ${conditionData.rules.length}`);\r\n      details.push(`\uD83D\uDD17 Logique: ${conditionData.logic || 'AND'}`);\r\n\r\n      // \u00C9valuer chaque r\u00E8gle\r\n      const ruleResults: boolean[] = [];\r\n      for (let i = 0; i < conditionData.rules.length; i++) {\r\n        const rule = conditionData.rules[i];\r\n        const ruleResult = await this.evaluateConditionRule(rule, contextData, details, i);\r\n        ruleResults.push(ruleResult);\r\n      }\r\n\r\n      // Appliquer la logique globale\r\n      const finalResult = this.applyLogicToResults(ruleResults, conditionData.logic || 'AND', details);\r\n      \r\n      details.push(`\u2705 R\u00E9sultat final: ${finalResult}`);\r\n      \r\n      return {\r\n        result: finalResult,\r\n        success: true,\r\n        details\r\n      };\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';\r\n      details.push(`\u274C Erreur: ${errorMessage}`);\r\n      \r\n      return {\r\n        result: false,\r\n        success: false,\r\n        error: errorMessage,\r\n        details\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCF \u00C9VALUATEUR DE R\u00C8GLE INDIVIDUELLE\r\n   */\r\n  private async evaluateConditionRule(\r\n    rule: {\r\n      operator: string;\r\n      value: unknown;\r\n      source_node_id?: string;\r\n      target_node_id?: string;\r\n      logical_operator?: string;\r\n    },\r\n    contextData: Record<string, unknown>,\r\n    details: string[],\r\n    ruleIndex: number\r\n  ): Promise<boolean> {\r\n    details.push(`\uD83D\uDD0D R\u00E8gle ${ruleIndex + 1}: ${rule.operator}`);\r\n\r\n    // R\u00E9cup\u00E9rer la valeur source\r\n    let sourceValue: unknown;\r\n    if (rule.source_node_id) {\r\n      // Lire depuis la base de donn\u00E9es\r\n      const sourceElement = await this.prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: rule.source_node_id },\r\n        select: { \r\n          value: true, \r\n          tbl_code: true, \r\n          label: true,\r\n          other_TreeBranchLeafNode: {\r\n            select: {\r\n              id: true,\r\n              value: true,\r\n              tbl_code: true,\r\n              label: true\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      if (sourceElement) {\r\n        sourceValue = this.parseValue(sourceElement.value);\r\n        details.push(`\uD83D\uDCCA Source ${sourceElement.tbl_code}: ${sourceValue}`);\r\n        \r\n        // Si c'est un champ avec options, v\u00E9rifier si une option est s\u00E9lectionn\u00E9e\r\n        if (sourceElement.other_TreeBranchLeafNode && sourceElement.other_TreeBranchLeafNode.length > 0) {\r\n          const selectedOption = sourceElement.other_TreeBranchLeafNode.find(child => \r\n            child.value === sourceValue || child.tbl_code === sourceValue\r\n          );\r\n          if (selectedOption) {\r\n            sourceValue = selectedOption.value || selectedOption.tbl_code;\r\n            details.push(`\uD83C\uDFAF Option s\u00E9lectionn\u00E9e: ${selectedOption.label} (${sourceValue})`);\r\n          }\r\n        }\r\n      } else {\r\n        details.push(`\u274C Source non trouv\u00E9e: ${rule.source_node_id}`);\r\n        sourceValue = null;\r\n      }\r\n    } else if (contextData) {\r\n      // Chercher dans le contexte\r\n      sourceValue = contextData.sourceValue || null;\r\n      details.push(`\uD83D\uDD17 Valeur du contexte: ${sourceValue}`);\r\n    }\r\n\r\n    // Valeur de comparaison\r\n    const compareValue = rule.value;\r\n    details.push(`\u2696\uFE0F Comparaison: ${sourceValue} ${rule.operator} ${compareValue}`);\r\n\r\n    // Effectuer la comparaison\r\n    const result = this.compareValues(sourceValue, rule.operator, compareValue);\r\n    details.push(`\uD83D\uDCCA R\u00E9sultat r\u00E8gle ${ruleIndex + 1}: ${result}`);\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD0D COMPARATEUR DE VALEURS UNIVERSEL\r\n   */\r\n  private compareValues(sourceValue: unknown, operator: string, compareValue: unknown): boolean {\r\n    // Normaliser les valeurs\r\n    const source = this.normalizeValueForComparison(sourceValue);\r\n    const compare = this.normalizeValueForComparison(compareValue);\r\n\r\n    switch (operator) {\r\n      case '==':\r\n      case 'equals':\r\n        return source === compare;\r\n      \r\n      case '!=':\r\n      case 'not_equals':\r\n        return source !== compare;\r\n      \r\n      case '>':\r\n      case 'greater_than':\r\n        return Number(source) > Number(compare);\r\n      \r\n      case '>=':\r\n      case 'greater_than_or_equal':\r\n        return Number(source) >= Number(compare);\r\n      \r\n      case '<':\r\n      case 'less_than':\r\n        return Number(source) < Number(compare);\r\n      \r\n      case '<=':\r\n      case 'less_than_or_equal':\r\n        return Number(source) <= Number(compare);\r\n      \r\n      case 'contains':\r\n        return String(source).toLowerCase().includes(String(compare).toLowerCase());\r\n      \r\n      case 'starts_with':\r\n        return String(source).toLowerCase().startsWith(String(compare).toLowerCase());\r\n      \r\n      case 'ends_with':\r\n        return String(source).toLowerCase().endsWith(String(compare).toLowerCase());\r\n      \r\n      case 'is_empty':\r\n        return !source || source === '' || source === null || source === undefined;\r\n      \r\n      case 'is_not_empty':\r\n        return !(!source || source === '' || source === null || source === undefined);\r\n      \r\n      case 'in':\r\n        if (Array.isArray(compare)) {\r\n          return compare.includes(source);\r\n        }\r\n        return String(compare).split(',').map(s => s.trim()).includes(String(source));\r\n      \r\n      case 'not_in':\r\n        if (Array.isArray(compare)) {\r\n          return !compare.includes(source);\r\n        }\r\n        return !String(compare).split(',').map(s => s.trim()).includes(String(source));\r\n      \r\n      default:\r\n        console.warn(`Op\u00E9rateur de comparaison non support\u00E9: ${operator}`);\r\n        return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD27 NORMALISATEUR DE VALEURS POUR COMPARAISON\r\n   */\r\n  private normalizeValueForComparison(value: unknown): string | number | boolean | null {\r\n    if (value === null || value === undefined) return null;\r\n    \r\n    if (typeof value === 'boolean') return value;\r\n    if (typeof value === 'number') return value;\r\n    \r\n    if (typeof value === 'string') {\r\n      // Tenter de convertir en nombre si c'est possible\r\n      const num = parseFloat(value.trim());\r\n      if (!isNaN(num) && isFinite(num)) {\r\n        return num;\r\n      }\r\n      \r\n      // Tenter de convertir en boolean\r\n      const lower = value.toLowerCase().trim();\r\n      if (lower === 'true' || lower === '1') return true;\r\n      if (lower === 'false' || lower === '0') return false;\r\n      \r\n      return value.trim();\r\n    }\r\n    \r\n    return String(value);\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE APPLICATEUR DE LOGIQUE GLOBALE\r\n   */\r\n  private applyLogicToResults(results: boolean[], logic: string, details: string[]): boolean {\r\n    details.push(`\uD83E\uDDEE Application logique ${logic} sur ${results.length} r\u00E9sultats: [${results.join(', ')}]`);\r\n\r\n    switch (logic.toUpperCase()) {\r\n      case 'AND':\r\n        const andResult = results.every(r => r);\r\n        details.push(`\uD83D\uDD17 AND: tous vrais = ${andResult}`);\r\n        return andResult;\r\n      \r\n      case 'OR':\r\n        const orResult = results.some(r => r);\r\n        details.push(`\uD83D\uDD17 OR: au moins un vrai = ${orResult}`);\r\n        return orResult;\r\n      \r\n      case 'XOR':\r\n        const trueCount = results.filter(r => r).length;\r\n        const xorResult = trueCount === 1;\r\n        details.push(`\uD83D\uDD17 XOR: exactement un vrai = ${xorResult}`);\r\n        return xorResult;\r\n      \r\n      case 'NAND':\r\n        const nandResult = !results.every(r => r);\r\n        details.push(`\uD83D\uDD17 NAND: pas tous vrais = ${nandResult}`);\r\n        return nandResult;\r\n      \r\n      case 'NOR':\r\n        const norResult = !results.some(r => r);\r\n        details.push(`\uD83D\uDD17 NOR: aucun vrai = ${norResult}`);\r\n        return norResult;\r\n      \r\n      default:\r\n        details.push(`\u26A0\uFE0F Logique inconnue ${logic}, utilisation de AND par d\u00E9faut`);\r\n        return results.every(r => r);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA MOTEUR D'ANALYSE ET TRAITEMENT DES TABLEAUX\r\n   * Analyse les structures de tableaux avec donn\u00E9es dynamiques et formules\r\n   */\r\n  async processTable(tableId: string, contextData: Record<string, unknown> = {}): Promise<{\r\n    processedData: unknown[][];\r\n    metadata: {\r\n      rows: number;\r\n      columns: number;\r\n      hasFormulas: boolean;\r\n      calculatedCells: number;\r\n    };\r\n    success: boolean;\r\n    error?: string;\r\n    processing: string[];\r\n  }> {\r\n    console.log(`\uD83D\uDCCA [TBL Intelligence] Traitement tableau ${tableId}`);\r\n    \r\n    const processing: string[] = [];\r\n    \r\n    try {\r\n      // Lire les donn\u00E9es du tableau\r\n      const tableData = await this.readAndDecodeElementData(tableId, 'table');\r\n      if (!tableData.columns || !Array.isArray(tableData.columns)) {\r\n        throw new Error('Structure de tableau invalide');\r\n      }\r\n\r\n      processing.push(`\uD83D\uDCD6 Tableau charg\u00E9: ${tableData.table_type}`);\r\n      processing.push(`\uD83D\uDCCB Colonnes: ${tableData.columns.length}`);\r\n      processing.push(`\uD83D\uDCCA Lignes de donn\u00E9es: ${tableData.data.length}`);\r\n\r\n      // Analyser les colonnes avec formules\r\n      const formulaColumns = tableData.columns.filter((col: { formula: unknown }) => col.formula);\r\n      processing.push(`\uD83E\uDDEE Colonnes avec formules: ${formulaColumns.length}`);\r\n\r\n      // Traiter les donn\u00E9es ligne par ligne\r\n      const processedData: unknown[][] = [];\r\n      let calculatedCells = 0;\r\n\r\n      for (let rowIndex = 0; rowIndex < tableData.data.length; rowIndex++) {\r\n        const row = tableData.data[rowIndex];\r\n        const processedRow: unknown[] = [];\r\n        \r\n        processing.push(`\uD83D\uDD04 Traitement ligne ${rowIndex + 1}`);\r\n\r\n        for (let colIndex = 0; colIndex < tableData.columns.length; colIndex++) {\r\n          const column = tableData.columns[colIndex];\r\n          let cellValue = row[colIndex] || null;\r\n\r\n          // Si la colonne a une formule, la calculer\r\n          if (column.formula) {\r\n            processing.push(`\uD83E\uDDEE Calcul formule colonne ${column.name}: ${column.formula}`);\r\n            \r\n            try {\r\n              // Cr\u00E9er le contexte pour cette cellule\r\n              const cellContext = {\r\n                ...contextData,\r\n                rowIndex,\r\n                colIndex,\r\n                rowData: row,\r\n                currentValue: cellValue\r\n              };\r\n\r\n              // Calculer la formule\r\n              const formulaResult = await this.calculateTableFormula(\r\n                column.formula, \r\n                cellContext, \r\n                tableData.data,\r\n                rowIndex,\r\n                colIndex\r\n              );\r\n\r\n              if (formulaResult.success) {\r\n                cellValue = formulaResult.result;\r\n                calculatedCells++;\r\n                processing.push(`\u2705 Formule calcul\u00E9e: ${formulaResult.result}`);\r\n              } else {\r\n                processing.push(`\u274C Erreur formule: ${formulaResult.error}`);\r\n              }\r\n\r\n            } catch (error) {\r\n              const errorMsg = error instanceof Error ? error.message : 'Erreur calcul';\r\n              processing.push(`\u274C Erreur calcul cellule [${rowIndex}, ${colIndex}]: ${errorMsg}`);\r\n            }\r\n          }\r\n\r\n          processedRow.push(cellValue);\r\n        }\r\n\r\n        processedData.push(processedRow);\r\n      }\r\n\r\n      const metadata = {\r\n        rows: processedData.length,\r\n        columns: tableData.columns.length,\r\n        hasFormulas: formulaColumns.length > 0,\r\n        calculatedCells\r\n      };\r\n\r\n      processing.push(`\u2705 Tableau trait\u00E9: ${metadata.rows}x${metadata.columns}, ${calculatedCells} cellules calcul\u00E9es`);\r\n\r\n      return {\r\n        processedData,\r\n        metadata,\r\n        success: true,\r\n        processing\r\n      };\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';\r\n      processing.push(`\u274C Erreur: ${errorMessage}`);\r\n      \r\n      return {\r\n        processedData: [],\r\n        metadata: { rows: 0, columns: 0, hasFormulas: false, calculatedCells: 0 },\r\n        success: false,\r\n        error: errorMessage,\r\n        processing\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE CALCULATEUR DE FORMULES DE TABLEAU\r\n   */\r\n  private async calculateTableFormula(\r\n    formula: string,\r\n    cellContext: Record<string, unknown>,\r\n    tableData: unknown[][],\r\n    rowIndex: number,\r\n    colIndex: number\r\n  ): Promise<{ result: unknown; success: boolean; error?: string }> {\r\n    try {\r\n      // Variables sp\u00E9ciales pour les tableaux\r\n      const tableVariables: Record<string, unknown> = {\r\n        // Variables de position\r\n        ROW_INDEX: rowIndex,\r\n        COL_INDEX: colIndex,\r\n        ROW_NUMBER: rowIndex + 1,\r\n        COL_NUMBER: colIndex + 1,\r\n        \r\n        // Variables de donn\u00E9es\r\n        CURRENT_VALUE: cellContext.currentValue,\r\n        ROW_DATA: cellContext.rowData,\r\n        \r\n        // Fonctions de tableau\r\n        TABLE_ROWS: tableData.length,\r\n        TABLE_COLS: tableData[0]?.length || 0\r\n      };\r\n\r\n      // Ajouter les valeurs des autres cellules accessibles\r\n      for (let r = 0; r < tableData.length; r++) {\r\n        for (let c = 0; c < (tableData[r]?.length || 0); c++) {\r\n          if (r !== rowIndex || c !== colIndex) {\r\n            tableVariables[`CELL_${r}_${c}`] = tableData[r][c];\r\n            tableVariables[`R${r}C${c}`] = tableData[r][c];\r\n          }\r\n        }\r\n      }\r\n\r\n      // Parser et \u00E9valuer la formule\r\n      const result = await this.evaluateTableFormula(formula, tableVariables, cellContext);\r\n\r\n      return {\r\n        result,\r\n        success: true\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        result: null,\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Erreur calcul formule'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD22 \u00C9VALUATEUR DE FORMULES DE TABLEAU\r\n   */\r\n  private async evaluateTableFormula(\r\n    formula: string,\r\n    variables: Record<string, unknown>,\r\n    context: Record<string, unknown>\r\n  ): Promise<unknown> {\r\n    // Remplacer les r\u00E9f\u00E9rences de cellules et variables\r\n    let processedFormula = formula;\r\n\r\n    // Remplacer les r\u00E9f\u00E9rences de cellules (ex: R0C1, CELL_0_1)\r\n    processedFormula = processedFormula.replace(/R(\\d+)C(\\d+)/g, (match, row, col) => {\r\n      const value = variables[`R${row}C${col}`];\r\n      return typeof value === 'number' ? value.toString() : `\"${value}\"`;\r\n    });\r\n\r\n    // Remplacer les variables connues\r\n    for (const [varName, varValue] of Object.entries(variables)) {\r\n      if (processedFormula.includes(varName)) {\r\n        const replacement = typeof varValue === 'number' ? varValue.toString() : `\"${varValue}\"`;\r\n        processedFormula = processedFormula.replace(new RegExp(varName, 'g'), replacement);\r\n      }\r\n    }\r\n\r\n    // Fonctions sp\u00E9ciales de tableau\r\n    processedFormula = await this.replaceTableFunctions(processedFormula, variables, context);\r\n\r\n    // \u00C9valuer l'expression JavaScript s\u00E9curis\u00E9e\r\n    try {\r\n      return this.safeEvaluateExpression(processedFormula);\r\n    } catch (error) {\r\n      console.warn('Formule non \u00E9valuable comme JS, tentative d\\'\u00E9valuation simple:', processedFormula);\r\n      return processedFormula;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD27 REMPLACEUR DE FONCTIONS DE TABLEAU\r\n   */\r\n  private async replaceTableFunctions(\r\n    formula: string,\r\n    variables: Record<string, unknown>,\r\n    context: Record<string, unknown>\r\n  ): Promise<string> {\r\n    let result = formula;\r\n\r\n    // SUM_ROW() - Somme de la ligne courante\r\n    result = result.replace(/SUM_ROW\\(\\)/g, () => {\r\n      const rowData = context.rowData as unknown[];\r\n      if (Array.isArray(rowData)) {\r\n        const sum = rowData.reduce((acc, val) => acc + (Number(val) || 0), 0);\r\n        return sum.toString();\r\n      }\r\n      return '0';\r\n    });\r\n\r\n    // SUM_COL(colIndex) - Somme d'une colonne\r\n    result = result.replace(/SUM_COL\\((\\d+)\\)/g, (match, colIndex) => {\r\n      const col = Number(colIndex);\r\n      const tableRows = variables.TABLE_ROWS as number;\r\n      let sum = 0;\r\n      \r\n      for (let r = 0; r < tableRows; r++) {\r\n        const cellValue = variables[`R${r}C${col}`];\r\n        sum += Number(cellValue) || 0;\r\n      }\r\n      \r\n      return sum.toString();\r\n    });\r\n\r\n    // AVG_ROW() - Moyenne de la ligne courante\r\n    result = result.replace(/AVG_ROW\\(\\)/g, () => {\r\n      const rowData = context.rowData as unknown[];\r\n      if (Array.isArray(rowData) && rowData.length > 0) {\r\n        const sum = rowData.reduce((acc, val) => acc + (Number(val) || 0), 0);\r\n        return (sum / rowData.length).toString();\r\n      }\r\n      return '0';\r\n    });\r\n\r\n    // COUNT_NON_EMPTY_ROW() - Compte les cellules non vides de la ligne\r\n    result = result.replace(/COUNT_NON_EMPTY_ROW\\(\\)/g, () => {\r\n      const rowData = context.rowData as unknown[];\r\n      if (Array.isArray(rowData)) {\r\n        const count = rowData.filter(val => val !== null && val !== undefined && val !== '').length;\r\n        return count.toString();\r\n      }\r\n      return '0';\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD12 \u00C9VALUATEUR D'EXPRESSIONS S\u00C9CURIS\u00C9\r\n   */\r\n  private safeEvaluateExpression(expression: string): unknown {\r\n    // Whitelist des op\u00E9rations autoris\u00E9es\r\n    const allowedPattern = /^[\\d\\s+\\-*/().,\"'>=<!&|]+$/;\r\n    \r\n    if (!allowedPattern.test(expression)) {\r\n      throw new Error('Expression contient des caract\u00E8res non autoris\u00E9s');\r\n    }\r\n\r\n    // \u00C9valuation s\u00E9curis\u00E9e avec Function\r\n    try {\r\n      const func = new Function(`\"use strict\"; return (${expression});`);\r\n      return func();\r\n    } catch (error) {\r\n      throw new Error(`Erreur \u00E9valuation: ${error instanceof Error ? error.message : 'Inconnue'}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD22 ARIT\u00C9 DES FONCTIONS (compl\u00E9t\u00E9e)\r\n   */\r\n  private getFunctionArity(funcName: string): number {\r\n    switch (funcName.toUpperCase()) {\r\n      case 'SUM': case 'AVG': case 'MIN': case 'MAX': return 0; // Variable\r\n      case 'ROUND': return 1;\r\n      case 'IF': return 3;\r\n      case 'CONCAT': return 0; // Variable\r\n      case 'LEN': return 1;\r\n      case 'SUM_ROW': case 'AVG_ROW': case 'COUNT_NON_EMPTY_ROW': return 0;\r\n      case 'SUM_COL': return 1;\r\n      default: return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD0D ANALYSE COMPL\u00C8TE D'UN \u00C9L\u00C9MENT\r\n   * Analyse un \u00E9l\u00E9ment par son CODE TBL ou son UUID\r\n   */\r\n  async analyzeElement(elementIdentifier: string): Promise<{\r\n    element: TBLElement;\r\n    formulas: TBLFormula[];\r\n    conditions: TBLCondition[];\r\n    tables: TBLTable[];\r\n    dependencies: TBLDependency[];\r\n  }> {\r\n    console.log(`\uD83E\uDDE0 [TBL Intelligence] Analyse compl\u00E8te de ${elementIdentifier}`);\r\n\r\n    // \uD83D\uDE80 NOUVEAU SYST\u00C8ME TBL BRIDGE : Recherche UNIQUEMENT sur code TBL\r\n    console.log(`\uD83D\uDD0D Recherche TBL Bridge sur code: ${elementIdentifier}`);\r\n\r\n    // 1. R\u00E9cup\u00E9rer l'\u00E9l\u00E9ment avec ses relations par code TBL\r\n    const element = await this.prisma.treeBranchLeafNode.findFirst({\r\n      where: { tbl_code: elementIdentifier },  // UNIQUEMENT code TBL !\r\n      include: {\r\n        TreeBranchLeafNodeFormula: true,\r\n        TreeBranchLeafNodeCondition: true,\r\n        TreeBranchLeafNodeTable: true,\r\n        other_TreeBranchLeafNode: {\r\n          select: {\r\n            id: true,\r\n            label: true,\r\n            tbl_code: true,\r\n            tbl_type: true,\r\n            tbl_capacity: true,\r\n            type: true\r\n          }\r\n        },\r\n        TreeBranchLeafNode: {\r\n          select: {\r\n            id: true,\r\n            label: true,\r\n            tbl_code: true,\r\n            tbl_type: true,\r\n            type: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!element) {\r\n      throw new Error(`\u274C \u00C9l\u00E9ment TBL Bridge avec code \"${elementIdentifier}\" non trouv\u00E9 dans la base de donn\u00E9es`);\r\n    }\r\n    \r\n    console.log(`\u2705 \u00C9l\u00E9ment TBL Bridge trouv\u00E9: ${element.label} (${element.type})`);\r\n    console.log(`   \uD83C\uDFAF TBL Code: ${element.tbl_code}`);\r\n    console.log(`   \uD83C\uDFD7\uFE0F Type TBL: ${element.tbl_type} | \uD83D\uDD27 Capacit\u00E9 TBL: ${element.tbl_capacity}`);\r\n    \r\n    // \uD83D\uDE80 NOUVEAU SYST\u00C8ME : Utilisation directe des colonnes natives tbl_type et tbl_capacity\r\n    const typeDescription = this.getTBLTypeDescription(element.tbl_type);\r\n    const capacityDescription = this.getTBLCapacityDescription(element.tbl_capacity);\r\n    console.log(`   \uD83D\uDCCB TBL Intelligence: ${typeDescription} avec ${capacityDescription}`);\r\n\r\n    const tblElement: TBLElement = {\r\n      id: element.id,\r\n      label: element.label,\r\n      tbl_code: element.tbl_code || '',\r\n      tbl_type: element.tbl_type || 0,\r\n      tbl_capacity: element.tbl_capacity || 0,\r\n      type: element.type,\r\n      parent_id: element.parent_id || undefined\r\n    };\r\n\r\n    // \uD83D\uDE80 TBL BRIDGE V2.0 : Analyse bas\u00E9e sur les colonnes natives\r\n    console.log(`\uD83E\uDDE0 [TBL Intelligence V2.0] Analyse des capacit\u00E9s via colonnes Prisma...`);\r\n    \r\n    // 2. Analyser les capacit\u00E9s selon tbl_capacity (plus besoin de regex !)\r\n    const formulas = element.tbl_capacity === 2 ? await this.analyzeFormulas(element.TreeBranchLeafNodeFormula || []) : [];\r\n    const conditions = element.tbl_capacity === 3 ? await this.analyzeConditions(element.TreeBranchLeafNodeCondition || []) : [];\r\n    const tables = element.tbl_capacity === 4 ? await this.analyzeTables(element.TreeBranchLeafNodeTable || []) : [];\r\n    \r\n    console.log(`\uD83D\uDCCA [TBL V2.0] R\u00E9sultats: ${formulas.length} formules, ${conditions.length} conditions, ${tables.length} tableaux`);\r\n\r\n    // 5. Construire le graphe de d\u00E9pendances\r\n    const dependencies = await this.buildDependencyGraph(tblElement, formulas, conditions, tables);\r\n\r\n    console.log(`\u2705 [TBL Intelligence] Analyse termin\u00E9e pour ${element.label} (${element.tbl_code})`);\r\n    console.log(`   \uD83D\uDCCA ${formulas.length} formules, ${conditions.length} conditions, ${tables.length} tableaux`);\r\n    console.log(`   \uD83D\uDD17 ${dependencies.length} d\u00E9pendances d\u00E9tect\u00E9es`);\r\n\r\n    return {\r\n      element: tblElement,\r\n      formulas,\r\n      conditions,\r\n      tables,\r\n      dependencies\r\n    };\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE ANALYSE DES FORMULES\r\n   * Extrait les codes TBL r\u00E9f\u00E9renc\u00E9s dans les formules\r\n   */\r\n  private async analyzeFormulas(formulas: any[]): Promise<TBLFormula[]> {\r\n    const tblFormulas: TBLFormula[] = [];\r\n\r\n    for (const formula of formulas) {\r\n      console.log(`\uD83E\uDDEE [TBL Intelligence] Analyse formule ${formula.id}`);\r\n\r\n      // Extraire les tokens pour identifier les r\u00E9f\u00E9rences (depuis le JSON)\r\n      const referencedFields: string[] = [];\r\n      const dependencies: TBLDependency[] = [];\r\n\r\n      const tokens = Array.isArray(formula.tokens) ? formula.tokens : [];\r\n      for (const token of tokens) {\r\n        if (token.type === 'variable' && token.reference_id) {\r\n          // R\u00E9cup\u00E9rer le code TBL de l'\u00E9l\u00E9ment r\u00E9f\u00E9renc\u00E9\r\n          const referencedElement = await this.prisma.treeBranchLeafNode.findUnique({\r\n            where: { id: token.reference_id },\r\n            select: { tbl_code: true, label: true }\r\n          });\r\n\r\n          if (referencedElement?.tbl_code) {\r\n            referencedFields.push(referencedElement.tbl_code);\r\n            dependencies.push({\r\n              source_code: referencedElement.tbl_code,\r\n              target_code: '', // Sera rempli par l'\u00E9l\u00E9ment parent\r\n              dependency_type: 'formula',\r\n              relationship: 'depends_on'\r\n            });\r\n\r\n            console.log(`   \uD83D\uDD17 R\u00E9f\u00E9rence d\u00E9tect\u00E9e: ${referencedElement.label} (${referencedElement.tbl_code})`);\r\n          }\r\n        }\r\n      }\r\n\r\n      tblFormulas.push({\r\n        id: formula.id,\r\n        formula_content: formula.sequence || '[]',\r\n        referenced_fields: referencedFields,\r\n        dependencies\r\n      });\r\n    }\r\n\r\n    return tblFormulas;\r\n  }\r\n\r\n  /**\r\n   * \u2696\uFE0F ANALYSE DES CONDITIONS\r\n   * Identifie les relations options + champs conditionnels\r\n   */\r\n  private async analyzeConditions(conditions: any[]): Promise<TBLCondition[]> {\r\n    const tblConditions: TBLCondition[] = [];\r\n\r\n    for (const condition of conditions) {\r\n      console.log(`\u2696\uFE0F [TBL Intelligence] Analyse condition ${condition.id}`);\r\n\r\n      const triggerElements: string[] = [];\r\n      const targetElements: string[] = [];\r\n      const optionMappings: TBLOptionMapping[] = [];\r\n\r\n      // Analyser les r\u00E8gles de condition\r\n      for (const rule of condition.TreeBranchLeafNodeConditionRule || []) {\r\n        // Si c'est une condition sur une option\r\n        if (rule.source_node_id) {\r\n          const sourceElement = await this.prisma.treeBranchLeafNode.findUnique({\r\n            where: { id: rule.source_node_id },\r\n            select: { \r\n              tbl_code: true, \r\n              label: true, \r\n              type: true,\r\n              other_TreeBranchLeafNode: {\r\n                select: {\r\n                  id: true,\r\n                  tbl_code: true,\r\n                  label: true,\r\n                  type: true\r\n                }\r\n              }\r\n            }\r\n          });\r\n\r\n          if (sourceElement?.tbl_code) {\r\n            triggerElements.push(sourceElement.tbl_code);\r\n\r\n            // Si c'est une option avec des champs conditionnels\r\n            if (sourceElement.type === 'leaf_option' || sourceElement.type === 'leaf_option_field') {\r\n              for (const child of sourceElement.other_TreeBranchLeafNode) {\r\n                if (child.tbl_code && child.type === 'leaf_field') {\r\n                  optionMappings.push({\r\n                    option_code: sourceElement.tbl_code,\r\n                    field_code: child.tbl_code,\r\n                    show_when_selected: rule.condition_value === 'true' || rule.condition_value === sourceElement.label\r\n                  });\r\n\r\n                  console.log(`   \uD83C\uDFAF Option + Champ d\u00E9tect\u00E9: ${sourceElement.label} (${sourceElement.tbl_code}) \u2192 ${child.label} (${child.tbl_code})`);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        // \u00C9l\u00E9ment cible de la condition\r\n        if (rule.target_node_id) {\r\n          const targetElement = await this.prisma.treeBranchLeafNode.findUnique({\r\n            where: { id: rule.target_node_id },\r\n            select: { tbl_code: true, label: true }\r\n          });\r\n\r\n          if (targetElement?.tbl_code) {\r\n            targetElements.push(targetElement.tbl_code);\r\n          }\r\n        }\r\n      }\r\n\r\n      tblConditions.push({\r\n        id: condition.id,\r\n        condition_logic: condition.logic || 'and',\r\n        trigger_elements: triggerElements,\r\n        target_elements: targetElements,\r\n        option_mappings: optionMappings\r\n      });\r\n    }\r\n\r\n    return tblConditions;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA ANALYSE DES TABLEAUX\r\n   * Identifie les sources de donn\u00E9es et relations\r\n   */\r\n  private async analyzeTables(tables: any[]): Promise<TBLTable[]> {\r\n    const tblTables: TBLTable[] = [];\r\n\r\n    for (const table of tables) {\r\n      console.log(`\uD83D\uDCCA [TBL Intelligence] Analyse tableau ${table.id}`);\r\n\r\n      const dataSources: string[] = [];\r\n      const computedColumns: string[] = [];\r\n      const relationships: TBLRelationship[] = [];\r\n\r\n      // Analyser les colonnes\r\n      for (const column of table.TreeBranchLeafNodeTableColumn || []) {\r\n        if (column.source_node_id) {\r\n          const sourceElement = await this.prisma.treeBranchLeafNode.findUnique({\r\n            where: { id: column.source_node_id },\r\n            select: { tbl_code: true, label: true, tbl_capacity: true }\r\n          });\r\n\r\n          if (sourceElement?.tbl_code) {\r\n            // Si c'est une colonne calcul\u00E9e (formule)\r\n            if (sourceElement.tbl_capacity === 2) {\r\n              computedColumns.push(sourceElement.tbl_code);\r\n            } else {\r\n              dataSources.push(sourceElement.tbl_code);\r\n            }\r\n\r\n            console.log(`   \uD83D\uDCCB Source donn\u00E9es: ${sourceElement.label} (${sourceElement.tbl_code})`);\r\n          }\r\n        }\r\n      }\r\n\r\n      tblTables.push({\r\n        id: table.id,\r\n        data_sources: dataSources,\r\n        computed_columns: computedColumns,\r\n        relationships\r\n      });\r\n    }\r\n\r\n    return tblTables;\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD17 CONSTRUCTION DU GRAPHE DE D\u00C9PENDANCES\r\n   * Cr\u00E9e le r\u00E9seau complet des relations entre \u00E9l\u00E9ments\r\n   */\r\n  private async buildDependencyGraph(\r\n    element: TBLElement,\r\n    formulas: TBLFormula[],\r\n    conditions: TBLCondition[],\r\n    tables: TBLTable[]\r\n  ): Promise<TBLDependency[]> {\r\n    const dependencies: TBLDependency[] = [];\r\n\r\n    // D\u00E9pendances des formules\r\n    for (const formula of formulas) {\r\n      for (const dep of formula.dependencies) {\r\n        dependencies.push({\r\n          ...dep,\r\n          target_code: element.tbl_code\r\n        });\r\n      }\r\n    }\r\n\r\n    // D\u00E9pendances des conditions\r\n    for (const condition of conditions) {\r\n      for (const triggerCode of condition.trigger_elements) {\r\n        for (const targetCode of condition.target_elements) {\r\n          dependencies.push({\r\n            source_code: triggerCode,\r\n            target_code: targetCode,\r\n            dependency_type: 'condition',\r\n            relationship: 'triggers'\r\n          });\r\n        }\r\n      }\r\n\r\n      // D\u00E9pendances des options + champs\r\n      for (const mapping of condition.option_mappings) {\r\n        dependencies.push({\r\n          source_code: mapping.option_code,\r\n          target_code: mapping.field_code,\r\n          dependency_type: 'condition',\r\n          relationship: 'triggers'\r\n        });\r\n      }\r\n    }\r\n\r\n    // D\u00E9pendances des tableaux\r\n    for (const table of tables) {\r\n      for (const sourceCode of table.data_sources) {\r\n        dependencies.push({\r\n          source_code: sourceCode,\r\n          target_code: element.tbl_code,\r\n          dependency_type: 'data_flow',\r\n          relationship: 'affects'\r\n        });\r\n      }\r\n    }\r\n\r\n    return dependencies;\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAF R\u00C9SOLUTION INTELLIGENTE\r\n   * R\u00E9sout une valeur en tenant compte de toutes les d\u00E9pendances TBL\r\n   */\r\n  async resolveValue(\r\n    elementCode: string, \r\n    context: Record<string, any> = {}\r\n  ): Promise<{\r\n    value: any;\r\n    dependencies_resolved: string[];\r\n    conditions_evaluated: string[];\r\n    formulas_calculated: string[];\r\n  }> {\r\n    console.log(`\uD83C\uDFAF [TBL Intelligence] R\u00E9solution intelligente de ${elementCode}`);\r\n\r\n    // R\u00E9cup\u00E9rer l'\u00E9l\u00E9ment par son code TBL\r\n    const element = await this.prisma.treeBranchLeafNode.findFirst({\r\n      where: { tbl_code: elementCode }\r\n    });\r\n\r\n    if (!element) {\r\n      throw new Error(`\u00C9l\u00E9ment avec code TBL ${elementCode} non trouv\u00E9`);\r\n    }\r\n\r\n    // Analyser l'\u00E9l\u00E9ment compl\u00E8tement\r\n    const analysis = await this.analyzeElement(element.id);\r\n\r\n    // R\u00E9soudre selon la capacit\u00E9\r\n    switch (analysis.element.tbl_capacity) {\r\n      case 2: // Formule\r\n        return await this.resolveFormula(analysis, context);\r\n      case 3: // Condition\r\n        return await this.resolveCondition(analysis, context);\r\n      case 4: // Tableau\r\n        return await this.resolveTable(analysis, context);\r\n      default: // Donn\u00E9e simple\r\n        return await this.resolveSimpleValue(analysis, context);\r\n    }\r\n  }\r\n\r\n  private async resolveFormula(analysis: any, context: Record<string, any>) {\r\n    // Implementation de r\u00E9solution de formule avec codes TBL\r\n    console.log(`\uD83E\uDDEE R\u00E9solution formule avec ${analysis.formulas.length} formules`);\r\n    return {\r\n      value: 0, // Calcul\u00E9 selon la formule\r\n      dependencies_resolved: analysis.formulas.flatMap((f: any) => f.referenced_fields),\r\n      conditions_evaluated: [],\r\n      formulas_calculated: analysis.formulas.map((f: any) => f.id)\r\n    };\r\n  }\r\n\r\n  private async resolveCondition(analysis: any, context: Record<string, any>) {\r\n    // Implementation de r\u00E9solution de condition avec options + champs\r\n    console.log(`\u2696\uFE0F R\u00E9solution condition avec ${analysis.conditions.length} conditions`);\r\n    return {\r\n      value: true, // \u00C9valu\u00E9 selon les conditions\r\n      dependencies_resolved: [],\r\n      conditions_evaluated: analysis.conditions.map((c: any) => c.id),\r\n      formulas_calculated: []\r\n    };\r\n  }\r\n\r\n  private async resolveTable(analysis: any, context: Record<string, any>) {\r\n    // Implementation de r\u00E9solution de tableau avec sources de donn\u00E9es\r\n    console.log(`\uD83D\uDCCA R\u00E9solution tableau avec ${analysis.tables.length} tableaux`);\r\n    return {\r\n      value: [], // Donn\u00E9es du tableau\r\n      dependencies_resolved: analysis.tables.flatMap((t: any) => t.data_sources),\r\n      conditions_evaluated: [],\r\n      formulas_calculated: []\r\n    };\r\n  }\r\n\r\n  private async resolveSimpleValue(analysis: any, context: Record<string, any>) {\r\n    // R\u00E9solution d'une valeur simple\r\n    const value = context[analysis.element.tbl_code] || null;\r\n    console.log(`\uD83D\uDCDD R\u00E9solution valeur simple: ${analysis.element.label} = ${value}`);\r\n    return {\r\n      value,\r\n      dependencies_resolved: [],\r\n      conditions_evaluated: [],\r\n      formulas_calculated: []\r\n    };\r\n  }\r\n\r\n  // \uD83D\uDE80 TBL BRIDGE V2.0 - M\u00E9thodes de description des types et capacit\u00E9s\r\n  \r\n  /**\r\n   * Retourne la description du type TBL selon le README\r\n   */\r\n  private getTBLTypeDescription(tbl_type: number): string {\r\n    const typeMap: Record<number, string> = {\r\n      1: \"Branche (Onglet TBL)\",\r\n      2: \"Sous-Branche (Liste d\u00E9roulante TBL)\",\r\n      3: \"Champ (Input utilisateur)\",\r\n      4: \"Option (Choix dans liste)\",\r\n      5: \"Option + champ (Option qui ouvre un champ)\",\r\n      6: \"Champ donn\u00E9es (Affichage donn\u00E9es calcul\u00E9es)\",\r\n      7: \"Section (Container pour champs donn\u00E9es)\"\r\n    };\r\n    \r\n    return typeMap[tbl_type] || `Type inconnu (${tbl_type})`;\r\n  }\r\n\r\n  /**\r\n   * Retourne la description de la capacit\u00E9 TBL selon le README\r\n   */\r\n  private getTBLCapacityDescription(tbl_capacity: number): string {\r\n    const capacityMap: Record<number, string> = {\r\n      1: \"Neutre (Pas de traitement sp\u00E9cial)\",\r\n      2: \"Formule (Calcul math\u00E9matique)\",\r\n      3: \"Condition (Logique if/then/else)\",\r\n      4: \"Tableau (Donn\u00E9es tabulaires)\"\r\n    };\r\n    \r\n    return capacityMap[tbl_capacity] || `Capacit\u00E9 inconnue (${tbl_capacity})`;\r\n  }\r\n}\r\n\r\nexport default TBLIntelligence;", "/**\r\n * \uD83D\uDE80 TBL EVALUATION ENGINE V2.0\r\n * \r\n * Moteur d'\u00E9valuation intelligent qui remplace TOUS les anciens syst\u00E8mes !\r\n * - Formules avec codes TBL\r\n * - Conditions avec options + champs\r\n * - Tableaux avec sources intelligentes\r\n * - R\u00E9solution automatique des d\u00E9pendances\r\n */\r\n\r\nimport TBLIntelligence from './TBLIntelligence';\r\n\r\ninterface TBLEvaluationRequest {\r\n  element_code: string; // Code TBL de l'\u00E9l\u00E9ment \u00E0 \u00E9valuer\r\n  context_values: Record<string, unknown>; // Valeurs du contexte actuel\r\n  evaluation_mode: 'formula' | 'condition' | 'table' | 'auto';\r\n  deep_resolution: boolean; // R\u00E9soudre toutes les d\u00E9pendances en cascade\r\n}\r\n\r\ninterface TBLEvaluationResult {\r\n  success: boolean;\r\n  element_code: string;\r\n  final_value: unknown;\r\n  evaluation_path: string[]; // Codes TBL \u00E9valu\u00E9s dans l'ordre\r\n  dependencies_used: string[]; // Codes TBL des d\u00E9pendances utilis\u00E9es\r\n  options_triggered: Array<{\r\n    option_code: string;\r\n    field_code: string;\r\n    show_field: boolean;\r\n  }>;\r\n  formulas_calculated: Array<{\r\n    formula_id: string;\r\n    referenced_codes: string[];\r\n    result: number;\r\n  }>;\r\n  conditions_evaluated: Array<{\r\n    condition_id: string;\r\n    trigger_codes: string[];\r\n    result: boolean;\r\n  }>;\r\n  performance: {\r\n    total_time_ms: number;\r\n    elements_analyzed: number;\r\n    cache_hits: number;\r\n  };\r\n  errors: string[];\r\n  warnings: string[];\r\n}\r\n\r\nexport class TBLEvaluationEngine {\r\n  private intelligence: TBLIntelligence;\r\n  private evaluationCache: Map<string, { result: unknown; timestamp: number }> = new Map();\r\n  private readonly CACHE_TTL = 5000; // 5 secondes\r\n\r\n  constructor() {\r\n    this.intelligence = new TBLIntelligence();\r\n  }\r\n\r\n  /**\r\n   * \uD83C\uDFAF \u00C9VALUATION PRINCIPALE\r\n   * Point d'entr\u00E9e unique pour toutes les \u00E9valuations TBL\r\n   */\r\n  async evaluate(request: TBLEvaluationRequest): Promise<TBLEvaluationResult> {\r\n    const startTime = Date.now();\r\n    console.log(`\uD83D\uDE80 [TBL Evaluation] D\u00E9but \u00E9valuation ${request.element_code}`);\r\n    console.log(`   Mode: ${request.evaluation_mode}, Deep: ${request.deep_resolution}`);\r\n\r\n    const result: TBLEvaluationResult = {\r\n      success: false,\r\n      element_code: request.element_code,\r\n      final_value: null,\r\n      evaluation_path: [],\r\n      dependencies_used: [],\r\n      options_triggered: [],\r\n      formulas_calculated: [],\r\n      conditions_evaluated: [],\r\n      performance: {\r\n        total_time_ms: 0,\r\n        elements_analyzed: 0,\r\n        cache_hits: 0\r\n      },\r\n      errors: [],\r\n      warnings: []\r\n    };\r\n\r\n    try {\r\n      // 1. V\u00E9rifier le cache\r\n      const cacheKey = this.getCacheKey(request);\r\n      const cached = this.getCachedResult(cacheKey);\r\n      if (cached) {\r\n        console.log(`\uD83D\uDCBE [TBL Evaluation] Cache HIT pour ${request.element_code}`);\r\n        result.performance.cache_hits = 1;\r\n        result.final_value = cached;\r\n        result.success = true;\r\n        return result;\r\n      }\r\n\r\n      // 2. Analyser l'\u00E9l\u00E9ment avec intelligence TBL\r\n      const analysis = await this.intelligence.analyzeElement(request.element_code);\r\n      result.performance.elements_analyzed++;\r\n      result.evaluation_path.push(request.element_code);\r\n\r\n      // 3. R\u00E9soudre selon le type d'\u00E9valuation\r\n      switch (request.evaluation_mode) {\r\n        case 'formula':\r\n          await this.evaluateFormulas(analysis, request, result);\r\n          break;\r\n        case 'condition':\r\n          await this.evaluateConditions(analysis, request, result);\r\n          break;\r\n        case 'table':\r\n          await this.evaluateTables(analysis, request, result);\r\n          break;\r\n        case 'auto':\r\n        default:\r\n          await this.evaluateAuto(analysis, request, result);\r\n          break;\r\n      }\r\n\r\n      // 4. R\u00E9solution en cascade si demand\u00E9e\r\n      if (request.deep_resolution) {\r\n        await this.resolveDeepDependencies(analysis, request, result);\r\n      }\r\n\r\n      // 5. Mise en cache du r\u00E9sultat\r\n      this.setCachedResult(cacheKey, result.final_value);\r\n\r\n      result.success = true;\r\n      console.log(`\u2705 [TBL Evaluation] \u00C9valuation r\u00E9ussie: ${request.element_code} = ${result.final_value}`);\r\n\r\n    } catch (error) {\r\n      console.error(`\u274C [TBL Evaluation] Erreur:`, error);\r\n      result.errors.push(error instanceof Error ? error.message : 'Erreur inconnue');\r\n    }\r\n\r\n    result.performance.total_time_ms = Date.now() - startTime;\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE \u00C9VALUATION DES FORMULES\r\n   */\r\n  private async evaluateFormulas(\r\n    analysis: any,\r\n    request: TBLEvaluationRequest,\r\n    result: TBLEvaluationResult\r\n  ): Promise<void> {\r\n    console.log(`\uD83E\uDDEE [TBL Evaluation] \u00C9valuation de ${analysis.formulas.length} formules`);\r\n\r\n    for (const formula of analysis.formulas) {\r\n      try {\r\n        // R\u00E9cup\u00E9rer les valeurs des champs r\u00E9f\u00E9renc\u00E9s par leurs codes TBL\r\n        const fieldValues: Record<string, number> = {};\r\n        \r\n        for (const fieldCode of formula.referenced_fields) {\r\n          if (fieldCode in request.context_values) {\r\n            const value = request.context_values[fieldCode];\r\n            fieldValues[fieldCode] = typeof value === 'number' ? value : parseFloat(String(value)) || 0;\r\n            result.dependencies_used.push(fieldCode);\r\n          } else {\r\n            result.warnings.push(`Champ manquant pour formule: ${fieldCode}`);\r\n          }\r\n        }\r\n\r\n        // Calculer la formule (simulation)\r\n        const formulaResult = this.calculateFormula(formula.formula_content, fieldValues);\r\n        \r\n        result.formulas_calculated.push({\r\n          formula_id: formula.id,\r\n          referenced_codes: formula.referenced_fields,\r\n          result: formulaResult\r\n        });\r\n\r\n        // La derni\u00E8re formule donne la valeur finale\r\n        result.final_value = formulaResult;\r\n\r\n        console.log(`   \u2705 Formule ${formula.id}: ${formulaResult}`);\r\n\r\n      } catch (error) {\r\n        console.error(`   \u274C Erreur formule ${formula.id}:`, error);\r\n        result.errors.push(`Formule ${formula.id}: ${error instanceof Error ? error.message : 'Erreur'}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \u2696\uFE0F \u00C9VALUATION DES CONDITIONS\r\n   */\r\n  private async evaluateConditions(\r\n    analysis: any,\r\n    request: TBLEvaluationRequest,\r\n    result: TBLEvaluationResult\r\n  ): Promise<void> {\r\n    console.log(`\u2696\uFE0F [TBL Evaluation] \u00C9valuation de ${analysis.conditions.length} conditions`);\r\n\r\n    for (const condition of analysis.conditions) {\r\n      try {\r\n        // \u00C9valuer chaque \u00E9l\u00E9ment d\u00E9clencheur\r\n        let conditionResult = true;\r\n        const usedTriggers: string[] = [];\r\n\r\n        for (const triggerCode of condition.trigger_elements) {\r\n          if (triggerCode in request.context_values) {\r\n            const triggerValue = request.context_values[triggerCode];\r\n            // Simulation d'\u00E9valuation - adapter selon la logique r\u00E9elle\r\n            const triggerResult = Boolean(triggerValue);\r\n            conditionResult = conditionResult && triggerResult;\r\n            usedTriggers.push(triggerCode);\r\n            result.dependencies_used.push(triggerCode);\r\n          }\r\n        }\r\n\r\n        // \u00C9valuer les mappings options + champs\r\n        for (const mapping of condition.option_mappings) {\r\n          const optionValue = request.context_values[mapping.option_code];\r\n          const shouldShowField = Boolean(optionValue) && mapping.show_when_selected;\r\n\r\n          result.options_triggered.push({\r\n            option_code: mapping.option_code,\r\n            field_code: mapping.field_code,\r\n            show_field: shouldShowField\r\n          });\r\n\r\n          console.log(`   \uD83C\uDFAF Option ${mapping.option_code} \u2192 Champ ${mapping.field_code}: ${shouldShowField ? 'AFFICH\u00C9' : 'MASQU\u00C9'}`);\r\n        }\r\n\r\n        result.conditions_evaluated.push({\r\n          condition_id: condition.id,\r\n          trigger_codes: usedTriggers,\r\n          result: conditionResult\r\n        });\r\n\r\n        result.final_value = conditionResult;\r\n\r\n        console.log(`   \u2705 Condition ${condition.id}: ${conditionResult}`);\r\n\r\n      } catch (error) {\r\n        console.error(`   \u274C Erreur condition ${condition.id}:`, error);\r\n        result.errors.push(`Condition ${condition.id}: ${error instanceof Error ? error.message : 'Erreur'}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCCA \u00C9VALUATION DES TABLEAUX\r\n   */\r\n  private async evaluateTables(\r\n    analysis: any,\r\n    request: TBLEvaluationRequest,\r\n    result: TBLEvaluationResult\r\n  ): Promise<void> {\r\n    console.log(`\uD83D\uDCCA [TBL Evaluation] \u00C9valuation de ${analysis.tables.length} tableaux`);\r\n\r\n    for (const table of analysis.tables) {\r\n      try {\r\n        // R\u00E9cup\u00E9rer les donn\u00E9es sources par codes TBL\r\n        const tableData: Record<string, unknown>[] = [];\r\n        \r\n        for (const sourceCode of table.data_sources) {\r\n          if (sourceCode in request.context_values) {\r\n            const sourceValue = request.context_values[sourceCode];\r\n            // Simulation - adapter selon la structure r\u00E9elle\r\n            tableData.push({ [sourceCode]: sourceValue });\r\n            result.dependencies_used.push(sourceCode);\r\n          }\r\n        }\r\n\r\n        // Calculer les colonnes comput\u00E9es\r\n        for (const computedCode of table.computed_columns) {\r\n          // Ici on pourrait appeler r\u00E9cursivement l'\u00E9valuation pour les formules\r\n          console.log(`   \uD83E\uDDEE Colonne calcul\u00E9e: ${computedCode}`);\r\n        }\r\n\r\n        result.final_value = tableData;\r\n        console.log(`   \u2705 Tableau ${table.id}: ${tableData.length} lignes`);\r\n\r\n      } catch (error) {\r\n        console.error(`   \u274C Erreur tableau ${table.id}:`, error);\r\n        result.errors.push(`Tableau ${table.id}: ${error instanceof Error ? error.message : 'Erreur'}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDD16 \u00C9VALUATION AUTOMATIQUE\r\n   * D\u00E9tecte automatiquement le type d'\u00E9valuation selon la capacit\u00E9 TBL\r\n   */\r\n  private async evaluateAuto(\r\n    analysis: any,\r\n    request: TBLEvaluationRequest,\r\n    result: TBLEvaluationResult\r\n  ): Promise<void> {\r\n    const capacity = analysis.element.tbl_capacity;\r\n    \r\n    console.log(`\uD83E\uDD16 [TBL Evaluation] Mode auto - capacit\u00E9 d\u00E9tect\u00E9e: ${capacity}`);\r\n\r\n    switch (capacity) {\r\n      case 2: // Formule\r\n        await this.evaluateFormulas(analysis, request, result);\r\n        break;\r\n      case 3: // Condition\r\n        await this.evaluateConditions(analysis, request, result);\r\n        break;\r\n      case 4: // Tableau\r\n        await this.evaluateTables(analysis, request, result);\r\n        break;\r\n      default: // Valeur simple\r\n        result.final_value = request.context_values[request.element_code] || null;\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDD04 R\u00C9SOLUTION R\u00C9CURSIVE DES D\u00C9PENDANCES\r\n   */\r\n  private async resolveDeepDependencies(\r\n    analysis: any,\r\n    request: TBLEvaluationRequest,\r\n    result: TBLEvaluationResult\r\n  ): Promise<void> {\r\n    console.log(`\uD83D\uDD04 [TBL Evaluation] R\u00E9solution profonde des d\u00E9pendances`);\r\n\r\n    for (const dependency of analysis.dependencies) {\r\n      if (!result.evaluation_path.includes(dependency.source_code)) {\r\n        // \u00C9valuation r\u00E9cursive\r\n        const subRequest: TBLEvaluationRequest = {\r\n          ...request,\r\n          element_code: dependency.source_code,\r\n          deep_resolution: false // \u00C9viter la r\u00E9cursion infinie\r\n        };\r\n\r\n        const subResult = await this.evaluate(subRequest);\r\n        if (subResult.success) {\r\n          result.evaluation_path.push(...subResult.evaluation_path);\r\n          result.dependencies_used.push(...subResult.dependencies_used);\r\n          result.performance.elements_analyzed += subResult.performance.elements_analyzed;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83E\uDDEE CALCUL R\u00C9EL DE FORMULE\r\n   */\r\n  private calculateFormula(formulaContent: string, fieldValues: Record<string, number>): number {\r\n    try {\r\n      // Simulation simple - remplacer par le vrai moteur de formules\r\n      const sequence = JSON.parse(formulaContent);\r\n      \r\n      // Logique de calcul basique pour d\u00E9monstration\r\n      let result = 0;\r\n      for (const token of sequence) {\r\n        if (token.type === 'number') {\r\n          result += parseFloat(token.value) || 0;\r\n        } else if (token.type === 'variable' && token.reference_code) {\r\n          result += fieldValues[token.reference_code] || 0;\r\n        }\r\n      }\r\n      \r\n      return result;\r\n    } catch {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \uD83D\uDCBE GESTION DU CACHE\r\n   */\r\n  private getCacheKey(request: TBLEvaluationRequest): string {\r\n    const contextHash = JSON.stringify(request.context_values);\r\n    return `${request.element_code}:${request.evaluation_mode}:${contextHash}`;\r\n  }\r\n\r\n  private getCachedResult(key: string): unknown | null {\r\n    const cached = this.evaluationCache.get(key);\r\n    if (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {\r\n      return cached.result;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private setCachedResult(key: string, result: unknown): void {\r\n    this.evaluationCache.set(key, {\r\n      result,\r\n      timestamp: Date.now()\r\n    });\r\n  }\r\n}\r\n\r\nexport default TBLEvaluationEngine;", "import express from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authenticateToken } from '../middleware/auth';\r\n\r\n// NOTE: requireRole peut \u00EAtre import\u00E9 si restriction fine n\u00E9cessaire\r\n// import { requireRole } from '../middleware/auth';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = express.Router();\r\n\r\n/**\r\n * Shape de la capability retourn\u00E9e au frontend.\r\n * On garde une forme volontairement plate et explicite pour un usage direct c\u00F4t\u00E9 hook.\r\n */\r\ninterface TBLCapabilityBase {\r\n  nodeId: string;\r\n  variableId?: string; // id TreeBranchLeafNodeVariable\r\n  sourceRef?: string | null;\r\n  sourceType?: string | null;\r\n  exposedKey?: string | null;\r\n  displayName?: string | null;\r\n  capacity: 'data' | 'formula' | 'condition' | 'table' | 'fixed' | 'unknown';\r\n  hasFormula?: boolean;\r\n  hasCondition?: boolean;\r\n  hasTable?: boolean;\r\n  fixedValue?: string | null;\r\n  // d\u00E9pendances (extraites des tokens / conditionSet si possible)\r\n  dependencies?: string[];\r\n  // payload brut utile pour debug localStorage.TBL_DIAG\r\n  raw?: Record<string, unknown>;\r\n}\r\n\r\ninterface CapabilityResolverOptions {\r\n  includeRaw?: boolean;\r\n  extractDependencies?: boolean;\r\n}\r\n\r\n/**\r\n * Extraction rapide des r\u00E9f\u00E9rences depuis un tableau de tokens de formule.\r\n * Hypoth\u00E8se: token = { type, value } et les refs de variables ont type 'ref' ou pattern '@value.<uuid>'\r\n */\r\ninterface FormulaTokenRef { type: string; value?: string }\r\ntype FormulaToken = FormulaTokenRef | string | null | undefined;\r\nfunction extractFormulaDependencies(tokens: FormulaToken[]): string[] {\r\n  const deps: string[] = [];\r\n  for (const t of tokens || []) {\r\n    if (!t) continue;\r\n    if (typeof t === 'object' && 'type' in t && t.type === 'ref' && typeof t.value === 'string') {\r\n      deps.push(t.value);\r\n    } else if (typeof t === 'string') {\r\n      const m = t.match(/@value\\.[0-9a-fA-F-]{36}/g);\r\n      if (m) m.forEach(ref => deps.push(ref.replace('@value.', '')));\r\n    }\r\n  }\r\n  return Array.from(new Set(deps));\r\n}\r\n\r\n/**\r\n * Extraction d\u00E9pendances depuis un conditionSet (branches[].when.left/right.ref etc.)\r\n */\r\ntype JSONValue = string | number | boolean | null | JSONValue[] | { [k: string]: JSONValue };\r\n// ConditionSet structure libre\r\nfunction extractConditionDependencies(conditionSet: JSONValue): string[] {\r\n  if (!conditionSet || typeof conditionSet !== 'object') return [];\r\n  const deps = new Set<string>();\r\n  const scan = (obj: JSONValue): void => {\r\n    if (!obj || typeof obj !== 'object') return;\r\n    if (Array.isArray(obj)) {\r\n      obj.forEach(scan);\r\n      return;\r\n    }\r\n    // obj est un record\r\n    const rec = obj as { [k: string]: JSONValue } & { ref?: JSONValue };\r\n    if (typeof rec.ref === 'string') {\r\n      const cleaned = rec.ref.startsWith('@value.') ? rec.ref.substring(7) : rec.ref;\r\n      deps.add(cleaned);\r\n    }\r\n    for (const k of Object.keys(rec)) scan(rec[k]);\r\n  };\r\n  scan(conditionSet);\r\n  return Array.from(deps);\r\n}\r\n\r\n/**\r\n * R\u00E9sout les capabilities pour un tree donn\u00E9.\r\n * Strat\u00E9gie: charger variables + formules + conditions + tables en batch, puis fusionner par nodeId.\r\n */\r\nasync function resolveCapabilities(treeId: string, opts: CapabilityResolverOptions = {}): Promise<TBLCapabilityBase[]> {\r\n  // 1. R\u00E9cup\u00E9ration en parall\u00E8le\r\n  const [variables, formulas, conditions, tables] = await Promise.all([\r\n    prisma.treeBranchLeafNodeVariable.findMany({\r\n      where: { TreeBranchLeafNode: { treeId } },\r\n      select: {\r\n        id: true,\r\n        nodeId: true,\r\n        sourceRef: true,\r\n        sourceType: true,\r\n        exposedKey: true,\r\n        displayName: true,\r\n        fixedValue: true,\r\n        selectedNodeId: true\r\n      }\r\n    }),\r\n    prisma.treeBranchLeafNodeFormula.findMany({\r\n      where: { TreeBranchLeafNode: { treeId } },\r\n      select: { id: true, nodeId: true, tokens: true, name: true }\r\n    }),\r\n    prisma.treeBranchLeafNodeCondition.findMany({\r\n      where: { TreeBranchLeafNode: { treeId } },\r\n      select: { id: true, nodeId: true, conditionSet: true, name: true }\r\n    }),\r\n    prisma.treeBranchLeafNodeTable.findMany({\r\n      where: { TreeBranchLeafNode: { treeId } },\r\n      select: { id: true, nodeId: true, type: true, name: true, meta: true }\r\n    })\r\n  ]);\r\n\r\n  // Indexation par nodeId\r\n  const formulaByNode = new Map<string, typeof formulas[0]>();\r\n  formulas.forEach(f => formulaByNode.set(f.nodeId, f));\r\n  const conditionByNode = new Map<string, typeof conditions[0]>();\r\n  conditions.forEach(c => conditionByNode.set(c.nodeId, c));\r\n  const tableByNode = new Map<string, typeof tables[0]>();\r\n  tables.forEach(t => tableByNode.set(t.nodeId, t));\r\n\r\n  const capabilities: TBLCapabilityBase[] = [];\r\n\r\n  for (const v of variables) {\r\n    let capacity: TBLCapabilityBase['capacity'] = 'unknown';\r\n    let deps: string[] = [];\r\n\r\n    // D\u00E9tection par sourceRef si pr\u00E9sent\r\n    if (v.sourceRef) {\r\n      if (v.sourceRef.startsWith('formula:') || v.sourceRef.startsWith('node-formula:')) capacity = 'formula';\r\n      else if (v.sourceRef.startsWith('condition:')) capacity = 'condition';\r\n      else if (v.sourceRef.startsWith('table:')) capacity = 'table';\r\n      else if (v.sourceType === 'fixed' || v.fixedValue) capacity = 'fixed';\r\n      else capacity = 'data';\r\n    } else if (v.fixedValue) {\r\n      capacity = 'fixed';\r\n    } else {\r\n      // fallback: regarder existence de ressources associ\u00E9es au node\r\n      if (formulaByNode.has(v.nodeId)) capacity = 'formula';\r\n      else if (conditionByNode.has(v.nodeId)) capacity = 'condition';\r\n      else if (tableByNode.has(v.nodeId)) capacity = 'table';\r\n      else capacity = 'data';\r\n    }\r\n\r\n    const formula = formulaByNode.get(v.nodeId);\r\n    const condition = conditionByNode.get(v.nodeId);\r\n    const table = tableByNode.get(v.nodeId);\r\n\r\n    if (opts.extractDependencies) {\r\n  if (formula?.tokens) deps = extractFormulaDependencies(formula.tokens as unknown as FormulaToken[]);\r\n  else if (condition?.conditionSet) deps = extractConditionDependencies(condition.conditionSet as unknown as JSONValue);\r\n      // Table dependencies: \u00E0 d\u00E9finir plus tard (ex: r\u00E9f\u00E9rences colonnes)\r\n    }\r\n\r\n    const cap: TBLCapabilityBase = {\r\n      nodeId: v.nodeId,\r\n      variableId: v.id,\r\n      sourceRef: v.sourceRef,\r\n      sourceType: v.sourceType,\r\n      exposedKey: v.exposedKey,\r\n      displayName: v.displayName,\r\n      fixedValue: v.fixedValue,\r\n      capacity,\r\n      hasFormula: !!formula,\r\n      hasCondition: !!condition,\r\n      hasTable: !!table,\r\n      dependencies: deps.length ? deps : undefined,\r\n      raw: opts.includeRaw ? { variable: v, formula, condition, table } : undefined\r\n    };\r\n\r\n    capabilities.push(cap);\r\n  }\r\n\r\n  return capabilities;\r\n}\r\n\r\n/**\r\n * GET /api/tbl/capabilities?treeId=xxx&raw=1&deps=1\r\n * Retourne la liste des capabilities pour toutes les variables d'un tree.\r\n */\r\nrouter.get('/capabilities', authenticateToken, async (req, res) => {\r\n  try {\r\n    const treeId = String(req.query.treeId || '');\r\n    if (!treeId) {\r\n      return res.status(400).json({ error: 'treeId requis' });\r\n    }\r\n\r\n    const includeRaw = req.query.raw === '1' || req.query.raw === 'true';\r\n    const extractDeps = req.query.deps === '1' || req.query.deps === 'true';\r\n\r\n    // TODO: V\u00E9rifier ownership/organization du treeId avant de retourner les donn\u00E9es\r\n    const data = await resolveCapabilities(treeId, { includeRaw, extractDependencies: extractDeps });\r\n\r\n    res.json({\r\n      treeId,\r\n      count: data.length,\r\n      capabilities: data,\r\n      meta: {\r\n        extractedAt: new Date().toISOString(),\r\n        raw: includeRaw,\r\n        deps: extractDeps,\r\n        version: 'v1'\r\n      }\r\n    });\r\n  } catch (error) {\r\n    const err = error as Error;\r\n    console.error('\u274C [TBL Capabilities] Erreur:', err);\r\n    res.status(500).json({ error: 'Erreur serveur capabilities', details: err.message });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83C\uDFAF DEVIS1MINUTE - Routes Lead Generation\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient, type Prisma } from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 RATE LIMITING\r\nconst leadGenRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 50, // 50 requ\u00EAtes par minute\r\n  message: { success: false, message: 'Trop de requ\u00EAtes lead generation' }\r\n});\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(leadGenRateLimit);\r\n\r\nconst getQueryString = (value: unknown): string | undefined => {\r\n  if (typeof value === 'string') return value;\r\n  if (Array.isArray(value)) {\r\n    const firstString = value.find((item): item is string => typeof item === 'string');\r\n    if (firstString) return firstString;\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst buildOriginFilter = (origin: string | undefined): Prisma.LeadWhereInput | undefined => {\r\n  if (origin !== 'd1m') return undefined;\r\n\r\n  return {\r\n    OR: [\r\n      { NOT: { sourceId: null } },\r\n      { source: { in: ['public-form', 'd1m', 'devis1minute', 'landing'] } }\r\n    ]\r\n  };\r\n};\r\n\r\n// \uD83D\uDCCA GET /api/lead-generation/campaigns - Liste des campagnes\r\n// Ici, nous mappions le concept de \"campagne\" sur LeadSource (mod\u00E8le existant)\r\nrouter.get('/campaigns', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    }\r\n\r\n    const sources = await prisma.leadSource.findMany({\r\n      where: { organizationId },\r\n      include: {\r\n        _count: { select: { Lead: true } }\r\n      },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    // Adapter aux besoins du front (structure Campaign)\r\n    const campaigns = await Promise.all(\r\n      sources.map(async (s) => {\r\n        const completedLeads = await prisma.lead.count({\r\n          where: { organizationId, sourceId: s.id, status: 'completed' }\r\n        });\r\n        const leadsGenerated = s._count?.Lead ?? 0;\r\n        const conversionRate = leadsGenerated > 0 ? Math.round((completedLeads / leadsGenerated) * 100) : 0;\r\n        return {\r\n          id: s.id,\r\n          name: s.name,\r\n          description: s.description ?? '',\r\n          category: 'source',\r\n          targetPostalCodes: [],\r\n          budget: 0,\r\n          spentBudget: 0,\r\n          costPerLead: 0,\r\n          status: s.isActive ? 'active' : 'paused',\r\n          utmSource: '',\r\n          utmMedium: '',\r\n          utmCampaign: '',\r\n          leadsGenerated,\r\n          leadsPublished: 0,\r\n          conversionRate,\r\n          qualityScore: 0,\r\n          createdAt: s.createdAt instanceof Date ? s.createdAt.toISOString() : new Date().toISOString(),\r\n          startDate: undefined,\r\n          endDate: undefined,\r\n          isAutomatic: false,\r\n          targetAudience: [],\r\n          landingPageUrl: undefined\r\n        };\r\n      })\r\n    );\r\n\r\n    res.json({ success: true, data: campaigns });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur r\u00E9cup\u00E9ration campagnes (LeadSource):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des campagnes' });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFAF POST /api/lead-generation/campaigns - Cr\u00E9er une campagne\r\nrouter.post('/campaigns', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const { name, description, isActive = true } = req.body;\r\n    if (!name) return res.status(400).json({ success: false, message: 'Nom de campagne requis' });\r\n\r\n    const created = await prisma.leadSource.create({\r\n      data: { organizationId, name, description, isActive: Boolean(isActive) }\r\n    });\r\n\r\n    res.json({ success: true, data: created, message: 'Campagne cr\u00E9\u00E9e avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur cr\u00E9ation campagne (LeadSource):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la cr\u00E9ation de la campagne' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC8 GET /api/lead-generation/stats - Statistiques globales\r\nrouter.get('/stats', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const monthStart = new Date();\r\n    monthStart.setDate(1);\r\n    monthStart.setHours(0, 0, 0, 0);\r\n\r\n    // Par d\u00E9faut, les stats D1M ne comptent que les leads d'origine D1M\r\n    const originParam = getQueryString(req.query.origin) ?? 'd1m';\r\n    const originWhere = buildOriginFilter(originParam);\r\n\r\n    const [totalCampaigns, activeCampaigns, totalLeads, thisMonthLeads] = await Promise.all([\r\n      prisma.leadSource.count({ where: { organizationId } }),\r\n      prisma.leadSource.count({ where: { organizationId, isActive: true } }),\r\n  prisma.lead.count({ where: { organizationId, ...(originWhere ?? {}) } }),\r\n  prisma.lead.count({ where: { organizationId, createdAt: { gte: monthStart }, ...(originWhere ?? {}) } })\r\n    ]);\r\n\r\n    res.json({ success: true, data: { totalCampaigns, activeCampaigns, totalLeads, thisMonthLeads } });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur stats (LeadSource/Lead):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques' });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFAF PUT /api/lead-generation/campaigns/:id - Modifier campagne\r\nrouter.put('/campaigns/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    // S'assurer que la source appartient \u00E0 l'org\r\n    const existing = await prisma.leadSource.findFirst({ where: { id, organizationId } });\r\n    if (!existing) return res.status(404).json({ success: false, message: 'Campagne non trouv\u00E9e' });\r\n\r\n    const { name, description, isActive } = req.body;\r\n    const updated = await prisma.leadSource.update({ where: { id }, data: { name, description, isActive } });\r\n    res.json({ success: true, data: updated, message: 'Campagne modifi\u00E9e avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur modification campagne (LeadSource):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la modification de la campagne' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDDD1\uFE0F DELETE /api/lead-generation/campaigns/:id - Supprimer campagne\r\nrouter.delete('/campaigns/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const deleted = await prisma.leadSource.deleteMany({ where: { id, organizationId } });\r\n    if (deleted.count === 0) return res.status(404).json({ success: false, message: 'Campagne non trouv\u00E9e' });\r\n    res.json({ success: true, message: 'Campagne supprim\u00E9e avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur suppression campagne (LeadSource):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la suppression de la campagne' });\r\n  }\r\n});\r\n\r\n// PATCH /api/lead-generation/campaigns/:id/status - changer statut (active/paused)\r\nrouter.patch('/campaigns/:id/status', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { status } = req.body as { status?: 'active' | 'paused' };\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    if (!status) return res.status(400).json({ success: false, message: 'Statut requis' });\r\n\r\n    const target = await prisma.leadSource.findFirst({ where: { id, organizationId } });\r\n    if (!target) return res.status(404).json({ success: false, message: 'Campagne non trouv\u00E9e' });\r\n\r\n    const updated = await prisma.leadSource.update({ where: { id }, data: { isActive: status === 'active' } });\r\n    res.json({ success: true, data: updated, message: 'Statut mis \u00E0 jour' });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur MAJ statut (LeadSource):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la mise \u00E0 jour du statut' });\r\n  }\r\n});\r\n\r\n// POST /api/lead-generation/campaigns/:id/duplicate - dupliquer une \"campagne\" (LeadSource)\r\nrouter.post('/campaigns/:id/duplicate', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const source = await prisma.leadSource.findFirst({ where: { id, organizationId } });\r\n    if (!source) return res.status(404).json({ success: false, message: 'Campagne non trouv\u00E9e' });\r\n\r\n    const copy = await prisma.leadSource.create({\r\n      data: {\r\n        organizationId,\r\n        name: `${source.name} (Copie)`,\r\n        description: source.description,\r\n        color: source.color,\r\n        icon: source.icon,\r\n        isActive: false\r\n      }\r\n    });\r\n    res.json({ success: true, data: copy, message: 'Campagne dupliqu\u00E9e avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur duplication campagne (LeadSource):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la duplication de la campagne' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC8 GET /api/lead-generation/stats/timeseries?days=30\r\nrouter.get('/stats/timeseries', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n  const organizationId = req.user?.organizationId;\r\n  if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n  const daysParam = getQueryString(req.query.days);\r\n  const requestedDays = Number.parseInt(daysParam ?? '30', 10);\r\n  const days = Math.min(365, Math.max(1, Number.isNaN(requestedDays) ? 30 : requestedDays));\r\n    const start = new Date();\r\n    start.setDate(start.getDate() - (days - 1));\r\n    start.setHours(0, 0, 0, 0);\r\n\r\n    // Par d\u00E9faut, s\u00E9ries D1M uniquement (m\u00EAmes crit\u00E8res que /stats)\r\n    const originParam = getQueryString(req.query.origin) ?? 'd1m';\r\n    const originWhere = buildOriginFilter(originParam);\r\n\r\n    const leads = await prisma.lead.findMany({\r\n      where: { organizationId, createdAt: { gte: start }, ...(originWhere ?? {}) },\r\n      select: { createdAt: true, status: true }\r\n    });\r\n\r\n    const byDay = new Map<string, { created: number; completed: number }>();\r\n    for (let i = 0; i < days; i++) {\r\n      const d = new Date(start.getTime());\r\n      d.setDate(start.getDate() + i);\r\n      const key = d.toISOString().slice(0, 10);\r\n      byDay.set(key, { created: 0, completed: 0 });\r\n    }\r\n    for (const lead of leads) {\r\n      const key = lead.createdAt instanceof Date ? lead.createdAt.toISOString().slice(0, 10) : new Date(lead.createdAt).toISOString().slice(0, 10);\r\n      const rec = byDay.get(key);\r\n      if (rec) {\r\n        rec.created++;\r\n        if (lead.status === 'completed') rec.completed++;\r\n      }\r\n    }\r\n    const series = Array.from(byDay.entries()).map(([date, v]) => ({ date, created: v.created, completed: v.completed }));\r\n    res.json({ success: true, data: { start: start.toISOString(), days, series } });\r\n  } catch (error) {\r\n    console.error('\u274C [LEAD-GEN] Erreur timeseries:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des s\u00E9ries temporelles' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83C\uDFAF DEVIS1MINUTE - Routes Marketplace (VERSION CORRIG\u00C9E)\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 RATE LIMITING\r\nconst marketplaceRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 100, // 100 requ\u00EAtes par minute\r\n  message: { success: false, message: 'Trop de requ\u00EAtes marketplace' }\r\n});\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(marketplaceRateLimit);\r\n\r\n// \uD83D\uDCCA GET /api/marketplace/leads - Leads marketplace disponibles\r\nrouter.get('/leads', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const { \r\n      status = 'AVAILABLE',\r\n      minPrice,\r\n      maxPrice,\r\n      targetSectors,\r\n      targetRegions,\r\n      limit = 50,\r\n      offset = 0,\r\n      availableOnly\r\n    } = req.query;\r\n\r\n    // Construction du filtre WHERE selon le sch\u00E9ma r\u00E9el\r\n    const where: Record<string, unknown> = {};\r\n\r\n    // Filtre par statut (correspond au sch\u00E9ma)\r\n    if (availableOnly === 'true' || status) {\r\n      where.status = status as string;\r\n    }\r\n\r\n    // Filtres de prix\r\n    if (minPrice) {\r\n      where.price = { ...where.price, gte: parseFloat(minPrice as string) };\r\n    }\r\n    if (maxPrice) {\r\n      where.price = { ...where.price, lte: parseFloat(maxPrice as string) };\r\n    }\r\n\r\n    // Filtres g\u00E9ographiques/secteurs (arrays dans le sch\u00E9ma)\r\n    if (targetSectors) {\r\n      where.targetSectors = { hasSome: [targetSectors as string] };\r\n    }\r\n    if (targetRegions) {\r\n      where.targetRegions = { hasSome: [targetRegions as string] };\r\n    }\r\n\r\n    console.log('\uD83D\uDD0D [MARKETPLACE] Requ\u00EAte leads avec filtres:', where);\r\n\r\n    const leads = await prisma.leadMarketplace.findMany({\r\n      where,\r\n      include: {\r\n        Lead: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            email: true,\r\n            phone: true,\r\n            company: true,\r\n            aiScore: true,\r\n            createdAt: true,\r\n            organizationId: true,\r\n            data: true\r\n          }\r\n        },\r\n        LeadPurchase: {\r\n          select: {\r\n            id: true,\r\n            price: true,\r\n            purchasedAt: true,\r\n            partnerOrganizationId: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        publishedAt: 'desc'\r\n      },\r\n      take: parseInt(limit as string),\r\n      skip: parseInt(offset as string)\r\n    });\r\n\r\n    // Total pour pagination\r\n    const total = await prisma.leadMarketplace.count({ where });\r\n\r\n    // Transformer pour compatibilit\u00E9 frontend\r\n    const transformedLeads = leads.map(marketplace => ({\r\n      id: marketplace.id,\r\n      leadId: marketplace.leadId,\r\n      price: marketplace.price,\r\n      exclusivePrice: marketplace.exclusivePrice,\r\n      maxPartners: marketplace.maxPartners,\r\n      currentPartners: marketplace.currentPartners,\r\n      status: marketplace.status,\r\n      targetSectors: marketplace.targetSectors,\r\n      targetRegions: marketplace.targetRegions,\r\n      minRating: marketplace.minRating,\r\n      publishedAt: marketplace.publishedAt?.toISOString(),\r\n      expiresAt: marketplace.expiresAt?.toISOString(),\r\n      aiScore: marketplace.aiScore || 0,\r\n      urgencyScore: marketplace.urgencyScore,\r\n      qualityScore: marketplace.qualityScore,\r\n      aiAnalysis: marketplace.aiAnalysis,\r\n      createdAt: marketplace.createdAt.toISOString(),\r\n      updatedAt: marketplace.updatedAt.toISOString(),\r\n      lead: {\r\n        id: marketplace.Lead.id,\r\n        firstName: marketplace.Lead.firstName || '',\r\n        lastName: marketplace.Lead.lastName || '',\r\n        email: marketplace.Lead.email || '',\r\n        phone: marketplace.Lead.phone || '',\r\n        company: marketplace.Lead.company || ''\r\n      },\r\n      purchases: marketplace.LeadPurchase || []\r\n    }));\r\n\r\n    console.log(`\u2705 [MARKETPLACE] ${transformedLeads.length} leads trouv\u00E9s`);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        leads: transformedLeads,\r\n        pagination: {\r\n          total,\r\n          limit: parseInt(limit as string),\r\n          offset: parseInt(offset as string),\r\n          hasMore: parseInt(offset as string) + parseInt(limit as string) < total\r\n        }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [MARKETPLACE] Erreur r\u00E9cup\u00E9ration leads:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des leads marketplace',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCCA GET /api/marketplace/stats - Statistiques marketplace\r\nrouter.get('/stats', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    // Statistiques parall\u00E8les avec le sch\u00E9ma r\u00E9el\r\n    const [\r\n      availableLeads,\r\n      soldLeads,\r\n      totalPurchases,\r\n      myPublishedLeads\r\n    ] = await Promise.all([\r\n      prisma.leadMarketplace.count({\r\n        where: { status: 'AVAILABLE' }\r\n      }),\r\n      prisma.leadMarketplace.count({\r\n        where: { status: 'PURCHASED' }\r\n      }),\r\n      prisma.leadPurchase.count().catch(() => 0), // En cas d'erreur\r\n      prisma.leadMarketplace.count({\r\n        where: {\r\n          Lead: {\r\n            organizationId: organizationId\r\n          }\r\n        }\r\n      })\r\n    ]);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        totalLeads: availableLeads + soldLeads,\r\n        availableLeads,\r\n        avgPrice: 0, // TODO: calculer la moyenne des prix\r\n        newToday: 0, // TODO: compter les leads d'aujourd'hui\r\n        marketplace: {\r\n          availableLeads,\r\n          soldLeads\r\n        },\r\n        organization: {\r\n          totalPurchases,\r\n          myPublishedLeads,\r\n          currentCredits: 0 // TODO: syst\u00E8me de cr\u00E9dits si n\u00E9cessaire\r\n        }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [MARKETPLACE] Erreur stats:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDD0D GET /api/marketplace/saved-searches - Recherches sauvegard\u00E9es\r\nrouter.get('/saved-searches', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    // Pour l'instant, retourner un tableau vide (fonctionnalit\u00E9 \u00E0 impl\u00E9menter)\r\n    res.json({\r\n      success: true,\r\n      data: []\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [MARKETPLACE] Erreur recherches sauvegard\u00E9es:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des recherches sauvegard\u00E9es',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCB0 POST /api/marketplace/purchase/:leadId - Acheter un lead (version simplifi\u00E9e pour test)\r\nrouter.post('/purchase/:leadId', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { leadId } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    const userId = req.user?.userId || req.user?.id;\r\n    \r\n    if (!organizationId || !userId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID ou User ID manquant' \r\n      });\r\n    }\r\n\r\n    // V\u00E9rifier que le lead marketplace existe\r\n    const leadMarketplace = await prisma.leadMarketplace.findUnique({\r\n      where: { leadId },\r\n      include: { Lead: true }\r\n    });\r\n\r\n    if (!leadMarketplace || leadMarketplace.status !== 'AVAILABLE') {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Lead non disponible'\r\n      });\r\n    }\r\n\r\n    // Pour l'instant, on simule l'achat (\u00E0 impl\u00E9menter compl\u00E8tement plus tard)\r\n    res.json({\r\n      success: true,\r\n      message: 'Fonctionnalit\u00E9 d\\'achat en cours d\\'impl\u00E9mentation',\r\n      data: {\r\n        leadId,\r\n        price: leadMarketplace.price,\r\n        status: 'simulation'\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [MARKETPLACE] Erreur achat lead:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: error instanceof Error ? error.message : 'Erreur lors de l\\'achat du lead',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83C\uDFAF DEVIS1MINUTE - Routes Partner Portal\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 RATE LIMITING\r\nconst partnerRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 30, // 30 requ\u00EAtes par minute\r\n  message: { success: false, message: 'Trop de requ\u00EAtes partner portal' }\r\n});\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(partnerRateLimit);\r\n\r\n// \uD83E\uDD1D GET /api/partner/dashboard - Dashboard partenaire\r\nrouter.get('/dashboard', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    // V\u00E9rifier si l'organisation est partenaire\r\n    const partnerOrg = await prisma.partnerOrganization.findUnique({\r\n      where: { organizationId },\r\n      include: {\r\n        organization: {\r\n          select: {\r\n            name: true,\r\n            credits: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!partnerOrg) {\r\n      return res.status(403).json({ \r\n        success: false, \r\n        message: 'Acc\u00E8s partenaire non autoris\u00E9' \r\n      });\r\n    }\r\n\r\n    // Statistiques du mois courant\r\n    const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);\r\n    \r\n    const [\r\n      totalLeadsGenerated,\r\n      monthlyLeadsGenerated,\r\n      totalRevenue,\r\n      monthlyRevenue,\r\n      activeCampaigns\r\n    ] = await Promise.all([\r\n      prisma.lead.count({\r\n        where: { organizationId }\r\n      }),\r\n      prisma.lead.count({\r\n        where: { \r\n          organizationId,\r\n          createdAt: { gte: startOfMonth }\r\n        }\r\n      }),\r\n      prisma.creditTransaction.aggregate({\r\n        where: { \r\n          organizationId,\r\n          type: 'SALE'\r\n        },\r\n        _sum: { amount: true }\r\n      }),\r\n      prisma.creditTransaction.aggregate({\r\n        where: { \r\n          organizationId,\r\n          type: 'SALE',\r\n          createdAt: { gte: startOfMonth }\r\n        },\r\n        _sum: { amount: true }\r\n      }),\r\n      prisma.campaign.count({\r\n        where: { \r\n          organizationId,\r\n          status: 'ACTIVE'\r\n        }\r\n      })\r\n    ]);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        partner: partnerOrg,\r\n        stats: {\r\n          totalLeadsGenerated,\r\n          monthlyLeadsGenerated,\r\n          totalRevenue: totalRevenue._sum.amount || 0,\r\n          monthlyRevenue: monthlyRevenue._sum.amount || 0,\r\n          activeCampaigns,\r\n          currentCredits: partnerOrg.organization.credits || 0\r\n        }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [PARTNER] Erreur dashboard:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration du dashboard partenaire' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCB0 GET /api/partner/earnings - Revenus partenaire\r\nrouter.get('/earnings', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const { period = '30', offset = 0, limit = 50 } = req.query;\r\n    \r\n    // Calcul de la p\u00E9riode\r\n    const startDate = new Date();\r\n    startDate.setDate(startDate.getDate() - parseInt(period as string));\r\n\r\n    const earnings = await prisma.creditTransaction.findMany({\r\n      where: {\r\n        organizationId,\r\n        type: 'SALE',\r\n        createdAt: { gte: startDate }\r\n      },\r\n      include: {\r\n        relatedLead: {\r\n          select: {\r\n            firstName: true,\r\n            lastName: true,\r\n            company: true,\r\n            marketplacePrice: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc'\r\n      },\r\n      take: parseInt(limit as string),\r\n      skip: parseInt(offset as string)\r\n    });\r\n\r\n    const totalEarnings = await prisma.creditTransaction.aggregate({\r\n      where: {\r\n        organizationId,\r\n        type: 'SALE',\r\n        createdAt: { gte: startDate }\r\n      },\r\n      _sum: { amount: true },\r\n      _count: true\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        earnings,\r\n        summary: {\r\n          totalAmount: totalEarnings._sum.amount || 0,\r\n          totalTransactions: totalEarnings._count,\r\n          period: parseInt(period as string)\r\n        }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [PARTNER] Erreur earnings:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des revenus' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFAF GET /api/partner/leads - Leads g\u00E9n\u00E9r\u00E9s par le partenaire\r\nrouter.get('/leads', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const { \r\n      status,\r\n      marketplaceOnly = false,\r\n      offset = 0,\r\n      limit = 50\r\n    } = req.query;\r\n\r\n    const where: { [key: string]: unknown } = { organizationId };\r\n    \r\n    if (status) {\r\n      where.status = status;\r\n    }\r\n    \r\n    if (marketplaceOnly === 'true') {\r\n      where.LeadMarketplace = {\r\n        isNot: null\r\n      };\r\n    }\r\n\r\n    const leads = await prisma.lead.findMany({\r\n      where,\r\n      include: {\r\n        campaign: {\r\n          select: {\r\n            name: true,\r\n            type: true\r\n          }\r\n        },\r\n        LeadMarketplace: {\r\n          select: {\r\n            marketplacePrice: true,\r\n            marketplaceVisible: true,\r\n            status: true,\r\n            soldAt: true\r\n          }\r\n        },\r\n        aiRecommendations: {\r\n          select: {\r\n            score: true,\r\n            recommendation: true\r\n          },\r\n          orderBy: {\r\n            createdAt: 'desc'\r\n          },\r\n          take: 1\r\n        }\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc'\r\n      },\r\n      take: parseInt(limit as string),\r\n      skip: parseInt(offset as string)\r\n    });\r\n\r\n    const total = await prisma.lead.count({ where });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        leads,\r\n        pagination: {\r\n          total,\r\n          limit: parseInt(limit as string),\r\n          offset: parseInt(offset as string),\r\n          hasMore: parseInt(offset as string) + parseInt(limit as string) < total\r\n        }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [PARTNER] Erreur r\u00E9cup\u00E9ration leads:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des leads partenaire' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83C\uDFEA POST /api/partner/register - S'enregistrer comme partenaire\r\nrouter.post('/register', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const {\r\n      contactPerson,\r\n      contactEmail,\r\n      contactPhone,\r\n      website,\r\n      description,\r\n      specialties = [],\r\n      commissionRate = 10\r\n    } = req.body;\r\n\r\n    // Validation\r\n    if (!contactPerson || !contactEmail) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Personne de contact et email requis' \r\n      });\r\n    }\r\n\r\n    // V\u00E9rifier si d\u00E9j\u00E0 partenaire\r\n    const existingPartner = await prisma.partnerOrganization.findUnique({\r\n      where: { organizationId }\r\n    });\r\n\r\n    if (existingPartner) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organisation d\u00E9j\u00E0 enregistr\u00E9e comme partenaire' \r\n      });\r\n    }\r\n\r\n    const partnerOrg = await prisma.partnerOrganization.create({\r\n      data: {\r\n        organizationId,\r\n        partnerType: 'LEAD_GENERATOR',\r\n        status: 'PENDING',\r\n        contactPerson,\r\n        contactEmail,\r\n        contactPhone,\r\n        website,\r\n        description,\r\n        specialties,\r\n        commissionRate: parseFloat(commissionRate.toString())\r\n      },\r\n      include: {\r\n        organization: {\r\n          select: {\r\n            name: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: partnerOrg,\r\n      message: 'Demande de partenariat enregistr\u00E9e avec succ\u00E8s'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [PARTNER] Erreur enregistrement:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de l\\'enregistrement du partenariat' \r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// Routes gestion des formulaires publics (Public Forms) - RELOAD FIX\r\nimport { Router, type Response } from 'express';\r\nimport type {\r\n  PublicForm as PrismaPublicForm,\r\n  PublicFormSubmission as PrismaPublicFormSubmission\r\n} from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\nimport { z } from 'zod';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { prisma } from '../lib/prisma.js';\r\n\r\n// \uD83D\uDD0D DEBUG: V\u00E9rifier que prisma est bien import\u00E9\r\nconsole.log('[PUBLIC-FORMS-DEBUG] prisma import\u00E9:', typeof prisma, prisma ? '\u2705 OK' : '\u274C UNDEFINED');\r\n\r\nconst router = Router();\r\n\r\nconst submissionRateLimit = rateLimit({\r\n  windowMs: 5 * 60 * 1000,\r\n  max: 10,\r\n  message: { success: false, message: 'Trop de soumissions de formulaires' }\r\n});\r\n\r\nconst adminRateLimit = rateLimit({\r\n  windowMs: 60 * 1000,\r\n  max: 100,\r\n  message: { success: false, message: 'Trop de requetes formulaires' }\r\n});\r\n\r\nconst rawBaseUrl =\r\n  process.env.PUBLIC_FORMS_BASE_URL ||\r\n  process.env.PUBLIC_SITE_URL ||\r\n  process.env.FRONTEND_BASE_URL ||\r\n  'https://devis1minute.be';\r\nconst PUBLIC_FORMS_BASE_URL = rawBaseUrl.replace(/\\/$/, '');\r\nconst DEFAULT_EMBED_HEIGHT = Number.parseInt(process.env.PUBLIC_FORM_EMBED_HEIGHT ?? '', 10) || 520;\r\n\r\nconst slugify = (value: string): string =>\r\n  value\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .replace(/[^a-zA-Z0-9\\s-]/g, '')\r\n    .trim()\r\n    .replace(/\\s+/g, '-')\r\n    .replace(/-+/g, '-')\r\n    .toLowerCase();\r\n\r\nconst generateFallbackSlug = () => `form-${Math.random().toString(36).slice(2, 8)}`;\r\n\r\nconst ensureUniqueSlug = async (\r\n  organizationId: string,\r\n  base: string,\r\n  excludeFormId?: string\r\n): Promise<string> => {\r\n  const sanitized = base || generateFallbackSlug();\r\n  let slug = sanitized;\r\n  let counter = 1;\r\n  const maxAttempts = 100;\r\n\r\n  while (counter <= maxAttempts) {\r\n    // Chercher tous les formulaires avec ce slug (actifs ET supprim\u00E9s)\r\n    const allWithSlug = await prisma.publicForm.findMany({\r\n      where: {\r\n        organizationId,\r\n        slug,\r\n        id: excludeFormId ? { not: excludeFormId } : undefined\r\n      },\r\n      select: { id: true, deletedAt: true }\r\n    });\r\n\r\n    if (allWithSlug.length === 0) {\r\n      // Aucun formulaire avec ce slug, on peut l'utiliser\r\n      console.log('[ensureUniqueSlug] \u2705 Slug disponible:', slug);\r\n      return slug;\r\n    }\r\n\r\n    // V\u00E9rifier si tous sont supprim\u00E9s\r\n    const activeOnes = allWithSlug.filter(f => f.deletedAt === null);\r\n    const deletedOnes = allWithSlug.filter(f => f.deletedAt !== null);\r\n\r\n    if (activeOnes.length === 0 && deletedOnes.length > 0) {\r\n      // Tous sont supprim\u00E9s : les supprimer d\u00E9finitivement pour lib\u00E9rer le slug\r\n      console.log(`[ensureUniqueSlug] \uD83D\uDDD1\uFE0F Suppression d\u00E9finitive de ${deletedOnes.length} formulaire(s) supprim\u00E9(s) avec le slug \"${slug}\"`);\r\n      await prisma.publicForm.deleteMany({\r\n        where: {\r\n          id: { in: deletedOnes.map(f => f.id) }\r\n        }\r\n      });\r\n      console.log('[ensureUniqueSlug] \u2705 Slug lib\u00E9r\u00E9:', slug);\r\n      return slug;\r\n    }\r\n\r\n    if (activeOnes.length > 0) {\r\n      // Il existe un formulaire actif avec ce slug, essayer avec un compteur\r\n      console.log('[ensureUniqueSlug] \u26A0\uFE0F Slug d\u00E9j\u00E0 utilis\u00E9 par un formulaire actif:', slug);\r\n      slug = `${sanitized}-${counter++}`;\r\n    }\r\n  }\r\n\r\n  // Fallback avec timestamp apr\u00E8s 100 tentatives\r\n  const timestamp = Date.now();\r\n  const timestampedSlug = `${sanitized}-${timestamp}`;\r\n  console.log('[ensureUniqueSlug] \uD83D\uDD04 Utilisation du slug avec timestamp:', timestampedSlug);\r\n  return timestampedSlug;\r\n};\r\n\r\nconst toPublicUrl = (slug: string) => `${PUBLIC_FORMS_BASE_URL}/forms/${slug}`;\r\n\r\nconst buildEmbedCode = (slug: string) => {\r\n  const url = toPublicUrl(slug);\r\n  return `<iframe src=\"${url}\" title=\"Formulaire ${slug}\" style=\"width:100%;max-width:600px;height:${DEFAULT_EMBED_HEIGHT}px;border:0;border-radius:12px;\" loading=\"lazy\" referrerpolicy=\"no-referrer-when-downgrade\"></iframe>`;\r\n};\r\n\r\nconst mapFormToResponse = (form: PrismaPublicForm) => {\r\n  const rawFields = Array.isArray(form.fields as unknown[]) ? (form.fields as unknown[]) : [];\r\n\r\n  return {\r\n    id: form.id,\r\n    name: form.name,\r\n    description: form.description ?? undefined,\r\n    category: form.category ?? 'contact',\r\n    slug: form.slug,\r\n    publicUrl: toPublicUrl(form.slug),\r\n    embedCode: buildEmbedCode(form.slug),\r\n    isActive: form.isActive && form.deletedAt === null,\r\n    collectsRgpdConsent: form.collectsRgpdConsent,\r\n    autoPublishLeads: form.autoPublishLeads,\r\n    maxSubmissionsPerDay: form.maxSubmissionsPerDay ?? undefined,\r\n    customCss: form.customCss ?? undefined,\r\n    thankYouMessage: form.thankYouMessage,\r\n    redirectUrl: form.redirectUrl ?? undefined,\r\n    submissionCount: form.submissionCount ?? 0,\r\n    conversionRate: Number(form.conversionRate ?? 0),\r\n    lastSubmission: form.lastSubmissionAt ? form.lastSubmissionAt.toISOString() : undefined,\r\n    createdAt: form.createdAt.toISOString(),\r\n    updatedAt: form.updatedAt.toISOString(),\r\n    fields: rawFields,\r\n    campaigns: form.campaigns ?? []\r\n  };\r\n};\r\n\r\nconst mapSubmissionToResponse = (submission: PrismaPublicFormSubmission) => ({\r\n  id: submission.id,\r\n  formId: submission.formId,\r\n  submittedAt: submission.createdAt.toISOString(),\r\n  ipAddress: submission.ipAddress ?? '',\r\n  userAgent: submission.userAgent ?? '',\r\n  leadId: submission.leadId ?? undefined,\r\n  data: (submission.data as Record<string, unknown>) ?? {},\r\n  status: submission.status ?? 'new'\r\n});\r\n\r\nconst optionalPositiveInt = z.preprocess((value) => {\r\n  if (value === null || value === undefined || value === '') {\r\n    return undefined;\r\n  }\r\n  if (typeof value === 'string') {\r\n    const parsed = Number(value);\r\n    return Number.isFinite(parsed) ? parsed : value;\r\n  }\r\n  return value;\r\n}, z.number().int().positive().optional());\r\n\r\nconst formFieldSchema = z\r\n  .object({\r\n    id: z.union([z.string(), z.number()]).optional(),\r\n    name: z.string().optional(),\r\n    label: z.string().optional(),\r\n    type: z.string().optional(),\r\n    required: z.boolean().optional(),\r\n    placeholder: z.string().optional(),\r\n    options: z.array(z.string()).optional(),\r\n    order: z.number().int().optional()\r\n  })\r\n  .passthrough();\r\n\r\nconst baseFormSchema = z.object({\r\n  name: z.string().min(1, 'Nom requis'),\r\n  description: z.string().max(1000).optional(),\r\n  category: z.string().max(120).optional(),\r\n  slug: z.string().max(160).optional(),\r\n  fields: z.array(formFieldSchema).default([]),\r\n  thankYouMessage: z.string().min(1).max(1000).optional(),\r\n  redirectUrl: z.string().max(500).optional(),\r\n  collectsRgpdConsent: z.boolean().optional(),\r\n  autoPublishLeads: z.boolean().optional(),\r\n  maxSubmissionsPerDay: optionalPositiveInt,\r\n  customCss: z.string().optional(),\r\n  campaigns: z.array(z.string().min(1)).optional(),\r\n  isActive: z.boolean().optional(),\r\n  isPublic: z.boolean().optional()\r\n});\r\n\r\nconst createFormSchema = baseFormSchema;\r\nconst updateFormSchema = baseFormSchema.partial();\r\nconst toggleSchema = z.object({ isActive: z.boolean() });\r\n\r\nconst submissionSchema = z\r\n  .object({\r\n    formId: z.string().min(1),\r\n    privacyConsent: z.boolean(),\r\n    marketingConsent: z.boolean().optional()\r\n  })\r\n  .passthrough();\r\n\r\nconst normalizeFormPayload = (payload: unknown) => {\r\n  if (!payload || typeof payload !== 'object') {\r\n    return {};\r\n  }\r\n\r\n  const data = { ...(payload as Record<string, unknown>) };\r\n  if (!data.name && typeof data.title === 'string') {\r\n    data.name = data.title;\r\n  }\r\n  if (!data.thankYouMessage && typeof data.submissionMessage === 'string') {\r\n    data.thankYouMessage = data.submissionMessage;\r\n  }\r\n  if (!data.fields && Array.isArray(data.formFields)) {\r\n    data.fields = data.formFields;\r\n  }\r\n  if (data.maxSubmissionsPerDay === '') {\r\n    data.maxSubmissionsPerDay = undefined;\r\n  }\r\n  return data;\r\n};\r\n\r\nconst resolveOrganizationId = (req: AuthenticatedRequest, res: Response): string | null => {\r\n  const organizationId = req.user?.organizationId;\r\n  if (!organizationId) {\r\n    res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    return null;\r\n  }\r\n  return organizationId;\r\n};\r\n\r\nconst listFormsHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const forms = await prisma.publicForm.findMany({\r\n      where: { organizationId, deletedAt: null },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    res.json(forms.map(mapFormToResponse));\r\n  } catch (error) {\r\n  console.error('[PUBLIC-FORMS] Liste impossible:', error);\r\n  res.status(500).json({ success: false, message: 'Erreur lors de la recuperation des formulaires' });\r\n  }\r\n};\r\n\r\nconst statsHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const startOfDay = new Date();\r\n    startOfDay.setHours(0, 0, 0, 0);\r\n\r\n    const [forms, totalSubmissions, todaySubmissions] = await prisma.$transaction([\r\n      prisma.publicForm.findMany({\r\n        where: { organizationId, deletedAt: null },\r\n        select: { id: true, name: true, submissionCount: true, conversionRate: true, isActive: true }\r\n      }),\r\n      prisma.publicFormSubmission.count({ where: { organizationId } }),\r\n      prisma.publicFormSubmission.count({\r\n        where: { organizationId, createdAt: { gte: startOfDay } }\r\n      })\r\n    ]);\r\n\r\n    const totalForms = forms.length;\r\n    const activeForms = forms.filter((form) => form.isActive).length;\r\n    const conversionRate =\r\n      totalForms > 0\r\n        ? Number(\r\n            (\r\n              forms.reduce((sum, form) => sum + Number(form.conversionRate ?? 0), 0) /\r\n              totalForms\r\n            ).toFixed(2)\r\n          )\r\n        : 0;\r\n\r\n    const topForm = forms.reduce<null | (typeof forms)[number]>((best, current) => {\r\n      if (!best || current.submissionCount > best.submissionCount) {\r\n        return current;\r\n      }\r\n      return best;\r\n    }, null);\r\n\r\n    res.json({\r\n      totalForms,\r\n      activeForms,\r\n      totalSubmissions,\r\n      todaySubmissions,\r\n      conversionRate,\r\n      topPerformingForm: topForm?.name ?? ''\r\n    });\r\n  } catch (error) {\r\n    console.error('[PUBLIC-FORMS] Statistiques impossibles:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la recuperation des statistiques' });\r\n  }\r\n};\r\n\r\nconst submissionsHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  const { formId } = req.params;\r\n\r\n  try {\r\n    const form = await prisma.publicForm.findFirst({\r\n      where: { id: formId, organizationId, deletedAt: null }\r\n    });\r\n\r\n    if (!form) {\r\n      res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      return;\r\n    }\r\n\r\n    const submissions = await prisma.publicFormSubmission.findMany({\r\n      where: { formId: form.id, organizationId },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 100\r\n    });\r\n\r\n    res.json(submissions.map(mapSubmissionToResponse));\r\n  } catch (error) {\r\n    console.error('[PUBLIC-FORMS] Soumissions impossibles:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la recuperation des soumissions' });\r\n  }\r\n};\r\n\r\nconst createFormHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  const normalized = normalizeFormPayload(req.body);\r\n  const parsed = createFormSchema.safeParse(normalized);\r\n\r\n  if (!parsed.success) {\r\n    res.status(400).json({ success: false, message: 'Donnees invalides', issues: parsed.error.flatten() });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const payload = parsed.data;\r\n    const baseSlug = slugify(payload.slug ?? payload.name);\r\n    const slug = await ensureUniqueSlug(organizationId, baseSlug);\r\n\r\n    const created = await prisma.publicForm.create({\r\n      data: {\r\n        organizationId,\r\n        name: payload.name.trim(),\r\n        description: payload.description?.trim() || null,\r\n        category: (payload.category ?? 'contact').toLowerCase(),\r\n        slug,\r\n        fields: payload.fields,\r\n        thankYouMessage: payload.thankYouMessage ?? 'Merci pour votre soumission !',\r\n        redirectUrl: payload.redirectUrl?.trim() || null,\r\n        collectsRgpdConsent: payload.collectsRgpdConsent ?? true,\r\n        autoPublishLeads: payload.autoPublishLeads ?? false,\r\n        maxSubmissionsPerDay: payload.maxSubmissionsPerDay ?? null,\r\n        customCss: payload.customCss ?? null,\r\n        campaigns: payload.campaigns ?? [],\r\n        isActive: payload.isActive ?? true,\r\n        isPublic: payload.isPublic ?? true,\r\n        submissionCount: 0,\r\n        conversionRate: 0\r\n      }\r\n    });\r\n\r\n    res.status(201).json(mapFormToResponse(created));\r\n  } catch (error) {\r\n    console.error('[PUBLIC-FORMS] Creation impossible:', error);\r\n    \r\n    // Erreur de contrainte unique (ne devrait plus arriver avec la nouvelle logique)\r\n    if (error instanceof Error && 'code' in error && error.code === 'P2002') {\r\n      res.status(409).json({ \r\n        success: false, \r\n        message: 'Un formulaire avec ce nom existe d\u00E9j\u00E0. Veuillez choisir un autre nom.' \r\n      });\r\n      return;\r\n    }\r\n    \r\n    res.status(500).json({ success: false, message: 'Erreur lors de la cr\u00E9ation du formulaire' });\r\n  }\r\n};\r\n\r\nconst updateFormHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  const { formId } = req.params;\r\n  const normalized = normalizeFormPayload(req.body);\r\n  const parsed = updateFormSchema.safeParse(normalized);\r\n\r\n  if (!parsed.success) {\r\n    res.status(400).json({ success: false, message: 'Donnees invalides', issues: parsed.error.flatten() });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const form = await prisma.publicForm.findFirst({\r\n      where: { id: formId, organizationId, deletedAt: null }\r\n    });\r\n\r\n    if (!form) {\r\n      res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      return;\r\n    }\r\n\r\n    const payload = parsed.data;\r\n    let nextSlug = form.slug;\r\n\r\n    if (payload.slug || payload.name) {\r\n      const baseSlug = slugify(payload.slug ?? payload.name ?? form.name);\r\n      nextSlug = await ensureUniqueSlug(organizationId, baseSlug, form.id);\r\n    }\r\n\r\n    const data: Record<string, unknown> = {};\r\n\r\n    if (payload.name !== undefined) data.name = payload.name.trim();\r\n    if (payload.description !== undefined) data.description = payload.description?.trim() || null;\r\n    if (payload.category !== undefined) data.category = payload.category;\r\n    if (payload.fields !== undefined) data.fields = payload.fields;\r\n    if (payload.thankYouMessage !== undefined) data.thankYouMessage = payload.thankYouMessage;\r\n    if (payload.redirectUrl !== undefined) data.redirectUrl = payload.redirectUrl?.trim() || null;\r\n    if (payload.collectsRgpdConsent !== undefined) data.collectsRgpdConsent = payload.collectsRgpdConsent;\r\n    if (payload.autoPublishLeads !== undefined) data.autoPublishLeads = payload.autoPublishLeads;\r\n    if (payload.maxSubmissionsPerDay !== undefined) data.maxSubmissionsPerDay = payload.maxSubmissionsPerDay ?? null;\r\n    if (payload.customCss !== undefined) data.customCss = payload.customCss ?? null;\r\n    if (payload.campaigns !== undefined) data.campaigns = payload.campaigns;\r\n    if (payload.isActive !== undefined) data.isActive = payload.isActive;\r\n    if (nextSlug !== form.slug) data.slug = nextSlug;\r\n\r\n    const updated = await prisma.publicForm.update({\r\n      where: { id: form.id },\r\n      data\r\n    });\r\n\r\n    res.json(mapFormToResponse(updated));\r\n  } catch (error) {\r\n    console.error('[PUBLIC-FORMS] Mise \u00E0 jour impossible:', error);\r\n    \r\n    // Erreur de contrainte unique lors de la modification du slug\r\n    if (error instanceof Error && 'code' in error && error.code === 'P2002') {\r\n      res.status(409).json({ \r\n        success: false, \r\n        message: 'Un formulaire avec ce nom existe d\u00E9j\u00E0. Veuillez choisir un autre nom.' \r\n      });\r\n      return;\r\n    }\r\n    \r\n    res.status(500).json({ success: false, message: 'Erreur lors de la mise \u00E0 jour du formulaire' });\r\n  }\r\n};\r\n\r\nconst toggleFormHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  const { formId } = req.params;\r\n  const parsed = toggleSchema.safeParse(req.body);\r\n\r\n  if (!parsed.success) {\r\n    res.status(400).json({ success: false, message: 'Donnees invalides', issues: parsed.error.flatten() });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const form = await prisma.publicForm.findFirst({\r\n      where: { id: formId, organizationId, deletedAt: null }\r\n    });\r\n\r\n    if (!form) {\r\n      res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      return;\r\n    }\r\n\r\n    const updated = await prisma.publicForm.update({\r\n      where: { id: form.id },\r\n      data: { isActive: parsed.data.isActive }\r\n    });\r\n\r\n    res.json(mapFormToResponse(updated));\r\n  } catch (error) {\r\n    console.error('[PUBLIC-FORMS] Toggle impossible:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors du changement de statut du formulaire' });\r\n  }\r\n};\r\n\r\nconst deleteFormHandler = async (req: AuthenticatedRequest, res: Response) => {\r\n  const organizationId = resolveOrganizationId(req, res);\r\n  if (!organizationId) {\r\n    return;\r\n  }\r\n\r\n  const { formId } = req.params;\r\n\r\n  try {\r\n    const form = await prisma.publicForm.findFirst({\r\n      where: { id: formId, organizationId, deletedAt: null }\r\n    });\r\n\r\n    if (!form) {\r\n      res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      return;\r\n    }\r\n\r\n    // Modifier le slug pour lib\u00E9rer le nom (\u00E9viter les conflits avec la contrainte UNIQUE)\r\n    const deletedSlug = `${form.slug}-deleted-${Date.now()}`;\r\n    \r\n    await prisma.publicForm.update({\r\n      where: { id: form.id },\r\n      data: {\r\n        deletedAt: new Date(),\r\n        isActive: false,\r\n        slug: deletedSlug // Lib\u00E8re le slug original pour r\u00E9utilisation\r\n      }\r\n    });\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('[PUBLIC-FORMS] Suppression impossible:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la suppression du formulaire' });\r\n  }\r\n};\r\n\r\nrouter.get(\r\n  '/',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  listFormsHandler\r\n);\r\nrouter.get(\r\n  '/stats',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  statsHandler\r\n);\r\nrouter.get(\r\n  '/:formId/submissions',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  submissionsHandler\r\n);\r\nrouter.get(\r\n  '/:formId',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  async (req, res) => {\r\n    try {\r\n      const { formId } = req.params;\r\n      const user = (req as any).user;\r\n\r\n      const form = await prisma.publicForm.findFirst({\r\n        where: {\r\n          id: formId,\r\n          deletedAt: null,\r\n          ...(user.isSuperAdmin ? {} : { organizationId: user.organizationId })\r\n        }\r\n      });\r\n\r\n      if (!form) {\r\n        return res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      }\r\n\r\n      res.json(form);\r\n    } catch (error) {\r\n      console.error('[PUBLIC-FORMS] Erreur r\u00E9cup\u00E9ration formulaire:', error);\r\n      res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration du formulaire' });\r\n    }\r\n  }\r\n);\r\nrouter.post(\r\n  '/',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  createFormHandler\r\n);\r\nrouter.put(\r\n  '/:formId',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  updateFormHandler\r\n);\r\nrouter.patch(\r\n  '/:formId/toggle',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  toggleFormHandler\r\n);\r\nrouter.delete(\r\n  '/:formId',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  deleteFormHandler\r\n);\r\n\r\nconst adminRouter = Router();\r\nadminRouter.get('/list', listFormsHandler);\r\nadminRouter.get('/stats', statsHandler);\r\nadminRouter.get('/:formId/submissions', submissionsHandler);\r\nadminRouter.post('/create', createFormHandler);\r\nadminRouter.put('/:formId', updateFormHandler);\r\nadminRouter.patch('/:formId/toggle', toggleFormHandler);\r\nadminRouter.post('/:formId/toggle', toggleFormHandler);\r\nadminRouter.delete('/:formId', deleteFormHandler);\r\nrouter.use(\r\n  '/admin',\r\n  authMiddleware,\r\n  requireRole(['admin', 'super_admin']),\r\n  adminRateLimit,\r\n  adminRouter\r\n);\r\n\r\nrouter.get('/public/:identifier/config', async (req, res) => {\r\n  try {\r\n    const { identifier } = req.params;\r\n    const form = await prisma.publicForm.findFirst({\r\n      where: {\r\n        deletedAt: null,\r\n        isActive: true,\r\n        isPublic: true,\r\n        OR: [{ id: identifier }, { slug: identifier }]\r\n      }\r\n    });\r\n\r\n    if (!form) {\r\n      res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      return;\r\n    }\r\n\r\n    const fields = Array.isArray(form.fields as unknown[]) ? (form.fields as unknown[]) : [];\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: form.id,\r\n        title: form.name,\r\n        name: form.name,\r\n        description: form.description,\r\n        fields,\r\n        styling: {\r\n          submitLabel: 'Envoyer',\r\n          customCss: form.customCss ?? undefined,\r\n          redirectUrl: form.redirectUrl ?? undefined\r\n        },\r\n        submissionMessage: form.thankYouMessage\r\n      }\r\n    });\r\n  } catch (error) {\r\n  console.error('[PUBLIC-FORMS] Config publique impossible:', error);\r\n  res.status(500).json({ success: false, message: 'Erreur lors de la recuperation de la configuration du formulaire' });\r\n  }\r\n});\r\n\r\nrouter.post('/submit', submissionRateLimit, async (req, res) => {\r\n  const parsed = submissionSchema.safeParse(req.body);\r\n\r\n  if (!parsed.success) {\r\n    res.status(400).json({ success: false, message: 'Donnees de soumission invalides', issues: parsed.error.flatten() });\r\n    return;\r\n  }\r\n\r\n  const { formId, privacyConsent, marketingConsent = false, ...payload } = parsed.data as {\r\n    formId: string;\r\n    privacyConsent: boolean;\r\n    marketingConsent?: boolean;\r\n    [key: string]: unknown;\r\n  };\r\n\r\n  if (!privacyConsent) {\r\n  res.status(400).json({ success: false, message: 'Consentement de confidentialite requis' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const form = await prisma.publicForm.findFirst({\r\n      where: {\r\n        deletedAt: null,\r\n        isActive: true,\r\n        isPublic: true,\r\n        OR: [{ id: formId }, { slug: formId }]\r\n      }\r\n    });\r\n\r\n    if (!form) {\r\n      res.status(404).json({ success: false, message: 'Formulaire introuvable' });\r\n      return;\r\n    }\r\n\r\n    if (form.maxSubmissionsPerDay) {\r\n      const startOfDay = new Date();\r\n      startOfDay.setHours(0, 0, 0, 0);\r\n\r\n      const submissionsToday = await prisma.publicFormSubmission.count({\r\n        where: {\r\n          formId: form.id,\r\n          createdAt: { gte: startOfDay }\r\n        }\r\n      });\r\n\r\n      if (submissionsToday >= form.maxSubmissionsPerDay) {\r\n        res.status(429).json({ success: false, message: 'Limite de soumissions atteinte pour aujourd\\'hui' });\r\n        return;\r\n      }\r\n    }\r\n\r\n    const ipAddress =\r\n      (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||\r\n      req.socket.remoteAddress ||\r\n      'unknown';\r\n    const userAgent = req.headers['user-agent'] ?? 'unknown';\r\n\r\n    const submission = await prisma.publicFormSubmission.create({\r\n      data: {\r\n        formId: form.id,\r\n        organizationId: form.organizationId,\r\n        data: payload,\r\n        status: 'new',\r\n        ipAddress,\r\n        userAgent,\r\n        privacyConsent,\r\n        marketingConsent\r\n      }\r\n    });\r\n\r\n    await prisma.publicForm.update({\r\n      where: { id: form.id },\r\n      data: {\r\n        submissionCount: { increment: 1 },\r\n        lastSubmissionAt: new Date()\r\n      }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      message: form.thankYouMessage,\r\n      data: {\r\n        submissionId: submission.id,\r\n        submittedAt: submission.createdAt.toISOString()\r\n      }\r\n    });\r\n  } catch (error) {\r\n  console.error('[PUBLIC-FORMS] Soumission impossible:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la soumission du formulaire' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83C\uDFAF DEVIS1MINUTE - Routes Landing Pages\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient, type Prisma } from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 RATE LIMITING PUBLIC\r\nconst publicLandingRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 100, // 100 vues par minute par IP\r\n  message: { success: false, message: 'Trop de requ\u00EAtes landing pages' }\r\n});\r\n\r\n// \uD83D\uDD12 RATE LIMITING ADMIN\r\nconst adminLandingRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 50, // 50 requ\u00EAtes par minute\r\n  message: { success: false, message: 'Trop de requ\u00EAtes landing admin' }\r\n});\r\n\r\ntype JsonValue = Prisma.JsonValue;\r\ntype JsonObject = Prisma.JsonObject;\r\n\r\nconst isJsonObject = (value: JsonValue | null | undefined): value is JsonObject =>\r\n  typeof value === 'object' && value !== null && !Array.isArray(value);\r\n\r\nconst toJsonObject = (value: JsonValue | null | undefined): JsonObject =>\r\n  (isJsonObject(value) ? value : {}) as JsonObject;\r\n\r\nconst toStringOrNull = (value: JsonValue | null | undefined): string | null =>\r\n  (typeof value === 'string' ? value : null);\r\n\r\nconst toStringArray = (value: JsonValue | null | undefined): string[] =>\r\n  Array.isArray(value) ? value.filter((item): item is string => typeof item === 'string') : [];\r\n\r\ntype LandingSnapshot = JsonObject & {\r\n  id: string;\r\n  label: string;\r\n  createdAt: string;\r\n  content: JsonObject;\r\n  settings: JsonObject;\r\n};\r\n\r\nconst toSnapshots = (value: JsonValue | null | undefined): LandingSnapshot[] => {\r\n  if (!Array.isArray(value)) return [];\r\n\r\n  return value\r\n    .filter((item): item is JsonObject => isJsonObject(item))\r\n    .map((item) => {\r\n      const id = toStringOrNull(item.id);\r\n      const label = toStringOrNull(item.label) ?? `Snapshot ${new Date().toLocaleString()}`;\r\n      const createdAt = toStringOrNull(item.createdAt) ?? new Date().toISOString();\r\n      const content = toJsonObject(item.content ?? {});\r\n      const settings = toJsonObject(item.settings ?? {});\r\n\r\n      if (!id) {\r\n        return null;\r\n      }\r\n\r\n      const snapshot: LandingSnapshot = {\r\n        id,\r\n        label,\r\n        createdAt,\r\n        content,\r\n        settings\r\n      };\r\n\r\n      return snapshot;\r\n    })\r\n    .filter((snapshot): snapshot is LandingSnapshot => snapshot !== null);\r\n};\r\n\r\n// \uD83C\uDF10 GET /api/landing-pages/public/:slug - Affichage public d'une landing page\r\nrouter.get('/public/:slug', publicLandingRateLimit, async (req, res) => {\r\n  try {\r\n    const { slug } = req.params;\r\n\r\n    // Pas de mod\u00E8le LandingPage dans le sch\u00E9ma actuel.\r\n    // Utiliser TreeBranchLeafTree comme container de contenu public \"landing\" via category='landing'.\r\n    // On tente de retrouver soit par id (slug=id), soit par name.\r\n    const landingPage = await prisma.treeBranchLeafTree.findFirst({\r\n      where: {\r\n        category: 'landing',\r\n        isPublic: true,\r\n        OR: [\r\n          { id: slug },\r\n          { name: slug }\r\n        ]\r\n      },\r\n      include: { Organization: { select: { name: true } } }\r\n    });\r\n\r\n    if (!landingPage) {\r\n      return res.status(404).json({ \r\n        success: false, \r\n        message: 'Landing page non trouv\u00E9e' \r\n      });\r\n    }\r\n\r\n    // Incr\u00E9menter le compteur de vues\r\n    // Compte de vues: cr\u00E9er un enregistrement dans TreeBranchLeafSubmission comme trace minimaliste\r\n    await prisma.treeBranchLeafSubmission.create({\r\n      data: {\r\n        treeId: landingPage.id,\r\n        status: 'view',\r\n        summary: {},\r\n        exportData: {},\r\n      }\r\n    });\r\n\r\n    // Extraire SEO et tracking \u00E0 partir des blobs JSON existants (sans changer le sch\u00E9ma)\r\n    const content = toJsonObject(landingPage.metadata);\r\n    const styling = toJsonObject(landingPage.settings);\r\n    const seo = toJsonObject(content.seo ?? null);\r\n    const tracking = toJsonObject(styling.tracking ?? null);\r\n    const title = toStringOrNull(content.title) ?? landingPage.name;\r\n    const subtitle = toStringOrNull(content.subtitle);\r\n    const ctaButton = toStringOrNull(content.ctaButton);\r\n    const ctaUrl = toStringOrNull(content.ctaUrl);\r\n    const seoTitle = toStringOrNull(seo.title) ?? landingPage.name;\r\n    const seoDescription = toStringOrNull(seo.description);\r\n    const keywords = toStringArray(seo.keywords);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: landingPage.id,\r\n        title,\r\n        subtitle,\r\n        content,\r\n        seo: {\r\n          title: seoTitle,\r\n          description: seoDescription,\r\n          keywords\r\n        },\r\n        styling,\r\n        tracking, // { googleTagId?: string; metaPixelId?: string; enable?: boolean }\r\n        ctaButton,\r\n        ctaUrl,\r\n        campaign: { name: landingPage.Organization?.name }\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING-PAGES] Erreur affichage public:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de l\\'affichage de la landing page' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCCA POST /api/landing-pages/public/:slug/track - Tracking d'\u00E9v\u00E9nements sur landing page\r\nrouter.post('/public/:slug/track', publicLandingRateLimit, async (req, res) => {\r\n  try {\r\n    const { slug } = req.params;\r\n    const { event, data = {} } = req.body;\r\n\r\n    // Validation\r\n    if (!event) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Type d\\'\u00E9v\u00E9nement requis' \r\n      });\r\n    }\r\n\r\n    const landingPage = await prisma.treeBranchLeafTree.findFirst({\r\n      where: {\r\n        category: 'landing',\r\n        OR: [ { id: slug }, { name: slug } ]\r\n      },\r\n      select: { id: true, organizationId: true }\r\n    });\r\n\r\n    if (!landingPage) {\r\n      return res.status(404).json({ \r\n        success: false, \r\n        message: 'Landing page non trouv\u00E9e' \r\n      });\r\n    }\r\n\r\n    // Enregistrer l'\u00E9v\u00E9nement de tracking\r\n    // Utiliser TreeBranchLeafSubmission comme log d'\u00E9v\u00E9nement minimal\r\n    await prisma.treeBranchLeafSubmission.create({\r\n      data: {\r\n        treeId: landingPage.id,\r\n        status: event,\r\n        summary: data || {},\r\n        exportData: {\r\n          userAgent: req.get('User-Agent'),\r\n          ip: req.ip,\r\n          referer: req.get('Referer')\r\n        }\r\n      }\r\n    });\r\n\r\n    // Incr\u00E9menter les compteurs sp\u00E9cifiques selon l'\u00E9v\u00E9nement\r\n    // Compteurs d\u00E9riv\u00E9s via agr\u00E9gations, pas d'update direct requis ici.\r\n\r\n    res.json({\r\n      success: true,\r\n      message: '\u00C9v\u00E9nement track\u0117 avec succ\u00E8s'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING-PAGES] Erreur tracking:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors du tracking' \r\n    });\r\n  }\r\n});\r\n\r\n// === ROUTES ADMINISTRATEUR (AUTHENTIFI\u00C9ES) ===\r\n\r\nrouter.use('/admin', authMiddleware);\r\nrouter.use('/admin', adminLandingRateLimit);\r\n\r\n// \uD83D\uDCCB GET /api/landing-pages/admin/list - Liste des landing pages\r\nrouter.get('/admin/list', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    // Repr\u00E9senter les landing pages par les arbres TBL avec category='landing'\r\n    const trees = await prisma.treeBranchLeafTree.findMany({\r\n      where: { organizationId, category: 'landing' },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n\r\n    // Pour chaque tree, compter les \"vues\" et \"conversions\" via TreeBranchLeafSubmission.status\r\n    const data = await Promise.all(\r\n      trees.map(async (t) => {\r\n        const [views, conversions] = await Promise.all([\r\n          prisma.treeBranchLeafSubmission.count({ where: { treeId: t.id, status: 'view' } }),\r\n          prisma.treeBranchLeafSubmission.count({ where: { treeId: t.id, status: 'form_submit' } })\r\n        ]);\r\n        const conversionRate = views > 0 ? Math.round((conversions / views) * 100) : 0;\r\n        const content = toJsonObject(t.metadata);\r\n        const status = (t.status ?? 'draft').toUpperCase();\r\n        return {\r\n          id: t.id,\r\n          title: t.name,\r\n          slug: t.id,\r\n          description: t.description ?? '',\r\n          content,\r\n          status,\r\n          metaTitle: t.name,\r\n          metaDescription: '',\r\n          keywords: [],\r\n          customCSS: '',\r\n          customJS: '',\r\n          trackingPixels: [],\r\n          publishedAt: t.status === 'published' ? t.updatedAt : null,\r\n          views,\r\n          conversions,\r\n          conversionRate,\r\n          createdAt: t.createdAt,\r\n          updatedAt: t.updatedAt\r\n        };\r\n      })\r\n    );\r\n\r\n    res.json({ success: true, data });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING-ADMIN] Erreur liste:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des landing pages' });\r\n  }\r\n});\r\n\r\n// GET /api/landing-pages - alias simple pour la page front existante\r\nrouter.get('/', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    // R\u00E9utiliser l'impl\u00E9mentation admin/list mais renvoyer data directement\r\n    // pour compat avec la page frontend actuelle qui appelle /api/landing-pages\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const trees = await prisma.treeBranchLeafTree.findMany({ where: { organizationId, category: 'landing' }, orderBy: { createdAt: 'desc' } });\r\n    const data = await Promise.all(\r\n      trees.map(async (t) => {\r\n        const [views, conversions] = await Promise.all([\r\n          prisma.treeBranchLeafSubmission.count({ where: { treeId: t.id, status: 'view' } }),\r\n          prisma.treeBranchLeafSubmission.count({ where: { treeId: t.id, status: 'form_submit' } })\r\n        ]);\r\n        const conversionRate = views > 0 ? Math.round((conversions / views) * 100) : 0;\r\n        const content = toJsonObject(t.metadata);\r\n        const status = (t.status ?? 'draft').toUpperCase();\r\n        return {\r\n          id: t.id,\r\n          title: t.name,\r\n          slug: t.id,\r\n          description: t.description ?? '',\r\n          content,\r\n          status,\r\n          metaTitle: t.name,\r\n          metaDescription: '',\r\n          keywords: [],\r\n          customCSS: '',\r\n          customJS: '',\r\n          trackingPixels: [],\r\n          publishedAt: t.status === 'published' ? t.updatedAt : null,\r\n          views,\r\n          conversions,\r\n          conversionRate,\r\n          createdAt: t.createdAt,\r\n          updatedAt: t.updatedAt\r\n        };\r\n      })\r\n    );\r\n    res.json({ success: true, data });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur / (list):', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des landing pages' });\r\n  }\r\n});\r\n\r\n// GET /api/landing-pages/stats - statistiques globales\r\nrouter.get('/stats', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const totalPages = await prisma.treeBranchLeafTree.count({ where: { organizationId, category: 'landing' } });\r\n    const publishedPages = await prisma.treeBranchLeafTree.count({ where: { organizationId, category: 'landing', status: 'published' } });\r\n    const draftPages = totalPages - publishedPages;\r\n\r\n    const [totalViews, totalConversions] = await Promise.all([\r\n      prisma.treeBranchLeafSubmission.count({ where: { status: 'view', TreeBranchLeafTree: { organizationId, category: 'landing' } } }),\r\n      prisma.treeBranchLeafSubmission.count({ where: { status: 'form_submit', TreeBranchLeafTree: { organizationId, category: 'landing' } } })\r\n    ]);\r\n\r\n    const avgConversionRate = totalViews > 0 ? Math.round((totalConversions / totalViews) * 100) : 0;\r\n    res.json({ success: true, data: { totalPages, publishedPages, draftPages, totalViews, totalConversions, avgConversionRate } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur /stats:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des statistiques' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC8 GET /api/landing-pages/stats/timeseries?days=30\r\nrouter.get('/stats/timeseries', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n  const daysParam = Array.isArray(req.query.days) ? req.query.days[0] : req.query.days;\r\n  const requestedDays = Number.parseInt(daysParam ?? '30', 10);\r\n  const safeDays = Number.isNaN(requestedDays) ? 30 : requestedDays;\r\n  const days = Math.min(365, Math.max(1, safeDays));\r\n    const start = new Date(); start.setDate(start.getDate() - (days - 1)); start.setHours(0,0,0,0);\r\n\r\n    const submissions = await prisma.treeBranchLeafSubmission.findMany({\r\n      where: { createdAt: { gte: start }, TreeBranchLeafTree: { organizationId, category: 'landing' } },\r\n      select: { createdAt: true, status: true }\r\n    });\r\n\r\n    const byDay = new Map<string, { views: number; conversions: number }>();\r\n    for (let i = 0; i < days; i++) {\r\n      const d = new Date(start.getTime()); d.setDate(start.getDate() + i);\r\n      byDay.set(d.toISOString().slice(0,10), { views: 0, conversions: 0 });\r\n    }\r\n    for (const s of submissions) {\r\n      const key = new Date(s.createdAt as unknown as Date).toISOString().slice(0,10);\r\n      const rec = byDay.get(key); if (!rec) continue;\r\n      if (s.status === 'view') rec.views++;\r\n      if (s.status === 'form_submit') rec.conversions++;\r\n    }\r\n    const series = Array.from(byDay.entries()).map(([date, v]) => ({ date, views: v.views, conversions: v.conversions }));\r\n    res.json({ success: true, data: { start: start.toISOString(), days, series } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur timeseries:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur s\u00E9ries temporelles landing' });\r\n  }\r\n});\r\n\r\n// === CRUD minimal pour la compatibilit\u00E9 avec la page front ===\r\n\r\n// Cr\u00E9er\r\nrouter.post('/', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n  const { title, description, content, status, settings } = req.body as { title: string; description?: string; content?: unknown; status?: string; settings?: unknown };\r\n    if (!title) return res.status(400).json({ success: false, message: 'Titre requis' });\r\n\r\n    const created = await prisma.treeBranchLeafTree.create({\r\n      data: {\r\n        organizationId,\r\n        name: title,\r\n        description: description || '',\r\n        category: 'landing',\r\n        status: (status || 'DRAFT').toLowerCase(),\r\n        metadata: content || {},\r\n        settings: settings || {}\r\n      }\r\n    });\r\n    res.json({ success: true, data: { id: created.id } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur cr\u00E9ation:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la cr\u00E9ation' });\r\n  }\r\n});\r\n\r\n// Mettre \u00E0 jour\r\nrouter.put('/:id', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n\r\n    const { title, description, content, status, settings } = req.body as { title?: string; description?: string; content?: unknown; status?: string; settings?: unknown };\r\n    const updated = await prisma.treeBranchLeafTree.update({\r\n      where: { id },\r\n      data: {\r\n        name: title ?? tree.name,\r\n        description: description ?? tree.description,\r\n        metadata: content ?? tree.metadata,\r\n        settings: settings ?? tree.settings,\r\n        status: status ? status.toLowerCase() : tree.status\r\n      }\r\n    });\r\n    res.json({ success: true, data: { id: updated.id } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur mise \u00E0 jour:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la mise \u00E0 jour' });\r\n  }\r\n});\r\n\r\n// Supprimer\r\nrouter.delete('/:id', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const deleted = await prisma.treeBranchLeafTree.deleteMany({ where: { id, organizationId, category: 'landing' } });\r\n    if (deleted.count === 0) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur suppression:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la suppression' });\r\n  }\r\n});\r\n\r\n// Publier / D\u00E9publier\r\nrouter.patch('/:id/publish', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { publish } = req.body as { publish?: boolean };\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    if (publish === undefined) return res.status(400).json({ success: false, message: 'Param\u00E8tre publish manquant' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n\r\n    const updated = await prisma.treeBranchLeafTree.update({ where: { id }, data: { status: publish ? 'published' : 'draft', isPublic: !!publish } });\r\n    res.json({ success: true, data: { id: updated.id, status: updated.status } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur publish:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la publication' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC4 GET /api/landing-pages/admin/:id - D\u00E9tails d'une landing page (TreeBranchLeafTree)\r\nrouter.get('/admin/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n\r\n    const content = toJsonObject(tree.metadata);\r\n    const styling = toJsonObject(tree.settings);\r\n    const seo = toJsonObject(content.seo ?? null);\r\n    const tracking = toJsonObject(styling.tracking ?? null);\r\n    const status = (tree.status ?? 'draft').toUpperCase();\r\n    const seoTitle = toStringOrNull(seo.title) ?? tree.name;\r\n    const seoDescription = toStringOrNull(seo.description) ?? '';\r\n    const keywords = toStringArray(seo.keywords);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        id: tree.id,\r\n        title: tree.name,\r\n        description: tree.description ?? '',\r\n        status,\r\n        content,\r\n        seo: {\r\n          title: seoTitle,\r\n          description: seoDescription,\r\n          keywords\r\n        },\r\n        styling,\r\n        tracking,\r\n        isPublic: !!tree.isPublic,\r\n        createdAt: tree.createdAt,\r\n        updatedAt: tree.updatedAt\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING-ADMIN] Erreur d\u00E9tail:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration du d\u00E9tail' });\r\n  }\r\n});\r\n\r\n// \uD83E\uDDEC POST /api/landing-pages/:id/duplicate - Dupliquer la landing (draft)\r\nrouter.post('/:id/duplicate', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n\r\n    const suffix = Math.random().toString(36).slice(2, 6);\r\n    const copy = await prisma.treeBranchLeafTree.create({\r\n      data: {\r\n        organizationId,\r\n        name: `${tree.name} (copie ${suffix})`,\r\n        description: tree.description || '',\r\n        category: 'landing',\r\n        status: 'draft',\r\n        isPublic: false,\r\n        metadata: toJsonObject(tree.metadata),\r\n        settings: toJsonObject(tree.settings)\r\n      }\r\n    });\r\n    res.json({ success: true, data: { id: copy.id } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur duplication:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la duplication' });\r\n  }\r\n});\r\n\r\n// \uD83E\uDDF1 POST /api/landing-pages/:id/snapshot - Cr\u00E9er un snapshot (versionnage sans migration)\r\nrouter.post('/:id/snapshot', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { label } = req.body as { label?: string };\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n\r\n    const settings = toJsonObject(tree.settings);\r\n    const versions = toSnapshots(settings._versions);\r\n    const snapshotId = `${Date.now()}_${Math.random().toString(36).slice(2,6)}`;\r\n    const snapshot: LandingSnapshot = {\r\n      id: snapshotId,\r\n      label: label || `Snapshot ${new Date().toLocaleString()}`,\r\n      createdAt: new Date().toISOString(),\r\n      content: toJsonObject(tree.metadata),\r\n      settings: toJsonObject(tree.settings)\r\n    };\r\n    const updatedSettings: JsonObject = {\r\n      ...settings,\r\n      _versions: [snapshot, ...versions] as Prisma.JsonArray\r\n    };\r\n    const updated = await prisma.treeBranchLeafTree.update({ where: { id }, data: { settings: updatedSettings } });\r\n    res.json({ success: true, data: { id: updated.id, snapshotId } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur snapshot:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la cr\u00E9ation du snapshot' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDDC2\uFE0F GET /api/landing-pages/:id/versions - Lister les versions\r\nrouter.get('/:id/versions', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n    const settings = toJsonObject(tree.settings);\r\n    const versions = toSnapshots(settings._versions);\r\n    res.json({\r\n      success: true,\r\n      data: versions.map((version) => ({\r\n        id: version.id,\r\n        label: version.label,\r\n        createdAt: version.createdAt\r\n      }))\r\n    });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur versions:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des versions' });\r\n  }\r\n});\r\n\r\n// \u267B\uFE0F POST /api/landing-pages/:id/restore - Restaurer une version\r\nrouter.post('/:id/restore', authMiddleware, adminLandingRateLimit, requireRole(['admin','super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { snapshotId } = req.body as { snapshotId: string };\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    if (!snapshotId) return res.status(400).json({ success: false, message: 'snapshotId requis' });\r\n\r\n    const tree = await prisma.treeBranchLeafTree.findFirst({ where: { id, organizationId, category: 'landing' } });\r\n    if (!tree) return res.status(404).json({ success: false, message: 'Landing page non trouv\u00E9e' });\r\n    const settings = toJsonObject(tree.settings);\r\n    const versions = toSnapshots(settings._versions);\r\n    const snap = versions.find((version) => version.id === snapshotId);\r\n    if (!snap) return res.status(404).json({ success: false, message: 'Snapshot non trouv\u00E9' });\r\n\r\n    const updated = await prisma.treeBranchLeafTree.update({\r\n      where: { id },\r\n      data: {\r\n        metadata: snap.content,\r\n        settings: { ...snap.settings, _versions: versions as Prisma.JsonArray }\r\n      }\r\n    });\r\n    res.json({ success: true, data: { id: updated.id } });\r\n  } catch (error) {\r\n    console.error('\u274C [LANDING] Erreur restore:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la restauration' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83C\uDFAF DEVIS1MINUTE - Routes Campaign Analytics\r\nimport { Router } from 'express';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport rateLimit from 'express-rate-limit';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 RATE LIMITING\r\nconst campaignAnalyticsRateLimit = rateLimit({\r\n  windowMs: 60 * 1000, // 1 minute\r\n  max: 50, // 50 requ\u00EAtes par minute\r\n  message: { success: false, message: 'Trop de requ\u00EAtes campaign analytics' }\r\n});\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(campaignAnalyticsRateLimit);\r\n\r\n// \uD83D\uDCCA GET /api/campaign-analytics/dashboard - Dashboard analytics g\u00E9n\u00E9ral\r\nrouter.get('/dashboard', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const { period = '30' } = req.query;\r\n    \r\n    // Calcul de la p\u00E9riode\r\n    const startDate = new Date();\r\n    startDate.setDate(startDate.getDate() - parseInt(period as string));\r\n\r\n    // M\u00E9triques globales en parall\u00E8le\r\n    const [\r\n      totalLeads,\r\n      periodLeads,\r\n      activeCampaigns,\r\n      totalRevenue,\r\n      averageAiScore,\r\n      conversionFunnel\r\n    ] = await Promise.all([\r\n      // Total des leads\r\n      prisma.lead.count({\r\n        where: { organizationId }\r\n      }),\r\n      \r\n      // Leads de la p\u00E9riode\r\n      prisma.lead.count({\r\n        where: { \r\n          organizationId,\r\n          createdAt: { gte: startDate }\r\n        }\r\n      }),\r\n      \r\n      // Campagnes actives\r\n      prisma.campaign.count({\r\n        where: { \r\n          organizationId,\r\n          status: 'ACTIVE'\r\n        }\r\n      }),\r\n      \r\n      // Revenus totaux\r\n      prisma.creditTransaction.aggregate({\r\n        where: { \r\n          organizationId,\r\n          type: 'SALE'\r\n        },\r\n        _sum: { amount: true }\r\n      }),\r\n      \r\n      // Score IA moyen\r\n      prisma.lead.aggregate({\r\n        where: { \r\n          organizationId,\r\n          aiScore: { not: null }\r\n        },\r\n        _avg: { aiScore: true }\r\n      }),\r\n      \r\n      // Funnel de conversion\r\n      prisma.lead.groupBy({\r\n        by: ['status'],\r\n        where: { organizationId },\r\n        _count: true\r\n      })\r\n    ]);\r\n\r\n    // \u00C9volution journali\u00E8re des leads sur la p\u00E9riode\r\n    const dailyLeads = await prisma.$queryRaw`\r\n      SELECT \r\n        DATE(created_at) as date,\r\n        COUNT(*) as count\r\n      FROM \"Lead\" \r\n      WHERE organization_id = ${organizationId}\r\n        AND created_at >= ${startDate}\r\n      GROUP BY DATE(created_at)\r\n      ORDER BY date ASC\r\n    `;\r\n\r\n    // Top 5 des campagnes par performance\r\n    const topCampaigns = await prisma.campaign.findMany({\r\n      where: { organizationId },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        type: true,\r\n        _count: {\r\n          select: { leads: true }\r\n        }\r\n      },\r\n      orderBy: {\r\n        leads: { _count: 'desc' }\r\n      },\r\n      take: 5\r\n    });\r\n\r\n    // R\u00E9partition par source de leads\r\n    const leadsSources = await prisma.lead.groupBy({\r\n      by: ['source'],\r\n      where: { \r\n        organizationId,\r\n        createdAt: { gte: startDate }\r\n      },\r\n      _count: true\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        period: parseInt(period as string),\r\n        metrics: {\r\n          totalLeads,\r\n          periodLeads,\r\n          activeCampaigns,\r\n          totalRevenue: totalRevenue._sum.amount || 0,\r\n          averageAiScore: Math.round((averageAiScore._avg.aiScore || 0) * 100) / 100\r\n        },\r\n        conversionFunnel: conversionFunnel.map(item => ({\r\n          status: item.status,\r\n          count: item._count\r\n        })),\r\n        dailyLeads,\r\n        topCampaigns: topCampaigns.map(campaign => ({\r\n          ...campaign,\r\n          leadsCount: campaign._count.leads\r\n        })),\r\n        leadsSources: leadsSources.map(source => ({\r\n          source: source.source,\r\n          count: source._count\r\n        }))\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [CAMPAIGN-ANALYTICS] Erreur dashboard:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration du dashboard analytics' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCC8 GET /api/campaign-analytics/campaign/:id - Analytics d'une campagne sp\u00E9cifique\r\nrouter.get('/campaign/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const { period = '30' } = req.query;\r\n    \r\n    // Calcul de la p\u00E9riode\r\n    const startDate = new Date();\r\n    startDate.setDate(startDate.getDate() - parseInt(period as string));\r\n\r\n    // V\u00E9rifier que la campagne appartient \u00E0 l'organisation\r\n    const campaign = await prisma.campaign.findFirst({\r\n      where: {\r\n        id,\r\n        organizationId\r\n      },\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            leads: true,\r\n            publicForms: true,\r\n            landingPages: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!campaign) {\r\n      return res.status(404).json({ \r\n        success: false, \r\n        message: 'Campagne non trouv\u00E9e' \r\n      });\r\n    }\r\n\r\n    // M\u00E9triques de la campagne en parall\u00E8le\r\n    const [\r\n      periodLeads,\r\n      leadsRevenue,\r\n      averageAiScore,\r\n      statusBreakdown,\r\n      sourceBreakdown,\r\n      regionBreakdown\r\n    ] = await Promise.all([\r\n      // Leads de la p\u00E9riode\r\n      prisma.lead.count({\r\n        where: { \r\n          campaignId: id,\r\n          createdAt: { gte: startDate }\r\n        }\r\n      }),\r\n      \r\n      // Revenus g\u00E9n\u00E9r\u00E9s par les leads de cette campagne\r\n      prisma.leadMarketplace.aggregate({\r\n        where: { \r\n          campaignId: id,\r\n          status: 'SOLD'\r\n        },\r\n        _sum: { marketplacePrice: true }\r\n      }),\r\n      \r\n      // Score IA moyen\r\n      prisma.lead.aggregate({\r\n        where: { \r\n          campaignId: id,\r\n          aiScore: { not: null }\r\n        },\r\n        _avg: { aiScore: true }\r\n      }),\r\n      \r\n      // R\u00E9partition par statut\r\n      prisma.lead.groupBy({\r\n        by: ['status'],\r\n        where: { campaignId: id },\r\n        _count: true\r\n      }),\r\n      \r\n      // R\u00E9partition par source\r\n      prisma.lead.groupBy({\r\n        by: ['source'],\r\n        where: { campaignId: id },\r\n        _count: true\r\n      }),\r\n      \r\n      // R\u00E9partition par r\u00E9gion\r\n      prisma.lead.groupBy({\r\n        by: ['region'],\r\n        where: { \r\n          campaignId: id,\r\n          region: { not: null }\r\n        },\r\n        _count: true\r\n      })\r\n    ]);\r\n\r\n    // \u00C9volution quotidienne des leads pour cette campagne\r\n    const dailyLeadsEvolution = await prisma.$queryRaw`\r\n      SELECT \r\n        DATE(created_at) as date,\r\n        COUNT(*) as count,\r\n        AVG(ai_score) as avg_score\r\n      FROM \"Lead\" \r\n      WHERE campaign_id = ${id}\r\n        AND created_at >= ${startDate}\r\n      GROUP BY DATE(created_at)\r\n      ORDER BY date ASC\r\n    `;\r\n\r\n    // Performance des formulaires publics li\u00E9s\r\n    const formsPerformance = await prisma.publicForm.findMany({\r\n      where: { campaignId: id },\r\n      select: {\r\n        id: true,\r\n        title: true,\r\n        submissionsCount: true,\r\n        isActive: true,\r\n        _count: {\r\n          select: { leads: true }\r\n        }\r\n      }\r\n    });\r\n\r\n    // Performance des landing pages li\u00E9es\r\n    const landingPagesPerformance = await prisma.landingPage.findMany({\r\n      where: { campaignId: id },\r\n      select: {\r\n        id: true,\r\n        title: true,\r\n        slug: true,\r\n        viewsCount: true,\r\n        clicksCount: true,\r\n        conversionsCount: true,\r\n        isPublished: true\r\n      }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        campaign: {\r\n          ...campaign,\r\n          totalLeads: campaign._count.leads,\r\n          totalForms: campaign._count.publicForms,\r\n          totalLandingPages: campaign._count.landingPages\r\n        },\r\n        period: parseInt(period as string),\r\n        metrics: {\r\n          periodLeads,\r\n          leadsRevenue: leadsRevenue._sum.marketplacePrice || 0,\r\n          averageAiScore: Math.round((averageAiScore._avg.aiScore || 0) * 100) / 100,\r\n          costPerLead: campaign.budget && campaign._count.leads > 0 \r\n            ? Math.round((campaign.budget / campaign._count.leads) * 100) / 100 \r\n            : 0\r\n        },\r\n        breakdowns: {\r\n          status: statusBreakdown.map(item => ({\r\n            status: item.status,\r\n            count: item._count\r\n          })),\r\n          source: sourceBreakdown.map(item => ({\r\n            source: item.source,\r\n            count: item._count\r\n          })),\r\n          region: regionBreakdown.map(item => ({\r\n            region: item.region,\r\n            count: item._count\r\n          }))\r\n        },\r\n        dailyEvolution: dailyLeadsEvolution,\r\n        formsPerformance: formsPerformance.map(form => ({\r\n          ...form,\r\n          conversionRate: form.submissionsCount > 0 \r\n            ? Math.round((form._count.leads / form.submissionsCount) * 100 * 100) / 100\r\n            : 0\r\n        })),\r\n        landingPagesPerformance: landingPagesPerformance.map(page => ({\r\n          ...page,\r\n          conversionRate: page.viewsCount > 0 \r\n            ? Math.round((page.conversionsCount / page.viewsCount) * 100 * 100) / 100\r\n            : 0,\r\n          clickThroughRate: page.viewsCount > 0 \r\n            ? Math.round((page.clicksCount / page.viewsCount) * 100 * 100) / 100\r\n            : 0\r\n        }))\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [CAMPAIGN-ANALYTICS] Erreur campagne:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des analytics de campagne' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83E\uDD16 GET /api/campaign-analytics/ai-insights - Insights IA\r\nrouter.get('/ai-insights', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer les recommandations IA r\u00E9centes\r\n    const aiRecommendations = await prisma.aiRecommendation.findMany({\r\n      where: {\r\n        lead: {\r\n          organizationId\r\n        }\r\n      },\r\n      include: {\r\n        lead: {\r\n          select: {\r\n            firstName: true,\r\n            lastName: true,\r\n            company: true,\r\n            aiScore: true\r\n          }\r\n        }\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc'\r\n      },\r\n      take: 20\r\n    });\r\n\r\n    // Distribution des scores IA\r\n    const scoreDistribution = await prisma.$queryRaw`\r\n      SELECT \r\n        CASE \r\n          WHEN ai_score >= 90 THEN 'Excellent (90-100)'\r\n          WHEN ai_score >= 80 THEN 'Tr\u00E8s bon (80-89)'\r\n          WHEN ai_score >= 70 THEN 'Bon (70-79)'\r\n          WHEN ai_score >= 60 THEN 'Moyen (60-69)'\r\n          ELSE 'Faible (0-59)'\r\n        END as score_range,\r\n        COUNT(*) as count\r\n      FROM \"Lead\" \r\n      WHERE organization_id = ${organizationId}\r\n        AND ai_score IS NOT NULL\r\n      GROUP BY score_range\r\n      ORDER BY MIN(ai_score) DESC\r\n    `;\r\n\r\n    // Tendances des scores par campagne\r\n    const campaignScores = await prisma.campaign.findMany({\r\n      where: { organizationId },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        leads: {\r\n          select: {\r\n            aiScore: true\r\n          },\r\n          where: {\r\n            aiScore: { not: null }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    const campaignScoresAnalysis = campaignScores.map(campaign => {\r\n      const scores = campaign.leads.map(lead => lead.aiScore).filter(Boolean) as number[];\r\n      return {\r\n        campaignId: campaign.id,\r\n        campaignName: campaign.name,\r\n        averageScore: scores.length > 0 \r\n          ? Math.round((scores.reduce((a, b) => a + b, 0) / scores.length) * 100) / 100\r\n          : 0,\r\n        leadsCount: scores.length,\r\n        scoreRange: {\r\n          min: Math.min(...scores),\r\n          max: Math.max(...scores)\r\n        }\r\n      };\r\n    }).filter(campaign => campaign.leadsCount > 0);\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        aiRecommendations,\r\n        scoreDistribution,\r\n        campaignScoresAnalysis,\r\n        insights: [\r\n          // G\u00E9n\u00E9ration d'insights automatiques bas\u00E9s sur les donn\u00E9es\r\n          ...(aiRecommendations.length > 0 ? [{\r\n            type: 'recommendation',\r\n            title: 'Nouvelles recommandations IA',\r\n            description: `${aiRecommendations.length} nouvelles recommandations disponibles`,\r\n            actionable: true\r\n          }] : []),\r\n          \r\n          ...(campaignScoresAnalysis.length > 0 ? [{\r\n            type: 'performance',\r\n            title: 'Meilleure campagne par score IA',\r\n            description: `La campagne \"${campaignScoresAnalysis.sort((a, b) => b.averageScore - a.averageScore)[0].campaignName}\" a le meilleur score moyen (${campaignScoresAnalysis[0].averageScore})`,\r\n            actionable: false\r\n          }] : [])\r\n        ]\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [CAMPAIGN-ANALYTICS] Erreur AI insights:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de la r\u00E9cup\u00E9ration des insights IA' \r\n    });\r\n  }\r\n});\r\n\r\n// \uD83D\uDCCA GET /api/campaign-analytics/export - Export des donn\u00E9es\r\nrouter.get('/export', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({ \r\n        success: false, \r\n        message: 'Organization ID manquant' \r\n      });\r\n    }\r\n\r\n    const { \r\n      format = 'json',\r\n      campaignId,\r\n      startDate,\r\n      endDate\r\n    } = req.query;\r\n\r\n    // Construction du filtre WHERE\r\n    const where: { [key: string]: unknown } = { organizationId };\r\n    \r\n    if (campaignId) {\r\n      where.campaignId = campaignId;\r\n    }\r\n    \r\n    if (startDate || endDate) {\r\n      where.createdAt = {};\r\n      if (startDate) where.createdAt.gte = new Date(startDate as string);\r\n      if (endDate) where.createdAt.lte = new Date(endDate as string);\r\n    }\r\n\r\n    const leads = await prisma.lead.findMany({\r\n      where,\r\n      include: {\r\n        campaign: {\r\n          select: {\r\n            name: true,\r\n            type: true\r\n          }\r\n        },\r\n        LeadMarketplace: {\r\n          select: {\r\n            marketplacePrice: true,\r\n            marketplaceVisible: true,\r\n            status: true\r\n          }\r\n        },\r\n        aiRecommendations: {\r\n          select: {\r\n            score: true,\r\n            recommendation: true,\r\n            createdAt: true\r\n          },\r\n          orderBy: {\r\n            createdAt: 'desc'\r\n          },\r\n          take: 1\r\n        }\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc'\r\n      }\r\n    });\r\n\r\n    if (format === 'csv') {\r\n      // TODO: Impl\u00E9menter export CSV si n\u00E9cessaire\r\n      res.setHeader('Content-Type', 'text/csv');\r\n      res.setHeader('Content-Disposition', 'attachment; filename=\"leads-export.csv\"');\r\n      res.send('CSV export \u00E0 impl\u00E9menter');\r\n    } else {\r\n      res.json({\r\n        success: true,\r\n        data: {\r\n          exportDate: new Date().toISOString(),\r\n          filters: { campaignId, startDate, endDate },\r\n          totalRecords: leads.length,\r\n          leads\r\n        }\r\n      });\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [CAMPAIGN-ANALYTICS] Erreur export:', error);\r\n    res.status(500).json({ \r\n      success: false, \r\n      message: 'Erreur lors de l\\'export des donn\u00E9es' \r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83C\uDFAF DEVIS1MINUTE - Routes Dispatch (r\u00E8gles d'orientation)\r\nimport { Router } from 'express';\r\nimport rateLimit from 'express-rate-limit';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \uD83D\uDD12 RATE LIMITING\r\nconst dispatchRateLimit = rateLimit({\r\n  windowMs: 60 * 1000,\r\n  max: 60,\r\n  message: { success: false, message: 'Trop de requ\u00EAtes dispatch' }\r\n});\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(dispatchRateLimit);\r\n\r\n// \uD83D\uDCCB GET /api/dispatch/rules - Liste des r\u00E8gles (AutomationRule)\r\nrouter.get('/rules', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const rules = await prisma.automationRule.findMany({\r\n      where: { organizationId },\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    res.json({ success: true, data: rules });\r\n  } catch (error) {\r\n    console.error('\u274C [DISPATCH] Erreur liste:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration des r\u00E8gles' });\r\n  }\r\n});\r\n\r\n// \u2795 POST /api/dispatch/rules - Cr\u00E9er une r\u00E8gle\r\nrouter.post('/rules', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const { event, action, params, active = true } = req.body as { event?: string; action?: string; params?: unknown; active?: boolean };\r\n    if (!event || !action) return res.status(400).json({ success: false, message: 'event et action sont requis' });\r\n\r\n    const created = await prisma.automationRule.create({ data: { organizationId, event, action, params: params ?? {}, active: !!active } });\r\n    res.json({ success: true, data: created, message: 'R\u00E8gle cr\u00E9\u00E9e' });\r\n  } catch (error) {\r\n    console.error('\u274C [DISPATCH] Erreur cr\u00E9ation:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la cr\u00E9ation de la r\u00E8gle' });\r\n  }\r\n});\r\n\r\n// \u270F\uFE0F PUT /api/dispatch/rules/:id - Modifier une r\u00E8gle\r\nrouter.put('/rules/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const existing = await prisma.automationRule.findFirst({ where: { id, organizationId } });\r\n    if (!existing) return res.status(404).json({ success: false, message: 'R\u00E8gle non trouv\u00E9e' });\r\n\r\n    const { event, action, params, active } = req.body as { event?: string; action?: string; params?: unknown; active?: boolean };\r\n    const updated = await prisma.automationRule.update({ where: { id }, data: { event, action, params, active } });\r\n    res.json({ success: true, data: updated, message: 'R\u00E8gle mise \u00E0 jour' });\r\n  } catch (error) {\r\n    console.error('\u274C [DISPATCH] Erreur mise \u00E0 jour:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la mise \u00E0 jour de la r\u00E8gle' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDDD1\uFE0F DELETE /api/dispatch/rules/:id - Supprimer une r\u00E8gle\r\nrouter.delete('/rules/:id', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const deleted = await prisma.automationRule.deleteMany({ where: { id, organizationId } });\r\n    if (!deleted.count) return res.status(404).json({ success: false, message: 'R\u00E8gle non trouv\u00E9e' });\r\n    res.json({ success: true, message: 'R\u00E8gle supprim\u00E9e' });\r\n  } catch (error) {\r\n    console.error('\u274C [DISPATCH] Erreur suppression:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la suppression de la r\u00E8gle' });\r\n  }\r\n});\r\n\r\n// \uD83E\uDDEA POST /api/dispatch/simulate - Simuler une orientation simple\r\nrouter.post('/simulate', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    const { lead } = req.body as { lead?: Record<string, unknown> };\r\n    if (!lead) return res.status(400).json({ success: false, message: 'lead requis' });\r\n\r\n    const rules = await prisma.automationRule.findMany({ where: { organizationId, active: true }, orderBy: { createdAt: 'asc' } });\r\n\r\n    // Matching na\u00EFf: si params.conditions est un objet { key: value }, on v\u00E9rifie l'\u00E9galit\u00E9\r\n    const matches: Array<{ ruleId: string; action: string; score: number }> = [];\r\n    for (const r of rules) {\r\n      const params = (r.params as unknown) || {};\r\n      const conds = params.conditions && typeof params.conditions === 'object' ? params.conditions as Record<string, unknown> : {};\r\n      let score = 0;\r\n      let total = 0;\r\n      for (const [k, v] of Object.entries(conds)) {\r\n        total++;\r\n        if ((lead as Record<string, unknown>)[k] === v) score++;\r\n      }\r\n      const ratio = total > 0 ? score / total : 0;\r\n      if (total === 0 || ratio >= 0.75) {\r\n        matches.push({ ruleId: r.id, action: r.action, score: Math.round(ratio * 100) });\r\n      }\r\n    }\r\n\r\n    res.json({ success: true, data: { matches } });\r\n  } catch (error) {\r\n    console.error('\u274C [DISPATCH] Erreur simulate:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la simulation' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// \uD83D\uDD0C DEVIS1MINUTE - \u00C9tat des int\u00E9grations (agr\u00E9gateur)\r\nimport { Router } from 'express';\r\nimport { randomUUID } from 'crypto';\r\nimport rateLimit from 'express-rate-limit';\r\nimport { PrismaClient, type Prisma } from '@prisma/client';\r\nimport { authMiddleware, type AuthenticatedRequest } from '../middlewares/auth.js';\r\nimport { requireRole } from '../middlewares/requireRole.js';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\nconst rl = rateLimit({ windowMs: 60 * 1000, max: 60 });\r\n\r\nrouter.use(authMiddleware);\r\nrouter.use(rl);\r\n\r\n// \uD83D\uDCCA GET /api/integrations/status - Synth\u00E8se des connecteurs/org\r\nrouter.get('/status', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const [google, telnyx, adPlatforms] = await Promise.all([\r\n      prisma.googleWorkspaceConfig.findUnique({ where: { organizationId } }),\r\n      prisma.telnyxConnection.findMany({ where: { organizationId } }),\r\n      prisma.adPlatformIntegration.findMany({ where: { organizationId } })\r\n    ]);\r\n\r\n    const status = {\r\n      google: {\r\n        enabled: !!google?.enabled || !!google?.isActive,\r\n        gmail: !!google?.gmailEnabled,\r\n        calendar: !!google?.calendarEnabled,\r\n        drive: !!google?.driveEnabled,\r\n        meet: !!google?.meetEnabled,\r\n        sheets: !!google?.sheetsEnabled,\r\n        voice: !!google?.voiceEnabled,\r\n        lastSync: google?.updatedAt ?? null\r\n      },\r\n      telnyx: {\r\n        connections: telnyx.map(t => ({ id: t.id, name: t.name, status: t.status, type: t.type })),\r\n        active: telnyx.some(t => t.status === 'active')\r\n      },\r\n  adPlatforms: adPlatforms.map(p => ({ id: p.id, platform: p.platform, name: p.name, status: p.status, lastSync: p.lastSync })),\r\n    };\r\n\r\n    res.json({ success: true, data: status });\r\n  } catch (error) {\r\n    console.error('\u274C [INTEGRATIONS] Erreur status:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la r\u00E9cup\u00E9ration du statut des int\u00E9grations' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDD0C POST /api/integrations/ad-platform/connect - Connecter une plateforme Ads (Google/Meta)\r\nrouter.post('/ad-platform/connect', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n\r\n    const { platform, name, credentials, config } = req.body as {\r\n      platform: string;\r\n      name?: string;\r\n      credentials?: Prisma.InputJsonValue;\r\n      config?: Prisma.InputJsonValue;\r\n    };\r\n    if (!platform) return res.status(400).json({ success: false, message: 'Param\u00E8tre platform requis' });\r\n\r\n    const existing = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform } });\r\n    let rec;\r\n    if (existing) {\r\n      rec = await prisma.adPlatformIntegration.update({\r\n        where: { id: existing.id },\r\n        data: {\r\n          name: name ?? existing.name,\r\n          credentials: credentials ?? (existing.credentials as Prisma.InputJsonValue) ?? Prisma.JsonNull,\r\n          config: config ?? (existing.config as Prisma.InputJsonValue) ?? Prisma.JsonNull,\r\n          status: 'connected',\r\n          active: true,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    } else {\r\n      rec = await prisma.adPlatformIntegration.create({\r\n        data: {\r\n          id: randomUUID(),\r\n          organizationId,\r\n          platform,\r\n          name: name || platform,\r\n          credentials: credentials ?? Prisma.JsonNull,\r\n          config: config ?? Prisma.JsonNull,\r\n          status: 'connected',\r\n          active: true,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n    }\r\n    res.json({ success: true, data: { id: rec.id } });\r\n  } catch (error) {\r\n    console.error('\u274C [INTEGRATIONS] Erreur connect:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur connexion plateforme' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDD0C POST /api/integrations/ad-platform/disconnect - D\u00E9connecter une plateforme Ads\r\nrouter.post('/ad-platform/disconnect', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    const { platform } = req.body as { platform: string };\r\n    if (!platform) return res.status(400).json({ success: false, message: 'Param\u00E8tre platform requis' });\r\n\r\n    const existing = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform } });\r\n    if (!existing) return res.status(404).json({ success: false, message: 'Int\u00E9gration non trouv\u00E9e' });\r\n\r\n    await prisma.adPlatformIntegration.update({\r\n      where: { id: existing.id },\r\n      data: { status: 'disconnected', active: false, updatedAt: new Date() }\r\n    });\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C [INTEGRATIONS] Erreur disconnect:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur d\u00E9connexion plateforme' });\r\n  }\r\n});\r\n\r\n// \uD83D\uDD04 POST /api/integrations/ad-platform/sync - Marquer une sync (placeholder, sans appels externes)\r\nrouter.post('/ad-platform/sync', requireRole(['admin', 'super_admin']), async (req: AuthenticatedRequest, res) => {\r\n  try {\r\n    const organizationId = req.user?.organizationId;\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organization ID manquant' });\r\n    const { platform } = req.body as { platform: string };\r\n    if (!platform) return res.status(400).json({ success: false, message: 'Param\u00E8tre platform requis' });\r\n\r\n    const existing = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform } });\r\n    if (!existing) return res.status(404).json({ success: false, message: 'Int\u00E9gration non trouv\u00E9e' });\r\n\r\n    const rec = await prisma.adPlatformIntegration.update({ where: { id: existing.id }, data: { lastSync: new Date(), updatedAt: new Date() } });\r\n    res.json({ success: true, data: { id: rec.id, lastSync: rec.lastSync } });\r\n  } catch (error) {\r\n    console.error('\u274C [INTEGRATIONS] Erreur sync:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur lors de la synchronisation' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router, Request, Response } from \"express\";\r\nimport { authMiddleware, AuthenticatedRequest } from \"../middlewares/auth\";\r\nimport { impersonationMiddleware } from \"../middlewares/impersonation\";\r\nimport { PrismaClient, AdPlatformIntegration, Prisma } from '@prisma/client';\r\nimport axios from 'axios';\r\nimport { google } from 'googleapis';\r\nimport { randomUUID, createHash } from 'crypto';\r\n\r\nimport { googleOAuthConfig } from '../auth/googleConfig';\r\n\r\nconst prisma = new PrismaClient();\r\nconst router = Router();\r\n\r\n// Cache en m\u00E9moire (l\u00E9ger) pour \u00E9viter des rafales d'appels c\u00F4t\u00E9 UI et vers Google Ads\r\n// Cl\u00E9: string -> Valeur: { expiresAt: number; payload: unknown }\r\nconst memCache = new Map<string, { expiresAt: number; payload: unknown }>();\r\nfunction cacheGet<T = unknown>(key: string): T | undefined {\r\n  const it = memCache.get(key);\r\n  if (!it) return undefined;\r\n  if (Date.now() > it.expiresAt) {\r\n    memCache.delete(key);\r\n    return undefined;\r\n  }\r\n  return it.payload as T;\r\n}\r\nfunction cacheSet(key: string, payload: unknown, ttlMs: number) {\r\n  memCache.set(key, { expiresAt: Date.now() + ttlMs, payload });\r\n}\r\n\r\n// Utilitaire: s\u00E9curiser/normaliser le redirectUri provenant des variables d'environnement\r\nconst DEFAULT_ADS_REDIRECT = (() => {\r\n  const explicit = process.env.GOOGLE_ADS_REDIRECT_URI || googleOAuthConfig.redirectUri;\r\n  if (explicit && explicit.trim().length > 0) return explicit.trim();\r\n  return googleOAuthConfig.redirectUri;\r\n})();\r\nfunction sanitizeRedirectUri(raw?: string): { uri: string; raw?: string; sanitized: boolean; warning?: string } {\r\n  if (!raw) return { uri: DEFAULT_ADS_REDIRECT, sanitized: false };\r\n  const original = raw;\r\n  let val = raw.trim();\r\n  // Retirer guillemets d'encadrement\r\n  val = val.replace(/^['\"]/g, '').replace(/['\"]$/g, '');\r\n  // Extraire la premi\u00E8re sous-cha\u00EEne http(s)://... si du bruit est pr\u00E9sent autour\r\n  const match = val.match(/https?:\\/\\/[^\\s\"']+/);\r\n  if (match) {\r\n    val = match[0];\r\n  }\r\n  try {\r\n    // Valider via URL; si invalide: fallback\r\n    const u = new URL(val);\r\n    if (!/^https?:$/.test(u.protocol)) throw new Error('Unsupported protocol');\r\n    return { uri: u.toString(), raw: original, sanitized: val !== original, warning: val !== original ? 'Redirect URI corrig\u00E9 depuis la variable d\\'environnement (guillemets/texte parasite retir\u00E9s)' : undefined };\r\n  } catch {\r\n    return { uri: DEFAULT_ADS_REDIRECT, raw: original, sanitized: true, warning: 'Redirect URI invalide d\u00E9tect\u00E9 dans GOOGLE_ADS_REDIRECT_URI \u2014 fallback appliqu\u00E9' };\r\n  }\r\n}\r\n\r\n// Utilitaire: nettoyer client_id / client_secret (espaces/guillemets parasites)\r\nfunction sanitizeClientValue(raw?: string): { value: string | undefined; sanitized: boolean; warning?: string; looksQuoted?: boolean } {\r\n  if (!raw) return { value: undefined, sanitized: false };\r\n  const original = raw;\r\n  let v = raw.trim();\r\n  const looksQuoted = /^['\"].*['\"]$/.test(v);\r\n  if (looksQuoted) {\r\n    v = v.replace(/^['\"]/, '').replace(/['\"]$/, '');\r\n  }\r\n  const sanitized = v !== original;\r\n  const warning = sanitized ? 'Credential nettoy\u00E9 (espaces/guillemets retir\u00E9s) \u2014 v\u00E9rifiez votre .env' : undefined;\r\n  return { value: v, sanitized, warning, looksQuoted };\r\n}\r\n\r\n// Utilitaire: fingerprint non r\u00E9versible pour v\u00E9rifier quel secret est charg\u00E9 sans l'exposer\r\nfunction fingerprintSecret(secret?: string | null): string | null {\r\n  if (!secret) return null;\r\n  try {\r\n    const hex = createHash('sha256').update(secret).digest('hex');\r\n    return hex.slice(0, 12); // 12 hex chars (~48 bits) suffisent pour identifier sans divulguer\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction maskValue(value?: string | null, prefix = 4, suffix = 4): string | null {\r\n  if (!value) return null;\r\n  const len = value.length;\r\n  if (len <= prefix + suffix + 1) return value;\r\n  return `${value.slice(0, prefix)}\u2026${value.slice(len - suffix)}`;\r\n}\r\n\r\nfunction normalizeGoogleAdsCustomerId(raw?: string | null): string | undefined {\r\n  if (!raw) return undefined;\r\n  const digitsOnly = String(raw).replace(/[^0-9]/g, '');\r\n  if (digitsOnly.length !== 10) return undefined;\r\n  return digitsOnly;\r\n}\r\n\r\nfunction formatGoogleAdsCustomerId(raw?: string | null): string | undefined {\r\n  const normalized = normalizeGoogleAdsCustomerId(raw);\r\n  if (!normalized) return undefined;\r\n  return `${normalized.slice(0, 3)}-${normalized.slice(3, 6)}-${normalized.slice(6)}`;\r\n}\r\n\r\n// ===== ROUTES PUBLIQUES (sans authentification) =====\r\n// Callbacks OAuth - accessibles sans authentification car appel\u00E9s directement par les plateformes\r\n\r\n// Route callback Facebook standard (https://localhost/)\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  // V\u00E9rifier si c'est un callback Facebook\r\n  const { code, state } = req.query;\r\n  if (code && state) {\r\n    try {\r\n      let parsed: { platform?: string };\r\n      try {\r\n        parsed = JSON.parse(decodeURIComponent(state as string));\r\n      } catch {\r\n        const raw = Buffer.from(String(state), 'base64url').toString('utf8');\r\n        parsed = JSON.parse(raw);\r\n      }\r\n      \r\n      if (parsed.platform === 'meta_ads') {\r\n        // Rediriger vers le callback Meta Ads avec les param\u00E8tres\r\n        const redirectUrl = `/api/integrations/advertising/oauth/meta_ads/callback?code=${encodeURIComponent(code as string)}&state=${encodeURIComponent(state as string)}`;\r\n        return res.redirect(redirectUrl);\r\n      }\r\n    } catch (e) {\r\n      console.error('Erreur parsing state Facebook:', e);\r\n    }\r\n  }\r\n  \r\n  // Si pas de callback Facebook, page normale\r\n  res.send('CRM API Server - Facebook OAuth Callback Handler');\r\n});\r\n\r\n// Route callback simplifi\u00E9e pour Facebook (qui refuse les URIs complexes)\r\nrouter.get('/callback', async (req: Request, res: Response): Promise<void> => {\r\n  // Rediriger vers le callback sp\u00E9cialis\u00E9 Meta Ads\r\n  const { code, state } = req.query;\r\n  if (code && state) {\r\n    // D\u00E9terminer la plateforme depuis le state\r\n    try {\r\n      let parsed: { platform?: string };\r\n      try {\r\n        parsed = JSON.parse(decodeURIComponent(state as string));\r\n      } catch {\r\n        const raw = Buffer.from(String(state), 'base64url').toString('utf8');\r\n        parsed = JSON.parse(raw);\r\n      }\r\n      \r\n      if (parsed.platform === 'meta_ads') {\r\n        // Rediriger vers le callback Meta Ads avec les param\u00E8tres\r\n        const redirectUrl = `/api/integrations/advertising/oauth/meta_ads/callback?code=${encodeURIComponent(code as string)}&state=${encodeURIComponent(state as string)}`;\r\n        return res.redirect(redirectUrl);\r\n      }\r\n    } catch (e) {\r\n      console.error('Erreur parsing state:', e);\r\n    }\r\n  }\r\n  \r\n  res.status(400).send('Callback invalide');\r\n});\r\n\r\nrouter.get('/advertising/oauth/:platform/callback', async (req: Request, res: Response): Promise<void> => {\r\n  // Ajouter les en-t\u00EAtes pour contourner la page d'avertissement ngrok\r\n  res.setHeader('ngrok-skip-browser-warning', 'true');\r\n  res.setHeader('User-Agent', 'CRM-OAuth-Handler');\r\n  \r\n  try {\r\n    const platform = req.params.platform as 'google_ads' | 'meta_ads';\r\n    const { code, state, error } = req.query as { code?: string; state?: string; error?: string };\r\n    if (error) {\r\n      console.warn('OAuth error from provider:', error);\r\n    }\r\n    if (!code || !state) {\r\n      res.status(400).send('Missing code/state');\r\n      return;\r\n    }\r\n    // D\u00E9codage robuste du state: JSON direct puis base64url -> JSON en fallback\r\n    let parsed: { organizationId: string; userId: string };\r\n    try {\r\n      // Essai 1: JSON direct (compatibilit\u00E9 ancienne g\u00E9n\u00E9ration)\r\n      parsed = JSON.parse(decodeURIComponent(state));\r\n    } catch {\r\n      try {\r\n        // Essai 2: base64url -> JSON (nouvelle g\u00E9n\u00E9ration s\u00E9curis\u00E9e)\r\n        const raw = Buffer.from(String(state), 'base64url').toString('utf8');\r\n        parsed = JSON.parse(raw);\r\n      } catch {\r\n        res.status(400).send('Invalid state');\r\n        return;\r\n      }\r\n    }\r\n    const organizationId = parsed.organizationId;\r\n    const userId = parsed.userId;\r\n\r\n    // Upsert integration row helper\r\n    const upsertIntegration = async (data: Partial<{ name: string; credentials: unknown; config: unknown }>) => {\r\n      const existing = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform } });\r\n      if (existing) {\r\n        await prisma.adPlatformIntegration.update({ where: { id: existing.id }, data: { ...data, status: 'connected', active: true, updatedAt: new Date() } });\r\n        return existing.id;\r\n      }\r\n      const created = await prisma.adPlatformIntegration.create({\r\n        data: {\r\n          id: randomUUID(),\r\n          organizationId,\r\n          platform,\r\n          name: data.name || platform,\r\n          credentials: (data.credentials as unknown) ?? {},\r\n          config: (data.config as unknown) ?? {},\r\n          status: 'connected',\r\n          active: true,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n      return created.id;\r\n    };\r\n\r\n    if (platform === 'google_ads') {\r\n      const idSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_ID);\r\n      const secretSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_SECRET);\r\n      const clientId = idSan.value as string;\r\n      const clientSecret = secretSan.value as string;\r\n      const { uri: redirectUri } = sanitizeRedirectUri(process.env.GOOGLE_ADS_REDIRECT_URI);\r\n      if (!clientId || !clientSecret) {\r\n        await upsertIntegration({ name: 'Google Ads (OAuth pending)', credentials: { authCode: code, error: 'missing_client_creds', userId } });\r\n      } else {\r\n        try {\r\n          const oauth2 = new google.auth.OAuth2(clientId, clientSecret, redirectUri);\r\n          const { tokens } = await oauth2.getToken(code);\r\n          console.log('\u2705 Google Ads OAuth tokens received successfully');\r\n          await upsertIntegration({ name: 'Google Ads OAuth', credentials: { tokens, userId } });\r\n        } catch (e: unknown) {\r\n          const idSanMasked = clientId ? (clientId.length > 8 ? clientId.slice(0,4) + '...' + clientId.slice(-4) : 'defined') : 'MISSING';\r\n          const secretFp = fingerprintSecret(clientSecret);\r\n          console.error(`Google Ads token exchange failed (clientId=${idSanMasked}, secretFp=${secretFp ?? 'null'}):`, e);\r\n          const errorMsg = (e as Error).message || (e as { code?: string }).code || 'unknown_error';\r\n          let userFriendlyError = 'Erreur d\\'authentification';\r\n          \r\n          if (errorMsg.includes('invalid_client')) {\r\n            userFriendlyError = 'Client OAuth non autoris\u00E9 pour Google Ads API';\r\n          } else if (errorMsg.includes('invalid_scope')) {\r\n            userFriendlyError = 'Scope Google Ads non activ\u00E9';\r\n          }\r\n          \r\n          await upsertIntegration({ \r\n            name: `Google Ads (${userFriendlyError})`, \r\n            credentials: { authCode: code, error: errorMsg, userError: userFriendlyError, userId } \r\n          });\r\n        }\r\n      }\r\n    } else if (platform === 'meta_ads') {\r\n      const appId = process.env.META_APP_ID as string;\r\n      const appSecret = process.env.META_APP_SECRET as string;\r\n      const redirectUri = process.env.META_REDIRECT_URI || 'https://localhost:3000/';\r\n      if (!appId || !appSecret) {\r\n        await upsertIntegration({ name: 'Meta Ads (OAuth pending)', credentials: { authCode: code, error: 'missing_app_creds', userId } });\r\n      } else {\r\n        try {\r\n          const tokenRes = await axios.get('https://graph.facebook.com/v18.0/oauth/access_token', {\r\n            params: { client_id: appId, redirect_uri: redirectUri, client_secret: appSecret, code }\r\n          });\r\n          const accessToken = tokenRes.data?.access_token;\r\n          let longLived = accessToken;\r\n          try {\r\n            const ll = await axios.get('https://graph.facebook.com/v18.0/oauth/access_token', {\r\n              params: { grant_type: 'fb_exchange_token', client_id: appId, client_secret: appSecret, fb_exchange_token: accessToken }\r\n            });\r\n            longLived = ll.data?.access_token || accessToken;\r\n          } catch {\r\n            // ignore, keep short token\r\n          }\r\n          await upsertIntegration({ name: 'Meta Ads OAuth', credentials: { accessToken: longLived, userId } });\r\n        } catch (e) {\r\n          console.error('Meta token exchange failed:', e);\r\n          await upsertIntegration({ name: 'Meta Ads (OAuth error)', credentials: { authCode: code, error: 'token_exchange_failed', userId } });\r\n        }\r\n      }\r\n    } else {\r\n      res.status(400).send('Unsupported platform');\r\n      return;\r\n    }\r\n\r\n    // Simple page to close popup and notify opener\r\n    res.setHeader('Content-Type', 'text/html; charset=utf-8');\r\n    res.send(`<!doctype html><html><body style=\"font-family:sans-serif; padding:16px\">\\\r\n      <p>Authentification ${platform} termin\u00E9e. Vous pouvez fermer cette fen\u00EAtre.</p>\\\r\n      <script src=\"/api/integrations/advertising/oauth/callback-close.js?platform=${encodeURIComponent(platform)}\"></script>\\\r\n    </body></html>`);\r\n  } catch (error) {\r\n    console.error('Erreur oauth callback:', error);\r\n    res.status(500).send('OAuth callback error');\r\n  }\r\n});\r\n\r\n// Sert un script JS externe qui notifie l'onglet parent et tente de fermer le popup (meilleure compatibilit\u00E9 CSP)\r\nrouter.get('/advertising/oauth/callback-close.js', (req: Request, res: Response): void => {\r\n  const platform = (req.query.platform as string) || 'google_ads';\r\n  const js = `(() => {\\n  const payload = { type: 'ads_oauth_done', platform: ${JSON.stringify(platform)}, ts: Date.now() };\\n  const notify = () => { try { window.opener && window.opener.postMessage(payload, '*'); } catch (e) {} };\\n  // Notifier plusieurs fois\\n  notify();\\n  let n = 0;\\n  const t1 = setInterval(() => { n++; notify(); if (n > 10) clearInterval(t1); }, 250);\\n  // Fermer \u00E0 r\u00E9p\u00E9tition\\n  let c = 0;\\n  const t2 = setInterval(() => {\\n    c++;\\n    try { window.close(); } catch (e) {}\\n    try { window.open('', '_self'); window.close(); } catch (e) {}\\n    if (c > 20 || window.closed) clearInterval(t2);\\n  }, 300);\\n  // S\u00E9curit\u00E9: arr\u00EAt des timers\\n  setTimeout(() => { try { clearInterval(t1); clearInterval(t2); } catch (e) {} }, 8000);\\n})();`;\r\n  res.setHeader('Content-Type', 'application/javascript; charset=utf-8');\r\n  res.send(js);\r\n});\r\n\r\n// ===== ROUTES AUTHENTIFI\u00C9ES =====\r\n// Toutes les autres routes n\u00E9cessitent une authentification\r\nrouter.use(authMiddleware, impersonationMiddleware);\r\nconst getEffectiveOrgId = (req: Request): string | undefined => {\r\n  // 1) Header (source standard via useAuthenticatedApi)\r\n  const headerOrgId = req.headers['x-organization-id'];\r\n  if (typeof headerOrgId === 'string' && headerOrgId !== 'all') return headerOrgId;\r\n  // 2) Query param (utile pour tests directs dans le navigateur)\r\n  const qOrg = (req.query.organizationId || req.query.orgId) as string | undefined;\r\n  if (qOrg && qOrg !== 'all') return qOrg;\r\n  // 3) Fallback utilisateur (pour utilisateurs non super-admin)\r\n  const user = (req as AuthenticatedRequest).user;\r\n  return user?.organizationId;\r\n};\r\n\r\n// GET all integrations for the selected organization\r\nrouter.get('/', async (req: Request, res: Response): Promise<void> => {\r\n  const user = (req as AuthenticatedRequest).user;\r\n  const organizationId = getEffectiveOrgId(req);\r\n\r\n  if (!user) {\r\n    res.status(401).json({ success: false, message: 'Unauthorized' });\r\n    return;\r\n  }\r\n  \r\n  if (!organizationId) {\r\n    // Return empty array if no specific organization is selected (e.g., \"All organizations\" view)\r\n    res.json({ success: true, data: [] });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const integrationsSettings = await prisma.integrationsSettings.findMany({\r\n      where: { organizationId: organizationId },\r\n      include: {\r\n        user: { select: { id: true, email: true, firstName: true, lastName: true } },\r\n      },\r\n    });\r\n\r\n    res.json({ success: true, data: integrationsSettings });\r\n  } catch (error) {\r\n    console.error('Failed to get integrations:', error);\r\n    res.status(500).json({ success: false, message: 'Failed to get integrations' });\r\n  }\r\n});\r\n\r\n// POST to create or update an integration\r\nrouter.post('/', async (req: Request, res: Response): Promise<void> => {\r\n  const user = (req as AuthenticatedRequest).user;\r\n  const organizationId = getEffectiveOrgId(req);\r\n  const { type, config, enabled } = req.body;\r\n\r\n  if (!user) {\r\n    res.status(401).json({ success: false, message: 'Unauthorized' });\r\n    return;\r\n  }\r\n\r\n  if (!organizationId) {\r\n    res.status(400).json({ success: false, message: 'Organization ID is required to create or update an integration.' });\r\n    return;\r\n  }\r\n\r\n  if (!type) {\r\n    res.status(400).json({ success: false, message: 'Integration type is required.' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const upsertedIntegration = await prisma.integrationsSettings.upsert({\r\n      where: {\r\n        organizationId_type: {\r\n          organizationId: organizationId,\r\n          type: type,\r\n        },\r\n      },\r\n      update: {\r\n        config,\r\n        enabled,\r\n        userId: user.id,\r\n      },\r\n      create: {\r\n        type,\r\n        config,\r\n        enabled,\r\n        organizationId: organizationId,\r\n        userId: user.id,\r\n      },\r\n    });\r\n\r\n    res.status(201).json({ success: true, data: upsertedIntegration });\r\n  } catch (error) {\r\n    console.error('Failed to upsert integration:', error);\r\n    res.status(500).json({ success: false, message: 'Failed to upsert integration' });\r\n  }\r\n});\r\n\r\n// DELETE to remove an integration by type\r\nrouter.delete('/:type', async (req: Request, res: Response): Promise<void> => {\r\n  const user = (req as AuthenticatedRequest).user;\r\n  const organizationId = getEffectiveOrgId(req);\r\n  const { type } = req.params;\r\n\r\n  if (!user) {\r\n    res.status(401).json({ success: false, message: 'Unauthorized' });\r\n    return;\r\n  }\r\n  \r\n  if (!organizationId) {\r\n    res.status(400).json({ success: false, message: 'Organization context is missing.' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await prisma.integrationsSettings.delete({\r\n      where: {\r\n        organizationId_type: {\r\n          organizationId: organizationId,\r\n          type: type,\r\n        },\r\n      },\r\n    });\r\n\r\n    res.status(200).json({ success: true, message: 'Integration deleted successfully.' });\r\n  } catch (error: unknown) {\r\n    if (error.code === 'P2025') {\r\n      res.status(404).json({ success: false, message: 'Integration not found' });\r\n      return;\r\n    }\r\n    console.error('Failed to delete integration:', error);\r\n    res.status(500).json({ success: false, message: 'Failed to delete integration' });\r\n  }\r\n});\r\n\r\n// ==================== ROUTES ARCHITECTURE SCALABLE ====================\r\n// Import des nouveaux services (ajout\u00E9 ici pour \u00E9viter les conflits)\r\nimport { AdPlatformService, AD_PLATFORMS } from '../services/adPlatformService';\r\nimport { EcommerceService, ECOMMERCE_PLATFORMS } from '../services/ecommerceService';\r\n\r\n/**\r\n * GET /api/integrations/advertising/platforms\r\n * R\u00E9cup\u00E8re la liste des plateformes publicitaires disponibles\r\n */\r\nrouter.get('/advertising/platforms', (req, res) => {\r\n  res.json({\r\n    success: true,\r\n    platforms: Object.values(AD_PLATFORMS)\r\n  });\r\n});\r\n\r\n/**\r\n * GET /api/integrations/advertising/env-check\r\n * V\u00E9rifie la pr\u00E9sence des variables d'environnement n\u00E9cessaires (Google/Meta)\r\n */\r\nrouter.get('/advertising/env-check', (_req, res) => {\r\n  const backendUrl = process.env.BACKEND_URL;\r\n\r\n  const googleClientId = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_ID);\r\n  const googleClientSecret = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_SECRET);\r\n  const googleDeveloperToken = sanitizeClientValue(process.env.GOOGLE_ADS_DEVELOPER_TOKEN);\r\n  const googleApiVersionRaw = (process.env.GOOGLE_ADS_API_VERSION || 'v18').trim();\r\n  const googleRedirect = sanitizeRedirectUri(process.env.GOOGLE_ADS_REDIRECT_URI);\r\n  const googleManagerCustomer = normalizeGoogleAdsCustomerId(process.env.GOOGLE_ADS_MANAGER_CUSTOMER_ID);\r\n  const googleLoginCustomer = normalizeGoogleAdsCustomerId(process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID);\r\n\r\n  const googleWarnings: string[] = [];\r\n  if (googleClientId.sanitized || googleClientId.looksQuoted) {\r\n    googleWarnings.push('GOOGLE_ADS_CLIENT_ID semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e.');\r\n  }\r\n  if (googleClientSecret.sanitized || googleClientSecret.looksQuoted) {\r\n    googleWarnings.push('GOOGLE_ADS_CLIENT_SECRET semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e.');\r\n  }\r\n  if (googleDeveloperToken.sanitized || googleDeveloperToken.looksQuoted) {\r\n    googleWarnings.push('GOOGLE_ADS_DEVELOPER_TOKEN semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e.');\r\n  }\r\n  if (googleRedirect.warning) {\r\n    googleWarnings.push(googleRedirect.warning);\r\n  }\r\n\r\n  const metaAppId = sanitizeClientValue(process.env.META_APP_ID);\r\n  const metaAppSecret = sanitizeClientValue(process.env.META_APP_SECRET);\r\n  const metaRedirect = sanitizeRedirectUri(process.env.META_REDIRECT_URI);\r\n\r\n  const metaWarnings: string[] = [];\r\n  if (metaAppId.sanitized || metaAppId.looksQuoted) {\r\n    metaWarnings.push('META_APP_ID semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e.');\r\n  }\r\n  if (metaAppSecret.sanitized || metaAppSecret.looksQuoted) {\r\n    metaWarnings.push('META_APP_SECRET semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e.');\r\n  }\r\n  if (metaRedirect.warning) {\r\n    metaWarnings.push(metaRedirect.warning);\r\n  }\r\n\r\n  const vars = {\r\n    BACKEND_URL: !!backendUrl,\r\n    GOOGLE_ADS_CLIENT_ID: !!googleClientId.value,\r\n    GOOGLE_ADS_CLIENT_SECRET: !!googleClientSecret.value,\r\n    GOOGLE_ADS_DEVELOPER_TOKEN: !!googleDeveloperToken.value,\r\n    META_APP_ID: !!metaAppId.value,\r\n    META_APP_SECRET: !!metaAppSecret.value,\r\n  } as const;\r\n\r\n  const missing = Object.entries(vars)\r\n    .filter(([, ok]) => !ok)\r\n    .map(([k]) => k);\r\n\r\n  const maskOrNull = (value?: string | null) => maskValue(value ?? undefined);\r\n\r\n  const details = {\r\n    backend: {\r\n      backendUrlDefined: !!backendUrl,\r\n    },\r\n    google: {\r\n      clientId: {\r\n        defined: !!googleClientId.value,\r\n        sanitized: googleClientId.sanitized,\r\n        looksQuoted: googleClientId.looksQuoted,\r\n        length: googleClientId.value?.length ?? 0,\r\n        masked: maskOrNull(googleClientId.value),\r\n      },\r\n      clientSecret: {\r\n        defined: !!googleClientSecret.value,\r\n        sanitized: googleClientSecret.sanitized,\r\n        looksQuoted: googleClientSecret.looksQuoted,\r\n        length: googleClientSecret.value?.length ?? 0,\r\n        fingerprint: fingerprintSecret(googleClientSecret.value),\r\n      },\r\n      developerToken: {\r\n        defined: !!googleDeveloperToken.value,\r\n        sanitized: googleDeveloperToken.sanitized,\r\n        looksQuoted: googleDeveloperToken.looksQuoted,\r\n        length: googleDeveloperToken.value?.length ?? 0,\r\n        fingerprint: fingerprintSecret(googleDeveloperToken.value),\r\n        masked: maskOrNull(googleDeveloperToken.value),\r\n      },\r\n      managerCustomerId: {\r\n        raw: process.env.GOOGLE_ADS_MANAGER_CUSTOMER_ID ?? null,\r\n        normalized: googleManagerCustomer ?? null,\r\n        formatted: formatGoogleAdsCustomerId(googleManagerCustomer) ?? null,\r\n      },\r\n      loginCustomerId: {\r\n        raw: process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID ?? null,\r\n        normalized: googleLoginCustomer ?? null,\r\n        formatted: formatGoogleAdsCustomerId(googleLoginCustomer) ?? null,\r\n      },\r\n      apiVersion: {\r\n        value: googleApiVersionRaw,\r\n        defaultApplied: !process.env.GOOGLE_ADS_API_VERSION,\r\n      },\r\n      redirectUri: {\r\n        value: googleRedirect.uri,\r\n        sanitized: googleRedirect.sanitized,\r\n        warning: googleRedirect.warning ?? null,\r\n      },\r\n    },\r\n    meta: {\r\n      appId: {\r\n        defined: !!metaAppId.value,\r\n        sanitized: metaAppId.sanitized,\r\n        looksQuoted: metaAppId.looksQuoted,\r\n        length: metaAppId.value?.length ?? 0,\r\n        masked: maskOrNull(metaAppId.value),\r\n      },\r\n      appSecret: {\r\n        defined: !!metaAppSecret.value,\r\n        sanitized: metaAppSecret.sanitized,\r\n        looksQuoted: metaAppSecret.looksQuoted,\r\n        length: metaAppSecret.value?.length ?? 0,\r\n        fingerprint: fingerprintSecret(metaAppSecret.value),\r\n      },\r\n      redirectUri: {\r\n        value: metaRedirect.uri,\r\n        sanitized: metaRedirect.sanitized,\r\n        warning: metaRedirect.warning ?? null,\r\n      },\r\n    },\r\n  } as const;\r\n\r\n  res.json({\r\n    success: true,\r\n    vars,\r\n    missing,\r\n    ready: missing.length === 0,\r\n    warnings: [...googleWarnings, ...metaWarnings],\r\n    details,\r\n  });\r\n});\r\n\r\n/**\r\n * GET /api/integrations/advertising\r\n * R\u00E9cup\u00E8re toutes les int\u00E9grations publicitaires de l'organisation\r\n */\r\nrouter.get('/advertising', async (req, res) => {\r\n  try {\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organisation requise' });\r\n    }\r\n\r\n    const integrations = await AdPlatformService.getIntegrations(organizationId);\r\n    res.json({\r\n      success: true,\r\n      integrations\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur r\u00E9cup\u00E9ration int\u00E9grations publicitaires:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n/**\r\n * OAuth: Obtenir l'URL d'authentification pour une plateforme publicitaire\r\n * GET /api/integrations/advertising/oauth/:platform/url\r\n */\r\nrouter.get('/advertising/oauth/:platform/url', async (req: Request, res: Response) => {\r\n  try {\r\n    const platform = req.params.platform as 'google_ads' | 'meta_ads';\r\n    const user = (req as AuthenticatedRequest).user;\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!user || !organizationId) {\r\n      return res.status(401).json({ success: false, message: 'Auth requise' });\r\n    }\r\n\r\n    const stateObj = {\r\n      platform,\r\n      organizationId,\r\n      userId: user.userId,\r\n      ts: Date.now()\r\n    };\r\n  const stateRaw = JSON.stringify(stateObj);\r\n  // Encodage base64url pour \u00E9viter tout caract\u00E8re probl\u00E9matique dans l'URL\r\n  const stateEncoded = Buffer.from(stateRaw, 'utf8').toString('base64url');\r\n\r\n    if (platform === 'google_ads') {\r\n      const idSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_ID);\r\n      const secretSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_SECRET || '');\r\n      const clientId = idSan.value;\r\n      const clientSecret = secretSan.value || '';\r\n      const { uri: redirectUri, warning } = sanitizeRedirectUri(process.env.GOOGLE_ADS_REDIRECT_URI);\r\n      if (!clientId) {\r\n        const missing = ['GOOGLE_ADS_CLIENT_ID'];\r\n  const backend = (process.env.BACKEND_URL || process.env.API_URL || '').trim() || 'http://localhost:4000';\r\n        const demoUrl = `${backend}/api/integrations/advertising/oauth/google_ads/demo?missing=${encodeURIComponent(missing.join(','))}`;\r\n        return res.json({ success: true, platform, demo: true, requiredEnv: missing, authUrl: demoUrl, message: 'Mode d\u00E9mo: variables d\\'environnement manquantes' });\r\n      }\r\n      try {\r\n        const oauth2 = new google.auth.OAuth2(clientId, clientSecret, redirectUri);\r\n        const authUrl = oauth2.generateAuthUrl({\r\n          access_type: 'offline',\r\n          prompt: 'consent',\r\n          scope: ['https://www.googleapis.com/auth/adwords'],\r\n          state: stateEncoded\r\n        });\r\n        // Log l\u00E9ger pour debug (masque le clientId)\r\n        const masked = clientId.length > 8 ? clientId.slice(0, 4) + '...' + clientId.slice(-4) : 'defined';\r\n        const warns: string[] = [];\r\n        if (warning) warns.push(warning);\r\n        if (idSan.sanitized || idSan.looksQuoted) warns.push('GOOGLE_ADS_CLIENT_ID semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n        if (secretSan.sanitized || secretSan.looksQuoted) warns.push('GOOGLE_ADS_CLIENT_SECRET semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n        console.log(`[ADS OAUTH] G\u00E9n\u00E9ration URL Google Ads OAuth | clientId=${masked} | redirectUri=${redirectUri}`);\r\n        return res.json({ success: true, platform, authUrl, warnings: warns });\r\n      } catch (err) {\r\n        console.error('Erreur g\u00E9n\u00E9ration URL OAuth Google Ads:', err);\r\n        return res.status(500).json({ success: false, message: 'Erreur g\u00E9n\u00E9ration URL OAuth (Google Ads)' });\r\n      }\r\n    }\r\n\r\n    if (platform === 'meta_ads') {\r\n  const appId = process.env.META_APP_ID;\r\n      const redirectUri = process.env.META_REDIRECT_URI || 'https://localhost:3000/';\r\n      if (!appId) {\r\n        const missing = ['META_APP_ID'];\r\n  const backend = (process.env.BACKEND_URL || process.env.API_URL || '').trim() || 'http://localhost:4000';\r\n        const demoUrl = `${backend}/api/integrations/advertising/oauth/meta_ads/demo?missing=${encodeURIComponent(missing.join(','))}`;\r\n        return res.json({ success: true, platform, demo: true, requiredEnv: missing, authUrl: demoUrl, message: 'Mode d\u00E9mo: variables d\\'environnement manquantes' });\r\n      }\r\n  // Utiliser seulement public_profile (email n\u00E9cessite approbation Facebook)\r\n  const basicScope = 'public_profile';\r\n  // Pour la publicit\u00E9 Meta : ads_read,ads_management,business_management (n\u00E9cessite approbation Facebook)\r\n  const scope = encodeURIComponent(basicScope);\r\n  \r\n  // Si utilisation de l'URI Facebook universelle, utiliser le SDK JavaScript\r\n  if (redirectUri === 'https://www.facebook.com/connect/login_success.html') {\r\n    const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${scope}&state=${encodeURIComponent(stateRaw)}&display=popup`;\r\n    return res.json({ \r\n      success: true, \r\n      platform, \r\n      authUrl,\r\n      usePopup: true,\r\n      message: 'Utilisation de l\\'URI Facebook universelle avec popup'\r\n    });\r\n  } else {\r\n    const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${scope}&state=${encodeURIComponent(stateRaw)}`;\r\n    return res.json({ success: true, platform, authUrl });\r\n  }\r\n    }\r\n\r\n    return res.status(400).json({ success: false, message: 'Plateforme non support\u00E9e' });\r\n  } catch (error) {\r\n    console.error('Erreur oauth url:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur g\u00E9n\u00E9ration URL OAuth' });\r\n  }\r\n});\r\n\r\n/**\r\n * Endpoint de debug: affiche les param\u00E8tres OAuth Google Ads calcul\u00E9s\r\n * GET /api/integrations/advertising/oauth/google_ads/debug\r\n */\r\nrouter.get('/advertising/oauth/google_ads/debug', async (req: Request, res: Response) => {\r\n  try {\r\n    const user = (req as AuthenticatedRequest).user;\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!user || !organizationId) {\r\n      return res.status(401).json({ success: false, message: 'Auth requise' });\r\n    }\r\n\r\n  const idSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_ID || '');\r\n  const secretSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_SECRET || '');\r\n  const clientId = idSan.value || '';\r\n  const clientSecret = secretSan.value || '';\r\n  const { uri: redirectUri, warning: redirectWarning } = sanitizeRedirectUri(process.env.GOOGLE_ADS_REDIRECT_URI);\r\n    const masked = clientId ? (clientId.length > 8 ? clientId.slice(0, 4) + '...' + clientId.slice(-4) : 'defined') : 'MISSING';\r\n    const warnings: string[] = [];\r\n    if (!clientId) warnings.push('GOOGLE_ADS_CLIENT_ID manquant');\r\n    if (!redirectUri) warnings.push('Redirect URI manquant');\r\n  if (redirectWarning) warnings.push(redirectWarning);\r\n  if (idSan.sanitized || idSan.looksQuoted) warnings.push('GOOGLE_ADS_CLIENT_ID semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n  if (secretSan.sanitized || secretSan.looksQuoted) warnings.push('GOOGLE_ADS_CLIENT_SECRET semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n\r\n    // Scopes\r\n    const defaultScopes = ['https://www.googleapis.com/auth/adwords'];\r\n    const testScopes = ['openid','email','profile'];\r\n\r\n    let authUrl: string | null = null;\r\n    let testAuthUrl: string | null = null;\r\n    try {\r\n      if (clientId) {\r\n        const stateRaw = JSON.stringify({ platform: 'google_ads', organizationId, userId: user.userId, ts: Date.now() });\r\n        const oauth2 = new google.auth.OAuth2(clientId, clientSecret, redirectUri);\r\n        // URL principale (Ads)\r\n        authUrl = oauth2.generateAuthUrl({ access_type: 'offline', prompt: 'consent', scope: defaultScopes, state: stateRaw });\r\n        // URL de test (scopes simples)\r\n        testAuthUrl = oauth2.generateAuthUrl({ access_type: 'offline', prompt: 'consent', scope: testScopes, state: stateRaw });\r\n      }\r\n    } catch (e) {\r\n      warnings.push('Erreur lors de la g\u00E9n\u00E9ration de l\\'URL OAuth: ' + (e as Error).message);\r\n    }\r\n\r\n    return res.json({\r\n      success: true,\r\n      platform: 'google_ads',\r\n      clientIdMasked: masked,\r\n      clientSecretFingerprint: fingerprintSecret(clientSecret),\r\n      clientSecretLength: clientSecret ? clientSecret.length : 0,\r\n      clientSecretStartsWithGOCSPX: clientSecret ? clientSecret.startsWith('GOCSPX-') : false,\r\n      redirectUri,\r\n      scope: defaultScopes,\r\n      testScopes,\r\n      organizationId,\r\n      userId: user.userId,\r\n      authUrl,\r\n      testAuthUrl,\r\n      warnings\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur debug OAuth Google Ads:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur (debug OAuth)' });\r\n  }\r\n});\r\n\r\n/**\r\n * Page d\u00E9mo quand les variables d'environnement OAuth manquent.\r\n * GET /api/integrations/advertising/oauth/:platform/demo?missing=VAR1,VAR2\r\n */\r\nrouter.get('/advertising/oauth/:platform/demo', (req: Request, res: Response) => {\r\n  const platform = req.params.platform as 'google_ads' | 'meta_ads';\r\n  const missing = String(req.query.missing || '').split(',').filter(Boolean);\r\n  const platformLabel = platform === 'google_ads' ? 'Google Ads' : platform === 'meta_ads' ? 'Meta Ads' : platform;\r\n  res.setHeader('Content-Type', 'text/html; charset=utf-8');\r\n  res.send(`<!doctype html>\r\n  <html lang=\"fr\">\r\n    <head>\r\n      <meta charset=\"utf-8\" />\r\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n      <title>Mode d\u00E9mo \u2014 OAuth non configur\u00E9</title>\r\n      <style>\r\n        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; color: #0f172a; }\r\n        .card { max-width: 720px; margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 10px 18px rgba(2,6,23,0.06); }\r\n        h1 { font-size: 20px; margin: 0 0 8px; }\r\n        .muted { color: #475569; }\r\n        code { background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }\r\n        ul { margin: 8px 0 16px 22px; }\r\n        .actions { display: flex; gap: 8px; }\r\n        button { padding: 8px 12px; border-radius: 8px; border: 1px solid #cbd5e1; background: white; cursor: pointer; }\r\n        button.primary { background: #2563eb; color: white; border-color: #2563eb; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"card\">\r\n        <h1>Mode d\u00E9mo \u2014 ${platformLabel} OAuth non configur\u00E9</h1>\r\n  <p class=\"muted\">Pour activer l'authentification ${platformLabel}, d\u00E9finissez les variables d'environnement suivantes c\u00F4t\u00E9 serveur :</p>\r\n        ${missing.length ? `<ul>${missing.map(v => `<li><code>${v}</code></li>`).join('')}</ul>` : ''}\r\n        <p class=\"muted\">Apr\u00E8s configuration, relancez l'API puis r\u00E9essayez. Cette fen\u00EAtre se fermera automatiquement.</p>\r\n        <div class=\"actions\">\r\n          <button class=\"primary\" id=\"close\">Fermer maintenant</button>\r\n        </div>\r\n      </div>\r\n      <script>\r\n        const notify = () => { try { window.opener && window.opener.postMessage({ type: 'ads_oauth_done', platform: '${platform}', demo: true }, '*'); } catch (e) {} };\r\n        document.getElementById('close').addEventListener('click', () => { notify(); window.close(); });\r\n        setTimeout(() => { notify(); window.close(); }, 1600);\r\n      </script>\r\n    </body>\r\n  </html>`);\r\n});\r\n\r\n/**\r\n * Lister les comptes accessibles pour une plateforme\r\n * GET /api/integrations/advertising/:platform/accounts\r\n */\r\nrouter.get('/advertising/:platform/accounts', async (req: Request, res: Response) => {\r\n  try {\r\n    const platform = req.params.platform as 'google_ads' | 'meta_ads';\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organisation requise' });\r\n\r\n    let integration = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform } });\r\n    \r\n    // Si pas d'int\u00E9gration, retourner un statut simple\r\n    if (!integration) {\r\n      return res.json({ success: true, platform, integration: null, accounts: [], note: 'Aucune int\u00E9gration configur\u00E9e' });\r\n    }\r\n\r\n    // Par plateforme: Google Ads \u2014 lister les comptes accessibles\r\n    if (platform === 'google_ads') {\r\n      const devTokenSan = sanitizeClientValue(process.env.GOOGLE_ADS_DEVELOPER_TOKEN || '');\r\n      const devToken = devTokenSan.value || '';\r\n      const idSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_ID || '');\r\n      const secretSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_SECRET || '');\r\n      const clientId = idSan.value || '';\r\n      const clientSecret = secretSan.value || '';\r\n      const { uri: redirectUri } = sanitizeRedirectUri(process.env.GOOGLE_ADS_REDIRECT_URI);\r\n\r\n      type GoogleOAuthTokens = {\r\n        access_token?: string;\r\n        refresh_token?: string;\r\n        expiry_date?: number;\r\n        token_type?: string;\r\n        scope?: string;\r\n      };\r\n\r\n      const creds = (integration.credentials as unknown) as Record<string, unknown> | null;\r\n      const cfg = (integration.config as unknown) as { selectedAccount?: { id?: string } } | null;\r\n      const loginCustomerIdSelected = normalizeGoogleAdsCustomerId(cfg?.selectedAccount?.id);\r\n      const loginCustomerIdSelectedFormatted = formatGoogleAdsCustomerId(loginCustomerIdSelected);\r\n\r\n      const envLoginCandidatesRaw = [\r\n        process.env.GOOGLE_ADS_MANAGER_CUSTOMER_ID,\r\n        process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID,\r\n        process.env.GOOGLE_ADS_MANAGER_ID\r\n      ];\r\n      const envLoginCandidates = envLoginCandidatesRaw\r\n        .map((value) => normalizeGoogleAdsCustomerId(value))\r\n        .filter((value): value is string => Boolean(value));\r\n      const loginCustomerCandidates = Array.from(\r\n        new Set([loginCustomerIdSelected, ...envLoginCandidates].filter((value): value is string => Boolean(value)))\r\n      );\r\n\r\n      const sendLoginOnListEnv = (() => {\r\n        const v = String(process.env.GOOGLE_ADS_LIST_SEND_LOGIN_CUSTOMER || '').trim().toLowerCase();\r\n        return v === '1' || v === 'true' || v === 'yes';\r\n      })();\r\n      const loginRequirementKey = `ads.accounts.force-login:${organizationId}`;\r\n      const forcedLoginFromCache = cacheGet<boolean>(loginRequirementKey) === true;\r\n      const primaryCandidate = loginCustomerCandidates[0];\r\n      const shouldSendLoginHeaderFirst = Boolean(primaryCandidate) &&\r\n        (sendLoginOnListEnv || forcedLoginFromCache || Boolean(loginCustomerIdSelected));\r\n      const primaryLoginCustomerId = shouldSendLoginHeaderFirst ? primaryCandidate : undefined;\r\n\r\n      const cloneIntegrationCredentials = (): Prisma.JsonObject | null => {\r\n        const raw = integration?.credentials;\r\n        if (!raw || typeof raw !== 'object' || Array.isArray(raw)) {\r\n          return raw && typeof raw === 'object' ? { ...(raw as Prisma.JsonObject) } : null;\r\n        }\r\n        return { ...(raw as Prisma.JsonObject) };\r\n      };\r\n\r\n      const credentialsForSuccess = (): Prisma.JsonObject | undefined => {\r\n        const clone = cloneIntegrationCredentials();\r\n        if (!clone) return undefined;\r\n        let mutated = false;\r\n        if (Object.prototype.hasOwnProperty.call(clone, 'userError')) {\r\n          delete clone.userError;\r\n          mutated = true;\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(clone, 'error')) {\r\n          delete clone.error;\r\n          mutated = true;\r\n        }\r\n        return mutated ? clone : undefined;\r\n      };\r\n\r\n      const credentialsForError = (userError?: string): Prisma.JsonObject | undefined => {\r\n        const clone = (cloneIntegrationCredentials() ?? {}) as Prisma.JsonObject;\r\n        let mutated = false;\r\n        if (userError && clone.userError !== userError) {\r\n          clone.userError = userError;\r\n          mutated = true;\r\n        }\r\n        return mutated ? clone : undefined;\r\n      };\r\n\r\n      const markIntegrationStatus = async (status: 'connected' | 'error', userError?: string) => {\r\n        if (!integration) return;\r\n        const data: Prisma.AdPlatformIntegrationUpdateInput = {\r\n          status,\r\n          updatedAt: new Date(),\r\n        };\r\n        if (status === 'connected') {\r\n          data.lastSync = new Date();\r\n          const sanitized = credentialsForSuccess();\r\n          if (sanitized) data.credentials = sanitized;\r\n        } else if (status === 'error') {\r\n          const credsWithError = credentialsForError(userError);\r\n          if (credsWithError) data.credentials = credsWithError;\r\n        }\r\n        const updated = await prisma.adPlatformIntegration.update({\r\n          where: { id: integration.id },\r\n          data,\r\n        });\r\n        integration = updated;\r\n      };\r\n\r\n      const tokensRaw = creds && typeof creds === 'object' && 'tokens' in (creds as Record<string, unknown>)\r\n        ? (creds as Record<string, unknown>)['tokens']\r\n        : undefined;\r\n      const storedTokens: GoogleOAuthTokens = (tokensRaw && typeof tokensRaw === 'object')\r\n        ? (tokensRaw as GoogleOAuthTokens)\r\n        : {};\r\n\r\n      const warnings: string[] = [];\r\n      if (!devToken) warnings.push('GOOGLE_ADS_DEVELOPER_TOKEN manquant \u2014 requ\u00EAtes Google Ads refus\u00E9es');\r\n      if (devTokenSan.sanitized || devTokenSan.looksQuoted) warnings.push('GOOGLE_ADS_DEVELOPER_TOKEN semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n      if (!clientId || !clientSecret) warnings.push('Client OAuth Google Ads incomplet \u2014 rafra\u00EEchissement du token impossible');\r\n\r\n      let accessToken: string | undefined = storedTokens.access_token;\r\n      const refreshToken: string | undefined = storedTokens.refresh_token;\r\n\r\n      try {\r\n        if ((!accessToken || storedTokens.expiry_date) && clientId && clientSecret && (refreshToken || storedTokens.expiry_date)) {\r\n          const oauth2 = new google.auth.OAuth2(clientId, clientSecret, redirectUri);\r\n          oauth2.setCredentials({\r\n            access_token: storedTokens.access_token,\r\n            refresh_token: storedTokens.refresh_token,\r\n            expiry_date: storedTokens.expiry_date,\r\n            token_type: storedTokens.token_type,\r\n            scope: storedTokens.scope,\r\n          });\r\n          const tk = await oauth2.getAccessToken();\r\n          accessToken = tk?.token || oauth2.credentials.access_token || accessToken;\r\n        }\r\n      } catch {\r\n        warnings.push('\u00C9chec du rafra\u00EEchissement de l\u2019access token \u2014 tentative avec le token stock\u00E9');\r\n      }\r\n\r\n      if (!accessToken) {\r\n        return res.json({ success: true, platform, integration, accounts: [], warnings, disabledReason: 'missing_access_token', message: 'Access token indisponible', connectionState: 'disconnected' as const });\r\n      }\r\n      if (!devToken) {\r\n        return res.json({ success: true, platform, integration, accounts: [], warnings, disabledReason: 'missing_developer_token', message: 'Developer token manquant', connectionState: 'disconnected' as const });\r\n      }\r\n\r\n      const candidateApiVersions = (() => {\r\n        const envValue = (process.env.GOOGLE_ADS_API_VERSION || '').trim();\r\n        const defaults = ['v19', 'v18', 'v17'];\r\n        const ordered = envValue ? [envValue, ...defaults] : defaults;\r\n        return Array.from(new Set(ordered)).filter(Boolean);\r\n      })();\r\n      const unsupportedVersions: string[] = [];\r\n\r\n      type GoogleAdsSuccessPayload = {\r\n        success: true;\r\n        platform: typeof platform;\r\n        integration: AdPlatformIntegration;\r\n        accounts: { id: string }[];\r\n        warnings: string[];\r\n        diagnostics: Record<string, unknown>;\r\n        cached: boolean;\r\n        cacheTtlMs: number;\r\n        connectionState: 'connected';\r\n      } & Record<string, unknown>;\r\n\r\n      type GoogleAdsErrorPayload = {\r\n        success: true;\r\n        platform: typeof platform;\r\n        integration: AdPlatformIntegration;\r\n        accounts: { id: string }[];\r\n        warnings: string[];\r\n        apiError?: unknown;\r\n        apiErrorSummary?: string;\r\n        apiStatus: string;\r\n        disabledReason: string;\r\n        diagnostics: Record<string, unknown>;\r\n        cached: boolean;\r\n        cacheTtlMs: number;\r\n        connectionState: 'error';\r\n      } & Record<string, unknown>;\r\n\r\n      type LoginHeaderFormat = 'digits' | 'formatted' | 'raw';\r\n\r\n      type AttemptResult =\r\n        | { type: 'success'; payload: GoogleAdsSuccessPayload; apiStatus?: undefined; loginCustomerId?: string; headerFormatUsed: LoginHeaderFormat | 'none'; fromCache: boolean; cacheKeyBase: string; cacheKeyUsed: string; apiVersion: string }\r\n        | { type: 'error'; payload: GoogleAdsErrorPayload; apiStatus: string; loginCustomerId?: string; headerFormatUsed: LoginHeaderFormat | 'none'; fromCache: boolean; cacheKeyBase: string; cacheKeyUsed: string; apiVersion: string };\r\n\r\n      const extractGoogleAdsError = (err: unknown) => {\r\n        const ax = err as { response?: { status?: number; data?: { error?: { message?: string; status?: string; details?: unknown[] } } } };\r\n        const data = ax?.response?.data;\r\n        const apiError = data?.error;\r\n        const apiMsg = apiError?.message || 'Erreur Google Ads API';\r\n        const apiStatus = apiError?.status || 'UNKNOWN';\r\n        const detailMsgs: string[] = [];\r\n        const errorCodeKeys: string[] = [];\r\n        try {\r\n          interface GoogleAdsInnerError { message?: string; errorCode?: Record<string, unknown>; }\r\n          interface GoogleAdsDetailShapeA { errors?: GoogleAdsInnerError[] }\r\n          interface GoogleAdsDetailShapeB { data?: { errors?: GoogleAdsInnerError[] } }\r\n          type GoogleAdsDetail = GoogleAdsDetailShapeA | GoogleAdsDetailShapeB | unknown;\r\n\r\n          const detailsArr: GoogleAdsDetail[] = Array.isArray(apiError?.details) ? (apiError.details as GoogleAdsDetail[]) : [];\r\n          for (const d of detailsArr) {\r\n            const dA = d as GoogleAdsDetailShapeA;\r\n            const dB = d as GoogleAdsDetailShapeB;\r\n            const errorsContainer: GoogleAdsInnerError[] = Array.isArray(dA?.errors)\r\n              ? dA.errors as GoogleAdsInnerError[]\r\n              : Array.isArray(dB?.data?.errors)\r\n                ? (dB.data?.errors as GoogleAdsInnerError[])\r\n                : [];\r\n            for (const e of errorsContainer) {\r\n              if (e?.message) detailMsgs.push(String(e.message));\r\n              const ec = e?.errorCode;\r\n              if (ec && typeof ec === 'object') {\r\n                for (const k of Object.keys(ec)) {\r\n                  const val = (ec as Record<string, unknown>)[k];\r\n                  if (val) errorCodeKeys.push(`${k}:${String(val)}`);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        } catch { /* ignore detail extraction errors */ }\r\n\r\n        const apiErrorSummary = `${apiStatus}: ${apiMsg}${detailMsgs.length ? ' \u2014 ' + detailMsgs[0] : ''}`;\r\n        return { data, apiErrorSummary, apiStatus, errorCodeKeys };\r\n      };\r\n\r\n      const buildCacheKeyBase = (apiVersion: string, loginCustomerId?: string, headerFormat?: LoginHeaderFormat | 'none') => {\r\n        const loginKey = loginCustomerId ?? 'none';\r\n        const formatKey = headerFormat ?? 'none';\r\n        return `ads.accounts:${organizationId}:${apiVersion}:${loginKey}:${formatKey}:${fingerprintSecret(devToken) || 'no-dev'}`;\r\n      };\r\n\r\n      const runWithApiVersion = async (apiVersion: string): Promise<AttemptResult> => {\r\n        const cacheTtlSuccessMs = 30000;\r\n        const cacheTtlErrorMs = 20000;\r\n\r\n        const attemptList = async (\r\n          loginCustomerId?: string,\r\n          allowCacheRead = true,\r\n          options?: { headerFormat?: LoginHeaderFormat }\r\n        ): Promise<AttemptResult> => {\r\n        const headerFormat = options?.headerFormat ?? 'digits';\r\n        const sanitizedLoginForKey = normalizeGoogleAdsCustomerId(loginCustomerId);\r\n          const cacheKeyBase = buildCacheKeyBase(apiVersion, sanitizedLoginForKey ?? loginCustomerId, headerFormat);\r\n        const cacheKeyOk = cacheKeyBase;\r\n        const cacheKeyErr = `${cacheKeyBase}:error`;\r\n\r\n        if (allowCacheRead) {\r\n          const cachedOk = cacheGet<GoogleAdsSuccessPayload>(cacheKeyOk);\r\n          if (cachedOk) {\r\n            const headerFmtDiag = (cachedOk?.diagnostics as Record<string, unknown> | undefined)?.loginCustomerHeaderFormatUsed;\r\n            const headerFormatFromCache: LoginHeaderFormat | 'none' = headerFmtDiag === 'formatted' || headerFmtDiag === 'raw' || headerFmtDiag === 'digits'\r\n              ? headerFmtDiag\r\n              : 'none';\r\n            return {\r\n              type: 'success',\r\n              payload: { ...cachedOk, cached: true },\r\n              loginCustomerId: sanitizedLoginForKey ?? loginCustomerId,\r\n              headerFormatUsed: headerFormatFromCache,\r\n              fromCache: true,\r\n              cacheKeyBase,\r\n                cacheKeyUsed: cacheKeyOk,\r\n                apiVersion\r\n            };\r\n          }\r\n          const cachedErr = cacheGet<GoogleAdsErrorPayload>(cacheKeyErr);\r\n          if (cachedErr) {\r\n            const cachedStatus = typeof cachedErr.apiStatus === 'string' ? cachedErr.apiStatus : 'UNKNOWN';\r\n            const headerFmtDiag = (cachedErr?.diagnostics as Record<string, unknown> | undefined)?.loginCustomerHeaderFormatUsed;\r\n            const headerFormatFromCache: LoginHeaderFormat | 'none' = headerFmtDiag === 'formatted' || headerFmtDiag === 'raw' || headerFmtDiag === 'digits'\r\n              ? headerFmtDiag\r\n              : 'none';\r\n            return {\r\n              type: 'error',\r\n              payload: { ...cachedErr, cached: true },\r\n              apiStatus: cachedStatus,\r\n              loginCustomerId: sanitizedLoginForKey ?? loginCustomerId,\r\n              headerFormatUsed: headerFormatFromCache,\r\n              fromCache: true,\r\n              cacheKeyBase,\r\n                cacheKeyUsed: cacheKeyErr,\r\n                apiVersion\r\n            };\r\n          }\r\n        }\r\n\r\n        const url = `https://googleads.googleapis.com/${apiVersion}/customers:listAccessibleCustomers`;\r\n        const headers: Record<string, string> = {\r\n          Authorization: `Bearer ${accessToken}`,\r\n          'developer-token': devToken,\r\n          Accept: 'application/json'\r\n        };\r\n  const sanitizedLoginHeader = sanitizedLoginForKey;\r\n        const formattedLoginHeader = sanitizedLoginHeader ? formatGoogleAdsCustomerId(sanitizedLoginHeader) : undefined;\r\n        const rawLoginHeader = typeof loginCustomerId === 'string' ? loginCustomerId.trim() : undefined;\r\n        const loginHeaderValue = (() => {\r\n          if (headerFormat === 'formatted') return formattedLoginHeader;\r\n          if (headerFormat === 'raw') return rawLoginHeader;\r\n          return sanitizedLoginHeader;\r\n        })();\r\n        const loginHeaderSent = Boolean(loginHeaderValue);\r\n        if (loginHeaderSent && loginHeaderValue) {\r\n          headers['login-customer-id'] = loginHeaderValue;\r\n        }\r\n\r\n        try {\r\n          const resp = await axios.get(url, { headers });\r\n          const names: string[] = resp.data?.resourceNames || resp.data?.resource_names || [];\r\n          const accounts = names.map((rn) => {\r\n            const m = String(rn).match(/customers\\/(\\d+)/);\r\n            return { id: m ? m[1] : rn };\r\n          });\r\n          const payload: GoogleAdsSuccessPayload = {\r\n            success: true,\r\n            platform,\r\n            integration,\r\n            accounts,\r\n            warnings: [...warnings],\r\n            diagnostics: {\r\n              loginCustomerIdSelected,\r\n              loginCustomerIdSelectedFormatted,\r\n              loginCustomerHeaderSent: loginHeaderSent,\r\n              loginCustomerAttempted: sanitizedLoginHeader ?? null,\r\n              loginCustomerAttemptFormatted: sanitizedLoginHeader ? formatGoogleAdsCustomerId(sanitizedLoginHeader) : null,\r\n              loginCustomerAttemptRaw: rawLoginHeader ?? null,\r\n              loginCustomerHeaderValue: loginHeaderValue ?? null,\r\n              loginCustomerHeaderFormatUsed: loginHeaderSent ? headerFormat : 'none',\r\n              loginHeaderSource: sanitizedLoginHeader\r\n                ? sanitizedLoginHeader === loginCustomerIdSelected\r\n                  ? 'selected_account'\r\n                  : envLoginCandidates.includes(sanitizedLoginHeader)\r\n                    ? 'environment'\r\n                    : 'manual'\r\n                : null,\r\n                apiVersion,\r\n              availableLoginCustomerCandidates: loginCustomerCandidates,\r\n              forcedLoginHeader: forcedLoginFromCache,\r\n              fallbackTriggered: false\r\n            },\r\n            cached: false,\r\n            cacheTtlMs: cacheTtlSuccessMs,\r\n            connectionState: 'connected'\r\n          };\r\n          cacheSet(cacheKeyOk, payload, cacheTtlSuccessMs);\r\n            return { type: 'success', payload, loginCustomerId: sanitizedLoginHeader ?? loginCustomerId, headerFormatUsed: loginHeaderSent ? headerFormat : 'none', fromCache: false, cacheKeyBase, cacheKeyUsed: cacheKeyOk, apiVersion };\r\n        } catch (error: unknown) {\r\n          const { data, apiErrorSummary, apiStatus, errorCodeKeys } = extractGoogleAdsError(error);\r\n          console.error('Erreur Google Ads listAccessibleCustomers:', data || error);\r\n          console.error('Google Ads diagnostics (listAccessibleCustomers):', {\r\n            organizationId,\r\n            apiStatus,\r\n            loginHeader: {\r\n              sent: loginHeaderSent,\r\n              valueLength: loginHeaderValue ? loginHeaderValue.length : 0,\r\n              normalized: sanitizedLoginHeader ?? null,\r\n              formatted: sanitizedLoginHeader ? formatGoogleAdsCustomerId(sanitizedLoginHeader) : null,\r\n              formatUsed: loginHeaderSent ? headerFormat : 'none',\r\n              source: sanitizedLoginHeader\r\n                ? sanitizedLoginHeader === loginCustomerIdSelected\r\n                  ? 'selected_account'\r\n                  : envLoginCandidates.includes(sanitizedLoginHeader)\r\n                    ? 'environment'\r\n                    : 'manual'\r\n                : null,\r\n            },\r\n            developerToken: {\r\n              defined: Boolean(devToken),\r\n              fingerprint: fingerprintSecret(devToken),\r\n              length: devToken ? devToken.length : 0,\r\n            },\r\n            clientId: {\r\n              defined: Boolean(clientId),\r\n              masked: clientId\r\n                ? clientId.length > 8\r\n                  ? `${clientId.slice(0, 4)}...${clientId.slice(-4)}`\r\n                  : 'defined'\r\n                : 'MISSING',\r\n            },\r\n            redirectUri,\r\n            errorCodeKeys,\r\n              apiVersion,\r\n          });\r\n\r\n          const warningsForPayload = [...warnings];\r\n          let humanHint: string | undefined;\r\n          if (apiStatus === 'INVALID_ARGUMENT') {\r\n            humanHint = 'INVALID_ARGUMENT re\u00E7u. V\u00E9rifiez GOOGLE_ADS_DEVELOPER_TOKEN (sans guillemets/espaces), l\u2019approbation API et red\u00E9marrez l\u2019API apr\u00E8s modification du .env.';\r\n            if (devTokenSan.sanitized || devTokenSan.looksQuoted) {\r\n              humanHint += ' Le token a \u00E9t\u00E9 nettoy\u00E9 automatiquement c\u00F4t\u00E9 serveur (indice: guillemets/espaces d\u00E9tect\u00E9s).';\r\n            }\r\n            if (!loginHeaderSent && loginCustomerCandidates.length === 0) {\r\n              warningsForPayload.push('INVALID_ARGUMENT sans login-customer-id et aucun identifiant de repli disponible. D\u00E9finissez GOOGLE_ADS_MANAGER_CUSTOMER_ID ou s\u00E9lectionnez un compte Google Ads.');\r\n            }\r\n          }\r\n\r\n          const payload: GoogleAdsErrorPayload = {\r\n            success: true,\r\n            platform,\r\n            integration,\r\n            accounts: [],\r\n            warnings: warningsForPayload,\r\n            apiError: data,\r\n            apiErrorSummary,\r\n            apiStatus,\r\n            disabledReason: 'ads_api_error',\r\n            diagnostics: {\r\n              apiVersion,\r\n              devTokenFingerprint: fingerprintSecret(devToken),\r\n              devTokenLength: devToken ? devToken.length : 0,\r\n              clientIdMasked: (idSan.value ? (idSan.value.length > 8 ? idSan.value.slice(0, 4) + '...' + idSan.value.slice(-4) : 'defined') : 'MISSING'),\r\n              redirectUri,\r\n              loginCustomerIdSelected,\r\n              loginCustomerIdSelectedFormatted,\r\n              loginCustomerHeaderSent: loginHeaderSent,\r\n              loginCustomerAttempted: sanitizedLoginHeader ?? null,\r\n              loginCustomerAttemptFormatted: sanitizedLoginHeader ? formatGoogleAdsCustomerId(sanitizedLoginHeader) : null,\r\n              loginCustomerAttemptRaw: rawLoginHeader ?? null,\r\n              loginCustomerHeaderValue: loginHeaderValue ?? null,\r\n              loginCustomerHeaderFormatUsed: loginHeaderSent ? headerFormat : 'none',\r\n              loginHeaderSource: sanitizedLoginHeader\r\n                ? sanitizedLoginHeader === loginCustomerIdSelected\r\n                  ? 'selected_account'\r\n                  : envLoginCandidates.includes(sanitizedLoginHeader)\r\n                    ? 'environment'\r\n                    : 'manual'\r\n                : null,\r\n              availableLoginCustomerCandidates: loginCustomerCandidates,\r\n              primaryErrorCode: errorCodeKeys[0] || null,\r\n              errorCodeKeys,\r\n              humanHint,\r\n              forcedLoginHeader: forcedLoginFromCache,\r\n              fallbackTriggered: false\r\n            },\r\n            cached: false,\r\n            cacheTtlMs: cacheTtlErrorMs,\r\n            connectionState: 'error'\r\n          };\r\n          cacheSet(cacheKeyErr, payload, cacheTtlErrorMs);\r\n            return { type: 'error', payload, apiStatus, loginCustomerId: sanitizedLoginHeader ?? loginCustomerId, headerFormatUsed: loginHeaderSent ? headerFormat : 'none', fromCache: false, cacheKeyBase, cacheKeyUsed: cacheKeyErr, apiVersion };\r\n        }\r\n      };\r\n        const applyFormattedFallback = async (\r\n          current: AttemptResult,\r\n          loginCustomerId?: string,\r\n          context: 'initial' | 'secondary'\r\n        ): Promise<AttemptResult> => {\r\n          if (!loginCustomerId) return current;\r\n          if (current.type === 'success') return current;\r\n          if (current.apiStatus !== 'INVALID_ARGUMENT') return current;\r\n          if (current.headerFormatUsed === 'formatted') return current;\r\n\r\n          const formattedAttempt = await attemptList(loginCustomerId, false, { headerFormat: 'formatted' });\r\n          const warningNoteSuccess = 'La requ\u00EAte Google Ads a abouti apr\u00E8s r\u00E9\u00E9mission du login-customer-id au format 123-456-7890.';\r\n          const warningNoteFailure = `Tentative suppl\u00E9mentaire avec login-customer-id format\u00E9 (tirets) \u00E9galement en \u00E9chec (${formattedAttempt.apiStatus}).`;\r\n          const diagAugmentation = {\r\n            formatFallbackTriggered: true,\r\n            formatFallbackContext: context,\r\n          } as Record<string, unknown>;\r\n\r\n          if (formattedAttempt.type === 'success') {\r\n            formattedAttempt.payload.warnings = [...formattedAttempt.payload.warnings, warningNoteSuccess];\r\n            formattedAttempt.payload.diagnostics = {\r\n              ...formattedAttempt.payload.diagnostics,\r\n              ...diagAugmentation,\r\n            };\r\n          } else {\r\n            formattedAttempt.payload.warnings = [...formattedAttempt.payload.warnings, warningNoteFailure];\r\n            formattedAttempt.payload.diagnostics = {\r\n              ...formattedAttempt.payload.diagnostics,\r\n              ...diagAugmentation,\r\n            };\r\n          }\r\n\r\n          return formattedAttempt;\r\n        };\r\n\r\n        let initialAttempt = await attemptList(primaryLoginCustomerId, true);\r\n        initialAttempt = await applyFormattedFallback(initialAttempt, primaryLoginCustomerId, 'initial');\r\n        if (initialAttempt.type === 'success') {\r\n          if (!initialAttempt.fromCache) {\r\n            await markIntegrationStatus('connected');\r\n            initialAttempt.payload.integration = integration;\r\n            cacheSet(initialAttempt.cacheKeyUsed, initialAttempt.payload, initialAttempt.payload.cacheTtlMs);\r\n          } else {\r\n            initialAttempt.payload.integration = integration;\r\n          }\r\n          initialAttempt.payload.diagnostics = {\r\n            ...initialAttempt.payload.diagnostics,\r\n            apiVersion,\r\n          };\r\n          return initialAttempt;\r\n        }\r\n\r\n        const shouldRetryWithLoginHeader = initialAttempt.apiStatus === 'INVALID_ARGUMENT'\r\n          && !primaryLoginCustomerId\r\n          && loginCustomerCandidates.length > 0;\r\n\r\n        if (shouldRetryWithLoginHeader) {\r\n          const fallbackLoginCustomerId = loginCustomerCandidates[0];\r\n          const fallbackLabel = formatGoogleAdsCustomerId(fallbackLoginCustomerId) ?? fallbackLoginCustomerId;\r\n          cacheSet(loginRequirementKey, true, 10 * 60 * 1000); // 10 minutes\r\n\r\n          let fallbackAttempt = await attemptList(fallbackLoginCustomerId, false);\r\n          fallbackAttempt = await applyFormattedFallback(fallbackAttempt, fallbackLoginCustomerId, 'secondary');\r\n          if (fallbackAttempt.type === 'success') {\r\n            fallbackAttempt.payload.warnings = [\r\n              ...fallbackAttempt.payload.warnings,\r\n              `La requ\u00EAte initiale sans login-customer-id a retourn\u00E9 INVALID_ARGUMENT. Relance r\u00E9ussie avec l'identifiant ${fallbackLabel}.`\r\n            ];\r\n            fallbackAttempt.payload.diagnostics = {\r\n              ...fallbackAttempt.payload.diagnostics,\r\n              fallbackTriggered: true,\r\n              fallbackLoginCustomerId,\r\n              fallbackLoginCustomerFormatted: fallbackLabel,\r\n              fallbackReason: 'INVALID_ARGUMENT_without_login_header',\r\n              apiVersion,\r\n            };\r\n            await markIntegrationStatus('connected');\r\n            fallbackAttempt.payload.integration = integration;\r\n            cacheSet(fallbackAttempt.cacheKeyUsed, fallbackAttempt.payload, fallbackAttempt.payload.cacheTtlMs);\r\n            return fallbackAttempt;\r\n          }\r\n\r\n          fallbackAttempt.payload.warnings = [\r\n            ...fallbackAttempt.payload.warnings,\r\n            `La requ\u00EAte initiale sans login-customer-id a retourn\u00E9 INVALID_ARGUMENT. La relance avec ${fallbackLabel} a \u00E9galement \u00E9chou\u00E9 (${fallbackAttempt.apiStatus}).`\r\n          ];\r\n          fallbackAttempt.payload.diagnostics = {\r\n            ...fallbackAttempt.payload.diagnostics,\r\n            fallbackTriggered: true,\r\n            fallbackLoginCustomerId,\r\n            fallbackLoginCustomerFormatted: fallbackLabel,\r\n            fallbackReason: 'INVALID_ARGUMENT_without_login_header',\r\n            apiVersion,\r\n          };\r\n          const fallbackErrorSummary = fallbackAttempt.payload.apiErrorSummary || fallbackAttempt.apiStatus;\r\n          await markIntegrationStatus('error', fallbackErrorSummary);\r\n          fallbackAttempt.payload.integration = integration;\r\n          cacheSet(fallbackAttempt.cacheKeyUsed, fallbackAttempt.payload, fallbackAttempt.payload.cacheTtlMs);\r\n          return fallbackAttempt;\r\n        }\r\n\r\n        const initialErrorSummary = initialAttempt.payload.apiErrorSummary || initialAttempt.apiStatus;\r\n        if (!initialAttempt.fromCache) {\r\n          await markIntegrationStatus('error', initialErrorSummary);\r\n          initialAttempt.payload.integration = integration;\r\n          cacheSet(initialAttempt.cacheKeyUsed, initialAttempt.payload, initialAttempt.payload.cacheTtlMs);\r\n        } else {\r\n          initialAttempt.payload.integration = integration;\r\n        }\r\n\r\n        initialAttempt.payload.diagnostics = {\r\n          ...initialAttempt.payload.diagnostics,\r\n          apiVersion,\r\n        };\r\n\r\n        return initialAttempt;\r\n      };\r\n\r\n      let finalResult: AttemptResult | undefined;\r\n      for (const apiVersion of candidateApiVersions) {\r\n        const result = await runWithApiVersion(apiVersion);\r\n        if (result.type === 'success') {\r\n          finalResult = result;\r\n          break;\r\n        }\r\n        const primaryError = (result.payload?.diagnostics as Record<string, unknown> | undefined)?.primaryErrorCode;\r\n        if (result.apiStatus === 'INVALID_ARGUMENT' && primaryError === 'requestError:UNSUPPORTED_VERSION') {\r\n          unsupportedVersions.push(apiVersion);\r\n          continue;\r\n        }\r\n        finalResult = result;\r\n        break;\r\n      }\r\n\r\n      if (!finalResult) {\r\n        // fallback: renvoyer derni\u00E8re tentative avec version par d\u00E9faut\r\n        finalResult = await runWithApiVersion(candidateApiVersions[candidateApiVersions.length - 1] || 'v18');\r\n      }\r\n\r\n      if (unsupportedVersions.length) {\r\n        const diag = (finalResult.payload?.diagnostics ?? {}) as Record<string, unknown>;\r\n        finalResult.payload.diagnostics = {\r\n          ...diag,\r\n          unsupportedApiVersions: unsupportedVersions,\r\n        };\r\n        finalResult.payload.warnings = [\r\n          ...(finalResult.payload.warnings || []),\r\n          `Versions Google Ads non support\u00E9es d\u00E9tect\u00E9es: ${unsupportedVersions.join(', ')}`\r\n        ];\r\n      }\r\n\r\n      console.log('[Google Ads] R\u00E9sultat listAccessibleCustomers', {\r\n        organizationId,\r\n        type: finalResult.type,\r\n        apiVersion: finalResult.apiVersion,\r\n        unsupportedVersions,\r\n        fromCache: finalResult.fromCache,\r\n      });\r\n\r\n      if (finalResult.type === 'success') {\r\n        if (!finalResult.fromCache) {\r\n          await markIntegrationStatus('connected');\r\n          finalResult.payload.integration = integration;\r\n          cacheSet(finalResult.cacheKeyUsed, finalResult.payload, finalResult.payload.cacheTtlMs);\r\n        } else {\r\n          finalResult.payload.integration = integration;\r\n        }\r\n        return res.json(finalResult.payload);\r\n      }\r\n\r\n      const finalErrorSummary = finalResult.payload.apiErrorSummary || finalResult.apiStatus;\r\n      if (!finalResult.fromCache) {\r\n        await markIntegrationStatus('error', finalErrorSummary);\r\n        finalResult.payload.integration = integration;\r\n        cacheSet(finalResult.cacheKeyUsed, finalResult.payload, finalResult.payload.cacheTtlMs);\r\n      } else {\r\n        finalResult.payload.integration = integration;\r\n      }\r\n\r\n      return res.json(finalResult.payload);\r\n    }\r\n\r\n    if (platform === 'meta_ads') {\r\n      const appIdSan = sanitizeClientValue(process.env.META_APP_ID || '');\r\n      const appSecretSan = sanitizeClientValue(process.env.META_APP_SECRET || '');\r\n      const warnings: string[] = [];\r\n      if (!appIdSan.value) warnings.push('META_APP_ID manquant \u2014 authentification Meta impossible');\r\n      if (!appSecretSan.value) warnings.push('META_APP_SECRET manquant \u2014 \u00E9changes de tokens impossibles');\r\n      if (appIdSan.sanitized || appIdSan.looksQuoted) warnings.push('META_APP_ID semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n      if (appSecretSan.sanitized || appSecretSan.looksQuoted) warnings.push('META_APP_SECRET semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n\r\n      const rawCreds = integration.credentials as Prisma.JsonObject | null;\r\n      const rawAccessToken = rawCreds && typeof rawCreds === 'object' ? (rawCreds as Record<string, unknown>).accessToken : undefined;\r\n      const trimmedAccessToken = typeof rawAccessToken === 'string' ? rawAccessToken.trim() : undefined;\r\n      const accessToken = trimmedAccessToken;\r\n\r\n      const cloneIntegrationCredentials = (): Prisma.JsonObject | null => {\r\n        const raw = integration?.credentials;\r\n        if (!raw || typeof raw !== 'object' || Array.isArray(raw)) {\r\n          return raw && typeof raw === 'object' ? { ...(raw as Prisma.JsonObject) } : null;\r\n        }\r\n        return { ...(raw as Prisma.JsonObject) };\r\n      };\r\n\r\n      const credentialsForSuccess = (): Prisma.JsonObject | undefined => {\r\n        const clone = cloneIntegrationCredentials();\r\n        if (!clone) return undefined;\r\n        let mutated = false;\r\n        if (accessToken && clone.accessToken !== accessToken) {\r\n          clone.accessToken = accessToken;\r\n          mutated = true;\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(clone, 'userError')) {\r\n          delete clone.userError;\r\n          mutated = true;\r\n        }\r\n        if (Object.prototype.hasOwnProperty.call(clone, 'error')) {\r\n          delete clone.error;\r\n          mutated = true;\r\n        }\r\n        return mutated ? clone : undefined;\r\n      };\r\n\r\n      const credentialsForError = (userError?: string, errorCode?: string): Prisma.JsonObject | undefined => {\r\n        const clone = (cloneIntegrationCredentials() ?? {}) as Prisma.JsonObject;\r\n        let mutated = false;\r\n        if (userError && clone.userError !== userError) {\r\n          clone.userError = userError;\r\n          mutated = true;\r\n        }\r\n        if (errorCode && clone.error !== errorCode) {\r\n          clone.error = errorCode;\r\n          mutated = true;\r\n        }\r\n        return mutated ? clone : undefined;\r\n      };\r\n\r\n      const markIntegrationStatus = async (status: 'connected' | 'error', userError?: string, errorCode?: string) => {\r\n        if (!integration) return;\r\n        const data: Prisma.AdPlatformIntegrationUpdateInput = {\r\n          status,\r\n          updatedAt: new Date()\r\n        };\r\n        if (status === 'connected') {\r\n          data.lastSync = new Date();\r\n          const sanitized = credentialsForSuccess();\r\n          if (sanitized) data.credentials = sanitized;\r\n        } else if (status === 'error') {\r\n          const credsWithError = credentialsForError(userError, errorCode);\r\n          if (credsWithError) data.credentials = credsWithError;\r\n        }\r\n        const updated = await prisma.adPlatformIntegration.update({\r\n          where: { id: integration.id },\r\n          data\r\n        });\r\n        integration = updated;\r\n      };\r\n\r\n      if (!accessToken) {\r\n        return res.json({\r\n          success: true,\r\n          platform,\r\n          integration,\r\n          accounts: [],\r\n          warnings,\r\n          disabledReason: 'missing_access_token',\r\n          message: 'Access token Meta Ads indisponible',\r\n          connectionState: 'disconnected' as const\r\n        });\r\n      }\r\n\r\n      const cacheKeyBase = `meta.accounts:${organizationId}:${fingerprintSecret(accessToken) || 'anon'}`;\r\n      const cacheKeyOk = `${cacheKeyBase}:ok`;\r\n      const cacheKeyError = `${cacheKeyBase}:error`;\r\n      const cacheTtlSuccessMs = 30000;\r\n      const cacheTtlErrorMs = 20000;\r\n\r\n      const cachedOk = cacheGet<Record<string, unknown>>(cacheKeyOk);\r\n      if (cachedOk) {\r\n        const diagnostics = cachedOk?.diagnostics && typeof cachedOk.diagnostics === 'object' && !Array.isArray(cachedOk.diagnostics)\r\n          ? { ...(cachedOk.diagnostics as Record<string, unknown>), cached: true }\r\n          : { cached: true };\r\n        return res.json({ ...cachedOk, diagnostics });\r\n      }\r\n      const cachedErr = cacheGet<Record<string, unknown>>(cacheKeyError);\r\n      if (cachedErr) {\r\n        const diagnostics = cachedErr?.diagnostics && typeof cachedErr.diagnostics === 'object' && !Array.isArray(cachedErr.diagnostics)\r\n          ? { ...(cachedErr.diagnostics as Record<string, unknown>), cached: true }\r\n          : { cached: true };\r\n        return res.json({ ...cachedErr, diagnostics });\r\n      }\r\n\r\n      try {\r\n        const accountsResp = await axios.get('https://graph.facebook.com/v18.0/me/adaccounts', {\r\n          params: {\r\n            fields: 'id,account_id,name,account_status,currency,timezone_id,business_name',\r\n            access_token: accessToken\r\n          }\r\n        });\r\n        const rawAccounts: Array<Record<string, unknown>> = Array.isArray(accountsResp.data?.data)\r\n          ? (accountsResp.data.data as Array<Record<string, unknown>>)\r\n          : [];\r\n        const accounts = rawAccounts.map((acc) => {\r\n          const accountId = typeof acc.account_id === 'string' ? acc.account_id : undefined;\r\n          const actId = typeof acc.id === 'string' ? acc.id : accountId;\r\n          return {\r\n            id: actId || accountId || 'unknown',\r\n            accountId: accountId || null,\r\n            name: typeof acc.name === 'string' ? acc.name : 'Compte Meta',\r\n            status: typeof acc.account_status === 'number' ? acc.account_status : acc.account_status ?? null,\r\n            currency: typeof acc.currency === 'string' ? acc.currency : null,\r\n            timezoneId: typeof acc.timezone_id === 'string' ? acc.timezone_id : null,\r\n            businessName: typeof acc.business_name === 'string' ? acc.business_name : null\r\n          };\r\n        });\r\n\r\n        await markIntegrationStatus('connected');\r\n\r\n        const payload = {\r\n          success: true,\r\n          platform,\r\n          integration,\r\n          accounts,\r\n          warnings,\r\n          diagnostics: {\r\n            tokenFingerprint: fingerprintSecret(accessToken),\r\n            accountCount: accounts.length,\r\n            cached: false\r\n          },\r\n          connectionState: 'connected' as const\r\n        };\r\n        cacheSet(cacheKeyOk, payload, cacheTtlSuccessMs);\r\n        return res.json(payload);\r\n      } catch (error: unknown) {\r\n        const ax = error as { response?: { data?: { error?: { message?: string; type?: string; code?: number; error_subcode?: number; fbtrace_id?: string } } } };\r\n        const fbError = ax?.response?.data?.error;\r\n        const fbType = fbError?.type || 'MetaApiError';\r\n        const fbMessage = fbError?.message || 'Erreur Meta Ads API';\r\n        const fbCode = typeof fbError?.code === 'number' ? fbError?.code : null;\r\n        const fbSubcode = typeof fbError?.error_subcode === 'number' ? fbError?.error_subcode : null;\r\n        const fbTraceId = fbError?.fbtrace_id || null;\r\n        let userFriendly = fbMessage;\r\n        if (fbCode === 190) {\r\n          userFriendly = 'Session Meta expir\u00E9e \u2014 reconnectez-vous \u00E0 Meta Ads.';\r\n        } else if (fbCode === 102) {\r\n          userFriendly = 'Jeton Meta invalide \u2014 relancez l\u2019authentification.';\r\n        }\r\n\r\n        await markIntegrationStatus('error', userFriendly, fbType);\r\n\r\n        const payload = {\r\n          success: true,\r\n          platform,\r\n          integration,\r\n          accounts: [],\r\n          warnings,\r\n          apiError: fbError,\r\n          apiErrorSummary: `${fbType}${fbCode ? ` (${fbCode}${fbSubcode ? `/${fbSubcode}` : ''})` : ''}: ${fbMessage}`,\r\n          disabledReason: 'ads_api_error',\r\n          connectionState: 'error' as const,\r\n          diagnostics: {\r\n            tokenFingerprint: fingerprintSecret(accessToken),\r\n            appIdPresent: !!appIdSan.value,\r\n            errorCode: fbCode,\r\n            errorSubcode: fbSubcode,\r\n            errorType: fbType,\r\n            fbTraceId,\r\n            cached: false\r\n          }\r\n        };\r\n        cacheSet(cacheKeyError, payload, cacheTtlErrorMs);\r\n        return res.json(payload);\r\n      }\r\n    }\r\n\r\n    // Par d\u00E9faut pour autres plateformes (placeholder)\r\n    return res.json({ success: true, platform, integration, accounts: [], note: 'Int\u00E9gration configur\u00E9e', connectionState: 'unknown' as const });\r\n  } catch (error) {\r\n    console.error('Erreur listing comptes:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur listing comptes' });\r\n  }\r\n});\r\n\r\n/**\r\n * Endpoint de test cibl\u00E9 Google Ads: GET customer\r\n * Objectif: diagnostiquer les erreurs INVALID_ARGUMENT en testant un customerId pr\u00E9cis\r\n * GET /api/integrations/advertising/google_ads/test/customers-get?customerId=XXX&withLoginHeader=true&apiVersion=v18\r\n */\r\nrouter.get('/advertising/google_ads/test/customers-get', async (req: Request, res: Response) => {\r\n  try {\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organisation requise' });\r\n\r\n    const integ = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform: 'google_ads' } });\r\n    if (!integ) return res.status(404).json({ success: false, message: 'Int\u00E9gration Google Ads manquante' });\r\n\r\n    const devTokenSan = sanitizeClientValue(process.env.GOOGLE_ADS_DEVELOPER_TOKEN || '');\r\n    const devToken = devTokenSan.value || '';\r\n    const idSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_ID || '');\r\n    const secretSan = sanitizeClientValue(process.env.GOOGLE_ADS_CLIENT_SECRET || '');\r\n    const clientId = idSan.value || '';\r\n    const clientSecret = secretSan.value || '';\r\n    const { uri: redirectUri } = sanitizeRedirectUri(process.env.GOOGLE_ADS_REDIRECT_URI);\r\n\r\n    const qCustomerId = String(req.query.customerId || '').trim();\r\n    const normalizedCustomerId = qCustomerId.replace(/[^0-9]/g, '');\r\n    const apiVersion = String(req.query.apiVersion || process.env.GOOGLE_ADS_API_VERSION || 'v18').trim();\r\n    const withLoginHeader = String(req.query.withLoginHeader || '').toLowerCase();\r\n    const sendLoginHeader = withLoginHeader === '1' || withLoginHeader === 'true' || withLoginHeader === 'yes';\r\n\r\n    const warnings: string[] = [];\r\n    if (!normalizedCustomerId || normalizedCustomerId.length < 8) return res.status(400).json({ success: false, message: 'Param\u00E8tre customerId invalide' });\r\n    if (!devToken) warnings.push('GOOGLE_ADS_DEVELOPER_TOKEN manquant \u2014 requ\u00EAtes Google Ads refus\u00E9es');\r\n    if (devTokenSan.sanitized || devTokenSan.looksQuoted) warnings.push('GOOGLE_ADS_DEVELOPER_TOKEN semblait contenir des guillemets/espaces \u2014 valeur nettoy\u00E9e');\r\n    if (!clientId || !clientSecret) warnings.push('Client OAuth Google Ads incomplet \u2014 rafra\u00EEchissement du token impossible');\r\n\r\n    type GoogleOAuthTokens = {\r\n      access_token?: string;\r\n      refresh_token?: string;\r\n      expiry_date?: number;\r\n      token_type?: string;\r\n      scope?: string;\r\n    };\r\n    const creds = (integ.credentials as unknown) as Record<string, unknown> | null;\r\n    const tokensRaw = creds && typeof creds === 'object' && 'tokens' in (creds as Record<string, unknown>)\r\n      ? (creds as Record<string, unknown>)['tokens']\r\n      : undefined;\r\n    const storedTokens: GoogleOAuthTokens = (tokensRaw && typeof tokensRaw === 'object')\r\n      ? (tokensRaw as GoogleOAuthTokens)\r\n      : {};\r\n    let accessToken: string | undefined = storedTokens.access_token;\r\n    const refreshToken: string | undefined = storedTokens.refresh_token;\r\n\r\n    try {\r\n      if ((!accessToken || storedTokens.expiry_date) && clientId && clientSecret && (refreshToken || storedTokens.expiry_date)) {\r\n        const oauth2 = new google.auth.OAuth2(clientId, clientSecret, redirectUri);\r\n        oauth2.setCredentials({\r\n          access_token: storedTokens.access_token,\r\n          refresh_token: storedTokens.refresh_token,\r\n          expiry_date: storedTokens.expiry_date,\r\n          token_type: storedTokens.token_type,\r\n          scope: storedTokens.scope,\r\n        });\r\n        const tk = await oauth2.getAccessToken();\r\n        accessToken = tk?.token || oauth2.credentials.access_token || accessToken;\r\n      }\r\n    } catch {\r\n      warnings.push('\u00C9chec du rafra\u00EEchissement de l\u2019access token \u2014 tentative avec le token stock\u00E9');\r\n    }\r\n\r\n    if (!accessToken) {\r\n      return res.json({ success: true, test: 'customers.get', customerId: normalizedCustomerId, warnings, disabledReason: 'missing_access_token' });\r\n    }\r\n    if (!devToken) {\r\n      return res.json({ success: true, test: 'customers.get', customerId: normalizedCustomerId, warnings, disabledReason: 'missing_developer_token' });\r\n    }\r\n\r\n    const url = `https://googleads.googleapis.com/${apiVersion}/customers/${normalizedCustomerId}`;\r\n    const headers: Record<string, string> = {\r\n      Authorization: `Bearer ${accessToken}`,\r\n      'developer-token': devToken,\r\n      Accept: 'application/json'\r\n    };\r\n    const loginHeaderSent = !!(sendLoginHeader && normalizedCustomerId);\r\n    if (loginHeaderSent) headers['login-customer-id'] = normalizedCustomerId;\r\n\r\n    try {\r\n      const resp = await axios.get(url, { headers });\r\n      return res.json({\r\n        success: true,\r\n        test: 'customers.get',\r\n        customerId: normalizedCustomerId,\r\n        apiVersion,\r\n        loginCustomerHeaderSent: loginHeaderSent,\r\n        warnings,\r\n        data: resp.data\r\n      });\r\n    } catch (error: unknown) {\r\n      const ax = error as { response?: { status?: number; data?: { error?: { message?: string; status?: string; details?: unknown[] } } } };\r\n      const data = ax?.response?.data;\r\n      const apiError = data?.error;\r\n      const apiMsg = apiError?.message || 'Erreur Google Ads API';\r\n      const apiStatus = apiError?.status || 'UNKNOWN';\r\n      const detailMsgs: string[] = [];\r\n      const errorCodeKeys: string[] = [];\r\n      try {\r\n        interface GoogleAdsInnerError { message?: string; errorCode?: Record<string, unknown>; }\r\n        interface GoogleAdsDetailShapeA { errors?: GoogleAdsInnerError[] }\r\n        interface GoogleAdsDetailShapeB { data?: { errors?: GoogleAdsInnerError[] } }\r\n        type GoogleAdsDetail = GoogleAdsDetailShapeA | GoogleAdsDetailShapeB | unknown;\r\n        const detailsArr: GoogleAdsDetail[] = Array.isArray(apiError?.details) ? (apiError.details as GoogleAdsDetail[]) : [];\r\n        for (const d of detailsArr) {\r\n          const dA = d as GoogleAdsDetailShapeA;\r\n          const dB = d as GoogleAdsDetailShapeB;\r\n          const errorsContainer: GoogleAdsInnerError[] = Array.isArray(dA?.errors)\r\n            ? dA.errors as GoogleAdsInnerError[]\r\n            : Array.isArray(dB?.data?.errors)\r\n              ? (dB.data?.errors as GoogleAdsInnerError[])\r\n              : [];\r\n          for (const e of errorsContainer) {\r\n            if (e?.message) detailMsgs.push(String(e.message));\r\n            const ec = e?.errorCode;\r\n            if (ec && typeof ec === 'object') {\r\n              for (const k of Object.keys(ec)) {\r\n                const val = (ec as Record<string, unknown>)[k];\r\n                if (val) errorCodeKeys.push(`${k}:${String(val)}`);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } catch { /* ignore */ }\r\n      const apiErrorSummary = `${apiStatus}: ${apiMsg}${detailMsgs.length ? ' \u2014 ' + detailMsgs[0] : ''}`;\r\n      return res.json({\r\n        success: true,\r\n        test: 'customers.get',\r\n        customerId: normalizedCustomerId,\r\n        apiVersion,\r\n        loginCustomerHeaderSent: loginHeaderSent,\r\n        warnings,\r\n        apiError: data,\r\n        apiErrorSummary,\r\n        diagnostics: {\r\n          devTokenFingerprint: fingerprintSecret(devToken),\r\n          devTokenLength: devToken ? devToken.length : 0,\r\n          clientIdMasked: (idSan.value ? (idSan.value.length > 8 ? idSan.value.slice(0,4)+'...'+idSan.value.slice(-4) : 'defined') : 'MISSING'),\r\n          redirectUri,\r\n          primaryErrorCode: errorCodeKeys[0] || null,\r\n          errorCodeKeys\r\n        }\r\n      });\r\n    }\r\n  } catch (error) {\r\n    console.error('Erreur test customers.get:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur test customers.get' });\r\n  }\r\n});\r\n\r\n/**\r\n * Supprimer une int\u00E9gration publicitaire\r\n * DELETE /api/integrations/advertising/:platform\r\n */\r\nrouter.delete('/advertising/:platform', async (req: Request, res: Response): Promise<void> => {\r\n  const user = (req as AuthenticatedRequest).user;\r\n  const organizationId = getEffectiveOrgId(req);\r\n  const platform = req.params.platform as 'google_ads' | 'meta_ads';\r\n\r\n  if (!user) {\r\n    res.status(401).json({ success: false, message: 'Unauthorized' });\r\n    return;\r\n  }\r\n  \r\n  if (!organizationId) {\r\n    res.status(400).json({ success: false, message: 'Organization context is missing.' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const deleted = await prisma.adPlatformIntegration.deleteMany({\r\n      where: {\r\n        organizationId,\r\n        platform\r\n      }\r\n    });\r\n\r\n    if (deleted.count === 0) {\r\n      res.status(404).json({ success: false, message: 'Integration not found' });\r\n      return;\r\n    }\r\n\r\n    res.status(200).json({ success: true, message: `Int\u00E9gration ${platform} supprim\u00E9e avec succ\u00E8s` });\r\n  } catch (error) {\r\n    console.error('Failed to delete platform integration:', error);\r\n    res.status(500).json({ success: false, message: 'Failed to delete integration' });\r\n  }\r\n});\r\n/**\r\n * S\u00E9lectionner un compte pour une int\u00E9gration publicitaire\r\n * POST /api/integrations/advertising/:platform/select-account\r\n * body: { account: { id: string; name?: string; currency?: string } }\r\n */\r\nrouter.post('/advertising/:platform/select-account', async (req: Request, res: Response) => {\r\n  try {\r\n    const platform = req.params.platform as 'google_ads' | 'meta_ads';\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) return res.status(400).json({ success: false, message: 'Organisation requise' });\r\n\r\n    const { account } = req.body as { account?: { id?: string; name?: string; currency?: string } };\r\n    if (!account || !account.id) {\r\n      return res.status(400).json({ success: false, message: 'Compte invalide' });\r\n    }\r\n\r\n    const integ = await prisma.adPlatformIntegration.findFirst({ where: { organizationId, platform } });\r\n    if (!integ) return res.status(404).json({ success: false, message: 'Int\u00E9gration non trouv\u00E9e' });\r\n\r\n    const currentConfig = (integ.config as unknown) as Record<string, unknown> | null;\r\n    const newConfig: Record<string, unknown> = { ...(currentConfig || {}), selectedAccount: { id: account.id, name: account.name, currency: account.currency } };\r\n\r\n    // Optionnel: si le nom est g\u00E9n\u00E9rique, on l\u2019enrichit avec le nom du compte\r\n    let newName = integ.name;\r\n    const genericNames = new Set<string>(['google_ads', 'meta_ads', 'Google Ads OAuth', 'Meta Ads OAuth']);\r\n    if (!newName || genericNames.has(newName)) {\r\n      newName = `${platform} - ${account.name || account.id}`;\r\n    }\r\n\r\n    await prisma.adPlatformIntegration.update({\r\n      where: { id: integ.id },\r\n      data: { config: newConfig, name: newName, updatedAt: new Date() }\r\n    });\r\n\r\n    return res.json({ success: true, platform, selectedAccount: { id: account.id, name: account.name, currency: account.currency } });\r\n  } catch (error) {\r\n    console.error('Erreur select account:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur s\u00E9lection compte' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/integrations/advertising\r\n * Cr\u00E9e une nouvelle int\u00E9gration publicitaire\r\n */\r\nrouter.post('/advertising', async (req, res) => {\r\n  try {\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organisation requise' });\r\n    }\r\n\r\n    const { platform, name, config, credentials } = req.body;\r\n\r\n    if (!platform || !name || !config || !credentials) {\r\n      return res.status(400).json({ \r\n        error: 'Plateforme, nom, configuration et identifiants requis' \r\n      });\r\n    }\r\n\r\n    if (!AD_PLATFORMS[platform]) {\r\n      return res.status(400).json({ \r\n        error: 'Plateforme publicitaire non support\u00E9e' \r\n      });\r\n    }\r\n\r\n    const integration = await AdPlatformService.createIntegration(\r\n      organizationId,\r\n      platform,\r\n      name,\r\n      config,\r\n      credentials\r\n    );\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      integration\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur cr\u00E9ation int\u00E9gration publicitaire:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/integrations/ecommerce/platforms\r\n * R\u00E9cup\u00E8re la liste des plateformes e-commerce disponibles\r\n */\r\nrouter.get('/ecommerce/platforms', (req, res) => {\r\n  res.json({\r\n    success: true,\r\n    platforms: Object.values(ECOMMERCE_PLATFORMS)\r\n  });\r\n});\r\n\r\n/**\r\n * GET /api/integrations/ecommerce\r\n * R\u00E9cup\u00E8re toutes les int\u00E9grations e-commerce de l'organisation\r\n */\r\nrouter.get('/ecommerce', async (req, res) => {\r\n  try {\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organisation requise' });\r\n    }\r\n\r\n    const integrations = await EcommerceService.getIntegrations(organizationId);\r\n    res.json({\r\n      success: true,\r\n      integrations\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur r\u00E9cup\u00E9ration int\u00E9grations e-commerce:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/integrations/ecommerce\r\n * Cr\u00E9e une nouvelle int\u00E9gration e-commerce\r\n */\r\nrouter.post('/ecommerce', async (req, res) => {\r\n  try {\r\n    const organizationId = getEffectiveOrgId(req);\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organisation requise' });\r\n    }\r\n\r\n    const { platform, name, url, config, credentials } = req.body;\r\n\r\n    if (!platform || !name || !url || !config || !credentials) {\r\n      return res.status(400).json({ \r\n        error: 'Plateforme, nom, URL, configuration et identifiants requis' \r\n      });\r\n    }\r\n\r\n    if (!ECOMMERCE_PLATFORMS[platform]) {\r\n      return res.status(400).json({ \r\n        error: 'Plateforme e-commerce non support\u00E9e' \r\n      });\r\n    }\r\n\r\n    const integration = await EcommerceService.createIntegration(\r\n      organizationId,\r\n      platform,\r\n      name,\r\n      url,\r\n      config,\r\n      credentials\r\n    );\r\n\r\n    res.status(201).json({\r\n      success: true,\r\n      integration\r\n    });\r\n  } catch (error) {\r\n    console.error('Erreur cr\u00E9ation int\u00E9gration e-commerce:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "// Service d'int\u00E9gration publicitaire - Architecture scalable\r\nimport { prisma } from '../lib/prisma';\r\n\r\nexport interface AdPlatform {\r\n  id: string;\r\n  name: string;\r\n  displayName: string;\r\n  icon: string;\r\n  authUrl: string;\r\n  scopes: string[];\r\n  fields: AdPlatformField[];\r\n}\r\n\r\nexport interface AdPlatformField {\r\n  key: string;\r\n  label: string;\r\n  type: 'text' | 'select' | 'number' | 'boolean';\r\n  required: boolean;\r\n  options?: { value: string; label: string }[];\r\n}\r\n\r\nexport interface AdCampaignData {\r\n  name: string;\r\n  budget: number;\r\n  targetingData: Record<string, unknown>;\r\n  creativeData: Record<string, unknown>;\r\n  startDate?: Date;\r\n  endDate?: Date;\r\n}\r\n\r\nexport interface AdMetricsData {\r\n  impressions: number;\r\n  clicks: number;\r\n  conversions: number;\r\n  spend: number;\r\n  ctr: number;\r\n  cvr: number;\r\n  cpc: number;\r\n  cpl: number;\r\n  qualityScore?: number;\r\n}\r\n\r\n// Plateformes publicitaires support\u00E9es\r\nexport const AD_PLATFORMS: Record<string, AdPlatform> = {\r\n  google_ads: {\r\n    id: 'google_ads',\r\n    name: 'google_ads',\r\n    displayName: 'Google Ads',\r\n    icon: 'GoogleOutlined',\r\n    // URL de callback dynamique (\u00E9vite le hardcode localhost dans le bundle)\r\n    authUrl: ((): string => {\r\n      const env = (globalThis as any)?.process?.env || {};\r\n      const explicit = env.GOOGLE_ADS_REDIRECT || env.GOOGLE_REDIRECT_URI;\r\n      if (explicit) return explicit;\r\n      // Frontend build time variables (Vite)\r\n      const viteEnv: any = (import.meta as any)?.env || {};\r\n      const frontendBase = viteEnv.VITE_API_BASE_URL || viteEnv.API_URL || '';\r\n      if (frontendBase) return `${frontendBase.replace(/\\/$/, '')}/api/google-auth/callback`;\r\n      if (typeof window !== 'undefined') return `${window.location.origin}/api/google-auth/callback`;\r\n      return '/api/google-auth/callback';\r\n    })(),\r\n    scopes: [\r\n      'https://www.googleapis.com/auth/adwords'\r\n    ],\r\n    fields: [\r\n      {\r\n        key: 'account_id',\r\n        label: 'ID du compte Google Ads',\r\n        type: 'text',\r\n        required: true\r\n      },\r\n      {\r\n        key: 'customer_id',\r\n        label: 'ID client',\r\n        type: 'text',\r\n        required: true\r\n      }\r\n    ]\r\n  },\r\n  meta_ads: {\r\n    id: 'meta_ads',\r\n    name: 'meta_ads',\r\n    displayName: 'Meta Ads (Facebook/Instagram)',\r\n    icon: 'FacebookOutlined',\r\n    authUrl: 'https://www.facebook.com/v18.0/dialog/oauth',\r\n    scopes: [\r\n      'read_insights',\r\n      'pages_show_list',\r\n      'instagram_basic'\r\n    ],\r\n    fields: [\r\n      {\r\n        key: 'app_id',\r\n        label: 'App ID Facebook',\r\n        type: 'text',\r\n        required: true\r\n      },\r\n      {\r\n        key: 'business_account_id',\r\n        label: 'ID du compte Business Manager',\r\n        type: 'text',\r\n        required: true\r\n      }\r\n    ]\r\n  },\r\n  linkedin_ads: {\r\n    id: 'linkedin_ads',\r\n    name: 'linkedin_ads',\r\n    displayName: 'LinkedIn Ads',\r\n    icon: 'LinkedinOutlined',\r\n    authUrl: 'https://www.linkedin.com/oauth/v2/authorization',\r\n    scopes: [\r\n      'r_ads',\r\n      'rw_ads',\r\n      'r_organization_social'\r\n    ],\r\n    fields: [\r\n      {\r\n        key: 'organization_id',\r\n        label: 'ID de l\\'organisation LinkedIn',\r\n        type: 'text',\r\n        required: true\r\n      }\r\n    ]\r\n  },\r\n  tiktok_ads: {\r\n    id: 'tiktok_ads',\r\n    name: 'tiktok_ads',\r\n    displayName: 'TikTok Ads',\r\n    icon: 'TikTokOutlined',\r\n    authUrl: 'https://ads.tiktok.com/marketing_api/auth',\r\n    scopes: [\r\n      'advertiser_read',\r\n      'campaign_read',\r\n      'campaign_write'\r\n    ],\r\n    fields: [\r\n      {\r\n        key: 'advertiser_id',\r\n        label: 'ID de l\\'annonceur TikTok',\r\n        type: 'text',\r\n        required: true\r\n      }\r\n    ]\r\n  }\r\n};\r\n\r\nexport class AdPlatformService {\r\n  /**\r\n   * R\u00E9cup\u00E8re toutes les int\u00E9grations publicitaires d'une organisation\r\n   */\r\n  static async getIntegrations(organizationId: string) {\r\n    return prisma.adPlatformIntegration.findMany({\r\n      where: {\r\n        organizationId,\r\n        active: true\r\n      },\r\n      include: {\r\n        AdCampaign: {\r\n          include: {\r\n            AdMetrics: {\r\n              orderBy: {\r\n                date: 'desc'\r\n              },\r\n              take: 30 // 30 derniers jours\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Cr\u00E9e une nouvelle int\u00E9gration publicitaire\r\n   */\r\n  static async createIntegration(\r\n    organizationId: string,\r\n    platform: string,\r\n    name: string,\r\n    config: Record<string, unknown>,\r\n    credentials: Record<string, unknown>\r\n  ) {\r\n    return prisma.adPlatformIntegration.create({\r\n      data: {\r\n        organizationId,\r\n        platform,\r\n        name,\r\n        config,\r\n        credentials,\r\n        status: 'connected'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Met \u00E0 jour le statut d'une int\u00E9gration\r\n   */\r\n  static async updateIntegrationStatus(\r\n    integrationId: string,\r\n    status: 'connected' | 'disconnected' | 'error'\r\n  ) {\r\n    return prisma.adPlatformIntegration.update({\r\n      where: { id: integrationId },\r\n      data: {\r\n        status,\r\n        lastSync: new Date()\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Cr\u00E9e une nouvelle campagne publicitaire\r\n   */\r\n  static async createCampaign(\r\n    organizationId: string,\r\n    platformIntegrationId: string,\r\n    campaignData: AdCampaignData\r\n  ) {\r\n    return prisma.adCampaign.create({\r\n      data: {\r\n        organizationId,\r\n        platformIntegrationId,\r\n        ...campaignData\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Met \u00E0 jour les m\u00E9triques d'une campagne\r\n   */\r\n  static async updateCampaignMetrics(\r\n    campaignId: string,\r\n    date: Date,\r\n    metrics: AdMetricsData\r\n  ) {\r\n    return prisma.adMetrics.upsert({\r\n      where: {\r\n        campaignId_date: {\r\n          campaignId,\r\n          date\r\n        }\r\n      },\r\n      create: {\r\n        campaignId,\r\n        date,\r\n        ...metrics\r\n      },\r\n      update: {\r\n        ...metrics\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * R\u00E9cup\u00E8re les m\u00E9triques d'une campagne sur une p\u00E9riode\r\n   */\r\n  static async getCampaignMetrics(\r\n    campaignId: string,\r\n    startDate: Date,\r\n    endDate: Date\r\n  ) {\r\n    return prisma.adMetrics.findMany({\r\n      where: {\r\n        campaignId,\r\n        date: {\r\n          gte: startDate,\r\n          lte: endDate\r\n        }\r\n      },\r\n      orderBy: {\r\n        date: 'asc'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Calcule le ROI global d'une organisation\r\n   */\r\n  static async calculateOrganizationROI(organizationId: string) {\r\n    const campaigns = await prisma.adCampaign.findMany({\r\n      where: {\r\n        organizationId\r\n      },\r\n      include: {\r\n        AdMetrics: true\r\n      }\r\n    });\r\n\r\n    let totalSpent = 0;\r\n    let totalRevenue = 0;\r\n    let totalLeads = 0;\r\n\r\n    for (const campaign of campaigns) {\r\n      for (const metric of campaign.AdMetrics) {\r\n        totalSpent += Number(metric.spend);\r\n        totalLeads += metric.conversions;\r\n      }\r\n    }\r\n\r\n    // Estimation de la revenue bas\u00E9e sur les leads convertis\r\n    // \u00C0 adapter selon le mod\u00E8le business de chaque organisation\r\n    const avgLeadValue = 500; // Valeur moyenne d'un lead en euros\r\n    totalRevenue = totalLeads * avgLeadValue;\r\n\r\n    const roi = totalSpent > 0 ? ((totalRevenue - totalSpent) / totalSpent) * 100 : 0;\r\n\r\n    return {\r\n      totalSpent,\r\n      totalRevenue,\r\n      totalLeads,\r\n      roi,\r\n      avgCostPerLead: totalLeads > 0 ? totalSpent / totalLeads : 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Synchronise les donn\u00E9es depuis les APIs externes\r\n   */\r\n  static async syncPlatformData(integrationId: string) {\r\n    const integration = await prisma.adPlatformIntegration.findUnique({\r\n      where: { id: integrationId },\r\n      include: {\r\n        AdCampaign: true\r\n      }\r\n    });\r\n\r\n    if (!integration) {\r\n      throw new Error('Int\u00E9gration non trouv\u00E9e');\r\n    }\r\n\r\n    try {\r\n      // Synchronisation sp\u00E9cifique selon la plateforme\r\n      switch (integration.platform) {\r\n        case 'google_ads':\r\n          await this.syncGoogleAds(integration);\r\n          break;\r\n        case 'meta_ads':\r\n          await this.syncMetaAds(integration);\r\n          break;\r\n        case 'linkedin_ads':\r\n          await this.syncLinkedInAds(integration);\r\n          break;\r\n        case 'tiktok_ads':\r\n          await this.syncTikTokAds(integration);\r\n          break;\r\n      }\r\n\r\n      // Enregistrement de l'\u00E9v\u00E9nement analytique\r\n      await prisma.analyticsEvent.create({\r\n        data: {\r\n          organizationId: integration.organizationId,\r\n          eventType: 'platform_sync_completed',\r\n          source: 'advertising',\r\n          sourceId: integrationId,\r\n          data: {\r\n            platform: integration.platform,\r\n            campaignCount: integration.AdCampaign.length\r\n          }\r\n        }\r\n      });\r\n\r\n      await this.updateIntegrationStatus(integrationId, 'connected');\r\n    } catch (error) {\r\n      await this.updateIntegrationStatus(integrationId, 'error');\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Synchronisation Google Ads (\u00E0 impl\u00E9menter)\r\n   */\r\n  private static async syncGoogleAds(integration: { id: string; name: string; platform: string; organizationId: string }) {\r\n    // TODO: Impl\u00E9menter l'API Google Ads\r\n    console.log('Synchronisation Google Ads pour:', integration.name);\r\n  }\r\n\r\n  /**\r\n   * Synchronisation Meta Ads (\u00E0 impl\u00E9menter)\r\n   */\r\n  private static async syncMetaAds(integration: { id: string; name: string; platform: string; organizationId: string }) {\r\n    // TODO: Impl\u00E9menter l'API Facebook Marketing\r\n    console.log('Synchronisation Meta Ads pour:', integration.name);\r\n  }\r\n\r\n  /**\r\n   * Synchronisation LinkedIn Ads (\u00E0 impl\u00E9menter)\r\n   */\r\n  private static async syncLinkedInAds(integration: { id: string; name: string; platform: string; organizationId: string }) {\r\n    // TODO: Impl\u00E9menter l'API LinkedIn Marketing\r\n    console.log('Synchronisation LinkedIn Ads pour:', integration.name);\r\n  }\r\n\r\n  /**\r\n   * Synchronisation TikTok Ads (\u00E0 impl\u00E9menter)\r\n   */\r\n  private static async syncTikTokAds(integration: { id: string; name: string; platform: string; organizationId: string }) {\r\n    // TODO: Impl\u00E9menter l'API TikTok for Business\r\n    console.log('Synchronisation TikTok Ads pour:', integration.name);\r\n  }\r\n}\r\n", "// Service d'int\u00E9gration e-commerce - Architecture scalable\r\nimport { prisma } from '../lib/prisma';\r\n\r\nexport interface EcommercePlatform {\r\n  id: string;\r\n  name: string;\r\n  displayName: string;\r\n  icon: string;\r\n  fields: EcommercePlatformField[];\r\n  webhookSupport: boolean;\r\n}\r\n\r\nexport interface EcommercePlatformField {\r\n  key: string;\r\n  label: string;\r\n  type: 'text' | 'url' | 'password' | 'select';\r\n  required: boolean;\r\n  placeholder?: string;\r\n  options?: { value: string; label: string }[];\r\n}\r\n\r\nexport interface ProductData {\r\n  externalId?: string;\r\n  name: string;\r\n  description?: string;\r\n  category?: string;\r\n  price: number;\r\n  currency?: string;\r\n  stock?: number;\r\n  sku?: string;\r\n  images?: string[];\r\n  metadata?: Record<string, unknown>;\r\n  status?: 'active' | 'inactive' | 'archived';\r\n}\r\n\r\nexport interface OrderData {\r\n  externalId?: string;\r\n  orderNumber: string;\r\n  customerName: string;\r\n  customerEmail: string;\r\n  customerPhone?: string;\r\n  billingAddress?: Record<string, unknown>;\r\n  shippingAddress?: Record<string, unknown>;\r\n  totalAmount: number;\r\n  currency?: string;\r\n  status?: 'pending' | 'confirmed' | 'shipped' | 'delivered' | 'cancelled';\r\n  paymentStatus?: 'pending' | 'paid' | 'failed' | 'refunded';\r\n  items: OrderItem[];\r\n  metadata?: Record<string, unknown>;\r\n  orderDate?: Date;\r\n}\r\n\r\nexport interface OrderItem {\r\n  productId?: string;\r\n  name: string;\r\n  quantity: number;\r\n  price: number;\r\n  sku?: string;\r\n}\r\n\r\n// Plateformes e-commerce support\u00E9es\r\nexport const ECOMMERCE_PLATFORMS: Record<string, EcommercePlatform> = {\r\n  shopify: {\r\n    id: 'shopify',\r\n    name: 'shopify',\r\n    displayName: 'Shopify',\r\n    icon: 'ShopOutlined',\r\n    webhookSupport: true,\r\n    fields: [\r\n      {\r\n        key: 'shop_domain',\r\n        label: 'Domaine de la boutique',\r\n        type: 'url',\r\n        required: true,\r\n        placeholder: 'https://votre-boutique.myshopify.com'\r\n      },\r\n      {\r\n        key: 'access_token',\r\n        label: 'Token d\\'acc\u00E8s priv\u00E9',\r\n        type: 'password',\r\n        required: true\r\n      },\r\n      {\r\n        key: 'webhook_secret',\r\n        label: 'Secret webhook',\r\n        type: 'password',\r\n        required: false\r\n      }\r\n    ]\r\n  },\r\n  woocommerce: {\r\n    id: 'woocommerce',\r\n    name: 'woocommerce',\r\n    displayName: 'WooCommerce',\r\n    icon: 'ShoppingCartOutlined',\r\n    webhookSupport: true,\r\n    fields: [\r\n      {\r\n        key: 'site_url',\r\n        label: 'URL du site WordPress',\r\n        type: 'url',\r\n        required: true,\r\n        placeholder: 'https://votre-site.com'\r\n      },\r\n      {\r\n        key: 'consumer_key',\r\n        label: 'Cl\u00E9 consommateur',\r\n        type: 'text',\r\n        required: true\r\n      },\r\n      {\r\n        key: 'consumer_secret',\r\n        label: 'Secret consommateur',\r\n        type: 'password',\r\n        required: true\r\n      }\r\n    ]\r\n  },\r\n  prestashop: {\r\n    id: 'prestashop',\r\n    name: 'prestashop',\r\n    displayName: 'PrestaShop',\r\n    icon: 'ShopOutlined',\r\n    webhookSupport: false,\r\n    fields: [\r\n      {\r\n        key: 'shop_url',\r\n        label: 'URL de la boutique',\r\n        type: 'url',\r\n        required: true,\r\n        placeholder: 'https://votre-boutique.com'\r\n      },\r\n      {\r\n        key: 'webservice_key',\r\n        label: 'Cl\u00E9 webservice',\r\n        type: 'password',\r\n        required: true\r\n      }\r\n    ]\r\n  },\r\n  magento: {\r\n    id: 'magento',\r\n    name: 'magento',\r\n    displayName: 'Magento',\r\n    icon: 'ShoppingOutlined',\r\n    webhookSupport: true,\r\n    fields: [\r\n      {\r\n        key: 'store_url',\r\n        label: 'URL du magasin',\r\n        type: 'url',\r\n        required: true,\r\n        placeholder: 'https://votre-magasin.com'\r\n      },\r\n      {\r\n        key: 'access_token',\r\n        label: 'Token d\\'acc\u00E8s admin',\r\n        type: 'password',\r\n        required: true\r\n      }\r\n    ]\r\n  },\r\n  custom: {\r\n    id: 'custom',\r\n    name: 'custom',\r\n    displayName: 'API personnalis\u00E9e',\r\n    icon: 'ApiOutlined',\r\n    webhookSupport: true,\r\n    fields: [\r\n      {\r\n        key: 'api_url',\r\n        label: 'URL de l\\'API',\r\n        type: 'url',\r\n        required: true,\r\n        placeholder: 'https://api.votre-boutique.com'\r\n      },\r\n      {\r\n        key: 'api_key',\r\n        label: 'Cl\u00E9 API',\r\n        type: 'password',\r\n        required: true\r\n      },\r\n      {\r\n        key: 'auth_type',\r\n        label: 'Type d\\'authentification',\r\n        type: 'select',\r\n        required: true,\r\n        options: [\r\n          { value: 'bearer', label: 'Bearer Token' },\r\n          { value: 'basic', label: 'Basic Auth' },\r\n          { value: 'api_key', label: 'API Key' }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n};\r\n\r\nexport class EcommerceService {\r\n  /**\r\n   * R\u00E9cup\u00E8re toutes les int\u00E9grations e-commerce d'une organisation\r\n   */\r\n  static async getIntegrations(organizationId: string) {\r\n    return prisma.ecommerceIntegration.findMany({\r\n      where: {\r\n        organizationId,\r\n        active: true\r\n      },\r\n      include: {\r\n        Product: {\r\n          where: {\r\n            status: 'active'\r\n          }\r\n        },\r\n        Order: {\r\n          orderBy: {\r\n            orderDate: 'desc'\r\n          },\r\n          take: 10 // 10 derni\u00E8res commandes\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Cr\u00E9e une nouvelle int\u00E9gration e-commerce\r\n   */\r\n  static async createIntegration(\r\n    organizationId: string,\r\n    platform: string,\r\n    name: string,\r\n    url: string,\r\n    config: Record<string, unknown>,\r\n    credentials: Record<string, unknown>\r\n  ) {\r\n    return prisma.ecommerceIntegration.create({\r\n      data: {\r\n        organizationId,\r\n        platform,\r\n        name,\r\n        url,\r\n        config,\r\n        credentials,\r\n        status: 'connected'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Test de connexion \u00E0 une int\u00E9gration\r\n   */\r\n  static async testConnection(integrationId: string) {\r\n    const integration = await prisma.ecommerceIntegration.findUnique({\r\n      where: { id: integrationId }\r\n    });\r\n\r\n    if (!integration) {\r\n      throw new Error('Int\u00E9gration non trouv\u00E9e');\r\n    }\r\n\r\n    try {\r\n      // Test sp\u00E9cifique selon la plateforme\r\n      let isConnected = false;\r\n      \r\n      switch (integration.platform) {\r\n        case 'shopify':\r\n          isConnected = await this.testShopifyConnection(integration);\r\n          break;\r\n        case 'woocommerce':\r\n          isConnected = await this.testWooCommerceConnection(integration);\r\n          break;\r\n        case 'prestashop':\r\n          isConnected = await this.testPrestaShopConnection(integration);\r\n          break;\r\n        case 'magento':\r\n          isConnected = await this.testMagentoConnection(integration);\r\n          break;\r\n        case 'custom':\r\n          isConnected = await this.testCustomConnection(integration);\r\n          break;\r\n      }\r\n\r\n      const status = isConnected ? 'connected' : 'error';\r\n      \r\n      await prisma.ecommerceIntegration.update({\r\n        where: { id: integrationId },\r\n        data: {\r\n          status,\r\n          lastSync: new Date()\r\n        }\r\n      });\r\n\r\n      return { connected: isConnected, status };\r\n    } catch (error) {\r\n      await prisma.ecommerceIntegration.update({\r\n        where: { id: integrationId },\r\n        data: {\r\n          status: 'error',\r\n          lastSync: new Date()\r\n        }\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Synchronise les produits depuis la plateforme e-commerce\r\n   */\r\n  static async syncProducts(integrationId: string) {\r\n    const integration = await prisma.ecommerceIntegration.findUnique({\r\n      where: { id: integrationId }\r\n    });\r\n\r\n    if (!integration) {\r\n      throw new Error('Int\u00E9gration non trouv\u00E9e');\r\n    }\r\n\r\n    let products: ProductData[] = [];\r\n\r\n    switch (integration.platform) {\r\n      case 'shopify':\r\n        products = await this.fetchShopifyProducts(integration);\r\n        break;\r\n      case 'woocommerce':\r\n        products = await this.fetchWooCommerceProducts(integration);\r\n        break;\r\n      case 'prestashop':\r\n        products = await this.fetchPrestaShopProducts(integration);\r\n        break;\r\n      case 'magento':\r\n        products = await this.fetchMagentoProducts(integration);\r\n        break;\r\n      case 'custom':\r\n        products = await this.fetchCustomProducts(integration);\r\n        break;\r\n    }\r\n\r\n    // Sauvegarde des produits en base\r\n    for (const productData of products) {\r\n      await prisma.product.upsert({\r\n        where: {\r\n          organizationId_externalId: {\r\n            organizationId: integration.organizationId,\r\n            externalId: productData.externalId || ''\r\n          }\r\n        },\r\n        create: {\r\n          organizationId: integration.organizationId,\r\n          ecommerceIntegrationId: integrationId,\r\n          ...productData,\r\n          images: JSON.stringify(productData.images || []),\r\n          metadata: JSON.stringify(productData.metadata || {})\r\n        },\r\n        update: {\r\n          ...productData,\r\n          images: JSON.stringify(productData.images || []),\r\n          metadata: JSON.stringify(productData.metadata || {})\r\n        }\r\n      });\r\n    }\r\n\r\n    // Enregistrement de l'\u00E9v\u00E9nement analytique\r\n    await prisma.analyticsEvent.create({\r\n      data: {\r\n        organizationId: integration.organizationId,\r\n        eventType: 'products_synced',\r\n        source: 'ecommerce',\r\n        sourceId: integrationId,\r\n        data: {\r\n          platform: integration.platform,\r\n          productCount: products.length\r\n        }\r\n      }\r\n    });\r\n\r\n    return products.length;\r\n  }\r\n\r\n  /**\r\n   * Synchronise les commandes depuis la plateforme e-commerce\r\n   */\r\n  static async syncOrders(integrationId: string, fromDate?: Date) {\r\n    const integration = await prisma.ecommerceIntegration.findUnique({\r\n      where: { id: integrationId }\r\n    });\r\n\r\n    if (!integration) {\r\n      throw new Error('Int\u00E9gration non trouv\u00E9e');\r\n    }\r\n\r\n    let orders: OrderData[] = [];\r\n\r\n    switch (integration.platform) {\r\n      case 'shopify':\r\n        orders = await this.fetchShopifyOrders(integration, fromDate);\r\n        break;\r\n      case 'woocommerce':\r\n        orders = await this.fetchWooCommerceOrders(integration, fromDate);\r\n        break;\r\n      case 'prestashop':\r\n        orders = await this.fetchPrestaShopOrders(integration, fromDate);\r\n        break;\r\n      case 'magento':\r\n        orders = await this.fetchMagentoOrders(integration, fromDate);\r\n        break;\r\n      case 'custom':\r\n        orders = await this.fetchCustomOrders(integration, fromDate);\r\n        break;\r\n    }\r\n\r\n    // Sauvegarde des commandes en base\r\n    for (const orderData of orders) {\r\n      await prisma.order.upsert({\r\n        where: {\r\n          organizationId_externalId: {\r\n            organizationId: integration.organizationId,\r\n            externalId: orderData.externalId || ''\r\n          }\r\n        },\r\n        create: {\r\n          organizationId: integration.organizationId,\r\n          ecommerceIntegrationId: integrationId,\r\n          ...orderData,\r\n          billingAddress: JSON.stringify(orderData.billingAddress || {}),\r\n          shippingAddress: JSON.stringify(orderData.shippingAddress || {}),\r\n          items: JSON.stringify(orderData.items || []),\r\n          metadata: JSON.stringify(orderData.metadata || {})\r\n        },\r\n        update: {\r\n          ...orderData,\r\n          billingAddress: JSON.stringify(orderData.billingAddress || {}),\r\n          shippingAddress: JSON.stringify(orderData.shippingAddress || {}),\r\n          items: JSON.stringify(orderData.items || []),\r\n          metadata: JSON.stringify(orderData.metadata || {})\r\n        }\r\n      });\r\n\r\n      // Cr\u00E9er un \u00E9v\u00E9nement analytique pour chaque nouvelle commande\r\n      await prisma.analyticsEvent.create({\r\n        data: {\r\n          organizationId: integration.organizationId,\r\n          eventType: 'order_placed',\r\n          source: 'ecommerce',\r\n          sourceId: orderData.externalId || '',\r\n          data: {\r\n            platform: integration.platform,\r\n            orderNumber: orderData.orderNumber,\r\n            customerEmail: orderData.customerEmail\r\n          },\r\n          value: orderData.totalAmount\r\n        }\r\n      });\r\n    }\r\n\r\n    return orders.length;\r\n  }\r\n\r\n  // Tests de connexion (\u00E0 impl\u00E9menter)\r\n  private static async testShopifyConnection(integration: { url: string; credentials: any }): Promise<boolean> {\r\n    // TODO: Impl\u00E9menter test Shopify\r\n    console.log('Test connexion Shopify:', integration.url);\r\n    return true;\r\n  }\r\n\r\n  private static async testWooCommerceConnection(integration: { url: string; credentials: any }): Promise<boolean> {\r\n    // TODO: Impl\u00E9menter test WooCommerce\r\n    console.log('Test connexion WooCommerce:', integration.url);\r\n    return true;\r\n  }\r\n\r\n  private static async testPrestaShopConnection(integration: { url: string; credentials: any }): Promise<boolean> {\r\n    // TODO: Impl\u00E9menter test PrestaShop\r\n    console.log('Test connexion PrestaShop:', integration.url);\r\n    return true;\r\n  }\r\n\r\n  private static async testMagentoConnection(integration: { url: string; credentials: any }): Promise<boolean> {\r\n    // TODO: Impl\u00E9menter test Magento\r\n    console.log('Test connexion Magento:', integration.url);\r\n    return true;\r\n  }\r\n\r\n  private static async testCustomConnection(integration: { url: string; credentials: any }): Promise<boolean> {\r\n    // TODO: Impl\u00E9menter test API personnalis\u00E9e\r\n    console.log('Test connexion API personnalis\u00E9e:', integration.url);\r\n    return true;\r\n  }\r\n\r\n  // R\u00E9cup\u00E9ration des produits (\u00E0 impl\u00E9menter)\r\n  private static async fetchShopifyProducts(integration: any): Promise<ProductData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration produits Shopify\r\n    console.warn('\uD83D\uDECD\uFE0F [Ecommerce] fetchShopifyProducts non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown'\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchWooCommerceProducts(integration: any): Promise<ProductData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration produits WooCommerce\r\n    console.warn('\uD83D\uDECD\uFE0F [Ecommerce] fetchWooCommerceProducts non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown'\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchPrestaShopProducts(integration: any): Promise<ProductData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration produits PrestaShop\r\n    console.warn('\uD83D\uDECD\uFE0F [Ecommerce] fetchPrestaShopProducts non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown'\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchMagentoProducts(integration: any): Promise<ProductData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration produits Magento\r\n    console.warn('\uD83D\uDECD\uFE0F [Ecommerce] fetchMagentoProducts non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown'\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchCustomProducts(integration: any): Promise<ProductData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration produits API personnalis\u00E9e\r\n    console.warn('\uD83D\uDECD\uFE0F [Ecommerce] fetchCustomProducts non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown'\r\n    });\r\n    return [];\r\n  }\r\n\r\n  // R\u00E9cup\u00E9ration des commandes (\u00E0 impl\u00E9menter)\r\n  private static async fetchShopifyOrders(integration: any, fromDate?: Date): Promise<OrderData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration commandes Shopify\r\n    console.warn('\uD83D\uDED2 [Ecommerce] fetchShopifyOrders non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown',\r\n      fromDate: fromDate?.toISOString() ?? null\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchWooCommerceOrders(integration: any, fromDate?: Date): Promise<OrderData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration commandes WooCommerce\r\n    console.warn('\uD83D\uDED2 [Ecommerce] fetchWooCommerceOrders non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown',\r\n      fromDate: fromDate?.toISOString() ?? null\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchPrestaShopOrders(integration: any, fromDate?: Date): Promise<OrderData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration commandes PrestaShop\r\n    console.warn('\uD83D\uDED2 [Ecommerce] fetchPrestaShopOrders non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown',\r\n      fromDate: fromDate?.toISOString() ?? null\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchMagentoOrders(integration: any, fromDate?: Date): Promise<OrderData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration commandes Magento\r\n    console.warn('\uD83D\uDED2 [Ecommerce] fetchMagentoOrders non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown',\r\n      fromDate: fromDate?.toISOString() ?? null\r\n    });\r\n    return [];\r\n  }\r\n\r\n  private static async fetchCustomOrders(integration: any, fromDate?: Date): Promise<OrderData[]> {\r\n    // TODO: Impl\u00E9menter r\u00E9cup\u00E9ration commandes API personnalis\u00E9e\r\n    console.warn('\uD83D\uDED2 [Ecommerce] fetchCustomOrders non impl\u00E9ment\u00E9', {\r\n      integrationId: integration?.id ?? integration?.url ?? 'unknown',\r\n      fromDate: fromDate?.toISOString() ?? null\r\n    });\r\n    return [];\r\n  }\r\n}\r\n", "/**\r\n * Routes publiques pour l'API Devis1Minute\r\n * Endpoints accessibles sans authentification pour la capture de leads\r\n */\r\n\r\nimport { Router } from 'express';\r\nimport { rateLimit } from 'express-rate-limit';\r\nimport { body, validationResult } from 'express-validator';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { GoogleGeminiService } from '../services/GoogleGeminiService.js';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\nconst geminiService = new GoogleGeminiService();\r\n\r\n// Configuration rate limiting pour l'API publique\r\nconst publicRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000, // 15 minutes\r\n  max: 10, // Max 10 requ\u00EAtes par IP par fen\u00EAtre\r\n  message: {\r\n    error: 'Trop de requ\u00EAtes. Veuillez patienter avant de r\u00E9essayer.',\r\n    retryAfter: '15 minutes'\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  handler: (req, res) => {\r\n    console.log(`[RATE-LIMIT] IP bloqu\u00E9e: ${req.ip}`);\r\n    res.status(429).json({\r\n      error: 'Trop de requ\u00EAtes. Veuillez patienter avant de r\u00E9essayer.',\r\n      retryAfter: '15 minutes'\r\n    });\r\n  }\r\n});\r\n\r\n// Configuration rate limiting plus stricte pour la cr\u00E9ation de leads\r\nconst leadCreationLimit = rateLimit({\r\n  windowMs: 5 * 60 * 1000, // 5 minutes\r\n  max: 3, // Max 3 leads par IP par 5 minutes\r\n  message: {\r\n    error: 'Limite de cr\u00E9ation de demandes atteinte. Veuillez patienter.',\r\n    retryAfter: '5 minutes'\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false\r\n});\r\n\r\n// Validation des donn\u00E9es de lead\r\nconst validateLead = [\r\n  body('projectType')\r\n    .isIn(['website', 'ecommerce', 'app', 'branding', 'marketing', 'consulting', 'other'])\r\n    .withMessage('Type de projet invalide'),\r\n  \r\n  body('projectDescription')\r\n    .isLength({ min: 10, max: 1000 })\r\n    .withMessage('Description du projet entre 10 et 1000 caract\u00E8res'),\r\n  \r\n  body('budget')\r\n    .isInt({ min: 500, max: 100000 })\r\n    .withMessage('Budget entre 500\u20AC et 100,000\u20AC'),\r\n  \r\n  body('timeline')\r\n    .isIn(['urgent', '1-3 mois', '3-6 mois', '6+ mois'])\r\n    .withMessage('Timeline invalide'),\r\n  \r\n  body('businessType')\r\n    .isIn(['startup', 'PME', 'grande-entreprise', 'association', 'particulier'])\r\n    .withMessage('Type d\\'entreprise invalide'),\r\n  \r\n  body('firstName')\r\n    .isLength({ min: 2, max: 50 })\r\n    .matches(/^[a-zA-Z\u00C0-\u00FF\\s-']+$/)\r\n    .withMessage('Pr\u00E9nom invalide'),\r\n  \r\n  body('lastName')\r\n    .isLength({ min: 2, max: 50 })\r\n    .matches(/^[a-zA-Z\u00C0-\u00FF\\s-']+$/)\r\n    .withMessage('Nom de famille invalide'),\r\n  \r\n  body('email')\r\n    .isEmail()\r\n    .normalizeEmail()\r\n    .withMessage('Adresse email invalide'),\r\n  \r\n  body('phone')\r\n    .matches(/^(\\+32|0)[1-9][0-9]{7,8}$/)\r\n    .withMessage('Num\u00E9ro de t\u00E9l\u00E9phone belge invalide'),\r\n  \r\n  body('company')\r\n    .optional()\r\n    .isLength({ max: 100 })\r\n    .withMessage('Nom d\\'entreprise trop long'),\r\n  \r\n  body('city')\r\n    .isLength({ min: 2, max: 50 })\r\n    .withMessage('Ville invalide'),\r\n  \r\n  body('acceptsMarketing')\r\n    .isBoolean()\r\n    .withMessage('Consentement marketing requis'),\r\n  \r\n  body('rgpdConsent')\r\n    .equals('true')\r\n    .withMessage('Le consentement RGPD est obligatoire')\r\n];\r\n\r\n// Interface pour les donn\u00E9es de lead\r\ninterface LeadData {\r\n  projectType: string;\r\n  projectDescription: string;\r\n  budget: number;\r\n  timeline: string;\r\n  businessType: string;\r\n  city: string;\r\n  firstName?: string;\r\n  lastName?: string;\r\n  email?: string;\r\n  phone?: string;\r\n  company?: string;\r\n  targetAudience?: string;\r\n  goals?: string[];\r\n  additionalServices?: string[];\r\n  acceptsMarketing?: boolean;\r\n  rgpdConsent?: boolean;\r\n}\r\n\r\n// Fonction de calcul du score de lead avec IA\r\nasync function calculateLeadScore(leadData: LeadData): Promise<number> {\r\n  try {\r\n    const prompt = `\r\n    \u00C9value cette demande de devis et donne un score de qualit\u00E9 entre 1 et 100:\r\n\r\n    Type de projet: ${leadData.projectType}\r\n    Description: ${leadData.projectDescription}\r\n    Budget: ${leadData.budget}\u20AC\r\n    Timeline: ${leadData.timeline}\r\n    Type d'entreprise: ${leadData.businessType}\r\n    Ville: ${leadData.city}\r\n\r\n    Crit\u00E8res d'\u00E9valuation:\r\n    - Coh\u00E9rence budget/projet (30%)\r\n    - Clart\u00E9 de la description (25%)\r\n    - Urgence du timeline (20%)\r\n    - Type d'entreprise (15%)\r\n    - Localisation Belgique (10%)\r\n\r\n    R\u00E9ponds uniquement par un nombre entre 1 et 100.\r\n    `;\r\n\r\n    const response = await geminiService.generateText(prompt);\r\n    const score = parseInt(response.trim());\r\n    \r\n    return isNaN(score) ? 50 : Math.max(1, Math.min(100, score));\r\n  } catch (error) {\r\n    console.error('[GEMINI-SCORE] Erreur calcul score:', error);\r\n    return 50; // Score par d\u00E9faut en cas d'erreur\r\n  }\r\n}\r\n\r\n// Routes publiques\r\n\r\n/**\r\n * GET /api/public/health\r\n * Health check de l'API publique\r\n */\r\nrouter.get('/health', (req, res) => {\r\n  res.json({\r\n    status: 'healthy',\r\n    service: 'Devis1Minute Public API',\r\n    version: '1.0.0',\r\n    timestamp: new Date().toISOString(),\r\n    endpoints: {\r\n      leads: '/api/public/leads',\r\n      stats: '/api/public/stats',\r\n      categories: '/api/public/categories'\r\n    }\r\n  });\r\n});\r\n\r\n/**\r\n * GET /api/public/stats\r\n * Statistiques publiques pour la page d'accueil\r\n */\r\nrouter.get('/stats', publicRateLimit, async (req, res) => {\r\n  try {\r\n    const stats = await prisma.$transaction(async (tx) => {\r\n      const totalLeads = await tx.lead.count();\r\n      const recentLeads = await tx.lead.count({\r\n        where: {\r\n          createdAt: {\r\n            gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) // 30 jours\r\n          }\r\n        }\r\n      });\r\n\r\n      return {\r\n        totalLeads: totalLeads || 1247, // Valeur par d\u00E9faut pour l'effet\r\n        successRate: 92, // Pourcentage fixe optimiste\r\n        averageResponseTime: '2h', // D\u00E9lai de r\u00E9ponse moyen\r\n        clientsServed: Math.floor(totalLeads * 0.8) || 998,\r\n        monthlyGrowth: recentLeads > 0 ? 15 : 12 // Croissance mensuelle\r\n      };\r\n    });\r\n\r\n    res.json(stats);\r\n  } catch (error) {\r\n    console.error('[PUBLIC-STATS] Erreur:', error);\r\n    res.json({\r\n      totalLeads: 1247,\r\n      successRate: 92,\r\n      averageResponseTime: '2h',\r\n      clientsServed: 998,\r\n      monthlyGrowth: 15\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/public/categories\r\n * Cat\u00E9gories de services disponibles\r\n */\r\nrouter.get('/categories', publicRateLimit, (req, res) => {\r\n  const categories = [\r\n    {\r\n      id: 'website',\r\n      name: 'Site Web',\r\n      description: 'Sites vitrine, corporate et institutionnels',\r\n      icon: 'GlobalOutlined',\r\n      estimatedPrice: '1,500 - 8,000\u20AC',\r\n      deliveryTime: '2-6 semaines'\r\n    },\r\n    {\r\n      id: 'ecommerce',\r\n      name: 'E-commerce',\r\n      description: 'Boutiques en ligne et places de march\u00E9',\r\n      icon: 'ShoppingCartOutlined',\r\n      estimatedPrice: '3,000 - 15,000\u20AC',\r\n      deliveryTime: '4-10 semaines'\r\n    },\r\n    {\r\n      id: 'app',\r\n      name: 'Application Mobile',\r\n      description: 'Apps iOS et Android natives et hybrides',\r\n      icon: 'MobileOutlined',\r\n      estimatedPrice: '5,000 - 25,000\u20AC',\r\n      deliveryTime: '8-16 semaines'\r\n    },\r\n    {\r\n      id: 'branding',\r\n      name: 'Identit\u00E9 Visuelle',\r\n      description: 'Logo, charte graphique, supports print',\r\n      icon: 'BgColorsOutlined',\r\n      estimatedPrice: '800 - 3,500\u20AC',\r\n      deliveryTime: '1-4 semaines'\r\n    },\r\n    {\r\n      id: 'marketing',\r\n      name: 'Marketing Digital',\r\n      description: 'SEO, SEM, r\u00E9seaux sociaux, email marketing',\r\n      icon: 'TrophyOutlined',\r\n      estimatedPrice: '500 - 2,500\u20AC/mois',\r\n      deliveryTime: 'Continu'\r\n    },\r\n    {\r\n      id: 'consulting',\r\n      name: 'Conseil Digital',\r\n      description: 'Strat\u00E9gie, audit, accompagnement',\r\n      icon: 'BulbOutlined',\r\n      estimatedPrice: '150 - 800\u20AC/jour',\r\n      deliveryTime: 'Sur mesure'\r\n    }\r\n  ];\r\n\r\n  res.json(categories);\r\n});\r\n\r\n/**\r\n * POST /api/public/leads\r\n * Cr\u00E9ation d'un nouveau lead depuis le formulaire public\r\n */\r\nrouter.post('/leads', leadCreationLimit, validateLead, async (req, res) => {\r\n  try {\r\n    // V\u00E9rifier les erreurs de validation\r\n    const errors = validationResult(req);\r\n    if (!errors.isEmpty()) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Donn\u00E9es invalides',\r\n        details: errors.array()\r\n      });\r\n    }\r\n\r\n    const leadData = req.body;\r\n    const clientIp = req.ip || req.connection.remoteAddress;\r\n\r\n    console.log(`[PUBLIC-LEAD] Nouvelle demande depuis ${clientIp}`);\r\n    console.log(`[PUBLIC-LEAD] Projet: ${leadData.projectType} - Budget: ${leadData.budget}\u20AC`);\r\n\r\n    // V\u00E9rifier les doublons r\u00E9cents (m\u00EAme email dans les 24h)\r\n    const existingLead = await prisma.lead.findFirst({\r\n      where: {\r\n        email: leadData.email,\r\n        createdAt: {\r\n          gte: new Date(Date.now() - 24 * 60 * 60 * 1000)\r\n        }\r\n      }\r\n    });\r\n\r\n    if (existingLead) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Une demande avec cet email a d\u00E9j\u00E0 \u00E9t\u00E9 soumise aujourd\\'hui',\r\n        message: 'Nous vous recontacterons bient\u00F4t.'\r\n      });\r\n    }\r\n\r\n    // Calculer le score de qualit\u00E9 avec IA\r\n    const qualityScore = await calculateLeadScore(leadData);\r\n    \r\n    // Cr\u00E9er le lead avec statut par d\u00E9faut\r\n    const lead = await prisma.lead.create({\r\n      data: {\r\n        // Informations projet\r\n        projectType: leadData.projectType,\r\n        projectDescription: leadData.projectDescription,\r\n        budget: leadData.budget,\r\n        timeline: leadData.timeline,\r\n        businessType: leadData.businessType,\r\n        \r\n        // Informations contact\r\n        firstName: leadData.firstName,\r\n        lastName: leadData.lastName,\r\n        email: leadData.email,\r\n        phone: leadData.phone,\r\n        company: leadData.company,\r\n        city: leadData.city,\r\n        \r\n        // M\u00E9tadonn\u00E9es\r\n        source: 'public-form',\r\n        status: qualityScore >= 70 ? 'qualified' : qualityScore >= 40 ? 'potential' : 'cold',\r\n        qualityScore: qualityScore,\r\n        acceptsMarketing: leadData.acceptsMarketing,\r\n        rgpdConsent: true,\r\n        ipAddress: clientIp,\r\n        \r\n        // Donn\u00E9es optionnelles\r\n        targetAudience: leadData.targetAudience,\r\n        goals: leadData.goals || [],\r\n        additionalServices: leadData.additionalServices || [],\r\n        \r\n        // Timestamps\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      }\r\n    });\r\n\r\n    console.log(`[PUBLIC-LEAD] Lead cr\u00E9\u00E9: ${lead.id} - Score: ${qualityScore}/100`);\r\n\r\n    // Pr\u00E9parer la r\u00E9ponse\r\n    const response = {\r\n      success: true,\r\n      message: 'Votre demande a \u00E9t\u00E9 envoy\u00E9e avec succ\u00E8s !',\r\n      leadId: lead.id,\r\n      score: qualityScore,\r\n      estimatedResponseTime: qualityScore >= 70 ? '2-4 heures' : '24-48 heures',\r\n      nextSteps: [\r\n        'Analyse de votre demande par notre \u00E9quipe',\r\n        'Appel de qualification sous 24h',\r\n        'Pr\u00E9sentation d\\'un devis personnalis\u00E9',\r\n        'Planification du projet'\r\n      ]\r\n    };\r\n\r\n    res.status(201).json(response);\r\n\r\n  } catch (error) {\r\n    console.error('[PUBLIC-LEAD] Erreur cr\u00E9ation:', error);\r\n    \r\n    res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'envoi de votre demande',\r\n      message: 'Veuillez r\u00E9essayer ou nous contacter directement.'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/public/lead-status/:id\r\n * V\u00E9rification du statut d'un lead (avec token de s\u00E9curit\u00E9)\r\n */\r\nrouter.get('/lead-status/:id', publicRateLimit, async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    // Note: token sera utilis\u00E9 pour la s\u00E9curit\u00E9 dans une version future\r\n\r\n    // Validation basique de l'ID\r\n    if (!id || typeof id !== 'string') {\r\n      return res.status(400).json({\r\n        error: 'ID de demande invalide'\r\n      });\r\n    }\r\n\r\n    // R\u00E9cup\u00E9rer le lead (informations publiques seulement)\r\n    const lead = await prisma.lead.findUnique({\r\n      where: { id },\r\n      select: {\r\n        id: true,\r\n        status: true,\r\n        createdAt: true,\r\n        projectType: true,\r\n        firstName: true,\r\n        qualityScore: true\r\n      }\r\n    });\r\n\r\n    if (!lead) {\r\n      return res.status(404).json({\r\n        error: 'Demande non trouv\u00E9e'\r\n      });\r\n    }\r\n\r\n    const statusMessages = {\r\n      'new': 'Votre demande a \u00E9t\u00E9 re\u00E7ue et est en cours d\\'analyse',\r\n      'contacted': 'Notre \u00E9quipe vous a contact\u00E9',\r\n      'qualified': 'Votre demande a \u00E9t\u00E9 qualifi\u00E9e et est prioritaire',\r\n      'proposal': 'Un devis personnalis\u00E9 a \u00E9t\u00E9 pr\u00E9par\u00E9',\r\n      'won': 'F\u00E9licitations ! Votre projet a \u00E9t\u00E9 accept\u00E9',\r\n      'lost': 'Votre demande n\\'a pas abouti cette fois',\r\n      'cold': 'Votre demande est en attente d\\'informations compl\u00E9mentaires'\r\n    };\r\n\r\n    res.json({\r\n      id: lead.id,\r\n      status: lead.status,\r\n      message: statusMessages[lead.status as keyof typeof statusMessages] || 'Statut en cours d\\'analyse',\r\n      submittedAt: lead.createdAt,\r\n      projectType: lead.projectType,\r\n      qualityScore: lead.qualityScore\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[LEAD-STATUS] Erreur:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la v\u00E9rification du statut'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83C\uDFAF TBL PRISMA SUBMISSION EVALUATOR - ENDPOINT POUR \u00C9VALUATION COMPL\u00C8TE\r\n * \r\n * Endpoint qui \u00E9value TOUTES les capacit\u00E9s (conditions, formules, tableaux) \r\n * d'une soumission avec operation-interpreter.ts (syst\u00E8me unifi\u00E9) et sauvegarde\r\n * les traductions intelligentes directement en base TreeBranchLeafSubmissionData.\r\n */\r\n\r\nimport { Router, Request } from 'express';\r\nimport { PrismaClient, Prisma } from '@prisma/client';\r\n\r\ntype OperationSourceType = 'condition' | 'formula' | 'table' | 'neutral';\r\n\r\ninterface SubmissionDataEntry {\r\n  id: string;\r\n  submissionId: string;\r\n  nodeId: string;\r\n  value: string | null;\r\n  sourceRef?: string | null;\r\n  operationSource?: OperationSourceType | null;\r\n  fieldLabel?: string | null;\r\n  operationDetail?: Prisma.InputJsonValue | null;\r\n  operationResult?: Prisma.InputJsonValue | null;\r\n  lastResolved?: Date | null;\r\n}\r\nimport { evaluateVariableOperation } from '../../treebranchleaf-new/api/operation-interpreter';\r\nimport { storeCalculatedValues } from '../../../../services/calculatedValuesService';\r\n\r\ninterface AuthenticatedRequest extends Request {\r\n  user?: {\r\n    userId?: string;\r\n    organizationId?: string;\r\n  };\r\n}\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// M\u00E9moire: staging des modifications (par session) pour ne pas \u00E9crire en base tant que non valid\u00E9\r\ntype StageRecord = {\r\n  id: string;\r\n  organizationId: string;\r\n  userId: string;\r\n  treeId: string;\r\n  submissionId?: string;\r\n  formData: Record<string, unknown>;\r\n  updatedAt: number; // epoch ms\r\n};\r\n\r\nconst stagingStore = new Map<string, StageRecord>();\r\nconst STAGE_TTL_MS = 1000 * 60 * 60; // 1h\r\n\r\nfunction pruneStages() {\r\n  const now = Date.now();\r\n  for (const [k, v] of stagingStore) {\r\n    if (now - v.updatedAt > STAGE_TTL_MS) stagingStore.delete(k);\r\n  }\r\n}\r\n\r\nfunction newStageId() {\r\n  return `stage-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;\r\n}\r\n\r\n// Utilitaire: nettoyer les formData des cl\u00E9s techniques (__mirror_, __formula_, __condition_, __*)\r\nfunction sanitizeFormData(input: unknown): unknown {\r\n  if (Array.isArray(input)) {\r\n    return input.map(sanitizeFormData);\r\n  }\r\n  if (input && typeof input === 'object') {\r\n    const result: Record<string, unknown> = {};\r\n    for (const [k, v] of Object.entries(input as Record<string, unknown>)) {\r\n      if (k.startsWith('__') || k.startsWith('__mirror_') || k.startsWith('__formula_') || k.startsWith('__condition_')) {\r\n        continue;\r\n      }\r\n      // Omettre valeurs vides (null/undefined/\"\")\r\n      if (v === null || v === undefined || v === '') continue;\r\n      result[k] = sanitizeFormData(v);\r\n    }\r\n    return result;\r\n  }\r\n  return input;\r\n}\r\n\r\nconst UUID_NODE_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\nconst GENERATED_NODE_REGEX = /^node_[0-9]+_[a-z0-9]+$/i;\r\nconst SHARED_REFERENCE_REGEX = /^shared-ref-[a-z0-9-]+$/i;\r\n\r\nfunction isSharedReferenceId(nodeId: string): boolean {\r\n  return SHARED_REFERENCE_REGEX.test(nodeId);\r\n}\r\n\r\nfunction isAcceptedNodeId(nodeId: string): boolean {\r\n  return UUID_NODE_REGEX.test(nodeId) || GENERATED_NODE_REGEX.test(nodeId) || isSharedReferenceId(nodeId);\r\n}\r\n\r\nasync function resolveSharedReferenceAliases(sharedRefs: string[], treeId?: string) {\r\n  if (!sharedRefs.length) {\r\n    return new Map<string, string[]>();\r\n  }\r\n\r\n  const where: Prisma.TreeBranchLeafNodeWhereInput = {\r\n    sharedReferenceId: { in: sharedRefs }\r\n  };\r\n\r\n  if (treeId) {\r\n    where.treeId = treeId;\r\n  }\r\n\r\n  const aliases = await prisma.treeBranchLeafNode.findMany({\r\n    where,\r\n    select: { id: true, sharedReferenceId: true }\r\n  });\r\n\r\n  const map = new Map<string, string[]>();\r\n  for (const alias of aliases) {\r\n    if (!alias.sharedReferenceId) continue;\r\n    if (!map.has(alias.sharedReferenceId)) {\r\n      map.set(alias.sharedReferenceId, []);\r\n    }\r\n    map.get(alias.sharedReferenceId)!.push(alias.id);\r\n  }\r\n\r\n  return map;\r\n}\r\n\r\nasync function applySharedReferenceValues(\r\n  target: Map<string, unknown>,\r\n  entries: Array<[string, unknown]>,\r\n  treeId?: string\r\n) {\r\n  if (!entries.length) return;\r\n\r\n  const sharedRefKeys = entries\r\n    .map(([key]) => key)\r\n    .filter(isSharedReferenceId);\r\n\r\n  const aliasMap = sharedRefKeys.length\r\n    ? await resolveSharedReferenceAliases(sharedRefKeys, treeId)\r\n    : new Map<string, string[]>();\r\n\r\n  for (const [key, value] of entries) {\r\n    target.set(key, value);\r\n    if (!isSharedReferenceId(key)) continue;\r\n\r\n    const aliases = aliasMap.get(key) || [];\r\n    for (const alias of aliases) {\r\n      target.set(alias, value);\r\n    }\r\n  }\r\n}\r\n\r\n// R\u00E9utilisables: sauvegarde des entr\u00E9es utilisateur (neutral) avec NO-OP\r\nasync function saveUserEntriesNeutral(\r\n  submissionId: string,\r\n  formData: Record<string, unknown> | undefined,\r\n  treeId?: string\r\n) {\r\n  if (!formData || typeof formData !== 'object') return 0;\r\n\r\n  let saved = 0;\r\n  const entries = new Map<string, SubmissionDataEntry>();\r\n\r\n  const sharedRefKeys = Object.keys(formData).filter(isSharedReferenceId);\r\n  const sharedRefAliasMap = sharedRefKeys.length\r\n    ? await resolveSharedReferenceAliases(sharedRefKeys, treeId)\r\n    : new Map<string, string[]>();\r\n\r\n  for (const [key, value] of Object.entries(formData)) {\r\n    if (key.startsWith('__mirror_') || key.startsWith('__formula_') || key.startsWith('__condition_')) {\r\n      continue;\r\n    }\r\n    if (!isAcceptedNodeId(key)) continue;\r\n    // \u2705 CORRECTIF : Sauvegarder TOUTES les valeurs (m\u00EAme null/undefined/vide)\r\n    // pour que operation-interpreter.ts puisse les r\u00E9cup\u00E9rer depuis TreeBranchLeafSubmissionData\r\n    // if (value === null || value === undefined || value === '') continue;  // \u274C LIGNE SUPPRIM\u00C9E\r\n\r\n    const storageIds = isSharedReferenceId(key)\r\n      ? [key, ...(sharedRefAliasMap.get(key) || [])]\r\n      : [key];\r\n\r\n    for (const nodeId of storageIds) {\r\n      if (!isAcceptedNodeId(nodeId)) continue;\r\n\r\n      const serializedValue =\r\n        value === null || value === undefined\r\n          ? null\r\n          : typeof value === 'string'\r\n            ? value\r\n            : JSON.stringify(value);\r\n\r\n      const entry: SubmissionDataEntry = {\r\n        id: `${submissionId}-${nodeId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n        submissionId,\r\n        nodeId,\r\n        value: serializedValue,\r\n        operationSource: 'neutral',\r\n        operationDetail: {\r\n          inputValue: value,\r\n          nodeId,\r\n          action: 'user_input',\r\n          sourceNodeId: key,\r\n          aliasResolved: nodeId !== key\r\n        } as Prisma.InputJsonValue,\r\n        operationResult: {\r\n          processedValue: value,\r\n          status: 'stored'\r\n        } as Prisma.InputJsonValue\r\n      };\r\n\r\n      entries.set(nodeId, entry);\r\n    }\r\n  }\r\n\r\n  for (const entry of entries.values()) {\r\n    const key = { submissionId_nodeId: { submissionId: entry.submissionId, nodeId: entry.nodeId } } as const;\r\n    const existing = await prisma.treeBranchLeafSubmissionData.findUnique({ where: key });\r\n    const normalize = (v: unknown) => {\r\n      if (v === null || v === undefined) return null;\r\n      if (typeof v === 'string') return v;\r\n      try { return JSON.stringify(v); } catch { return String(v); }\r\n    };\r\n    if (existing) {\r\n      // Idempotent: on ne consid\u00E8re que la valeur et la source; les d\u00E9tails/r\u00E9sultats neutres sont stables\r\n      const changed = (\r\n        normalize(existing.value) !== normalize(entry.value) ||\r\n        (existing.operationSource || null) !== (entry.operationSource || null)\r\n      );\r\n      if (changed) {\r\n        await prisma.treeBranchLeafSubmissionData.update({\r\n          where: key,\r\n          data: {\r\n            value: entry.value,\r\n            operationSource: 'neutral',\r\n            operationDetail: entry.operationDetail,\r\n            operationResult: entry.operationResult\r\n          }\r\n        });\r\n        saved++;\r\n      }\r\n    } else {\r\n      await prisma.treeBranchLeafSubmissionData.create({ data: entry });\r\n      saved++;\r\n    }\r\n  }\r\n  return saved;\r\n}\r\n\r\n// R\u00E9utilisables: \u00E9valuation et sauvegarde des capacit\u00E9s pour une soumission (NO-OP)\r\nasync function evaluateCapacitiesForSubmission(\r\n  submissionId: string,\r\n  organizationId: string,\r\n  userId: string | null,\r\n  treeId: string\r\n) {\r\n  // Capacit\u00E9s pour l'arbre\r\n  const capacities = await prisma.treeBranchLeafNodeVariable.findMany({\r\n    where: { TreeBranchLeafNode: { treeId }, sourceRef: { not: null } },\r\n    include: { TreeBranchLeafNode: { select: { id: true, label: true } } }\r\n  });\r\n\r\n  const _tblContext = {\r\n    submissionId,\r\n    labelMap: new Map<string, string | null>(),\r\n    valueMap: new Map<string, unknown>(),\r\n    organizationId,\r\n    userId: userId || 'unknown-user',\r\n    treeId\r\n  };\r\n\r\n  const results: { updated: number; created: number; stored: number } = { updated: 0, created: 0, stored: 0 };\r\n  const calculatedValuesToStore: { nodeId: string; calculatedValue: string | number | boolean; calculatedBy?: string }[] = [];\r\n\r\n  for (const capacity of capacities) {\r\n    const sourceRef = capacity.sourceRef!;\r\n    try {\r\n      // \u2728 UTILISATION DU SYST\u00C8ME UNIFI\u00C9 operation-interpreter.ts\r\n      const capacityResult = await evaluateVariableOperation(\r\n        capacity.nodeId,\r\n        submissionId,\r\n        prisma\r\n      );\r\n      const normalizedOperationSource: OperationSourceType = (typeof capacityResult.operationSource === 'string'\r\n        ? (capacityResult.operationSource as string).toLowerCase()\r\n        : 'neutral') as OperationSourceType;\r\n\r\n      let parsedDetail: Prisma.InputJsonValue | null = null;\r\n      try {\r\n        parsedDetail = typeof capacityResult.operationDetail === 'string'\r\n          ? (JSON.parse(capacityResult.operationDetail as unknown as string) as Prisma.InputJsonValue)\r\n          : (capacityResult.operationDetail as unknown as Prisma.InputJsonValue);\r\n      } catch {\r\n        parsedDetail = capacityResult.operationDetail as unknown as Prisma.InputJsonValue;\r\n      }\r\n\r\n      const key = { submissionId_nodeId: { submissionId, nodeId: capacity.nodeId } } as const;\r\n      const existing = await prisma.treeBranchLeafSubmissionData.findUnique({ where: key });\r\n      const normalize = (v: unknown) => {\r\n        if (v === null || v === undefined) return null;\r\n        if (typeof v === 'string') return v;\r\n        try { return JSON.stringify(v); } catch { return String(v); }\r\n      };\r\n      if (existing) {\r\n        const changed = (\r\n          (existing.sourceRef || null) !== (sourceRef || null) ||\r\n          (existing.operationSource || null) !== (normalizedOperationSource || null) ||\r\n          (existing.fieldLabel || null) !== ((capacity.TreeBranchLeafNode?.label || null)) ||\r\n          normalize(existing.operationDetail) !== normalize(parsedDetail) ||\r\n          normalize(existing.operationResult) !== normalize(capacityResult.operationResult)\r\n        );\r\n        if (changed) {\r\n          await prisma.treeBranchLeafSubmissionData.update({\r\n            where: key,\r\n            data: {\r\n              value: null,\r\n              sourceRef,\r\n              operationSource: normalizedOperationSource,\r\n              fieldLabel: capacity.TreeBranchLeafNode?.label || null,\r\n              operationDetail: parsedDetail,\r\n              operationResult: capacityResult.operationResult as unknown as Prisma.InputJsonValue,\r\n              lastResolved: new Date()\r\n            }\r\n          });\r\n          results.updated++;\r\n        }\r\n      } else {\r\n        await prisma.treeBranchLeafSubmissionData.create({\r\n          data: {\r\n            id: `${submissionId}-${capacity.nodeId}-cap-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n            submissionId,\r\n            nodeId: capacity.nodeId,\r\n            value: null,\r\n            sourceRef,\r\n            operationSource: normalizedOperationSource,\r\n            fieldLabel: capacity.TreeBranchLeafNode?.label || null,\r\n            operationDetail: parsedDetail,\r\n            operationResult: capacityResult.operationResult as unknown as Prisma.InputJsonValue,\r\n            lastResolved: new Date()\r\n          }\r\n        });\r\n        results.created++;\r\n      }\r\n\r\n      const rawValue = (capacityResult as { value?: unknown }).value;\r\n      const stringified = rawValue === null || rawValue === undefined ? null : String(rawValue).trim();\r\n      if (rawValue !== null && rawValue !== undefined && stringified !== '' && stringified !== '\u2205') {\r\n        let normalizedValue: string | number | boolean;\r\n        if (typeof rawValue === 'number' || typeof rawValue === 'boolean') {\r\n          normalizedValue = rawValue;\r\n        } else {\r\n          normalizedValue = String(rawValue);\r\n        }\r\n\r\n        calculatedValuesToStore.push({\r\n          nodeId: capacity.nodeId,\r\n          calculatedValue: normalizedValue,\r\n          calculatedBy: `submission-${submissionId}`\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error(`[TBL CAPACITY ERROR] ${sourceRef}:`, error);\r\n    }\r\n  }\r\n\r\n  if (calculatedValuesToStore.length > 0) {\r\n    try {\r\n      const storeResult = await storeCalculatedValues(calculatedValuesToStore, submissionId);\r\n      results.stored = storeResult.stored;\r\n      if (!storeResult.success && storeResult.errors.length > 0) {\r\n        console.warn('[TBL CAPACITY STORE] Certaines valeurs n\\'ont pas pu \u00EAtre enregistr\u00E9es:', storeResult.errors);\r\n      }\r\n    } catch (storeError) {\r\n      console.error('[TBL CAPACITY STORE] Erreur lors du stockage des valeurs calcul\u00E9es:', storeError);\r\n    }\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\n/**\r\n * \uD83D\uDD25 POST /api/tbl/submissions/:submissionId/evaluate-all\r\n * \r\n * \u00C9value TOUTES les capacit\u00E9s d'une soumission avec TBL Prisma\r\n * et sauvegarde les traductions intelligentes en base\r\n */\r\nrouter.post('/submissions/:submissionId/evaluate-all', async (req, res) => {\r\n  try {\r\n    const { submissionId } = req.params;\r\n    const { forceUpdate = false } = req.body || {};\r\n    \r\n    // R\u00E9cup\u00E9rer l'organisation de l'utilisateur authentifi\u00E9 (endpoint PUT)\r\n    const organizationId = req.headers['x-organization-id'] as string || (req as AuthenticatedRequest).user?.organizationId;\r\n    const userId = (req as AuthenticatedRequest).user?.userId || 'unknown-user';\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Organisation ID manquant - authentification requise'\r\n      });\r\n    }\r\n    \r\n    console.log('\uD83D\uDD25 [TBL EVALUATE ALL] D\u00E9but \u00E9valuation compl\u00E8te:', submissionId);\r\n    console.log(`\uD83C\uDFE2 [TBL EVALUATE ALL] Organisation: ${organizationId}, Utilisateur: ${userId}`);\r\n    \r\n    // 1. R\u00E9cup\u00E9rer toutes les donn\u00E9es de soumission avec capacit\u00E9s\r\n    const submissionData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: {\r\n        submissionId,\r\n        sourceRef: { not: null }\r\n      },\r\n      include: {\r\n        TreeBranchLeafNode: {\r\n          select: { label: true, type: true }\r\n        }\r\n      }\r\n    });\r\n    \r\n    console.log(`\uD83D\uDCCA [TBL EVALUATE ALL] ${submissionData.length} \u00E9l\u00E9ments avec capacit\u00E9s trouv\u00E9s`);\r\n    \r\n    if (submissionData.length === 0) {\r\n      return res.json({\r\n        success: true,\r\n        message: 'Aucune capacit\u00E9 \u00E0 \u00E9valuer',\r\n        evaluated: 0\r\n      });\r\n    }\r\n    \r\n    // 2. Contexte d'\u00E9valuation (Maps initialis\u00E9es)\r\n  const _context = {\r\n      submissionId,\r\n      organizationId, // \u2705 VRAIE ORGANISATION!\r\n      userId, // \u2705 VRAI UTILISATEUR!\r\n      labelMap: new Map<string, string>(), // \uD83D\uDD25 MAPS INITIALIS\u00C9ES\r\n      valueMap: new Map<string, unknown>()\r\n    };\r\n    \r\n  let evaluatedCount = 0;\r\n  let errorCount = 0;\r\n    const results = [];\r\n    \r\n    // 4. \u00C9valuer chaque capacit\u00E9 avec TBL Prisma\r\n    for (const data of submissionData) {\r\n      try {\r\n        // Skip si d\u00E9j\u00E0 \u00E9valu\u00E9 (sauf si forceUpdate)\r\n        if (!forceUpdate && data.operationResult && data.lastResolved) {\r\n          console.log(`\u23ED\uFE0F [TBL EVALUATE ALL] Skip ${data.sourceRef} (d\u00E9j\u00E0 \u00E9valu\u00E9)`);\r\n          continue;\r\n        }\r\n        \r\n        console.log(`\uD83D\uDD04 [TBL EVALUATE ALL] \u00C9valuation ${data.sourceRef}...`);\r\n        \r\n        // \u2728 Calculer avec operation-interpreter (syst\u00E8me unifi\u00E9)\r\n        const calculationResult = await evaluateVariableOperation(\r\n          data.nodeId,\r\n          submissionId,\r\n          prisma\r\n        );\r\n        \r\n        console.log(`\u2705 [TBL EVALUATE ALL] R\u00E9sultat pour ${data.sourceRef}:`, calculationResult.operationResult);\r\n\r\n        // 5. Sauvegarder en base SEULEMENT si changement (NO-OP sinon)\r\n        const normalize = (v: unknown) => {\r\n          if (v === null || v === undefined) return null;\r\n          if (typeof v === 'string') return v;\r\n          try { return JSON.stringify(v); } catch { return String(v); }\r\n        };\r\n\r\n        const normalizedSource: Prisma.OperationSource = (\r\n          typeof calculationResult.operationSource === 'string'\r\n            ? calculationResult.operationSource.toLowerCase()\r\n            : 'neutral'\r\n        ) as Prisma.OperationSource;\r\n\r\n        const nextDetail: Prisma.InputJsonValue = (() => {\r\n          try {\r\n            return typeof calculationResult.operationDetail === 'string'\r\n              ? JSON.parse(calculationResult.operationDetail)\r\n              : (calculationResult.operationDetail as unknown as Prisma.InputJsonValue);\r\n          } catch { return calculationResult.operationDetail as unknown as Prisma.InputJsonValue; }\r\n        })();\r\n\r\n        const nextResult: Prisma.InputJsonValue = calculationResult.operationResult as unknown as Prisma.InputJsonValue;\r\n\r\n        const changed = (\r\n          (data.operationSource || null) !== (normalizedSource || null) ||\r\n          normalize(data.operationDetail) !== normalize(nextDetail) ||\r\n          normalize(data.operationResult) !== normalize(nextResult)\r\n        );\r\n\r\n        if (changed) {\r\n          await prisma.treeBranchLeafSubmissionData.update({\r\n            where: { id: data.id },\r\n            data: {\r\n              operationDetail: nextDetail,\r\n              operationResult: nextResult, // \uD83D\uDD25 TRADUCTION INTELLIGENTE !\r\n              operationSource: normalizedSource,\r\n              lastResolved: new Date()\r\n            }\r\n          });\r\n        } else {\r\n          console.log(`\u23ED\uFE0F [TBL EVALUATE ALL] NO-OP ${data.sourceRef} (inchang\u00E9)`);\r\n        }\r\n        \r\n        results.push({\r\n          id: data.id,\r\n          sourceRef: data.sourceRef,\r\n          nodeLabel: data.TreeBranchLeafNode?.label,\r\n          operationResult: calculationResult.operationResult,\r\n          success: true\r\n        });\r\n        \r\n        evaluatedCount++;\r\n        \r\n      } catch (error) {\r\n        console.error(`\u274C [TBL EVALUATE ALL] Erreur pour ${data.sourceRef}:`, error);\r\n        \r\n        results.push({\r\n          id: data.id,\r\n          sourceRef: data.sourceRef,\r\n          nodeLabel: data.TreeBranchLeafNode?.label,\r\n          error: error instanceof Error ? error.message : 'Erreur inconnue',\r\n          success: false\r\n        });\r\n        \r\n        errorCount++;\r\n      }\r\n    }\r\n    \r\n    console.log(`\uD83C\uDF89 [TBL EVALUATE ALL] Termin\u00E9: ${evaluatedCount} \u00E9valu\u00E9s, ${errorCount} erreurs`);\r\n    \r\n    return res.json({\r\n      success: true,\r\n      submissionId,\r\n      evaluated: evaluatedCount,\r\n      errors: errorCount,\r\n      total: submissionData.length,\r\n      results,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL EVALUATE ALL] Erreur globale:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de l\\'\u00E9valuation compl\u00E8te',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDCCA GET /api/tbl/submissions/:submissionId/verification\r\n * \r\n * V\u00E9rifie que toutes les traductions intelligentes sont bien sauvegard\u00E9es\r\n */\r\nrouter.get('/submissions/:submissionId/verification', async (req, res) => {\r\n  try {\r\n    const { submissionId } = req.params;\r\n    \r\n    console.log('\uD83D\uDD0D [TBL VERIFICATION] V\u00E9rification soumission:', submissionId);\r\n    \r\n    // R\u00E9cup\u00E9rer les lignes concern\u00E9es et compter en m\u00E9moire (operationResult est un JSON)\r\n    const rows = await prisma.treeBranchLeafSubmissionData.findMany({\r\n      where: { submissionId, sourceRef: { not: null } },\r\n      select: { operationResult: true }\r\n    });\r\n\r\n    const total = rows.length;\r\n    const toStringSafely = (val: unknown): string => {\r\n      if (val === null || val === undefined) return '';\r\n      if (typeof val === 'string') return val;\r\n      try { return JSON.stringify(val); } catch { return String(val); }\r\n    };\r\n\r\n    let withIntelligentTranslations = 0; // heuristique: contient \"Si \" ou \"(=) Result (\"\r\n    let withOldMessages = 0;            // heuristique: message legacy\r\n    let withErrors = 0;                 // null/empty\r\n\r\n    for (const r of rows) {\r\n      const s = toStringSafely(r.operationResult).trim();\r\n      if (!s) {\r\n        withErrors++;\r\n        continue;\r\n      }\r\n      if (s.includes('\u00C9valu\u00E9 dynamiquement par TBL Prisma')) {\r\n        withOldMessages++;\r\n      }\r\n      if (s.includes('Si ') || /(=) Result \\(/.test(s) || s.includes('(/)')) {\r\n        withIntelligentTranslations++;\r\n      }\r\n    }\r\n\r\n    const successRate = total > 0 ? Math.round(((total - withOldMessages - withErrors) / total) * 100) : 100;\r\n\r\n    return res.json({\r\n      success: true,\r\n      submissionId,\r\n      verification: {\r\n        total,\r\n        withIntelligentTranslations,\r\n        withOldMessages,\r\n        withErrors,\r\n        successRate: `${successRate}%`\r\n      },\r\n      status: withOldMessages === 0 && withErrors === 0 ? 'perfect' : 'needs_improvement',\r\n      timestamp: new Date().toISOString()\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL VERIFICATION] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la v\u00E9rification'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD25 POST /api/tbl/submissions/create-and-evaluate\r\n * \r\n * ENDPOINT TOUT-EN-UN : Cr\u00E9e une soumission ET l'\u00E9value avec TBL Prisma\r\n * SANS JAMAIS passer par les routes TreeBranchLeaf legacy !\r\n */\r\nrouter.post('/submissions/create-and-evaluate', async (req, res) => {\r\n  try {\r\n    const { treeId, clientId, formData, status = 'draft', providedName, reuseSubmissionId } = req.body;\r\n    const cleanFormData = formData && typeof formData === 'object' ? (sanitizeFormData(formData) as Record<string, unknown>) : undefined;\r\n    \r\n    // R\u00E9cup\u00E9rer l'organisation de l'utilisateur authentifi\u00E9 (endpoint POST)\r\n    const organizationId = req.headers['x-organization-id'] as string || (req as AuthenticatedRequest).user?.organizationId;\r\n    const userId = (req as AuthenticatedRequest).user?.userId || 'unknown-user';\r\n    \r\n    if (!organizationId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Organisation ID manquant - authentification requise'\r\n      });\r\n    }\r\n    \r\n    console.log('\uD83D\uDD25 [TBL CREATE-AND-EVALUATE] D\u00E9but cr\u00E9ation compl\u00E8te TBL Prisma');\r\n    console.log(`\uD83C\uDFE2 [TBL CREATE-AND-EVALUATE] Organisation: ${organizationId}, Utilisateur: ${userId}`);\r\n    console.log(`\uD83D\uDCCB [TBL CREATE-AND-EVALUATE] TreeId re\u00E7u: ${treeId}, ClientId: ${clientId}`);\r\n    \r\n    // 1. V\u00E9rifier et r\u00E9cup\u00E9rer l'arbre r\u00E9el depuis la base de donn\u00E9es\r\n    let effectiveTreeId = treeId;\r\n    \r\n    // Si pas de treeId fourni ou si l'arbre n'existe pas, r\u00E9cup\u00E9rer le premier arbre disponible\r\n    if (!effectiveTreeId) {\r\n      console.log('\u26A0\uFE0F [TBL CREATE-AND-EVALUATE] Aucun treeId fourni, recherche du premier arbre disponible...');\r\n      const firstTree = await prisma.treeBranchLeafTree.findFirst({\r\n        select: { id: true, name: true }\r\n      });\r\n      \r\n      if (!firstTree) {\r\n        throw new Error('Aucun arbre TreeBranchLeaf trouv\u00E9 dans la base de donn\u00E9es');\r\n      }\r\n      \r\n      effectiveTreeId = firstTree.id;\r\n      console.log(`\uD83C\uDF33 [TBL CREATE-AND-EVALUATE] Arbre par d\u00E9faut s\u00E9lectionn\u00E9: ${effectiveTreeId} (${firstTree.name})`);\r\n    } else {\r\n      // V\u00E9rifier que l'arbre fourni existe bien\r\n      const treeExists = await prisma.treeBranchLeafTree.findUnique({\r\n        where: { id: effectiveTreeId },\r\n        select: { id: true, name: true }\r\n      });\r\n      \r\n      if (!treeExists) {\r\n        console.log(`\u274C [TBL CREATE-AND-EVALUATE] Arbre ${effectiveTreeId} introuvable, recherche d'un arbre alternatif...`);\r\n        const firstTree = await prisma.treeBranchLeafTree.findFirst({\r\n          select: { id: true, name: true }\r\n        });\r\n        \r\n        if (!firstTree) {\r\n          throw new Error('Aucun arbre TreeBranchLeaf trouv\u00E9 dans la base de donn\u00E9es');\r\n        }\r\n        \r\n        effectiveTreeId = firstTree.id;\r\n        console.log(`\uD83C\uDF33 [TBL CREATE-AND-EVALUATE] Arbre alternatif s\u00E9lectionn\u00E9: ${effectiveTreeId} (${firstTree.name})`);\r\n      } else {\r\n        console.log(`\u2705 [TBL CREATE-AND-EVALUATE] Arbre valid\u00E9: ${effectiveTreeId} (${treeExists.name})`);\r\n      }\r\n    }\r\n    \r\n    // 2. V\u00E9rifier et g\u00E9rer le Lead (clientId)\r\n    let effectiveLeadId = clientId;\r\n    \r\n    if (effectiveLeadId) {\r\n      // V\u00E9rifier que le lead fourni existe bien\r\n      const leadExists = await prisma.lead.findUnique({\r\n        where: { id: effectiveLeadId },\r\n        select: { id: true, firstName: true, lastName: true, email: true }\r\n      });\r\n      \r\n      if (!leadExists) {\r\n        console.log(`\u274C [TBL CREATE-AND-EVALUATE] Lead ${effectiveLeadId} introuvable, cr\u00E9ation d'un lead par d\u00E9faut...`);\r\n        \r\n        // Cr\u00E9er un lead par d\u00E9faut\r\n        const defaultLead = await prisma.lead.create({\r\n          data: {\r\n            id: `lead-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n            firstName: \"Client\",\r\n            lastName: \"D\u00E9faut\",\r\n            email: `client-${Date.now()}@example.com`,\r\n            phone: \"\",\r\n            organizationId: organizationId!,\r\n            updatedAt: new Date()\r\n          }\r\n        });\r\n        \r\n        effectiveLeadId = defaultLead.id;\r\n        console.log(`\uD83D\uDC64 [TBL CREATE-AND-EVALUATE] Lead par d\u00E9faut cr\u00E9\u00E9: ${effectiveLeadId} (${defaultLead.firstName} ${defaultLead.lastName})`);\r\n      } else {\r\n        console.log(`\u2705 [TBL CREATE-AND-EVALUATE] Lead valid\u00E9: ${effectiveLeadId} (${leadExists.firstName} ${leadExists.lastName})`);\r\n      }\r\n    } else {\r\n      console.log('\u2139\uFE0F [TBL CREATE-AND-EVALUATE] Aucun leadId fourni, soumission sans lead associ\u00E9');\r\n    }\r\n    \r\n    // 3. V\u00E9rifier l'utilisateur si fourni\r\n    let effectiveUserId = userId;\r\n    \r\n    if (effectiveUserId) {\r\n      const userExists = await prisma.user.findUnique({\r\n        where: { id: effectiveUserId },\r\n        select: { id: true, firstName: true, lastName: true }\r\n      });\r\n      \r\n      if (!userExists) {\r\n        console.log(`\u274C [TBL CREATE-AND-EVALUATE] User ${effectiveUserId} introuvable, soumission sans utilisateur`);\r\n        effectiveUserId = null;\r\n      } else {\r\n        console.log(`\u2705 [TBL CREATE-AND-EVALUATE] User valid\u00E9: ${effectiveUserId} (${userExists.firstName} ${userExists.lastName})`);\r\n      }\r\n    }\r\n    \r\n    // 4. R\u00E9utiliser \u00E9ventuellement une soumission existante au lieu d'en cr\u00E9er une nouvelle\r\n    let submissionId = reuseSubmissionId as string | undefined;\r\n    if (submissionId) {\r\n      const existing = await prisma.treeBranchLeafSubmission.findUnique({ where: { id: submissionId }, select: { id: true } });\r\n      if (!existing) submissionId = undefined;\r\n    }\r\n    if (!submissionId) {\r\n      submissionId = `tbl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n      await prisma.treeBranchLeafSubmission.create({\r\n        data: {\r\n          id: submissionId,\r\n          treeId: effectiveTreeId,\r\n          userId: effectiveUserId,\r\n          leadId: effectiveLeadId,\r\n          status: status || 'completed',\r\n          summary: { name: providedName || `Devis TBL ${new Date().toLocaleDateString()}` },\r\n          exportData: cleanFormData || {},\r\n          completedAt: status === 'completed' ? new Date() : null,\r\n          updatedAt: new Date()\r\n        }\r\n      });\r\n      console.log(`\u2705 [TBL CREATE-AND-EVALUATE] Soumission cr\u00E9\u00E9e: ${submissionId}`);\r\n    } else {\r\n      console.log(`\uFFFD [TBL CREATE-AND-EVALUATE] R\u00E9utilisation de la soumission: ${submissionId}`);\r\n    }\r\n    \r\n    // 5. Sauvegarder d'abord les donn\u00E9es UTILISATEUR en base, puis \u00E9valuer et sauvegarder les CAPACIT\u00C9S\r\n    if (cleanFormData && typeof cleanFormData === 'object') {\r\n      // A. Sauvegarder les donn\u00E9es utilisateur directes (r\u00E9utilise NO-OP)\r\n  const savedCount = await saveUserEntriesNeutral(submissionId!, cleanFormData, effectiveTreeId);\r\n      if (savedCount > 0) console.log(`\u2705 [TBL CREATE-AND-EVALUATE] ${savedCount} entr\u00E9es utilisateur enregistr\u00E9es`);\r\n      \r\n      // B. R\u00E9cup\u00E9rer toutes les capacit\u00E9s (conditions, formules, tables) depuis TreeBranchLeafNodeVariable\r\n      const capacities = await prisma.treeBranchLeafNodeVariable.findMany({\r\n        where: {\r\n          TreeBranchLeafNode: {\r\n            treeId: effectiveTreeId\r\n          },\r\n          sourceRef: { not: null }\r\n        },\r\n        include: {\r\n          TreeBranchLeafNode: {\r\n            select: { id: true, label: true }\r\n          }\r\n        }\r\n      });\r\n      \r\n      console.log(`\uD83C\uDFAF [TBL CREATE-AND-EVALUATE] ${capacities.length} capacit\u00E9s trouv\u00E9es`);\r\n      \r\n      // C. \u00C9valuer et persister les capacit\u00E9s avec NO-OP\r\n      const evalStats = await evaluateCapacitiesForSubmission(submissionId!, organizationId!, userId || null, effectiveTreeId);\r\n      console.log(`\u2705 [TBL CREATE-AND-EVALUATE] Capacit\u00E9s: ${evalStats.updated} mises \u00E0 jour, ${evalStats.created} cr\u00E9\u00E9es, ${evalStats.stored} valeurs stock\u00E9es`);\r\n    }\r\n    \r\n    // 3. \u00C9valuation imm\u00E9diate d\u00E9j\u00E0 effectu\u00E9e via operation-interpreter ci-dessus.\r\n    //    On \u00E9vite une seconde passe redondante qui r\u00E9\u00E9crit inutilement en base.\r\n    \r\n    // 4. Retourner la soumission compl\u00E8te\r\n    const finalSubmission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id: submissionId },\r\n      include: {\r\n        TreeBranchLeafSubmissionData: true\r\n      }\r\n    });\r\n    \r\n    return res.status(201).json({\r\n      success: true,\r\n      message: 'Soumission cr\u00E9\u00E9e et \u00E9valu\u00E9e avec TBL Prisma',\r\n      submission: finalSubmission\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [TBL CREATE-AND-EVALUATE] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Erreur interne'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD04 PUT /api/tbl/submissions/:submissionId/update-and-evaluate\r\n * \r\n * Met \u00E0 jour les donn\u00E9es utilisateur d'une soumission existante (sans recr\u00E9er)\r\n * puis \u00E9value toutes les capacit\u00E9s et sauvegarde les r\u00E9sultats (NO-OP).\r\n */\r\nrouter.put('/submissions/:submissionId/update-and-evaluate', async (req, res) => {\r\n  try {\r\n    const { submissionId } = req.params;\r\n    const { formData, status } = req.body || {};\r\n    const cleanFormData = formData && typeof formData === 'object' ? (sanitizeFormData(formData) as Record<string, unknown>) : undefined;\r\n\r\n    const organizationId = req.headers['x-organization-id'] as string || (req as AuthenticatedRequest).user?.organizationId;\r\n    const userId = (req as AuthenticatedRequest).user?.userId || null;\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({ success: false, error: 'Organisation ID manquant - authentification requise' });\r\n    }\r\n\r\n    const submission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id: submissionId },\r\n      select: { id: true, treeId: true, status: true, exportData: true }\r\n    });\r\n    if (!submission) {\r\n      return res.status(404).json({ success: false, error: 'Soumission introuvable' });\r\n    }\r\n\r\n    // 1) Sauvegarder les donn\u00E9es utilisateur (NO-OP)\r\n  const saved = await saveUserEntriesNeutral(submissionId, cleanFormData, submission.treeId);\r\n\r\n    // 2) Option: mettre \u00E0 jour le statut de la soumission si fourni (NO-OP)\r\n    const updateData: Prisma.TreeBranchLeafSubmissionUpdateInput = {};\r\n    if (status && status !== submission.status) {\r\n      updateData.status = status;\r\n    }\r\n    // 2b) Mettre \u00E0 jour exportData si fourni (NO-OP)\r\n    if (cleanFormData) {\r\n      const normalize = (v: unknown) => {\r\n        if (v === null || v === undefined) return null;\r\n        if (typeof v === 'string') return v;\r\n        try { return JSON.stringify(v); } catch { return String(v); }\r\n      };\r\n      if (normalize(submission.exportData) !== normalize(cleanFormData)) {\r\n        updateData.exportData = cleanFormData as unknown as Prisma.InputJsonValue;\r\n      }\r\n    }\r\n    if (Object.keys(updateData).length > 0) {\r\n      await prisma.treeBranchLeafSubmission.update({ where: { id: submissionId }, data: updateData });\r\n    }\r\n\r\n    // 3) \u00C9valuer et persister les capacit\u00E9s li\u00E9es \u00E0 l'arbre\r\n    const stats = await evaluateCapacitiesForSubmission(submissionId, organizationId, userId, submission.treeId);\r\n\r\n    // 4) Retourner la soumission compl\u00E8te\r\n    const finalSubmission = await prisma.treeBranchLeafSubmission.findUnique({\r\n      where: { id: submissionId },\r\n      include: { TreeBranchLeafSubmissionData: true }\r\n    });\r\n\r\n    return res.json({\r\n      success: true,\r\n      message: `Soumission mise \u00E0 jour (${saved} entr\u00E9es) et \u00E9valu\u00E9e (${stats.updated} mises \u00E0 jour, ${stats.created} cr\u00E9\u00E9es, ${stats.stored} valeurs stock\u00E9es)`,\r\n      submission: finalSubmission\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [TBL UPDATE-AND-EVALUATE] Erreur:', error);\r\n    return res.status(500).json({ success: false, error: error instanceof Error ? error.message : 'Erreur interne' });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDEA POST /api/tbl/submissions/preview-evaluate\r\n *\r\n * \u00C9value les capacit\u00E9s pour un arbre donn\u00E9 EN M\u00C9MOIRE uniquement (aucune \u00E9criture en base).\r\n * Permet un flux \"pr\u00E9visualisation\" pour un nouveau devis ou pour tester des changements\r\n * avant de sauvegarder. Peut fusionner les donn\u00E9es d'une soumission existante (baseSubmissionId)\r\n * avec des overrides (formData) pour simuler l'\u00E9tat final sans persister.\r\n */\r\nrouter.post('/submissions/preview-evaluate', async (req, res) => {\r\n  try {\r\n    const { treeId, formData, baseSubmissionId, leadId } = req.body || {};\r\n\r\n    const organizationId = req.headers['x-organization-id'] as string || (req as AuthenticatedRequest).user?.organizationId;\r\n    const userId = (req as AuthenticatedRequest).user?.userId || 'unknown-user';\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({ success: false, error: 'Organisation ID manquant - authentification requise' });\r\n    }\r\n\r\n    // 1) R\u00E9soudre l'arbre\r\n    let effectiveTreeId = treeId as string | undefined;\r\n    if (!effectiveTreeId) {\r\n      const firstTree = await prisma.treeBranchLeafTree.findFirst({ select: { id: true } });\r\n      if (!firstTree) {\r\n        return res.status(404).json({ success: false, error: 'Aucun arbre TreeBranchLeaf trouv\u00E9' });\r\n      }\r\n      effectiveTreeId = firstTree.id;\r\n    } else {\r\n      const exists = await prisma.treeBranchLeafTree.findUnique({ where: { id: effectiveTreeId }, select: { id: true } });\r\n      if (!exists) {\r\n        return res.status(404).json({ success: false, error: `Arbre introuvable: ${effectiveTreeId}` });\r\n      }\r\n    }\r\n\r\n    // 2) Pr\u00E9parer labelMap pour tous les nodes de l'arbre\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId: effectiveTreeId }, select: { id: true, label: true } });\r\n    const labelMap = new Map<string, string | null>();\r\n    for (const n of nodes) labelMap.set(n.id, n.label);\r\n\r\n    // 3) Construire valueMap: donn\u00E9es existantes (si baseSubmissionId) + overrides formData\r\n    const valueMap = new Map<string, unknown>();\r\n    \r\n    // 3a) \uD83C\uDD95 Charger les donn\u00E9es du Lead si pr\u00E9sent\r\n    if (leadId) {\r\n      const lead = await prisma.lead.findUnique({\r\n        where: { id: leadId as string },\r\n        select: {\r\n          id: true,\r\n          firstName: true,\r\n          lastName: true,\r\n          email: true,\r\n          phone: true,\r\n          company: true,\r\n          leadNumber: true,\r\n          linkedin: true,\r\n          website: true,\r\n          status: true,\r\n          notes: true,\r\n          data: true\r\n        }\r\n      });\r\n      \r\n      if (lead) {\r\n        // Ajouter les champs du Lead dans le valueMap avec le pr\u00E9fixe \"lead.\"\r\n        valueMap.set('lead.id', lead.id);\r\n        valueMap.set('lead.firstName', lead.firstName);\r\n        valueMap.set('lead.lastName', lead.lastName);\r\n        valueMap.set('lead.email', lead.email);\r\n        valueMap.set('lead.phone', lead.phone);\r\n        valueMap.set('lead.company', lead.company);\r\n        valueMap.set('lead.leadNumber', lead.leadNumber);\r\n        valueMap.set('lead.linkedin', lead.linkedin);\r\n        valueMap.set('lead.website', lead.website);\r\n        valueMap.set('lead.status', lead.status);\r\n        valueMap.set('lead.notes', lead.notes);\r\n        \r\n        // \u2705 Extraire les donn\u00E9es de l'objet JSON `data` s'il existe\r\n        if (lead.data && typeof lead.data === 'object') {\r\n          const leadData = lead.data as Record<string, unknown>;\r\n          \r\n          // Ajouter le code postal s'il existe dans data\r\n          if (leadData.postalCode) {\r\n            valueMap.set('lead.postalCode', leadData.postalCode);\r\n            console.log(`[PREVIEW-EVALUATE] \u2705 Code postal Lead: ${leadData.postalCode}`);\r\n          } else if (leadData.address && typeof leadData.address === 'string') {\r\n            // \uD83C\uDD95 Extraire le code postal depuis l'adresse (format: \"Rue..., 5150 Ville, Pays\")\r\n            const postalCodeMatch = leadData.address.match(/\\b(\\d{4})\\b/);\r\n            if (postalCodeMatch) {\r\n              const extractedPostalCode = postalCodeMatch[1];\r\n              valueMap.set('lead.postalCode', extractedPostalCode);\r\n              console.log(`[PREVIEW-EVALUATE] \u2705 Code postal extrait: ${extractedPostalCode} depuis \"${leadData.address}\"`);\r\n            } else {\r\n              console.log(`[PREVIEW-EVALUATE] \u26A0\uFE0F Aucun code postal trouv\u00E9 dans l'adresse: \"${leadData.address}\"`);\r\n            }\r\n          }\r\n          \r\n          if (leadData.address) {\r\n            valueMap.set('lead.address', leadData.address);\r\n          }\r\n          if (leadData.city) {\r\n            valueMap.set('lead.city', leadData.city);\r\n          }\r\n          if (leadData.country) {\r\n            valueMap.set('lead.country', leadData.country);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // 3b) Charger les donn\u00E9es de la submission existante\r\n    if (baseSubmissionId) {\r\n      const existingData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n        where: { submissionId: baseSubmissionId },\r\n        select: { nodeId: true, value: true }\r\n      });\r\n\r\n      const existingEntries = existingData.map(row => [row.nodeId, row.value] as [string, unknown]);\r\n      await applySharedReferenceValues(valueMap, existingEntries, effectiveTreeId);\r\n    }\r\n    \r\n    // 3c) Appliquer les overrides du formData\r\n    if (formData && typeof formData === 'object') {\r\n      const overrides = Object.entries(formData as Record<string, unknown>).filter(([k]) => !k.startsWith('__'));\r\n      await applySharedReferenceValues(valueMap, overrides as Array<[string, unknown]>, effectiveTreeId);\r\n    }\r\n\r\n    // 4) R\u00E9cup\u00E9rer les capacit\u00E9s de l'arbre\r\n    const capacities = await prisma.treeBranchLeafNodeVariable.findMany({\r\n      where: { TreeBranchLeafNode: { treeId: effectiveTreeId }, sourceRef: { not: null } },\r\n      include: { TreeBranchLeafNode: { select: { id: true, label: true } } }\r\n    });\r\n\r\n    // 5) Contexte d'\u00E9valuation (submissionId fictif)\r\n    const submissionId = baseSubmissionId || `preview-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;\r\n    \r\n    // \uD83D\uDD0D DEBUG: Afficher le contenu du valueMap\r\n    console.log(`[UNIVERSAL] \uD83D\uDCE6 valueMap contient ${valueMap.size} entr\u00E9es:`);\r\n    for (const [key, val] of valueMap.entries()) {\r\n      console.log(`  - ${key} = ${val}`);\r\n    }\r\n    \r\n    const context = {\r\n      submissionId,\r\n      organizationId,\r\n      userId,\r\n      treeId: effectiveTreeId,\r\n      labelMap,\r\n      valueMap\r\n    } as const;\r\n\r\n    const results: Array<{ nodeId: string; nodeLabel: string | null; sourceRef: string; operationSource: string; operationResult: unknown; operationDetail: unknown }>= [];\r\n    let evaluated = 0;\r\n    for (const cap of capacities) {\r\n      try {\r\n        console.log(`[UNIVERSAL] \uD83D\uDE80 \u00C9valuation preview pour nodeId: ${cap.nodeId}, sourceRef: ${cap.sourceRef}`);\r\n        \r\n        // NOUVEAU : Utiliser le syst\u00E8me universel operation-interpreter\r\n        // La fonction attend maintenant 4 param\u00E8tres : (variableNodeId, submissionId, prisma, valueMap)\r\n        const evaluation = await evaluateVariableOperation(\r\n          cap.nodeId,              // variableNodeId\r\n          context.submissionId,     // submissionId\r\n          prisma,                   // prismaClient\r\n          context.valueMap          // valueMap (donn\u00E9es temporaires du formulaire)\r\n        );\r\n        \r\n        console.log(`[UNIVERSAL] \u2705 R\u00E9sultat: value=\"${evaluation.value}\", operationResult=\"${evaluation.operationResult}\"`);\r\n        \r\n        results.push({\r\n          nodeId: cap.nodeId,\r\n          nodeLabel: cap.TreeBranchLeafNode?.label || null,\r\n          sourceRef: cap.sourceRef!,\r\n          operationSource: evaluation.operationSource as string,\r\n          // \uD83D\uDD25 STRUCTURE CORRECTE: value directement au niveau racine pour SmartCalculatedField\r\n          value: evaluation.value,              // \u2705 VALEUR CALCUL\u00C9E (utilis\u00E9e par SmartCalculatedField)\r\n          calculatedValue: evaluation.value,    // \u2705 ALIAS pour compatibilit\u00E9\r\n          operationResult: {\r\n            value: evaluation.value,            // \u2705 Aussi dans operationResult pour tra\u00E7abilit\u00E9\r\n            humanText: evaluation.operationResult,  // \u2705 Le texte explicatif\r\n            detail: evaluation.operationDetail\r\n          },\r\n          operationDetail: evaluation.operationDetail,\r\n          // \uD83C\uDFA8 NOUVEAU: Configuration d'affichage depuis TreeBranchLeafNodeVariable\r\n          displayConfig: {\r\n            displayFormat: cap.displayFormat || 'number',\r\n            unit: cap.unit || null,\r\n            precision: cap.precision ?? 2,\r\n            visibleToUser: cap.visibleToUser ?? true\r\n          }\r\n        });\r\n        evaluated++;\r\n      } catch (e) {\r\n        console.error(`[UNIVERSAL] \u274C Erreur \u00E9valuation pour nodeId ${cap.nodeId}:`, e);\r\n        // Ne bloque pas l'ensemble de la pr\u00E9visualisation\r\n        const errorMessage = e instanceof Error ? e.message : 'Erreur inconnue';\r\n        results.push({\r\n          nodeId: cap.nodeId,\r\n          nodeLabel: cap.TreeBranchLeafNode?.label || null,\r\n          sourceRef: cap.sourceRef!,\r\n          operationSource: 'error',\r\n          value: null,                    // \u2705 Valeur nulle pour les erreurs\r\n          calculatedValue: null,          // \u2705 ALIAS\r\n          operationResult: { \r\n            value: null,                  // \u2705 Valeur nulle\r\n            humanText: errorMessage,      // \u2705 Message d'erreur\r\n            error: errorMessage \r\n          },\r\n          operationDetail: null,\r\n          // \uD83C\uDFA8 Configuration d'affichage m\u00EAme en cas d'erreur\r\n          displayConfig: {\r\n            displayFormat: cap.displayFormat || 'number',\r\n            unit: cap.unit || null,\r\n            precision: cap.precision ?? 2,\r\n            visibleToUser: cap.visibleToUser ?? true\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    // \uD83D\uDD0D DEBUG: Log final des r\u00E9sultats avant envoi\r\n    console.log(`[PREVIEW-EVALUATE] \uD83D\uDCE4 Envoi r\u00E9ponse avec ${results.length} r\u00E9sultats:`);\r\n    results.forEach((r, i) => {\r\n      console.log(`  [${i}] nodeId=\"${r.nodeId}\", label=\"${r.nodeLabel}\", value=\"${r.value}\" (calculatedValue=\"${r.calculatedValue}\")`);\r\n    });\r\n\r\n    // \uD83D\uDCBE STOCKER LES VALEURS CALCUL\u00C9ES DANS PRISMA\r\n    try {\r\n      const calculatedValues = results\r\n        .filter(r => {\r\n          // Exclure null, undefined, cha\u00EEnes vides, et symboles de vide (\u2205)\r\n          if (r.value === null || r.value === undefined) return false;\r\n          const strValue = String(r.value).trim();\r\n          if (strValue === '' || strValue === '\u2205') return false;\r\n          return true;\r\n        })\r\n        .map(r => ({\r\n          nodeId: r.nodeId,\r\n          calculatedValue: String(r.value),\r\n          calculatedBy: `preview-${userId}`\r\n        }));\r\n\r\n      if (calculatedValues.length > 0) {\r\n        await storeCalculatedValues(calculatedValues, submissionId);\r\n        console.log(`[PREVIEW-EVALUATE] \u2705 ${calculatedValues.length} valeurs stock\u00E9es dans Prisma`);\r\n      }\r\n    } catch (storeError) {\r\n      console.error(`[PREVIEW-EVALUATE] \u26A0\uFE0F Erreur stockage valeurs calcul\u00E9es:`, storeError);\r\n      // Ne pas bloquer la r\u00E9ponse si le stockage \u00E9choue\r\n    }\r\n\r\n    return res.json({\r\n      success: true,\r\n      mode: 'preview',\r\n      submissionId,\r\n      treeId: effectiveTreeId,\r\n      evaluated,\r\n      results\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [TBL PREVIEW-EVALUATE] Erreur:', error);\r\n    return res.status(500).json({ success: false, error: error instanceof Error ? error.message : 'Erreur interne' });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83E\uDDF1 STAGING API \u2014 aucune \u00E9criture DB tant que non \"commit\"\r\n */\r\nrouter.post('/submissions/stage', async (req, res) => {\r\n  try {\r\n    pruneStages();\r\n    const { stageId, treeId, submissionId, formData } = req.body || {};\r\n    const organizationId = req.headers['x-organization-id'] as string || (req as AuthenticatedRequest).user?.organizationId;\r\n    const userId = (req as AuthenticatedRequest).user?.userId || 'unknown-user';\r\n    if (!organizationId) return res.status(400).json({ success: false, error: 'Organisation ID manquant' });\r\n\r\n    // R\u00E9soudre treeId\r\n    let effectiveTreeId = treeId as string | undefined;\r\n    if (!effectiveTreeId) {\r\n      const firstTree = await prisma.treeBranchLeafTree.findFirst({ select: { id: true } });\r\n      if (!firstTree) return res.status(404).json({ success: false, error: 'Aucun arbre trouv\u00E9' });\r\n      effectiveTreeId = firstTree.id;\r\n    }\r\n\r\n    const id = stageId || newStageId();\r\n    const clean = formData && typeof formData === 'object' ? (sanitizeFormData(formData) as Record<string, unknown>) : {};\r\n    const existing = stagingStore.get(id);\r\n    const merged: StageRecord = {\r\n      id,\r\n      organizationId,\r\n      userId,\r\n      treeId: effectiveTreeId!,\r\n      submissionId: submissionId || existing?.submissionId,\r\n      formData: { ...(existing?.formData || {}), ...clean },\r\n      updatedAt: Date.now()\r\n    };\r\n    stagingStore.set(id, merged);\r\n    return res.json({ success: true, stage: merged });\r\n  } catch (e) {\r\n    return res.status(500).json({ success: false, error: e instanceof Error ? e.message : 'Erreur interne' });\r\n  }\r\n});\r\n\r\nrouter.post('/submissions/stage/preview', async (req, res) => {\r\n  try {\r\n    pruneStages();\r\n    const { stageId } = req.body || {};\r\n    const stage = stageId ? stagingStore.get(stageId) : undefined;\r\n    if (!stage) return res.status(404).json({ success: false, error: 'Stage introuvable' });\r\n\r\n    // Utilise le m\u00EAme moteur que preview-evaluate\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({ where: { treeId: stage.treeId }, select: { id: true, label: true } });\r\n    const labelMap = new Map(nodes.map(n => [n.id, n.label] as const));\r\n    const valueMap = new Map<string, unknown>();\r\n    if (stage.submissionId) {\r\n      const existingData = await prisma.treeBranchLeafSubmissionData.findMany({\r\n        where: { submissionId: stage.submissionId },\r\n        select: { nodeId: true, value: true }\r\n      });\r\n\r\n      const existingEntries = existingData.map(r => [r.nodeId, r.value] as [string, unknown]);\r\n      await applySharedReferenceValues(valueMap, existingEntries, stage.treeId);\r\n    }\r\n\r\n    const stageEntries = Object.entries(stage.formData) as Array<[string, unknown]>;\r\n    await applySharedReferenceValues(valueMap, stageEntries, stage.treeId);\r\n\r\n    const capacities = await prisma.treeBranchLeafNodeVariable.findMany({ where: { TreeBranchLeafNode: { treeId: stage.treeId }, sourceRef: { not: null } }, include: { TreeBranchLeafNode: { select: { id: true, label: true } } } });\r\n    const context = { submissionId: stage.submissionId || `preview-${Date.now()}`, organizationId: stage.organizationId, userId: stage.userId, treeId: stage.treeId, labelMap, valueMap } as const;\r\n    const results = [] as Array<{ nodeId: string; nodeLabel: string | null; sourceRef: string; operationSource: string; operationResult: unknown; operationDetail: unknown }>;\r\n    for (const c of capacities) {\r\n      try {\r\n        // \u2728 Utilisation du syst\u00E8me unifi\u00E9 operation-interpreter\r\n        const r = await evaluateVariableOperation(\r\n          c.nodeId,\r\n          context.submissionId,\r\n          prisma,\r\n          context.valueMap\r\n        );\r\n        results.push({ \r\n          nodeId: c.nodeId, \r\n          nodeLabel: c.TreeBranchLeafNode?.label || null, \r\n          sourceRef: c.sourceRef!, \r\n          operationSource: (r.operationSource || 'neutral') as string,\r\n          value: r.value,                     // \u2705 VALEUR CALCUL\u00C9E\r\n          calculatedValue: r.value,           // \u2705 ALIAS\r\n          operationResult: {\r\n            value: r.value,\r\n            humanText: r.operationResult,\r\n            detail: r.operationDetail\r\n          },\r\n          operationDetail: r.operationDetail \r\n        });\r\n      } catch (e) {\r\n        const errorMessage = e instanceof Error ? e.message : 'Erreur';\r\n        results.push({ \r\n          nodeId: c.nodeId, \r\n          nodeLabel: c.TreeBranchLeafNode?.label || null, \r\n          sourceRef: c.sourceRef!, \r\n          operationSource: 'error',\r\n          value: null,                        // \u2705 Valeur nulle\r\n          calculatedValue: null,              // \u2705 ALIAS\r\n          operationResult: { \r\n            value: null,\r\n            humanText: errorMessage,\r\n            error: errorMessage \r\n          }, \r\n          operationDetail: null \r\n        });\r\n      }\r\n    }\r\n    return res.json({ success: true, stageId: stage.id, results });\r\n  } catch (e) {\r\n    return res.status(500).json({ success: false, error: e instanceof Error ? e.message : 'Erreur interne' });\r\n  }\r\n});\r\n\r\nrouter.post('/submissions/stage/commit', async (req, res) => {\r\n  try {\r\n    pruneStages();\r\n    const { stageId, asNew } = req.body || {};\r\n    const stage = stageId ? stagingStore.get(stageId) : undefined;\r\n    if (!stage) return res.status(404).json({ success: false, error: 'Stage introuvable' });\r\n\r\n    if (!asNew && stage.submissionId) {\r\n      // commit sur devis existant\r\n      const submission = await prisma.treeBranchLeafSubmission.findUnique({ where: { id: stage.submissionId } });\r\n      if (!submission) return res.status(404).json({ success: false, error: 'Soumission introuvable' });\r\n      // update exportData (NO-OP) + donn\u00E9es neutral + \u00E9valuations\r\n      await prisma.treeBranchLeafSubmission.update({ where: { id: stage.submissionId }, data: { exportData: stage.formData as unknown as Prisma.InputJsonValue } });\r\n  const saved = await saveUserEntriesNeutral(stage.submissionId, stage.formData, stage.treeId);\r\n      const stats = await evaluateCapacitiesForSubmission(stage.submissionId, stage.organizationId, stage.userId, stage.treeId);\r\n      return res.json({ success: true, submissionId: stage.submissionId, saved, stats });\r\n    }\r\n\r\n    // commit en nouveau devis\r\n    const submissionId = `tbl-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;\r\n    await prisma.treeBranchLeafSubmission.create({ data: { id: submissionId, treeId: stage.treeId, userId: stage.userId, status: 'draft', summary: { name: `Devis TBL ${new Date().toLocaleDateString()}` }, exportData: stage.formData as unknown as Prisma.InputJsonValue, updatedAt: new Date() } });\r\n  const saved = await saveUserEntriesNeutral(submissionId, stage.formData, stage.treeId);\r\n    const stats = await evaluateCapacitiesForSubmission(submissionId, stage.organizationId, stage.userId, stage.treeId);\r\n    // attacher l\u2019id cr\u00E9\u00E9 au stage pour permettre des commit suivants sur ce m\u00EAme devis\r\n    stage.submissionId = submissionId; stage.updatedAt = Date.now(); stagingStore.set(stage.id, stage);\r\n    return res.status(201).json({ success: true, submissionId, saved, stats });\r\n  } catch (e) {\r\n    return res.status(500).json({ success: false, error: e instanceof Error ? e.message : 'Erreur interne' });\r\n  }\r\n});\r\n\r\nrouter.post('/submissions/stage/discard', (req, res) => {\r\n  pruneStages();\r\n  const { stageId } = req.body || {};\r\n  if (!stageId || !stagingStore.has(stageId)) return res.json({ success: true, discarded: false });\r\n  stagingStore.delete(stageId);\r\n  return res.json({ success: true, discarded: true });\r\n});\r\n\r\n/**\r\n * \uD83D\uDD25 GET /api/tbl/tables/:tableId\r\n * \r\n * R\u00E9cup\u00E8re les informations compl\u00E8tes d'une table (structure + lookup config)\r\n * Utilis\u00E9 par SmartCalculatedField pour les r\u00E9f\u00E9rences @table.xxx\r\n */\r\nrouter.get('/tables/:tableId', async (req, res) => {\r\n  try {\r\n    const { tableId } = req.params;\r\n    \r\n    console.log(`\uD83D\uDCCA [GET TABLE] R\u00E9cup\u00E9ration table: ${tableId}`);\r\n    \r\n    // \u2705 CORRIG\u00C9: R\u00E9cup\u00E9rer la table depuis TreeBranchLeafNodeTable\r\n    const table = await prisma.treeBranchLeafNodeTable.findUnique({\r\n      where: { id: tableId },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        nodeId: true,\r\n        meta: true,\r\n      }\r\n    });\r\n    \r\n    if (!table) {\r\n      console.log(`\u274C [GET TABLE] Table introuvable: ${tableId}`);\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: 'Table introuvable'\r\n      });\r\n    }\r\n    \r\n    console.log(`\u2705 [GET TABLE] Table trouv\u00E9e: ${table.name || tableId}`);\r\n    \r\n    // Extraire la configuration de lookup depuis meta\r\n    const meta = table.meta as any;\r\n    const lookupConfig = meta?.lookup || {};\r\n    \r\n    // Extraire les donn\u00E9es de la table (colonnes, lignes, data matrix)\r\n    const tableData = meta?.data || {};\r\n    const columns = tableData.columns || [];\r\n    const rows = tableData.rows || [];\r\n    const data = tableData.matrix || [];\r\n    \r\n    console.log(`\uD83D\uDCCA [GET TABLE] Donn\u00E9es extraites:`, {\r\n      columnsCount: columns.length,\r\n      rowsCount: rows.length,\r\n      dataRowsCount: data.length,\r\n      lookupEnabled: lookupConfig.rowLookupEnabled || lookupConfig.columnLookupEnabled\r\n    });\r\n    \r\n    // Retourner les informations de la table AVEC les donn\u00E9es\r\n    return res.json({\r\n      success: true,\r\n      table: {\r\n        id: table.id,\r\n        nodeId: table.nodeId,\r\n        name: table.name || null,\r\n        type: 'matrix', // Type de table\r\n        sourceRef: `@table.${table.id}`,\r\n        // \uD83D\uDD25 DONN\u00C9ES DE LA TABLE (colonnes, lignes, data)\r\n        columns: columns,\r\n        rows: rows,\r\n        data: data,\r\n        // \uD83D\uDD25 CONFIGURATION DE LOOKUP\r\n        meta: {\r\n          lookup: {\r\n            enabled: lookupConfig.rowLookupEnabled || lookupConfig.columnLookupEnabled || false,\r\n            mode: lookupConfig.mode || 'columns',\r\n            rowLookupEnabled: lookupConfig.rowLookupEnabled || false,\r\n            columnLookupEnabled: lookupConfig.columnLookupEnabled || false,\r\n            selectors: {\r\n              rowFieldId: lookupConfig.selectors?.rowFieldId || null,\r\n              columnFieldId: lookupConfig.selectors?.columnFieldId || null,\r\n            },\r\n            displayRow: lookupConfig.displayRow || null,\r\n            displayColumn: lookupConfig.displayColumn || null\r\n          }\r\n        }\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C [GET TABLE] Erreur:', error);\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la r\u00E9cup\u00E9ration de la table',\r\n      details: error instanceof Error ? error.message : 'Erreur inconnue'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83C\uDFAF Service Backend pour stocker les valeurs calcul\u00E9es dans Prisma\r\n * \r\n * Apr\u00E8s que le backend calcule les formules/tables/conditions,\r\n * ce service stocke les r\u00E9sultats dans TreeBranchLeafNode.calculatedValue\r\n * \r\n * Utilisation:\r\n * const results = await storeCalculatedValues(nodeValues, submissionId);\r\n */\r\n\r\nimport { prisma } from '../lib/prisma';\r\n\r\nexport interface CalculatedValueInput {\r\n  nodeId: string;\r\n  calculatedValue: string | number | boolean;\r\n  calculatedBy?: string; // \"formula-abc\", \"table-def\", \"condition-ghi\"\r\n  submissionId?: string; // Pour audit\r\n}\r\n\r\nexport interface StoreCalculatedValuesResult {\r\n  success: boolean;\r\n  stored: number;\r\n  failed: number;\r\n  errors: Array<{ nodeId: string; error: string }>;\r\n}\r\n\r\n/**\r\n * Stocke plusieurs valeurs calcul\u00E9es \u00E0 la fois\r\n * \r\n * @param values - Liste des valeurs \u00E0 stocker\r\n * @param submissionId - (Optionnel) ID de la soumission pour contexte\r\n * @returns R\u00E9sultat du stockage\r\n */\r\nexport async function storeCalculatedValues(\r\n  values: CalculatedValueInput[],\r\n  submissionId?: string\r\n): Promise<StoreCalculatedValuesResult> {\r\n  const result: StoreCalculatedValuesResult = {\r\n    success: true,\r\n    stored: 0,\r\n    failed: 0,\r\n    errors: []\r\n  };\r\n\r\n  console.log(`\uD83D\uDCCA [StoreCalculatedValues] D\u00E9but stockage de ${values.length} valeurs`, {\r\n    submissionId,\r\n    timestamp: new Date().toISOString()\r\n  });\r\n\r\n  for (const value of values) {\r\n    try {\r\n      const { nodeId, calculatedValue, calculatedBy = 'unknown' } = value;\r\n\r\n      if (!nodeId) {\r\n        result.errors.push({ nodeId: 'unknown', error: 'nodeId manquant' });\r\n        result.failed++;\r\n        continue;\r\n      }\r\n\r\n      // \uD83C\uDFAF V\u00E9rifier que le n\u0153ud existe\r\n      const node = await prisma.treeBranchLeafNode.findUnique({\r\n        where: { id: nodeId },\r\n        select: { id: true, label: true }\r\n      });\r\n\r\n      if (!node) {\r\n        result.errors.push({ \r\n          nodeId, \r\n          error: 'N\u0153ud non trouv\u00E9' \r\n        });\r\n        result.failed++;\r\n        continue;\r\n      }\r\n\r\n      // \uD83C\uDFAF Stocker la valeur calcul\u00E9e\r\n      await prisma.treeBranchLeafNode.update({\r\n        where: { id: nodeId },\r\n        data: {\r\n          calculatedValue: String(calculatedValue),\r\n          calculatedAt: new Date(),\r\n          calculatedBy\r\n        }\r\n      });\r\n\r\n      result.stored++;\r\n\r\n      console.log(`\u2705 [StoreCalculatedValues] Valeur stock\u00E9e:`, {\r\n        nodeId,\r\n        label: node.label,\r\n        calculatedValue,\r\n        calculatedBy,\r\n        submissionId\r\n      });\r\n    } catch (error) {\r\n      result.failed++;\r\n      result.errors.push({\r\n        nodeId: value.nodeId,\r\n        error: error instanceof Error ? error.message : String(error)\r\n      });\r\n\r\n      console.error(`\u274C [StoreCalculatedValues] Erreur stockage:`, {\r\n        nodeId: value.nodeId,\r\n        error,\r\n        submissionId\r\n      });\r\n    }\r\n  }\r\n\r\n  console.log(`\uD83D\uDCCA [StoreCalculatedValues] Fin stockage:`, {\r\n    stored: result.stored,\r\n    failed: result.failed,\r\n    total: values.length,\r\n    submissionId,\r\n    errors: result.errors.length > 0 ? result.errors : undefined\r\n  });\r\n\r\n  result.success = result.failed === 0;\r\n  return result;\r\n}\r\n\r\n/**\r\n * Stocke UNE SEULE valeur calcul\u00E9e\r\n * \r\n * @param nodeId - ID du n\u0153ud\r\n * @param calculatedValue - Valeur \u00E0 stocker\r\n * @param calculatedBy - Source du calcul (optionnel)\r\n * @returns La valeur stock\u00E9e\r\n */\r\nexport async function storeCalculatedValue(\r\n  nodeId: string,\r\n  calculatedValue: string | number | boolean,\r\n  calculatedBy: string = 'unknown'\r\n): Promise<{ success: boolean; value?: string; error?: string }> {\r\n  try {\r\n    const updated = await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        calculatedValue: String(calculatedValue),\r\n        calculatedAt: new Date(),\r\n        calculatedBy\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        calculatedValue: true,\r\n        calculatedAt: true,\r\n        calculatedBy: true\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 [storeCalculatedValue] Valeur stock\u00E9e:', {\r\n      nodeId,\r\n      label: updated.label,\r\n      value: updated.calculatedValue,\r\n      calculatedBy: updated.calculatedBy\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      value: updated.calculatedValue || undefined\r\n    };\r\n  } catch (error) {\r\n    console.error('\u274C [storeCalculatedValue] Erreur:', {\r\n      nodeId,\r\n      error\r\n    });\r\n\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : String(error)\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * R\u00E9cup\u00E8re UNE valeur calcul\u00E9e (sans requ\u00EAte API)\r\n * \r\n * @param nodeId - ID du n\u0153ud\r\n * @returns La valeur calcul\u00E9e\r\n */\r\nexport async function getCalculatedValue(nodeId: string): Promise<string | null> {\r\n  try {\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: { id: nodeId },\r\n      select: { calculatedValue: true }\r\n    });\r\n\r\n    return node?.calculatedValue ?? null;\r\n  } catch (error) {\r\n    console.error('\u274C [getCalculatedValue] Erreur:', { nodeId, error });\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * R\u00E9cup\u00E8re TOUTES les valeurs calcul\u00E9es pour des n\u0153uds donn\u00E9s\r\n * \r\n * @param nodeIds - Liste des IDs de n\u0153uds\r\n * @returns Map nodeId -> calculatedValue\r\n */\r\nexport async function getCalculatedValues(\r\n  nodeIds: string[]\r\n): Promise<Record<string, string | null>> {\r\n  try {\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: {\r\n        id: { in: nodeIds }\r\n      },\r\n      select: {\r\n        id: true,\r\n        calculatedValue: true\r\n      }\r\n    });\r\n\r\n    const result: Record<string, string | null> = {};\r\n    for (const nodeId of nodeIds) {\r\n      const node = nodes.find(n => n.id === nodeId);\r\n      result[nodeId] = node?.calculatedValue ?? null;\r\n    }\r\n\r\n    return result;\r\n  } catch (error) {\r\n    console.error('\u274C [getCalculatedValues] Erreur:', { error });\r\n    return {};\r\n  }\r\n}\r\n\r\n/**\r\n * Efface les valeurs calcul\u00E9es pour r\u00E9initialiser\r\n * \r\n * @param nodeIds - Liste des IDs de n\u0153uds \u00E0 r\u00E9initialiser\r\n * @returns Nombre de n\u0153uds r\u00E9initialis\u00E9s\r\n */\r\nexport async function clearCalculatedValues(nodeIds: string[]): Promise<number> {\r\n  try {\r\n    const result = await prisma.treeBranchLeafNode.updateMany({\r\n      where: {\r\n        id: { in: nodeIds }\r\n      },\r\n      data: {\r\n        calculatedValue: null,\r\n        calculatedAt: null,\r\n        calculatedBy: null\r\n      }\r\n    });\r\n\r\n    console.log('\uD83D\uDDD1\uFE0F [clearCalculatedValues] Valeurs r\u00E9initialis\u00E9es:', {\r\n      count: result.count,\r\n      nodeIds: nodeIds.length\r\n    });\r\n\r\n    return result.count;\r\n  } catch (error) {\r\n    console.error('\u274C [clearCalculatedValues] Erreur:', { error });\r\n    return 0;\r\n  }\r\n}\r\n", "/**\r\n * \uD83C\uDFAF Contr\u00F4leur pour g\u00E9rer les valeurs calcul\u00E9es\r\n * \r\n * GET  /api/tree-nodes/:nodeId/calculated-value\r\n * POST /api/tree-nodes/:nodeId/store-calculated-value\r\n * POST /api/tree-nodes/store-batch-calculated-values\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { prisma } from '../lib/prisma';\r\n\r\nconst router = Router();\r\n\r\n/**\r\n * GET /api/tree-nodes/:nodeId/calculated-value\r\n * \r\n * R\u00E9cup\u00E8re la valeur calcul\u00E9e stock\u00E9e dans Prisma\r\n */\r\nrouter.get('/:nodeId/calculated-value', async (req: Request, res: Response) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { _submissionId } = req.query;\r\n\r\n    if (!nodeId) {\r\n      return res.status(400).json({ error: 'nodeId requis' });\r\n    }\r\n\r\n    // \uD83C\uDFAF Chercher le n\u0153ud et r\u00E9cup\u00E9rer sa valeur calcul\u00E9e\r\n    const node = await prisma.treeBranchLeafNode.findUnique({\r\n      where: {\r\n        id: nodeId\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        calculatedValue: true,\r\n        calculatedAt: true,\r\n        calculatedBy: true,\r\n        type: true,\r\n        fieldType: true\r\n      }\r\n    });\r\n\r\n    if (!node) {\r\n      return res.status(404).json({ error: 'N\u0153ud non trouv\u00E9' });\r\n    }\r\n\r\n    // \u2705 Retourner la valeur calcul\u00E9e\r\n    return res.json({\r\n      success: true,\r\n      nodeId: node.id,\r\n      label: node.label,\r\n      value: node.calculatedValue,\r\n      calculatedAt: node.calculatedAt,\r\n      calculatedBy: node.calculatedBy,\r\n      type: node.type,\r\n      fieldType: node.fieldType\r\n    });\r\n  } catch (error) {\r\n    console.error('[CalculatedValueController] GET erreur:', error);\r\n    return res.status(500).json({ error: String(error) });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/tree-nodes/:nodeId/store-calculated-value\r\n * \r\n * Stocke une valeur calcul\u00E9e dans le n\u0153ud\r\n */\r\nrouter.post('/:nodeId/store-calculated-value', async (req: Request, res: Response) => {\r\n  try {\r\n    const { nodeId } = req.params;\r\n    const { calculatedValue, calculatedBy, submissionId } = req.body;\r\n\r\n    if (!nodeId) {\r\n      return res.status(400).json({ error: 'nodeId requis' });\r\n    }\r\n\r\n    if (calculatedValue === undefined) {\r\n      return res.status(400).json({ error: 'calculatedValue requis' });\r\n    }\r\n\r\n    // \uD83C\uDFAF Mettre \u00E0 jour le n\u0153ud avec la valeur calcul\u00E9e\r\n    const updated = await prisma.treeBranchLeafNode.update({\r\n      where: { id: nodeId },\r\n      data: {\r\n        calculatedValue: String(calculatedValue),\r\n        calculatedAt: new Date(),\r\n        calculatedBy: calculatedBy || 'unknown'\r\n      },\r\n      select: {\r\n        id: true,\r\n        label: true,\r\n        calculatedValue: true,\r\n        calculatedAt: true,\r\n        calculatedBy: true\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 [CalculatedValueController] Valeur stock\u00E9e:', {\r\n      nodeId,\r\n      calculatedValue,\r\n      calculatedBy,\r\n      submissionId\r\n    });\r\n\r\n    return res.json({\r\n      success: true,\r\n      nodeId: updated.id,\r\n      calculatedValue: updated.calculatedValue,\r\n      calculatedAt: updated.calculatedAt,\r\n      calculatedBy: updated.calculatedBy\r\n    });\r\n  } catch (error) {\r\n    console.error('[CalculatedValueController] POST erreur:', error);\r\n    return res.status(500).json({ error: String(error) });\r\n  }\r\n});\r\n\r\n/**\r\n * BATCH POST /api/tree-nodes/store-batch-calculated-values\r\n * \r\n * Stocke plusieurs valeurs calcul\u00E9es \u00E0 la fois\r\n * Utile apr\u00E8s une soumission de formulaire complet\r\n */\r\nrouter.post('/store-batch-calculated-values', async (req: Request, res: Response) => {\r\n  try {\r\n    const { values, submissionId } = req.body;\r\n\r\n    if (!Array.isArray(values) || values.length === 0) {\r\n      return res.status(400).json({ error: 'values doit \u00EAtre un tableau non-vide' });\r\n    }\r\n\r\n    // \uD83C\uDFAF Mettre \u00E0 jour tous les n\u0153uds\r\n    const results = [];\r\n    for (const { nodeId, calculatedValue, calculatedBy } of values) {\r\n      if (!nodeId) continue;\r\n\r\n      try {\r\n        const updated = await prisma.treeBranchLeafNode.update({\r\n          where: { id: nodeId },\r\n          data: {\r\n            calculatedValue: String(calculatedValue),\r\n            calculatedAt: new Date(),\r\n            calculatedBy: calculatedBy || 'unknown'\r\n          }\r\n        });\r\n\r\n        results.push({\r\n          nodeId,\r\n          success: true,\r\n          calculatedValue: updated.calculatedValue\r\n        });\r\n      } catch (err) {\r\n        results.push({\r\n          nodeId,\r\n          success: false,\r\n          error: String(err)\r\n        });\r\n      }\r\n    }\r\n\r\n    console.log('\u2705 [CalculatedValueController] BATCH stockage:', {\r\n      submissionId,\r\n      total: values.length,\r\n      success: results.filter(r => r.success).length,\r\n      failed: results.filter(r => !r.success).length\r\n    });\r\n\r\n    return res.json({\r\n      success: true,\r\n      results,\r\n      submissionId\r\n    });\r\n  } catch (error) {\r\n    console.error('[CalculatedValueController] BATCH POST erreur:', error);\r\n    return res.status(500).json({ error: String(error) });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * API Routes pour la gestion des sites web\r\n * GET /api/websites - Liste des sites\r\n * GET /api/websites/:slug - D\u00E9tails complets d'un site\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { authenticateToken } from '../middleware/auth';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// \u26A0\uFE0F IMPORTANT: Les routes GET sont publiques (affichage site vitrine)\r\n// Les routes POST/PUT/PATCH/DELETE sont prot\u00E9g\u00E9es par authenticateToken\r\n\r\n/**\r\n * GET /api/websites\r\n * Liste tous les sites web d'une organisation\r\n * Query param: ?all=true pour voir tous les sites (Super Admin uniquement)\r\n * \uD83D\uDD12 PROT\u00C9G\u00C9E: N\u00E9cessite authentification (admin seulement)\r\n */\r\nrouter.get('/websites', authenticateToken, async (req: Request, res: Response) => {\r\n  try {\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    const showAll = req.query.all === 'true';\r\n\r\n    if (!organizationId && !showAll) {\r\n      return res.status(400).json({ error: 'Organization ID is required' });\r\n    }\r\n\r\n    const whereClause: any = {\r\n      isActive: true\r\n    };\r\n\r\n    // Si pas de showAll, filtrer par organisation\r\n    if (!showAll && organizationId) {\r\n      whereClause.organizationId = organizationId;\r\n    }\r\n\r\n    const websites = await prisma.webSite.findMany({\r\n      where: whereClause,\r\n      include: {\r\n        config: true\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc'\r\n      }\r\n    });\r\n\r\n    res.json(websites);\r\n  } catch (error) {\r\n    console.error('Error fetching websites:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/websites/:slug\r\n * R\u00E9cup\u00E8re tous les d\u00E9tails d'un site par son slug\r\n */\r\nrouter.get('/websites/:slug', async (req: Request, res: Response) => {\r\n  try {\r\n    const { slug } = req.params;\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n\r\n    // Si pas d'organization ID dans les headers, on cherche le site publiquement\r\n    const whereClause: any = { slug, isActive: true };\r\n    if (organizationId) {\r\n      whereClause.organizationId = organizationId;\r\n    }\r\n\r\n    const website = await prisma.webSite.findFirst({\r\n      where: whereClause,\r\n      include: {\r\n        config: {\r\n          include: {\r\n            logoFile: true,\r\n            faviconFile: true,\r\n            heroBackgroundFile: true,\r\n            ogImageFile: true\r\n          }\r\n        },\r\n        sections: {\r\n          where: { isActive: true },\r\n          orderBy: { displayOrder: 'asc' }\r\n        },\r\n        services: {\r\n          where: { isActive: true },\r\n          orderBy: { displayOrder: 'asc' }\r\n        },\r\n        projects: {\r\n          where: { isActive: true },\r\n          orderBy: { displayOrder: 'asc' }\r\n        },\r\n        testimonials: {\r\n          where: { isActive: true },\r\n          orderBy: { displayOrder: 'asc' }\r\n        },\r\n        blogPosts: {\r\n          where: { isPublished: true },\r\n          orderBy: { publishedAt: 'desc' },\r\n          take: 10,\r\n          include: {\r\n            author: {\r\n              select: {\r\n                id: true,\r\n                firstName: true,\r\n                lastName: true,\r\n                avatarUrl: true\r\n              }\r\n            }\r\n          }\r\n        },\r\n        mediaFiles: {\r\n          where: { isPublic: true },\r\n          orderBy: { createdAt: 'desc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    // V\u00E9rifier si le site est en maintenance\r\n    if (website.maintenanceMode && !organizationId) {\r\n      return res.status(503).json({\r\n        error: 'Site en maintenance',\r\n        message: website.maintenanceMessage || 'Le site est temporairement indisponible.'\r\n      });\r\n    }\r\n\r\n    res.json(website);\r\n  } catch (error) {\r\n    console.error('Error fetching website:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/websites/:slug/services\r\n * R\u00E9cup\u00E8re uniquement les services d'un site\r\n */\r\nrouter.get('/websites/:slug/services', async (req: Request, res: Response) => {\r\n  try {\r\n    const { slug } = req.params;\r\n\r\n    const website = await prisma.webSite.findFirst({\r\n      where: { slug, isActive: true },\r\n      select: { id: true }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    const services = await prisma.webSiteService.findMany({\r\n      where: {\r\n        websiteId: website.id,\r\n        isActive: true\r\n      },\r\n      orderBy: { displayOrder: 'asc' }\r\n    });\r\n\r\n    res.json(services);\r\n  } catch (error) {\r\n    console.error('Error fetching services:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/websites/:slug/projects\r\n * R\u00E9cup\u00E8re uniquement les projets/r\u00E9alisations d'un site\r\n */\r\nrouter.get('/websites/:slug/projects', async (req: Request, res: Response) => {\r\n  try {\r\n    const { slug } = req.params;\r\n    const { featured } = req.query;\r\n\r\n    const website = await prisma.webSite.findFirst({\r\n      where: { slug, isActive: true },\r\n      select: { id: true }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    const whereClause: any = {\r\n      websiteId: website.id,\r\n      isActive: true\r\n    };\r\n\r\n    if (featured === 'true') {\r\n      whereClause.isFeatured = true;\r\n    }\r\n\r\n    const projects = await prisma.webSiteProject.findMany({\r\n      where: whereClause,\r\n      orderBy: { displayOrder: 'asc' }\r\n    });\r\n\r\n    res.json(projects);\r\n  } catch (error) {\r\n    console.error('Error fetching projects:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/websites/:slug/testimonials\r\n * R\u00E9cup\u00E8re uniquement les t\u00E9moignages d'un site\r\n */\r\nrouter.get('/websites/:slug/testimonials', async (req: Request, res: Response) => {\r\n  try {\r\n    const { slug } = req.params;\r\n    const { featured } = req.query;\r\n\r\n    const website = await prisma.webSite.findFirst({\r\n      where: { slug, isActive: true },\r\n      select: { id: true }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    const whereClause: any = {\r\n      websiteId: website.id,\r\n      isActive: true\r\n    };\r\n\r\n    if (featured === 'true') {\r\n      whereClause.isFeatured = true;\r\n    }\r\n\r\n    const testimonials = await prisma.webSiteTestimonial.findMany({\r\n      where: whereClause,\r\n      orderBy: { displayOrder: 'asc' }\r\n    });\r\n\r\n    res.json(testimonials);\r\n  } catch (error) {\r\n    console.error('Error fetching testimonials:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/websites/:slug/blog\r\n * R\u00E9cup\u00E8re les articles de blog d'un site\r\n */\r\nrouter.get('/websites/:slug/blog', async (req: Request, res: Response) => {\r\n  try {\r\n    const { slug } = req.params;\r\n    const { limit = '10', featured } = req.query;\r\n\r\n    const website = await prisma.webSite.findFirst({\r\n      where: { slug, isActive: true },\r\n      select: { id: true }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    const whereClause: any = {\r\n      websiteId: website.id,\r\n      isPublished: true\r\n    };\r\n\r\n    if (featured === 'true') {\r\n      whereClause.isFeatured = true;\r\n    }\r\n\r\n    const blogPosts = await prisma.webSiteBlogPost.findMany({\r\n      where: whereClause,\r\n      orderBy: { publishedAt: 'desc' },\r\n      take: parseInt(limit as string),\r\n      include: {\r\n        author: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            avatarUrl: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    res.json(blogPosts);\r\n  } catch (error) {\r\n    console.error('Error fetching blog posts:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * GET /api/websites/:slug/blog/:postSlug\r\n * R\u00E9cup\u00E8re un article de blog sp\u00E9cifique\r\n */\r\nrouter.get('/websites/:slug/blog/:postSlug', async (req: Request, res: Response) => {\r\n  try {\r\n    const { slug, postSlug } = req.params;\r\n\r\n    const website = await prisma.webSite.findFirst({\r\n      where: { slug, isActive: true },\r\n      select: { id: true }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    const blogPost = await prisma.webSiteBlogPost.findFirst({\r\n      where: {\r\n        websiteId: website.id,\r\n        slug: postSlug,\r\n        isPublished: true\r\n      },\r\n      include: {\r\n        author: {\r\n          select: {\r\n            id: true,\r\n            firstName: true,\r\n            lastName: true,\r\n            avatarUrl: true,\r\n            email: true\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (!blogPost) {\r\n      return res.status(404).json({ error: 'Blog post not found' });\r\n    }\r\n\r\n    res.json(blogPost);\r\n  } catch (error) {\r\n    console.error('Error fetching blog post:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * PUT /api/websites/:id\r\n * Met \u00E0 jour un site web\r\n * \uD83D\uDD12 PROT\u00C9G\u00C9E: N\u00E9cessite authentification\r\n */\r\nrouter.put('/websites/:id', authenticateToken, async (req: Request, res: Response) => {\r\n  try {\r\n    const websiteId = parseInt(req.params.id);\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    const data = req.body;\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organization ID is required' });\r\n    }\r\n\r\n    // V\u00E9rifier que le site appartient bien \u00E0 l'organisation\r\n    const existingWebsite = await prisma.webSite.findFirst({\r\n      where: {\r\n        id: websiteId,\r\n        organizationId\r\n      }\r\n    });\r\n\r\n    if (!existingWebsite) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    // Mettre \u00E0 jour le site\r\n    const updatedWebsite = await prisma.webSite.update({\r\n      where: { id: websiteId },\r\n      data: {\r\n        name: data.name,\r\n        slug: data.slug,\r\n        domain: data.domain,\r\n        description: data.description,\r\n        language: data.language,\r\n        timezone: data.timezone,\r\n        isActive: data.isActive,\r\n        maintenanceMode: data.maintenanceMode,\r\n        maintenanceMessage: data.maintenanceMessage,\r\n        analyticsCode: data.analyticsCode,\r\n        customCss: data.customCss,\r\n        customJs: data.customJs,\r\n        seoMetadata: data.seoMetadata\r\n      },\r\n      include: {\r\n        config: true\r\n      }\r\n    });\r\n\r\n    res.json(updatedWebsite);\r\n  } catch (error) {\r\n    console.error('Error updating website:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/websites\r\n * Cr\u00E9e un nouveau site web\r\n * \uD83D\uDD12 PROT\u00C9G\u00C9E: N\u00E9cessite authentification\r\n */\r\nrouter.post('/websites', authenticateToken, async (req: Request, res: Response) => {\r\n  try {\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    const data = req.body;\r\n\r\n    if (!organizationId) {\r\n      return res.status(400).json({ error: 'Organization ID is required' });\r\n    }\r\n\r\n    const newWebsite = await prisma.webSite.create({\r\n      data: {\r\n        name: data.name,\r\n        slug: data.slug,\r\n        domain: data.domain,\r\n        description: data.description,\r\n        language: data.language || 'fr',\r\n        timezone: data.timezone || 'Europe/Brussels',\r\n        organizationId,\r\n        isActive: true,\r\n        maintenanceMode: false\r\n      },\r\n      include: {\r\n        config: true\r\n      }\r\n    });\r\n\r\n    res.status(201).json(newWebsite);\r\n  } catch (error) {\r\n    console.error('Error creating website:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * DELETE /api/websites/:id\r\n * Supprime un site web et toutes ses donn\u00E9es associ\u00E9es (cascade)\r\n * Super Admin peut supprimer n'importe quel site\r\n * \uD83D\uDD12 PROT\u00C9G\u00C9E: N\u00E9cessite authentification\r\n */\r\nrouter.delete('/websites/:id', authenticateToken, async (req: Request, res: Response) => {\r\n  console.log('\uD83D\uDDD1\uFE0F [WEBSITES] DELETE /websites/:id atteint!');\r\n  console.log('\uD83D\uDDD1\uFE0F [WEBSITES] ID du site:', req.params.id);\r\n  \r\n  try {\r\n    const websiteId = parseInt(req.params.id);\r\n    const organizationId = req.headers['x-organization-id'] as string;\r\n    const user = (req as any).user;\r\n\r\n    console.log('\uD83D\uDDD1\uFE0F [WEBSITES] User:', user?.email, 'isSuperAdmin:', user?.isSuperAdmin);\r\n    console.log('\uD83D\uDDD1\uFE0F [WEBSITES] OrganizationId:', organizationId);\r\n\r\n    if (!organizationId && !user?.isSuperAdmin) {\r\n      console.log('\u274C [WEBSITES] Organization ID requis et user n\\'est pas Super Admin');\r\n      return res.status(400).json({ error: 'Organization ID is required' });\r\n    }\r\n\r\n    // Super Admin peut supprimer n'importe quel site\r\n    const whereClause: any = { id: websiteId };\r\n    \r\n    // Si ce n'est pas un Super Admin, on v\u00E9rifie l'organisation\r\n    if (!user?.isSuperAdmin && organizationId) {\r\n      whereClause.organizationId = organizationId;\r\n    }\r\n\r\n    // V\u00E9rifier que le site existe\r\n    const existingWebsite = await prisma.webSite.findFirst({\r\n      where: whereClause\r\n    });\r\n\r\n    if (!existingWebsite) {\r\n      return res.status(404).json({ error: 'Website not found' });\r\n    }\r\n\r\n    // Supprimer le site (cascade delete configur\u00E9 dans Prisma supprimera automatiquement:\r\n    // sections, services, projects, testimonials, blogPosts, mediaFiles, config)\r\n    await prisma.webSite.delete({\r\n      where: { id: websiteId }\r\n    });\r\n\r\n    console.log(`\u2705 Site web ${websiteId} (${existingWebsite.name}) supprim\u00E9 par ${user?.email || 'unknown'}`);\r\n    res.json({ \r\n      success: true, \r\n      message: `Site \"${existingWebsite.name}\" supprim\u00E9 avec succ\u00E8s` \r\n    });\r\n  } catch (error) {\r\n    console.error('Error deleting website:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * API Routes pour la gestion des services des sites web\r\n * CRUD complet + r\u00E9organisation\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * GET /api/website-services/:websiteId\r\n * Liste tous les services d'un site\r\n */\r\nrouter.get('/website-services/:websiteId', async (req: Request, res: Response) => {\r\n  try {\r\n    const { websiteId } = req.params;\r\n\r\n    const services = await prisma.webSiteService.findMany({\r\n      where: {\r\n        websiteId: parseInt(websiteId)\r\n      },\r\n      orderBy: {\r\n        displayOrder: 'asc'\r\n      }\r\n    });\r\n\r\n    res.json(services);\r\n  } catch (error) {\r\n    console.error('Error fetching services:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-services\r\n * Cr\u00E9e un nouveau service\r\n */\r\nrouter.post('/website-services', async (req: Request, res: Response) => {\r\n  try {\r\n    const { websiteId, key, icon, title, description, features, ctaText, ctaUrl, isActive } = req.body;\r\n\r\n    if (!websiteId || !key || !title) {\r\n      return res.status(400).json({ error: 'websiteId, key, and title are required' });\r\n    }\r\n\r\n    // Obtenir le prochain displayOrder\r\n    const maxOrder = await prisma.webSiteService.aggregate({\r\n      where: { websiteId: parseInt(websiteId) },\r\n      _max: { displayOrder: true }\r\n    });\r\n\r\n    const service = await prisma.webSiteService.create({\r\n      data: {\r\n        websiteId: parseInt(websiteId),\r\n        key,\r\n        icon: icon || 'CheckCircleOutlined',\r\n        title,\r\n        description: description || '',\r\n        features: features || [],\r\n        ctaText: ctaText || 'En savoir plus',\r\n        ctaUrl: ctaUrl || '',\r\n        isActive: isActive !== undefined ? isActive : true,\r\n        displayOrder: (maxOrder._max.displayOrder || 0) + 1\r\n      }\r\n    });\r\n\r\n    res.json(service);\r\n  } catch (error) {\r\n    console.error('Error creating service:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * PUT /api/website-services/:id\r\n * Modifie un service existant\r\n */\r\nrouter.put('/website-services/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { key, icon, title, description, features, ctaText, ctaUrl, isActive } = req.body;\r\n\r\n    const service = await prisma.webSiteService.update({\r\n      where: { id: parseInt(id) },\r\n      data: {\r\n        ...(key && { key }),\r\n        ...(icon && { icon }),\r\n        ...(title && { title }),\r\n        ...(description !== undefined && { description }),\r\n        ...(features && { features }),\r\n        ...(ctaText !== undefined && { ctaText }),\r\n        ...(ctaUrl !== undefined && { ctaUrl }),\r\n        ...(isActive !== undefined && { isActive })\r\n      }\r\n    });\r\n\r\n    res.json(service);\r\n  } catch (error) {\r\n    console.error('Error updating service:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * DELETE /api/website-services/:id\r\n * Supprime un service\r\n */\r\nrouter.delete('/website-services/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    await prisma.webSiteService.delete({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error deleting service:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-services/reorder\r\n * R\u00E9organise les services (drag & drop)\r\n */\r\nrouter.post('/website-services/reorder', async (req: Request, res: Response) => {\r\n  try {\r\n    const { services } = req.body; // Array de { id, displayOrder }\r\n\r\n    if (!Array.isArray(services)) {\r\n      return res.status(400).json({ error: 'services array is required' });\r\n    }\r\n\r\n    // Mettre \u00E0 jour l'ordre de chaque service\r\n    await Promise.all(\r\n      services.map((service: { id: number; displayOrder: number }) =>\r\n        prisma.webSiteService.update({\r\n          where: { id: service.id },\r\n          data: { displayOrder: service.displayOrder }\r\n        })\r\n      )\r\n    );\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error reordering services:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * API Routes pour la gestion des projets des sites web\r\n * CRUD complet + r\u00E9organisation\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * GET /api/website-projects/:websiteId\r\n * Liste tous les projets d'un site\r\n */\r\nrouter.get('/website-projects/:websiteId', async (req: Request, res: Response) => {\r\n  try {\r\n    const { websiteId } = req.params;\r\n\r\n    const projects = await prisma.webSiteProject.findMany({\r\n      where: {\r\n        websiteId: parseInt(websiteId)\r\n      },\r\n      orderBy: {\r\n        displayOrder: 'asc'\r\n      }\r\n    });\r\n\r\n    res.json(projects);\r\n  } catch (error) {\r\n    console.error('Error fetching projects:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-projects\r\n * Cr\u00E9e un nouveau projet\r\n */\r\nrouter.post('/website-projects', async (req: Request, res: Response) => {\r\n  try {\r\n    const { websiteId, title, location, details, tags, isActive, isFeatured, completedAt } = req.body;\r\n\r\n    if (!websiteId || !title) {\r\n      return res.status(400).json({ error: 'websiteId and title are required' });\r\n    }\r\n\r\n    const maxOrder = await prisma.webSiteProject.aggregate({\r\n      where: { websiteId: parseInt(websiteId) },\r\n      _max: { displayOrder: true }\r\n    });\r\n\r\n    const project = await prisma.webSiteProject.create({\r\n      data: {\r\n        websiteId: parseInt(websiteId),\r\n        title,\r\n        location: location || '',\r\n        details: details || '',\r\n        tags: tags || [],\r\n        isActive: isActive !== undefined ? isActive : true,\r\n        isFeatured: isFeatured || false,\r\n        displayOrder: (maxOrder._max.displayOrder || 0) + 1,\r\n        completedAt: completedAt ? new Date(completedAt) : new Date()\r\n      }\r\n    });\r\n\r\n    res.json(project);\r\n  } catch (error) {\r\n    console.error('Error creating project:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * PUT /api/website-projects/:id\r\n * Modifie un projet existant\r\n */\r\nrouter.put('/website-projects/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { title, location, details, tags, isActive, isFeatured, completedAt } = req.body;\r\n\r\n    const project = await prisma.webSiteProject.update({\r\n      where: { id: parseInt(id) },\r\n      data: {\r\n        ...(title && { title }),\r\n        ...(location !== undefined && { location }),\r\n        ...(details !== undefined && { details }),\r\n        ...(tags && { tags }),\r\n        ...(isActive !== undefined && { isActive }),\r\n        ...(isFeatured !== undefined && { isFeatured }),\r\n        ...(completedAt && { completedAt: new Date(completedAt) })\r\n      }\r\n    });\r\n\r\n    res.json(project);\r\n  } catch (error) {\r\n    console.error('Error updating project:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * DELETE /api/website-projects/:id\r\n * Supprime un projet\r\n */\r\nrouter.delete('/website-projects/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    await prisma.webSiteProject.delete({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error deleting project:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-projects/reorder\r\n * R\u00E9organise les projets (drag & drop)\r\n */\r\nrouter.post('/website-projects/reorder', async (req: Request, res: Response) => {\r\n  try {\r\n    const { projects } = req.body;\r\n\r\n    if (!Array.isArray(projects)) {\r\n      return res.status(400).json({ error: 'projects array is required' });\r\n    }\r\n\r\n    await Promise.all(\r\n      projects.map((project: { id: number; displayOrder: number }) =>\r\n        prisma.webSiteProject.update({\r\n          where: { id: project.id },\r\n          data: { displayOrder: project.displayOrder }\r\n        })\r\n      )\r\n    );\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error reordering projects:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * API Routes pour la gestion des t\u00E9moignages des sites web\r\n * CRUD complet + r\u00E9organisation\r\n */\r\n\r\nimport { Router, Request, Response } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n/**\r\n * GET /api/website-testimonials/:websiteId\r\n * Liste tous les t\u00E9moignages d'un site\r\n */\r\nrouter.get('/website-testimonials/:websiteId', async (req: Request, res: Response) => {\r\n  try {\r\n    const { websiteId } = req.params;\r\n\r\n    const testimonials = await prisma.webSiteTestimonial.findMany({\r\n      where: {\r\n        websiteId: parseInt(websiteId)\r\n      },\r\n      orderBy: {\r\n        displayOrder: 'asc'\r\n      }\r\n    });\r\n\r\n    res.json(testimonials);\r\n  } catch (error) {\r\n    console.error('Error fetching testimonials:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-testimonials\r\n * Cr\u00E9e un nouveau t\u00E9moignage\r\n */\r\nrouter.post('/website-testimonials', async (req: Request, res: Response) => {\r\n  try {\r\n    const { websiteId, customerName, location, service, rating, text, isActive, isFeatured, publishedAt } = req.body;\r\n\r\n    if (!websiteId || !customerName || !text) {\r\n      return res.status(400).json({ error: 'websiteId, customerName, and text are required' });\r\n    }\r\n\r\n    const maxOrder = await prisma.webSiteTestimonial.aggregate({\r\n      where: { websiteId: parseInt(websiteId) },\r\n      _max: { displayOrder: true }\r\n    });\r\n\r\n    const testimonial = await prisma.webSiteTestimonial.create({\r\n      data: {\r\n        websiteId: parseInt(websiteId),\r\n        customerName,\r\n        location: location || '',\r\n        service: service || '',\r\n        rating: rating || 5,\r\n        text,\r\n        isActive: isActive !== undefined ? isActive : true,\r\n        isFeatured: isFeatured || false,\r\n        displayOrder: (maxOrder._max.displayOrder || 0) + 1,\r\n        publishedAt: publishedAt ? new Date(publishedAt) : new Date()\r\n      }\r\n    });\r\n\r\n    res.json(testimonial);\r\n  } catch (error) {\r\n    console.error('Error creating testimonial:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * PUT /api/website-testimonials/:id\r\n * Modifie un t\u00E9moignage existant\r\n */\r\nrouter.put('/website-testimonials/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { customerName, location, service, rating, text, isActive, isFeatured, publishedAt } = req.body;\r\n\r\n    const testimonial = await prisma.webSiteTestimonial.update({\r\n      where: { id: parseInt(id) },\r\n      data: {\r\n        ...(customerName && { customerName }),\r\n        ...(location !== undefined && { location }),\r\n        ...(service !== undefined && { service }),\r\n        ...(rating !== undefined && { rating }),\r\n        ...(text !== undefined && { text }),\r\n        ...(isActive !== undefined && { isActive }),\r\n        ...(isFeatured !== undefined && { isFeatured }),\r\n        ...(publishedAt && { publishedAt: new Date(publishedAt) })\r\n      }\r\n    });\r\n\r\n    res.json(testimonial);\r\n  } catch (error) {\r\n    console.error('Error updating testimonial:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * DELETE /api/website-testimonials/:id\r\n * Supprime un t\u00E9moignage\r\n */\r\nrouter.delete('/website-testimonials/:id', async (req: Request, res: Response) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    await prisma.webSiteTestimonial.delete({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error deleting testimonial:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-testimonials/reorder\r\n * R\u00E9organise les t\u00E9moignages (drag & drop)\r\n */\r\nrouter.post('/website-testimonials/reorder', async (req: Request, res: Response) => {\r\n  try {\r\n    const { testimonials } = req.body;\r\n\r\n    if (!Array.isArray(testimonials)) {\r\n      return res.status(400).json({ error: 'testimonials array is required' });\r\n    }\r\n\r\n    await Promise.all(\r\n      testimonials.map((testimonial: { id: number; displayOrder: number }) =>\r\n        prisma.webSiteTestimonial.update({\r\n          where: { id: testimonial.id },\r\n          data: { displayOrder: testimonial.displayOrder }\r\n        })\r\n      )\r\n    );\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('Error reordering testimonials:', error);\r\n    res.status(500).json({ error: 'Internal server error' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * API CRUD pour les sections de sites web\r\n * Gestion du Page Builder (header, hero, stats, CTA, footer, etc.)\r\n */\r\n\r\nimport express from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = express.Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// GET /api/website-sections/:websiteId - Liste des sections d'un site\r\nrouter.get('/website-sections/:websiteId', async (req, res) => {\r\n  try {\r\n    const { websiteId } = req.params;\r\n\r\n    const sections = await prisma.webSiteSection.findMany({\r\n      where: {\r\n        websiteId: parseInt(websiteId)\r\n      },\r\n      orderBy: {\r\n        displayOrder: 'asc'\r\n      }\r\n    });\r\n\r\n    res.json(sections);\r\n  } catch (error) {\r\n    console.error('\u274C Erreur r\u00E9cup\u00E9ration sections:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/website-sections - Cr\u00E9er une section\r\nrouter.post('/website-sections', async (req, res) => {\r\n  try {\r\n    const { websiteId, key, type, name, content, backgroundColor, textColor, customCss } = req.body;\r\n\r\n    // Obtenir le displayOrder max actuel\r\n    const maxOrder = await prisma.webSiteSection.aggregate({\r\n      where: { websiteId: parseInt(websiteId) },\r\n      _max: { displayOrder: true }\r\n    });\r\n\r\n    const section = await prisma.webSiteSection.create({\r\n      data: {\r\n        websiteId: parseInt(websiteId),\r\n        key,\r\n        type,\r\n        name,\r\n        content: content || {},\r\n        backgroundColor,\r\n        textColor,\r\n        customCss,\r\n        displayOrder: (maxOrder._max.displayOrder || 0) + 1,\r\n        isActive: true,\r\n        isLocked: false\r\n      }\r\n    });\r\n\r\n    res.json(section);\r\n  } catch (error) {\r\n    console.error('\u274C Erreur cr\u00E9ation section:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// PUT /api/website-sections/:id - Modifier une section\r\nrouter.put('/website-sections/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { name, content, backgroundColor, textColor, customCss, isActive } = req.body;\r\n\r\n    console.log('\uD83D\uDD27 PUT /api/website-sections/:id');\r\n    console.log('  ID:', id);\r\n    console.log('  Body keys:', Object.keys(req.body));\r\n    console.log('  Content keys:', content ? Object.keys(content) : 'undefined');\r\n\r\n    // \uD83D\uDD25 FIX: Charger le content existant pour fusionner\r\n    const existing = await prisma.webSiteSection.findUnique({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    if (!existing) {\r\n      return res.status(404).json({ error: 'Section introuvable' });\r\n    }\r\n\r\n    // \uD83D\uDD25 FIX: Deep merge du content pour pr\u00E9server les propri\u00E9t\u00E9s imbriqu\u00E9es\r\n    const deepMerge = (target: any, source: any): any => {\r\n      if (!source || typeof source !== 'object' || Array.isArray(source)) {\r\n        return source;\r\n      }\r\n      \r\n      const result = { ...(target || {}) };\r\n      \r\n      for (const key in source) {\r\n        if (source[key] !== undefined) {\r\n          if (\r\n            result[key] &&\r\n            typeof result[key] === 'object' &&\r\n            !Array.isArray(result[key]) &&\r\n            typeof source[key] === 'object' &&\r\n            !Array.isArray(source[key])\r\n          ) {\r\n            result[key] = deepMerge(result[key], source[key]);\r\n          } else {\r\n            result[key] = source[key];\r\n          }\r\n        }\r\n      }\r\n      \r\n      return result;\r\n    };\r\n\r\n    const mergedContent = content !== undefined \r\n      ? deepMerge(existing.content as object, content)\r\n      : existing.content;\r\n\r\n    console.log('  \uD83D\uDD0D Existing content keys:', existing.content ? Object.keys(existing.content as object) : 'none');\r\n    console.log('  \uD83D\uDD0D Merged content keys:', mergedContent ? Object.keys(mergedContent as object) : 'none');\r\n\r\n    const section = await prisma.webSiteSection.update({\r\n      where: { id: parseInt(id) },\r\n      data: {\r\n        ...(name !== undefined && { name }),\r\n        ...(content !== undefined && { content: mergedContent }),\r\n        ...(backgroundColor !== undefined && { backgroundColor }),\r\n        ...(textColor !== undefined && { textColor }),\r\n        ...(customCss !== undefined && { customCss }),\r\n        ...(isActive !== undefined && { isActive })\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 Section mise \u00E0 jour ID:', section.id);\r\n    res.json(section);\r\n  } catch (error) {\r\n    console.error('\u274C Erreur modification section:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// PATCH /api/website-sections/:id - Modifier partiellement une section (alias de PUT)\r\nrouter.patch('/website-sections/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const { name, content, backgroundColor, textColor, customCss, isActive } = req.body;\r\n\r\n    console.log('\uD83D\uDD27 PATCH /api/website-sections/:id');\r\n    console.log('  ID:', id);\r\n    console.log('  Body keys:', Object.keys(req.body));\r\n\r\n    // \uD83D\uDD25 FIX: Charger le content existant pour fusionner\r\n    const existing = await prisma.webSiteSection.findUnique({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    if (!existing) {\r\n      return res.status(404).json({ error: 'Section introuvable' });\r\n    }\r\n\r\n    // \uD83D\uDD25 FIX: Deep merge du content pour pr\u00E9server les propri\u00E9t\u00E9s imbriqu\u00E9es\r\n    const deepMerge = (target: any, source: any): any => {\r\n      if (!source || typeof source !== 'object' || Array.isArray(source)) {\r\n        return source;\r\n      }\r\n      \r\n      const result = { ...(target || {}) };\r\n      \r\n      for (const key in source) {\r\n        if (source[key] !== undefined) {\r\n          if (\r\n            result[key] &&\r\n            typeof result[key] === 'object' &&\r\n            !Array.isArray(result[key]) &&\r\n            typeof source[key] === 'object' &&\r\n            !Array.isArray(source[key])\r\n          ) {\r\n            result[key] = deepMerge(result[key], source[key]);\r\n          } else {\r\n            result[key] = source[key];\r\n          }\r\n        }\r\n      }\r\n      \r\n      return result;\r\n    };\r\n\r\n    const mergedContent = content !== undefined \r\n      ? deepMerge(existing.content as object, content)\r\n      : existing.content;\r\n\r\n    const section = await prisma.webSiteSection.update({\r\n      where: { id: parseInt(id) },\r\n      data: {\r\n        ...(name !== undefined && { name }),\r\n        ...(content !== undefined && { content: mergedContent }),\r\n        ...(backgroundColor !== undefined && { backgroundColor }),\r\n        ...(textColor !== undefined && { textColor }),\r\n        ...(customCss !== undefined && { customCss }),\r\n        ...(isActive !== undefined && { isActive })\r\n      }\r\n    });\r\n\r\n    console.log('\u2705 Section mise \u00E0 jour:', section);\r\n    res.json(section);\r\n  } catch (error) {\r\n    console.error('\u274C Erreur modification section:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// DELETE /api/website-sections/:id - Supprimer une section\r\nrouter.delete('/website-sections/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    // V\u00E9rifier si la section est verrouill\u00E9e\r\n    const section = await prisma.webSiteSection.findUnique({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    if (section?.isLocked) {\r\n      return res.status(403).json({ error: 'Cette section est verrouill\u00E9e et ne peut pas \u00EAtre supprim\u00E9e' });\r\n    }\r\n\r\n    await prisma.webSiteSection.delete({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur suppression section:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/website-sections/reorder - R\u00E9organiser les sections\r\nrouter.post('/website-sections/reorder', async (req, res) => {\r\n  try {\r\n    const { sections } = req.body; // [{ id, displayOrder }, ...]\r\n\r\n    await prisma.$transaction(\r\n      sections.map((section: { id: number; displayOrder: number }) =>\r\n        prisma.webSiteSection.update({\r\n          where: { id: section.id },\r\n          data: { displayOrder: section.displayOrder }\r\n        })\r\n      )\r\n    );\r\n\r\n    res.json({ success: true });\r\n  } catch (error) {\r\n    console.error('\u274C Erreur r\u00E9organisation sections:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// POST /api/website-sections/duplicate/:id - Dupliquer une section\r\nrouter.post('/website-sections/duplicate/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n\r\n    const original = await prisma.webSiteSection.findUnique({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    if (!original) {\r\n      return res.status(404).json({ error: 'Section introuvable' });\r\n    }\r\n\r\n    // G\u00E9n\u00E9rer une nouvelle cl\u00E9 unique\r\n    const newKey = `${original.key}-copy-${Date.now()}`;\r\n\r\n    const duplicate = await prisma.webSiteSection.create({\r\n      data: {\r\n        websiteId: original.websiteId,\r\n        key: newKey,\r\n        type: original.type,\r\n        name: `${original.name} (Copie)`,\r\n        content: original.content,\r\n        backgroundColor: original.backgroundColor,\r\n        textColor: original.textColor,\r\n        customCss: original.customCss,\r\n        displayOrder: original.displayOrder + 1,\r\n        isActive: original.isActive,\r\n        isLocked: false\r\n      }\r\n    });\r\n\r\n    res.json(duplicate);\r\n  } catch (error) {\r\n    console.error('\u274C Erreur duplication section:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "import { Router } from 'express';\r\nimport { prisma } from '../lib/prisma';\r\n\r\nconst router = Router();\r\n\r\n/**\r\n * GET /api/website-themes/:websiteId\r\n * R\u00E9cup\u00E8re le th\u00E8me d'un site\r\n */\r\nrouter.get('/:websiteId', async (req, res) => {\r\n  try {\r\n    const { websiteId } = req.params;\r\n    console.log('\uD83D\uDCE1 [API] GET theme websiteId:', websiteId);\r\n\r\n    const theme = await prisma.webSiteTheme.findUnique({\r\n      where: { websiteId: parseInt(websiteId) }\r\n    });\r\n\r\n    if (!theme) {\r\n      return res.status(404).json({ message: 'Th\u00E8me non trouv\u00E9' });\r\n    }\r\n\r\n    res.json(theme);\r\n  } catch (error) {\r\n    console.error('\u274C [API] Erreur GET theme:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/website-themes\r\n * Cr\u00E9e un nouveau th\u00E8me\r\n */\r\nrouter.post('/', async (req, res) => {\r\n  try {\r\n    const themeData = req.body;\r\n    console.log('\uD83D\uDCE1 [API] POST theme:', themeData);\r\n\r\n    const theme = await prisma.webSiteTheme.create({\r\n      data: themeData\r\n    });\r\n\r\n    res.status(201).json(theme);\r\n  } catch (error) {\r\n    console.error('\u274C [API] Erreur POST theme:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n/**\r\n * PUT /api/website-themes/:id\r\n * Met \u00E0 jour un th\u00E8me existant\r\n */\r\nrouter.put('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    const themeData = req.body;\r\n    console.log('\uD83D\uDCE1 [API] PUT theme:', id, themeData);\r\n\r\n    const theme = await prisma.webSiteTheme.update({\r\n      where: { id: parseInt(id) },\r\n      data: themeData\r\n    });\r\n\r\n    res.json(theme);\r\n  } catch (error) {\r\n    console.error('\u274C [API] Erreur PUT theme:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n/**\r\n * DELETE /api/website-themes/:id\r\n * Supprime un th\u00E8me\r\n */\r\nrouter.delete('/:id', async (req, res) => {\r\n  try {\r\n    const { id } = req.params;\r\n    console.log('\uD83D\uDCE1 [API] DELETE theme:', id);\r\n\r\n    await prisma.webSiteTheme.delete({\r\n      where: { id: parseInt(id) }\r\n    });\r\n\r\n    res.json({ message: 'Th\u00E8me supprim\u00E9 avec succ\u00E8s' });\r\n  } catch (error) {\r\n    console.error('\u274C [API] Erreur DELETE theme:', error);\r\n    res.status(500).json({ error: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83D\uDD25 API ENDPOINT - FORMULAIRE DE CONTACT\r\n * \r\n * G\u00E8re les soumissions du formulaire de contact du site vitrine\r\n * Enregistre dans la BDD et peut envoyer un email de notification\r\n * \r\n * \u2705 COMPLET 100%:\r\n * - Enregistrement en BDD (ContactSubmission)\r\n * - Validation compl\u00E8te\r\n * - D\u00E9tection spam basique\r\n * - M\u00E9tadonn\u00E9es (IP, User-Agent)\r\n * - TODO: Envoi emails (SendGrid/AWS SES)\r\n * - TODO: Cr\u00E9ation lead automatique dans CRM\r\n */\r\n\r\nimport { Router, Request } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\ninterface ContactFormData {\r\n  websiteId: number;\r\n  name: string;\r\n  email: string;\r\n  phone?: string;\r\n  service?: string;\r\n  message?: string;\r\n}\r\n\r\n// Validation email simple\r\nconst isValidEmail = (email: string): boolean => {\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email);\r\n};\r\n\r\n// D\u00E9tection spam basique (honeypot, contenu suspect)\r\nconst isSpam = (data: ContactFormData): boolean => {\r\n  // Si le message contient trop d'URLs (>3), c'est probablement du spam\r\n  if (data.message) {\r\n    const urlCount = (data.message.match(/https?:\\/\\//g) || []).length;\r\n    if (urlCount > 3) return true;\r\n  }\r\n  \r\n  // Mots-cl\u00E9s spam courants\r\n  const spamKeywords = ['viagra', 'casino', 'bitcoin', 'forex', 'seo service', 'make money'];\r\n  const text = `${data.name} ${data.message || ''}`.toLowerCase();\r\n  if (spamKeywords.some(keyword => text.includes(keyword))) {\r\n    return true;\r\n  }\r\n  \r\n  return false;\r\n};\r\n\r\n// POST - Soumettre un formulaire de contact\r\nrouter.post('/contact-form', async (req: Request, res) => {\r\n  try {\r\n    const data: ContactFormData = req.body;\r\n\r\n    // 1. Validation basique\r\n    if (!data.name || data.name.trim().length < 2) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Le nom doit contenir au moins 2 caract\u00E8res'\r\n      });\r\n    }\r\n\r\n    if (!data.email || !isValidEmail(data.email)) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Email invalide'\r\n      });\r\n    }\r\n\r\n    if (!data.websiteId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Website ID manquant'\r\n      });\r\n    }\r\n\r\n    // 2. V\u00E9rifier que le site existe\r\n    const website = await prisma.webSite.findUnique({\r\n      where: { id: data.websiteId },\r\n      select: { id: true, organizationId: true }\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Site web introuvable'\r\n      });\r\n    }\r\n\r\n    // 3. D\u00E9tection spam\r\n    const spam = isSpam(data);\r\n\r\n    // 4. Extraire m\u00E9tadonn\u00E9es\r\n    const ipAddress = (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() \r\n                      || req.socket.remoteAddress \r\n                      || 'unknown';\r\n    const userAgent = req.headers['user-agent'] || 'unknown';\r\n\r\n    // 5. Enregistrer dans la base de donn\u00E9es\r\n    const submission = await prisma.contactSubmission.create({\r\n      data: {\r\n        websiteId: data.websiteId,\r\n        organizationId: website.organizationId,\r\n        name: data.name.trim(),\r\n        email: data.email.toLowerCase().trim(),\r\n        phone: data.phone?.trim() || null,\r\n        service: data.service?.trim() || null,\r\n        message: data.message?.trim() || null,\r\n        source: 'website',\r\n        ipAddress,\r\n        userAgent,\r\n        status: spam ? 'spam' : 'new',\r\n        isRead: false\r\n      }\r\n    });\r\n\r\n    console.log('\uD83D\uDCE7 \u2705 Nouveau formulaire de contact re\u00E7u:', {\r\n      id: submission.id,\r\n      name: data.name,\r\n      email: data.email,\r\n      service: data.service,\r\n      websiteId: data.websiteId,\r\n      organizationId: website.organizationId,\r\n      spam,\r\n      date: new Date().toISOString()\r\n    });\r\n\r\n    // Si spam, on confirme quand m\u00EAme pour ne pas r\u00E9v\u00E9ler la d\u00E9tection\r\n    if (spam) {\r\n      console.log('\u26A0\uFE0F SPAM D\u00C9TECT\u00C9 - Marqu\u00E9 comme spam dans la BDD');\r\n    }\r\n\r\n    // 6. TODO: Envoyer emails de notification\r\n    // await sendEmailToClient(data.email, data.name);\r\n    // await sendEmailToAdmin(website.organizationId, submission);\r\n\r\n    // 7. TODO: Cr\u00E9er un lead dans le CRM\r\n    // await createLeadFromContact(submission, website.organizationId);\r\n\r\n    // 8. R\u00E9ponse succ\u00E8s\r\n    res.json({\r\n      success: true,\r\n      message: 'Merci ! Nous avons bien re\u00E7u votre demande. Nous vous r\u00E9pondrons sous 24h.',\r\n      submissionId: submission.id\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C Erreur lors de la soumission du formulaire:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Une erreur est survenue. Veuillez r\u00E9essayer ou nous contacter directement par t\u00E9l\u00E9phone.'\r\n    });\r\n  }\r\n});\r\n\r\n// GET - Liste des soumissions pour un site (admin)\r\nrouter.get('/contact-submissions/:websiteId', async (req: Request, res) => {\r\n  try {\r\n    const websiteId = parseInt(req.params.websiteId);\r\n    \r\n    // TODO: V\u00E9rifier permissions (organisationId du user = organisationId du site)\r\n    \r\n    const submissions = await prisma.contactSubmission.findMany({\r\n      where: { websiteId },\r\n      orderBy: { submittedAt: 'desc' },\r\n      take: 100 // Limiter \u00E0 100 derni\u00E8res soumissions\r\n    });\r\n\r\n    res.json(submissions);\r\n  } catch (error) {\r\n    console.error('Erreur r\u00E9cup\u00E9ration soumissions:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// PATCH - Marquer comme lu\r\nrouter.patch('/contact-submission/:id/read', async (req: Request, res) => {\r\n  try {\r\n    const id = parseInt(req.params.id);\r\n    \r\n    const submission = await prisma.contactSubmission.update({\r\n      where: { id },\r\n      data: { isRead: true }\r\n    });\r\n\r\n    res.json({ success: true, submission });\r\n  } catch (error) {\r\n    console.error('Erreur marquage lu:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// PATCH - Changer le statut\r\nrouter.patch('/contact-submission/:id/status', async (req: Request, res) => {\r\n  try {\r\n    const id = parseInt(req.params.id);\r\n    const { status, notes } = req.body;\r\n    \r\n    const validStatuses = ['new', 'contacted', 'converted', 'spam'];\r\n    if (!validStatuses.includes(status)) {\r\n      return res.status(400).json({ success: false, message: 'Statut invalide' });\r\n    }\r\n    \r\n    const submission = await prisma.contactSubmission.update({\r\n      where: { id },\r\n      data: { \r\n        status,\r\n        notes: notes || undefined,\r\n        respondedAt: status === 'contacted' ? new Date() : undefined\r\n      }\r\n    });\r\n\r\n    res.json({ success: true, submission });\r\n  } catch (error) {\r\n    console.error('Erreur changement statut:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\n// DELETE - Supprimer une soumission (spam)\r\nrouter.delete('/contact-submission/:id', async (req: Request, res) => {\r\n  try {\r\n    const id = parseInt(req.params.id);\r\n    \r\n    await prisma.contactSubmission.delete({\r\n      where: { id }\r\n    });\r\n\r\n    res.json({ success: true, message: 'Soumission supprim\u00E9e' });\r\n  } catch (error) {\r\n    console.error('Erreur suppression:', error);\r\n    res.status(500).json({ success: false, message: 'Erreur serveur' });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83D\uDDBC\uFE0F UPLOAD D'IMAGES - SYST\u00C8ME COMPLET\r\n * \r\n * API endpoint pour uploader des images (logos, photos projets, etc.)\r\n * Stockage local ou S3\r\n */\r\n\r\nimport { Router } from 'express';\r\nimport multer from 'multer';\r\nimport path from 'path';\r\nimport fs from 'fs/promises';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst router = Router();\r\nconst prisma = new PrismaClient();\r\n\r\n// Configuration Multer pour l'upload\r\nconst storage = multer.diskStorage({\r\n  destination: async (req, file, cb) => {\r\n    const uploadDir = path.join(process.cwd(), 'public', 'uploads', 'websites');\r\n    // Cr\u00E9er le dossier s'il n'existe pas\r\n    await fs.mkdir(uploadDir, { recursive: true });\r\n    cb(null, uploadDir);\r\n  },\r\n  filename: (req, file, cb) => {\r\n    // G\u00E9n\u00E9rer un nom unique : timestamp_originalname\r\n    const uniqueName = `${Date.now()}_${file.originalname.replace(/\\s+/g, '_')}`;\r\n    cb(null, uniqueName);\r\n  }\r\n});\r\n\r\n// Filtre pour n'accepter que les images\r\nconst fileFilter = (req: any, file: Express.Multer.File, cb: multer.FileFilterCallback) => {\r\n  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];\r\n  \r\n  if (allowedTypes.includes(file.mimetype)) {\r\n    cb(null, true);\r\n  } else {\r\n    cb(new Error('Type de fichier non autoris\u00E9. Utilisez JPG, PNG, GIF, WEBP ou SVG.'));\r\n  }\r\n};\r\n\r\nconst upload = multer({\r\n  storage,\r\n  fileFilter,\r\n  limits: {\r\n    fileSize: 5 * 1024 * 1024 // 5MB max\r\n  }\r\n});\r\n\r\n// POST - Upload une image\r\nrouter.post('/upload-image', upload.single('image'), async (req: any, res) => {\r\n  try {\r\n    if (!req.file) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Aucune image fournie'\r\n      });\r\n    }\r\n\r\n    const { websiteId, category = 'general' } = req.body;\r\n\r\n    if (!websiteId) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        message: 'Website ID manquant'\r\n      });\r\n    }\r\n\r\n    // Construire l'URL publique\r\n    const fileUrl = `/uploads/websites/${req.file.filename}`;\r\n\r\n    // Enregistrer dans la BDD (table WebSiteMediaFile)\r\n    const mediaFile = await prisma.webSiteMediaFile.create({\r\n      data: {\r\n        websiteId: parseInt(websiteId),\r\n        fileName: req.file.originalname,\r\n        fileType: req.file.mimetype, // \u2705 CORRECTION: fileType au lieu de mimeType\r\n        fileUrl,\r\n        filePath: req.file.path,\r\n        fileSize: req.file.size,\r\n        category, // 'logo', 'project', 'service', 'general'\r\n        uploadedById: (req as any).user?.id || null\r\n      }\r\n    });\r\n\r\n    console.log('\uD83D\uDCF8 \u2705 Image upload\u00E9e:', {\r\n      id: mediaFile.id,\r\n      fileName: mediaFile.fileName,\r\n      url: fileUrl,\r\n      size: `${(req.file.size / 1024).toFixed(2)} KB`,\r\n      category\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      message: 'Image upload\u00E9e avec succ\u00E8s',\r\n      file: {\r\n        id: mediaFile.id,\r\n        fileName: mediaFile.fileName,\r\n        url: fileUrl,\r\n        size: mediaFile.fileSize,\r\n        mimeType: mediaFile.fileType // \u2705 CORRECTION: retourne fileType\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('\u274C Erreur upload image:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur lors de l\\'upload'\r\n    });\r\n  }\r\n});\r\n\r\n// GET - Liste des images d'un site\r\nrouter.get('/images/:websiteId', async (req, res) => {\r\n  try {\r\n    const websiteId = parseInt(req.params.websiteId);\r\n    const { category } = req.query;\r\n\r\n    const where: any = { websiteId };\r\n    if (category) {\r\n      where.category = category;\r\n    }\r\n\r\n    const images = await prisma.webSiteMediaFile.findMany({\r\n      where,\r\n      orderBy: { uploadedAt: 'desc' }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      images\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Erreur r\u00E9cup\u00E9ration images:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur'\r\n    });\r\n  }\r\n});\r\n\r\n// DELETE - Supprimer une image\r\nrouter.delete('/image/:id', async (req, res) => {\r\n  try {\r\n    const id = parseInt(req.params.id);\r\n\r\n    const mediaFile = await prisma.webSiteMediaFile.findUnique({\r\n      where: { id }\r\n    });\r\n\r\n    if (!mediaFile) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        message: 'Image introuvable'\r\n      });\r\n    }\r\n\r\n    // Supprimer le fichier physique\r\n    try {\r\n      await fs.unlink(mediaFile.filePath);\r\n    } catch (err) {\r\n      console.warn('Fichier d\u00E9j\u00E0 supprim\u00E9 ou inexistant');\r\n    }\r\n\r\n    // Supprimer de la BDD\r\n    await prisma.webSiteMediaFile.delete({\r\n      where: { id }\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      message: 'Image supprim\u00E9e'\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Erreur suppression image:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      message: 'Erreur serveur'\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * Routes API pour la g\u00E9n\u00E9ration de contenu IA\r\n */\r\n\r\nimport { Router } from 'express';\r\nimport { aiContentService } from '../services/aiContentService';\r\n\r\nconst router = Router();\r\n\r\n/**\r\n * POST /api/ai-content/generate-service\r\n * G\u00E9n\u00E8re le contenu d'un service\r\n */\r\nrouter.post('/generate-service', async (req, res) => {\r\n  try {\r\n    const { siteName, industry, serviceType, keywords } = req.body;\r\n\r\n    if (!siteName || !industry || !serviceType) {\r\n      return res.status(400).json({\r\n        error: 'Param\u00E8tres manquants : siteName, industry, serviceType requis'\r\n      });\r\n    }\r\n\r\n    const content = await aiContentService.generateService({\r\n      siteName,\r\n      industry,\r\n      serviceType,\r\n      keywords\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      content\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Erreur g\u00E9n\u00E9ration service:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration du service',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai-content/generate-project\r\n * G\u00E9n\u00E8re le contenu d'un projet\r\n */\r\nrouter.post('/generate-project', async (req, res) => {\r\n  try {\r\n    const { siteName, industry, projectType, location } = req.body;\r\n\r\n    if (!siteName || !industry || !projectType) {\r\n      return res.status(400).json({\r\n        error: 'Param\u00E8tres manquants : siteName, industry, projectType requis'\r\n      });\r\n    }\r\n\r\n    const content = await aiContentService.generateProject({\r\n      siteName,\r\n      industry,\r\n      projectType,\r\n      location\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      content\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Erreur g\u00E9n\u00E9ration projet:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration du projet',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai-content/generate-testimonial\r\n * G\u00E9n\u00E8re le contenu d'un t\u00E9moignage\r\n */\r\nrouter.post('/generate-testimonial', async (req, res) => {\r\n  try {\r\n    const { siteName, industry, serviceType, customerType } = req.body;\r\n\r\n    if (!siteName || !industry || !serviceType) {\r\n      return res.status(400).json({\r\n        error: 'Param\u00E8tres manquants : siteName, industry, serviceType requis'\r\n      });\r\n    }\r\n\r\n    const content = await aiContentService.generateTestimonial({\r\n      siteName,\r\n      industry,\r\n      serviceType,\r\n      customerType\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      content\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Erreur g\u00E9n\u00E9ration t\u00E9moignage:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration du t\u00E9moignage',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai-content/generate-page\r\n * G\u00E9n\u00E8re le contenu complet d'une page\r\n */\r\nrouter.post('/generate-page', async (req, res) => {\r\n  try {\r\n    const { siteName, siteType, industry, mainServices, targetAudience } = req.body;\r\n\r\n    if (!siteName || !siteType || !industry || !mainServices) {\r\n      return res.status(400).json({\r\n        error: 'Param\u00E8tres manquants : siteName, siteType, industry, mainServices requis'\r\n      });\r\n    }\r\n\r\n    const content = await aiContentService.generatePageContent({\r\n      siteName,\r\n      siteType,\r\n      industry,\r\n      mainServices,\r\n      targetAudience\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      content\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Erreur g\u00E9n\u00E9ration page:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration de la page',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai-content/optimize-seo\r\n * Optimise le SEO d'un contenu existant\r\n */\r\nrouter.post('/optimize-seo', async (req, res) => {\r\n  try {\r\n    const { currentTitle, currentDescription, pageContent, targetKeywords, siteName, industry } = req.body;\r\n\r\n    if (!pageContent || !siteName || !industry) {\r\n      return res.status(400).json({\r\n        error: 'Param\u00E8tres manquants : pageContent, siteName, industry requis'\r\n      });\r\n    }\r\n\r\n    const suggestions = await aiContentService.optimizeSEO({\r\n      currentTitle,\r\n      currentDescription,\r\n      pageContent,\r\n      targetKeywords,\r\n      siteName,\r\n      industry\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      suggestions\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Erreur optimisation SEO:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de l\\'optimisation SEO',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai-content/generate-multiple-services\r\n * G\u00E9n\u00E8re plusieurs services d'un coup\r\n */\r\nrouter.post('/generate-multiple-services', async (req, res) => {\r\n  try {\r\n    const { siteName, industry, serviceTypes } = req.body;\r\n\r\n    if (!siteName || !industry || !serviceTypes || !Array.isArray(serviceTypes)) {\r\n      return res.status(400).json({\r\n        error: 'Param\u00E8tres manquants : siteName, industry, serviceTypes (array) requis'\r\n      });\r\n    }\r\n\r\n    const services = await aiContentService.generateMultipleServices({\r\n      siteName,\r\n      industry,\r\n      serviceTypes\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      services,\r\n      count: services.length\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Erreur g\u00E9n\u00E9ration multiple services:', error);\r\n    res.status(500).json({\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration des services',\r\n      details: error.message\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * Service de g\u00E9n\u00E9ration de contenu IA pour les sites web\r\n * Utilise Google Gemini pour cr\u00E9er du contenu optimis\u00E9\r\n */\r\n\r\nimport { GoogleGeminiService } from './GoogleGeminiService';\r\n\r\nexport interface ServiceContent {\r\n  key: string;\r\n  icon: string;\r\n  title: string;\r\n  description: string;\r\n  features: string[];\r\n  ctaText: string;\r\n}\r\n\r\nexport interface ProjectContent {\r\n  title: string;\r\n  location: string;\r\n  details: string;\r\n  tags: string[];\r\n}\r\n\r\nexport interface TestimonialContent {\r\n  customerName: string;\r\n  location: string;\r\n  service: string;\r\n  rating: number;\r\n  text: string;\r\n}\r\n\r\nexport interface PageContent {\r\n  heroTitle: string;\r\n  heroSubtitle: string;\r\n  heroCtaPrimary: string;\r\n  heroCtaSecondary: string;\r\n  metaTitle: string;\r\n  metaDescription: string;\r\n  metaKeywords: string;\r\n  aboutText: string;\r\n}\r\n\r\nexport interface SEOSuggestions {\r\n  metaTitle: string;\r\n  metaDescription: string;\r\n  metaKeywords: string;\r\n  improvements: string[];\r\n}\r\n\r\nexport class AIContentService {\r\n  private geminiService: GoogleGeminiService;\r\n\r\n  constructor() {\r\n    this.geminiService = new GoogleGeminiService();\r\n  }\r\n\r\n  /**\r\n   * Option A : G\u00E9n\u00E8re le contenu d'un service\r\n   */\r\n  async generateService(context: {\r\n    siteName: string;\r\n    industry: string;\r\n    serviceType: string;\r\n    keywords?: string[];\r\n  }): Promise<ServiceContent> {\r\n    const prompt = `Tu es un expert en r\u00E9daction web et marketing pour le secteur ${context.industry}.\r\n\r\nG\u00E9n\u00E8re le contenu complet d'un service pour le site \"${context.siteName}\".\r\n\r\nType de service : ${context.serviceType}\r\n${context.keywords ? `Mots-cl\u00E9s sugg\u00E9r\u00E9s : ${context.keywords.join(', ')}` : ''}\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure exacte :\r\n{\r\n  \"key\": \"identifiant-technique-du-service (slug, kebab-case)\",\r\n  \"icon\": \"Nom d'une ic\u00F4ne Ant Design pertinente (ex: ThunderboltOutlined, FireOutlined, etc.)\",\r\n  \"title\": \"Titre accrocheur du service (3-6 mots)\",\r\n  \"description\": \"Description persuasive en 1-2 phrases (max 150 caract\u00E8res)\",\r\n  \"features\": [\"Caract\u00E9ristique 1 (5-8 mots)\", \"Caract\u00E9ristique 2\", \"Caract\u00E9ristique 3\", \"Caract\u00E9ristique 4\"],\r\n  \"ctaText\": \"Texte du call-to-action (3-5 mots)\",\r\n  \"keywords\": [\"mot-cl\u00E9 1\", \"mot-cl\u00E9 2\", \"mot-cl\u00E9 3\", \"mot-cl\u00E9 4\", \"mot-cl\u00E9 5\", \"mot-cl\u00E9 6\", \"mot-cl\u00E9 7\", \"mot-cl\u00E9 8\"]\r\n}\r\n\r\n\u26A0\uFE0F IMPORTANT pour les keywords :\r\n- G\u00E9n\u00E8re AU MINIMUM 8 mots-cl\u00E9s SEO pertinents et vari\u00E9s\r\n- Inclus des synonymes, termes techniques, b\u00E9n\u00E9fices clients\r\n- Pense r\u00E9f\u00E9rencement naturel (longue tra\u00EEne + termes courts)\r\n- Exemples : \"panneaux solaires\", \"installation photovolta\u00EFque\", \"\u00E9nergie renouvelable\", \"\u00E9conomies \u00E9lectricit\u00E9\", \"autoconsommation\", \"primes photovolta\u00EFques\", \"panneaux haute performance\", \"autonomie \u00E9nerg\u00E9tique\"\r\n\r\nR\u00E8gles :\r\n- Ton professionnel et convaincant\r\n- Orient\u00E9 b\u00E9n\u00E9fices client\r\n- Optimis\u00E9 SEO naturellement\r\n- Pas de texte superflu, UNIQUEMENT le JSON`;\r\n\r\n    const response = await this.geminiService.generateContentStream(prompt);\r\n    \r\n    // Extraire le JSON de la r\u00E9ponse\r\n    const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n    if (!jsonMatch) {\r\n      throw new Error('Format de r\u00E9ponse invalide de l\\'IA');\r\n    }\r\n\r\n    return JSON.parse(jsonMatch[0]);\r\n  }\r\n\r\n  /**\r\n   * Option A : G\u00E9n\u00E8re le contenu d'un projet\r\n   */\r\n  async generateProject(context: {\r\n    siteName: string;\r\n    industry: string;\r\n    projectType: string;\r\n    location?: string;\r\n  }): Promise<ProjectContent> {\r\n    const prompt = `Tu es un expert en r\u00E9daction web et marketing pour le secteur ${context.industry}.\r\n\r\nG\u00E9n\u00E8re le contenu complet d'un projet r\u00E9alis\u00E9 pour le site \"${context.siteName}\".\r\n\r\nType de projet : ${context.projectType}\r\n${context.location ? `Localisation : ${context.location}` : ''}\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure exacte :\r\n{\r\n  \"title\": \"Titre technique du projet (ex: 12.5 kWp + Batterie 15 kWh)\",\r\n  \"location\": \"Ville ou r\u00E9gion\",\r\n  \"details\": \"Description d\u00E9taill\u00E9e du projet en 2-3 phrases (max 200 caract\u00E8res)\",\r\n  \"tags\": [\"Tag1\", \"Tag2\", \"Tag3\"]\r\n}\r\n\r\nR\u00E8gles :\r\n- Titre technique et pr\u00E9cis\r\n- D\u00E9tails concrets et mesurables\r\n- Tags pertinents (2-4 tags)\r\n- Pas de texte superflu, UNIQUEMENT le JSON`;\r\n\r\n    const response = await this.geminiService.generateContentStream(prompt);\r\n    \r\n    const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n    if (!jsonMatch) {\r\n      throw new Error('Format de r\u00E9ponse invalide de l\\'IA');\r\n    }\r\n\r\n    return JSON.parse(jsonMatch[0]);\r\n  }\r\n\r\n  /**\r\n   * Option A : G\u00E9n\u00E8re le contenu d'un t\u00E9moignage\r\n   */\r\n  async generateTestimonial(context: {\r\n    siteName: string;\r\n    industry: string;\r\n    serviceType: string;\r\n    customerType?: 'particulier' | 'professionnel';\r\n  }): Promise<TestimonialContent> {\r\n    const prompt = `Tu es un expert en r\u00E9daction web et marketing pour le secteur ${context.industry}.\r\n\r\nG\u00E9n\u00E8re un t\u00E9moignage client r\u00E9aliste et convaincant pour le site \"${context.siteName}\".\r\n\r\nService concern\u00E9 : ${context.serviceType}\r\nType de client : ${context.customerType || 'particulier'}\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure exacte :\r\n{\r\n  \"customerName\": \"Pr\u00E9nom Nom (belge francophone)\",\r\n  \"location\": \"Ville belge\",\r\n  \"service\": \"Nom du service utilis\u00E9\",\r\n  \"rating\": 5,\r\n  \"text\": \"T\u00E9moignage authentique et d\u00E9taill\u00E9 (3-4 phrases, max 300 caract\u00E8res). Doit mentionner des d\u00E9tails concrets, l'exp\u00E9rience v\u00E9cue, et les r\u00E9sultats obtenus.\"\r\n}\r\n\r\nR\u00E8gles :\r\n- T\u00E9moignage cr\u00E9dible et authentique\r\n- D\u00E9tails concrets et sp\u00E9cifiques\r\n- Ton positif mais naturel\r\n- Pas de superlatifs exag\u00E9r\u00E9s\r\n- Pas de texte superflu, UNIQUEMENT le JSON`;\r\n\r\n    const response = await this.geminiService.generateContentStream(prompt);\r\n    \r\n    const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n    if (!jsonMatch) {\r\n      throw new Error('Format de r\u00E9ponse invalide de l\\'IA');\r\n    }\r\n\r\n    return JSON.parse(jsonMatch[0]);\r\n  }\r\n\r\n  /**\r\n   * Option B : G\u00E9n\u00E8re le contenu complet d'une page\r\n   */\r\n  async generatePageContent(context: {\r\n    siteName: string;\r\n    siteType: 'vitrine' | 'landing' | 'blog';\r\n    industry: string;\r\n    mainServices: string[];\r\n    targetAudience?: string;\r\n  }): Promise<PageContent> {\r\n    const prompt = `Tu es un expert en r\u00E9daction web et marketing pour le secteur ${context.industry}.\r\n\r\nG\u00E9n\u00E8re le contenu complet de la page d'accueil pour \"${context.siteName}\".\r\n\r\nType de site : ${context.siteType}\r\nServices principaux : ${context.mainServices.join(', ')}\r\n${context.targetAudience ? `Audience cible : ${context.targetAudience}` : ''}\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure exacte :\r\n{\r\n  \"heroTitle\": \"Titre principal accrocheur (max 60 caract\u00E8res)\",\r\n  \"heroSubtitle\": \"Sous-titre avec liste des services s\u00E9par\u00E9s par \u2022\",\r\n  \"heroCtaPrimary\": \"Texte bouton principal (3-5 mots)\",\r\n  \"heroCtaSecondary\": \"Texte bouton secondaire (2-4 mots)\",\r\n  \"metaTitle\": \"Titre SEO optimis\u00E9 (50-60 caract\u00E8res)\",\r\n  \"metaDescription\": \"Description SEO persuasive (140-160 caract\u00E8res)\",\r\n  \"metaKeywords\": \"Liste de mots-cl\u00E9s SEO s\u00E9par\u00E9s par des virgules\",\r\n  \"aboutText\": \"Texte de pr\u00E9sentation de l'entreprise (3-4 phrases, max 400 caract\u00E8res)\"\r\n}\r\n\r\nR\u00E8gles :\r\n- Titres percutants et orient\u00E9s b\u00E9n\u00E9fices\r\n- SEO naturel et optimis\u00E9\r\n- Ton professionnel et convaincant\r\n- Int\u00E9grer les mots-cl\u00E9s de mani\u00E8re naturelle\r\n- Pas de texte superflu, UNIQUEMENT le JSON`;\r\n\r\n    const response = await this.geminiService.generateContentStream(prompt);\r\n    \r\n    const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n    if (!jsonMatch) {\r\n      throw new Error('Format de r\u00E9ponse invalide de l\\'IA');\r\n    }\r\n\r\n    return JSON.parse(jsonMatch[0]);\r\n  }\r\n\r\n  /**\r\n   * Option C : Optimisation SEO d'un contenu existant\r\n   */\r\n  async optimizeSEO(content: {\r\n    currentTitle?: string;\r\n    currentDescription?: string;\r\n    pageContent: string;\r\n    targetKeywords?: string[];\r\n    siteName: string;\r\n    industry: string;\r\n  }): Promise<SEOSuggestions> {\r\n    const prompt = `Tu es un expert SEO sp\u00E9cialis\u00E9 dans le secteur ${content.industry}.\r\n\r\nAnalyse et optimise le contenu SEO pour \"${content.siteName}\".\r\n\r\nTitre actuel : ${content.currentTitle || 'Non d\u00E9fini'}\r\nDescription actuelle : ${content.currentDescription || 'Non d\u00E9finie'}\r\n${content.targetKeywords ? `Mots-cl\u00E9s cibles : ${content.targetKeywords.join(', ')}` : ''}\r\n\r\nContenu de la page :\r\n${content.pageContent.substring(0, 1000)}\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure exacte :\r\n{\r\n  \"metaTitle\": \"Titre SEO optimis\u00E9 (50-60 caract\u00E8res)\",\r\n  \"metaDescription\": \"Description SEO optimis\u00E9e (140-160 caract\u00E8res)\",\r\n  \"metaKeywords\": \"Liste de mots-cl\u00E9s SEO pertinents s\u00E9par\u00E9s par des virgules\",\r\n  \"improvements\": [\r\n    \"Am\u00E9lioration 1 sugg\u00E9r\u00E9e\",\r\n    \"Am\u00E9lioration 2 sugg\u00E9r\u00E9e\",\r\n    \"Am\u00E9lioration 3 sugg\u00E9r\u00E9e\",\r\n    \"Am\u00E9lioration 4 sugg\u00E9r\u00E9e\"\r\n  ]\r\n}\r\n\r\nR\u00E8gles :\r\n- Optimisation SEO technique\r\n- Mots-cl\u00E9s int\u00E9gr\u00E9s naturellement\r\n- Appel \u00E0 l'action dans la description\r\n- Suggestions concr\u00E8tes et actionnables\r\n- Pas de texte superflu, UNIQUEMENT le JSON`;\r\n\r\n    const response = await this.geminiService.generateContentStream(prompt);\r\n    \r\n    const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n    if (!jsonMatch) {\r\n      throw new Error('Format de r\u00E9ponse invalide de l\\'IA');\r\n    }\r\n\r\n    return JSON.parse(jsonMatch[0]);\r\n  }\r\n\r\n  /**\r\n   * G\u00E9n\u00E8re plusieurs services d'un coup pour un site complet\r\n   */\r\n  async generateMultipleServices(context: {\r\n    siteName: string;\r\n    industry: string;\r\n    serviceTypes: string[];\r\n  }): Promise<ServiceContent[]> {\r\n    const services: ServiceContent[] = [];\r\n    \r\n    for (const serviceType of context.serviceTypes) {\r\n      try {\r\n        const service = await this.generateService({\r\n          siteName: context.siteName,\r\n          industry: context.industry,\r\n          serviceType\r\n        });\r\n        services.push(service);\r\n      } catch (error) {\r\n        console.error(`Erreur g\u00E9n\u00E9ration service ${serviceType}:`, error);\r\n      }\r\n    }\r\n\r\n    return services;\r\n  }\r\n}\r\n\r\nexport const aiContentService = new AIContentService();\r\n", "/**\r\n * \uD83E\uDD16 API IA - Routes pour la g\u00E9n\u00E9ration de contenu avec Google Gemini\r\n */\r\n\r\nimport express from 'express';\r\nimport { GoogleGenerativeAI } from '@google/generative-ai';\r\n\r\nconst router = express.Router();\r\n\r\n// Initialiser Gemini\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');\r\n\r\n// Mod\u00E8le \u00E0 utiliser\r\nconst MODEL_NAME = 'gemini-pro';\r\n\r\n/**\r\n * POST /api/ai/generate\r\n * G\u00E9n\u00E8re des suggestions avec Gemini\r\n */\r\nrouter.post('/generate', async (req, res) => {\r\n  try {\r\n    const { prompt, context, sectionType, currentValue } = req.body;\r\n\r\n    if (!prompt) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Le prompt est requis'\r\n      });\r\n    }\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'GEMINI_API_KEY non configur\u00E9e'\r\n      });\r\n    }\r\n\r\n    console.log(`[AI] G\u00E9n\u00E9ration pour context=\"${context}\", section=\"${sectionType}\"`);\r\n\r\n    // Obtenir le mod\u00E8le\r\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\r\n\r\n    // Configuration de g\u00E9n\u00E9ration\r\n    const generationConfig = {\r\n      temperature: 0.8,\r\n      topK: 40,\r\n      topP: 0.95,\r\n      maxOutputTokens: 2048,\r\n    };\r\n\r\n    // G\u00E9n\u00E9rer le contenu\r\n    const result = await model.generateContent({\r\n      contents: [{ role: 'user', parts: [{ text: prompt }] }],\r\n      generationConfig,\r\n    });\r\n\r\n    const response = await result.response;\r\n    const text = response.text();\r\n\r\n    console.log(`[AI] R\u00E9ponse re\u00E7ue (${text.length} caract\u00E8res)`);\r\n\r\n    // Parser la r\u00E9ponse JSON\r\n    let suggestions;\r\n    try {\r\n      // Essayer de parser comme JSON\r\n      const jsonMatch = text.match(/\\[[\\s\\S]*\\]|\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        suggestions = JSON.parse(jsonMatch[0]);\r\n      } else {\r\n        throw new Error('Pas de JSON trouv\u00E9');\r\n      }\r\n    } catch (parseError) {\r\n      console.warn('[AI] R\u00E9ponse non-JSON, conversion en array');\r\n      // Si ce n'est pas du JSON, traiter comme du texte brut\r\n      suggestions = parseNonJSONResponse(text, context);\r\n    }\r\n\r\n    // Formater les suggestions selon le contexte\r\n    const formattedSuggestions = formatSuggestions(suggestions, context);\r\n\r\n    res.json({\r\n      success: true,\r\n      suggestions: formattedSuggestions,\r\n      raw: text // Pour debug\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI] Erreur:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error.message || 'Erreur lors de la g\u00E9n\u00E9ration IA',\r\n      details: error.toString()\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * Parser une r\u00E9ponse non-JSON\r\n */\r\nfunction parseNonJSONResponse(text: string, context: string): any {\r\n  // S\u00E9parer par lignes vides ou num\u00E9ros\r\n  const lines = text.split(/\\n\\n+|\\n\\d+\\.\\s+/).filter(l => l.trim());\r\n\r\n  switch (context) {\r\n    case 'title':\r\n    case 'subtitle':\r\n    case 'description':\r\n      // Retourner chaque ligne comme une suggestion\r\n      return lines.slice(0, 5).map(line => line.trim());\r\n\r\n    case 'fullSection':\r\n      // Essayer d'extraire titre, sous-titre, description\r\n      return {\r\n        title: lines[0] || 'Titre g\u00E9n\u00E9r\u00E9',\r\n        subtitle: lines[1] || 'Sous-titre g\u00E9n\u00E9r\u00E9',\r\n        description: lines[2] || 'Description g\u00E9n\u00E9r\u00E9e',\r\n        items: lines.slice(3, 9).map((line, idx) => ({\r\n          title: `\u00C9l\u00E9ment ${idx + 1}`,\r\n          description: line\r\n        }))\r\n      };\r\n\r\n    default:\r\n      return lines;\r\n  }\r\n}\r\n\r\n/**\r\n * Formater les suggestions selon le contexte\r\n */\r\nfunction formatSuggestions(data: any, context: string): any[] {\r\n  switch (context) {\r\n    case 'title':\r\n    case 'subtitle':\r\n    case 'description':\r\n      // Array de strings -> Array d'objets avec value\r\n      if (Array.isArray(data)) {\r\n        return data.map(item => ({\r\n          value: typeof item === 'string' ? item : item.value || item.text || String(item),\r\n          reason: typeof item === 'object' ? item.reason : undefined\r\n        }));\r\n      }\r\n      return [{ value: String(data) }];\r\n\r\n    case 'fullSection':\r\n      // Un seul objet complet\r\n      if (Array.isArray(data)) {\r\n        return data.map(item => ({\r\n          value: {\r\n            title: item.title || 'Titre',\r\n            subtitle: item.subtitle || 'Sous-titre',\r\n            description: item.description || 'Description',\r\n            items: item.items || []\r\n          },\r\n          reason: item.reason\r\n        }));\r\n      }\r\n      return [{\r\n        value: {\r\n          title: data.title || 'Titre',\r\n          subtitle: data.subtitle || 'Sous-titre',\r\n          description: data.description || 'Description',\r\n          items: data.items || []\r\n        }\r\n      }];\r\n\r\n    case 'layout':\r\n      // Array de configurations de layout\r\n      if (Array.isArray(data)) {\r\n        return data.map(item => ({\r\n          value: {\r\n            columns: item.columns || 3,\r\n            rows: item.rows,\r\n            gap: item.gap || 24,\r\n            responsive: item.responsive || { mobile: 1, tablet: 2, desktop: 3 }\r\n          },\r\n          reason: item.reason\r\n        }));\r\n      }\r\n      return [{\r\n        value: {\r\n          columns: data.columns || 3,\r\n          rows: data.rows,\r\n          gap: data.gap || 24,\r\n          responsive: data.responsive || { mobile: 1, tablet: 2, desktop: 3 }\r\n        }\r\n      }];\r\n\r\n    case 'colors':\r\n      // Array de palettes\r\n      if (Array.isArray(data)) {\r\n        return data.map(item => ({\r\n          value: {\r\n            primary: item.primary || '#1890ff',\r\n            secondary: item.secondary || '#52c41a',\r\n            accent: item.accent || '#faad14',\r\n            background: item.background || '#ffffff',\r\n            text: item.text || '#000000'\r\n          },\r\n          reason: item.reason\r\n        }));\r\n      }\r\n      return [{\r\n        value: {\r\n          primary: data.primary || '#1890ff',\r\n          secondary: data.secondary || '#52c41a',\r\n          accent: data.accent || '#faad14',\r\n          background: data.background || '#ffffff',\r\n          text: data.text || '#000000'\r\n        }\r\n      }];\r\n\r\n    default:\r\n      // Format g\u00E9n\u00E9rique\r\n      if (Array.isArray(data)) {\r\n        return data.map(item => ({\r\n          value: item,\r\n          reason: typeof item === 'object' ? item.reason : undefined\r\n        }));\r\n      }\r\n      return [{ value: data }];\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/ai/analyze-section\r\n * Analyse compl\u00E8te d'une section et propose des optimisations\r\n */\r\nrouter.post('/analyze-section', async (req, res) => {\r\n  try {\r\n    const { sectionType, content, prompt } = req.body;\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'GEMINI_API_KEY non configur\u00E9e'\r\n      });\r\n    }\r\n\r\n    console.log(`[AI Analyze] Section=\"${sectionType}\"`);\r\n\r\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\r\n\r\n    // Configuration pour analyse d\u00E9taill\u00E9e\r\n    const generationConfig = {\r\n      temperature: 0.7, // Moins cr\u00E9atif, plus factuel\r\n      topK: 40,\r\n      topP: 0.95,\r\n      maxOutputTokens: 4096, // Plus long pour analyse d\u00E9taill\u00E9e\r\n    };\r\n\r\n    const result = await model.generateContent({\r\n      contents: [{ role: 'user', parts: [{ text: prompt }] }],\r\n      generationConfig,\r\n    });\r\n\r\n    const response = await result.response;\r\n    const text = response.text();\r\n\r\n    console.log(`[AI Analyze] R\u00E9ponse re\u00E7ue (${text.length} caract\u00E8res)`);\r\n\r\n    // Parser la r\u00E9ponse JSON\r\n    let analysis;\r\n    try {\r\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        analysis = JSON.parse(jsonMatch[0]);\r\n      } else {\r\n        throw new Error('Pas de JSON trouv\u00E9');\r\n      }\r\n    } catch (parseError) {\r\n      console.warn('[AI Analyze] Parsing \u00E9chou\u00E9, g\u00E9n\u00E9ration d\\'analyse par d\u00E9faut');\r\n      analysis = generateFallbackAnalysis(sectionType, content);\r\n    }\r\n\r\n    // Valider et compl\u00E9ter l'analyse\r\n    const validatedAnalysis = validateAnalysis(analysis);\r\n\r\n    res.json(validatedAnalysis);\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI Analyze] Erreur:', error);\r\n    \r\n    // Retourner analyse par d\u00E9faut en cas d'erreur\r\n    res.json(generateFallbackAnalysis(req.body.sectionType, req.body.content));\r\n  }\r\n});\r\n\r\n/**\r\n * Valide et compl\u00E8te une analyse\r\n */\r\nfunction validateAnalysis(analysis: any): any {\r\n  return {\r\n    score: analysis.score || 70,\r\n    suggestions: Array.isArray(analysis.suggestions) \r\n      ? analysis.suggestions.map((s: any) => ({\r\n          id: s.id || `suggestion-${Date.now()}-${Math.random()}`,\r\n          category: s.category || 'design',\r\n          type: s.type || 'improvement',\r\n          title: s.title || 'Am\u00E9lioration sugg\u00E9r\u00E9e',\r\n          description: s.description || 'D\u00E9tails non disponibles',\r\n          impact: s.impact || 'medium',\r\n          changes: s.changes || {},\r\n          preview: s.preview\r\n        }))\r\n      : [],\r\n    summary: {\r\n      strengths: Array.isArray(analysis.summary?.strengths) \r\n        ? analysis.summary.strengths \r\n        : ['Contenu pr\u00E9sent'],\r\n      weaknesses: Array.isArray(analysis.summary?.weaknesses)\r\n        ? analysis.summary.weaknesses\r\n        : ['Optimisation possible'],\r\n      opportunities: Array.isArray(analysis.summary?.opportunities)\r\n        ? analysis.summary.opportunities\r\n        : ['Am\u00E9lioration continue']\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * G\u00E9n\u00E8re une analyse par d\u00E9faut\r\n */\r\nfunction generateFallbackAnalysis(sectionType: string, content: any): any {\r\n  const itemCount = content?.values?.length || \r\n                    content?.stats?.length || \r\n                    content?.items?.length || 6;\r\n\r\n  return {\r\n    score: 65,\r\n    suggestions: [\r\n      {\r\n        id: 'layout-optimize',\r\n        category: 'layout',\r\n        type: 'improvement',\r\n        title: 'Optimiser le layout de la grille',\r\n        description: `Avec ${itemCount} \u00E9l\u00E9ments, une disposition diff\u00E9rente pourrait am\u00E9liorer l'\u00E9quilibre visuel.`,\r\n        impact: 'medium',\r\n        changes: {\r\n          'gridLayout': {\r\n            columns: itemCount <= 4 ? itemCount : 3,\r\n            gap: 32,\r\n            responsive: { mobile: 1, tablet: 2, desktop: itemCount <= 4 ? itemCount : 3 }\r\n          }\r\n        },\r\n        preview: {\r\n          before: `Layout actuel`,\r\n          after: `Layout optimis\u00E9 pour ${itemCount} \u00E9l\u00E9ments`\r\n        }\r\n      },\r\n      {\r\n        id: 'spacing-increase',\r\n        category: 'design',\r\n        type: 'improvement',\r\n        title: 'Augmenter l\\'espacement',\r\n        description: 'Un espacement de 32px am\u00E9liorerait la respiration visuelle.',\r\n        impact: 'low',\r\n        changes: {\r\n          'gridLayout.gap': 32\r\n        },\r\n        preview: {\r\n          before: 'Espacement standard',\r\n          after: 'Espacement am\u00E9lior\u00E9 (32px)'\r\n        }\r\n      },\r\n      {\r\n        id: 'header-improve',\r\n        category: 'content',\r\n        type: 'improvement',\r\n        title: 'Renforcer l\\'en-t\u00EAte',\r\n        description: 'Ajouter un sous-titre explicatif renforcerait le message.',\r\n        impact: 'medium',\r\n        changes: {\r\n          'sectionHeader.subtitle': `D\u00E9couvrez nos ${sectionType} adapt\u00E9s \u00E0 vos besoins`\r\n        }\r\n      }\r\n    ],\r\n    summary: {\r\n      strengths: [\r\n        'Structure claire',\r\n        'Contenu pr\u00E9sent',\r\n        'Design coh\u00E9rent'\r\n      ],\r\n      weaknesses: [\r\n        'Layout pourrait \u00EAtre optimis\u00E9',\r\n        'Espacement \u00E0 am\u00E9liorer',\r\n        'En-t\u00EAte \u00E0 renforcer'\r\n      ],\r\n      opportunities: [\r\n        'Meilleure utilisation de l\\'espace',\r\n        'Plus d\\'impact visuel',\r\n        'Message plus clair'\r\n      ]\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * POST /api/ai/optimize-seo\r\n * Optimise le SEO d'une section\r\n */\r\nrouter.post('/optimize-seo', async (req, res) => {\r\n  try {\r\n    const { content, sectionType } = req.body;\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'GEMINI_API_KEY non configur\u00E9e'\r\n      });\r\n    }\r\n\r\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\r\n\r\n    const prompt = `Tu es un expert SEO. Optimise ce contenu pour le r\u00E9f\u00E9rencement :\r\n\r\nSection : ${sectionType}\r\nContenu actuel : ${JSON.stringify(content)}\r\n\r\nG\u00E9n\u00E8re :\r\n1. Meta title (max 60 caract\u00E8res, optimis\u00E9 SEO)\r\n2. Meta description (max 160 caract\u00E8res, incite au clic)\r\n3. 5 mots-cl\u00E9s pertinents\r\n4. Slug URL optimis\u00E9\r\n5. Balises alt pour images (3 suggestions)\r\n\r\nFormat de r\u00E9ponse : JSON avec { metaTitle, metaDescription, keywords: [], slug, altTexts: [] }`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const response = await result.response;\r\n    const text = response.text();\r\n\r\n    // Parser JSON\r\n    const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n    const seoData = jsonMatch ? JSON.parse(jsonMatch[0]) : {};\r\n\r\n    res.json({\r\n      success: true,\r\n      seo: seoData\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI SEO] Erreur:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error.message || 'Erreur lors de l\\'optimisation SEO'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai/improve-content\r\n * Am\u00E9liore un contenu existant\r\n */\r\nrouter.post('/improve-content', async (req, res) => {\r\n  try {\r\n    const { content, instructions } = req.body;\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'GEMINI_API_KEY non configur\u00E9e'\r\n      });\r\n    }\r\n\r\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\r\n\r\n    const prompt = `Am\u00E9liore ce contenu selon les instructions suivantes :\r\n\r\nContenu actuel :\r\n${JSON.stringify(content, null, 2)}\r\n\r\nInstructions :\r\n${instructions || 'Rendre plus engageant, professionnel et optimis\u00E9 pour la conversion'}\r\n\r\nRetourne le contenu am\u00E9lior\u00E9 au format JSON identique \u00E0 l'original.`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const response = await result.response;\r\n    const text = response.text();\r\n\r\n    // Parser JSON\r\n    const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\r\n    const improvedContent = jsonMatch ? JSON.parse(jsonMatch[0]) : content;\r\n\r\n    res.json({\r\n      success: true,\r\n      improved: improvedContent,\r\n      original: content\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI Improve] Erreur:', error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: error.message || 'Erreur lors de l\\'am\u00E9lioration du contenu'\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai/optimize-layout\r\n * Optimise le layout d'une section selon le nombre d'\u00E9l\u00E9ments\r\n */\r\nrouter.post('/optimize-layout', async (req, res) => {\r\n  try {\r\n    const { itemCount, sectionType, currentLayout } = req.body;\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'GEMINI_API_KEY non configur\u00E9e'\r\n      });\r\n    }\r\n\r\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\r\n\r\n    const prompt = `Tu es un expert en UI/UX et design responsive.\r\n\r\nType de section : ${sectionType}\r\nNombre d'\u00E9l\u00E9ments : ${itemCount}\r\nLayout actuel : ${JSON.stringify(currentLayout || {})}\r\n\r\nSugg\u00E8re 3 configurations de grille CSS optimales pour cette section.\r\nPour chaque configuration, explique pourquoi elle est adapt\u00E9e.\r\n\r\nFormat de r\u00E9ponse : JSON array avec :\r\n[\r\n  {\r\n    \"preset\": \"3x2\" (ou \"custom\"),\r\n    \"columns\": 3,\r\n    \"rows\": 2,\r\n    \"gap\": 24,\r\n    \"responsive\": {\r\n      \"mobile\": 1,\r\n      \"tablet\": 2,\r\n      \"desktop\": 3\r\n    },\r\n    \"reason\": \"Explication de pourquoi ce layout est optimal\"\r\n  }\r\n]`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const response = await result.response;\r\n    const text = response.text();\r\n\r\n    // Parser JSON\r\n    const jsonMatch = text.match(/\\[[\\s\\S]*\\]/);\r\n    let layouts = jsonMatch ? JSON.parse(jsonMatch[0]) : [];\r\n\r\n    // Fallback si parsing \u00E9choue\r\n    if (!Array.isArray(layouts) || layouts.length === 0) {\r\n      layouts = generateFallbackLayouts(itemCount);\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      layouts: layouts.slice(0, 3) // Max 3 suggestions\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI Layout] Erreur:', error);\r\n    // Fallback en cas d'erreur\r\n    res.json({\r\n      success: true,\r\n      layouts: generateFallbackLayouts(req.body.itemCount || 6)\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * POST /api/ai/generate-palette\r\n * G\u00E9n\u00E8re une palette de couleurs harmonieuse\r\n */\r\nrouter.post('/generate-palette', async (req, res) => {\r\n  try {\r\n    const { baseColor, mood, industry } = req.body;\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'GEMINI_API_KEY non configur\u00E9e'\r\n      });\r\n    }\r\n\r\n    const model = genAI.getGenerativeModel({ model: MODEL_NAME });\r\n\r\n    const prompt = `Tu es un expert en th\u00E9orie des couleurs et design.\r\n\r\nCouleur de base : ${baseColor || '#1890ff'}\r\nAmbiance souhait\u00E9e : ${mood || 'professionnelle, moderne'}\r\nSecteur d'activit\u00E9 : ${industry || 'technologie'}\r\n\r\nG\u00E9n\u00E8re 3 palettes de couleurs harmonieuses avec :\r\n- primary : couleur principale\r\n- secondary : couleur secondaire\r\n- accent : couleur d'accentuation\r\n- background : couleur de fond\r\n- text : couleur de texte\r\n- success, warning, error : couleurs de statut\r\n\r\nFormat : JSON array avec :\r\n[\r\n  {\r\n    \"name\": \"Nom de la palette\",\r\n    \"primary\": \"#RRGGBB\",\r\n    \"secondary\": \"#RRGGBB\",\r\n    \"accent\": \"#RRGGBB\",\r\n    \"background\": \"#RRGGBB\",\r\n    \"text\": \"#RRGGBB\",\r\n    \"success\": \"#RRGGBB\",\r\n    \"warning\": \"#RRGGBB\",\r\n    \"error\": \"#RRGGBB\",\r\n    \"reason\": \"Pourquoi cette palette est adapt\u00E9e\"\r\n  }\r\n]`;\r\n\r\n    const result = await model.generateContent(prompt);\r\n    const response = await result.response;\r\n    const text = response.text();\r\n\r\n    // Parser JSON\r\n    const jsonMatch = text.match(/\\[[\\s\\S]*\\]/);\r\n    let palettes = jsonMatch ? JSON.parse(jsonMatch[0]) : [];\r\n\r\n    // Fallback\r\n    if (!Array.isArray(palettes) || palettes.length === 0) {\r\n      palettes = generateFallbackPalettes(baseColor);\r\n    }\r\n\r\n    res.json({\r\n      success: true,\r\n      palettes: palettes.slice(0, 3)\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI Palette] Erreur:', error);\r\n    res.json({\r\n      success: true,\r\n      palettes: generateFallbackPalettes(req.body.baseColor || '#1890ff')\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * G\u00E9n\u00E8re des layouts de fallback\r\n */\r\nfunction generateFallbackLayouts(itemCount: number): any[] {\r\n  const layouts = [];\r\n\r\n  if (itemCount <= 3) {\r\n    layouts.push({\r\n      preset: '1x1',\r\n      columns: itemCount,\r\n      gap: 24,\r\n      responsive: { mobile: 1, tablet: 2, desktop: itemCount },\r\n      reason: 'Layout horizontal adapt\u00E9 pour peu d\\'\u00E9l\u00E9ments'\r\n    });\r\n  } else if (itemCount <= 6) {\r\n    layouts.push({\r\n      preset: '3x2',\r\n      columns: 3,\r\n      rows: 2,\r\n      gap: 24,\r\n      responsive: { mobile: 1, tablet: 2, desktop: 3 },\r\n      reason: 'Grille 3 colonnes \u00E9quilibr\u00E9e'\r\n    });\r\n  } else if (itemCount <= 9) {\r\n    layouts.push({\r\n      preset: '3x3',\r\n      columns: 3,\r\n      rows: 3,\r\n      gap: 20,\r\n      responsive: { mobile: 1, tablet: 2, desktop: 3 },\r\n      reason: 'Grille 3x3 pour 7-9 \u00E9l\u00E9ments'\r\n    });\r\n  } else {\r\n    layouts.push({\r\n      preset: '4x3',\r\n      columns: 4,\r\n      rows: Math.ceil(itemCount / 4),\r\n      gap: 16,\r\n      responsive: { mobile: 1, tablet: 2, desktop: 4 },\r\n      reason: 'Grille dense pour nombreux \u00E9l\u00E9ments'\r\n    });\r\n  }\r\n\r\n  return layouts;\r\n}\r\n\r\n/**\r\n * G\u00E9n\u00E8re des palettes de fallback\r\n */\r\nfunction generateFallbackPalettes(baseColor: string): any[] {\r\n  return [\r\n    {\r\n      name: 'Palette Professionnelle',\r\n      primary: baseColor || '#1890ff',\r\n      secondary: '#52c41a',\r\n      accent: '#faad14',\r\n      background: '#ffffff',\r\n      text: '#000000',\r\n      success: '#52c41a',\r\n      warning: '#faad14',\r\n      error: '#ff4d4f',\r\n      reason: 'Couleurs \u00E9quilibr\u00E9es et professionnelles'\r\n    },\r\n    {\r\n      name: 'Palette Moderne',\r\n      primary: '#722ed1',\r\n      secondary: '#13c2c2',\r\n      accent: '#fadb14',\r\n      background: '#f0f2f5',\r\n      text: '#262626',\r\n      success: '#52c41a',\r\n      warning: '#fa8c16',\r\n      error: '#f5222d',\r\n      reason: 'Design moderne avec contraste \u00E9lev\u00E9'\r\n    },\r\n    {\r\n      name: 'Palette \u00C9l\u00E9gante',\r\n      primary: '#2f54eb',\r\n      secondary: '#eb2f96',\r\n      accent: '#faad14',\r\n      background: '#fafafa',\r\n      text: '#141414',\r\n      success: '#73d13d',\r\n      warning: '#ffc53d',\r\n      error: '#ff7875',\r\n      reason: '\u00C9l\u00E9gance et sophistication'\r\n    }\r\n  ];\r\n}\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83E\uDD16 AI FIELD GENERATOR - ROUTE INTELLIGENTE\r\n * \r\n * G\u00E9n\u00E8re du contenu intelligent pour n'importe quel champ du Website Builder\r\n * avec analyse de contexte, propositions multiples, et scoring de qualit\u00E9.\r\n * \r\n * Endpoint: POST /api/ai/generate-field\r\n * \r\n * @author IA Assistant - Syst\u00E8me de g\u00E9n\u00E9ration intelligent\r\n */\r\n\r\nimport express from 'express';\r\nimport { authMiddleware } from '../middlewares/auth';\r\nimport type { AuthenticatedRequest } from '../middlewares/auth';\r\nimport { GoogleGeminiService } from '../services/GoogleGeminiService';\r\n\r\nconst router = express.Router();\r\nconst geminiService = new GoogleGeminiService();\r\n\r\n// Protection par authentification\r\nrouter.use(authMiddleware);\r\n\r\n/**\r\n * \uD83C\uDFAF SYST\u00C8ME DE PROMPTS INTELLIGENTS\r\n * Adapte le prompt selon le type de champ pour des r\u00E9sultats optimaux\r\n */\r\nclass SmartPromptBuilder {\r\n  /**\r\n   * Construit un prompt optimis\u00E9 selon le type de champ\r\n   */\r\n  static buildPrompt(params: {\r\n    fieldId: string;\r\n    fieldType: string;\r\n    fieldLabel: string;\r\n    currentValue?: any;\r\n    aiContext: {\r\n      sectionType: string;\r\n      businessType?: string;\r\n      tone?: string;\r\n      targetAudience?: string;\r\n      language?: string;\r\n      keywords?: string[];\r\n    };\r\n  }): string {\r\n    const { fieldId, fieldType, fieldLabel, currentValue, aiContext } = params;\r\n    const language = aiContext.language || 'fran\u00E7ais';\r\n    const tone = aiContext.tone || 'professionnel et convaincant';\r\n    const audience = aiContext.targetAudience || 'clients potentiels';\r\n    const business = aiContext.businessType || 'services \u00E9nerg\u00E9tiques';\r\n    const keywords = aiContext.keywords?.join(', ') || '';\r\n\r\n    // Contexte enrichi pour tous les types\r\n    const baseContext = `\r\nTu es un expert en r\u00E9daction web, marketing digital et SEO pour le secteur ${business}.\r\n\r\nCONTEXTE:\r\n- Type de section: ${aiContext.sectionType}\r\n- Champ \u00E0 g\u00E9n\u00E9rer: ${fieldLabel} (${fieldId})\r\n- Public cible: ${audience}\r\n- Ton: ${tone}\r\n- Langue: ${language}\r\n${keywords ? `- Mots-cl\u00E9s sugg\u00E9r\u00E9s: ${keywords}` : ''}\r\n${currentValue ? `- Valeur actuelle: \"${currentValue}\"` : ''}\r\n`;\r\n\r\n    // Prompts sp\u00E9cialis\u00E9s selon le type de champ\r\n    switch (fieldType) {\r\n      case 'text':\r\n        return this.buildTextPrompt(baseContext, fieldId, fieldLabel, currentValue);\r\n      \r\n      case 'textarea':\r\n        return this.buildTextareaPrompt(baseContext, fieldId, fieldLabel, currentValue);\r\n      \r\n      case 'select':\r\n      case 'multiselect':\r\n        return this.buildSelectPrompt(baseContext, fieldId, fieldLabel, currentValue);\r\n      \r\n      case 'richtext':\r\n        return this.buildRichtextPrompt(baseContext, fieldId, fieldLabel, currentValue);\r\n      \r\n      default:\r\n        return this.buildGenericPrompt(baseContext, fieldLabel, currentValue);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Prompt pour champs texte courts (titres, labels, CTA)\r\n   */\r\n  private static buildTextPrompt(context: string, fieldId: string, label: string, current?: any): string {\r\n    // D\u00E9tection du type de contenu par l'ID du champ\r\n    const isTitle = fieldId.toLowerCase().includes('title') || label.toLowerCase().includes('titre');\r\n    const isCTA = fieldId.toLowerCase().includes('cta') || label.toLowerCase().includes('bouton');\r\n    const isLabel = fieldId.toLowerCase().includes('label');\r\n\r\n    let specificGuidelines = '';\r\n    let maxLength = 60;\r\n\r\n    if (isTitle) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES TITRE:\r\n- Accrocheur et m\u00E9morable\r\n- Orient\u00E9 b\u00E9n\u00E9fice client\r\n- Inclure un chiffre ou statistique si pertinent\r\n- \u00C9voquer la transformation ou le r\u00E9sultat\r\n- Cr\u00E9er de la curiosit\u00E9 ou urgence\r\n`;\r\n      maxLength = 60;\r\n    } else if (isCTA) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES CTA:\r\n- Verbe d'action \u00E0 l'imp\u00E9ratif\r\n- Court et percutant (3-5 mots maximum)\r\n- Cr\u00E9er l'urgence ou la valeur\r\n- Exemples: \"Demander un devis gratuit\", \"D\u00E9couvrir nos solutions\", \"Calculer mes \u00E9conomies\"\r\n`;\r\n      maxLength = 40;\r\n    } else if (isLabel) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES LABEL:\r\n- Clair et descriptif\r\n- Terme professionnel mais accessible\r\n- Coh\u00E9rent avec le secteur\r\n`;\r\n      maxLength = 40;\r\n    }\r\n\r\n    return `${context}\r\n\r\n${specificGuidelines}\r\n\r\nT\u00C2CHE: G\u00E9n\u00E8re 3 PROPOSITIONS VARI\u00C9ES pour ce champ texte court.\r\n\r\nCONTRAINTES:\r\n- Maximum ${maxLength} caract\u00E8res par proposition\r\n- Ton professionnel et convaincant\r\n- Optimis\u00E9 SEO naturellement\r\n- \u00C9viter les clich\u00E9s et phrases creuses\r\n- Vari\u00E9t\u00E9 dans les approches (angle diff\u00E9rent pour chaque proposition)\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure:\r\n{\r\n  \"suggestions\": [\r\n    {\r\n      \"content\": \"Proposition 1\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 85\r\n    },\r\n    {\r\n      \"content\": \"Proposition 2\", \r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 90\r\n    },\r\n    {\r\n      \"content\": \"Proposition 3\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\", \r\n      \"score\": 80\r\n    }\r\n  ],\r\n  \"analysis\": {\r\n    \"fieldType\": \"${fieldId}\",\r\n    \"bestApproach\": \"Approche recommand\u00E9e (1 phrase)\",\r\n    \"keywords\": [\"mot-cl\u00E9 1\", \"mot-cl\u00E9 2\", \"mot-cl\u00E9 3\"],\r\n    \"avgScore\": 85\r\n  }\r\n}\r\n\r\n\u26A0\uFE0F IMPORTANT: Retourne UNIQUEMENT le JSON, aucun texte avant ou apr\u00E8s.`;\r\n  }\r\n\r\n  /**\r\n   * Prompt pour champs textarea (descriptions, paragraphes)\r\n   */\r\n  private static buildTextareaPrompt(context: string, fieldId: string, label: string, current?: any): string {\r\n    const isDescription = fieldId.toLowerCase().includes('description') || label.toLowerCase().includes('description');\r\n    const isAbout = fieldId.toLowerCase().includes('about') || label.toLowerCase().includes('pr\u00E9sentation');\r\n\r\n    let specificGuidelines = '';\r\n    let maxLength = 200;\r\n\r\n    if (isDescription) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES DESCRIPTION:\r\n- 2-3 phrases persuasives\r\n- Structure: Probl\u00E8me \u2192 Solution \u2192 B\u00E9n\u00E9fice\r\n- Inclure des chiffres/donn\u00E9es si pertinent\r\n- Call-to-action implicite\r\n- Optimis\u00E9 pour la conversion\r\n`;\r\n      maxLength = 200;\r\n    } else if (isAbout) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES \u00C0 PROPOS:\r\n- 3-4 phrases engageantes\r\n- Histoire/mission de l'entreprise\r\n- Valeurs et diff\u00E9renciateurs\r\n- Preuve sociale ou chiffres cl\u00E9s\r\n- Cr\u00E9er la confiance\r\n`;\r\n      maxLength = 300;\r\n    }\r\n\r\n    return `${context}\r\n\r\n${specificGuidelines}\r\n\r\nT\u00C2CHE: G\u00E9n\u00E8re 3 PROPOSITIONS VARI\u00C9ES pour ce champ texte long.\r\n\r\nCONTRAINTES:\r\n- Maximum ${maxLength} caract\u00E8res par proposition\r\n- Style fluide et naturel\r\n- Ponctuation et structure professionnelle\r\n- Int\u00E9gration naturelle des mots-cl\u00E9s\r\n- \u00C9viter le jargon excessif\r\n- Vari\u00E9t\u00E9 dans les angles (rationnel, \u00E9motionnel, social proof)\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure:\r\n{\r\n  \"suggestions\": [\r\n    {\r\n      \"content\": \"Proposition 1 (2-3 phrases)\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 88,\r\n      \"angle\": \"angle rationnel / \u00E9motionnel / social proof\"\r\n    },\r\n    {\r\n      \"content\": \"Proposition 2 (2-3 phrases)\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 92,\r\n      \"angle\": \"angle rationnel / \u00E9motionnel / social proof\"\r\n    },\r\n    {\r\n      \"content\": \"Proposition 3 (2-3 phrases)\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 85,\r\n      \"angle\": \"angle rationnel / \u00E9motionnel / social proof\"\r\n    }\r\n  ],\r\n  \"analysis\": {\r\n    \"fieldType\": \"${fieldId}\",\r\n    \"bestApproach\": \"Approche recommand\u00E9e (1 phrase)\",\r\n    \"keywords\": [\"mot-cl\u00E9 1\", \"mot-cl\u00E9 2\", \"mot-cl\u00E9 3\", \"mot-cl\u00E9 4\"],\r\n    \"avgScore\": 88,\r\n    \"readabilityTips\": [\"Conseil 1\", \"Conseil 2\"]\r\n  }\r\n}\r\n\r\n\u26A0\uFE0F IMPORTANT: Retourne UNIQUEMENT le JSON, aucun texte avant ou apr\u00E8s.`;\r\n  }\r\n\r\n  /**\r\n   * Prompt pour champs select/multiselect (features, tags, options)\r\n   */\r\n  private static buildSelectPrompt(context: string, fieldId: string, label: string, current?: any): string {\r\n    const isFeatures = fieldId.toLowerCase().includes('feature') || label.toLowerCase().includes('caract\u00E9ristique');\r\n    const isTags = fieldId.toLowerCase().includes('tag') || label.toLowerCase().includes('\u00E9tiquette');\r\n    const isBenefits = fieldId.toLowerCase().includes('benefit') || label.toLowerCase().includes('avantage');\r\n\r\n    let specificGuidelines = '';\r\n    let itemCount = 4;\r\n\r\n    if (isFeatures) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES FEATURES:\r\n- Caract\u00E9ristiques techniques ET b\u00E9n\u00E9fices\r\n- Format: \"B\u00E9n\u00E9fice concret + d\u00E9tail technique\"\r\n- Exemples: \"Garantie 25 ans sur les panneaux\", \"Installation en 2 jours chrono\"\r\n- M\u00E9langer aspects techniques, pratiques, et commerciaux\r\n`;\r\n      itemCount = 4;\r\n    } else if (isTags) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES TAGS:\r\n- Mots-cl\u00E9s courts (1-3 mots)\r\n- Descriptifs et recherchables\r\n- Mix: technique + cat\u00E9gorie + b\u00E9n\u00E9fice\r\n- Exemples: \"\u00C9nergie verte\", \"R\u00E9sidentiel\", \"Haute performance\"\r\n`;\r\n      itemCount = 5;\r\n    } else if (isBenefits) {\r\n      specificGuidelines = `\r\nGUIDELINES SP\u00C9CIFIQUES AVANTAGES:\r\n- Orient\u00E9 r\u00E9sultat client\r\n- Quantifiable si possible\r\n- \u00C9motionnel + rationnel\r\n- Exemples: \"R\u00E9duisez vos factures de 60%\", \"Installation garantie d\u00E9cennale\"\r\n`;\r\n      itemCount = 4;\r\n    }\r\n\r\n    return `${context}\r\n\r\n${specificGuidelines}\r\n\r\nT\u00C2CHE: G\u00E9n\u00E8re ${itemCount} ITEMS PERTINENTS ET VARI\u00C9S pour ce champ liste.\r\n\r\nCONTRAINTES:\r\n- ${itemCount} items par proposition\r\n- Chaque item: 5-12 mots maximum\r\n- Coh\u00E9rence et compl\u00E9mentarit\u00E9 entre les items\r\n- \u00C9viter les r\u00E9p\u00E9titions\r\n- Mix de types: technique, pratique, \u00E9motionnel, chiffr\u00E9\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure:\r\n{\r\n  \"suggestions\": [\r\n    {\r\n      \"content\": [\"Item 1\", \"Item 2\", \"Item 3\", \"Item 4\"],\r\n      \"reasoning\": \"Logique de s\u00E9lection (1 phrase)\",\r\n      \"score\": 87\r\n    },\r\n    {\r\n      \"content\": [\"Item 1\", \"Item 2\", \"Item 3\", \"Item 4\"],\r\n      \"reasoning\": \"Logique de s\u00E9lection (1 phrase)\",\r\n      \"score\": 91\r\n    },\r\n    {\r\n      \"content\": [\"Item 1\", \"Item 2\", \"Item 3\", \"Item 4\"],\r\n      \"reasoning\": \"Logique de s\u00E9lection (1 phrase)\",\r\n      \"score\": 84\r\n    }\r\n  ],\r\n  \"analysis\": {\r\n    \"fieldType\": \"${fieldId}\",\r\n    \"bestApproach\": \"Approche recommand\u00E9e (1 phrase)\",\r\n    \"keywords\": [\"mot-cl\u00E9 1\", \"mot-cl\u00E9 2\", \"mot-cl\u00E9 3\"],\r\n    \"avgScore\": 87\r\n  }\r\n}\r\n\r\n\u26A0\uFE0F IMPORTANT: Retourne UNIQUEMENT le JSON, aucun texte avant ou apr\u00E8s.`;\r\n  }\r\n\r\n  /**\r\n   * Prompt pour richtext (contenu HTML/Markdown enrichi)\r\n   */\r\n  private static buildRichtextPrompt(context: string, fieldId: string, label: string, current?: any): string {\r\n    return `${context}\r\n\r\nT\u00C2CHE: G\u00E9n\u00E8re 2 PROPOSITIONS VARI\u00C9ES de contenu enrichi (paragraphes structur\u00E9s).\r\n\r\nCONTRAINTES:\r\n- 2-4 paragraphes par proposition\r\n- Structure: Intro \u2192 D\u00E9veloppement \u2192 Conclusion/CTA\r\n- Ton professionnel et engageant\r\n- Int\u00E9gration naturelle des mots-cl\u00E9s\r\n- Lisibilit\u00E9 optimale (phrases courtes, transitions)\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure:\r\n{\r\n  \"suggestions\": [\r\n    {\r\n      \"content\": \"Paragraphe 1\\n\\nParagraphe 2\\n\\nParagraphe 3\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 89,\r\n      \"structure\": \"intro + b\u00E9n\u00E9fices + preuve sociale\"\r\n    },\r\n    {\r\n      \"content\": \"Paragraphe 1\\n\\nParagraphe 2\\n\\nParagraphe 3\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 92,\r\n      \"structure\": \"probl\u00E8me + solution + r\u00E9sultats\"\r\n    }\r\n  ],\r\n  \"analysis\": {\r\n    \"fieldType\": \"${fieldId}\",\r\n    \"bestApproach\": \"Approche recommand\u00E9e (1 phrase)\",\r\n    \"keywords\": [\"mot-cl\u00E9 1\", \"mot-cl\u00E9 2\", \"mot-cl\u00E9 3\", \"mot-cl\u00E9 4\"],\r\n    \"avgScore\": 90,\r\n    \"readabilityScore\": 85\r\n  }\r\n}\r\n\r\n\u26A0\uFE0F IMPORTANT: Retourne UNIQUEMENT le JSON, aucun texte avant ou apr\u00E8s.`;\r\n  }\r\n\r\n  /**\r\n   * Prompt g\u00E9n\u00E9rique pour types inconnus\r\n   */\r\n  private static buildGenericPrompt(context: string, label: string, current?: any): string {\r\n    return `${context}\r\n\r\nT\u00C2CHE: G\u00E9n\u00E8re 3 PROPOSITIONS PERTINENTES pour le champ \"${label}\".\r\n\r\nRetourne UNIQUEMENT un objet JSON valide avec cette structure:\r\n{\r\n  \"suggestions\": [\r\n    {\r\n      \"content\": \"Proposition 1\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 85\r\n    },\r\n    {\r\n      \"content\": \"Proposition 2\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 88\r\n    },\r\n    {\r\n      \"content\": \"Proposition 3\",\r\n      \"reasoning\": \"Pourquoi cette proposition (1 phrase)\",\r\n      \"score\": 82\r\n    }\r\n  ],\r\n  \"analysis\": {\r\n    \"fieldType\": \"${label}\",\r\n    \"bestApproach\": \"Approche recommand\u00E9e (1 phrase)\",\r\n    \"keywords\": [\"mot-cl\u00E9 1\", \"mot-cl\u00E9 2\", \"mot-cl\u00E9 3\"],\r\n    \"avgScore\": 85\r\n  }\r\n}\r\n\r\n\u26A0\uFE0F IMPORTANT: Retourne UNIQUEMENT le JSON, aucun texte avant ou apr\u00E8s.`;\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83D\uDCCA ANALYSEUR DE QUALIT\u00C9\r\n * \u00C9value la qualit\u00E9 des suggestions g\u00E9n\u00E9r\u00E9es\r\n */\r\nclass QualityAnalyzer {\r\n  /**\r\n   * Analyse et enrichit les suggestions avec des m\u00E9triques\r\n   */\r\n  static analyzeSuggestions(response: any, fieldType: string): any {\r\n    try {\r\n      // Calcul du score moyen\r\n      const scores = response.suggestions.map((s: any) => s.score || 0);\r\n      const avgScore = scores.length > 0 \r\n        ? Math.round(scores.reduce((a: number, b: number) => a + b, 0) / scores.length)\r\n        : 0;\r\n\r\n      // Tri des suggestions par score\r\n      response.suggestions.sort((a: any, b: any) => (b.score || 0) - (a.score || 0));\r\n\r\n      // Enrichissement de l'analyse\r\n      response.analysis = {\r\n        ...response.analysis,\r\n        avgScore,\r\n        generatedAt: new Date().toISOString(),\r\n        fieldType,\r\n        qualityLevel: avgScore >= 90 ? 'excellent' : avgScore >= 80 ? 'good' : avgScore >= 70 ? 'acceptable' : 'needs-improvement'\r\n      };\r\n\r\n      return response;\r\n    } catch (error) {\r\n      console.error('\u274C [QualityAnalyzer] Erreur analyse:', error);\r\n      return response;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83C\uDFAF ENDPOINT PRINCIPAL: POST /api/ai/generate-field\r\n */\r\nrouter.post('/generate-field', async (req: AuthenticatedRequest, res) => {\r\n  const startTime = Date.now();\r\n  \r\n  try {\r\n    const { fieldId, fieldType, fieldLabel, currentValue, aiContext } = req.body;\r\n\r\n    // \u2705 Validation des param\u00E8tres\r\n    if (!fieldId || !fieldType || !fieldLabel) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Param\u00E8tres manquants',\r\n        details: 'fieldId, fieldType et fieldLabel sont requis'\r\n      });\r\n    }\r\n\r\n    if (!aiContext || !aiContext.sectionType) {\r\n      return res.status(400).json({\r\n        success: false,\r\n        error: 'Contexte IA manquant',\r\n        details: 'aiContext.sectionType est requis'\r\n      });\r\n    }\r\n\r\n    console.log('\uD83E\uDD16 [AI] G\u00E9n\u00E9ration pour:', {\r\n      fieldId,\r\n      fieldType,\r\n      fieldLabel,\r\n      sectionType: aiContext.sectionType\r\n    });\r\n\r\n    // \uD83E\uDDE0 Construction du prompt intelligent\r\n    const prompt = SmartPromptBuilder.buildPrompt({\r\n      fieldId,\r\n      fieldType,\r\n      fieldLabel,\r\n      currentValue,\r\n      aiContext\r\n    });\r\n\r\n    console.log('\uD83D\uDCDD [AI] Prompt construit, appel \u00E0 Gemini...');\r\n\r\n    // \uD83D\uDE80 G\u00E9n\u00E9ration avec Gemini\r\n    const geminiResult = await geminiService.chat({ prompt, raw: true });\r\n    \r\n    if (!geminiResult.success || !geminiResult.content) {\r\n      throw new Error(geminiResult.error || 'Erreur lors de l\\'appel \u00E0 Gemini');\r\n    }\r\n\r\n    console.log('\u2705 [AI] R\u00E9ponse brute re\u00E7ue:', geminiResult.content.substring(0, 200));\r\n\r\n    // \uD83D\uDCCA Extraction et parsing du JSON\r\n    const jsonMatch = geminiResult.content.match(/\\{[\\s\\S]*\\}/);\r\n    if (!jsonMatch) {\r\n      throw new Error('Format de r\u00E9ponse invalide: JSON non trouv\u00E9 dans la r\u00E9ponse IA');\r\n    }\r\n\r\n    let parsedResponse = JSON.parse(jsonMatch[0]);\r\n\r\n    // \uD83D\uDCC8 Analyse de qualit\u00E9\r\n    parsedResponse = QualityAnalyzer.analyzeSuggestions(parsedResponse, fieldType);\r\n\r\n  const duration = Date.now() - startTime;\r\n  const modelUsed = geminiResult.model || geminiService.getStatus().model;\r\n\r\n    console.log(`\u2705 [AI] G\u00E9n\u00E9ration r\u00E9ussie en ${duration}ms, score moyen: ${parsedResponse.analysis.avgScore}/100`);\r\n\r\n    // \uD83C\uDF89 R\u00E9ponse structur\u00E9e\r\n    return res.json({\r\n      success: true,\r\n      content: parsedResponse.suggestions[0]?.content, // Meilleure suggestion par d\u00E9faut\r\n      suggestions: parsedResponse.suggestions,\r\n      analysis: parsedResponse.analysis,\r\n      metadata: {\r\n        generatedAt: new Date().toISOString(),\r\n        duration,\r\n        model: modelUsed,\r\n        fieldType,\r\n        fieldId\r\n      }\r\n    });\r\n\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n    \r\n    console.error('\u274C [AI] Erreur g\u00E9n\u00E9ration:', error);\r\n\r\n    // Gestion des erreurs sp\u00E9cifiques\r\n    if (error.message?.includes('API key')) {\r\n      return res.status(500).json({\r\n        success: false,\r\n        error: 'Configuration IA manquante',\r\n        details: 'La cl\u00E9 API Google Gemini n\\'est pas configur\u00E9e',\r\n        duration\r\n      });\r\n    }\r\n\r\n    if (error.message?.includes('quota') || error.message?.includes('rate limit')) {\r\n      return res.status(429).json({\r\n        success: false,\r\n        error: 'Limite de quota atteinte',\r\n        details: 'Trop de requ\u00EAtes IA. Attendez quelques instants.',\r\n        duration\r\n      });\r\n    }\r\n\r\n    return res.status(500).json({\r\n      success: false,\r\n      error: 'Erreur lors de la g\u00E9n\u00E9ration',\r\n      details: error.message || 'Erreur inconnue',\r\n      duration\r\n    });\r\n  }\r\n});\r\n\r\n/**\r\n * \uD83D\uDD0D ENDPOINT STATUS: GET /api/ai/status\r\n * V\u00E9rifie si le service IA est disponible\r\n */\r\nrouter.get('/status', async (_req: AuthenticatedRequest, res) => {\r\n  try {\r\n    // Test simple de disponibilit\u00E9\r\n    const isAvailable = !!process.env.GOOGLE_API_KEY || !!process.env.GEMINI_API_KEY;\r\n    \r\n    res.json({\r\n      success: true,\r\n      available: isAvailable,\r\n      service: 'Google Gemini',\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (error: any) {\r\n    res.status(500).json({\r\n      success: false,\r\n      available: false,\r\n      error: error.message\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n", "/**\r\n * \uD83C\uDF10 MIDDLEWARE DE D\u00C9TECTION AUTOMATIQUE DES SITES VITRINES v2.0\r\n * \r\n * D\u00E9tecte le domaine appel\u00E9 et charge automatiquement le site correspondant\r\n * depuis la base de donn\u00E9es. Fonctionne pour TOUS les sites cr\u00E9\u00E9s dans le CRM.\r\n * \r\n * Exemples:\r\n * - 2thier.be \u2192 Charge le site avec domain=\"2thier.be\"\r\n * - devis1min.be \u2192 Charge le site avec domain=\"devis1min.be\"\r\n * - monsite.com \u2192 Charge le site avec domain=\"monsite.com\"\r\n * \r\n * Updated: 14/10/2025 - Fix siteName loading\r\n */\r\n\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { PrismaClient } from '@prisma/client';\r\nimport { renderWebsite } from './websiteRenderer';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// Domaines r\u00E9serv\u00E9s pour le CRM (ne sont PAS des sites vitrines)\r\nconst CRM_DOMAINS = [\r\n  'app.2thier.be',\r\n  'api.2thier.be',\r\n  'crm.2thier.be',\r\n  'localhost'\r\n];\r\n\r\nexport interface WebsiteRequest extends Request {\r\n  websiteData?: {\r\n    id: string;\r\n    slug: string;\r\n    domain: string;\r\n    name: string;\r\n    config: any;\r\n    sections: any[];\r\n  };\r\n  isWebsiteRoute?: boolean;\r\n}\r\n\r\n/**\r\n * D\u00E9tecte si la requ\u00EAte vient d'un domaine de site vitrine\r\n * et charge les donn\u00E9es du site depuis la BD\r\n */\r\nexport async function detectWebsite(\r\n  req: WebsiteRequest,\r\n  res: Response,\r\n  next: NextFunction\r\n) {\r\n  try {\r\n    // \uD83C\uDF10 D\u00C9TECTER LE DOMAINE: utiliser plusieurs sources\r\n    // Cloud Run envoie le domaine dans req.hostname via les domain mappings\r\n    const forwardedHost = req.headers['x-forwarded-host'] as string;\r\n    const hostHeader = req.headers.host as string;\r\n    \r\n    // Priorit\u00E9: X-Forwarded-Host > Host header > req.hostname\r\n    let hostname = forwardedHost || hostHeader || req.hostname || '';\r\n    \r\n    // Enlever le port si pr\u00E9sent (ex: localhost:5173)\r\n    hostname = hostname.split(':')[0];\r\n    \r\n    console.log(`\uD83D\uDD0D [WEBSITE-DETECTION] Headers - X-Forwarded-Host: ${forwardedHost}, Host: ${hostHeader}, hostname: ${req.hostname}`);\r\n    console.log(`\uD83D\uDD0D [WEBSITE-DETECTION] Domaine d\u00E9tect\u00E9: ${hostname}`);\r\n    \r\n    // Si c'est un domaine CRM, passer au suivant\r\n    if (CRM_DOMAINS.some(crm => hostname.includes(crm))) {\r\n      console.log(`\uD83D\uDCF1 [WEBSITE-DETECTION] Domaine CRM d\u00E9tect\u00E9: ${hostname}`);\r\n      req.isWebsiteRoute = false;\r\n      return next();\r\n    }\r\n\r\n    // Nettoyer le hostname (enlever www. si pr\u00E9sent)\r\n    const cleanDomain = hostname.replace(/^www\\./, '');\r\n\r\n    console.log(`\uD83C\uDF10 [WEBSITE-DETECTION] Recherche site pour: ${cleanDomain}`);\r\n\r\n    // Chercher le site dans la base de donn\u00E9es\r\n    const website = await prisma.webSite.findFirst({\r\n      where: {\r\n        OR: [\r\n          { domain: cleanDomain },\r\n          { domain: hostname },\r\n          { domain: `www.${cleanDomain}` }\r\n        ],\r\n        isActive: true\r\n      },\r\n      include: {\r\n        config: true,\r\n        sections: {\r\n          where: { isActive: true },\r\n          orderBy: { displayOrder: 'asc' }\r\n        }\r\n      }\r\n    });\r\n\r\n    if (website) {\r\n      console.log(`\u2705 [WEBSITE-DETECTION] Site trouv\u00E9: ${website.siteName} (${website.slug})`);\r\n      \r\n      req.websiteData = {\r\n        id: website.id,\r\n        slug: website.slug,\r\n        domain: website.domain || cleanDomain,\r\n        name: website.siteName, // \u2190 Correction: utiliser siteName au lieu de name\r\n        config: website.config,\r\n        sections: website.sections\r\n      };\r\n      req.isWebsiteRoute = true;\r\n      \r\n      // \uD83C\uDF10 SI C'EST UN SITE VITRINE, NE PAS ROUTER, IGNORER COMPL\u00C8TEMENT LA REQU\u00CATE\r\n      // ET LA LAISSER PASSER AU RENDERER\r\n    } else {\r\n      console.log(`\u26A0\uFE0F [WEBSITE-DETECTION] Aucun site trouv\u00E9 pour: ${cleanDomain}`);\r\n      req.isWebsiteRoute = false;\r\n    }\r\n\r\n    next();\r\n  } catch (error) {\r\n    console.error('\u274C [WEBSITE-DETECTION] Erreur:', error);\r\n    req.isWebsiteRoute = false;\r\n    next();\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware qui intercepte les requ\u00EAtes de sites vitrines\r\n * et les rend directement AVANT le serveur statique\r\n */\r\nexport function websiteInterceptor(\r\n  req: WebsiteRequest,\r\n  res: Response,\r\n  next: NextFunction\r\n) {\r\n  // Si c'est une route API, health ou assets, passer au suivant\r\n  if (req.url.startsWith('/api/') || req.url.startsWith('/assets/') || req.url.startsWith('/health')) {\r\n    return next();\r\n  }\r\n  \r\n  // Si un site vitrine a \u00E9t\u00E9 d\u00E9tect\u00E9, ne PAS continuer, rendre le site\r\n  if (req.isWebsiteRoute && req.websiteData) {\r\n    console.log(`\uD83C\uDFA8 [WEBSITE-INTERCEPTOR] Interception pour site: ${req.websiteData.name}`);\r\n    return renderWebsite(req, res);\r\n  }\r\n  \r\n  // Sinon, continuer vers le serveur statique du CRM\r\n  next();\r\n}\r\n", "/**\r\n * \uD83C\uDFA8 SYST\u00C8ME DE RENDU SSR POUR SITES VITRINES\r\n * \r\n * G\u00E9n\u00E8re le HTML complet d'un site vitrine c\u00F4t\u00E9 serveur\r\n * en utilisant les renderers React (Header, Hero, Services, etc.)\r\n * \r\n * Compatible avec TOUS les sites cr\u00E9\u00E9s dans le CRM.\r\n */\r\n\r\nimport { Response } from 'express';\r\nimport { WebsiteRequest } from '../middleware/websiteDetection';\r\n\r\n/**\r\n * G\u00E9n\u00E8re le HTML d'une section en fonction de son type\r\n */\r\nfunction renderSection(section: any): string {\r\n  const content = section.content || {};\r\n  const sectionType = section.sectionType;\r\n\r\n  switch (sectionType) {\r\n    case 'header':\r\n      return renderHeader(content);\r\n    case 'hero':\r\n      return renderHero(content);\r\n    case 'services':\r\n      return renderServices(content);\r\n    case 'about':\r\n      return renderAbout(content);\r\n    case 'stats':\r\n      return renderStats(content);\r\n    case 'cta':\r\n      return renderCTA(content);\r\n    case 'testimonials':\r\n      return renderTestimonials(content);\r\n    case 'faq':\r\n      return renderFAQ(content);\r\n    case 'contact':\r\n      return renderContact(content);\r\n    case 'footer':\r\n      return renderFooter(content);\r\n    default:\r\n      return `<!-- Section inconnue: ${sectionType} -->`;\r\n  }\r\n}\r\n\r\nfunction renderHeader(content: any): string {\r\n  const logo = content.logo || {};\r\n  const menu = content.menu || {};\r\n  const cta = content.cta || {};\r\n  \r\n  return `\r\n    <header class=\"site-header\" style=\"background-color: ${content.background?.color || '#ffffff'}; padding: ${content.spacing?.padding || '20px'} 0;\">\r\n      <div class=\"container\" style=\"max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;\">\r\n        <div class=\"logo\">\r\n          ${logo.image?.url ? `<img src=\"${logo.image.url}\" alt=\"${logo.text || 'Logo'}\" style=\"height: ${logo.size?.height || '40px'};\">` : `<span style=\"font-size: ${logo.text?.fontSize || '24px'}; font-weight: bold; color: ${logo.text?.color || '#000000'};\">${logo.text?.value || 'Logo'}</span>`}\r\n        </div>\r\n        <nav class=\"menu\" style=\"display: flex; gap: ${menu.spacing?.gap || '30px'};\">\r\n          ${(menu.items || []).map((item: any) => `\r\n            <a href=\"${item.link || '#'}\" style=\"color: ${menu.text?.color || '#333333'}; text-decoration: none; font-size: ${menu.text?.fontSize || '16px'};\">\r\n              ${item.label || 'Menu'}\r\n            </a>\r\n          `).join('')}\r\n        </nav>\r\n        ${cta.text?.value ? `\r\n          <a href=\"${cta.link || '#'}\" class=\"cta-button\" style=\"background-color: ${cta.background?.color || '#007bff'}; color: ${cta.text?.color || '#ffffff'}; padding: ${cta.spacing?.padding || '12px 24px'}; border-radius: ${cta.border?.radius || '4px'}; text-decoration: none; font-size: ${cta.text?.fontSize || '16px'};\">\r\n            ${cta.text.value}\r\n          </a>\r\n        ` : ''}\r\n      </div>\r\n    </header>\r\n  `;\r\n}\r\n\r\nfunction renderHero(content: any): string {\r\n  const title = content.title || {};\r\n  const subtitle = content.subtitle || {};\r\n  const cta = content.cta || {};\r\n  \r\n  return `\r\n    <section class=\"hero-section\" style=\"background: ${content.background?.type === 'image' && content.background?.image?.url ? `url('${content.background.image.url}') center/cover` : content.background?.color || '#f5f5f5'}; padding: ${content.spacing?.padding || '100px'} 0; text-align: ${content.layout?.alignment || 'center'};\">\r\n      <div class=\"container\" style=\"max-width: 1200px; margin: 0 auto;\">\r\n        <h1 style=\"font-size: ${title.fontSize || '48px'}; color: ${title.color || '#000000'}; margin-bottom: ${content.spacing?.gap || '20px'};\">\r\n          ${title.value || 'Titre Principal'}\r\n        </h1>\r\n        ${subtitle.value ? `\r\n          <p style=\"font-size: ${subtitle.fontSize || '20px'}; color: ${subtitle.color || '#666666'}; margin-bottom: ${content.spacing?.gap || '30px'};\">\r\n            ${subtitle.value}\r\n          </p>\r\n        ` : ''}\r\n        ${cta.text?.value ? `\r\n          <a href=\"${cta.link || '#'}\" style=\"display: inline-block; background-color: ${cta.background?.color || '#007bff'}; color: ${cta.text?.color || '#ffffff'}; padding: ${cta.spacing?.padding || '16px 32px'}; border-radius: ${cta.border?.radius || '4px'}; text-decoration: none; font-size: ${cta.text?.fontSize || '18px'};\">\r\n            ${cta.text.value}\r\n          </a>\r\n        ` : ''}\r\n      </div>\r\n    </section>\r\n  `;\r\n}\r\n\r\nfunction renderServices(content: any): string {\r\n  const title = content.title || {};\r\n  const services = content.services || [];\r\n  \r\n  return `\r\n    <section class=\"services-section\" style=\"background-color: ${content.background?.color || '#ffffff'}; padding: ${content.spacing?.padding || '80px'} 0;\">\r\n      <div class=\"container\" style=\"max-width: 1200px; margin: 0 auto;\">\r\n        ${title.value ? `\r\n          <h2 style=\"font-size: ${title.fontSize || '36px'}; color: ${title.color || '#000000'}; text-align: center; margin-bottom: ${content.spacing?.gap || '50px'};\">\r\n            ${title.value}\r\n          </h2>\r\n        ` : ''}\r\n        <div class=\"services-grid\" style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: ${content.grid?.gap || '30px'};\">\r\n          ${services.map((service: any) => `\r\n            <div class=\"service-card\" style=\"background-color: ${service.background?.color || '#f9f9f9'}; padding: ${service.spacing?.padding || '30px'}; border-radius: ${service.border?.radius || '8px'}; text-align: center;\">\r\n              ${service.icon ? `<div class=\"service-icon\" style=\"font-size: ${service.icon?.size || '48px'}; color: ${service.icon?.color || '#007bff'}; margin-bottom: 20px;\">${service.icon.value || '\uD83D\uDD27'}</div>` : ''}\r\n              <h3 style=\"font-size: ${service.title?.fontSize || '24px'}; color: ${service.title?.color || '#000000'}; margin-bottom: 15px;\">\r\n                ${service.title?.value || 'Service'}\r\n              </h3>\r\n              <p style=\"font-size: ${service.description?.fontSize || '16px'}; color: ${service.description?.color || '#666666'};\">\r\n                ${service.description?.value || 'Description du service'}\r\n              </p>\r\n            </div>\r\n          `).join('')}\r\n        </div>\r\n      </div>\r\n    </section>\r\n  `;\r\n}\r\n\r\nfunction renderAbout(_content: any): string {\r\n  return `<section class=\"about-section\"><!-- Section About --></section>`;\r\n}\r\n\r\nfunction renderStats(_content: any): string {\r\n  return `<section class=\"stats-section\"><!-- Section Stats --></section>`;\r\n}\r\n\r\nfunction renderCTA(_content: any): string {\r\n  return `<section class=\"cta-section\"><!-- Section CTA --></section>`;\r\n}\r\n\r\nfunction renderTestimonials(_content: any): string {\r\n  return `<section class=\"testimonials-section\"><!-- Section Testimonials --></section>`;\r\n}\r\n\r\nfunction renderFAQ(_content: any): string {\r\n  return `<section class=\"faq-section\"><!-- Section FAQ --></section>`;\r\n}\r\n\r\nfunction renderContact(_content: any): string {\r\n  return `<section class=\"contact-section\"><!-- Section Contact --></section>`;\r\n}\r\n\r\nfunction renderFooter(content: any): string {\r\n  const text = content.text || {};\r\n  const social = content.social || [];\r\n  \r\n  return `\r\n    <footer class=\"site-footer\" style=\"background-color: ${content.background?.color || '#333333'}; color: ${text.color || '#ffffff'}; padding: ${content.spacing?.padding || '40px'} 0; text-align: center;\">\r\n      <div class=\"container\" style=\"max-width: 1200px; margin: 0 auto;\">\r\n        ${text.value ? `\r\n          <p style=\"font-size: ${text.fontSize || '14px'}; margin-bottom: ${content.spacing?.gap || '20px'};\">\r\n            ${text.value}\r\n          </p>\r\n        ` : ''}\r\n        ${social.length > 0 ? `\r\n          <div class=\"social-links\" style=\"display: flex; justify-content: center; gap: ${content.social?.spacing || '20px'};\">\r\n            ${social.map((link: any) => `\r\n              <a href=\"${link.url || '#'}\" target=\"${link.openInNewTab !== false ? '_blank' : '_self'}\" rel=\"${link.openInNewTab !== false ? 'noopener noreferrer' : ''}\" style=\"color: ${content.social?.color || '#ffffff'}; font-size: ${content.social?.size || '24px'};\">\r\n                ${link.icon || link.platform || '\uD83D\uDD17'}\r\n              </a>\r\n            `).join('')}\r\n          </div>\r\n        ` : ''}\r\n      </div>\r\n    </footer>\r\n  `;\r\n}\r\n\r\n/**\r\n * Rend le site vitrine complet en HTML\r\n */\r\nexport async function renderWebsite(req: WebsiteRequest, res: Response) {\r\n  try {\r\n    const website = req.websiteData;\r\n\r\n    console.log(`\uD83C\uDFA8 [WEBSITE-RENDERER] Donn\u00E9es re\u00E7ues:`, {\r\n      hasWebsite: !!website,\r\n      name: website?.name,\r\n      sectionsCount: website?.sections?.length\r\n    });\r\n\r\n    if (!website) {\r\n      return res.status(404).send(`\r\n        <!DOCTYPE html>\r\n        <html lang=\"fr\">\r\n          <head>\r\n            <meta charset=\"UTF-8\">\r\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n            <title>Site non trouv\u00E9</title>\r\n          </head>\r\n          <body>\r\n            <h1>Site non trouv\u00E9</h1>\r\n            <p>Aucun site n'est configur\u00E9 pour ce domaine.</p>\r\n          </body>\r\n        </html>\r\n      `);\r\n    }\r\n\r\n    // G\u00E9n\u00E9rer le HTML de toutes les sections\r\n    const sectionsHTML = website.sections\r\n      .map(section => renderSection(section))\r\n      .join('\\n');\r\n\r\n    // G\u00E9n\u00E9rer le document HTML complet\r\n    const html = `\r\n      <!DOCTYPE html>\r\n      <html lang=\"fr\">\r\n        <head>\r\n          <meta charset=\"UTF-8\">\r\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes\">\r\n          <meta name=\"mobile-web-app-capable\" content=\"yes\">\r\n          <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\r\n          <title>${website.name}</title>\r\n          <meta name=\"description\" content=\"${website.config?.seo?.description || website.name}\">\r\n          <style>\r\n            * {\r\n              margin: 0;\r\n              padding: 0;\r\n              box-sizing: border-box;\r\n            }\r\n            body {\r\n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n              line-height: 1.6;\r\n            }\r\n            .container {\r\n              max-width: 1200px;\r\n              margin: 0 auto;\r\n              padding: 0 20px;\r\n            }\r\n            @media (max-width: 768px) {\r\n              .site-header .container {\r\n                flex-direction: column;\r\n                gap: 20px;\r\n              }\r\n              .menu {\r\n                flex-direction: column;\r\n                text-align: center;\r\n              }\r\n              .services-grid {\r\n                grid-template-columns: 1fr !important;\r\n              }\r\n            }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          ${sectionsHTML}\r\n          <script>\r\n            console.log('\u2705 Site vitrine charg\u00E9: ${website.name}');\r\n            console.log('\uD83D\uDCCD Domaine: ${website.domain}');\r\n          </script>\r\n        </body>\r\n      </html>\r\n    `;\r\n\r\n    res.send(html);\r\n  } catch (error) {\r\n    console.error('\u274C [WEBSITE-RENDERER] Erreur:', error);\r\n    res.status(500).send('Erreur lors du chargement du site');\r\n  }\r\n}\r\n", "import rateLimit, { ipKeyGenerator } from 'express-rate-limit';\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport crypto from 'crypto';\r\nimport { logSecurityEvent, securityMetrics } from './securityLogger';\r\n\r\n// \uD83D\uDEE1\uFE0F MIDDLEWARE DE MONITORING S\u00C9CURIS\u00C9\r\nexport const securityMonitoring = (req: Request, res: Response, next: NextFunction) => {\r\n  const startTime = Date.now();\r\n  const requestId = crypto.randomUUID();\r\n  \r\n  // Ajouter l'ID de requ\u00EAte pour le tracking\r\n  (req as any).requestId = requestId;\r\n  \r\n  // Analyser les patterns suspects\r\n  const suspiciousPatterns = [\r\n    /(\\<script\\>)/gi,  // XSS basique\r\n    /(union\\s+select)/gi,  // SQL injection\r\n    /(\\.\\.\\/)|(\\.\\.\\\\)/g,  // Path traversal\r\n    /(eval\\(|function\\s*\\()/gi,  // Code injection\r\n    /(exec\\(|system\\()/gi,  // Command injection\r\n  ];\r\n  \r\n  const userAgent = req.headers['user-agent'] || '';\r\n  const isSuspicious = suspiciousPatterns.some(pattern => \r\n    pattern.test(req.url) || \r\n    pattern.test(JSON.stringify(req.body || {})) ||\r\n    pattern.test(userAgent)\r\n  );\r\n  \r\n  if (isSuspicious) {\r\n    securityMetrics.suspiciousActivity++;\r\n    logSecurityEvent('SUSPICIOUS_REQUEST', {\r\n      requestId,\r\n      ip: req.ip,\r\n      method: req.method,\r\n      url: req.url,\r\n      userAgent,\r\n      body: req.body,\r\n      patterns: 'detected'\r\n    }, 'warn');\r\n  }\r\n  \r\n  // Continuer avec la r\u00E9ponse\r\n  res.on('finish', () => {\r\n    const duration = Date.now() - startTime;\r\n    securityMetrics.requestCount++;\r\n    \r\n    // Logger les requ\u00EAtes lentes (potentielles attaques)\r\n    if (duration > 5000) {\r\n      logSecurityEvent('SLOW_REQUEST', {\r\n        requestId,\r\n        duration,\r\n        method: req.method,\r\n        url: req.url,\r\n        ip: req.ip\r\n      }, 'warn');\r\n    }\r\n  });\r\n  \r\n  next();\r\n};\r\n\r\n// \uD83D\uDEE1\uFE0F PROTECTION CONTRE LES ATTAQUES DE TIMING\r\nexport const timingAttackProtection = (req: Request, res: Response, next: NextFunction) => {\r\n  const randomDelay = Math.floor(Math.random() * 50); // 0-50ms al\u00E9atoire\r\n  \r\n  setTimeout(() => {\r\n    next();\r\n  }, randomDelay);\r\n};\r\n\r\n// \uD83D\uDEE1\uFE0F RATE LIMITING AVANC\u00C9 AVEC WHITELIST\r\n// Limiteur sp\u00E9cifique pour les endpoints d'authentification (permet plus de tentatives sans bloquer d'autres routes)\r\nexport const authRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000,\r\n  max: 20, // 20 tentatives de login / registre / reset par IP / 15min\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  trustProxy: 1, // Sp\u00E9cifique pour Cloud Run\r\n  message: { error: 'Trop de tentatives d\\'authentification, r\u00E9essayez plus tard.' },\r\n  keyGenerator: (req: Request) => {\r\n    const ipKey = ipKeyGenerator(req.ip ?? '');\r\n    const identifier = (req.body && (req.body.email || req.body.username)) || 'anon';\r\n    return `${ipKey}|${identifier}`;\r\n  },\r\n  handler: (req: Request, res: Response) => {\r\n    securityMetrics.blockedRequests++;\r\n    logSecurityEvent('AUTH_RATE_LIMIT', { ip: req.ip, url: req.url, bodyKeys: Object.keys(req.body || {}) }, 'warn');\r\n    res.status(429).json({ error: 'Trop de tentatives', retryAfter: 900 });\r\n  }\r\n});\r\n\r\n// Limiteur g\u00E9n\u00E9ral API (exclut explicitement static et OPTIONS, plus plafond \u00E9lev\u00E9)\r\nexport const advancedRateLimit = rateLimit({\r\n  windowMs: 15 * 60 * 1000,\r\n  trustProxy: 1, // Sp\u00E9cifique pour Cloud Run\r\n  max: (req: Request) => {\r\n    // OPTIONS jamais compt\u00E9 (CORS preflight)\r\n    if (req.method === 'OPTIONS') return 10_000;\r\n\r\n    // Exclusions static\r\n    if (\r\n      req.path.startsWith('/assets/') ||\r\n      req.path === '/manifest.webmanifest' ||\r\n      req.path === '/registerSW.js' ||\r\n      req.path === '/sw.js'\r\n    ) return 10_000;\r\n\r\n    const trustedIPs = ['127.0.0.1', '::1', 'localhost'];\r\n    if (trustedIPs.includes(req.ip)) return 10_000;\r\n\r\n    return 1000; // plafond g\u00E9n\u00E9ral relev\u00E9\r\n  },\r\n  skip: (req: Request) => {\r\n    return (\r\n      req.method === 'OPTIONS' ||\r\n      req.path.startsWith('/assets/') ||\r\n      req.path === '/manifest.webmanifest' ||\r\n      req.path === '/registerSW.js' ||\r\n      req.path === '/sw.js'\r\n    );\r\n  },\r\n  standardHeaders: true,\r\n  legacyHeaders: false,\r\n  message: { error: 'Trop de requ\u00EAtes, veuillez r\u00E9essayer plus tard', retryAfter: '15 minutes' },\r\n  handler: (req: Request, res: Response) => {\r\n    securityMetrics.blockedRequests++;\r\n    logSecurityEvent('API_RATE_LIMIT', { ip: req.ip, url: req.url, method: req.method }, 'warn');\r\n    res.status(429).json({ error: 'Trop de requ\u00EAtes', retryAfter: 900 });\r\n  }\r\n});\r\n\r\n// \uD83D\uDEE1\uFE0F D\u00C9TECTION D'ANOMALIES COMPORTEMENTALES\r\nconst requestHistory = new Map<string, Array<{ timestamp: number; endpoint: string }>>();\r\n\r\nexport const anomalyDetection = (req: Request, res: Response, next: NextFunction) => {\r\n  const clientIP = req.ip;\r\n  const currentTime = Date.now();\r\n  const endpoint = req.path;\r\n  \r\n  if (!requestHistory.has(clientIP)) {\r\n    requestHistory.set(clientIP, []);\r\n  }\r\n  \r\n  const history = requestHistory.get(clientIP)!;\r\n  \r\n  // Nettoyer l'historique (garder seulement les 10 derni\u00E8res minutes)\r\n  const tenMinutesAgo = currentTime - (10 * 60 * 1000);\r\n  const recentHistory = history.filter(req => req.timestamp > tenMinutesAgo);\r\n  \r\n  // Ajouter la requ\u00EAte actuelle\r\n  recentHistory.push({ timestamp: currentTime, endpoint });\r\n  requestHistory.set(clientIP, recentHistory);\r\n  \r\n  // D\u00E9tecter les anomalies\r\n  const requestsInLastMinute = recentHistory.filter(req => \r\n    req.timestamp > currentTime - 60000\r\n  ).length;\r\n  \r\n  const uniqueEndpoints = new Set(recentHistory.map(req => req.endpoint)).size;\r\n  const totalRequests = recentHistory.length;\r\n  \r\n  // Anomalie 1: Trop de requ\u00EAtes en peu de temps (seuil \u00E9lev\u00E9 pour le d\u00E9veloppement)\r\n  if (requestsInLastMinute > 200) {\r\n    logSecurityEvent('ANOMALY_HIGH_FREQUENCY', {\r\n      ip: clientIP,\r\n      requestsPerMinute: requestsInLastMinute,\r\n      userAgent: req.headers['user-agent']\r\n    }, 'warn');\r\n  }\r\n  \r\n  // Anomalie 2: Scanning de endpoints (beaucoup d'endpoints diff\u00E9rents)\r\n  if (uniqueEndpoints > 20 && totalRequests > 50) {\r\n    logSecurityEvent('ANOMALY_ENDPOINT_SCANNING', {\r\n      ip: clientIP,\r\n      uniqueEndpoints,\r\n      totalRequests,\r\n      endpoints: Array.from(new Set(recentHistory.map(r => r.endpoint)))\r\n    }, 'warn');\r\n  }\r\n  \r\n  next();\r\n};\r\n\r\n// \uD83D\uDEE1\uFE0F SANITISATION DES ENTR\u00C9ES - VERSION CORRIG\u00C9E\r\nexport const inputSanitization = (req: Request, res: Response, next: NextFunction) => {\r\n  // Sanitiser r\u00E9cursivement les objets\r\n  const sanitizeObject = (obj: any): any => {\r\n    if (typeof obj !== 'object' || obj === null) {\r\n      if (typeof obj === 'string') {\r\n        // Nettoyer les caract\u00E8res dangereux\r\n        return obj\r\n          .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '') // Scripts\r\n          .replace(/javascript:/gi, '') // Protocole javascript\r\n          .replace(/on\\w+\\s*=/gi, '') // Event handlers\r\n          .trim();\r\n      }\r\n      return obj;\r\n    }\r\n    \r\n    if (Array.isArray(obj)) {\r\n      return obj.map(sanitizeObject);\r\n    }\r\n    \r\n    const sanitized: any = {};\r\n    for (const [key, value] of Object.entries(obj)) {\r\n      sanitized[key] = sanitizeObject(value);\r\n    }\r\n    return sanitized;\r\n  };\r\n  \r\n  // Sanitiser body uniquement (query et params sont en lecture seule)\r\n  if (req.body && typeof req.body === 'object') {\r\n    try {\r\n      req.body = sanitizeObject(req.body);\r\n    } catch (e) {\r\n      console.warn('Cannot sanitize req.body:', e);\r\n    }\r\n  }\r\n  \r\n  next();\r\n};\r\n\r\n// \uD83D\uDEE1\uFE0F D\u00C9TECTION D'INJECTION SQL BASIQUE\r\nexport const sqlInjectionDetection = (req: Request, res: Response, next: NextFunction) => {\r\n  const sqlPatterns = [\r\n    /(\\%27)|(\\')|(\\-\\-)|(\\%23)|(#)/i,\r\n    /((\\%3D)|(=))[^\\n]*((\\%27)|(\\')|(\\-\\-)|(\\%3B)|(;))/i,\r\n    /\\w*((\\%27)|(\\'))((\\%6F)|o|(\\%4F))((\\%72)|r|(\\%52))/i,\r\n    /((\\%27)|(\\'))union/i,\r\n    /exec(\\s|\\+)+(s|x)p\\w+/i\r\n  ];\r\n  \r\n  const checkForSQLInjection = (data: any): boolean => {\r\n    if (typeof data === 'string') {\r\n      return sqlPatterns.some(pattern => pattern.test(data));\r\n    }\r\n    if (typeof data === 'object' && data !== null) {\r\n      return Object.values(data).some(checkForSQLInjection);\r\n    }\r\n    return false;\r\n  };\r\n  \r\n  const requestData = { \r\n    ...req.query, \r\n    ...req.body, \r\n    ...req.params,\r\n    url: req.url \r\n  };\r\n  \r\n  if (checkForSQLInjection(requestData)) {\r\n    logSecurityEvent('SQL_INJECTION_ATTEMPT', {\r\n      ip: req.ip,\r\n      method: req.method,\r\n      url: req.url,\r\n      userAgent: req.headers['user-agent'],\r\n      suspiciousData: requestData\r\n    }, 'error');\r\n    \r\n    return res.status(400).json({\r\n      error: 'Requ\u00EAte invalide d\u00E9tect\u00E9e'\r\n    });\r\n  }\r\n  \r\n  next();\r\n};", "/**\r\n * \uD83D\uDD04 HOOK DE SYNCHRONISATION AUTOMATIQUE\r\n * \r\n * Synchronise TreeBranchLeafNodeVariable.sourceRef avec data_instances.metadata.sourceRef\r\n * \r\n * Se lance automatiquement au d\u00E9marrage du serveur\r\n * Corrige les d\u00E9synchronisations sans casser ce qui fonctionne d\u00E9j\u00E0\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ninterface DataInstanceMetadata {\r\n  sourceRef?: string;\r\n  sourceType?: string;\r\n  [key: string]: unknown;\r\n}\r\n\r\ninterface DataInstance {\r\n  id: string;\r\n  metadata?: DataInstanceMetadata;\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport async function syncVariableSourceRefs() {\r\n  try {\r\n    console.log('\\n\uD83D\uDD04 [SYNC HOOK] Synchronisation des sourceRef...');\r\n\r\n    // R\u00E9cup\u00E9rer tous les nodes avec data_instances\r\n    const nodes = await prisma.treeBranchLeafNode.findMany({\r\n      where: {\r\n        data_instances: { not: null }\r\n      },\r\n      include: {\r\n        TreeBranchLeafNodeVariable: true\r\n      }\r\n    });\r\n\r\n    let syncCount = 0;\r\n    let skipCount = 0;\r\n\r\n    for (const node of nodes) {\r\n      if (!node.data_instances) continue;\r\n\r\n      const dataInstances = node.data_instances as Record<string, DataInstance>;\r\n      const firstInstanceKey = Object.keys(dataInstances)[0];\r\n      if (!firstInstanceKey) continue;\r\n\r\n      const firstInstance = dataInstances[firstInstanceKey];\r\n      if (!firstInstance?.metadata?.sourceRef) continue;\r\n\r\n      const jsonSourceRef = firstInstance.metadata.sourceRef;\r\n\r\n      // Si pas de variable en DB, skip (sera cr\u00E9\u00E9e plus tard)\r\n      if (!node.TreeBranchLeafNodeVariable) {\r\n        continue;\r\n      }\r\n\r\n      const dbSourceRef = node.TreeBranchLeafNodeVariable.sourceRef;\r\n\r\n      // \u26A0\uFE0F PROTECTION: Ne pas \u00E9craser les r\u00E9f\u00E9rences @table. et @value.\r\n      if (dbSourceRef && (dbSourceRef.startsWith('@table.') || dbSourceRef.startsWith('@value.'))) {\r\n        // V\u00E9rifier que le JSON ne dit pas autre chose\r\n        if (jsonSourceRef.startsWith('node-formula:')) {\r\n          // Le JSON dit formula mais la DB dit table/value\r\n          // C'est probablement une erreur de sync pr\u00E9c\u00E9dente\r\n          // On GARDE la DB (table/value) car c'est ce qui fonctionne\r\n          skipCount++;\r\n          continue;\r\n        }\r\n      }\r\n\r\n      // Si d\u00E9j\u00E0 synchronis\u00E9, skip\r\n      if (jsonSourceRef === dbSourceRef) {\r\n        continue;\r\n      }\r\n\r\n      // \u2705 SYNCHRONISER\r\n      await prisma.treeBranchLeafNodeVariable.update({\r\n        where: { id: node.TreeBranchLeafNodeVariable.id },\r\n        data: { sourceRef: jsonSourceRef }\r\n      });\r\n\r\n      syncCount++;\r\n    }\r\n\r\n    if (syncCount > 0) {\r\n      console.log(`\u2705 [SYNC HOOK] ${syncCount} sourceRef synchronis\u00E9(s)`);\r\n    }\r\n    if (skipCount > 0) {\r\n      console.log(`\u26A0\uFE0F  [SYNC HOOK] ${skipCount} table/value prot\u00E9g\u00E9(s)`);\r\n    }\r\n    if (syncCount === 0 && skipCount === 0) {\r\n      console.log(`\u2705 [SYNC HOOK] Tout est d\u00E9j\u00E0 synchronis\u00E9`);\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('\u274C [SYNC HOOK] Erreur:', error);\r\n    // Ne pas crasher le serveur si le hook \u00E9choue\r\n  }\r\n}\r\n\r\n/**\r\n * \uD83C\uDFAF Hook \u00E0 appeler au d\u00E9marrage du serveur\r\n */\r\nexport async function initializeTreeBranchLeafSync() {\r\n  try {\r\n    await syncVariableSourceRefs();\r\n  } catch (error) {\r\n    console.error('\u274C [INIT SYNC] Erreur:', error);\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["import_client", "prisma", "import_client", "import_events", "prisma", "RealTimeEmailNotificationService", "import_client", "import_events", "prisma", "imapSimple", "body", "prisma", "tokens", "rowLabel", "colSelectorValue", "colLabel", "normalizedColSelector", "colSelectorInCols", "colSelectorInRows", "dataRowIndex", "dataColIndex", "result", "humanText", "rowSelectorValue", "normalizedRowSelector", "rowSelectorInRows", "rowSelectorInCols", "import_express", "import_path", "import_fs", "import_express", "fs", "req", "bcrypt", "isSuperAdmin", "jwt", "import_express", "import_jsonwebtoken", "import_client", "prisma", "import_fs", "fs", "JWT_SECRET", "API_URL", "JWT_SECRET", "req", "jwt", "req", "import_client", "key", "prisma", "tokens", "credentials", "tokens", "import_googleapis", "import_googleapis", "PrismaClient", "prisma", "body", "req", "attachments", "body", "action", "express", "import_express", "import_client", "import_bcryptjs", "import_jsonwebtoken", "import_jsonwebtoken", "import_client", "prisma", "req", "jwt", "JWT_SECRET", "req", "import_client", "prisma", "req", "router", "prisma", "req", "bcrypt", "isSuperAdmin", "jwt", "JWT_SECRET", "userOrg", "import_express", "import_client", "import_fs", "prisma", "router", "req", "multer", "fs", "path", "import_express", "import_client", "prisma", "router", "key", "req", "import_express", "requireRole", "req", "router", "req", "isSuperAdmin", "module", "requireRole", "randomUUID", "import_express", "import_client", "prisma", "router", "req", "requireRole", "import_express", "router", "req", "import_express", "import_client", "import_bcryptjs", "body", "prisma", "router", "requireRole", "req", "uuidv4", "bcrypt", "import_express", "import_client", "import_zod", "import_crypto", "router", "prisma", "sanitized", "module", "action", "rateLimit", "router", "req", "prisma", "requireRole", "module", "import_express", "router", "req", "isSuperAdmin", "key", "payload", "import_express", "import_googleapis", "import_googleapis", "import_express", "import_fs", "import_path", "req", "formidable", "path", "fs", "key", "router", "import_path", "winston", "sanitized", "DailyRotateFile", "path", "key", "router", "module", "req", "tokens", "error", "googleToken", "import_express", "router", "requireRole", "req", "tokens", "import_express", "router", "requireRole", "req", "import_express", "import_client", "import_zod", "router", "prisma", "requireRole", "req", "validationResult", "import_express", "import_client", "import_uuid", "router", "prisma", "req", "requireRole", "uuidv4", "import_express", "import_client", "prisma", "router", "req", "notifications", "autoMailSync", "import_express", "router", "req", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "router", "prisma", "req", "isSuperAdmin", "formattedLeads", "body", "import_express", "import_client", "import_zod", "import_express_rate_limit", "router", "prisma", "sanitizeString", "rateLimit", "handleZodError", "req", "import_express", "import_client", "import_zod", "import_express_rate_limit", "router", "prisma", "sanitizeString", "rateLimit", "handleZodError", "requireRole", "req", "validationResult", "key", "import_express", "router", "req", "import_express", "import_express_rate_limit", "import_zod", "import_client", "prisma", "router", "express", "rateLimit", "req", "import_express", "import_client", "prisma", "router", "req", "import_express", "import_client", "prisma", "router", "express", "requireRole", "req", "import_express", "router", "req", "import_express", "import_client", "impersonationMiddleware", "req", "router", "req", "prisma", "impersonationMiddleware", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_googleapis", "import_client", "prisma", "tokens", "body", "router", "req", "body", "import_express", "router", "express", "req", "import_express", "import_express", "import_client", "import_zod", "router", "prisma", "req", "axios", "router", "impersonationMiddleware", "telnyx_default", "import_express", "import_client", "router", "prisma", "req", "import_express", "router", "req", "import_express", "router", "req", "import_express", "import_client", "import_express_rate_limit", "router", "prisma", "rateLimit", "requireRole", "req", "action", "import_express", "import_fs", "import_path", "import_client", "import_crypto", "prisma", "router", "express", "req", "path", "fs", "abs", "isSuper", "suggestions", "isSuperAdmin", "import_express", "import_fs", "import_path", "import_crypto", "router", "express", "req", "path", "fs", "crypto", "body", "import_express", "import_uuid", "import_client", "import_express", "import_client", "import_uuid", "prisma", "router", "req", "requireRole", "uuidv4", "import_express", "import_client", "import_uuid", "prisma", "router", "requireRole", "req", "action", "uuidv4", "import_express", "import_client", "prisma", "router", "express", "requireRole", "req", "router", "prisma", "requireRole", "req", "uuidv4", "counts", "import_express", "import_client", "op", "key", "router", "express", "prisma", "req", "formulas_default", "import_express", "import_client", "router", "express", "prisma", "req", "action", "dependencies_default", "import_express", "import_client", "prisma", "router", "req", "import_express", "router", "req", "isSuperAdmin", "module", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "router", "prisma", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "prisma", "inputData", "relatedFieldsData", "router", "express", "req", "inputData", "relatedFieldsData", "import_express", "import_client", "action", "router", "express", "req", "import_express", "import_client", "router", "express", "prisma", "req", "isSuperAdmin", "import_express", "tokens", "dt", "tokens", "import_client", "import_crypto", "tokens", "prisma", "key", "prisma", "addToNodeLinkedField", "prisma", "addToNodeLinkedField", "prisma", "displayNodeId", "key", "addToNodeLinkedField", "now", "prisma", "import_express", "import_client", "import_crypto", "router", "prisma", "req", "isSuperAdmin", "node", "updatedTable", "router", "prisma", "getAuthCtx", "req", "isSuperAdmin", "parseSourceRef", "tokens", "extractNodeIdsFromConditionSet", "addToNodeLinkedField", "prisma", "router", "req", "isSuperAdmin", "getAuthCtx", "prisma", "tokens", "idMap", "formulaIdMap", "queue", "source", "key", "hasSuffixRegex", "addToNodeLinkedField", "extractNodeIdsFromConditionSet", "validationResult", "randomUUID", "updatedNode", "responseData", "sourceRef", "metadata", "parseSourceRef", "evaluateVariableOperation", "prisma", "router", "req", "isSuperAdmin", "getAuthCtx", "items", "key", "nodeId", "tokens", "orchestrated", "fieldValues", "classified", "resolvedVariables", "evaluateTokens", "result", "id", "parsed", "parseSourceRef", "extractNodeIdsFromConditionSet", "setObj", "allRows", "evaluateVariableOperation", "res", "variableId", "addToNodeLinkedField", "router", "import_express", "import_client", "router", "express", "prisma", "getAuthCtx", "req", "isSuperAdmin", "import_express", "import_client", "tokens", "key", "router", "express", "req", "PrismaClient", "prisma", "evaluationEngine", "import_express", "import_client", "prisma", "router", "express", "tokens", "req", "import_express", "import_client", "import_express_rate_limit", "router", "prisma", "rateLimit", "requireRole", "req", "key", "import_express", "import_client", "import_express_rate_limit", "router", "prisma", "rateLimit", "requireRole", "req", "import_express", "import_client", "import_express_rate_limit", "router", "prisma", "rateLimit", "requireRole", "req", "import_express", "import_express_rate_limit", "import_zod", "router", "rateLimit", "sanitized", "req", "requireRole", "import_express", "import_client", "import_express_rate_limit", "router", "prisma", "rateLimit", "isJsonObject", "req", "requireRole", "key", "import_express", "import_client", "import_express_rate_limit", "router", "prisma", "rateLimit", "requireRole", "req", "import_express", "import_express_rate_limit", "import_client", "router", "prisma", "rateLimit", "requireRole", "req", "action", "import_express", "import_crypto", "import_express_rate_limit", "import_client", "router", "prisma", "rateLimit", "requireRole", "req", "google", "import_express", "import_client", "import_axios", "import_googleapis", "import_crypto", "import_meta", "prisma", "router", "key", "sanitized", "req", "tokens", "axios", "import_express", "import_express_rate_limit", "import_client", "router", "prisma", "geminiService", "req", "telnyx_default", "formulas_default", "dependencies_default", "import_express", "import_client", "router", "prisma", "key", "normalize", "req", "saved", "stats", "import_express", "router", "req", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "router", "prisma", "req", "key", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_client", "router", "express", "prisma", "req", "key", "import_express", "router", "req", "import_express", "import_client", "router", "prisma", "req", "import_express", "import_multer", "import_path", "import_client", "router", "prisma", "storage", "multer", "req", "path", "fs", "upload", "import_express", "router", "req", "import_express", "import_generative_ai", "router", "express", "req", "ai_default", "import_express", "router", "express", "geminiService", "req", "import_client", "req", "prisma", "req", "import_express_rate_limit", "import_crypto", "req", "crypto", "rateLimit", "sanitized", "key", "import_client", "prisma", "dotenv", "express", "req", "expressWinston", "helmet", "compression", "cors", "cookieParser", "session", "path", "passport", "ai_default", "fs"]
}
