generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Configuration de l'objet de r√©f√©rence pour mesures IA par organisation
model OrganizationMeasurementReferenceConfig {
  id                String   @id @default(cuid())
  organizationId    String
  referenceType     String // 'meter', 'card', 'a4', 'custom'
  customName        String?
  customSize        Float // Taille en unit√© sp√©cifi√©e
  customUnit        String   @default("cm") // 'cm', 'm', 'mm', 'inch'
  customWidth       Float? // Largeur pour r√©f√©rences rectangulaires
  customHeight      Float? // Hauteur pour r√©f√©rences rectangulaires
  referenceImageUrl String? // Photo de r√©f√©rence
  detectionPrompt   String? // Prompt personnalis√© pour d√©tection
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String

  Organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  User         User         @relation("MeasurementConfigCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([createdBy])
}

model AIRecommendation {
  id             String       @id
  leadId         String
  organizationId String
  startTime      DateTime
  endTime        DateTime
  title          String
  description    String?
  confidence     Float        @default(0.8)
  type           String       @default("ai_slot")
  status         String       @default("active")
  data           Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Lead           Lead         @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([leadId])
  @@index([leadId, status, startTime])
  @@index([organizationId])
  @@index([startTime])
  @@index([status])
}

model AdCampaign {
  id                    String                @id
  organizationId        String
  platformIntegrationId String
  externalId            String?
  name                  String
  description           String?
  status                String                @default("draft")
  budget                Decimal               @default(0) @db.Decimal(10, 2)
  spent                 Decimal               @default(0) @db.Decimal(10, 2)
  leads                 Int                   @default(0)
  costPerLead           Decimal               @default(0) @db.Decimal(10, 2)
  roi                   Decimal               @default(0) @db.Decimal(5, 2)
  targetingData         Json                  @default("{}")
  creativeData          Json                  @default("{}")
  startDate             DateTime?
  endDate               DateTime?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime
  Organization          Organization          @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  AdPlatformIntegration AdPlatformIntegration @relation(fields: [platformIntegrationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  AdMetrics             AdMetrics[]

  @@index([organizationId])
  @@index([platformIntegrationId])
  @@index([status])
}

model AdMetrics {
  id           String     @id
  campaignId   String
  date         DateTime   @db.Date
  impressions  Int        @default(0)
  clicks       Int        @default(0)
  conversions  Int        @default(0)
  spend        Decimal    @default(0) @db.Decimal(10, 2)
  ctr          Decimal    @default(0) @db.Decimal(5, 4)
  cvr          Decimal    @default(0) @db.Decimal(5, 4)
  cpc          Decimal    @default(0) @db.Decimal(10, 2)
  cpl          Decimal    @default(0) @db.Decimal(10, 2)
  qualityScore Decimal?   @db.Decimal(3, 1)
  createdAt    DateTime   @default(now())
  AdCampaign   AdCampaign @relation(fields: [campaignId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([campaignId, date])
  @@index([campaignId])
  @@index([date])
}

model AdPlatformIntegration {
  id             String       @id
  organizationId String
  platform       String
  name           String
  config         Json         @default("{}")
  credentials    Json         @default("{}")
  status         String       @default("disconnected")
  lastSync       DateTime?
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  AdCampaign     AdCampaign[]
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
  @@index([platform])
  @@index([status])
}

model AiUsageLog {
  id             String   @id
  userId         String?
  organizationId String?
  type           String
  model          String?
  tokensPrompt   Int?     @default(0)
  tokensOutput   Int?     @default(0)
  latencyMs      Int?
  success        Boolean? @default(true)
  errorCode      String?
  errorMessage   String?
  meta           Json?
  createdAt      DateTime @default(now()) @db.Timestamp(6)

  @@index([createdAt])
  @@index([organizationId], map: "AiUsageLog_orgId_idx")
  @@index([type])
  @@index([userId])
}

model AnalyticsEvent {
  id             String       @id
  organizationId String
  eventType      String
  source         String
  sourceId       String
  data           Json         @default("{}")
  value          Decimal?     @db.Decimal(10, 2)
  timestamp      DateTime     @default(now())
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([eventType])
  @@index([organizationId])
  @@index([source])
  @@index([timestamp])
}

model AutomationRule {
  id             String        @id
  organizationId String?
  event          String
  action         String
  params         Json?
  active         Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Block {
  id             String           @id
  name           String
  organizationId String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  FormSubmission FormSubmission[]
  Section        Section[]
}

model CalendarEvent {
  id                  String                @id
  title               String
  description         String?
  startDate           DateTime
  endDate             DateTime?
  allDay              Boolean               @default(false)
  type                String
  status              String?
  notes               String?
  location            String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  organizationId      String?
  ownerId             String?
  linkedEmailId       String?
  linkedLeadId        String?
  linkedClientId      String?
  linkedProjectId     String?
  externalCalendarId  String?
  Organization        Organization?         @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User                User?                 @relation(fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  CalendarParticipant CalendarParticipant[]
}

model CalendarParticipant {
  id            String        @id
  eventId       String
  userId        String?
  clientId      String?
  role          String
  Lead          Lead?         @relation(fields: [clientId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  CalendarEvent CalendarEvent @relation(fields: [eventId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User          User?         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model CallStatus {
  id                String              @id
  organizationId    String
  name              String
  description       String?
  color             String              @default("#6b7280")
  icon              String?
  order             Int                 @default(0)
  isActive          Boolean             @default(true)
  isDefault         Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  Organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  CallToLeadMapping CallToLeadMapping[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, order])
}

model CallToLeadMapping {
  id             String       @id
  organizationId String
  callStatusId   String
  leadStatusId   String
  condition      String       @default("automatic")
  priority       Int          @default(1)
  description    String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  CallStatus     CallStatus   @relation(fields: [callStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  LeadStatus     LeadStatus   @relation(fields: [leadStatusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, callStatusId, leadStatusId])
  @@index([callStatusId])
  @@index([leadStatusId])
  @@index([organizationId])
  @@index([priority])
}

model Category {
  id                  String        @id
  name                String
  description         String?
  icon                String?
  iconColor           String?
  order               Int           @default(0)
  active              Boolean       @default(true)
  superAdminOnly      Boolean       @default(false)
  allowedRoles        String[]      @default([])
  requiredPermissions String[]      @default([])
  organizationId      String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime
  Organization        Organization? @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Module              Module[]

  @@index([active])
  @@index([organizationId])
}

model DeletedEmail {
  id        String   @id
  userId    String
  uid       String?
  messageId String?
  folder    String
  deletedAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, uid, folder])
  @@index([messageId])
  @@index([userId, folder])
}

model DocumentSection {
  id                String           @id
  templateId        String
  order             Int
  type              SectionType
  config            Json             @default("{}")
  displayConditions Json?
  linkedNodeIds     String[]         @default([])
  linkedVariables   String[]         @default([])
  translations      Json             @default("{}")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime
  DocumentTemplate  DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([order])
  @@index([templateId])
}

model DocumentTemplate {
  id                 String              @id
  name               String
  type               DocumentType
  description        String?
  organizationId     String
  translations       Json                @default("{}")
  defaultLanguage    String              @default("fr")
  themeId            String?
  isActive           Boolean             @default(true)
  isAdminOnly        Boolean             @default(true)
  createdBy          String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  treeId             String?
  DocumentSection    DocumentSection[]
  User               User?               @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  DocumentTheme      DocumentTheme?      @relation(fields: [themeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  TreeBranchLeafTree TreeBranchLeafTree? @relation(fields: [treeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  GeneratedDocument  GeneratedDocument[]

  @@index([isActive])
  @@index([organizationId])
  @@index([treeId])
  @@index([type])
}

model DocumentTheme {
  id               String             @id
  name             String
  organizationId   String
  primaryColor     String             @default("#1890ff")
  secondaryColor   String             @default("#52c41a")
  accentColor      String?
  textColor        String             @default("#000000")
  backgroundColor  String             @default("#ffffff")
  fontFamily       String             @default("Arial, sans-serif")
  fontSize         Int                @default(12)
  logoUrl          String?
  headerImageUrl   String?
  footerImageUrl   String?
  headerTemplate   Json               @default("{}")
  footerTemplate   Json               @default("{}")
  customStyles     Json?
  isDefault        Boolean            @default(false)
  isActive         Boolean            @default(true)
  isPublic         Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @default(now())
  DocumentTemplate DocumentTemplate[]
  Organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([isActive])
  @@index([isDefault])
  @@index([organizationId])
}

model EcommerceIntegration {
  id             String       @id
  organizationId String
  platform       String
  name           String
  url            String
  config         Json         @default("{}")
  credentials    Json         @default("{}")
  status         String       @default("disconnected")
  lastSync       DateTime?
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Order          Order[]
  Product        Product[]

  @@index([organizationId])
  @@index([platform])
  @@index([status])
}

model Email {
  id          String   @id
  userId      String
  from        String
  to          String
  subject     String
  isRead      Boolean  @default(false)
  folder      String   @default("inbox")
  contentType String   @default("text/plain")
  uid         String?
  createdAt   DateTime @default(now())
  body        String
  isStarred   Boolean  @default(false)
  User        User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model EmailAccount {
  id                String       @id
  emailAddress      String       @unique
  encryptedPassword String
  userId            String       @unique
  organizationId    String
  mailProvider      String       @default("gmail") // "gmail" | "yandex" ‚Äî Fournisseur de messagerie utilis√© par cet utilisateur
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  Organization      Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User              User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
  @@index([userId])
}

model EmailDomain {
  id             String       @id
  domain         String       @unique
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
}

model EmailTemplate {
  id             String       @id
  organizationId String
  name           String
  subject        String?
  content        String
  type           String       @default("general")
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([type])
}

model Field {
  id                                                 String            @id
  label                                              String
  type                                               String
  width                                              String?
  required                                           Boolean           @default(false)
  isProtected                                        Boolean           @default(false)
  sectionId                                          String
  order                                              Int
  advancedConfig                                     Json?
  Section                                            Section           @relation(fields: [sectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  FieldCondition                                     FieldCondition[]
  FieldDependency_FieldDependency_dependsOnIdToField FieldDependency[] @relation("FieldDependency_dependsOnIdToField")
  FieldDependency_FieldDependency_fieldIdToField     FieldDependency[] @relation("FieldDependency_fieldIdToField")
  FieldFormula                                       FieldFormula[]
  FieldModule                                        FieldModule[]
  FieldOption                                        FieldOption[]
  FieldOptionNode                                    FieldOptionNode[]
  FieldValidation                                    FieldValidation[]
}

model FieldCondition {
  id         String @id
  fieldId    String
  type       String
  expression String
  Field      Field  @relation(fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model FieldDependency {
  id                                       String  @id
  fieldId                                  String
  dependsOnId                              String
  condition                                String
  value                                    String?
  title                                    String?
  description                              String?
  order                                    Int?
  params                                   Json?
  name                                     String?
  sequence                                 Json?
  Field_FieldDependency_dependsOnIdToField Field   @relation("FieldDependency_dependsOnIdToField", fields: [dependsOnId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Field_FieldDependency_fieldIdToField     Field   @relation("FieldDependency_fieldIdToField", fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model FieldFormula {
  id          String  @id
  fieldId     String
  formula     String?
  title       String?
  description String?
  order       Int?
  name        String?
  sequence    Json    @default("[]")
  Field       Field   @relation(fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model FieldModule {
  id         String @id
  fieldId    String
  moduleType String
  config     Json
  Field      Field  @relation(fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model FieldOption {
  id            String          @id
  label         String
  value         String
  fieldId       String
  order         Int
  Field         Field           @relation(fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  FieldSubField FieldSubField[]
}

model FieldOptionNode {
  id                    String            @id
  label                 String
  value                 String?
  parentId              String?
  fieldId               String
  order                 Int               @default(0)
  data                  Json?
  type                  String            @default("option")
  active                Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime
  Field                 Field             @relation(fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  FieldOptionNode       FieldOptionNode?  @relation("FieldOptionNodeToFieldOptionNode", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_FieldOptionNode FieldOptionNode[] @relation("FieldOptionNodeToFieldOptionNode")

  @@index([fieldId])
  @@index([fieldId, parentId])
  @@index([order])
  @@index([parentId])
}

model FieldSubField {
  id                  String                @id
  label               String
  type                String
  optionId            String
  order               Int
  FieldOption         FieldOption           @relation(fields: [optionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  FieldSubFieldOption FieldSubFieldOption[]
}

model FieldSubFieldOption {
  id            String        @id
  label         String
  subFieldId    String
  order         Int
  FieldSubField FieldSubField @relation(fields: [subFieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model FieldType {
  id            String   @id
  name          String   @unique
  label         String
  has_options   Boolean  @default(false)
  has_subfields Boolean  @default(false)
  config        Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

model FieldValidation {
  id                String  @id
  fieldId           String
  type              String
  comparisonFieldId String?
  comparisonType    String  @default("static")
  message           String  @default("Ce champ n'est pas valide.")
  value             String?
  Field             Field   @relation(fields: [fieldId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([fieldId])
}

model FormSubmission {
  id        String   @id
  blockId   String
  userId    String?
  data      Json
  createdAt DateTime @default(now())
  Block     Block    @relation(fields: [blockId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User      User?    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model GeneratedDocument {
  id                                     String                    @id
  submissionId                           String?
  leadId                                 String?
  templateId                             String
  organizationId                         String
  type                                   DocumentType
  language                               String                    @default("fr")
  pdfUrl                                 String?
  pdfFilename                            String?
  status                                 DocumentStatus            @default(DRAFT)
  dataSnapshot                           Json?
  clientAccessToken                      String?                   @unique
  clientViewedAt                         DateTime?
  signedAt                               DateTime?
  signatureUrl                           String?
  signedBy                               String?
  paidAt                                 DateTime?
  paymentAmount                          Decimal?                  @db.Decimal(10, 2)
  paymentMethod                          String?
  paymentReference                       String?
  sentAt                                 DateTime?
  sentTo                                 String?
  sentBy                                 String?
  documentNumber                         String?                   @unique
  title                                  String?
  notes                                  String?
  createdBy                              String?
  createdAt                              DateTime                  @default(now())
  updatedAt                              DateTime
  User_GeneratedDocument_createdByToUser User?                     @relation("GeneratedDocument_createdByToUser", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Lead                                   Lead?                     @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization                           Organization              @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User_GeneratedDocument_sentByToUser    User?                     @relation("GeneratedDocument_sentByToUser", fields: [sentBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  TreeBranchLeafSubmission               TreeBranchLeafSubmission? @relation(fields: [submissionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  DocumentTemplate                       DocumentTemplate          @relation(fields: [templateId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([clientAccessToken])
  @@index([createdAt])
  @@index([documentNumber])
  @@index([leadId])
  @@index([organizationId])
  @@index([status])
  @@index([submissionId])
  @@index([templateId])
  @@index([type])
}

model GoogleMailWatch {
  id             String       @id
  userId         String       @unique
  organizationId String
  historyId      String?
  expiration     DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
  @@index([userId])
}

model GoogleToken {
  id             String       @id
  accessToken    String
  refreshToken   String?
  tokenType      String       @default("Bearer")
  expiresAt      DateTime?
  scope          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  organizationId String
  userId         String // Chaque utilisateur a son propre token
  googleEmail    String? // Email du compte Google connect√©
  lastRefreshAt  DateTime?
  refreshCount   Int          @default(0)
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, organizationId])
}

model GoogleTokenRefreshHistory {
  id             String       @id @default(cuid())
  organizationId String
  refreshedAt    DateTime     @default(now())
  success        Boolean
  message        String?
  errorDetails   String?
  oldExpiresAt   DateTime?
  newExpiresAt   DateTime?
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([refreshedAt])
}

model GoogleVoiceCall {
  id             String       @id
  organizationId String
  userId         String?
  fromNumber     String
  toNumber       String
  duration       Int
  callType       String
  status         String
  recordingUrl   String?
  transcription  String?
  startTime      DateTime
  endTime        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User?        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([fromNumber])
  @@index([organizationId])
  @@index([startTime])
  @@index([toNumber])
  @@index([userId])
}

model GoogleVoiceConfig {
  id                   String       @id
  organizationId       String       @unique
  encryptedPrivateKey  String
  encryptedClientEmail String
  domain               String
  delegatedUserEmail   String
  isActive             Boolean      @default(true)
  lastSync             DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime
  Organization         Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([isActive])
  @@index([organizationId])
}

model GoogleVoiceSMS {
  id             String       @id
  organizationId String
  userId         String?
  fromNumber     String
  toNumber       String
  message        String
  direction      String
  status         String
  timestamp      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User?        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([fromNumber])
  @@index([organizationId])
  @@index([timestamp])
  @@index([toNumber])
  @@index([userId])
}

model GoogleWorkspaceConfig {
  id                  String       @id
  clientId            String?
  clientSecret        String?
  domain              String?
  adminEmail          String?
  serviceAccountEmail String?
  privateKey          String?
  isActive            Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime
  calendarEnabled     Boolean      @default(false)
  docsEnabled         Boolean      @default(false)
  driveEnabled        Boolean      @default(false)
  enabled             Boolean      @default(false)
  gmailEnabled        Boolean      @default(false)
  meetEnabled         Boolean      @default(false)
  organizationId      String       @unique
  sheetsEnabled       Boolean      @default(false)
  voiceEnabled        Boolean      @default(false)
  redirectUri         String?
  Organization        Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([isActive])
  @@index([organizationId])
}

model GoogleWorkspaceUser {
  id              String    @id
  userId          String    @unique
  email           String    @unique
  isActive        Boolean   @default(true)
  gmailEnabled    Boolean   @default(false)
  calendarEnabled Boolean   @default(false)
  driveEnabled    Boolean   @default(false)
  meetEnabled     Boolean   @default(false)
  docsEnabled     Boolean   @default(false)
  sheetsEnabled   Boolean   @default(false)
  voiceEnabled    Boolean   @default(false)
  lastSync        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([email])
  @@index([isActive])
  @@index([userId])
}

model Icon {
  id          String   @id
  name        String   @unique
  category    String
  description String?
  tags        String[] @default([])
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([active])
  @@index([category])
  @@index([name])
}

model IntegrationsSettings {
  id             String       @id
  type           String
  config         Json?
  enabled        Boolean      @default(false)
  organizationId String
  userId         String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User?        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, type])
}

model Invitation {
  id                                 String           @id
  email                              String
  token                              String           @unique
  expiresAt                          DateTime
  organizationId                     String
  roleId                             String
  createdAt                          DateTime         @default(now())
  updatedAt                          DateTime
  status                             InvitationStatus @default(PENDING)
  invitedById                        String
  targetUserId                       String?
  createWorkspaceAccount             Boolean          @default(false)
  User_Invitation_invitedByIdToUser  User             @relation("Invitation_invitedByIdToUser", fields: [invitedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization                       Organization     @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Role                               Role             @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User_Invitation_targetUserIdToUser User?            @relation("Invitation_targetUserIdToUser", fields: [targetUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([email, organizationId])
  @@index([targetUserId])
}

model Lead {
  id                  String                @id
  organizationId      String
  assignedToId        String?
  status              String                @default("nouveau")
  data                Json?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  source              String?
  statusId            String?
  company             String?
  email               String?
  firstName           String?
  lastContactDate     DateTime?
  lastName            String?
  leadNumber          String?               @unique
  linkedin            String?
  nextFollowUpDate    DateTime?
  notes               String?
  phone               String?
  website             String?
  sourceId            String?
  AIRecommendation    AIRecommendation[]
  CalendarParticipant CalendarParticipant[]
  GeneratedDocument   GeneratedDocument[]
  User                User?                 @relation(fields: [assignedToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization        Organization          @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  LeadSource          LeadSource?           @relation(fields: [sourceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  LeadStatus          LeadStatus?           @relation(fields: [statusId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Quote               Quote[]
  TechnicalData       TechnicalData[]
  TelnyxCall          TelnyxCall[]
  TelnyxMessage       TelnyxMessage[]
  TimelineEvent       TimelineEvent[]

  @@index([email])
  @@index([firstName, lastName])
  @@index([organizationId, createdAt])
}

model LeadSource {
  id             String       @id
  organizationId String
  name           String
  description    String?
  color          String       @default("#6b7280")
  icon           String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Lead           Lead[]
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, name])
  @@index([organizationId])
}

model LeadStatus {
  id                String              @id
  organizationId    String
  name              String
  color             String
  order             Int                 @default(0)
  isDefault         Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  CallToLeadMapping CallToLeadMapping[]
  Lead              Lead[]
  Organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
  @@index([organizationId, order])
}

model Module {
  id                       String                     @id
  key                      String                     @unique
  label                    String
  feature                  String                     @unique
  icon                     String?
  route                    String?
  description              String?
  page                     String?
  order                    Int?
  active                   Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  organizationId           String?
  categoryId               String?
  superAdminOnly           Boolean                    @default(false)
  Category                 Category?                  @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization             Organization?              @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  OrganizationModuleStatus OrganizationModuleStatus[]
  Permission               Permission[]

  @@index([categoryId])
  @@index([organizationId])
}

model Notification {
  id             String             @id
  organizationId String
  type           NotificationType
  data           Json
  status         NotificationStatus @default(PENDING)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime
  userId         String?
  Organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User?              @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
  @@index([userId])
}

model Order {
  id                     String                @id
  organizationId         String
  ecommerceIntegrationId String?
  externalId             String?
  orderNumber            String
  customerName           String
  customerEmail          String
  customerPhone          String?
  billingAddress         Json                  @default("{}")
  shippingAddress        Json                  @default("{}")
  totalAmount            Decimal               @default(0) @db.Decimal(10, 2)
  currency               String                @default("EUR")
  status                 String                @default("pending")
  paymentStatus          String                @default("pending")
  items                  Json                  @default("[]")
  metadata               Json                  @default("{}")
  orderDate              DateTime              @default(now())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  EcommerceIntegration   EcommerceIntegration? @relation(fields: [ecommerceIntegrationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([customerEmail])
  @@index([orderDate])
  @@index([organizationId])
  @@index([paymentStatus])
  @@index([status])
}

model Organization {
  id                         String                                   @id
  name                       String                                   @unique
  createdAt                  DateTime                                 @default(now())
  updatedAt                  DateTime
  features                   String[]                                 @default([])
  status                     String                                   @default("active")
  address                    String?
  description                String?
  phone                      String?
  website                    String?
  AIRecommendation           AIRecommendation[]
  AdCampaign                 AdCampaign[]
  AdPlatformIntegration      AdPlatformIntegration[]
  AnalyticsEvent             AnalyticsEvent[]
  AutomationRule             AutomationRule[]
  Block                      Block[]
  CalendarEvent              CalendarEvent[]
  CallStatus                 CallStatus[]
  CallToLeadMapping          CallToLeadMapping[]
  Category                   Category[]
  DocumentTemplate           DocumentTemplate[]
  DocumentTheme              DocumentTheme[]
  EcommerceIntegration       EcommerceIntegration[]
  EmailAccount               EmailAccount[]
  EmailDomain                EmailDomain[]
  EmailTemplate              EmailTemplate[]
  GeneratedDocument          GeneratedDocument[]
  GoogleMailWatch            GoogleMailWatch[]
  GoogleToken                GoogleToken[]
  GoogleVoiceCall            GoogleVoiceCall[]
  GoogleVoiceConfig          GoogleVoiceConfig?
  GoogleVoiceSMS             GoogleVoiceSMS[]
  GoogleWorkspaceConfig      GoogleWorkspaceConfig?
  IntegrationsSettings       IntegrationsSettings[]
  Invitation                 Invitation[]
  Lead                       Lead[]
  LeadSource                 LeadSource[]
  LeadStatus                 LeadStatus[]
  Module                     Module[]
  Notification               Notification[]
  Order                      Order[]
  OrganizationModuleStatus   OrganizationModuleStatus[]
  OrganizationRoleStatus     OrganizationRoleStatus[]
  Permission                 Permission[]
  Product                    Product[]
  PublicForm                 PublicForm[]
  PublicFormSubmission       PublicFormSubmission[]
  Quote                      Quote[]
  Role                       Role[]
  TechnicalData              TechnicalData[]
  TelnyxCall                 TelnyxCall[]
  TelnyxConnection           TelnyxConnection[]
  TelnyxMessage              TelnyxMessage[]
  TelnyxPhoneNumber          TelnyxPhoneNumber[]
  TelnyxUserConfig           TelnyxUserConfig[]
  TelnyxConfig               TelnyxConfig? // üÜï Config API Telnyx
  TelnyxSipEndpoint          TelnyxSipEndpoint[] // üÜï Endpoints SIP
  TimelineEvent              TimelineEvent[]
  UserOrganization           UserOrganization[]
  UserFavoriteModule         UserFavoriteModule[]
  JoinRequest                JoinRequest[]
  contact_submissions        contact_submissions[]
  websites                   websites[]
  MeasurementReferenceConfig OrganizationMeasurementReferenceConfig[]
  GoogleTokenRefreshHistory  GoogleTokenRefreshHistory[]
  website_forms              website_forms[]
  ProductDocument            ProductDocument[]
  TreeOrganizationAccess     TreeOrganizationAccess[]
}

model OrganizationModuleStatus {
  id             String       @id
  organizationId String
  moduleId       String
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Module         Module       @relation(fields: [moduleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, moduleId])
}

model OrganizationRoleStatus {
  id             String       @id
  organizationId String
  roleId         String
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Role           Role         @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, roleId])
}

model Permission {
  id             String        @id
  roleId         String
  organizationId String?
  moduleId       String?
  action         String
  resource       String
  allowed        Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  Module         Module?       @relation(fields: [moduleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Role           Role          @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([roleId, organizationId, moduleId, action, resource])
}

model Product {
  id                     String                @id
  organizationId         String
  ecommerceIntegrationId String?
  externalId             String?
  name                   String
  description            String?
  category               String?
  price                  Decimal               @default(0) @db.Decimal(10, 2)
  currency               String                @default("EUR")
  stock                  Int?
  sku                    String?
  images                 Json                  @default("[]")
  metadata               Json                  @default("{}")
  status                 String                @default("active")
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  EcommerceIntegration   EcommerceIntegration? @relation(fields: [ecommerceIntegrationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([category])
  @@index([organizationId])
  @@index([sku])
  @@index([status])
}

model PublicForm {
  id                         String                 @id
  organizationId             String
  name                       String
  description                String?
  category                   String                 @default("contact")
  slug                       String
  fields                     Json
  thankYouMessage            String                 @default("Merci pour votre soumission !")
  redirectUrl                String?
  collectsRgpdConsent        Boolean                @default(true)
  autoPublishLeads           Boolean                @default(false)
  maxSubmissionsPerDay       Int?
  customCss                  String?
  campaigns                  String[]               @default([])
  submissionCount            Int                    @default(0)
  conversionRate             Float                  @default(0)
  lastSubmissionAt           DateTime?
  isActive                   Boolean                @default(true)
  isPublic                   Boolean                @default(true)
  requiresCommercialTracking Boolean                @default(false)
  deletedAt                  DateTime?
  createdAt                  DateTime               @default(now())
  updatedAt                  DateTime
  Organization               Organization           @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  PublicFormSubmission       PublicFormSubmission[]

  @@unique([organizationId, slug], map: "PublicForm_organization_slug_unique")
  @@index([organizationId, deletedAt])
  @@index([organizationId, isActive])
}

model PublicFormSubmission {
  id               String       @id
  formId           String
  organizationId   String
  data             Json
  status           String       @default("new")
  ipAddress        String?
  userAgent        String?
  leadId           String?
  referredBy       String?
  privacyConsent   Boolean      @default(false)
  marketingConsent Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  PublicForm       PublicForm   @relation(fields: [formId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization     Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([formId, createdAt])
  @@index([organizationId, createdAt])
  @@index([status, createdAt])
}

model Quote {
  id             String          @id @default(dbgenerated("(gen_random_uuid())::text"))
  organizationId String
  leadId         String
  blockId        String          @db.Uuid
  createdById    String?         @db.Uuid
  number         String?
  status         QuoteStatus     @default(DRAFT)
  title          String?
  version        Int             @default(1)
  currency       String          @default("EUR")
  validUntil     DateTime?       @db.Timestamp(6)
  notes          String?
  data           Json?
  totals         Json?
  createdAt      DateTime        @default(now()) @db.Timestamp(6)
  updatedAt      DateTime        @default(now()) @db.Timestamp(6)
  Lead           Lead            @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  QuoteDocument  QuoteDocument[]
  QuoteItem      QuoteItem[]

  @@index([leadId])
  @@index([organizationId])
  @@index([status, updatedAt])
}

model QuoteDocument {
  id          String           @id @default(dbgenerated("(gen_random_uuid())::text"))
  quoteId     String
  version     Int              @default(1)
  storageType QuoteStorageType @default(LOCAL)
  fileName    String
  mimeType    String           @default("text/html")
  url         String?
  driveFileId String?
  path        String?
  createdAt   DateTime         @default(now()) @db.Timestamp(6)
  Quote       Quote            @relation(fields: [quoteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([quoteId])
}

model QuoteItem {
  id          String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  quoteId     String
  order       Int     @default(0)
  label       String
  description String?
  quantity    Decimal @db.Decimal(18, 4)
  unitPrice   Decimal @db.Decimal(18, 4)
  discountPct Decimal @default(0) @db.Decimal(5, 2)
  taxPct      Decimal @default(21) @db.Decimal(5, 2)
  totalExcl   Decimal @db.Decimal(18, 4)
  totalIncl   Decimal @db.Decimal(18, 4)
  Quote       Quote   @relation(fields: [quoteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([quoteId])
}

model Role {
  id                     String                   @id
  name                   String
  label                  String
  description            String?
  organizationId         String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  isDetached             Boolean                  @default(false)
  isGlobal               Boolean                  @default(false)
  templateRoleId         String?
  Invitation             Invitation[]
  OrganizationRoleStatus OrganizationRoleStatus[]
  Permission             Permission[]
  Organization           Organization?            @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  UserOrganization       UserOrganization[]

  @@unique([name, organizationId])
  @@index([organizationId])
}

model Section {
  id      String  @id
  name    String
  order   Int
  blockId String
  active  Boolean @default(true)
  Field   Field[]
  Block   Block   @relation(fields: [blockId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model SystemConfig {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([key])
}

model TechnicalData {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String?
  type           String        @db.VarChar(255)
  label          String        @db.VarChar(255)
  value          String        @db.VarChar(255)
  data           Json?
  createdAt      DateTime      @default(now()) @db.Timestamp(6)
  updatedAt      DateTime      @default(now()) @db.Timestamp(6)
  leadId         String?
  Lead           Lead?         @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model TelnyxCall {
  id             String          @id
  callId         String          @unique
  fromNumber     String
  toNumber       String
  direction      String
  status         String
  duration       Int?
  cost           Float?
  recordingUrl   String?
  organizationId String
  leadId         String?
  answeredBy     String? // üÜï Qui a r√©pondu: "sip:username" | "pstn:+32477..." | null
  startedAt      DateTime
  endedAt        DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  Lead           Lead?           @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  TelnyxCallLeg  TelnyxCallLeg[] // üÜï Relation vers les legs

  @@index([callId])
  @@index([fromNumber])
  @@index([leadId])
  @@index([organizationId])
  @@index([startedAt])
  @@index([toNumber])
}

model TelnyxConnection {
  id               String       @id
  name             String
  status           String
  type             String
  webhookUrl       String?
  organizationId   String
  sipDomain        String? // ex: votre-org.sip.telnyx.com
  callControlAppId String? // ID de l'application Call Control Telnyx
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  Organization     Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
  @@index([status])
}

model TelnyxMessage {
  id             String       @id
  messageId      String       @unique
  fromNumber     String
  toNumber       String
  direction      String
  type           String
  text           String
  status         String
  cost           Float?
  mediaUrls      String[]     @default([])
  organizationId String
  leadId         String?
  sentAt         DateTime
  deliveredAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Lead           Lead?        @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([fromNumber])
  @@index([leadId])
  @@index([messageId])
  @@index([organizationId])
  @@index([sentAt])
  @@index([toNumber])
}

model TelnyxPhoneNumber {
  id             String       @id
  phoneNumber    String       @unique
  status         String
  countryCode    String
  numberType     String
  features       String[]
  monthlyCost    Float        @default(0)
  connectionId   String?
  organizationId String
  purchasedAt    DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  assignedUserId String?
  User           User?        @relation(fields: [assignedUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([assignedUserId])
  @@index([countryCode])
  @@index([organizationId])
  @@index([phoneNumber])
  @@index([status])
}

model TelnyxSettings {
  id              String   @id
  userId          String   @unique
  encryptedApiKey String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  User            User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model TelnyxUserConfig {
  id             String       @id
  userId         String       @unique
  organizationId String
  assignedNumber String?
  canMakeCalls   Boolean      @default(false)
  canSendSms     Boolean      @default(false)
  monthlyLimit   Float?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([assignedNumber])
  @@index([organizationId])
  @@index([userId])
}

// üÜï NOUVEAUX MOD√àLES POUR ARCHITECTURE "TELNYX COMME CERVEAU"

// Configuration API Telnyx par organisation (s√©curis√©e)
model TelnyxConfig {
  id                   String       @id
  organizationId       String       @unique
  encryptedApiKey      String // Cl√© API chiffr√©e avec ENCRYPTION_KEY
  webhookSigningSecret String? // Pour valider l'authenticit√© des webhooks
  webhookUrl           String       @default("__AUTO__")
  defaultConnectionId  String? // Connexion par d√©faut pour les appels
  callControlAppId     String? // ID de l'application Call Control Telnyx
  fallbackPstnNumber   String? // üÜï Fallback GSM/PSTN (ex: +32477123456)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime
  Organization         Organization @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([organizationId])
}

// Endpoints SIP (CRM + Softphones utilisateurs)
model TelnyxSipEndpoint {
  id             String          @id
  organizationId String
  userId         String? // null = endpoint CRM principal
  name           String // "CRM Principal", "Softphone Jonathan"
  sipUsername    String          @unique
  sipPassword    String // Chiffr√© avec ENCRYPTION_KEY
  sipDomain      String // votre-org.sip.telnyx.com
  status         String          @default("active") // active, inactive
  priority       Int             @default(1) // Ordre cascade: 1=CRM, 2=softphones, 3=PSTN
  timeout        Int             @default(10) // Timeout en secondes
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  User           User?           @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  TelnyxCallLeg  TelnyxCallLeg[]

  @@index([organizationId])
  @@index([userId])
  @@index([priority])
  @@index([status])
}

// Tracking d√©taill√© des legs d'appel (multi-√©tapes SIP + PSTN)
model TelnyxCallLeg {
  id          String             @id
  callId      String // R√©f√©rence TelnyxCall.callId
  legType     String // "sip" | "pstn"
  endpointId  String? // ID TelnyxSipEndpoint si SIP
  destination String // SIP username ou num√©ro PSTN (+32477...)
  status      String // "no-answer" | "answered" | "busy" | "failed" | "timeout"
  dialedAt    DateTime           @default(now())
  answeredAt  DateTime?
  endedAt     DateTime?
  duration    Int? // Dur√©e en secondes
  priority    Int // Position dans la cascade (1, 2, 3...)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime
  Call        TelnyxCall         @relation(fields: [callId], references: [callId], onDelete: NoAction, onUpdate: NoAction)
  Endpoint    TelnyxSipEndpoint? @relation(fields: [endpointId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([callId])
  @@index([endpointId])
  @@index([status])
  @@index([dialedAt])
}

model TimelineEvent {
  id             String        @id
  organizationId String?
  entityType     String
  entityId       String
  eventType      String
  data           Json?
  createdAt      DateTime      @default(now())
  leadId         String?
  Lead           Lead?         @relation(fields: [leadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model TreeBranchLeafAPIConnection {
  id            String    @id
  treeId        String
  name          String
  url           String
  method        String    @default("GET")
  headers       Json      @default("{}")
  params        Json      @default("{}")
  authType      String?
  authConfig    Json      @default("{}")
  cacheEnabled  Boolean   @default(true)
  cacheDuration Int       @default(3600)
  lastCall      DateTime?
  lastResponse  Json?
  isActive      Boolean   @default(true)
  metadata      Json      @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime

  @@unique([treeId, name])
  @@index([isActive])
  @@index([treeId])
}

model TreeBranchLeafDateConfig {
  id            String    @id
  nodeId        String    @unique
  includeTime   Boolean   @default(false)
  minDate       DateTime?
  maxDate       DateTime?
  format        String    @default("DD/MM/YYYY")
  locale        String    @default("fr")
  disabledDates Json      @default("[]")
  allowedDays   Json      @default("[0, 1, 2, 3, 4, 5, 6]")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime

  @@index([nodeId])
}

model TreeBranchLeafFormulaConfig {
  id             String    @id
  nodeId         String    @unique
  formula        String
  variables      Json      @default("{}")
  resultType     String    @default("number")
  precision      Int       @default(2)
  autoCalculate  Boolean   @default(true)
  dependencies   Json      @default("[]")
  lastCalculated DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime

  @@index([autoCalculate])
  @@index([nodeId])
}

model TreeBranchLeafFormulaReference {
  id               String   @id
  nodeId           String
  referencedNodeId String
  operator         String?
  weight           Float    @default(1.0)
  order            Int      @default(0)
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())

  @@index([nodeId])
  @@index([order])
  @@index([referencedNodeId])
}

model TreeBranchLeafMarker {
  id             String   @id
  treeId         String?
  organizationId String
  name           String
  description    String?
  color          String   @default("#3b82f6")
  icon           String?
  category       String?
  isGlobal       Boolean  @default(false)
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@unique([organizationId, name])
  @@index([category])
  @@index([isGlobal])
  @@index([organizationId])
}

model TreeBranchLeafNode {
  id              String  @id
  treeId          String
  parentId        String?
  type            String
  subType         String?
  label           String
  description     String?
  value           String?
  order           Int     @default(0)
  isRequired      Boolean @default(false)
  isVisible       Boolean @default(true)
  isActive        Boolean @default(true)
  fieldConfig     Json?
  conditionConfig Json?
  formulaConfig   Json?
  tableConfig     Json?
  apiConfig       Json?
  linkConfig      Json?

  // Relation vers l'arbre parent
  TreeBranchLeafTree          TreeBranchLeafTree @relation(fields: [treeId], references: [id], onDelete: Cascade)
  defaultValue                String?
  calculatedValue             String?
  metadata                    Json               @default("{}")
  createdAt                   DateTime           @default(now())
  updatedAt                   DateTime
  hasAPI                      Boolean            @default(false)
  hasCondition                Boolean            @default(false)
  hasData                     Boolean            @default(false)
  hasFormula                  Boolean            @default(false)
  hasLink                     Boolean            @default(false)
  hasMarkers                  Boolean            @default(false)
  hasTable                    Boolean            @default(false)
  api_activeId                String?
  api_bodyVars                Json?
  api_instances               Json?
  api_name                    String?
  appearance_size             String?            @default("md")
  appearance_variant          String?
  appearance_width            String?
  appearance_displayIcon      String?
  bool_defaultValue           Boolean?
  bool_falseLabel             String?
  bool_trueLabel              String?
  condition_activeId          String?
  condition_branches          Json?
  condition_instances         Json?
  condition_mode              String?
  condition_tokens            Json?
  data_activeId               String?
  data_displayFormat          String?
  data_exposedKey             String?
  data_instances              Json?
  data_precision              Int?               @default(2)
  data_unit                   String?
  data_visibleToUser          Boolean?           @default(false)
  date_format                 String?            @default("DD/MM/YYYY")
  date_maxDate                DateTime?
  date_minDate                DateTime?
  date_showTime               Boolean?           @default(false)
  fieldSubType                String?
  fieldType                   String?
  field_label                 String?
  formula_activeId            String?
  formula_instances           Json?
  formula_name                String?
  formula_tokens              Json?
  image_crop                  Boolean?           @default(false)
  image_maxSize               Int?
  image_ratio                 String?
  image_thumbnails            Json?
  link_activeId               String?
  link_carryContext           Boolean?           @default(false)
  link_instances              Json?
  link_mode                   String?            @default("JUMP")
  link_name                   String?
  link_params                 Json?
  link_targetNodeId           String?
  link_targetTreeId           String?
  markers_activeId            String?
  markers_available           Json?
  markers_instances           Json?
  markers_name                String?
  markers_selectedIds         Json?
  number_decimals             Int?               @default(0)
  number_defaultValue         Decimal?
  number_max                  Decimal?
  number_min                  Decimal?
  number_prefix               String?
  number_step                 Decimal?           @default(1)
  number_suffix               String?
  number_unit                 String?
  option_label                String?
  select_allowClear           Boolean?           @default(true)
  select_defaultValue         String?
  select_multiple             Boolean?           @default(false)
  select_options              Json?
  select_searchable           Boolean?           @default(true)
  table_activeId              String?
  table_columns               Json?
  table_data                  Json?
  table_importSource          String?
  table_instances             Json?
  table_isImported            Boolean?           @default(false)
  table_meta                  Json?
  table_name                  String?
  table_rows                  Json?
  table_type                  String?            @default("columns")
  text_mask                   String?
  text_maxLength              Int?
  text_minLength              Int?
  text_placeholder            String?
  text_regex                  String?
  text_rows                   Int?               @default(3)
  tbl_auto_generated          Boolean            @default(false)
  tbl_capacity                Int?
  tbl_code                    String?            @db.VarChar(20)
  tbl_created_at              DateTime?
  tbl_type                    Int?
  tbl_updated_at              DateTime?
  text_helpTooltipType        String?            @default("none")
  text_helpTooltipText        String?
  text_helpTooltipImage       String?
  repeater_templateNodeIds    String?
  repeater_minItems           Int?               @default(0)
  repeater_maxItems           Int?
  repeater_addButtonLabel     String?
  repeater_templateNodeLabels String?
  repeater_countSourceNodeId  String?            // UUID du champ num√©rique qui contr√¥le le nombre de copies
  isMultiple                  Boolean?           @default(false)
  isSharedReference           Boolean?           @default(false)
  sharedReferenceCategory     String?
  sharedReferenceDescription  String?
  sharedReferenceId           String?
  sharedReferenceName         String?
  sharedReferenceIds          String[]           @default([])
  repeater_buttonSize         String?            @default("middle")
  repeater_buttonWidth        String?            @default("auto")
  repeater_iconOnly           Boolean?           @default(false)
  linkedConditionIds          String[]           @default([])
  linkedFormulaIds            String[]           @default([])
  linkedTableIds              String[]           @default([])
  linkedVariableIds           String[]           @default([])
  calculatedAt                DateTime?
  calculatedBy                String?
  subtabs                     Json?              @db.Json
  subtab                      Json?              @db.Json
  file_allowedTypes           String?
  file_maxSize                Int?
  file_multiple               Boolean?           @default(false)
  file_showPreview            Boolean?           @default(true)
  section_collapsible         Boolean?           @default(false)
  section_columnsDesktop      Int?               @default(2)
  section_columnsMobile       Int?               @default(1)
  section_defaultCollapsed    Boolean?           @default(false)
  section_gutter              Int?               @default(16)
  section_showChildrenCount   Boolean?           @default(false)

  // AI Measure configuration (colonnes d√©di√©es pour √©viter probl√®mes JSON)
  aiMeasure_enabled     Boolean @default(false)
  aiMeasure_autoTrigger Boolean @default(true)
  aiMeasure_prompt      String?
  aiMeasure_keys        Json?   @db.Json

  // üÜï Configuration compl√®te IA Mesure (objets de r√©f√©rence + param√®tres d√©tection)
  iaMesureConfig Json? @map("ia_mesure_config") @db.Json
  // Structure: { enabled: boolean, referenceObjects: [{type,width,height,unit}], detectionSettings: {minPhotos,confidenceThreshold,useSharp,useFusion} }

  // üì¶ PRODUIT - Capacit√© de filtrage par produit
  hasProduct                  Boolean            @default(false)
  product_sourceNodeId        String?            // ID du n≈ìud MULTISELECT qui pilote le filtrage
  product_visibleFor          Json?              @db.Json // Liste des valeurs d'options pour lesquelles ce n≈ìud est visible. Ex: ["panneaux","batteries"]. null = toujours visible.
  product_options             Json?              @db.Json // Options du produit (stock√©es sur le n≈ìud source). Ex: [{value:"panneaux",label:"Panneaux solaires"}]

  // Relation vers la variable expos√©e (1-to-1)
  TreeBranchLeafNodeVariable TreeBranchLeafNodeVariable?
  TreeBranchLeafNodeTable    TreeBranchLeafNodeTable[]
  TreeBranchLeafSelectConfig TreeBranchLeafSelectConfig?
  ProductDocument             ProductDocument[]

  @@index([api_activeId])
  @@index([condition_activeId])
  @@index([data_exposedKey])
  @@index([fieldType])
  @@index([formula_activeId])
  @@index([hasProduct])
  @@index([isSharedReference])
  @@index([link_activeId])
  @@index([markers_activeId])
  @@index([order])
  @@index([parentId])
  @@index([sharedReferenceId])
  @@index([table_activeId])
  @@index([tbl_auto_generated])
  @@index([tbl_capacity])
  @@index([tbl_code])
  @@index([tbl_type])
  @@index([treeId])
  @@index([type, subType])
}

model TreeBranchLeafNodeCondition {
  id             String   @id
  nodeId         String
  organizationId String?
  name           String
  conditionSet   Json     @default("{}")
  description    String?
  isDefault      Boolean  @default(false)
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@unique([nodeId, name])
  @@index([nodeId])
  @@index([organizationId])
}

model TreeBranchLeafNodeFormula {
  id                String   @id
  nodeId            String
  organizationId    String?
  name              String
  tokens            Json     @default("[]")
  description       String?
  isDefault         Boolean  @default(false)
  order             Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())
  targetProperty    String?
  constraintMessage String?

  @@unique([nodeId, name])
  @@index([nodeId])
  @@index([organizationId])
}

model TreeBranchLeafNodeMarker {
  id        String   @id
  nodeId    String
  markerId  String
  value     String?
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  @@unique([nodeId, markerId])
  @@index([markerId])
  @@index([nodeId])
}

model TreeBranchLeafNodeTable {
  id                   String   @id
  nodeId               String
  organizationId       String?
  name                 String
  description          String?
  type                 String   @default("basic")
  meta                 Json     @default("{}")
  isDefault            Boolean  @default(false)
  order                Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime
  lookupDisplayColumns String[] @default([])
  lookupSelectColumn   String?
  columnCount          Int      @default(0)
  rowCount             Int      @default(0)

  // Relations
  TreeBranchLeafNode TreeBranchLeafNode              @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  tableColumns       TreeBranchLeafNodeTableColumn[]
  tableRows          TreeBranchLeafNodeTableRow[]

  @@unique([nodeId, name])
  @@index([lookupSelectColumn])
  @@index([nodeId])
  @@index([organizationId])
}

model TreeBranchLeafNodeTableColumn {
  id          String  @id
  tableId     String
  columnIndex Int
  name        String
  type        String? @default("text")
  width       Int?
  format      String?
  metadata    Json    @default("{}")

  // Relation vers la table parente
  TreeBranchLeafNodeTable TreeBranchLeafNodeTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, columnIndex])
  @@index([tableId])
}

model TreeBranchLeafNodeTableRow {
  id       String @id
  tableId  String
  cells    Json
  rowIndex Int

  // Relation vers la table parente
  TreeBranchLeafNodeTable TreeBranchLeafNodeTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  ProductDocument         ProductDocument[]

  @@unique([tableId, rowIndex])
  @@index([tableId])
}

model TreeBranchLeafNodeVariable {
  id             String   @id
  nodeId         String   @unique
  exposedKey     String   @unique
  displayName    String
  displayFormat  String   @default("number")
  unit           String?
  precision      Int?     @default(2)
  visibleToUser  Boolean  @default(true)
  isReadonly     Boolean  @default(false)
  defaultValue   String?
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  fixedValue     String?
  selectedNodeId String?
  sourceRef      String?
  sourceType     String?  @default("fixed")

  // Relation vers le node parent
  TreeBranchLeafNode TreeBranchLeafNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([exposedKey])
  @@index([nodeId])
  @@index([selectedNodeId])
  @@index([sourceType])
  @@index([visibleToUser])
}

model TreeBranchLeafNumberConfig {
  id                 String   @id
  nodeId             String   @unique
  min                Float?
  max                Float?
  decimals           Int      @default(2)
  step               Float    @default(1)
  unit               String?
  prefix             String?
  suffix             String?
  separator          String   @default(".")
  thousandsSeparator String   @default(",")
  createdAt          DateTime @default(now())
  updatedAt          DateTime

  @@index([nodeId])
}

model TreeBranchLeafSelectConfig {
  id              String   @id
  nodeId          String   @unique
  options         Json     @default("[]")
  multiple        Boolean  @default(false)
  searchable      Boolean  @default(false)
  allowCustom     Boolean  @default(false)
  maxSelections   Int?
  optionsSource   String?
  apiEndpoint     String?
  tableReference  String?
  dependsOnNodeId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  keyColumn       String?
  valueColumn     String?
  displayColumn   String?
  displayRow      String?
  keyRow          String?
  valueRow        String?

  // Relation vers le node parent
  TreeBranchLeafNode TreeBranchLeafNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
  @@index([optionsSource])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model TreeBranchLeafStage {
  id           String   @id
  treeId       String
  submissionId String?
  leadId       String
  userId       String
  formData     Json     @default("{}")
  baseVersion  Int      @default(1)
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([expiresAt])
  @@index([submissionId])
  @@index([treeId])
  @@index([userId, leadId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model TreeBranchLeafSubmission {
  id                String              @id
  treeId            String
  userId            String?
  leadId            String?
  sessionId         String?
  status            String              @default("draft")
  totalScore        Float?
  summary           Json                @default("{}")
  exportData        Json?
  completedAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  currentVersion    Int                 @default(1)
  lastEditedBy      String?
  lockedBy          String?
  lockedAt          DateTime?
  organizationId    String?
  GeneratedDocument GeneratedDocument[]

  @@index([createdAt])
  @@index([lastEditedBy])
  @@index([leadId])
  @@index([lockedBy])
  @@index([organizationId])
  @@index([status])
  @@index([treeId])
  @@index([userId])
}

model TreeBranchLeafSubmissionData {
  id                  String           @id
  submissionId        String
  nodeId              String
  value               String?
  createdAt           DateTime         @default(now())
  lastResolved        DateTime?
  operationDetail     Json?
  operationResult     Json?
  operationSource     OperationSource?
  sourceRef           String?
  fieldLabel          String?
  isVariable          Boolean          @default(false)
  variableDisplayName String?
  variableKey         String?
  variableUnit        String?

  @@unique([submissionId, nodeId])
  @@index([isVariable])
  @@index([nodeId])
  @@index([operationSource])
  @@index([sourceRef])
  @@index([submissionId])
  @@index([variableKey])
  @@index([sourceRef], map: "idx_tree_branch_leaf_submission_data_source_ref")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model TreeBranchLeafSubmissionVersion {
  id           String   @id
  submissionId String
  version      Int
  formData     Json
  summary      String?
  createdBy    String
  createdAt    DateTime @default(now())

  @@unique([submissionId, version])
  @@index([createdAt])
  @@index([createdBy])
  @@index([submissionId])
}

model TreeBranchLeafTableData {
  id           String   @id
  treeId       String
  name         String
  description  String?
  headers      Json
  rows         Json
  isImported   Boolean  @default(false)
  importSource String?
  lastUpdated  DateTime @default(now())
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@unique([treeId, name])
  @@index([treeId])
}

model TreeBranchLeafTextConfig {
  id                String   @id
  nodeId            String   @unique
  maxLength         Int?
  minLength         Int?
  validation        String?
  placeholder       String?
  isMultiline       Boolean  @default(false)
  allowedCharacters String?
  forbiddenWords    Json     @default("[]")
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  @@index([nodeId])
}

model TreeBranchLeafTree {
  id               String             @id
  organizationId   String
  name             String
  description      String?
  category         String             @default("formulaire")
  icon             String?
  color            String             @default("#10b981")
  version          String             @default("1.0.0")
  status           String             @default("draft")
  settings         Json               @default("{}")
  metadata         Json               @default("{}")
  isPublic         Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  DocumentTemplate DocumentTemplate[]

  // Relation vers les nodes de l'arbre
  TreeBranchLeafNode TreeBranchLeafNode[]

  // Relation vers les acc√®s organisationnels
  TreeOrganizationAccess TreeOrganizationAccess[]

  @@index([category])
  @@index([organizationId])
  @@index([status])
}

/// Gestion des acc√®s aux arbres par organisation, r√¥les et onglets
model TreeOrganizationAccess {
  id             String       @id @default(cuid())
  treeId         String
  organizationId String
  isOwner        Boolean      @default(false)  // L'organisation propri√©taire de l'arbre
  active         Boolean      @default(true)
  // Configuration JSON des acc√®s par onglet/sous-onglet
  // Structure: { tabs: { [nodeId]: { visible: bool, allowedRoles: string[], isSequential: bool, sequentialOrder: int, subTabs: { [subTabKey]: { visible: bool, allowedRoles: string[] } } } } }
  tabAccessConfig Json        @default("{}")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  tree           TreeBranchLeafTree @relation(fields: [treeId], references: [id], onDelete: Cascade)
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([treeId, organizationId])
  @@index([organizationId])
  @@index([treeId])
}

model User {
  id                                                  String                                   @id
  email                                               String                                   @unique
  createdAt                                           DateTime                                 @default(now())
  updatedAt                                           DateTime
  passwordHash                                        String
  status                                              String                                   @default("active")
  address                                             String?
  avatarUrl                                           String?
  firstName                                           String?
  lastName                                            String?
  phoneNumber                                         String?
  vatNumber                                           String?
  role                                                String                                   @default("user")
  organizationId                                      String? // Organisation principale
  commercialSlug                                      String? // üéØ Slug commercial (ex: "jean-dupont")
  CalendarEvent                                       CalendarEvent[]
  CalendarParticipant                                 CalendarParticipant[]
  DeletedEmail                                        DeletedEmail[]
  DocumentTemplate                                    DocumentTemplate[]
  Email                                               Email[]
  EmailAccount                                        EmailAccount?
  FormSubmission                                      FormSubmission[]
  GeneratedDocument_GeneratedDocument_createdByToUser GeneratedDocument[]                      @relation("GeneratedDocument_createdByToUser")
  GeneratedDocument_GeneratedDocument_sentByToUser    GeneratedDocument[]                      @relation("GeneratedDocument_sentByToUser")
  GoogleMailWatch                                     GoogleMailWatch?
  GoogleToken                                         GoogleToken[] // Tokens Google par organisation
  GoogleVoiceCall                                     GoogleVoiceCall[]
  GoogleVoiceSMS                                      GoogleVoiceSMS[]
  GoogleWorkspaceUser                                 GoogleWorkspaceUser?
  IntegrationsSettings                                IntegrationsSettings[]
  Invitation_Invitation_invitedByIdToUser             Invitation[]                             @relation("Invitation_invitedByIdToUser")
  Invitation_Invitation_targetUserIdToUser            Invitation[]                             @relation("Invitation_targetUserIdToUser")
  Lead                                                Lead[]
  Notification                                        Notification[]
  TelnyxPhoneNumber                                   TelnyxPhoneNumber[]
  TelnyxSettings                                      TelnyxSettings?
  TelnyxUserConfig                                    TelnyxUserConfig?
  TelnyxSipEndpoint                                   TelnyxSipEndpoint[] // üÜï Endpoints SIP utilisateur
  UserOrganization                                    UserOrganization[]
  UserService                                         UserService[]
  UserFavoriteModule                                  UserFavoriteModule[]
  JoinRequest                                         JoinRequest[]
  website_blog_posts                                  website_blog_posts[]
  website_media_files                                 website_media_files[]
  MeasurementReferenceConfig                          OrganizationMeasurementReferenceConfig[] @relation("MeasurementConfigCreator")
  ProductDocumentsUploaded                             ProductDocument[] @relation("ProductDocumentsUploaded")

  @@index([organizationId, commercialSlug]) // üéØ Index pour optimiser les recherches de slug
}

model UserOrganization {
  userId         String
  organizationId String
  roleId         String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime
  status         UserOrganizationStatus @default(ACTIVE)
  id             String                 @id
  Organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Role           Role                   @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  User           User                   @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, organizationId])
}

model UserService {
  id           String   @id
  userId       String
  serviceType  String
  isActive     Boolean  @default(false)
  isConfigured Boolean  @default(false)
  email        String?
  phoneNumber  String?
  apiKey       String?
  data         Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, serviceType])
  @@index([userId])
}

model UserRoles {
  A String
  B String

  @@id([A, B], map: "_UserRoles_AB_pkey")
  @@index([B], map: "_UserRoles_B_index")
  @@map("_UserRoles")
}

model contact_submissions {
  id             Int           @id @default(autoincrement())
  websiteId      Int
  name           String
  email          String
  phone          String?
  service        String?
  message        String?
  source         String        @default("website")
  ipAddress      String?
  userAgent      String?
  status         String        @default("new")
  isRead         Boolean       @default(false)
  notes          String?
  submittedAt    DateTime      @default(now())
  respondedAt    DateTime?
  organizationId String?
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  websites       websites      @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([email])
  @@index([organizationId])
  @@index([status])
  @@index([submittedAt])
  @@index([websiteId])
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model verification_checksums {
  table_name String?
  checksum   String?

  @@ignore
}

model website_blog_posts {
  id               Int       @id @default(autoincrement())
  websiteId        Int
  slug             String
  title            String
  excerpt          String
  content          String
  coverImageFileId Int?
  tags             Json
  authorId         String?
  isPublished      Boolean   @default(false)
  isFeatured       Boolean   @default(false)
  publishedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  User             User?     @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  websites         websites  @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([websiteId, slug])
  @@index([isFeatured])
  @@index([isPublished])
  @@index([slug])
  @@index([websiteId])
}

model website_configs {
  id                                                                            Int                  @id @default(autoincrement())
  websiteId                                                                     Int                  @unique
  logoFileId                                                                    Int?
  faviconFileId                                                                 Int?
  primaryColor                                                                  String               @default("#10b981")
  secondaryColor                                                                String               @default("#3b82f6")
  phone                                                                         String?
  email                                                                         String?
  address                                                                       String?
  city                                                                          String?
  postalCode                                                                    String?
  country                                                                       String               @default("Belgique")
  mapUrl                                                                        String?
  businessHours                                                                 Json?
  socialLinks                                                                   Json?
  heroTitle                                                                     String?
  heroSubtitle                                                                  String?
  heroCtaPrimary                                                                String?
  heroCtaSecondary                                                              String?
  heroBackgroundFileId                                                          Int?
  metaTitle                                                                     String?
  metaDescription                                                               String?
  metaKeywords                                                                  String?
  ogImageFileId                                                                 Int?
  stats                                                                         Json?
  aboutText                                                                     String?
  valuesJson                                                                    Json?
  createdAt                                                                     DateTime             @default(now())
  updatedAt                                                                     DateTime
  website_media_files_website_configs_faviconFileIdTowebsite_media_files        website_media_files? @relation("website_configs_faviconFileIdTowebsite_media_files", fields: [faviconFileId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  website_media_files_website_configs_heroBackgroundFileIdTowebsite_media_files website_media_files? @relation("website_configs_heroBackgroundFileIdTowebsite_media_files", fields: [heroBackgroundFileId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  website_media_files_website_configs_logoFileIdTowebsite_media_files           website_media_files? @relation("website_configs_logoFileIdTowebsite_media_files", fields: [logoFileId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  website_media_files_website_configs_ogImageFileIdTowebsite_media_files        website_media_files? @relation("website_configs_ogImageFileIdTowebsite_media_files", fields: [ogImageFileId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  websites                                                                      websites             @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([websiteId])
}

model website_media_files {
  id                                                                        Int               @id @default(autoincrement())
  websiteId                                                                 Int
  fileName                                                                  String
  fileType                                                                  String
  fileSize                                                                  Int
  filePath                                                                  String
  fileUrl                                                                   String
  title                                                                     String?
  altText                                                                   String?
  caption                                                                   String?
  width                                                                     Int?
  height                                                                    Int?
  category                                                                  String?
  tags                                                                      Json?
  isPublic                                                                  Boolean           @default(true)
  uploadedById                                                              String?
  createdAt                                                                 DateTime          @default(now())
  updatedAt                                                                 DateTime
  website_configs_website_configs_faviconFileIdTowebsite_media_files        website_configs[] @relation("website_configs_faviconFileIdTowebsite_media_files")
  website_configs_website_configs_heroBackgroundFileIdTowebsite_media_files website_configs[] @relation("website_configs_heroBackgroundFileIdTowebsite_media_files")
  website_configs_website_configs_logoFileIdTowebsite_media_files           website_configs[] @relation("website_configs_logoFileIdTowebsite_media_files")
  website_configs_website_configs_ogImageFileIdTowebsite_media_files        website_configs[] @relation("website_configs_ogImageFileIdTowebsite_media_files")
  User                                                                      User?             @relation(fields: [uploadedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  websites                                                                  websites          @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([category])
  @@index([websiteId])
}

model website_projects {
  id           Int       @id @default(autoincrement())
  websiteId    Int
  title        String
  location     String
  details      String
  imageFileId  Int?
  tags         Json
  isActive     Boolean   @default(true)
  isFeatured   Boolean   @default(false)
  displayOrder Int       @default(0)
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  websites     websites  @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([displayOrder])
  @@index([isFeatured])
  @@index([websiteId])
}

model website_sections {
  id              Int      @id @default(autoincrement())
  websiteId       Int
  key             String
  type            String
  name            String
  content         Json
  backgroundColor String?
  textColor       String?
  customCss       String?
  displayOrder    Int      @default(0)
  isActive        Boolean  @default(true)
  isLocked        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  websites        websites @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([websiteId, key])
  @@index([displayOrder])
  @@index([isActive])
  @@index([websiteId])
}

model website_services {
  id           Int      @id @default(autoincrement())
  websiteId    Int
  key          String
  icon         String
  title        String
  description  String
  features     Json
  ctaText      String
  ctaUrl       String?
  imageFileId  Int?
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  websites     websites @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([websiteId, key])
  @@index([displayOrder])
  @@index([websiteId])
}

model website_testimonials {
  id           Int       @id @default(autoincrement())
  websiteId    Int
  customerName String
  location     String
  service      String
  rating       Int       @default(5)
  text         String
  avatarFileId Int?
  isActive     Boolean   @default(true)
  isFeatured   Boolean   @default(false)
  displayOrder Int       @default(0)
  publishedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  websites     websites  @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([displayOrder])
  @@index([isFeatured])
  @@index([websiteId])
}

model website_themes {
  id              Int      @id @default(autoincrement())
  websiteId       Int      @unique
  name            String   @default("Th√®me par d√©faut")
  primaryColor    String   @default("#10b981")
  secondaryColor  String   @default("#059669")
  accentColor     String   @default("#047857")
  textColor       String   @default("#1f2937")
  textLightColor  String   @default("#6b7280")
  backgroundColor String   @default("#ffffff")
  surfaceColor    String   @default("#f9fafb")
  fontTitle       String   @default("Poppins")
  fontText        String   @default("Inter")
  fontSizeBase    Int      @default(16)
  borderRadius    Int      @default(12)
  shadowLevel     String   @default("medium")
  spacingUnit     Int      @default(8)
  customCss       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  websites        websites @relation(fields: [websiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([websiteId])
}

model websites {
  id                        Int                    @id @default(autoincrement())
  organizationId            String
  siteName                  String
  siteType                  String
  slug                      String
  domain                    String?
  cloudRunDomain            String? // Domaine mapp√© dans Cloud Run (ex: 2thier.be)
  cloudRunServiceName       String? // Nom du service Cloud Run (ex: crm2thier-vite-prod)
  cloudRunRegion            String?                @default("europe-west1") // R√©gion Cloud Run
  cloudRunMappingVerified   Boolean                @default(false) // Mapping v√©rifi√© et fonctionnel
  cloudRunMappingVerifiedAt DateTime? // Date de v√©rification
  isActive                  Boolean                @default(true)
  isPublished               Boolean                @default(false)
  maintenanceMode           Boolean                @default(false)
  maintenanceMessage        String?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime
  contact_submissions       contact_submissions[]
  website_blog_posts        website_blog_posts[]
  website_configs           website_configs?
  website_media_files       website_media_files[]
  website_projects          website_projects[]
  website_sections          website_sections[]
  website_services          website_services[]
  website_testimonials      website_testimonials[]
  website_themes            website_themes?
  website_form_website      website_form_website[]
  Organization              Organization           @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@index([cloudRunDomain])
}

enum DocumentStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  PAID
  CANCELLED
  PENDING
}

enum DocumentType {
  QUOTE
  INVOICE
  ORDER
  CONTRACT
  PRESENTATION
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
  DISABLED
}

enum NotificationStatus {
  PENDING
  READ
  ARCHIVED
}

enum NotificationType {
  ROLE_UPDATE_AVAILABLE
  NEW_LEAD_ASSIGNED
  NEW_MAIL_RECEIVED
  TASK_COMPLETED
  CALENDAR_EVENT_REMINDER
  CALENDAR_EVENT_INVITATION
  CALENDAR_EVENT_UPDATED
  CALENDAR_EVENT_CANCELLED
}

enum OperationSource {
  condition
  formula
  table
  neutral
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
}

enum QuoteStorageType {
  LOCAL
  DRIVE
}

enum DocumentStorageType {
  LOCAL
  GOOGLE_DRIVE
  YANDEX_DISK
}

/// Fiches techniques / documents li√©s aux produits (panneaux, onduleurs, etc.)
/// Li√©s aux FieldOptionNode pour association automatique dans les devis
model ProductDocument {
  id             String              @id @default(dbgenerated("(gen_random_uuid())::text"))
  nodeId         String              /// R√©f√©rence au TreeBranchLeafNode (champ/option de l'arbre)
  tableRowId     String?             /// R√©f√©rence optionnelle √† une ligne de table lookup
  organizationId String
  uploadedById   String              /// Utilisateur qui a upload√©

  /// M√©tadonn√©es du fichier
  name           String              /// Nom affich√© (ex: "Fiche technique JA Solar 425W")
  fileName       String              /// Nom du fichier original
  mimeType       String              @default("application/pdf")
  fileSize       Int?                /// Taille en octets

  /// Stockage unifi√©
  storageType    DocumentStorageType @default(LOCAL)
  localPath      String?             /// Chemin local pour stockage CRM (users Yandex)
  driveFileId    String?             /// ID fichier Google Drive (users Google)
  driveUrl       String?             /// URL publique/partag√©e Google Drive
  externalUrl    String?             /// URL externe (Yandex Disk ou autre)

  /// Cat√©gorie pour filtrage
  category       String              @default("fiche_technique") /// fiche_technique, certification, garantie, notice

  createdAt      DateTime            @default(now()) @db.Timestamp(6)
  updatedAt      DateTime            @updatedAt @db.Timestamp(6)

  /// Relations
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  uploadedBy     User                @relation("ProductDocumentsUploaded", fields: [uploadedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  node           TreeBranchLeafNode  @relation(fields: [nodeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tableRow       TreeBranchLeafNodeTableRow? @relation(fields: [tableRowId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([nodeId])
  @@index([tableRowId])
  @@index([organizationId])
  @@index([category])
  @@index([storageType])
}

enum SectionType {
  COVER_PAGE
  COMPANY_PRESENTATION
  TEXT_BLOCK
  PRODUCT_OFFER
  PRICING_TABLE
  CHART_ROI
  CHART_BAR
  CHART_LINE
  CHART_PIE
  IMAGE
  TERMS_CONDITIONS
  SIGNATURE_BLOCK
  PAGE_BREAK
  CUSTOM_HTML
  MODULAR_PAGE
}

enum SignatureStatus {
  PENDING
  SIGNED
  DECLINED
}

enum UserOrganizationStatus {
  PENDING
  ACTIVE
  INACTIVE
  REJECTED
}

// Demandes d'adh√©sion √† une organisation (type "joinOrg" √† l'inscription)
enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model JoinRequest {
  id             String            @id @default(cuid())
  userId         String
  organizationId String
  message        String? // Message optionnel de l'utilisateur
  status         JoinRequestStatus @default(PENDING)
  reviewedBy     String? // ID de l'admin qui a trait√© la demande
  reviewedAt     DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId]) // Un user ne peut faire qu'une demande par org
  @@index([userId])
  @@index([organizationId])
  @@index([status])
}

model UserFavoriteModule {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  moduleKey      String // Ex: "leads", "dashboard", "email", etc.
  createdAt      DateTime @default(now())

  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, moduleKey])
  @@index([userId])
  @@index([organizationId])
}

// ============================================================================
// üì∑ Mesures photo (ArUco / homographie) - Nouveau flux vision
// ============================================================================

model MeasurePhoto {
  id              String   @id @default(cuid())
  organizationId  String
  treeId          String?
  nodeId          String?
  fieldId         String?
  fileUrl         String?
  storageRef      String?
  mimeType        String?
  widthPx         Int?
  heightPx        Int?
  exif            Json?
  deviceInfo      Json? // { make, model, focal, fov, orientation }
  referenceType   String? // a4|card|arucoTag|custom
  referenceSizeMm Json? // { width, height }
  arucoId         Int?
  arucoCornersPx  Json? // [[x,y]...]
  homography      Json? // { matrix, quality, rmsePx }
  pose            Json? // { pitch,yaw,roll,depthMm,reprojError }
  measurements    Json? // { key: value }
  status          String? // draft|ok|failed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  MeasurePhotoPoints MeasurePhotoPoint[]

  @@index([organizationId])
  @@index([treeId])
  @@index([nodeId])
  @@index([fieldId])
}

model MeasurePhotoPoint {
  id             String  @id @default(cuid())
  measurePhotoId String
  label          String
  xPx            Float
  yPx            Float
  source         String? // detected|manual
  confidence     Float?

  MeasurePhoto MeasurePhoto @relation(fields: [measurePhotoId], references: [id], onDelete: Cascade)

  @@index([measurePhotoId])
}

model CalibrationProfile {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  referenceType   String // a4|card|arucoTag|custom
  referenceSizeMm Json? // { width, height }
  arucoId         Int?
  cameraModel     String?
  lensFov         Float?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
}

// ============================================================================
// üìã MODULE FORMULAIRES - Style Effy
// Formulaires publics avec mapping TBL pour cr√©ation de leads
// ============================================================================

/// D√©finition d'un formulaire (peut √™tre li√© √† plusieurs sites)
model website_forms {
  id             Int     @id @default(autoincrement())
  organizationId String
  name           String // "Simulateur Isolation"
  slug           String // "simulateur-isolation" 
  description    String?
  treeId         String? // ID de l'arbre TBL pour le mapping des champs
  isActive       Boolean @default(true)

  // üéØ Tracking commercial nominatif
  requiresCommercialTracking Boolean @default(false) // Active le syst√®me de liens par commercial

  // Configuration globale du formulaire
  settings Json @default("{}") // {primaryColor, logo, trustpilotUrl, ...}

  // üß≠ Question de d√©part (pour le nouveau syst√®me 1 question = 1 √©cran)
  startQuestionKey String? // Cl√© de la premi√®re question √† afficher

  // Textes de fin de formulaire
  successTitle   String? @default("Merci pour votre demande !")
  successMessage String? @default("Nous vous recontacterons dans les plus brefs d√©lais.")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  Organization Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  steps        website_form_steps[]
  questions    website_form_questions[] // Nouveau syst√®me 1 question = 1 √©cran
  websites     website_form_website[]
  submissions  website_form_submissions[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@index([isActive])
}

/// √âtape du formulaire (une question par √©cran style Effy)
model website_form_steps {
  id     Int @id @default(autoincrement())
  formId Int

  // Contenu de l'√©tape
  title    String // "Votre projet concerne :"
  subtitle String? // "Cela permet de nous assurer de votre √©ligibilit√©..."
  helpText String? // Texte d'aide affich√© en tooltip ou sous le titre

  // Type d'√©tape
  stepType String @default("single_choice") // single_choice, multiple_choice, text, number, email, phone, address, date

  // Configuration
  order      Int     @default(0)
  isRequired Boolean @default(true)

  // Logique conditionnelle (JSON)
  // Ex: {"showIf": [{"stepId": 1, "fieldValue": "maison"}]}
  condition Json?

  // Configuration sp√©cifique au type d'√©tape
  settings Json @default("{}") // {layout: 'grid', columns: 2, ...}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  form   website_forms         @relation(fields: [formId], references: [id], onDelete: Cascade)
  fields website_form_fields[]

  @@index([formId])
  @@index([formId, order])
}

/// Champs/Options d'une √©tape
model website_form_fields {
  id     Int @id @default(autoincrement())
  stepId Int

  // üîó Champ parent pour sous-questions imbriqu√©es
  parentFieldId Int? // Si d√©fini, ce champ est une sous-question

  // Contenu du champ
  label String // "Une maison", "Surface habitable (m¬≤)"
  name  String? // Nom technique du champ (ex: "housing_type")
  value String? // Valeur par d√©faut ou valeur unique pour les options

  // Type de champ
  fieldType String @default("option") // option, card_select, text, number, email, phone, textarea, select, radio, checkbox, date, address

  // Visuel
  icon     String? // Emoji "üè†" ou nom d'ic√¥ne
  imageUrl String? // URL image illustrative (style Effy)

  // Configuration input
  placeholder  String?
  helpText     String?
  defaultValue String?

  // Options pour select/radio/checkbox/card_select (JSON array)
  // Ex: [{"value": "maison", "label": "Maison", "icon": "üè†"}, ...]
  options Json?

  // Validation (JSON)
  // Ex: {"min": 10, "max": 500, "pattern": "^[0-9]+$", "required": true, "errorMessage": "..."}
  validation Json?

  // üî• MAPPING TBL - Lien vers un n≈ìud TreeBranchLeaf
  tblNodeId    String? // ID du n≈ìud TBL o√π sauvegarder la valeur
  tblNodeLabel String? // Label du n≈ìud pour affichage admin

  // Configuration
  order         Int     @default(0)
  isRequired    Boolean @default(false) // Champ obligatoire
  isDefault     Boolean @default(false) // Option pr√©-s√©lectionn√©e
  allowMultiple Boolean @default(false) // Permet choix multiples (checkbox)

  // üéØ Logique conditionnelle avanc√©e
  // Format: {"showIf": {"field": "heating_type", "operator": "equals", "value": "fioul"}}
  // Op√©rateurs: equals, notEquals, in, notIn, greaterThan, lessThan, contains
  condition Json?

  // M√©tadonn√©es additionnelles
  metadata Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  step        website_form_steps    @relation(fields: [stepId], references: [id], onDelete: Cascade)
  parentField website_form_fields?  @relation("FieldChildren", fields: [parentFieldId], references: [id], onDelete: Cascade)
  childFields website_form_fields[] @relation("FieldChildren")

  @@index([stepId])
  @@index([stepId, order])
  @@index([tblNodeId])
  @@index([parentFieldId])
}

/// üéØ QUESTIONS - Style Effy : 1 question = 1 √©cran pleine page
/// Chaque question a sa propre navigation conditionnelle
model website_form_questions {
  id     Int @id @default(autoincrement())
  formId Int

  // Identification
  questionKey String // Cl√© unique: "type_logement", "chauffage_fioul_type"

  // Contenu affich√©
  title    String // "Votre projet concerne :"
  subtitle String? // "S√©lectionnez votre type de logement"
  helpText String? // Texte d'aide optionnel
  icon     String? // Emoji ou ic√¥ne pour le header

  // Type de question
  questionType String @default("single_choice")
  // single_choice: une seule r√©ponse (cartes cliquables)
  // multiple_choice: plusieurs r√©ponses (checkboxes)
  // number: champ num√©rique
  // text: champ texte
  // email: champ email
  // phone: champ t√©l√©phone
  // address: champ adresse
  // select: dropdown

  // Configuration input (pour number, text, etc.)
  placeholder String?
  inputSuffix String? // "m¬≤", "‚Ç¨", "kW"
  minValue    Int?
  maxValue    Int?

  // üé® Options de r√©ponse (pour single_choice / multiple_choice)
  // Format: [{"value": "maison", "label": "Une maison", "icon": "üè°", "description": "Individuelle", "imageUrl": "/img/maison.png"}]
  options Json?

  // üß≠ NAVIGATION CONDITIONNELLE
  // Question suivante par d√©faut (si pas de condition sp√©cifique)
  defaultNextQuestionKey String?

  // Navigation conditionnelle bas√©e sur la r√©ponse
  // Format: [{"answerValue": "maison", "nextQuestionKey": "annee_construction"}, 
  //          {"answerValue": "appartement", "nextQuestionKey": "annee_construction"}]
  // Ou avec conditions complexes:
  // [{"condition": {"field": "type_logement", "operator": "equals", "value": "maison"}, "nextQuestionKey": "isolation_etat"}]
  navigation Json?

  // Question finale ? (d√©clenche soumission)
  isEndQuestion Boolean @default(false)

  // üî• MAPPING TBL
  tblNodeId    String?
  tblNodeLabel String?

  // Ordre d'affichage dans l'admin
  order      Int     @default(0)
  isRequired Boolean @default(true)

  // M√©tadonn√©es
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  form website_forms @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@unique([formId, questionKey])
  @@index([formId])
  @@index([formId, order])
  @@index([questionKey])
}

/// Table de liaison formulaire <-> sites (N-N)
model website_form_website {
  id        Int @id @default(autoincrement())
  formId    Int
  websiteId Int

  // Configuration par site
  isDefault Boolean @default(false) // Formulaire principal du site
  urlPath   String? @default("/simulateur") // Chemin URL sur le site

  createdAt DateTime @default(now())

  // Relations
  form    website_forms @relation(fields: [formId], references: [id], onDelete: Cascade)
  website websites      @relation(fields: [websiteId], references: [id], onDelete: Cascade)

  @@unique([formId, websiteId])
  @@index([websiteId])
  @@index([formId])
}

/// Soumissions de formulaires (tracking des leads cr√©√©s)
model website_form_submissions {
  id     Int @id @default(autoincrement())
  formId Int

  // Lien vers les entit√©s cr√©√©es
  leadId       String? // ID du lead cr√©√©
  submissionId String? // ID de la TreeBranchLeafSubmission cr√©√©e

  // üéØ Tracking commercial nominatif
  referredBy String? // Slug du commercial r√©f√©rent (ex: "jean-dupont")

  // Donn√©es brutes soumises
  formData Json // Toutes les r√©ponses du formulaire

  // M√©tadonn√©es
  ipAddress   String?
  userAgent   String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Statut
  status       String  @default("completed") // completed, partial, error
  errorMessage String?

  createdAt DateTime @default(now())

  // Relations
  form website_forms @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([leadId])
  @@index([submissionId])
  @@index([createdAt])
  @@index([status])
}
