/**
 * ├Г┬░├Е┬╕├В┬з├В┬о Syst├Г╞Т├В┬иme de copie des FORMULES
 * 
 * Ce module g├Г╞Т├В┬иre la copie compl├Г╞Т├В┬иte d'une formule (TreeBranchLeafNodeFormula)
 * avec r├Г╞Т├В┬й├Г╞Т├В┬йcriture des tokens pour pointer vers les nouveaux IDs.
 * 
 * PRINCIPES :
 * -----------
 * 1. Copier la formule avec suffixe
 * 2. R├Г╞Т├В┬й├Г╞Т├В┬йcrire les tokens (@value.ID ├Г┬в├втВм┬а├втВмтДв @value.ID-suffix)
 * 3. ├Г┬░├Е┬╕├втВм┬Э├втВмтАЭ LIAISON AUTOMATIQUE OBLIGATOIRE: linkedFormulaIds sur TOUS les n├ГтАж├втВм┼Уuds r├Г╞Т├В┬йf├Г╞Т├В┬йrenc├Г╞Т├В┬йs
 * 4. Mettre ├Г╞Т├В┬а jour linkedFormulaIds du n├ГтАж├втВм┼Уud propri├Г╞Т├В┬йtaire
 * 5. Synchroniser les param├Г╞Т├В┬иtres de capacit├Г╞Т├В┬й (hasFormula, formula_activeId, etc.)
 * 
 * @author System TBL
 * @version 2.0.0 - LIAISON AUTOMATIQUE OBLIGATOIRE
 */

import { PrismaClient, Prisma } from '@prisma/client';
import { linkFormulaToAllNodes } from './universal-linking-system';
import { rewriteJsonReferences, forceSharedRefSuffixes, forceSharedRefSuffixesInJson, type RewriteMaps } from './repeat/utils/universal-reference-rewriter.js';

// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
// ├Г┬░├Е┬╕├втВм┼У├втВм┬╣ TYPES ET INTERFACES
// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р

/**
 * Options pour la copie de formule
 */
export interface CopyFormulaOptions {
  /** Map des n├ГтАж├втВм┼Уuds copi├Г╞Т├В┬йs (ancien ID ├Г┬в├втВм┬а├втВмтДв nouveau ID) pour r├Г╞Т├В┬й├Г╞Т├В┬йcrire les tokens */
  nodeIdMap?: Map<string, string>;
  /** Map des formules d├Г╞Т├В┬йj├Г╞Т├В┬а copi├Г╞Т├В┬йes (cache pour ├Г╞Т├В┬йviter doublons) */
  formulaCopyCache?: Map<string, string>;
}

/**
 * R├Г╞Т├В┬йsultat de la copie d'une formule
 */
export interface CopyFormulaResult {
  /** ID de la formule copi├Г╞Т├В┬йe */
  newFormulaId: string;
  /** ID du n├ГтАж├втВм┼Уud propri├Г╞Т├В┬йtaire */
  nodeId: string;
  /** Tokens r├Г╞Т├В┬й├Г╞Т├В┬йcrits */
  tokens: Prisma.InputJsonValue;
  /** Succ├Г╞Т├В┬иs de l'op├Г╞Т├В┬йration */
  success: boolean;
  /** Message d'erreur ├Г╞Т├В┬йventuel */
  error?: string;
}

// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
// ├Г┬░├Е┬╕├втВм┬Э├В┬з FONCTIONS UTILITAIRES DE R├Г╞Т├втВм┬░├Г╞Т├втВм┬░CRITURE
// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р

/**
 * R├Г╞Т├В┬й├Г╞Т├В┬йcrire les tokens d'une formule pour remplacer les anciens IDs par les nouveaux
 * 
 * Format des tokens :
 * - Array de strings/objets : ["@value.abc-123", "+", "@value.def-456"]
 * - Peut contenir des UUIDs ou des node_xxx
 * 
 * @param tokens - Tokens originaux
 * @param idMap - Map ancien ID ├Г┬в├втВм┬а├втВмтДв nouveau ID
 * @param suffix - Suffixe ├Г╞Т├В┬а ajouter si ID pas trouv├Г╞Т├В┬й dans la map
 * @returns Tokens r├Г╞Т├В┬й├Г╞Т├В┬йcrits
 * 
 * @example
 * rewriteFormulaTokens(
 *   ["@value.abc", "+", "@value.def"],
 *   new Map([["abc", "abc-1"]]),
 *   1
 * )
 * ├Г┬в├втВм┬а├втВмтДв ["@value.abc-1", "+", "@value.def-1"]
 */
function rewriteFormulaTokens(
  tokens: unknown,
  idMap: Map<string, string>,
  suffix?: string | number
): Prisma.InputJsonValue {
  if (!tokens) return tokens as Prisma.InputJsonValue;

  const rewriteString = (str: string): string => {
    // ├Г┬в├ЕтАЬ├втВм┬ж FIX REPEATER REFERENCES (02/12/2025):
    // PROBL├Г╞Т├ЛтАаME: Les shared-ref du repeater n'├Г╞Т├В┬йtaient pas suffix├Г╞Т├В┬йes
    // SOLUTION: Traiter TOUTES les r├Г╞Т├В┬йf├Г╞Т├В┬йrences (@value.<ID>) de la m├Г╞Т├В┬кme mani├Г╞Т├В┬иre
    // - Si trouv├Г╞Т├В┬йe dans la map ├Г┬в├втВм┬а├втВмтДв utiliser le mapping
    // - Sinon si suffixe fourni ├Г┬в├втВм┬а├втВмтДв ajouter le suffixe
    // - Y compris pour les shared-ref!
    return str.replace(/@value\.([A-Za-z0-9_:-]+(?:-[A-Za-z0-9]+)*)/g, (_match, nodeId: string) => {
      
      // 1. Chercher dans la map des n├ГтАж├втВм┼Уuds mapp├Г╞Т├В┬йs (y compris les shared-ref mapp├Г╞Т├В┬йes)
      const mappedId = idMap.get(nodeId);
      if (mappedId) {
        return `@value.${mappedId}`;
      }
      
      // 2. Si pas dans la map et qu'on a un suffixe, l'ajouter automatiquement
      if (suffix !== undefined) {
        const suffixStr = `${suffix}`;
        const suffixedId = `${nodeId}-${suffixStr}`;
        return `@value.${suffixedId}`;
      }
      
      // 3. Sinon garder tel quel
      return `@value.${nodeId}`;
    });
  };

  // Si tokens est un array
  if (Array.isArray(tokens)) {
    return tokens.map(token => {
      if (typeof token === 'string') {
        return rewriteString(token);
      }
      // Si c'est un objet, stringify puis rewrite puis parse
      if (token && typeof token === 'object') {
        try {
          const str = JSON.stringify(token);
          const rewritten = rewriteString(str);
          return JSON.parse(rewritten);
        } catch {
          return token;
        }
      }
      return token;
    }) as Prisma.InputJsonValue;
  }

  // Si tokens est une string
  if (typeof tokens === 'string') {
    return rewriteString(tokens) as Prisma.InputJsonValue;
  }

  // Si tokens est un objet
  if (tokens && typeof tokens === 'object') {
    try {
      const str = JSON.stringify(tokens);
      const rewritten = rewriteString(str);
      return JSON.parse(rewritten) as Prisma.InputJsonValue;
    } catch {
      return tokens as Prisma.InputJsonValue;
    }
  }

  return tokens as Prisma.InputJsonValue;
}

// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
// ├Г┬░├Е┬╕├втВм┬Э├втВм┼╛ FONCTION PRINCIPALE DE COPIE
// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р

/**
 * Copie une formule avec r├Г╞Т├В┬й├Г╞Т├В┬йcriture des tokens
 * 
 * PROCESSUS :
 * -----------
 * 1. V├Г╞Т├В┬йrifier le cache (├Г╞Т├В┬йviter doublons)
 * 2. R├Г╞Т├В┬йcup├Г╞Т├В┬йrer la formule originale
 * 3. G├Г╞Т├В┬йn├Г╞Т├В┬йrer le nouvel ID avec suffixe
 * 4. R├Г╞Т├В┬й├Г╞Т├В┬йcrire les tokens (@value.ID ├Г┬в├втВм┬а├втВмтДв @value.ID-suffix)
 * 5. Cr├Г╞Т├В┬йer la nouvelle formule
 * 6. Mettre ├Г╞Т├В┬а jour linkedFormulaIds du n├ГтАж├втВм┼Уud
 * 7. Synchroniser les param├Г╞Т├В┬иtres de capacit├Г╞Т├В┬й
 * 8. Mettre en cache
 * 
 * @param originalFormulaId - ID de la formule ├Г╞Т├В┬а copier
 * @param newNodeId - ID du nouveau n├ГтАж├втВм┼Уud propri├Г╞Т├В┬йtaire
 * @param suffix - Suffixe num├Г╞Т├В┬йrique ├Г╞Т├В┬а appliquer
 * @param prisma - Instance Prisma Client
 * @param options - Options avec nodeIdMap
 * @returns R├Г╞Т├В┬йsultat de la copie
 * 
 * @example
 * const result = await copyFormulaCapacity(
 *   'formula-abc',
 *   'node-xyz-1',
 *   1,
 *   prisma,
 *   { nodeIdMap: new Map([['node-a', 'node-a-1']]) }
 * );
 * // result.newFormulaId = 'formula-abc-1'
 * // result.tokens = ["@value.node-a-1", "+", "5"]
 */
export async function copyFormulaCapacity(
  originalFormulaId: string,
  newNodeId: string,
  suffix: number,
  prisma: PrismaClient,
  options: CopyFormulaOptions = {}
): Promise<CopyFormulaResult> {
  

  const {
    nodeIdMap = new Map(),
    formulaCopyCache = new Map()
  } = options;

  try {
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├В┬Н ├Г╞Т├втВм┬░TAPE 1 : V├Г╞Т├В┬йrifier le cache
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    if (formulaCopyCache.has(originalFormulaId)) {
      const cachedId = formulaCopyCache.get(originalFormulaId)!;
      
      const cached = await prisma.treeBranchLeafNodeFormula.findUnique({
        where: { id: cachedId }
      });
      
      if (cached) {
        return {
          newFormulaId: cached.id,
          nodeId: cached.nodeId,
          tokens: cached.tokens,
          success: true
        };
      }
    }

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┼У├В┬е ├Г╞Т├втВм┬░TAPE 2 : R├Г╞Т├В┬йcup├Г╞Т├В┬йrer la formule originale PAR ID (enlever suffixe si pr├Г╞Т├В┬йsent)
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // originalFormulaId peut contenir un suffixe si c'est d├Г╞Т├В┬йj├Г╞Т├В┬а une copie
    // On enl├Г╞Т├В┬иve le suffixe pour trouver l'original
    const cleanFormulaId = originalFormulaId.replace(/-\d+$/, '');
    
    const originalFormula = await prisma.treeBranchLeafNodeFormula.findUnique({
      where: { id: cleanFormulaId }
    });

    if (!originalFormula) {
      console.error(`├Г┬в├В┬Э├ЕтАЩ Formule introuvable avec id: ${cleanFormulaId}`);
      return {
        newFormulaId: '',
        nodeId: '',
        tokens: null,
        success: false,
        error: `Formule introuvable avec id: ${cleanFormulaId}`
      };
    }


    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬а├втВм┬Э ├Г╞Т├втВм┬░TAPE 3 : G├Г╞Т├В┬йn├Г╞Т├В┬йrer le nouvel ID (pour la formule elle-m├Г╞Т├В┬кme)
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // On utilise l'id original de la formule avec suffixe
    const newFormulaId = `${originalFormula.id}-${suffix}`;

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├В┬з FIX CRITIQUE: D├Г╞Т├В┬йterminer le VRAI propri├Г╞Т├В┬йtaire de la formule copi├Г╞Т├В┬йe
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // Le nodeId pass├Г╞Т├В┬й en param├Г╞Т├В┬иtre peut ├Г╞Т├В┬кtre un n├ГтАж├втВм┼Уud qui R├Г╞Т├втВм┬░F├Г╞Т├втВм┬░RENCE la formule,
    // pas le PROPRI├Г╞Т├втВм┬░TAIRE. Le propri├Г╞Т├В┬йtaire de la copie doit ├Г╞Т├В┬кtre le propri├Г╞Т├В┬йtaire
    // ORIGINAL avec le suffixe appliqu├Г╞Т├В┬й.
    const originalOwnerNodeId = originalFormula.nodeId;
    const correctOwnerNodeId = `${originalOwnerNodeId}-${suffix}`;
    
    // V├Г╞Т├В┬йrifier si le n├ГтАж├втВм┼Уud propri├Г╞Т├В┬йtaire copi├Г╞Т├В┬й existe
    const ownerNodeExists = await prisma.treeBranchLeafNode.findUnique({
      where: { id: correctOwnerNodeId },
      select: { id: true, label: true }
    });
    
    // ЁЯЫбя╕П CRITICAL FIX: TOUJOURS utiliser correctOwnerNodeId pour la formule
    // JAMAIS de fallback sur newNodeId car cela assignerait la formule au mauvais n┼Уud !
    // Si le propri├йtaire n'existe pas encore, on utilise quand m├кme correctOwnerNodeId
    const finalOwnerNodeId = correctOwnerNodeId;
    const ownerNodeExistsForUpdate = !!ownerNodeExists;
    

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├втВм┼╛ ├Г╞Т├втВм┬░TAPE 4 : R├Г╞Т├В┬й├Г╞Т├В┬йcrire les tokens
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    
    // ├Г┬░├Е┬╕├втВм┬Э├В┬е UTILISER LE SYST├Г╞Т├ЛтАаME UNIVERSEL pour traiter TOUS les types de r├Г╞Т├В┬йf├Г╞Т├В┬йrences
    const rewriteMaps: RewriteMaps = {
      nodeIdMap: nodeIdMap,
      formulaIdMap: formulaCopyCache || new Map(),
      conditionIdMap: new Map(), // Pas besoin ici mais requis par l'interface
      tableIdMap: new Map() // Pas besoin ici mais requis par l'interface
    };
    let rewrittenTokens = rewriteJsonReferences(originalFormula.tokens, rewriteMaps, suffix);
    

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├В┬е R├Г╞Т├втВм┬░├Г╞Т├втВм┬░CRITURE FORC├Г╞Т├втВм┬░E DES SHARED-REFS
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // Utiliser la fonction helper pour forcer les suffixes sur TOUS les shared-refs
    const sharedRefsCountBefore = rewrittenTokens && Array.isArray(rewrittenTokens) 
      ? rewrittenTokens.filter((t: any) => typeof t === 'string' && t.includes('shared-ref')).length
      : 0;
    
    rewrittenTokens = forceSharedRefSuffixes(rewrittenTokens, suffix);
    
    const sharedRefsCountAfter1 = rewrittenTokens && Array.isArray(rewrittenTokens) 
      ? rewrittenTokens.filter((t: any) => typeof t === 'string' && t.includes('shared-ref')).length
      : 0;
    
    // ├Г┬░├Е┬╕├втВм┬Э├В┬е R├Г╞Т├втВм┬░├Г╞Т├втВм┬░CRITURE R├Г╞Т├втВм┬░CURSIVE - Appel AUSSI la version JSON pour traiter les structures imbriqu├Г╞Т├В┬йes
    rewrittenTokens = forceSharedRefSuffixesInJson(rewrittenTokens, suffix);
    
    const sharedRefsCountAfter2 = rewrittenTokens && Array.isArray(rewrittenTokens) 
      ? rewrittenTokens.filter((t: any) => typeof t === 'string' && t.includes('shared-ref')).length
      : 0;
    
    if (Array.isArray(rewrittenTokens)) {
      const unsuffixed = rewrittenTokens.filter((t: any) => 
        typeof t === 'string' && t.includes('shared-ref') && !/-\d+$/.test(t)
      );
      if (unsuffixed.length > 0) {
        console.error(`├Г┬в├В┬Э├ЕтАЩ ALERTE: ${unsuffixed.length} shared-refs TOUJOURS non-suffix├Г╞Т├В┬йs:`, unsuffixed);
      } else {
      }
    }

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВмтДв├В┬╛ ├Г╞Т├втВм┬░TAPE 5 : Cr├Г╞Т├В┬йer la nouvelle formule
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├Е┬╜├В┬п COPIE COMPL├Г╞Т├ЛтАаTE: Tous les champs de la formule originale sont copi├Г╞Т├В┬йs
    // - targetProperty: Cible de la formule (valeur, number_max, number_min, visible, etc.)
    // - constraintMessage: Message de contrainte
    // - isDefault: Formule par d├Г╞Т├В┬йfaut
    // - order: Ordre d'affichage
    // ЁЯФД Utiliser upsert pour ├йviter les conflits d'ID (P2002)
    // ЁЯФз FIX COLLISION: Utiliser l'ID de formule dans le nom pour garantir l'unicit├й
    // Plusieurs formules peuvent avoir le m├кme "name" (ex: "Formule") sur des n┼Уuds diff├йrents.
    // Quand elles sont copi├йes sur le M├КME n┼Уud copi├й, leurs noms "Formule-1" entrent en collision.
    // Solution: Inclure les 8 premiers caract├иres de l'ID de la formule originale dans le nom.
    const formulaIdShort = originalFormula.id.substring(0, 8);
    const uniqueName = originalFormula.name 
      ? `${originalFormula.name}-${formulaIdShort}-${suffix}` 
      : `formula-${formulaIdShort}-${suffix}`;

    const newFormula = await prisma.treeBranchLeafNodeFormula.upsert({
      where: { id: newFormulaId },
      update: {
        nodeId: finalOwnerNodeId,
        name: uniqueName,
        description: originalFormula.description,
        tokens: rewrittenTokens,
        targetProperty: originalFormula.targetProperty,
        constraintMessage: originalFormula.constraintMessage,
        isDefault: originalFormula.isDefault,
        order: originalFormula.order,
        updatedAt: new Date()
      },
      create: {
        id: newFormulaId,
        nodeId: finalOwnerNodeId,
        organizationId: originalFormula.organizationId,
        name: uniqueName,
        description: originalFormula.description,
        tokens: rewrittenTokens,
        // ЁЯПп CHAMPS CRITIQUES - Copie de la cible et des propri├йt├йs
        targetProperty: originalFormula.targetProperty,      // тЖТ CIBLE DE LA FORMULE
        constraintMessage: originalFormula.constraintMessage, // тЖТ Message de contrainte
        isDefault: originalFormula.isDefault,                 // тЖТ Formule par d├йfaut
        order: originalFormula.order,                         // тЖТ Ordre d'affichage
        createdAt: new Date(),
        updatedAt: new Date()
      }
    });
    

    
    // ├Г┬░├Е┬╕├втВм┬Э├В┬Н V├Г╞Т├втВм┬░RIFICATION POST-CR├Г╞Т├втВм┬░ATION: Lire imm├Г╞Т├В┬йdiatement ce qui a ├Г╞Т├В┬йt├Г╞Т├В┬й sauvegard├Г╞Т├В┬й
    const savedFormula = await prisma.treeBranchLeafNodeFormula.findUnique({
      where: { id: newFormula.id }
    });
    
    if (savedFormula && Array.isArray(savedFormula.tokens)) {
      const savedSharedRefs = savedFormula.tokens.filter((t: any) => 
        typeof t === 'string' && t.includes('shared-ref')
      );
      const suffixed = savedSharedRefs.filter((s: any) => /-\d+$/.test(s));
      const nonSuffixed = savedSharedRefs.filter((s: any) => !/-\d+$/.test(s));
      
      
      if (nonSuffixed.length > 0) {
        console.error(`├Г┬░├Е┬╕├Е┬б├В┬и ERREUR! Tokens non-suffix├Г╞Т├В┬йs en BD:`, nonSuffixed.slice(0, 2));
      } else {
      }
    }

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├втВмтАЭ ├Г╞Т├втВм┬░TAPE 5 : LIAISON AUTOMATIQUE OBLIGATOIRE
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬в├Е┬б├В┬б UTILISATION DU SYST├Г╞Т├ЛтАаME UNIVERSEL DE LIAISON
    // Cette fonction lie automatiquement la formule ├Г╞Т├В┬а TOUS les n├ГтАж├втВм┼Уuds r├Г╞Т├В┬йf├Г╞Т├В┬йrenc├Г╞Т├В┬йs
    try {
      await linkFormulaToAllNodes(prisma, newFormulaId, rewrittenTokens);
    } catch (e) {
      console.error(`├Г┬в├В┬Э├ЕтАЩ Erreur LIAISON AUTOMATIQUE:`, (e as Error).message);
    }

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├втВмтАЭ ├Г╞Т├втВм┬░TAPE 5B : Mettre ├Г╞Т├В┬а jour linkedFormulaIds du n├ГтАж├втВм┼Уud propri├Г╞Т├В┬йtaire
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // SEULEMENT si le noeud proprietaire existe parmi les noeuds copies
    if (ownerNodeExistsForUpdate) {
      try {
        await addToNodeLinkedField(prisma, finalOwnerNodeId, 'linkedFormulaIds', [newFormulaId]);
      } catch (e) {
        console.warn(`Erreur MAJ linkedFormulaIds du proprietaire:`, (e as Error).message);
      }
    }

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┼У├В┬Э ├Г╞Т├втВм┬░TAPE 7 : Synchroniser les param├Г╞Т├В┬иtres de capacit├Г╞Т├В┬й
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ETAPE 7 : Synchroniser hasFormula/formula_activeId SEULEMENT si proprietaire existe
    if (ownerNodeExistsForUpdate) {
      try {
        await prisma.treeBranchLeafNode.update({
          where: { id: finalOwnerNodeId },
          data: {
            hasFormula: true,
            formula_activeId: newFormulaId,
            formula_name: newFormula.name
          }
        });
      } catch (e) {
        console.warn(`Erreur lors de la mise a jour des parametres capacite:`, (e as Error).message);
      }
    }

    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    // ├Г┬░├Е┬╕├втВм┬Э├втВмтАЭ ├Г╞Т├втВм┬░TAPE 8 : Mettre en cache
    // ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
    formulaCopyCache.set(originalFormulaId, newFormulaId);


    return {
      newFormulaId,
      nodeId: finalOwnerNodeId,
      tokens: rewrittenTokens,
      success: true
    };

  } catch (error) {
    console.error(`├Г┬в├В┬Э├ЕтАЩ Erreur lors de la copie de la formule:`, error);
    return {
      newFormulaId: '',
      nodeId: '',
      tokens: null,
      success: false,
      error: error instanceof Error ? error.message : String(error)
    };
  }
}

// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р
// ├Г┬░├Е┬╕├втВм┬Э├В┬з FONCTIONS UTILITAIRES POUR LINKED FIELDS
// ├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р├Г┬в├втВм┬в├В┬Р

/**
 * Ajoute des IDs ├Г╞Т├В┬а un champ linked... d'un n├ГтАж├втВм┼Уud (sans doublons)
 */
async function addToNodeLinkedField(
  prisma: PrismaClient,
  nodeId: string,
  field: 'linkedFormulaIds' | 'linkedConditionIds' | 'linkedTableIds' | 'linkedVariableIds',
  idsToAdd: string[]
): Promise<void> {
  if (!idsToAdd || idsToAdd.length === 0) return;

  const node = await prisma.treeBranchLeafNode.findUnique({
    where: { id: nodeId },
    select: { [field]: true }
  });

  if (!node) {
    console.warn(`├Г┬в├Е┬б├В┬а├Г┬п├В┬╕├В┬П N├ГтАж├втВм┼Уud ${nodeId} introuvable pour MAJ ${field}`);
    return;
  }

  const current = (node[field] || []) as string[];
  const newIds = [...new Set([...current, ...idsToAdd])]; // D├Г╞Т├В┬йdupliquer

  await prisma.treeBranchLeafNode.update({
    where: { id: nodeId },
    data: { [field]: { set: newIds } }
  });
}
