/**
 * ğŸ¤– useAIAssistant - Hook pour l'assistant IA conversationnel
 * 
 * GÃ¨re le chat IA, l'analyse en temps rÃ©el et les recommandations
 * intelligentes pendant les appels commerciaux
 */

import { useState, useCallback, useEffect, useMemo } from 'react';
import { useAuthenticatedApi } from '../../../hooks/useAuthenticatedApi';
import type { 
  UseAIAssistantReturn,
  AIChatMessage,
  AIAnalysisResult,
  SuggestionContext,
  Lead
} from '../types/CallTypes';

export const useAIAssistant = (
  lead: Lead | null,
  isCallInProgress: boolean
): UseAIAssistantReturn => {
  
  const { api } = useAuthenticatedApi();
  
  // ğŸ’¬ Ã‰tats du chat IA
  const [messages, setMessages] = useState<AIChatMessage[]>([]);
  const [currentAnalysis, setCurrentAnalysis] = useState<AIAnalysisResult | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  
  // ğŸ§  Analyse initiale du profil prospect
  const analyzeProspectProfile = useCallback(async (leadData: Lead) => {
    try {
      setIsAnalyzing(true);
      
      const response = await api.post('/api/ai/analyze-prospect-profile', {
        lead: leadData,
        includeRecommendations: true
      });
      
      if (response.data?.analysis) {
        setCurrentAnalysis(response.data.analysis);
        
        // Ajouter les insights IA au chat
        const analysisMessage: AIChatMessage = {
          id: `analysis-${Date.now()}`,
          type: 'ai',
          message: `ğŸ” **Analyse prospect terminÃ©e !**

ğŸ“Š **Score d'intÃ©rÃªt estimÃ© :** ${response.data.analysis.interestLevel}/100
ï¿½ **Approche recommandÃ©e :** ${response.data.analysis.recommendedApproach}

ğŸ¯ **Points clÃ©s Ã  aborder :**
${response.data.analysis.keyTopics?.map((topic: string) => `â€¢ ${topic}`).join('\n') || 'â€¢ Identifier les besoins'}

âš¡ **StratÃ©gie suggÃ©rÃ©e :**
${response.data.analysis.nextActions?.slice(0, 3).map((action: string) => `â€¢ ${action}`).join('\n') || 'â€¢ Engager la conversation'}`,
          timestamp: new Date(),
          suggestions: response.data.analysis.nextActions || [],
          context: {
            relatedToCall: true,
            priority: 'high',
            category: 'opportunity'
          }
        };
        
        setMessages(prev => [...prev, analysisMessage]);
      }
      
    } catch (error) {
      console.warn('[useAIAssistant] âŒ Endpoint analyse prospect non disponible:', error);
      // Analyse de fallback basique
      setCurrentAnalysis({
        sentiment: 'neutral',
        confidence: 70,
        interestLevel: 50,
        objections: [],
        opportunities: ['Nouveau prospect Ã  qualifier'],
        nextActions: ['Qualifier les besoins', 'PrÃ©senter la solution'],
        recommendedApproach: 'Approche consultative',
        emotionalState: 'neutral',
        keyTopics: [lead?.data?.company || 'Entreprise', lead?.source || 'Source inconnue']
      });
    } finally {
      setIsAnalyzing(false);
    }
  }, [api, lead?.data?.company, lead?.source]);

  // ï¿½ğŸš€ Initialisation de l'assistant IA au dÃ©marrage d'appel
  useEffect(() => {
    if (isCallInProgress && lead && messages.length === 0) {
      const welcomeMessage: AIChatMessage = {
        id: `welcome-${Date.now()}`,
        type: 'ai',
        message: `ğŸ‘‹ Bonjour ! Je suis votre assistant IA pour cet appel avec **${lead.data?.name}**. 

ğŸ¯ **Contexte du prospect :**
â€¢ SociÃ©tÃ© : ${lead.data?.company || 'Particulier'}
â€¢ Source : ${lead.source}
â€¢ Statut : ${lead.status}

Je vais analyser la conversation en temps rÃ©el et vous donner des conseils personnalisÃ©s pour maximiser vos chances de succÃ¨s !`,
        timestamp: new Date(),
        suggestions: [
          'ğŸ¤ Commencer par le script personnalisÃ©',
          'â“ Poser des questions qualifiantes',
          'ğŸ¯ Identifier les besoins spÃ©cifiques',
          'ğŸ“… PrÃ©parer la proposition de RDV'
        ],
        context: {
          relatedToCall: true,
          priority: 'high',
          category: 'advice'
        }
      };
      
      setMessages([welcomeMessage]);
      
      // ğŸ“Š DÃ©marrer l'analyse IA du prospect
      analyzeProspectProfile(lead);
    }
  }, [isCallInProgress, lead, messages.length, analyzeProspectProfile]);

  // ğŸ’¬ Fonction pour gÃ©nÃ©rer une rÃ©ponse IA
  const generateResponse = useCallback(async (userMessage: string) => {
    console.log('[useAIAssistant] ğŸš€ DÃ‰BUT generateResponse avec message:', userMessage);
    console.log('[useAIAssistant] ğŸ” Lead actuel:', lead);
    console.log('[useAIAssistant] ğŸ“ Messages actuels:', messages.length);
    
    try {
      console.log('[useAIAssistant] â³ DÃ©but de l\'analyse IA...');
      setIsAnalyzing(true);
      
      console.log('[useAIAssistant] ğŸ“¡ Tentative d\'appel API /api/ai/generate-response...');
      const response = await api.post('/api/ai/generate-response', {
        message: userMessage,
        lead,
        context: messages.slice(-5),
        analysis: currentAnalysis
      });
      
      console.log('[useAIAssistant] âœ… RÃ©ponse API reÃ§ue:', response);
      
      // VÃ©rifier si l'API a rÃ©pondu avec succÃ¨s
      if (response.data?.response) {
        console.log('[useAIAssistant] ğŸ’¬ CrÃ©ation du message IA avec rÃ©ponse:', response.data.response);
        const aiMessage: AIChatMessage = {
          id: `ai-${Date.now()}`,
          type: 'ai',
          message: response.data.response,
          timestamp: new Date(),
          suggestions: response.data.suggestions || [],
          context: {
            relatedToCall: true,
            priority: 'medium',
            category: 'response'
          }
        };
        
        console.log('[useAIAssistant] ğŸ“¨ Ajout du message IA au chat:', aiMessage);
        setMessages(prev => [...prev, aiMessage]);
        console.log('[useAIAssistant] âœ… Message IA ajoutÃ© avec succÃ¨s !');
      } else {
        console.warn('[useAIAssistant] âš ï¸ Aucune rÃ©ponse dans response.data:', response.data);
        console.log('[useAIAssistant] ğŸ”„ API non disponible - Activation du fallback intelligent...');
        
        // Activer le fallback car l'API n'a pas de rÃ©ponse valide
        throw new Error('API unavailable - activating fallback');
      }
      
    } catch (error) {
      console.error('[useAIAssistant] âŒ ERREUR API - Passage au fallback intelligent:', error);
      console.log('[useAIAssistant] ğŸ”„ DÃ©but du fallback intelligent...');
      
      // Analyse du message utilisateur pour une rÃ©ponse de collÃ¨gue IA
      const lowerMessage = userMessage.toLowerCase();
      console.log('[useAIAssistant] ğŸ” Message en minuscules pour analyse:', lowerMessage);
      let aiResponse = '';
      let suggestions: string[] = [];
      
      console.log('[useAIAssistant] ğŸ¤– GÃ©nÃ©ration de rÃ©ponse collÃ¨gue IA...');
      
      // ğŸ¯ SYSTÃˆME DE COLLÃˆGUE IA INTELLIGENT - Naturel mais orientÃ© business
      
      // === SALUTATIONS ET OUVERTURE ===
      if (lowerMessage.includes('salut') || lowerMessage.includes('bonjour') || lowerMessage.includes('hello') || lowerMessage.includes('coucou')) {
        const greetings = [
          `Hey ! ğŸ‘‹ PrÃªt pour cette conversation avec ${lead?.data?.name || 'ce prospect'} ? J'ai quelques idÃ©es pour bien commencer !`,
          `Salut mon pote ! ğŸ˜Š On va cartonner avec ${lead?.data?.name || 'ce lead'} aujourd'hui. Par oÃ¹ on commence ?`,
          `Hello ! ğŸš€ Je suis lÃ  pour t'Ã©pauler sur cet appel. ${lead?.data?.name || 'Ce prospect'} a l'air intÃ©ressant !`
        ];
        aiResponse = greetings[Math.floor(Math.random() * greetings.length)];
        suggestions = ['Analyser ce prospect', 'PrÃ©parer mon pitch', 'Script d\'ouverture', 'GÃ©rer les objections'];
      }
      
      // === QUESTIONS MÃ‰TÃ‰O/PERSONNELLES (pivot vers business) ===
      else if (lowerMessage.includes('mÃ©tÃ©o') || lowerMessage.includes('temps') || lowerMessage.includes('pluie') || lowerMessage.includes('soleil')) {
        const weatherResponses = [
          `Ah oui, ${lowerMessage.includes('pluie') ? 'il pleut' : 'beau temps'} aujourd'hui ! ğŸŒ¤ï¸ C'est parfait pour les appels - les gens sont plus disponibles. Au fait, tu as vu l'heure de ${lead?.data?.name || 'ton prospect'} ? C'est le bon moment !`,
          `Ouais le temps est ${lowerMessage.includes('pluie') ? 'pourri' : 'gÃ©nial'} ! ï¿½ Ã‡a me rappelle que ${lead?.data?.name || 'ton lead'} bosse dans le ${lead?.data?.company || 'business'} - peut-Ãªtre qu'on peut utiliser Ã§a comme ice-breaker ?`
        ];
        aiResponse = weatherResponses[Math.floor(Math.random() * weatherResponses.length)];
        suggestions = ['Ice-breaker mÃ©tÃ©o', 'Commencer l\'appel', 'Parler de son secteur', 'Script personnalisÃ©'];
      }
      
      // === QUESTIONS SPORT/LOISIRS (pivot vers business) ===
      else if (lowerMessage.includes('foot') || lowerMessage.includes('sport') || lowerMessage.includes('match') || lowerMessage.includes('weekend')) {
        const sportResponses = [
          `Ah tu suis le foot ? âš½ Moi aussi ! D'ailleurs, l'esprit d'Ã©quipe c'est crucial en business. ${lead?.data?.name || 'Ton prospect'} a peut-Ãªtre cette mentalitÃ© aussi ?`,
          `Le sport c'est la vie ! ï¿½â€â™‚ï¸ Ã‡a me fait penser que ${lead?.data?.name || 'ce lead'} a l'air dynamique aussi. On va matcher son Ã©nergie dans l'appel !`,
          `Weekend sportif ? ğŸ˜ Parfait pour avoir la pÃªche ! ${lead?.data?.name || 'Ce prospect'} va sentir ton Ã©nergie positive dÃ¨s les premiÃ¨res secondes !`
        ];
        aiResponse = sportResponses[Math.floor(Math.random() * sportResponses.length)];
        suggestions = ['Parler de dynamisme', 'Ã‰nergie positive', 'Esprit d\'Ã©quipe', 'Matcher son Ã©nergie'];
      }
      
      // === QUESTIONS NOURRITURE/CAFÃ‰ (pivot vers business) ===
      else if (lowerMessage.includes('cafÃ©') || lowerMessage.includes('manger') || lowerMessage.includes('bouffe') || lowerMessage.includes('dÃ©jeuner')) {
        const foodResponses = [
          `Un bon cafÃ©, Ã§a c'est essentiel ! â˜• Tu sais quoi ? Une invitation cafÃ© c'est souvent la meilleure faÃ§on de closer un RDV avec ${lead?.data?.name || 'un prospect'} !`,
          `Miam ! ğŸ• Au fait, tu as vu si ${lead?.data?.name || 'ton lead'} bosse prÃ¨s d'un bon resto ? Ã‡a peut Ãªtre un super spot pour un meeting !`,
          `Le cafÃ© Ã§a rÃ©veille ! â˜• Parfait timing pour appeler ${lead?.data?.name || 'ce prospect'} - il/elle sera sÃ»rement en forme aussi !`
        ];
        aiResponse = foodResponses[Math.floor(Math.random() * foodResponses.length)];
        suggestions = ['Proposer un cafÃ©', 'RDV restaurant', 'Meeting physique', 'Closer un RDV'];
      }
      
      // === QUESTIONS TECH/DIGITAL (lien naturel business) ===
      else if (lowerMessage.includes('tech') || lowerMessage.includes('digital') || lowerMessage.includes('app') || lowerMessage.includes('site')) {
        const techResponses = [
          `La tech c'est fou comme Ã§a Ã©volue ! ğŸ’» D'ailleurs, ${lead?.data?.company || 'l\'entreprise de ton prospect'} utilise peut-Ãªtre des outils qu'on propose ?`,
          `Ouais le digital c'est dingue ! ğŸš€ ${lead?.data?.name || 'Ton lead'} bosse dans un secteur qui digitalise beaucoup en ce moment ?`,
          `Les apps c'est ma passion ! ğŸ“± Ã‡a tombe bien, on peut sÃ»rement aider ${lead?.data?.name || 'ce prospect'} Ã  optimiser ses process digitaux !`
        ];
        aiResponse = techResponses[Math.floor(Math.random() * techResponses.length)];
        suggestions = ['Parler de digitalisation', 'Process optimization', 'Outils tech', 'Modernisation'];
      }
      
      // === QUESTIONS SUR LE PROSPECT ===
      else if (lowerMessage.includes('marie') || lowerMessage.includes('prospect') || lowerMessage.includes('client') || lowerMessage.includes('lead')) {
        aiResponse = `ğŸ¯ Alors, ${lead?.data?.name || 'ce prospect'} ! Voici ce que j'ai :

**Profile :**
â€¢ ${lead?.data?.name || 'Nom non renseignÃ©'} ${lead?.data?.company ? `chez ${lead?.data?.company}` : ''}
â€¢ ${lead?.data?.email || 'Email Ã  rÃ©cupÃ©rer'}
â€¢ Source : ${lead?.source || 'Direct'}
â€¢ Statut : ${lead?.status || 'Nouveau'}

**Mon analyse :** ${lead?.data?.company ? 'Belle boÃ®te' : 'Prospect intÃ©ressant'}, ${lead?.data?.name ? 'contact qualifiÃ©' : 'Ã  qualifier'}. Je sens du potentiel ! ğŸ’ª

Quelle approche tu veux tenter ?`;
        suggestions = ['Analyse SWOT', 'Points de douleur', 'Approche personnalisÃ©e', 'Script sur-mesure'];
      }
      
      // === AIDE BUSINESS/VENTE ===
      else if (lowerMessage.includes('vente') || lowerMessage.includes('vendre') || lowerMessage.includes('closer') || lowerMessage.includes('pitch')) {
        const salesResponses = [
          `Alors lÃ  tu parles ma langue ! ğŸ’° Pour ${lead?.data?.name || 'ce prospect'}, je vois plusieurs angles d'attaque. On mise sur quoi ?`,
          `Vendre c'est un art ! ğŸ¨ Avec ${lead?.data?.name || 'ce lead'}, l'approche consultative sera parfaite. Tu veux qu'on prÃ©pare ?`,
          `Oh yeah, mode warrior ! âš”ï¸ ${lead?.data?.name || 'Ce prospect'} va pas savoir ce qui l'a frappÃ© ! On structure ton approche ?`
        ];
        aiResponse = salesResponses[Math.floor(Math.random() * salesResponses.length)];
        suggestions = ['Structure de vente', 'Objections courantes', 'Closing techniques', 'Follow-up strategy'];
      }
      
      // === QUESTIONS OBJECTIONS ===
      else if (lowerMessage.includes('objection') || lowerMessage.includes('pas intÃ©ressÃ©') || lowerMessage.includes('trop cher') || lowerMessage.includes('dÃ©jÃ  un fournisseur')) {
        const objectionResponses = [
          `Ah les objections ! ğŸ›¡ï¸ Mon domaine de prÃ©dilection ! Pour "${lowerMessage}", j'ai 3-4 parades qui marchent Ã  tous les coups !`,
          `Les objections c'est des opportunitÃ©s dÃ©guisÃ©es ! ï¿½ Celle-lÃ , je l'ai vue 1000 fois. Laisse-moi te montrer comment la retourner !`,
          `Perfect ! ğŸ¯ Cette objection, c'est actually un signal d'achat cachÃ©. Je t'explique la technique ninja ?`
        ];
        aiResponse = objectionResponses[Math.floor(Math.random() * objectionResponses.length)];
        suggestions = ['Technique du boomerang', 'Reformulation positive', 'Question retour', 'Proof social'];
      }
      
      // === MOTIVATION/MORAL ===
      else if (lowerMessage.includes('fatigue') || lowerMessage.includes('dur') || lowerMessage.includes('difficile') || lowerMessage.includes('compliquÃ©')) {
        const motivationResponses = [
          `Hey, on a tous des jours comme Ã§a ! ğŸ’ª Mais tu sais quoi ? ${lead?.data?.name || 'Ce prospect'} va te redonner le smile ! Allez, on y va !`,
          `Fatigue de warrior ! ğŸ˜¤ C'est normal, tu donnes tout ! ${lead?.data?.name || 'Ce lead'} va Ãªtre ta victoire du jour, j'en suis sÃ»r !`,
          `Dur dur... ğŸ˜“ Mais regarde, ${lead?.data?.name || 'ce prospect'} c'est peut-Ãªtre LE contrat qui va tout changer ! On tente le coup ?`
        ];
        aiResponse = motivationResponses[Math.floor(Math.random() * motivationResponses.length)];
        suggestions = ['Boost de motivation', 'Techniques Ã©nergie', 'Mindset gagnant', 'Quick win'];
      }
      
      // === STRATÃ‰GIE/PLANNING ===
      else if (lowerMessage.includes('stratÃ©gie') || lowerMessage.includes('plan') || lowerMessage.includes('comment') || lowerMessage.includes('approche')) {
        aiResponse = `ğŸ§  Mode stratÃ¨ge activÃ© ! Pour ${lead?.data?.name || 'ce prospect'}, voici ma roadmap :

**Phase 1 :** Ice-breaker + qualification
**Phase 2 :** Identification besoins/douleurs  
**Phase 3 :** PrÃ©sentation solution ciblÃ©e
**Phase 4 :** Gestion objections
**Phase 5 :** Closing + next steps

Ã‰tape par Ã©tape, on assure ! Sur quelle phase tu veux qu'on se concentre ?`;
        suggestions = ['Phase 1 - Opening', 'Phase 2 - Discovery', 'Phase 3 - Pitch', 'Phase 5 - Closing'];
      }
      
      // === DEFAULT - OUVERT Ã€ TOUT MAIS RECENTRAGE SUBTIL ===
      else {
        const defaultResponses = [
          `Interessant ! Au fait, pendant qu'on discute, ${lead?.data?.name || 'ton prospect'} attend peut-etre ton appel ? On s'y met ?`,
          `Ah ok ! Dis-moi, pour ${lead?.data?.name || 'ce lead'}, tu as une approche en tete ou on brainstorme ensemble ?`,
          `Je vois ! Ca me fait penser que ${lead?.data?.name || 'ce prospect'} pourrait avoir le meme point de vue. On teste ca dans l'appel ?`,
          `Hmm ! D'ailleurs, avec ${lead?.data?.name || 'ton lead'}, tu penses partir sur quel angle ? J'ai quelques idees !`
        ];
        aiResponse = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        suggestions = ['Lancer l\'appel', 'Preparer l\'approche', 'Angle d\'attaque', 'Brainstorm ideas'];
      }
      
      console.log('[useAIAssistant] Reponse generee:', aiResponse);
      
      console.log('[useAIAssistant] Reponse generee:', aiResponse);
      
      // Creer le message de reponse IA
      const fallbackMessage: AIChatMessage = {
        id: `ai-fallback-${Date.now()}`,
        type: 'ai',
        message: aiResponse,
        timestamp: new Date(),
        suggestions: suggestions,
        context: {
          relatedToCall: true,
          priority: 'medium',
          category: 'conversational'
        }
      };
      
      console.log('[useAIAssistant] ğŸ“¨ Ajout du message fallback au chat:', fallbackMessage);
      setMessages(prev => [...prev, fallbackMessage]);
      console.log('[useAIAssistant] âœ… Message fallback ajoute avec succes !');
    }
    
    console.log('[useAIAssistant] ï¿½ Fin de generateResponse - setIsAnalyzing(false)');
    setIsAnalyzing(false);
          
          `Excellente question ! Avec ${lead?.data?.company || 'cette entreprise'}, il faut surtout montrer de la valeur dÃ¨s les premiÃ¨res secondes. Que souhaitez-vous aborder ?`,
          
          `Je comprends ! L'appel avec ${lead?.data?.name || 'ce prospect'} demande une prÃ©paration spÃ©cifique. Sur quoi puis-je vous aider ?`,
          
          `Bonne idÃ©e ! Pour optimiser cet appel, je peux vous aider sur plusieurs aspects. Qu'est-ce qui vous prÃ©occupe le plus ?`,
          
          `C'est notÃ© ! ${lead?.data?.name || 'Ce prospect'} mÃ©rite une approche rÃ©flÃ©chie. CommenÃ§ons par quoi ?`
        ];
        
        // SÃ©lectionner une rÃ©ponse alÃ©atoire pour varier
        aiResponse = responses[Math.floor(Math.random() * responses.length)];
        
        suggestions = [
          'Analyser ce prospect en dÃ©tail',
          'PrÃ©parer mon script d\'ouverture',
          'Anticiper les objections',
          'Techniques de persuasion'
        ];
      }
      
      console.log('[useAIAssistant] ğŸ¯ RÃ©ponse gÃ©nÃ©rÃ©e:', aiResponse);
      console.log('[useAIAssistant] ğŸ’¡ Suggestions gÃ©nÃ©rÃ©es:', suggestions);
      
      const fallbackMessage: AIChatMessage = {
        id: `ai-smart-${Date.now()}`,
        type: 'ai',
        message: aiResponse,
        timestamp: new Date(),
        suggestions,
        context: {
          relatedToCall: true,
          priority: 'high',
          category: 'advice'
        }
      };
      
      console.log('[useAIAssistant] ğŸ“¨ CrÃ©ation du message fallback:', fallbackMessage);
      console.log('[useAIAssistant] ğŸ”„ Ajout au chat...');
      setMessages(prev => {
        console.log('[useAIAssistant] ğŸ“ Messages prÃ©cÃ©dents:', prev.length);
        const newMessages = [...prev, fallbackMessage];
        console.log('[useAIAssistant] ğŸ“ Nouveaux messages:', newMessages.length);
        return newMessages;
      });
      console.log('[useAIAssistant] âœ… Message fallback ajoutÃ© avec succÃ¨s !');
    } finally {
      console.log('[useAIAssistant] ğŸ Fin de generateResponse - setIsAnalyzing(false)');
      setIsAnalyzing(false);
    }
  }, [api, lead, messages, currentAnalysis]);

  // ğŸ’¬ Envoyer un message Ã  l'IA
  const sendMessage = useCallback(async (userMessage: string): Promise<void> => {
    console.log('[useAIAssistant] ğŸš€ DÃ‰BUT sendMessage avec:', userMessage);
    console.log('[useAIAssistant] ğŸ” Message trimmed:', userMessage.trim());
    console.log('[useAIAssistant] ğŸ” Lead prÃ©sent:', !!lead);
    
    if (!userMessage.trim() || !lead) {
      console.warn('[useAIAssistant] âš ï¸ ABANDON sendMessage - Message vide ou lead manquant');
      return;
    }
    
    console.log('[useAIAssistant] ğŸ‘¤ CrÃ©ation du message utilisateur...');
    // Ajouter le message utilisateur
    const userMsg: AIChatMessage = {
      id: `user-${Date.now()}`,
      type: 'user',
      message: userMessage,
      timestamp: new Date()
    };
    
    console.log('[useAIAssistant] ğŸ“¨ Ajout du message utilisateur au chat:', userMsg);
    setMessages(prev => {
      console.log('[useAIAssistant] ğŸ“ Messages prÃ©cÃ©dents avant ajout user:', prev.length);
      const newMessages = [...prev, userMsg];
      console.log('[useAIAssistant] ğŸ“ Messages aprÃ¨s ajout user:', newMessages.length);
      return newMessages;
    });
    
    console.log('[useAIAssistant] ğŸ¤– Appel de generateResponse...');
    // Utiliser generateResponse pour traiter le message
    await generateResponse(userMessage);
    console.log('[useAIAssistant] ğŸ sendMessage terminÃ©');
  }, [lead, generateResponse]);

  // ğŸ—‘ï¸ Vider le chat
  const clearChat = useCallback((): void => {
    setMessages([]);
    setCurrentAnalysis(null);
  }, []);

  // ï¿½ Fonction pour dÃ©marrer l'Ã©coute vocale
  const startListening = useCallback(() => {
    console.log('[useAIAssistant] ğŸ¤ DÃ©marrage de l\'Ã©coute vocale...');
    // Cette fonction sera appelÃ©e par le composant VoiceTranscription
    // Elle peut Ãªtre utilisÃ©e pour dÃ©clencher d'autres actions IA
  }, []);

  //  Fonction pour obtenir des suggestions contextuelles
  const getSuggestions = useCallback(async (context: SuggestionContext) => {
    try {
      console.log('[useAIAssistant] ğŸ’¡ GÃ©nÃ©ration de suggestions...', context);
      
      const response = await api.post('/api/ai/get-suggestions', {
        lead,
        callContext: context,
        currentAnalysis,
        conversationHistory: messages.slice(-3)
      });
      
      if (response.data?.suggestions) {
        return response.data.suggestions;
      }
      
      // Suggestions par dÃ©faut si l'API ne rÃ©pond pas
      return [
        'Demander des dÃ©tails sur les besoins',
        'Proposer une dÃ©monstration',
        'Fixer un rendez-vous de suivi',
        'Clarifier le budget disponible'
      ];
      
    } catch (error) {
      console.warn('[useAIAssistant] âŒ Endpoint suggestions non disponible:', error);
      
      // Suggestions de fallback basÃ©es sur le contexte
      const fallbackSuggestions = context.currentPhase === 'opening' 
        ? [
            'Saluer chaleureusement le prospect',
            'Se prÃ©senter et prÃ©senter l\'entreprise',
            'Expliquer le motif de l\'appel',
            'Demander si c\'est le bon moment'
          ]
        : context.currentPhase === 'discovery'
        ? [
            'Poser des questions sur les besoins',
            'Comprendre les dÃ©fis actuels',
            'Identifier les dÃ©cideurs',
            'Ã‰valuer le budget disponible'
          ]
        : [
            'Continuer la conversation',
            'Poser des questions ouvertes',
            'Ã‰couter les objections',
            'Proposer des solutions adaptÃ©es'
          ];
      
      return fallbackSuggestions;
    }
  }, [api, lead, currentAnalysis, messages]);

  // ï¿½ğŸ™ï¸ Analyser la transcription vocale en temps rÃ©el
  const analyzeVoiceTranscription = useCallback(async (
    transcription: string,
    speaker: 'agent' | 'prospect'
  ): Promise<void> => {
    if (!transcription.trim() || transcription.length < 20) return;
    
    try {
      setIsAnalyzing(true);
      
      const response = await api.post('/api/ai/analyze-voice-transcription', {
        transcription,
        speaker,
        lead,
        currentAnalysis,
        conversationContext: messages.slice(-5)
      });
      
      if (response.data?.analysis) {
        setCurrentAnalysis(response.data.analysis);
        
        // Ajouter insights IA si importants
        if (response.data.analysis.opportunities?.length > 0) {
          const opportunityMsg: AIChatMessage = {
            id: `opportunity-${Date.now()}`,
            type: 'ai',
            message: `ğŸ¯ **OpportunitÃ© dÃ©tectÃ©e !**

${response.data.analysis.opportunities[0]}

ğŸ’¡ **Actions recommandÃ©es :**
${response.data.analysis.nextActions?.slice(0, 2).join('\nâ€¢ ') || 'Continuer l\'exploration'}`,
            timestamp: new Date(),
            suggestions: response.data.analysis.nextActions || [],
            context: {
              relatedToCall: true,
              priority: 'high',
              category: 'opportunity'
            }
          };
          
          setMessages(prev => [...prev, opportunityMsg]);
        }
        
        // Alertes si objections dÃ©tectÃ©es
        if (response.data.analysis.objections?.length > 0) {
          const objectionMsg: AIChatMessage = {
            id: `objection-${Date.now()}`,
            type: 'ai',
            message: `âš ï¸ **Objection identifiÃ©e :**

"${response.data.analysis.objections[0]}"

ğŸ›¡ï¸ **RÃ©ponse suggÃ©rÃ©e :**
${response.data.analysis.recommendedApproach}`,
            timestamp: new Date(),
            suggestions: [
              'Reformuler la valeur ajoutÃ©e',
              'Poser une question de clarification',
              'Proposer un exemple concret'
            ],
            context: {
              relatedToCall: true,
              priority: 'high',
              category: 'warning'
            }
          };
          
          setMessages(prev => [...prev, objectionMsg]);
        }
      }
      
    } catch (error) {
      console.error('[useAIAssistant] âŒ Erreur analyse transcription:', error);
    } finally {
      setIsAnalyzing(false);
    }
  }, [api, lead, currentAnalysis, messages]);

  // ğŸ“Š Score de confiance global
  const overallConfidence = useMemo(() => {
    if (!currentAnalysis) return 0;
    return Math.round(
      (currentAnalysis.confidence + currentAnalysis.interestLevel) / 2
    );
  }, [currentAnalysis]);

  // ğŸ¯ Retour du hook
  const returnValue: UseAIAssistantReturn = useMemo(() => ({
    messages,
    sendMessage,
    currentAnalysis,
    isAnalyzing,
    isLoading: isAnalyzing, // Alias pour compatibilitÃ© avec le composant
    clearChat,
    generateResponse,
    startListening,
    getSuggestions
  }), [
    messages,
    sendMessage,
    currentAnalysis,
    isAnalyzing,
    clearChat,
    generateResponse,
    startListening,
    getSuggestions
  ]);

  // ğŸ”Œ Interface pour les hooks parents
  const extendedReturn = useMemo(() => ({
    ...returnValue,
    analyzeVoiceTranscription,
    overallConfidence,
    hasActiveConversation: messages.length > 1,
    lastAIMessage: messages.filter(m => m.type === 'ai').pop(),
    pendingSuggestions: messages
      .filter(m => m.type === 'ai' && m.suggestions?.length)
      .flatMap(m => m.suggestions || [])
      .slice(-5) // 5 derniÃ¨res suggestions
  }), [returnValue, analyzeVoiceTranscription, overallConfidence, messages]);

  return extendedReturn;
};

export default useAIAssistant;
