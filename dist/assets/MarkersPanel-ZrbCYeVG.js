import{j as e}from"./index-C0S0DpaX.js";import{r}from"./react-vendor-Al_k-ZB6.js";import{u as a}from"./useAuthenticatedApi-BbQI8SDU.js";import{u as s}from"./TreeBranchLeafWrapper-Bsu92XNs.js";import{s as n,$ as t,ab as i,a as l,T as o,an as c,B as m,a0 as d,I as p}from"./antd-vendor-zFcGztvE.js";import"./dnd-vendor-D0spq1w0.js";const{Title:u,Text:b}=o,h=({treeId:h,nodeId:f,value:v,onChange:k,readOnly:D})=>{const{api:N}=a(),[x,C]=r.useState([]),[M,E]=r.useState(()=>(null==v?void 0:v.markerIds)||[]),[P,y]=r.useState(!1),[V,w]=r.useState([]),[S,g]=r.useState(null),[A,T]=r.useState("");r.useEffect(()=>{let e=!0;return(async()=>{try{if(y(!0),!v||!Array.isArray(v.markerIds)){const r=await N.get(`/api/treebranchleaf/nodes/${f}/markers`),a=Array.isArray(r)?r.map(e=>"string"==typeof e?e:e.id||e.markerId||"").filter(Boolean):[];e&&E(a),null==k||k({...v||{},markerIds:a})}const r=await N.get(`/api/treebranchleaf/nodes/${f}/markers/available`);e&&Array.isArray(r)&&C(r)}catch{}finally{e&&y(!1)}})(),()=>{e=!1}},[N,f,k,v]),r.useEffect(()=>{let e=!0;return(async()=>{var r,a;try{const s=await N.get(`/api/treebranchleaf/nodes/${f}`),n=(null==(a=null==(r=null==s?void 0:s.metadata)?void 0:r.capabilities)?void 0:a.markers)||[];if(!e)return;if(n.length>0)w(n),g(n[0].id),E(n[0].markerIds||[]),T(n[0].name||""),null==k||k({...v||{},markerIds:n[0].markerIds||[]});else{const e={id:`markers_${Date.now()}`,name:"Marqueurs 1",markerIds:M||[]};if(w([e]),g(e.id),T(e.name),h)try{const r=(null==s?void 0:s.metadata)||{},a={...r,capabilities:{...r.capabilities,markers:[e]}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:a})}catch{}}}catch{}})(),()=>{e=!1}},[N,f,k,M,h,v]);const B=r.useCallback(async e=>{try{await N.put(`/api/treebranchleaf/nodes/${f}/markers`,{markerIds:e}),null==k||k({...v||{},markerIds:e})}catch{n.error("Erreur de sauvegarde des marqueurs")}},[N,f,k,v]),j=s(B,400),I=r.useCallback(e=>{E(e),j(e)},[j]);r.useEffect(()=>{(async()=>{var e;if(h&&S)try{const r=await N.get(`/api/treebranchleaf/nodes/${f}`),a=(null==r?void 0:r.metadata)||{},s=((null==(e=a.capabilities)?void 0:e.markers)||V||[]).map(e=>e.id===S?{...e,markerIds:M,name:A}:e),n={...a,capabilities:{...a.capabilities,markers:s}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:n}),w(s)}catch{}})()},[S,N,f,M,h,A,V]);const O=r.useMemo(()=>(x||[]).map(r=>({label:e.jsxDEV(t,{size:6,children:[e.jsxDEV("span",{children:r.icon||"üè∑Ô∏è"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:129,columnNumber:11},void 0),e.jsxDEV("span",{children:r.name},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:130,columnNumber:11},void 0),r.category?e.jsxDEV(i,{color:"default",style:{marginInlineStart:6},children:r.category},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:131,columnNumber:25},void 0):null]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:128,columnNumber:9},void 0),value:r.id})),[x]),L=r.useMemo(()=>{const e=new Map(x.map(e=>[e.id,e]));return M.map(r=>e.get(r)).filter(Boolean)},[x,M]);return e.jsxDEV(l,{size:"small",bordered:!0,loading:P,children:[e.jsxDEV(u,{level:5,children:"üìç Marqueurs"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:145,columnNumber:7},void 0),e.jsxDEV("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxDEV(o.Text,{type:"secondary",children:"Instance:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:148,columnNumber:9},void 0),e.jsxDEV(c,{size:"small",style:{minWidth:220},value:S||void 0,options:V.map(e=>({value:e.id,label:e.name||"Sans nom"})),onChange:e=>{g(e);const r=V.find(r=>r.id===e);r&&(E(r.markerIds||[]),T(r.name||""))},placeholder:"S√©lectionner une instance"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:149,columnNumber:9},void 0),e.jsxDEV(m,{size:"small",onClick:async()=>{var e;const r=`markers_${Date.now()}_${Math.floor(1e3*Math.random())}`,a={id:r,name:`Marqueurs ${(V.length||0)+1}`,markerIds:[]},s=[...V,a];if(w(s),g(r),E([]),T(a.name),h)try{const r=await N.get(`/api/treebranchleaf/nodes/${f}`),s=(null==r?void 0:r.metadata)||{},n=(null==(e=s.capabilities)?void 0:e.markers)||[],t={...s,capabilities:{...s.capabilities,markers:[...n,a]}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:t})}catch{}},children:"Ajouter"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:161,columnNumber:9},void 0),e.jsxDEV(m,{size:"small",danger:!0,onClick:()=>{d.confirm({title:"Supprimer les marqueurs ?",content:"Cette action vide la configuration et d√©sactive la capacit√©.",okText:"Supprimer",okButtonProps:{danger:!0},cancelText:"Annuler",onOk:async()=>{var e;try{await N.put(`/api/treebranchleaf/nodes/${f}/markers`,{markerIds:[]});try{await N.put(`/api/treebranchleaf/nodes/${f}`,{hasMarkers:!1})}catch{}if(h&&S)try{const r=await N.get(`/api/treebranchleaf/nodes/${f}`),a=(null==r?void 0:r.metadata)||{},s=((null==(e=a.capabilities)?void 0:e.markers)||V||[]).filter(e=>e.id!==S),n={...a,capabilities:{...a.capabilities,markers:s}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:n}),w(s);const t=s[0]||null;g(t?t.id:null),t?(E(t.markerIds||[]),T(t.name||"")):(E([]),T(""))}catch{}else E([]),T("");null==k||k({...v||{},markerIds:[]}),n.success("Marqueurs supprim√©s")}catch{n.error("Impossible de supprimer les marqueurs")}}})},disabled:!S,children:"Supprimer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:179,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:147,columnNumber:7},void 0),e.jsxDEV("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxDEV(o.Text,{type:"secondary",children:"Nom:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:225,columnNumber:9},void 0),e.jsxDEV(p,{size:"small",style:{maxWidth:280},placeholder:"Nom de l'ensemble de marqueurs",value:A,onChange:e=>{const r=e.target.value;T(r)}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:226,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:224,columnNumber:7},void 0),e.jsxDEV("div",{style:{marginBottom:8},children:e.jsxDEV(m,{size:"small",danger:!0,onClick:()=>{d.confirm({title:"Supprimer les marqueurs ?",content:"Cette action vide la configuration et d√©sactive la capacit√©.",okText:"Supprimer",okButtonProps:{danger:!0},cancelText:"Annuler",onOk:async()=>{try{await N.put(`/api/treebranchleaf/nodes/${f}/markers`,{markerIds:[]});try{await N.put(`/api/treebranchleaf/nodes/${f}`,{hasMarkers:!1})}catch{}E([]),null==k||k({...v||{},markerIds:[]}),n.success("Marqueurs supprim√©s")}catch{n.error("Impossible de supprimer les marqueurs")}}})},children:"Supprimer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:238,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:237,columnNumber:7},void 0),e.jsxDEV(c,{mode:"multiple",allowClear:!0,style:{width:"100%"},placeholder:"S√©lectionnez des marqueurs disponibles",options:O,value:M,onChange:I,disabled:D,optionFilterProp:"label"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:259,columnNumber:7},void 0),e.jsxDEV("div",{style:{height:8}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:270,columnNumber:7},void 0),e.jsxDEV(b,{type:"secondary",style:{fontSize:12},children:"Les marqueurs disponibles proviennent de votre organisation et/ou de l‚Äôarbre."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:271,columnNumber:7},void 0),L.length>0&&e.jsxDEV("div",{style:{marginTop:12,display:"flex",flexWrap:"wrap",gap:6},children:L.map(r=>e.jsxDEV(i,{color:r.color,bordered:!r.color,children:e.jsxDEV(t,{size:6,children:[e.jsxDEV("span",{children:r.icon||"üè∑Ô∏è"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:279,columnNumber:17},void 0),e.jsxDEV("span",{children:r.name},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:280,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:278,columnNumber:15},void 0)},r.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:277,columnNumber:13},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:275,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/MarkersPanel.tsx",lineNumber:144,columnNumber:5},void 0)};export{h as default};
