import{j as e}from"./index-C0S0DpaX.js";import{r as a}from"./react-vendor-Al_k-ZB6.js";import{T as r}from"./TokenDropZone-DC6IWn53.js";import{u as n}from"./useAuthenticatedApi-BbQI8SDU.js";import{u as i}from"./TreeBranchLeafWrapper-Bsu92XNs.js";import{s as t,a0 as s,a as o,T as l,an as c,B as m,I as d,$ as p}from"./antd-vendor-zFcGztvE.js";import"./dnd-vendor-D0spq1w0.js";import"./TokenChip-CxHEbEuw.js";const{Title:u,Text:b}=l,h=({treeId:h,nodeId:f,value:v,onChange:P,readOnly:D})=>{const{api:N}=n(),[x,y]=a.useState(()=>(null==v?void 0:v.bodyVars)||[]),[V,A]=a.useState([]),[C,g]=a.useState(null),[E,w]=a.useState("");a.useEffect(()=>{let e=!0;return(async()=>{var a,r;try{const n=await N.get(`/api/treebranchleaf/nodes/${f}`),i=(null==(r=null==(a=null==n?void 0:n.metadata)?void 0:a.capabilities)?void 0:r.apis)||[];if(i.length>0){if(!e)return;A(i),g(i[0].id),y(i[0].bodyVars||[]),w(i[0].name||""),null==P||P({...v||{},bodyVars:i[0].bodyVars||[],name:i[0].name||""})}else{const a=await N.get(`/api/treebranchleaf/nodes/${f}/api`),r=(null==a?void 0:a.bodyVars)||[],i={id:`api_${Date.now()}`,name:"API 1",bodyVars:r};if(e&&(A([i]),g(i.id),y(r),w(i.name)),h)try{const e=(null==n?void 0:n.metadata)||{},a={...e,capabilities:{...e.capabilities,apis:[i]}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:a})}catch{}null==P||P({...v||{},bodyVars:r,name:i.name})}}catch{}})(),()=>{e=!1}},[N,f,P,v,h]);const I=a.useCallback(async e=>{var a;try{if(await N.put(`/api/treebranchleaf/nodes/${f}/api`,{bodyVars:e}),h&&C)try{const r=await N.get(`/api/treebranchleaf/nodes/${f}`),n=(null==r?void 0:r.metadata)||{},i=((null==(a=n.capabilities)?void 0:a.apis)||V||[]).map(a=>a.id===C?{...a,bodyVars:e,name:E}:a),t={...n,capabilities:{...n.capabilities,apis:i}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:t}),A(i)}catch{}null==P||P({...v||{},bodyVars:e})}catch{t.error("Erreur de sauvegarde API")}},[N,f,P,v,h,C,V,E]),T=i(I,500),k=a.useCallback(e=>{y(e),T(e)},[T]),S=a.useMemo(()=>"Glissez ici des variables pour construire le body de la requÃªte",[]),j=a.useCallback(()=>{s.confirm({title:"Supprimer la configuration API ?",content:"Cette action vide la configuration et dÃ©sactive la capacitÃ©.",okText:"Supprimer",okButtonProps:{danger:!0},cancelText:"Annuler",onOk:async()=>{var e;try{await N.put(`/api/treebranchleaf/nodes/${f}/api`,{bodyVars:[]});try{await N.put(`/api/treebranchleaf/nodes/${f}`,{hasAPI:!1})}catch{}if(h&&C)try{const a=await N.get(`/api/treebranchleaf/nodes/${f}`),r=(null==a?void 0:a.metadata)||{},n=((null==(e=r.capabilities)?void 0:e.apis)||V||[]).filter(e=>e.id!==C),i={...r,capabilities:{...r.capabilities,apis:n}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:i}),A(n);const t=n[0]||null;g(t?t.id:null),t?(y(t.bodyVars||[]),w(t.name||"")):(y([]),w(""))}catch{}else y([]),w("");null==P||P({...v||{},bodyVars:[]}),t.success("Configuration API supprimÃ©e")}catch{t.error("Impossible de supprimer la configuration API")}}})},[N,f,P,v,h,C,V]);return e.jsxDEV(o,{size:"small",bordered:!0,children:[e.jsxDEV(u,{level:5,children:"ðŸ”Œ API"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:138,columnNumber:7},void 0),e.jsxDEV("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxDEV(l.Text,{type:"secondary",children:"Instance:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:141,columnNumber:9},void 0),e.jsxDEV(c,{size:"small",style:{minWidth:220},value:C||void 0,options:V.map(e=>({value:e.id,label:e.name||"Sans nom"})),onChange:e=>{g(e);const a=V.find(a=>a.id===e);a&&(y(a.bodyVars||[]),w(a.name||""))},placeholder:"SÃ©lectionner une instance"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:142,columnNumber:9},void 0),e.jsxDEV(m,{size:"small",onClick:async()=>{var e;const a=`api_${Date.now()}_${Math.floor(1e3*Math.random())}`,r={id:a,name:`API ${(V.length||0)+1}`,bodyVars:[]},n=[...V,r];if(A(n),g(a),y([]),w(r.name),h)try{const a=await N.get(`/api/treebranchleaf/nodes/${f}`),n=(null==a?void 0:a.metadata)||{},i=(null==(e=n.capabilities)?void 0:e.apis)||[],t={...n,capabilities:{...n.capabilities,apis:[...i,r]}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:t})}catch{}},children:"Ajouter"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:154,columnNumber:9},void 0),e.jsxDEV(m,{size:"small",danger:!0,onClick:j,disabled:!C,children:"Supprimer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:172,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:140,columnNumber:7},void 0),e.jsxDEV("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxDEV(l.Text,{type:"secondary",children:"Nom:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:177,columnNumber:9},void 0),e.jsxDEV(d,{size:"small",style:{maxWidth:280},placeholder:"Nom de l'appel API",value:E,onChange:e=>{const a=e.target.value;w(a),(async()=>{var e;if(h&&C)try{const r=await N.get(`/api/treebranchleaf/nodes/${f}`),n=(null==r?void 0:r.metadata)||{},i=((null==(e=n.capabilities)?void 0:e.apis)||V||[]).map(e=>e.id===C?{...e,name:a}:e),t={...n,capabilities:{...n.capabilities,apis:i}};await N.put(`/api/treebranchleaf/trees/${h}/nodes/${f}`,{metadata:t}),A(i)}catch{}})()}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:178,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:176,columnNumber:7},void 0),e.jsxDEV("div",{style:{marginBottom:8,padding:"6px 8px",background:"#fafafa",border:"1px solid #f0f0f0",borderRadius:6},children:[e.jsxDEV(l.Text,{strong:!0,style:{marginRight:8},children:"RÃ©sumÃ© test:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:204,columnNumber:9},void 0),e.jsxDEV("div",{children:e.jsxDEV(l.Text,{type:"secondary",children:["Variables (",x.length,"):"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:206,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:205,columnNumber:9},void 0),x.length>0&&e.jsxDEV(p,{wrap:!0,style:{marginTop:6},children:x.map(a=>e.jsxDEV("code",{style:{background:"#f6f6f6",padding:"2px 6px",borderRadius:4},children:a},a,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:210,columnNumber:32},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:209,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:203,columnNumber:7},void 0),e.jsxDEV(r,{nodeId:f,capability:"api",label:"Corps de requÃªte (variables)",placeholder:S,value:x,onChange:k,readOnly:D},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:214,columnNumber:7},void 0),e.jsxDEV(b,{type:"secondary",style:{fontSize:12},children:"Sauvegarde automatique activÃ©e. Builder complet Ã  venir."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:215,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/APIPanel.tsx",lineNumber:137,columnNumber:5},void 0)};export{h as default};
