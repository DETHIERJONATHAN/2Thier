var e,t,s=Object.defineProperty,i=(e,t,i)=>((e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);import{u as r,j as a}from"./index-C0S0DpaX.js";import{r as n,l,R as o}from"./react-vendor-Al_k-ZB6.js";import{u as c}from"./useAuthenticatedApi-BbQI8SDU.js";import{a as d}from"./validationHelper-Bf19AZsP.js";import u from".prisma/client/index-browser";import{g as m}from"./fieldMapping-DdWz-wC8.js";import"./antd-vendor-zFcGztvE.js";function p(){if(t)return e;t=1;return e=u}var f=p();class v{constructor(){i(this,"prisma"),i(this,"configCache",new Map),i(this,"formulaCache",new Map),i(this,"fieldMapping",m()),this.prisma=new f.PrismaClient}async loadFieldConfigurations(e){try{const e=await this.prisma.field.findMany({include:{FieldFormula:!0,FieldDependency_FieldDependency_fieldIdToField:{include:{Field_FieldDependency_dependsOnIdToField:!0}},FieldValidation:!0,optionNodes:!0}}),t={};for(const s of e){const e={id:s.id,label:s.label,type:s.type,advancedConfig:s.advancedConfig,options:s.optionNodes.map(e=>({id:e.id,label:e.label,value:e.value,fieldId:e.fieldId})),formulas:s.FieldFormula.map(e=>({id:e.id,formula:e.formula||"",sequence:e.sequence,fieldId:e.fieldId})),dependencies:s.FieldDependency_FieldDependency_fieldIdToField.map(e=>({id:e.id,fieldId:e.fieldId,dependsOnId:e.dependsOnId,condition:e.condition,value:e.value||""})),validations:s.FieldValidation.map(e=>({id:e.id,fieldId:e.fieldId,rule:e.rule,message:e.message||""}))};t[s.id]=e,this.configCache.set(s.id,e)}return t}catch(t){throw new Error(`Erreur lors du chargement des configurations: ${t.message}`)}}analyzeConditionalLogic(e){const t=[];if("advanced_select"===e.type&&e.options)for(const s of e.options){const i=this.interpretAdvancedSelectOption(e,s);i&&t.push(i)}if(e.formulas)for(const s of e.formulas){const e=this.parseFormulaToConditionalLogic(s);e&&t.push(e)}if(e.dependencies)for(const s of e.dependencies){const e=this.interpretDependencyAsLogic(s);e&&t.push(e)}return t}interpretAdvancedSelectOption(e,t){if(e.label.includes("Prix Kw/h")){if("prix-kwh"===t.value)return{condition:`IF_${e.id}_EQUALS_DIRECT_VALUE`,field1:"52c7f63b-7e57-4ba8-86da-19a176f09220",operator:"EQUALS",field2:"direct_price_value",thenAction:"COPY_VALUE",elseAction:"CALCULATE_DIVISION",resultField:e.id};if("calcul-du-prix-kwh"===t.value)return{condition:`IF_${e.id}_EQUALS_CALCULATION`,field1:"calcul_du_prix_base",operator:"DIVIDE_BY",field2:"aa448cfa-3d97-4c23-8995-8e013577e27d",thenAction:"PERFORM_DIVISION",elseAction:"USE_DEFAULT",resultField:"52c7f63b-7e57-4ba8-86da-19a176f09220"}}return null}parseFormulaToConditionalLogic(e){if(!e.formula)return null;const t=[{regex:/IF\s+(.+?)\s*=\s*(.+?)\s+THEN\s+(.+?)\s+ELSE\s+(.+)/i,handler:t=>({condition:`PARSED_${e.id}`,field1:t[1].trim(),operator:"EQUALS",field2:t[2].trim(),thenAction:t[3].trim(),elseAction:t[4].trim(),resultField:e.fieldId})},{regex:/(.+?)\s*\/\s*(.+)/,handler:t=>({condition:`DIVISION_${e.id}`,field1:t[1].trim(),operator:"DIVIDE_BY",field2:t[2].trim(),thenAction:"PERFORM_DIVISION",elseAction:"USE_DEFAULT",resultField:e.fieldId})}];for(const s of t){const t=e.formula.match(s.regex);if(t)return s.handler(t)}return null}interpretDependencyAsLogic(e){return{condition:`DEPENDENCY_${e.id}`,field1:e.fieldId,operator:e.condition,field2:e.dependsOnId,thenAction:"UPDATE_FIELD",elseAction:"NO_ACTION",resultField:e.fieldId}}async executeCalculations(e){const t={};try{const s=Object.values(e.fieldConfigs).filter(e=>"advanced_select"===e.type||e.formulas&&e.formulas.length>0||e.dependencies&&e.dependencies.length>0);for(const i of s){const s=this.analyzeConditionalLogic(i);for(const r of s){const s=await this.executeConditionalLogic(r,e);null!==s&&(t[r.resultField||i.id]=s)}}if(e.fieldValues[this.fieldMapping.prix_kwh]){const s=await this.executePrixKwhLogic(e);null!==s&&(t[this.fieldMapping.prix_mois]=s)}return t}catch(s){throw s}}async executePrixKwhLogic(e){const t=e.fieldValues[this.fieldMapping.prix_kwh],s=e.fieldValues[this.fieldMapping.prix_mois],i=e.fieldValues[this.fieldMapping.consommation_kwh];if("prix-kwh"===t){return e.fieldValues.direct_prix_kwh_input||s||0}if("calcul-du-prix-kwh"===t){return(e.fieldValues.calcul_du_prix_base||s||0)/(parseFloat(i)||1)}return null}async executeConditionalLogic(e,t){const s=t.fieldValues[e.field1]||"",i=t.fieldValues[e.field2]||"";let r=!1;switch(e.operator){case"EQUALS":r=s===i;break;case"DIVIDE_BY":return(parseFloat(String(s))||0)/(parseFloat(String(i))||1);case"MULTIPLY_BY":return(parseFloat(String(s))||0)*(parseFloat(String(i))||1);case"GREATER_THAN":r=parseFloat(String(s))>parseFloat(String(i));break;case"LESS_THAN":r=parseFloat(String(s))<parseFloat(String(i))}switch(r?e.thenAction:e.elseAction){case"COPY_VALUE":return s;case"PERFORM_DIVISION":return(parseFloat(String(s))||0)/(parseFloat(String(i))||1);case"USE_DEFAULT":return t.fieldValues[e.resultField||""]||0;default:return null}}async updateFieldConfiguration(e,t){try{const s={};t.advancedConfig&&(s.advancedConfig=t.advancedConfig),Object.keys(s).length>0&&(await this.prisma.field.update({where:{id:e},data:s}),this.configCache.delete(e))}catch(s){throw s}}async applyFormulas(e,t){const s=(null==t?void 0:t.debug)||!1,i=(null==t||t.changedFieldId,null==t?void 0:t.preloadedRules);try{const t={},a=[],n=[];let l=[];i?Object.entries(i).forEach(([e,t])=>{t.formulas&&Array.isArray(t.formulas)&&t.formulas.forEach(t=>{l.push({...t,fieldId:e})})}):l=await this.prisma.fieldFormula.findMany({orderBy:{order:"asc"}});for(const i of l)if(i.sequence)try{let r;if("string"==typeof i.sequence)try{r=JSON.parse(i.sequence)}catch{continue}else{if(!Array.isArray(i.sequence))continue;r=i.sequence}if(!Array.isArray(r)||0===r.length)continue;const l=await this.evaluateFormulaSequence(r,e,{debug:s});l.success&&void 0!==l.value?(t[i.fieldId]=l.value,a.push({id:i.id,name:i.name||i.id})):l.error&&n.push(`Erreur formule ${i.name}: ${l.error}`)}catch(r){const e=r instanceof Error?r.message:String(r);n.push(`Erreur formule ${i.name||i.id}: ${e}`)}return{success:!0,calculatedValues:t,appliedFormulas:a,errors:n.length>0?n:void 0}}catch(a){return{success:!1,calculatedValues:{},appliedFormulas:[],errors:[a instanceof Error?a.message:String(a)]}}}async evaluateFormulaSequence(e,t,s={}){const i=s.debug||!1;for(const r of e){if(!r||"object"!=typeof r)continue;const e=r;if("cond"===e.type)return this.evaluateConditionalElement(e,t,{debug:i})}return{success:!1,error:"Aucun Ã©lÃ©ment Ã©valuable dans la sÃ©quence"}}async evaluateConditionalElement(e,t,s={}){const i=s.debug||!1,r=e.condition;if(!r)return{success:!1,error:"Condition manquante"};const a=r.fieldId,n=r.operator,l=r.value,o=r.part||"selection";let c;const d=t[a];if(d&&"object"==typeof d&&!Array.isArray(d)){c=d[o]}else c=d;let u=!1;"="===n&&(u=c===l);const m=u?e.then:e.else;return Array.isArray(m)?this.evaluateBranch(m,t,{debug:i}):{success:!1,error:"Branche manquante"}}async evaluateBranch(e,t,s={}){const i=s.debug||!1;if(1===e.length){const s=e[0];return this.evaluateAction(s,t,{debug:i})}if(3===e.length){const s=e[0],r=e[1],a=e[2],n=await this.evaluateAction(s,t,{debug:i}),l=await this.evaluateAction(a,t,{debug:i});if(!n.success||!l.success)return{success:!1,error:"Erreur Ã©valuation des opÃ©randes"};const o=r.value,c=parseFloat(String(n.value))||0,d=parseFloat(String(l.value))||0;if("/"===o){if(0===d)return{success:!1,error:"Division par zÃ©ro"};return{success:!0,value:c/d}}}return{success:!1,error:"Structure de branche non supportÃ©e"}}async evaluateAction(e,t,s={}){s.debug;const i=e.type,r=e.value;if("value"===i&&"string"==typeof r&&r.startsWith("nextField:")){const e=r.substring(10);for(const[s,i]of Object.entries(t))if(i&&"object"==typeof i&&!Array.isArray(i)){const t=i;if(t.nodeId===e&&void 0!==t.extra){return{success:!0,value:parseFloat(String(t.extra))||0}}}for(const[,s]of Object.entries(t))if(s&&"object"==typeof s&&!Array.isArray(s)){const t=s;if(t.nodeId&&void 0!==t.extra)try{const s=await this.prisma.optionNode.findUnique({where:{id:t.nodeId}});if(s&&s.data){const i="string"==typeof s.data?JSON.parse(s.data):s.data;if(i&&"object"==typeof i){const s=i.nextField;if(s&&"object"==typeof s){if(s.id===e){return{success:!0,value:parseFloat(String(t.extra))||0}}}}}}catch{}}return{success:!1,error:`NextField ${e} non trouvÃ©`}}if("field"===i){const e=t[r];return{success:!0,value:parseFloat(String(e))||0}}if("value"===i){return{success:!0,value:parseFloat(String(r))||0}}return{success:!1,error:`Type d'action non supportÃ©: ${i}`}}async cleanup(){this.configCache.clear(),this.formulaCache.clear(),await this.prisma.$disconnect()}}function h(e){if(!e||"object"!=typeof e)return!1;const t=e;return"string"==typeof t.name&&"string"==typeof t.dataUrl}function b(e){if(!e||"object"!=typeof e)return!1;return"data"in e}function g(){const{get:e,put:t,post:s}=c(),{user:i}=r(),o=n.useMemo(()=>new v,[]),u=!0,m=n.useCallback((...e)=>{},[u]),p=n.useCallback(e=>{const t=e.config||e.advancedConfig||{},s={},i=[];return t.backgroundColor&&"string"==typeof t.backgroundColor&&(s.backgroundColor=t.backgroundColor),!s.backgroundColor&&t.color&&"string"==typeof t.color&&(s.backgroundColor=t.color),t.textColor&&"string"==typeof t.textColor&&(s.color=t.textColor),t.borderColor&&"string"==typeof t.borderColor&&(s.borderColor=t.borderColor),t.fontSize&&"string"==typeof t.fontSize&&(s.fontSize=t.fontSize),t.fontFamily&&"string"==typeof t.fontFamily&&(s.fontFamily=t.fontFamily),t.fontWeight&&"string"==typeof t.fontWeight&&(s.fontWeight=t.fontWeight),t.fontStyle&&"string"==typeof t.fontStyle&&(s.fontStyle=t.fontStyle),t.customClass&&"string"==typeof t.customClass&&i.push(t.customClass),{styles:s,classNames:i}},[]),f=n.useRef(null),[g,N]=n.useState({}),[x,y]=n.useState({}),[C,E]=n.useState({}),V=n.useRef(null),S=n.useRef(null),A=n.useRef({});n.useEffect(()=>{(async()=>{try{if(V.current)return;const e=await fetch("/scripts/field-node-mapping.json");if(e.ok){const t=await e.json();V.current=t,m("Mapping chargÃ©",t)}}catch{}})()},[m,u]);const k=n.useCallback((e,t)=>{const s=x[e];if(!(null==s?void 0:s.dependencies))return g[e]||{visible:!0,disabled:!1,required:!1};const i={...g[e]||{visible:!0,disabled:!1,required:!1}};for(const r of s.dependencies){const e=t[r.dependsOnId],s=r.condition,a=r.value;let n=!1;"="===s?n=e===a:"!="===s?n=e!==a:"exists"===s?n=null!=e&&""!==e:"not_exists"===s&&(n=!e||""===e),n?(i.visible=!0,i.disabled=!1):(i.visible=!1,i.disabled=!0)}return i},[x,g]),j=n.useCallback(e=>/prix|price/i.test(e),[]),O=n.useCallback(e=>{if("number"==typeof e&&Number.isFinite(e))return e;if("string"!=typeof e)return null;const t=e.trim();if(!t)return null;let s=t.replace(/\s+/g,"").replace(/,/g,"."),i=!1;if(/^[-+]?\d*([.,]\d+)?%$/.test(s)&&(i=!0,s=s.replace(/%$/,"")),!/^[-+]?\d*(\.\d+)?$/.test(s))return null;const r=Number(s);return Number.isFinite(r)?i?r/100:r:null},[]),[w,R]=n.useState({}),[U,I]=l(),M=U.get("leadId")||"",P=U.get("blockId")||"",F=U.get("devisId")||"",_=F?`${P}::${F}`:P,[$,L]=n.useState(null),[q,T]=n.useState([]),[z,B]=n.useState(null),[W,Y]=n.useState([]),[J,Q]=n.useState(""),[H,K]=n.useState(0),[X,G]=n.useState({}),[Z,ee]=n.useState(!1),[te,se]=n.useState(!1),ie=n.useRef(null),re=n.useRef(null),ae=n.useRef(new Set);n.useEffect(()=>{A.current={...X}},[X]);const[ne,le]=n.useState(new Set),[oe,ce]=n.useState(new Set),de=n.useRef({}),[ue,me]=n.useState(new Set),pe="__prix_mirror",fe=n.useRef({advId:null,numId:null}),[ve,he]=n.useState(""),[be,ge]=n.useState(!1),[De,Ne]=n.useState(!1),xe=n.useCallback(e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";try{return t.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short"})}catch{return t.toLocaleString()}},[]),ye=n.useCallback(e=>String(e??"").normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").toLowerCase().replace(/[^a-z0-9]+/g,""),[]),Ce=n.useCallback((e,t)=>{if(!e||"object"!=typeof e||!t)return;const s=t.split(".").filter(Boolean);let i=e;for(const r of s){if(!i||"object"!=typeof i)return;if(!(r in i))return;i=i[r]}return i},[]),Ee=n.useCallback((e,t)=>{if(!t||"string"!=typeof t)return;const s=t.trim();return s.startsWith("lead.")?Ce(e,s.slice(5)):s.startsWith("data.")?Ce(e.data,s.slice(5)):Ce(e,s)??Ce(e.data,s)},[Ce]),Ve=n.useCallback((e,t,s=2)=>{if(!e||"object"!=typeof e||s<0)return;const i=e;for(const[r,a]of Object.entries(i)){const e=ye(r);if(t.includes(e))return a;if(a&&"object"==typeof a){const e=Ve(a,t,s-1);if(void 0!==e)return e}}},[ye]),Se=n.useCallback(e=>{const t=ye(e.id),s=ye(e.label),i=new Set([t,s]),r=e=>i.add(ye(e)),a=`${t}|${s}`;return(/prenom/.test(a)||/firstname/.test(a))&&(r("prenom"),r("firstName"),r("first_name")),(/(^|[^a-z])nom([^a-z]|$)/.test(a)||/lastname/.test(a))&&(r("nom"),r("lastName"),r("last_name")),/societe|company|entreprise/.test(a)&&(r("company"),r("societe")),/email|mail/.test(a)&&r("email"),/telephone|tel|phone/.test(a)&&(r("phone"),r("telephone"),r("tel")),/adresse|address/.test(a)&&(r("adresse"),r("address"),r("adresse1"),r("address1"),r("ligne1")),/codepostal|postal|zip/.test(a)&&(r("codepostal"),r("postalcode"),r("zip")),/ville|city/.test(a)&&(r("ville"),r("city")),/pays|country/.test(a)&&(r("pays"),r("country")),Array.from(i).filter(Boolean)},[ye]),Ae=n.useCallback((e,t)=>function(e,t){if(!e.sequence)return{result:"show"};try{const{conditions:i,action:r}=e.sequence;if(!i||0===i.length||1===i.length&&0===i[0].length)return{result:r};let a=!1;for(const e of i){if(0===e.length)continue;let i,r="";for(let s=0;s<e.length;s++){const i=e[s];if("field"===i.type){if(!i.id)continue;const e=t[i.id]??null;r+="string"==typeof e?`"${e}"`:e}else"operator"===i.type?r+=` ${i.value} `:"value"===i.type&&(r+="string"==typeof i.value?`"${i.value}"`:i.value)}try{i=new Function(`return ${r}`)()}catch(s){continue}if(i){a=!0;break}}if(a)return{result:r,details:{conditionsResult:a,appliedAction:r}};{const e="show"===r?"hide":"hide"===r?"show":"require"===r?"unrequire":"require";return{result:e,details:{conditionsResult:a,appliedAction:e}}}}catch(s){return{result:"show",details:{error:s}}}}(e,t),[]);n.useEffect(()=>{if(!P)return;let t=!0;return(async()=>{try{const s=await e(`/api/blocks/${P}/read`);if(!t)return;const i=b(s)?s.data:s;L(i),K(0);const r={},a={};await Promise.all((i.sections||[]).flatMap(t=>(t.fields||[]).map(async t=>{r[t.id]={visible:!0,disabled:!1,required:Boolean(t.required)};try{const[s,i,r]=await Promise.all([e(`/api/fields/${t.id}/dependencies/read`).catch(()=>({success:!0,data:[]})),e(`/api/fields/${t.id}/validations/read`).catch(()=>({success:!0,data:[]})),e(`/api/formulas/field/${t.id}`).catch(()=>[])]),n=b(s)?s.data:Array.isArray(s)?s:[],l=b(i)?i.data:Array.isArray(i)?i:[],o=Array.isArray(r)?r:[];a[t.id]={validations:l,dependencies:n,formulas:o}}catch{a[t.id]={}}}))),N(r),y(a);try{const e=new Set;(i.sections||[]).forEach(t=>(t.fields||[]).forEach(t=>{const s=(t.label||"").toString();(/prix|price/i.test(s)||/prix|price/i.test(t.id))&&e.add(t.id)})),e.size&&e.add(pe),me(e),e.size&&m("Champs prix dÃ©tectÃ©s (label)",Array.from(e));try{let t=null,s=null;(i.sections||[]).forEach(i=>(i.fields||[]).forEach(i=>{e.has(i.id)&&("advanced_select"===i.type&&(t=i.id),"advanced_select"===i.type||s||(s=i.id))})),fe.current={advId:t,numId:s},t&&s?m("Couplage prix dÃ©tectÃ© advanced_select -> cible",t,"=>",s):t&&!s&&m("Couplage prix: advanced_select trouvÃ© sans cible numÃ©rique claire")}catch{}}catch{}}catch{}})(),()=>{t=!1}},[P,e,m,y,N]);const ke=n.useCallback(async(t,s)=>{const i=`${t}::${s||"root"}`;if(w[i])return w[i];try{const r=await e(`/api/option-nodes/field/${t}/children${s?`?parentId=${encodeURIComponent(s)}`:""}`),a=Array.isArray(r)?r:r&&"object"==typeof r&&"data"in r&&r.data||[];return R(e=>({...e,[i]:a})),a}catch{return[]}},[w,e]),je=n.useCallback(async t=>{try{const s=await e(`/api/option-nodes/${t}`);return(s&&"object"==typeof s&&"data"in s?s.data:s)||null}catch{return null}},[e]);n.useEffect(()=>{if(!M)return;let t=!0;return(async()=>{try{const s=await e(`/api/leads/${M}`);if(!t)return;B(s)}catch{}})(),()=>{t=!1}},[M,e]),n.useEffect(()=>{if(z&&M){const e=[z.name,z.company,z.email].filter(Boolean).join(" â€” ");e&&Q(e)}},[z,M]);const Oe=n.useCallback(e=>{M&&P&&(f.current&&window.clearTimeout(f.current),f.current=window.setTimeout(async()=>{try{ee(!0);try{const t={};Object.entries(e).forEach(([e,s])=>{(j(e)||ue.has(e))&&(t[e]=s)}),m("scheduleSave -> valeurs prix dÃ©tectÃ©es",t);const s={};Object.entries(e).forEach(([e,t])=>{if(t&&"object"==typeof t&&!Array.isArray(t)){const i=t;"selection"in i&&"nodeId"in i&&(s[e]=i)}}),Object.keys(s).length&&m("scheduleSave -> advanced_select snapshot",s)}catch{}try{const t=fe.current;if(t.advId&&t.numId){const s=e[t.advId];if(s&&"object"==typeof s&&!Array.isArray(s)){const i=s,r="string"==typeof i.extra||"number"==typeof i.extra?i.extra:"string"==typeof i.selection||"number"==typeof i.selection?i.selection:void 0;if("string"==typeof r||"number"==typeof r){const s=O(r);if(null!==s){let r=s;const a="string"==typeof i.selection?i.selection.toLowerCase():"";if(/calcul/.test(a))try{const t=Object.entries(e).find(([e,t])=>{if(!t&&0!==t)return!1;const s=((null==$?void 0:$.sections)||[]).flatMap(e=>e.fields||[]).find(t=>t.id===e),i=((null==s?void 0:s.label)||"")+" "+e;return/consommation/i.test(i)&&/kwh/i.test(i)});if(t){const e=O(t[1]);e&&e>0&&(r=Number((s/e).toFixed(6)))}}catch{}e[t.numId]!==r&&(e={...e,[t.numId]:r},m("Normalisation sauvegarde prix",t.numId,"=>",r))}}}}}catch{}const s={...(null==z?void 0:z.data)||{}};s.devis=s.devis||{};const i=s.devis[_]||{},r=i&&"object"==typeof i?i._meta:void 0,a=(new Date).toISOString(),n={...r,name:(ve||"").trim(),updatedAt:a,createdAt:(null==r?void 0:r.createdAt)||a};s.devis[_]={...e,_meta:n};try{const e={},t=s.devis[_];Object.entries(t).forEach(([t,s])=>{(j(t)||ue.has(t))&&(e[t]=s)}),m("PUT /api/leads prix dans payload",e);const i={};Object.entries(t).forEach(([e,t])=>{if(t&&"object"==typeof t&&!Array.isArray(t)){const s=t;"selection"in s&&"nodeId"in s&&(i[e]=s)}}),Object.keys(i).length&&m("PUT /api/leads advanced_select payload",i)}catch{}await t(`/api/leads/${M}`,{data:s}),m("PUT terminÃ©")}finally{ee(!1)}},600))},[M,P,_,t,z,ve,m,j,ue,O,null==$?void 0:$.sections]);n.useEffect(()=>{if(!$)return;const t=z&&z.data&&z.data.devis&&z.data.devis[_]?z.data.devis[_]:{};try{const e=t&&"object"==typeof t?(null==t?void 0:t._meta)&&(null==t?void 0:t._meta):void 0,s=e&&"object"==typeof e?e.name:void 0;he("string"==typeof s?s:"")}catch{he("")}const s={};z&&($.sections||[]).forEach(e=>{(e.fields||[]).forEach(e=>{var i;const r=t&&"object"==typeof t?t[e.id]:void 0;if(void 0!==r&&""!==r)return;const a=null==(i=e.advancedConfig)?void 0:i.dbField,n=Ee(z,a);if(null!=n&&""!==n)return void(s[e.id]=n);const l=Se(e),o=Ve(z,l,1);if(null!=o&&""!==o)return void(s[e.id]=o);const c=Ve(z.data,l,2);null==c||""===c||(s[e.id]=c)})});const i={...s||{},...t||{}};try{if(ue.size&&!i[pe]){const e=Array.from(ue).find(e=>e!==pe&&"object"==typeof i[e]);if(e){const t=i[e];if(t&&"object"==typeof t){const e=t,s="string"==typeof e.extra||"number"==typeof e.extra?e.extra:"string"==typeof e.selection||"number"==typeof e.selection?e.selection:void 0;if(void 0!==s){const e=O(s);null!==e&&(i[pe]=e)}}}}}catch{}G(i),(async()=>{try{const t=[];if(($.sections||[]).forEach(e=>(e.fields||[]).forEach(e=>{(/prix kwh|prix k|kwh/i.test(e.label||"")||/prix_kwh/i.test(e.id))&&t.push(e.id)})),Object.keys(i).forEach(e=>{/prix|kwh/i.test(e)&&!t.includes(e)&&t.push(e)}),!t.length)return;const s=await e(`/api/treebranchleaf/effective-values?ids=${encodeURIComponent(t.join(","))}`),r=s&&"object"==typeof s&&"data"in s?s.data||{}:s||{};if(r&&Object.keys(r).length){const e={...i},t=new Set,s=[];Object.entries(r).forEach(([i,r])=>{de.current[i]={manualNodeId:r.manualNodeId,modeNodeId:r.modeNodeId},r.manualApplied?void 0!==r.value&&null!==r.value&&(e[i]=r.value,t.add(i)):"formula"===r.source&&s.push(i)}),(t.size||s.length)&&(G(t=>({...t,...e})),t.size&&ce(t),s.length&&le(e=>{const t=new Set(e);return s.forEach(e=>t.add(e)),t}))}}catch{}})(),z&&P&&Oe(i)},[$,z,_,Oe,P,Ee,Ve,Se,O,ue,e]),n.useEffect(()=>{let t=!0;return(async()=>{try{const s=await e("/api/blocks/read");let i=[];if(Array.isArray(s))i=s;else if(s&&"object"==typeof s&&"data"in s){i=s.data||[]}t&&T(i.map(e=>({id:e.id,name:e.name})))}catch{}})(),()=>{t=!1}},[e]),n.useEffect(()=>{let t=!0;return(async()=>{try{const s=await e("/api/leads");let i=[];Array.isArray(s)?i=s:s&&"object"==typeof s&&"data"in s&&(i=s.data||[]),t&&Y(i.map(e=>({id:e.id,name:e.name,email:e.email,company:e.company})))}catch{}})(),()=>{t=!1}},[e]);const we=n.useMemo(()=>{const e=J.trim().toLowerCase();return e.length<2?[]:W.filter(t=>{var s;return(null==(s=t.name)?void 0:s.toLowerCase().includes(e))||t.email&&t.email.toLowerCase().includes(e)||t.company&&t.company.toLowerCase().includes(e)}).slice(0,12)},[J,W]),Re=n.useMemo(()=>{if(!z||!P)return[];const e=z.data&&z.data.devis?z.data.devis:{},t=[];return Object.keys(e).forEach(s=>{const i=e[s],r=i&&"object"==typeof i?i._meta:void 0,a=r&&"object"==typeof r?r.name:void 0;if(!(!r||"object"!=typeof r)&&Boolean(r.archived)&&!be)return;const n=(null==r?void 0:r.updatedAt)||void 0,l=(null==r?void 0:r.createdAt)||void 0,o=(()=>{const e=n?Date.parse(n):NaN,t=l?Date.parse(l):NaN;return Number.isNaN(e)?Number.isNaN(t)?0:t:e})(),c=xe(n||l);if(s===P){const e=(null==a?void 0:a.trim())?a:"DÃ©faut",i=c?`${e} Â· ${c}`:e;t.push({key:s,label:i,devisId:"",ts:o})}else if(s.startsWith(`${P}::`)){const e=s.substring(P.length+2),i=(null==a?void 0:a.trim())?a:e||"Sans nom",r=c?`${i} Â· ${c}`:i;t.push({key:s,label:r,devisId:e,ts:o})}}),t.sort((e,t)=>t.ts-e.ts||e.label.localeCompare(t.label)).map(({key:e,label:t,devisId:s})=>({key:e,label:t,devisId:s}))},[z,P,be,xe]),Ue=n.useCallback(()=>`${Date.now().toString(36)}${Math.random().toString(36).slice(2,6)}`,[]),Ie=n.useMemo(()=>{var e;const t=(null==(e=null==z?void 0:z.data)?void 0:e.devis)&&z.data.devis[_];if(t&&"object"==typeof t){const e=t._meta;return e&&"object"==typeof e?e:void 0}},[z,_]),Me=Boolean(null==Ie?void 0:Ie.archived),Pe=n.useMemo(()=>{var e;const t=(null==(e=null==z?void 0:z.data)?void 0:e.devis)&&z.data.devis[_];return t&&"object"==typeof t?t:void 0},[z,_]);n.useEffect(()=>{if(Pe&&$)try{const e=new Set;($.sections||[]).forEach(t=>(t.fields||[]).forEach(t=>e.add(t.id)));const t=Object.keys(Pe).filter(e=>"_meta"!==e),s=t.filter(t=>!e.has(t)),i=Array.from(e).filter(e=>!(e in Pe));m("Analyse devis -> clÃ©s stockÃ©es",t),s.length&&m("Analyse devis -> clÃ©s orphelines (ID changÃ©s ?)",s),i.length&&m("Analyse devis -> champs sans valeur stockÃ©e",i)}catch{}},[Pe,$,m]),n.useEffect(()=>{if(!z||!P||!M)return;if(!(Re.length>0)&&!F){const e=Ue(),t=new URLSearchParams(U);t.set("devisId",e),I(t,{replace:!0})}},[z,P,M,Re.length,F,Ue,U,I]),n.useEffect(()=>{var e;if(be)return;if(!z||!P)return;if(!Me)return;const t=(null==(e=z.data)?void 0:e.devis)||{},s=Object.keys(t).filter(e=>e===P||e.startsWith(`${P}::`)).filter(e=>{const s=t[e],i=s&&"object"==typeof s?s._meta:void 0;return!(null==i?void 0:i.archived)}),i=new URLSearchParams(U);if(s.includes(P))i.delete("devisId");else if(s.length>0){const e=s.find(e=>e.startsWith(`${P}::`));if(e){const t=e.substring(P.length+2);i.set("devisId",t)}else i.delete("devisId")}else{const e=Ue();i.set("devisId",e)}I(i,{replace:!0})},[be,Me,z,P,U,I,Ue]),n.useEffect(()=>{M&&P&&Oe({...A.current})},[ve,M,P,Oe]);const Fe=n.useCallback((e,t)=>{re.current=String(e);try{ae.current.add(String(e))}catch{}if((j(e)||ue.has(e))&&m("onChange prix",e,"=>",t),t&&"object"==typeof t&&!Array.isArray(t)){"selection"in t&&"nodeId"in t&&m("onChange advanced_select",e,t)}le(t=>{if(!t.has(String(e)))return t;const s=new Set(t);return s.delete(String(e)),s}),G(s=>{const i={...s,[e]:t};try{const s=fe.current;if(e===s.advId&&t&&"object"==typeof t&&!Array.isArray(t)){const e=t,r="string"==typeof e.extra||"number"==typeof e.extra?e.extra:"string"==typeof e.selection||"number"==typeof e.selection?e.selection:void 0;if("string"==typeof r||"number"==typeof r){const e=O(r);if(null!==e){let t=null;if(s.numId)i[s.numId]!==e&&(i[s.numId]=e,t=s.numId,m("Propagation prix extra -> cible",s.advId,"=>",s.numId,e));else{const r=Array.from(ue).find(e=>e!==s.advId&&"object"!=typeof i[e]);r&&i[r]!==e&&(i[r]=e,t=r,m("Propagation prix extra (fallback) ->",s.advId,"=>",r,e)),r||m("Propagation prix: aucune cible numÃ©rique trouvÃ©e (fallback manquÃ©)")}if(i[pe]!==e&&(i[pe]=e,m("Miroir prix mis Ã  jour",pe,e)),t)try{ae.current.add(String(t))}catch{}}}}}catch{}try{const e=Object.entries(x),t={...g};e.forEach(([e,s])=>{(null==s?void 0:s.dependencies)&&s.dependencies.forEach(s=>{var r,a;const n=s.targetFieldId||(null==(r=s.sequence)?void 0:r.targetFieldId)||e;if(!n)return;const l={...i},o={id:s.id,name:s.name,sequence:s.sequence,targetFieldId:n,defaultValue:s.defaultValue},c=Ae(o,l),d=t[n]||{visible:!0,disabled:!1,required:Boolean((null==(a=g[n])?void 0:a.required)||!1)};"show"===c.result&&(t[n]={...d,visible:!0}),"hide"===c.result&&(t[n]={...d,visible:!1}),"require"===c.result&&(t[n]={...d,required:!0}),"unrequire"===c.result&&(t[n]={...d,required:!1})})}),N(t)}catch{}const r={...C},a=x[e];if((null==a?void 0:a.validations)&&a.validations.length>0){const s=a.validations[0],n=!(null==s?void 0:s.type)||d(s.type,t,s.params,i);r[e]=n?null:(null==s?void 0:s.message)||"Champ invalide"}const n={...i};try{const e=fe.current;if(e.advId&&e.numId){const t=n[e.advId];if(t&&"object"==typeof t&&!Array.isArray(t)){const s=t,i="string"==typeof s.extra||"number"==typeof s.extra?s.extra:"string"==typeof s.selection||"number"==typeof s.selection?s.selection:void 0;if("string"==typeof i||"number"==typeof i){const t=O(i);null!==t&&n[e.numId]!==t&&(n[e.numId]=t,m("Propagation prix (prÃ©-formules) adv->num",e.advId,"=>",e.numId,t))}}}}catch{}const l=[];(async()=>{try{m("ðŸš€ DÃ©but application formules dynamiques");const t=await o.applyFormulas(n,{changedFieldId:e,debug:u,preloadedRules:x});t.success&&Object.keys(t.calculatedValues).length>0&&G(e=>{const s={...e};let i=!1;const r=[];return Object.entries(t.calculatedValues).forEach(([e,t])=>{if(s[e]!==t&&void 0!==t){const a=s[e],n=re.current===e||ae.current.has(e);n&&("number"==typeof t&&0===t)&&("number"==typeof a&&0!==a)||(s[e]=t,i=!0,n||r.push(e),j(e)||ue.has(e)?m("ðŸ§® Formule dynamique appliquÃ©e (async)",e,"=>",t,"(prix dÃ©tectÃ©)"):m("ðŸ§® Formule dynamique appliquÃ©e (async)",e,"=>",t))}}),t.appliedFormulas.length>0&&m("âœ… Formules dynamiques appliquÃ©es (async):",t.appliedFormulas.map(e=>`${e.name} (${e.id})`)),i?(r.length&&le(e=>{const t=new Set(e);return r.forEach(e=>t.add(e)),t}),Oe(s),s):e})}catch(t){m("âŒ Exception formules dynamiques:",t)}})();const c=e=>null==e?"":"object"==typeof e?JSON.stringify(e):String(e),p=(e,t)=>{const s=n[e];if(s&&"object"==typeof s){const e=s;return t&&"selection"!==t?"extra"===t?e.extra:void 0:e.selection}if(!t||"selection"===t)return s};return $&&($.sections||[]).forEach(e=>{(e.fields||[]).forEach(e=>{if("donnee"!==e.type)return;const t=e.advancedConfig||{},s=null==t?void 0:t.composer;if(!s)return;const i=s.mode||"template";let a=n[e.id];if("picks"===i){const e=Array.isArray(s.picks)?s.picks:[],t={};e.forEach(e=>{const s=String(e.key??""),i=String(e.from??"values"),a=String(e.fieldId??""),l=e.path?String(e.path):void 0;if(s&&a)if("values"===i){let e=n[a];l&&e&&"object"==typeof e&&(e=e[l]),t[s]=e}else if("advancedSelect"===i){const e=l||"selection";t[s]=p(a,e)}else t[s]="errors"===i?r[a]||null:n[a]}),a=t}else{a=(e=>e.replace(/\{\{\s*([^}]+)\s*\}\}/g,(e,t)=>{const s=String(t).split("."),i=s[0],a=s[1],l=s.slice(2);if(!a)return"";if("values"===i){let e=n[a];for(const t of l){if(!e||"object"!=typeof e){e=void 0;break}e=e[t]}return c(e)}if("advancedSelect"===i){const e=l[0]||"selection";return c(p(a,e))}return"errors"===i?c(r[a]||""):""}))(String(s.template??""))}((e,t)=>{if(e===t)return!0;try{return JSON.stringify(e)===JSON.stringify(t)}catch{return!1}})(a,n[e.id])||"string"==typeof a&&""===a.trim()&&void 0!==n[e.id]||(n[e.id]=a)})}),E(r),l.length&&le(new Set(l)),Oe(n),n});try{S.current&&window.clearTimeout(S.current),S.current=window.setTimeout(async()=>{var e;try{const t=[];if(((null==$?void 0:$.sections)||[]).forEach(e=>(e.fields||[]).forEach(e=>{(/prix kwh|prix k|kwh/i.test(e.label||"")||/prix_kwh/i.test(e.id))&&t.push(e.id)})),!t.length)return;const i=(null==(e=V.current)?void 0:e.mappings)||[],r={};if(i.length&&$&&($.sections||[]).forEach(e=>(e.fields||[]).forEach(e=>{if(!i.find(t=>t.labelMatch&&e.label&&e.label.toLowerCase().includes(t.labelMatch.toLowerCase())))return;const t=valuesRef.current?valuesRef.current[e.id]:void 0;if("number"==typeof t)r[e.id]=t;else if("string"==typeof t){const s=parseFloat(t.replace(",","."));Number.isFinite(s)&&(r[e.id]=s)}})),!Object.keys(r).length){const e=valuesRef.current;e&&Object.entries(e).forEach(([e,t])=>{if(/facture.+(elec|Ã©lec|electricitÃ©)|consommation.+(elec|Ã©lec|electricitÃ©)/i.test(e)||/facture|consommation/i.test(e))if("number"==typeof t)r[e]=t;else if("string"==typeof t){const s=parseFloat(t.replace(",","."));Number.isFinite(s)&&(r[e]=s)}})}if(!Object.keys(r).length)return;const a=await s("/api/treebranchleaf/effective-values/evaluate",{ids:t,inputValues:r}),n=(null==a?void 0:a.data)||{};n&&Object.keys(n).length&&G(e=>{const t={...e},s=[];return Object.entries(n).forEach(([e,i])=>{"formula"===i.source&&null!==i.value&&void 0!==i.value&&t[e]!==i.value&&(t[e]=i.value,s.push(e),m("Recalcul serveur prix",e,"=>",i.value))}),s.length&&le(e=>{const t=new Set(e);return s.forEach(e=>t.add(e)),t}),t})}catch{}},420)}catch{}},[Oe,x,g,Ae,C,$,O,m,j,ue,u,o,E,N,s]);n.useEffect(()=>{$&&Object.keys(x).length&&Object.keys(X).length&&(m("ðŸ”„ Application automatique des formules au chargement/changement de donnÃ©es"),(async()=>{try{const e=await o.applyFormulas(X,{debug:u,preloadedRules:x});e.success&&Object.keys(e.calculatedValues).length>0&&(m("ðŸŽ¯ Formules appliquÃ©es automatiquement:",e.calculatedValues),G(t=>{const s={...t};let i=!1;const r=[];return Object.entries(e.calculatedValues).forEach(([e,t])=>{s[e]!==t&&void 0!==t&&(s[e]=t,i=!0,r.push(e),m("ðŸ§® Formule auto-appliquÃ©e:",e,"=",t))}),i?(r.length&&le(e=>{const t=new Set(e);return r.forEach(e=>t.add(e)),t}),Oe(s),s):t}))}catch(e){m("âŒ Erreur application automatique formules:",e)}})())},[$,x,X,o,u,m,Oe]);const _e=n.useMemo(()=>((null==$?void 0:$.sections)||[]).filter(e=>!1!==e.active),[$]);n.useEffect(()=>{H>=_e.length&&K(Math.max(0,_e.length-1))},[_e.length,H]);const $e=n.useRef(null);n.useEffect(()=>{const e=$e.current;if(!e)return;let t=0,s=0;const i=e=>{t=e.touches[0].clientX,s=e.touches[0].clientY},r=e=>{const i=e.changedTouches[0].clientX-t,r=e.changedTouches[0].clientY-s;Math.abs(i)>50&&Math.abs(r)<40&&K(e=>i<0?Math.min(e+1,Math.max(0,_e.length-1)):Math.max(e-1,0))};return e.addEventListener("touchstart",i,{passive:!0}),e.addEventListener("touchend",r,{passive:!0}),()=>{e.removeEventListener("touchstart",i),e.removeEventListener("touchend",r)}},[_e.length]);const Le=Boolean(P&&M&&$);return a.jsxDEV("div",{className:"w-full px-4 py-4",ref:$e,children:[a.jsxDEV("h1",{className:"text-2xl font-semibold mb-4",children:["Devis ",(null==$?void 0:$.name)?`â€” ${$.name}`:""]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1247,columnNumber:7},this),a.jsxDEV("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[a.jsxDEV("label",{className:"text-sm text-gray-600",children:"Lead"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1251,columnNumber:9},this),a.jsxDEV("div",{className:"relative flex-1 min-w-[320px]",children:[a.jsxDEV("input",{ref:ie,className:"border rounded px-2 py-1 w-full",placeholder:"Rechercher par nom, email ou sociÃ©tÃ©",value:J,onFocus:()=>se(!0),onBlur:()=>{setTimeout(()=>se(!1),120)},onChange:e=>{Q(e.target.value),se(!0)}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1253,columnNumber:11},this),te&&we.length>0&&a.jsxDEV("div",{className:"absolute left-0 right-0 mt-1 z-10 border rounded bg-white shadow max-h-64 overflow-auto",onMouseDown:e=>e.preventDefault(),children:we.map(e=>{const t=[e.name,e.company,e.email].filter(Boolean).join(" â€” ");return a.jsxDEV("button",{className:"block w-full text-left px-3 py-2 hover:bg-gray-100",onClick:()=>{const s=new URLSearchParams(U);s.set("leadId",e.id),I(s,{replace:!0}),Q(t),se(!1)},children:t},e.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1276,columnNumber:19},this)})},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1269,columnNumber:13},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1252,columnNumber:9},this),a.jsxDEV("label",{className:"text-sm text-gray-600",children:"Formulaire"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1294,columnNumber:9},this),a.jsxDEV("select",{className:"border rounded px-2 py-1 w-64",value:P,onChange:e=>{const t=e.target.value,s=new URLSearchParams(U);t?s.set("blockId",t):s.delete("blockId"),I(s,{replace:!0})},children:[a.jsxDEV("option",{value:"",children:"â€” Choisir un formulaire â€”"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1305,columnNumber:11},this),q.map(e=>a.jsxDEV("option",{value:e.id,children:e.name||e.id},e.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1307,columnNumber:13},this))]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1295,columnNumber:9},this),a.jsxDEV("label",{className:"text-sm text-gray-600",children:"Devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1310,columnNumber:3},this),a.jsxDEV("select",{className:"border rounded px-2 py-1 w-56 hover:border-gray-400",value:F||(Re.some(e=>""===e.devisId)?"":"__new__"),onChange:e=>{const t=e.target.value,s=new URLSearchParams(U);if("__new__"===t){const e=Ue();s.set("devisId",e)}else t?s.set("devisId",t):s.delete("devisId");I(s,{replace:!0})},disabled:!M||!P,children:[Re.some(e=>""===e.devisId)?a.jsxDEV("option",{value:"",children:"DÃ©faut"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1331,columnNumber:13},this):a.jsxDEV("option",{value:"__new__",children:"Nouveau"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1333,columnNumber:13},this),Re.map(e=>e.devisId?a.jsxDEV("option",{value:e.devisId,children:e.label},e.key,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1336,columnNumber:27},this):null)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1311,columnNumber:9},this),a.jsxDEV("label",{className:"text-sm text-gray-600 inline-flex items-center gap-1",children:[a.jsxDEV("input",{type:"checkbox",className:"mr-1",checked:be,onChange:e=>ge(e.target.checked)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1341,columnNumber:11},this),"Afficher archivÃ©s"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1340,columnNumber:9},this),a.jsxDEV("label",{className:"text-sm text-gray-600",children:"Nom"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1345,columnNumber:9},this),a.jsxDEV("input",{className:"border rounded px-2 py-1 w-64 hover:border-gray-400",placeholder:F?"Nom lisible de ce devis":"DÃ©faut",value:ve,onChange:e=>he(e.target.value),disabled:!M||!P},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1346,columnNumber:9},this),Me&&a.jsxDEV("span",{className:"text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded",children:"ArchivÃ©"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1354,columnNumber:11},this),a.jsxDEV("button",{type:"button",className:"border rounded px-2 py-1 text-sm hover:bg-gray-50",disabled:!M||!P,onClick:async()=>{if(!M||!P)return;const s=window.prompt("Nom du nouveau devis :",ve||"");if(null===s)return;const i=(s||"").trim(),r=Ue(),a=`${P}::${r}`;try{const s=(new Date).toISOString(),n={...{...X||{}},_meta:{name:i||`Devis ${r}`,createdAt:s,updatedAt:s}},l={...(null==z?void 0:z.data)||{}};l.devis=l.devis||{},l.devis[a]=n,await t(`/api/leads/${M}`,{data:l});const o=await e(`/api/leads/${M}`);B(o);const c=new URLSearchParams(U);c.set("devisId",r),I(c,{replace:!0}),he(i)}catch{}},children:"Enregistrer sousâ€¦"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1357,columnNumber:9},this),a.jsxDEV("button",{type:"button",className:"border rounded px-2 py-1 text-sm hover:bg-gray-50",disabled:!M||!P,onClick:async()=>{if(!M||!P)return;const s=Ue(),i=`${P}::${s}`;try{const r=(new Date).toISOString(),a={...X||{}},n=(null==ve?void 0:ve.trim())?`Copie de ${ve}`:`Copie ${s}`,l={...a,_meta:{name:n,createdAt:r,updatedAt:r}},o={...(null==z?void 0:z.data)||{}};o.devis=o.devis||{},o.devis[i]=l,await t(`/api/leads/${M}`,{data:o});const c=await e(`/api/leads/${M}`);B(c);const d=new URLSearchParams(U);d.set("devisId",s),I(d,{replace:!0}),he(n)}catch{}},children:"Dupliquer en nouveau devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1399,columnNumber:9},this),a.jsxDEV("button",{type:"button",className:"border rounded px-2 py-1 text-sm text-red-600 hover:bg-red-50",disabled:!M||!P,onClick:async()=>{var s;if(!M||!P)return;const i=!F,r=(null==ve?void 0:ve.trim())||(i?"DÃ©faut":F);if(window.confirm(`Supprimer le devis "${r}" ? Cette action est dÃ©finitive.`))try{const i={...(null==z?void 0:z.data)||{}};i.devis=i.devis||{},i.devis[_]&&delete i.devis[_],await t(`/api/leads/${M}`,{data:i});const r=await e(`/api/leads/${M}`);B(r);const a=(null==(s=null==r?void 0:r.data)?void 0:s.devis)||{},n=Object.keys(a).filter(e=>e===P||e.startsWith(`${P}::`)),l=new URLSearchParams(U);if(n.includes(P))l.delete("devisId");else if(n.length>0){const e=n.find(e=>e.startsWith(`${P}::`));if(e){const t=e.substring(P.length+2);l.set("devisId",t)}else l.delete("devisId")}else{const e=Ue();l.set("devisId",e)}I(l,{replace:!0})}catch{}},children:"Supprimer ce devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1440,columnNumber:9},this),a.jsxDEV("button",{type:"button",className:"border rounded px-2 py-1 text-sm hover:bg-gray-50",disabled:!M||!P,onClick:async()=>{if(!M||!P)return;const s=window.prompt("Nouveau nom du devis :",ve||"");if(null===s)return;const i=(s||"").trim();try{const s=(new Date).toISOString(),r={...(null==z?void 0:z.data)||{}};r.devis=r.devis||{};const a=r.devis[_]||{},n=a&&"object"==typeof a?a._meta:void 0,l={...n,name:i,updatedAt:s,createdAt:(null==n?void 0:n.createdAt)||s};r.devis[_]={...a,_meta:l},await t(`/api/leads/${M}`,{data:r});const o=await e(`/api/leads/${M}`);B(o),he(i)}catch{}},children:"Renommer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1490,columnNumber:9},this),a.jsxDEV("button",{type:"button",className:"border rounded px-2 py-1 text-sm hover:bg-gray-50",disabled:!M||!P,onClick:async()=>{var s;if(M&&P)try{const i=(new Date).toISOString(),r={...(null==z?void 0:z.data)||{}};r.devis=r.devis||{};const a=r.devis[_]||{},n=a&&"object"==typeof a?a._meta:void 0,l=!(null==n?void 0:n.archived),o={...n,archived:l,updatedAt:i,createdAt:(null==n?void 0:n.createdAt)||i};r.devis[_]={...a,_meta:o},await t(`/api/leads/${M}`,{data:r});const c=await e(`/api/leads/${M}`);if(B(c),l&&!be){const e=(null==(s=null==c?void 0:c.data)?void 0:s.devis)||{},t=Object.keys(e).filter(e=>e===P||e.startsWith(`${P}::`)).filter(t=>{const s=e[t],i=s&&"object"==typeof s?s._meta:void 0;return!(null==i?void 0:i.archived)}),i=new URLSearchParams(U);if(t.includes(P))i.delete("devisId");else if(t.length>0){const e=t.find(e=>e.startsWith(`${P}::`));if(e){const t=e.substring(P.length+2);i.set("devisId",t)}else i.delete("devisId")}else{const e=Ue();i.set("devisId",e)}I(i,{replace:!0})}}catch{}},children:Me?"Restaurer":"Archiver"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1519,columnNumber:9},this),a.jsxDEV("button",{type:"button",className:"border rounded px-2 py-1 text-sm "+(De?"bg-gray-200":"hover:bg-gray-50"),disabled:!M||!P,onClick:()=>Ne(e=>!e),children:De?"Masquer donnÃ©es":"DonnÃ©es brutes"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1570,columnNumber:9},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1250,columnNumber:7},this),!P&&a.jsxDEV("div",{className:"p-4 text-gray-600",children:"Choisissez un formulaire pour commencer."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1581,columnNumber:9},this),P&&!M&&a.jsxDEV("div",{className:"p-4 text-gray-600",children:"SÃ©lectionnez un lead pour charger/sauvegarder les valeurs."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1584,columnNumber:9},this),!Le&&P&&a.jsxDEV("div",{className:"p-4",children:"Chargementâ€¦"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1588,columnNumber:9},this),Le&&$&&a.jsxDEV(a.Fragment,{children:[De&&a.jsxDEV("div",{className:"mb-4 border rounded bg-white p-3 text-xs font-mono whitespace-pre-wrap max-h-72 overflow-auto",children:[a.jsxDEV("div",{className:"mb-2 font-semibold",children:"Snapshot JSON stockÃ©"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1596,columnNumber:11},this),Pe?JSON.stringify(Pe,null,2):"â€” Aucune donnÃ©e â€”"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1595,columnNumber:9},this),a.jsxDEV("div",{className:"flex flex-wrap gap-2 mb-4 border-b pb-2",children:_e.map((e,t)=>a.jsxDEV("button",{className:"px-3 py-1 rounded-t "+(t===H?"bg-blue-600 text-white":"bg-gray-100"),onClick:()=>K(t),children:e.name},e.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1602,columnNumber:11},this))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1600,columnNumber:7},this),_e[H]&&a.jsxDEV("div",{className:"bg-white border rounded p-4",children:[a.jsxDEV("div",{className:"grid grid-cols-4 gap-4",children:(()=>{const e=_e[H],t=[...e.fields||[]];if(("custom"===e.sectionType||"personnalisÃ©"===e.sectionType)&&e.menuFieldId){const s=t.findIndex(t=>String(t.id)===String(e.menuFieldId));if(s>0){const[e]=t.splice(s,1);t.unshift(e)}}return t})().map(e=>{var t,s,r,n;let l="col-span-4";"1/2"===e.width?l="col-span-2":"1/4"===e.width?l="col-span-1":"3/4"===e.width?l="col-span-3":"1/1"===e.width&&(l="col-span-4");const o=X[e.id]??"",c=Array.isArray(e.options)?e.options:[],d={...k(e.id,X),required:Boolean(e.required)},{styles:u,classNames:m}=p(e),f=C[e.id];return!d.visible||e.advancedConfig&&e.advancedConfig.hidden?null:"donnee"===e.type?a.jsxDEV("div",{className:`flex flex-col ${l}`,children:[a.jsxDEV("label",{className:"font-medium mb-1",children:e.label},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1651,columnNumber:21},this),(()=>{const e=o;return null==e?a.jsxDEV("div",{className:"text-sm text-gray-500",children:"â€”"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1654,columnNumber:74},this):"object"==typeof e?a.jsxDEV("pre",{className:`border rounded px-2 py-2 text-xs bg-gray-50 whitespace-pre-wrap break-words ${m.join(" ")}`,style:u,children:JSON.stringify(e,null,2)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1657,columnNumber:27},this):a.jsxDEV("input",{className:`border rounded px-2 py-1 ${m.join(" ")}`,style:{...u,backgroundColor:u.backgroundColor||"#f9fafb",color:u.color||"#374151"},value:String(e),readOnly:!0},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1666,columnNumber:25},this)})()]},e.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1650,columnNumber:19},this):a.jsxDEV("div",{className:`flex flex-col ${l}`,children:[a.jsxDEV("label",{className:"font-medium mb-1 flex items-center gap-2",children:[a.jsxDEV("span",{children:[e.label,(d.required||e.required)&&a.jsxDEV("span",{className:"text-red-500 ml-1",children:"*"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1685,columnNumber:71},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1685,columnNumber:21},this),oe.has(e.id)?a.jsxDEV("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 border border-amber-200",title:"Valeur manuelle (mode auto dÃ©sactivÃ©)",children:"MANUEL"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1687,columnNumber:23},this):ne.has(e.id)?a.jsxDEV("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-700 border border-indigo-200",title:"Valeur calculÃ©e par formule â€“ taper pour reprendre la main",children:"AUTO"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1689,columnNumber:23},this):null]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1684,columnNumber:19},this),"text"===e.type&&a.jsxDEV("div",{children:[a.jsxDEV("input",{disabled:d.disabled,className:`border rounded px-2 py-1 ${m.join(" ")}`,style:u,value:o,onChange:t=>Fe(e.id,t.target.value)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1695,columnNumber:23},this),f&&a.jsxDEV("div",{className:"text-red-500 text-sm mt-1",children:f},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1702,columnNumber:38},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1694,columnNumber:21},this),"password"===e.type&&a.jsxDEV("div",{children:[a.jsxDEV("input",{disabled:d.disabled,type:"password",className:`border rounded px-2 py-1 ${m.join(" ")}`,style:u,value:o,onChange:t=>Fe(e.id,t.target.value)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1707,columnNumber:23},this),f&&a.jsxDEV("div",{className:"text-red-500 text-sm mt-1",children:f},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1715,columnNumber:38},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1706,columnNumber:21},this),"number"===e.type&&a.jsxDEV("div",{children:[a.jsxDEV("input",{disabled:d.disabled,type:"text",inputMode:"decimal",className:`border rounded px-2 py-1 ${m.join(" ")}`,style:u,value:o,onChange:t=>{const s=t.target.value;if(""===s)return void Fe(e.id,"");if(/^[+-]?\d*[.,]?$/.test(s))return void Fe(e.id,s);const i=O(s);Fe(e.id,null===i?s:i)},onBlur:t=>{const s=O(t.target.value);null!==s&&Fe(e.id,s)}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1720,columnNumber:23},this),f&&a.jsxDEV("div",{className:"text-red-500 text-sm mt-1",children:f},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1740,columnNumber:38},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1719,columnNumber:21},this),"textarea"===e.type&&a.jsxDEV("textarea",{disabled:d.disabled,className:`border rounded px-2 py-1 min-h-[96px] ${m.join(" ")}`,style:u,value:o||"",onChange:t=>Fe(e.id,t.target.value)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1744,columnNumber:21},this),"date"===e.type&&a.jsxDEV("input",{disabled:d.disabled,type:"date",className:`border rounded px-2 py-1 ${m.join(" ")}`,style:u,value:o,onChange:t=>Fe(e.id,t.target.value)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1753,columnNumber:21},this),("select"===e.type||"advanced_select"===e.type)&&("select"===e.type?a.jsxDEV("select",{disabled:d.disabled,className:`border rounded px-2 py-1 ${m.join(" ")}`,style:u,value:o,onChange:t=>Fe(e.id,t.target.value),children:[a.jsxDEV("option",{value:"",children:"SÃ©lectionnerâ€¦"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1771,columnNumber:25},this),c.map(e=>a.jsxDEV("option",{value:e.value||e.label,children:e.label},e.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1773,columnNumber:27},this))]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1764,columnNumber:23},this):a.jsxDEV(D,{fieldId:e.id,disabled:d.disabled,loadChildren:ke,fetchNodeDetail:je,style:u,className:m.join(" "),onChange:t=>{Fe(e.id,t)},value:o},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1778,columnNumber:23},this)),"radio"===e.type&&a.jsxDEV("div",{className:"flex flex-col gap-1",children:c.map(t=>{const s=o===(t.value||t.label);return a.jsxDEV("label",{className:"inline-flex items-center gap-2",children:[a.jsxDEV("input",{type:"radio",name:`radio-${_e[H].id}-${e.id}`,disabled:d.disabled,checked:s,onChange:()=>Fe(e.id,t.value||t.label)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1799,columnNumber:29},this),t.label]},t.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1798,columnNumber:27},this)})},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1794,columnNumber:21},this),"checkboxes"===e.type&&a.jsxDEV("div",{className:"flex flex-col gap-1",children:c.map(t=>{const s=(Array.isArray(o)?o:[]).includes(t.value||t.label);return a.jsxDEV("label",{className:"inline-flex items-center gap-2",children:[a.jsxDEV("input",{type:"checkbox",disabled:d.disabled,checked:s,onChange:s=>{const i=Array.isArray(X[e.id])?[...X[e.id]]:[],r=t.value||t.label;s.target.checked?Fe(e.id,[...i,r]):Fe(e.id,i.filter(e=>e!==r))}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1819,columnNumber:29},this),t.label]},t.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1818,columnNumber:27},this)})},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1813,columnNumber:21},this),"image_admin"===e.type&&e.advancedConfig&&e.advancedConfig.imageUrl&&a.jsxDEV("img",{src:e.advancedConfig.imageUrl,alt:e.label,className:"mt-2 max-h-56 object-contain border rounded"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1838,columnNumber:21},this),"image_user"===e.type&&a.jsxDEV("div",{className:"flex flex-col gap-2",children:[a.jsxDEV("input",{type:"file",accept:(null==(t=e.advancedConfig)?void 0:t.accept)||"image/*",multiple:Boolean(null==(s=e.advancedConfig)?void 0:s.multiple),disabled:d.disabled,className:`${m.join(" ")}`,style:u,onChange:async t=>{var s;const i=Array.from(t.target.files||[]);if(0===i.length)return;const r=e=>new Promise(t=>{const s=new FileReader;s.onload=s=>{var i;return t({name:e.name,type:e.type,size:e.size,dataUrl:null==(i=s.target)?void 0:i.result})},s.readAsDataURL(e)});if(Boolean(null==(s=e.advancedConfig)?void 0:s.multiple)){const t=await Promise.all(i.map(r));Fe(e.id,t)}else{const t=i[0];if(t){const s=await r(t);Fe(e.id,s)}}}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1848,columnNumber:23},this),(()=>{var t;if(Boolean(null==(t=e.advancedConfig)?void 0:t.multiple)&&Array.isArray(o)){const e=o;return a.jsxDEV("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2 mt-1",children:e.map((e,t)=>a.jsxDEV("img",{src:e.dataUrl,alt:e.name,className:"max-h-40 object-contain border rounded"},t,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1884,columnNumber:33},this))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1882,columnNumber:29},this)}return h(o)&&o.dataUrl?a.jsxDEV("img",{src:o.dataUrl,alt:o.name,className:"mt-2 max-h-56 object-contain border rounded"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1891,columnNumber:29},this):null})()]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1847,columnNumber:21},this),"fichier_user"===e.type&&a.jsxDEV("div",{className:"flex flex-col gap-2",children:[a.jsxDEV("input",{type:"file",accept:(null==(r=e.advancedConfig)?void 0:r.accept)||"*/*",multiple:Boolean(null==(n=e.advancedConfig)?void 0:n.multiple),disabled:d.disabled,className:`${m.join(" ")}`,style:u,onChange:async t=>{var s;const i=Array.from(t.target.files||[]);if(0===i.length)return;const r=e=>new Promise(t=>{const s=new FileReader;s.onload=s=>{var i;return t({name:e.name,type:e.type,size:e.size,dataUrl:null==(i=s.target)?void 0:i.result})},s.readAsDataURL(e)});if(Boolean(null==(s=e.advancedConfig)?void 0:s.multiple)){const t=await Promise.all(i.map(r));Fe(e.id,t)}else{const t=i[0];if(t){const s=await r(t);Fe(e.id,s)}}}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1902,columnNumber:23},this),(()=>{var t;if(Boolean(null==(t=e.advancedConfig)?void 0:t.multiple)&&Array.isArray(o)){const e=o;return a.jsxDEV("ul",{className:"list-disc pl-4 text-sm text-blue-700",children:e.map((e,t)=>a.jsxDEV("li",{children:a.jsxDEV("a",{className:"underline",href:e.dataUrl,target:"_blank",rel:"noreferrer",children:e.name},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1939,columnNumber:35},this)},t,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1938,columnNumber:33},this))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1936,columnNumber:29},this)}return h(o)&&o.name?a.jsxDEV("a",{className:"text-blue-600 underline text-sm",href:o.dataUrl,target:"_blank",rel:"noreferrer",children:o.name},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1947,columnNumber:29},this):null})()]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1901,columnNumber:21},this),"tableau"===e.type&&a.jsxDEV("div",{className:"flex flex-col gap-2",children:(()=>{const t=e.config||{},s=t.columns||[],r=t.templates||[];if(0===s.length)return a.jsxDEV("div",{className:"text-sm text-gray-500",children:"Aucune colonne configurÃ©e. DÃ©finissez la structure du tableau dans le formulaire."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1966,columnNumber:34},this);const n="super_admin"===(null==i?void 0:i.role)||"admin"===(null==i?void 0:i.role),l=Array.isArray(o)?o:[];return a.jsxDEV(a.Fragment,{children:[r.length>0&&n&&a.jsxDEV("div",{className:"bg-blue-50 p-3 rounded-md border border-blue-200",children:[a.jsxDEV("div",{className:"text-sm font-medium text-blue-800 mb-2",children:"Templates disponibles"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2001,columnNumber:33},this),a.jsxDEV("div",{className:"flex flex-wrap gap-2",children:r.map((t,s)=>a.jsxDEV("button",{type:"button",onClick:()=>(t=>{Fe(e.id,[...l,...t.data])})(t),className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded border",children:[t.name,t.description&&a.jsxDEV("span",{className:"ml-1 text-blue-500",children:["(",t.description,")"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2012,columnNumber:41},this)]},s,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2004,columnNumber:37},this))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2002,columnNumber:33},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2e3,columnNumber:31},this),a.jsxDEV("div",{className:"border border-gray-300 rounded-md",children:a.jsxDEV("table",{className:"min-w-full",children:[a.jsxDEV("thead",{className:"bg-gray-50",children:a.jsxDEV("tr",{children:[s.map(e=>a.jsxDEV("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e.label},e.key,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2026,columnNumber:39},this)),n&&a.jsxDEV("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-16",children:"Actions"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2030,columnNumber:49},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2024,columnNumber:35},this)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2023,columnNumber:33},this),a.jsxDEV("tbody",{className:"bg-white divide-y divide-gray-200",children:l.map((t,i)=>a.jsxDEV("tr",{className:"hover:bg-gray-50",children:[s.map(s=>a.jsxDEV("td",{className:"px-3 py-2 whitespace-nowrap",children:n?a.jsxDEV("input",{type:"number"===s.type||"currency"===s.type?"number":"text",value:String(t[s.key]||""),onChange:t=>((t,s,i)=>{const r=l.map((e,r)=>r===t?{...e,[s]:i}:e);Fe(e.id,r)})(i,s.key,"number"===s.type?parseFloat(t.target.value)||0:t.target.value),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:s.label},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2039,columnNumber:45},this):a.jsxDEV("span",{className:"text-sm text-gray-900",children:"currency"===s.type?`${t[s.key]}â‚¬`:String(t[s.key]||"")},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2047,columnNumber:45},this)},s.key,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2037,columnNumber:41},this)),n&&a.jsxDEV("td",{className:"px-3 py-2 text-right",children:a.jsxDEV("button",{type:"button",onClick:()=>(t=>{const s=l.filter((e,s)=>s!==t);Fe(e.id,s)})(i),className:"text-red-600 hover:text-red-800 text-sm",children:"ðŸ—‘ï¸"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2055,columnNumber:43},this)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2054,columnNumber:41},this)]},i,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2035,columnNumber:37},this))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2033,columnNumber:33},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2022,columnNumber:31},this)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2021,columnNumber:29},this),n&&a.jsxDEV("div",{className:"flex gap-2",children:a.jsxDEV("button",{type:"button",onClick:()=>{const t={};s.forEach(e=>{t[e.key]="number"===e.type?0:""}),Fe(e.id,[...l,t])},className:"bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm",children:"+ Ajouter une ligne"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2073,columnNumber:33},this)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2072,columnNumber:31},this),!n&&a.jsxDEV("div",{className:"text-xs text-gray-500 italic",children:"Seuls les administrateurs peuvent modifier ce tableau."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2085,columnNumber:31},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1997,columnNumber:27},this)})()},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1957,columnNumber:21},this)]},e.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1683,columnNumber:17},this)})},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1615,columnNumber:11},this),Object.entries(C).some(([,e])=>e)&&a.jsxDEV("div",{className:"mt-2 text-sm text-red-600",children:Object.entries(C).map(([e,t])=>t?a.jsxDEV("div",{children:["â€¢ ",t]},e,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2103,columnNumber:17},this):null)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2101,columnNumber:13},this),a.jsxDEV("div",{className:"text-xs text-gray-500 mt-2",children:Z?"Sauvegardeâ€¦":"Autosave activÃ©"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2107,columnNumber:11},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1614,columnNumber:9},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1593,columnNumber:7},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:1246,columnNumber:5},this)}function D({fieldId:e,disabled:t,loadChildren:s,fetchNodeDetail:i,onChange:r,value:n,style:l,className:c}){const[d,u]=o.useState([]),[m,p]=o.useState(null),[f,v]=o.useState(""),[h,b]=o.useState(""),g=`border rounded px-2 py-1 w-full text-sm h-10 ${c||""}`;o.useEffect(()=>{let t=!0;return(async()=>{const r=await s(e,null);if(!t)return;const a=n&&"object"==typeof n?n.nodeId:void 0;a?(u([{parentId:null,options:r,selectedId:""}]),setTimeout(async()=>{const t=[],l=async(i,n=0)=>{const o=0===n?r:await s(e,i);if(!o||0===o.length)return!1;if(o.some(e=>e.id===a))return t.push(a),!0;if(n>6)return!1;for(const r of o){const i=await s(e,r.id);if(i.some(e=>e.id===a))return t.push(r.id,a),!0;if(i.length>0){if(await l(r.id,n+1))return t.unshift(r.id),!0}}return!1};try{await l(null,0)}catch{}if(t.length>0){const l=[{parentId:null,options:r,selectedId:t[0]||""}];for(let i=0;i<t.length;i++){const r=t[i];if(!r)continue;const a=await s(e,r);if(0===a.length)continue;const n=t[i+1]||"";l.push({parentId:r,options:a,selectedId:n})}u(l),v(a);const o=n&&"object"==typeof n?n.extra:void 0;void 0!==o&&b(String(o));try{const e=await i(a),t=(null==e?void 0:e.data)&&"object"==typeof e.data?e.data.nextField:void 0;if(t&&t.type){const s=((null==e?void 0:e.label)||"").toLowerCase().normalize("NFD").replace(/[^a-z0-9 ]/g,""),i=s.includes("calcul")&&s.includes("prix");p(i?null:{type:t.type,placeholder:t.placeholder})}}catch{}}else u([{parentId:null,options:r,selectedId:""}])},10)):u([{parentId:null,options:r,selectedId:""}])})(),()=>{t=!1}},[e,s,n,i]);const D=o.useCallback(async(t,a)=>{u(e=>e.slice(0,t+1).map((e,s)=>s===t?{...e,selectedId:a}:e));const n=await s(e,a||null);if(n.length>0&&a)u(e=>[...e,{parentId:a,options:n,selectedId:""}]),p(null),v(""),b("");else{const e=d[t],s=((null==e?void 0:e.options)||[]).find(e=>e.id===a),n=(null==s?void 0:s.value)||(null==s?void 0:s.label)||"";v(a||"");try{if(a){const e=await i(a),t=(null==e?void 0:e.data)&&"object"==typeof e.data?e.data.nextField:void 0;if(t&&t.type){const s=((null==e?void 0:e.label)||n||"").toLowerCase().normalize("NFD").replace(/[^a-z0-9 ]/g,"");if(!(s.includes("calcul")&&s.includes("prix")))return p({type:t.type,placeholder:t.placeholder}),b(""),void r({selection:n,nodeId:a,extra:""});p(null)}}}catch{}p(null),r({selection:n,nodeId:a||"",extra:void 0}),u(e=>e.slice(0,t+1))}},[e,s,r,d,i]);return a.jsxDEV("div",{className:"flex flex-col gap-2",children:[d.map((e,s)=>a.jsxDEV("select",{className:g,style:l,disabled:t,value:e.selectedId,onChange:e=>D(s,e.target.value),children:[a.jsxDEV("option",{value:"",children:"SÃ©lectionnerâ€¦"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2276,columnNumber:11},this),e.options.map(e=>a.jsxDEV("option",{value:e.id,children:e.label},e.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2278,columnNumber:13},this))]},`${e.parentId||"root"}-${s}`,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2268,columnNumber:9},this)),m&&a.jsxDEV("div",{className:"mt-1",children:"textarea"===m.type?a.jsxDEV("textarea",{className:"border rounded px-2 py-1 w-full text-sm min-h-[2.5rem]",placeholder:m.placeholder||"",disabled:t,value:h,onChange:e=>{const t=e.target.value;b(t);const s="object"==typeof n&&n?n.selection:"string"==typeof n?n:void 0;r({selection:s,nodeId:f,extra:t})}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2285,columnNumber:13},this):"checkbox"===m.type?a.jsxDEV("div",{className:"border rounded px-2 w-full h-10 flex items-center text-sm",children:a.jsxDEV("label",{className:"inline-flex items-center gap-2 w-full",children:[a.jsxDEV("input",{type:"checkbox",disabled:t,checked:"true"===h,onChange:e=>{const t=e.target.checked?"true":"false";b(t);const s="object"==typeof n&&n?n.selection:"string"==typeof n?n:void 0;r({selection:s,nodeId:f,extra:"true"===t})}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2300,columnNumber:17},this),a.jsxDEV("span",{className:"truncate",children:m.placeholder||"Oui / Non"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2311,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2299,columnNumber:15},this)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2298,columnNumber:13},this):a.jsxDEV("input",{className:g,style:l,type:"number"===m.type?"number":"date"===m.type?"date":"text",placeholder:m.placeholder||"",disabled:t,value:h,onChange:e=>{const t=e.target.value;b(t);const s="object"==typeof n&&n?n.selection:"string"==typeof n?n:void 0;r({selection:s,nodeId:f,extra:t})}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2315,columnNumber:13},this)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2283,columnNumber:9},this)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/pages/DevisPage.tsx",lineNumber:2266,columnNumber:5},this)}export{g as default};
