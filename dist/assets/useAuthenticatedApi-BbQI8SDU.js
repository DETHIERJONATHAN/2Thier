import{r as e,u as t}from"./react-vendor-Al_k-ZB6.js";import{u as s}from"./index-C0S0DpaX.js";const r=new Map,o=new Map,n=new Map,a={"/api/field-types":6e4,"/api/ai/status":15e3,"/api/notifications":8e3,"/api/google-auth/status":3e4,"/api/auto-google-auth/status":3e4};function i(){const i=e.useMemo(()=>({none:0,error:1,warn:2,info:3,debug:4}),[]),u=e.useCallback(e=>i[window.__API_LOG_LEVEL||localStorage.getItem("apiLogLevel")||"info"]>=i[e],[i]),d=e.useMemo(()=>({error:(...e)=>u("error")&&void 0,warn:(...e)=>u("warn")&&void 0,info:(...e)=>u("info")&&void 0,debug:(...e)=>u("debug")&&void 0}),[u]),[c,l]=e.useState(null),[p,g]=e.useState(!1),f=t(),{logout:m,currentOrganization:b}=s(),y=e.useMemo(()=>{let e="".trim();if("undefined"!=typeof window){const t=window.__API_BASE_URL;t&&(e=t.trim())}return e&&0!==e.length||(e="undefined"!=typeof window?"":"http://localhost:4000"),e.replace(/\/$/,"")},[""]),h=e.useCallback(()=>{m(),f("/login")},[m,f]),w=e.useCallback(async(e,t={})=>{const{showErrors:s=!0,redirectOnAuth:i=!0,params:u,...c}=t;let p=e;if(u&&Object.keys(u).length>0){const e=new URLSearchParams;Object.entries(u).forEach(([t,s])=>{null!=s&&e.append(t,String(s))});const t=e.toString();t&&(p+=(p.includes("?")?"&":"?")+t)}const f=new Headers(c.headers||{});f.delete("Authorization");const m=null==b?void 0:b.id;m&&f.set("X-Organization-Id",m);const w=sessionStorage.getItem("impersonatedUserId"),E=sessionStorage.getItem("impersonatedOrgId");w&&f.set("x-impersonate-user-id",w),E&&f.set("x-impersonate-org-id",E),!["POST","PUT","PATCH"].includes((c.method||"").toUpperCase())||c.body instanceof FormData||f.set("Content-Type","application/json"),g(!0),l(null);const T=(c.method||"GET").toUpperCase(),S="GET"!==T||t.noLocalCache?void 0:(e=>{for(const t of Object.keys(a))if(e.startsWith(t))return a[t]})(p),v=(null==b?void 0:b.id)||"no-org",L=`${y}${p}#${v}`;if("GET"===T){const e=n.get(L);if(e)return d.debug("Re-use inFlight(data)",p),e}if(S){const e=r.get(L);if(e&&Date.now()-e.time<S)return d.debug("Cache HIT",p),e.data;const t=o.get(L);if(t)return d.debug("Re-use inFlight",p),t}const O=`${y}${p}`;d.info("➡️",T,p,S?`(TTL ${S}ms)`:""),d.debug("Headers",Object.fromEntries(f.entries())),u&&d.debug("Query",u),d.debug("Base URL",y),d.debug("Full URL",O);const j={...c,headers:f,credentials:"include",cache:"no-store"};d.debug("no-store activé");const A=(async()=>{try{const e=fetch(O,j);S&&o.set(L,e);const n=await e;if(Array.isArray(t.suppressErrorLogForStatuses)&&t.suppressErrorLogForStatuses.includes(n.status)?d.debug("⬅️ (suppressed)",n.status,n.statusText,p):d.info("⬅️",n.status,n.statusText,p),d.debug("Headers réponse",Object.fromEntries(n.headers.entries())),401===n.status)return i&&"/login"!==window.location.pathname&&h(),Promise.reject(new Error("Session expirée. Veuillez vous reconnecter."));if(204===n.status)return d.debug("204 No Content",p),{success:!0};if("blob"===t.responseType){const e=await n.blob();if(!n.ok)throw new Error(`Erreur ${n.status}`);return d.debug("Blob taille",e.size),e}const a=n.headers.get("content-type")||"";d.debug("Content-Type",a);let u=null;if(a.includes("application/json"))u=await n.json(),u&&"object"==typeof u&&d.debug("JSON keys",Object.keys(u));else{const e=await n.text();Array.isArray(t.suppressErrorLogForStatuses)&&t.suppressErrorLogForStatuses.includes(n.status)?d.debug("Réponse non-JSON (suppressed)",{url:p,contentType:a,status:n.status}):d.warn("Réponse non-JSON",{url:p,contentType:a,status:n.status,preview:e.slice(0,100)}),u=e}if(!n.ok){if(Array.isArray(t.suppressErrorLogForStatuses)&&t.suppressErrorLogForStatuses.includes(n.status))return d.debug("API Suppressed Error (no-throw)",{url:p,status:n.status,statusText:n.statusText}),null;{d.error("API Error",{url:p,status:n.status,statusText:n.statusText,data:u});let e=`Erreur ${n.status}`;if("object"==typeof u&&null!==u){const t=u,s=t.message??t.error;"string"==typeof s&&(e=s)}else"string"==typeof u&&u.trim().length>0&&(e=u);s&&l(e);const t=new Error(e);return t.status=n.status,Promise.reject(t)}}return S&&(r.set(L,{time:Date.now(),data:u}),o.delete(L),d.debug("Cache WRITE",p)),u}catch(e){S&&o.delete(L),d.error("Network/parsing error",p,e);const t=(null==e?void 0:e.message)||"Erreur réseau";return s&&l(t),Promise.reject(new Error(t))}finally{g(!1)}})();"GET"===T&&n.set(L,A);try{return await A}finally{"GET"===T&&n.delete(L)}},[b,h,d,y]),E=e.useMemo(()=>({get:(e,t={})=>w(e,{...t,method:"GET"}),post:(e,t,s={})=>{const r=t instanceof FormData;return w(e,{...s,method:"POST",body:void 0===t?void 0:r?t:JSON.stringify(t)})},put:(e,t,s={})=>{const r=t instanceof FormData;return w(e,{...s,method:"PUT",body:void 0===t?void 0:r?t:JSON.stringify(t)})},patch:(e,t,s={})=>{const r=t instanceof FormData;return w(e,{...s,method:"PATCH",body:void 0===t?void 0:r?t:JSON.stringify(t)})},delete:(e,t={})=>w(e,{...t,method:"DELETE"})}),[w]);return{api:E,isLoading:p,globalError:c,...E}}export{i as u};
