import{j as e}from"./index-C0S0DpaX.js";import{r as a}from"./react-vendor-Al_k-ZB6.js";import{u as r}from"./useAuthenticatedApi-BbQI8SDU.js";import{u as n}from"./TreeBranchLeafWrapper-Bsu92XNs.js";import{s as i,a0 as t,a as s,T as o,an as l,B as c,I as m,$ as d,by as p,ao as u,b}from"./antd-vendor-zFcGztvE.js";import"./dnd-vendor-D0spq1w0.js";const{Title:h,Text:v}=o,f=({treeId:o,nodeId:f,value:N,onChange:D,readOnly:C})=>{const{api:k}=r(),[x,P]=a.useState([]),[g,L]=a.useState([]),[E,V]=a.useState(()=>({targetTreeId:null==N?void 0:N.targetTreeId,targetNodeId:null==N?void 0:N.targetNodeId,mode:(null==N?void 0:N.mode)||"JUMP",carryContext:Boolean(null==N?void 0:N.carryContext),params:(null==N?void 0:N.params)||{}})),[y,w]=a.useState(!1),[S,T]=a.useState([]),[A,B]=a.useState(null),[M,j]=a.useState("");a.useEffect(()=>{let e=!0;return(async()=>{var a,r;try{w(!0);const n=await k.get(`/api/treebranchleaf/nodes/${f}`),i=(null==(r=null==(a=null==n?void 0:n.metadata)?void 0:a.capabilities)?void 0:r.links)||[];if(i.length>0){const e=i[0];T(i),B(e.id),V(e.config),j(e.name||""),null==D||D(e.config)}else{const a=await k.get(`/api/treebranchleaf/nodes/${f}/link`);if(!e)return;const r={targetTreeId:null==a?void 0:a.targetTreeId,targetNodeId:null==a?void 0:a.targetNodeId,mode:(null==a?void 0:a.mode)||"JUMP",carryContext:Boolean(null==a?void 0:a.carryContext),params:(null==a?void 0:a.params)||{}};V(r);const i={id:`link_${Date.now()}`,name:"Lien 1",config:r};if(T([i]),B(i.id),j(i.name),o)try{const e=(null==n?void 0:n.metadata)||{},a={...e,capabilities:{...e.capabilities,links:[i]}};await k.put(`/api/treebranchleaf/trees/${o}/nodes/${f}`,{metadata:a})}catch{}null==D||D(r)}const t=await k.get("/api/treebranchleaf/trees");e&&Array.isArray(t)&&P(t)}catch{}finally{e&&w(!1)}})(),()=>{e=!1}},[k,f,D,N,o]),a.useEffect(()=>{let e=!0;return(async()=>{if(E.targetTreeId)try{const a=await k.get(`/api/treebranchleaf/trees/${E.targetTreeId}/nodes`);e&&Array.isArray(a)&&L(a)}catch{}else L([])})(),()=>{e=!1}},[k,E.targetTreeId]);const O=a.useCallback(async e=>{if(e.targetNodeId&&e.targetNodeId===f)i.error("Le lien ne peut pas cibler ce m√™me n≈ìud.");else try{await k.put(`/api/treebranchleaf/nodes/${f}/link`,e),null==D||D(e)}catch{i.error("Erreur de sauvegarde du lien")}},[k,f,D]),R=n(O,400),I=a.useCallback((e,a)=>{V(r=>{const n={...r,[e]:a};return"targetTreeId"===e&&(n.targetNodeId=void 0),R(n),n})},[R]),U=a.useMemo(()=>x.map(e=>({value:e.id,label:e.name})),[x]),$=a.useMemo(()=>g.map(e=>({value:e.id,label:e.label})),[g]),z=a.useMemo(()=>JSON.stringify(E.params||{},null,2),[E.params]),J=a.useCallback(e=>{try{const a=JSON.parse(e.target.value||"{}");I("params",a)}catch{}},[I]),W=a.useCallback(()=>{t.confirm({title:"Supprimer le lien ?",content:"Cette action vide la configuration et d√©sactive la capacit√©.",okText:"Supprimer",okButtonProps:{danger:!0},cancelText:"Annuler",onOk:async()=>{try{const e={targetTreeId:void 0,targetNodeId:void 0,mode:"JUMP",carryContext:!1,params:{}};await k.put(`/api/treebranchleaf/nodes/${f}/link`,e);try{await k.put(`/api/treebranchleaf/nodes/${f}`,{hasLink:!1})}catch{}V(e),null==D||D(e),i.success("Lien supprim√©")}catch{i.error("Impossible de supprimer le lien")}}})},[k,f,D]);return e.jsxDEV(s,{size:"small",bordered:!0,loading:y,children:[e.jsxDEV(h,{level:5,children:"üîó Lien"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:179,columnNumber:7},void 0),e.jsxDEV("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxDEV(v,{type:"secondary",children:"Instance:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:182,columnNumber:9},void 0),e.jsxDEV(l,{size:"small",style:{minWidth:220},value:A||void 0,options:S.map(e=>({value:e.id,label:e.name||"Sans nom"})),onChange:e=>{B(e);const a=S.find(a=>a.id===e);a&&(V(a.config),j(a.name||""))},placeholder:"S√©lectionner une instance"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:183,columnNumber:9},void 0),e.jsxDEV(c,{size:"small",onClick:async()=>{var e;const a=`link_${Date.now()}_${Math.floor(1e3*Math.random())}`,r={id:a,name:`Lien ${(S.length||0)+1}`,config:E},n=[...S,r];if(T(n),B(a),j(r.name),o)try{const a=await k.get(`/api/treebranchleaf/nodes/${f}`),n=(null==a?void 0:a.metadata)||{},i=(null==(e=n.capabilities)?void 0:e.links)||[],t={...n,capabilities:{...n.capabilities,links:[...i,r]}};await k.put(`/api/treebranchleaf/trees/${o}/nodes/${f}`,{metadata:t})}catch{}},children:"Ajouter"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:195,columnNumber:9},void 0),e.jsxDEV(c,{size:"small",danger:!0,onClick:W,disabled:!A,children:"Supprimer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:212,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:181,columnNumber:7},void 0),e.jsxDEV("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxDEV(v,{type:"secondary",children:"Nom:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:217,columnNumber:9},void 0),e.jsxDEV(m,{size:"small",style:{maxWidth:280},placeholder:"Nom du lien",value:M,onChange:e=>{const a=e.target.value;j(a),(async()=>{var e;if(o&&A)try{const r=await k.get(`/api/treebranchleaf/nodes/${f}`),n=(null==r?void 0:r.metadata)||{},i=((null==(e=n.capabilities)?void 0:e.links)||S||[]).map(e=>e.id===A?{...e,name:a}:e),t={...n,capabilities:{...n.capabilities,links:i}};await k.put(`/api/treebranchleaf/trees/${o}/nodes/${f}`,{metadata:t}),T(i)}catch{}})()}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:218,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:216,columnNumber:7},void 0),e.jsxDEV("div",{style:{marginBottom:8,padding:"6px 8px",background:"#fafafa",border:"1px solid #f0f0f0",borderRadius:6},children:[e.jsxDEV(v,{strong:!0,style:{marginRight:8},children:"R√©sum√© test:"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:244,columnNumber:9},void 0),e.jsxDEV("div",{children:e.jsxDEV(v,{type:"secondary",children:["Cible: ",E.targetTreeId?`arbre ${E.targetTreeId}`:"‚Äî"," ",E.targetNodeId?`‚Üí n≈ìud ${E.targetNodeId}`:""]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:246,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:245,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:243,columnNumber:7},void 0),e.jsxDEV("div",{style:{marginBottom:8},children:e.jsxDEV(c,{size:"small",danger:!0,onClick:W,children:"Supprimer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:250,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:249,columnNumber:7},void 0),e.jsxDEV(d,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsxDEV("div",{children:[e.jsxDEV(v,{type:"secondary",style:{fontSize:12},children:"Arbre cible"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:254,columnNumber:11},void 0),e.jsxDEV(l,{showSearch:!0,placeholder:"Choisir un arbre",options:U,value:E.targetTreeId,onChange:e=>I("targetTreeId",e),disabled:C,style:{width:"100%"},optionFilterProp:"label"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:255,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:253,columnNumber:9},void 0),e.jsxDEV("div",{children:[e.jsxDEV(v,{type:"secondary",style:{fontSize:12},children:"N≈ìud cible"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:267,columnNumber:11},void 0),e.jsxDEV(l,{showSearch:!0,placeholder:"Choisir un n≈ìud",options:$,value:E.targetNodeId,onChange:e=>I("targetNodeId",e),disabled:C||!E.targetTreeId,style:{width:"100%"},optionFilterProp:"label"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:268,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:266,columnNumber:9},void 0),e.jsxDEV("div",{children:[e.jsxDEV(v,{type:"secondary",style:{fontSize:12},children:"Mode"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:280,columnNumber:11},void 0),e.jsxDEV(p.Group,{value:E.mode,onChange:e=>I("mode",e.target.value),disabled:C,children:[e.jsxDEV(p.Button,{value:"JUMP",children:"Aller √†"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:286,columnNumber:13},void 0),e.jsxDEV(p.Button,{value:"APPEND_SECTION",children:"Ajouter section"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:287,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:281,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:279,columnNumber:9},void 0),e.jsxDEV(u,{checked:!!E.carryContext,onChange:e=>I("carryContext",e.target.checked),disabled:C,children:"Transporter le contexte (params/session)"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:290,columnNumber:9},void 0),e.jsxDEV("div",{children:[e.jsxDEV(v,{type:"secondary",style:{fontSize:12},children:"Param√®tres (JSON)"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:298,columnNumber:11},void 0),e.jsxDEV(m.TextArea,{autoSize:{minRows:3,maxRows:8},placeholder:'{\n  "leadId": "@lead.id"\n}',value:z,onChange:J,disabled:C},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:299,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:297,columnNumber:9},void 0),E.targetNodeId===f&&e.jsxDEV(b,{type:"warning",showIcon:!0,message:"Le lien ne peut pas cibler ce m√™me n≈ìud."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:308,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:252,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/components/Parameters/capabilities/LinkPanel.tsx",lineNumber:178,columnNumber:5},void 0)};export{f as default};
