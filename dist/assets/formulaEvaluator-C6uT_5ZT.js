const e=(r,t,n)=>{if(!r||!r.sequence||!Array.isArray(r.sequence)||0===r.sequence.length)return{result:null,success:!1,error:"Formule vide ou invalide",debug:[]};const s=[];try{let o=null,l=null,a=null,i=!0;return r.sequence.forEach((u,c)=>{var d,p;if(!u||!u.type)throw new Error(`Élément de formule invalide à l'étape ${c+1}`);let f,v;switch(u.type){case"value":if("string"==typeof u.value){const e=u.value.trim();if(v=e,"string"===u.valueType&&!/^-?\d+(\.\d+)?%$/.test(e.replace(/\s+/g,""))){f=0;break}if(/^-?\d+(\.\d+)?%$/.test(e)){const r=parseFloat(e.replace("%",""));f=isNaN(r)?0:r/100}else{const r=parseFloat(e);f=isNaN(r)?0:r}}else"number"==typeof u.value?(v=u.value,f=u.value):f=0;break;case"field":{const e=String(u.fieldId||u.value||"");let r;if(e&&(void 0!==t[e]?r=t[e]:(null==n?void 0:n.rawValues)&&Object.prototype.hasOwnProperty.call(n.rawValues,e)&&(r=n.rawValues[e])),r&&"object"==typeof r){const e=r.selection;r=void 0!==e?e:r}if(v=r,"number"==typeof r)f=r;else if("string"==typeof r){const e=r.trim();if(/^-?\d+(\.\d+)?%$/.test(e)){const r=parseFloat(e.replace("%",""));f=isNaN(r)?0:r/100}else{const r=parseFloat(e);f=isNaN(r)?0:r}}else f=0;s.push({step:c+1,operation:`Champ ${e}`,value:f});break}case"formula_ref":{const r=u.refFormulaId||String(u.value);if(!r)throw new Error("formula_ref sans refFormulaId");let s=((null==n?void 0:n.formulaResults)||{})[r];if(void 0===s){const o=(null==n?void 0:n.visited)||new Set;if(o.has(r))throw new Error(`Cycle détecté sur la formule ${r}`);if(o.add(r),(null==n?void 0:n.depth)&&n.depth>20)throw new Error("Profondeur formule imbriquée trop grande");const l=(null==n?void 0:n.resolveFormulaById)?n.resolveFormulaById(r):void 0;if(!l)throw new Error(`Formule référencée introuvable: ${r}`);const a=e(l,t,{...n,depth:((null==n?void 0:n.depth)||0)+1,visited:o,formulaResults:{...(null==n?void 0:n.formulaResults)||{}}});if(!a.success)throw new Error(`Erreur formule imbriquée ${r}: ${a.error}`);s=a.result,(null==n?void 0:n.formulaResults)&&(n.formulaResults[r]=s),o.delete(r)}f="boolean"==typeof s?s?1:0:Number(s??0);break}case"adv_part":{const e=u.fieldId||u.value,r=u.part||"selection",t=null==(d=null==n?void 0:n.rawValues)?void 0:d[e];let s;if(t&&"object"==typeof t){const e=t;"selection"===r?s=e.selection:"extra"===r?s=e.extra:"nodeId"===r&&(s=e.nodeId)}else"selection"===r&&(s=t);if(v=s,"number"==typeof s)f=s;else if("string"==typeof s){const e=s.trim();if(/^-?\d+(\.\d+)?%$/.test(e)){const r=parseFloat(e.replace("%",""));f=isNaN(r)?0:r/100}else{const r=parseFloat(e);f=isNaN(r)?0:r}}else f=0;break}case"cond":{let o=!1,l=null;if(u.condExpr&&u.condExpr.length>0){const s=u.condExpr[0];if("function"===(null==s?void 0:s.type)&&String(s.value).startsWith("IF(")){const s=u.condExpr.slice(1);if(s.length>=3){const a={id:`${r.id}__if_cond_${c}`,name:"if-condition",sequence:s,targetProperty:""},i=e(a,t,{...n,depth:((null==n?void 0:n.depth)||0)+1});i.success?(o=Boolean(i.result),l=i.result):(o=!1,l=!1)}else o=!1,l=!1}else{const s={id:`${r.id}__cond_expr_${c}`,name:"cond-expr",sequence:u.condExpr,targetProperty:""},a=e(s,t,{...n,depth:((null==n?void 0:n.depth)||0)+1});if(!a.success)throw new Error(`Erreur expression condition: ${a.error}`);o=Boolean(a.result),l=a.result}}else{const e=u.condition;o=(()=>{var r,t;if(!e)return!1;const s=(null==(r=null==n?void 0:n.rawValues)?void 0:r[e.fieldId])??(null==(t=null==n?void 0:n.rawValues)?void 0:t[e.fieldId]),o=e.part||"selection";let l=s;if(s&&"object"==typeof s){const e=s;"selection"===o?l=e.selection:"extra"===o?l=e.extra:"nodeId"===o&&(l=e.nodeId)}const a=e.operator||"=";return((e,r,t)=>{if("in"===t)return!!Array.isArray(r)&&r.some(r=>String(r)===String(e));const n=parseFloat(String(e)),s=parseFloat(String(r)),o=!isNaN(n)&&""!==String(e).trim()&&/^-?\d+(\.\d+)?$/.test(String(e).trim()),l=!isNaN(s)&&""!==String(r).trim()&&/^-?\d+(\.\d+)?$/.test(String(r).trim()),a="number"==typeof e?e:parseFloat(String(e)),i="number"==typeof r?r:parseFloat(String(r));switch(t){case"=":return String(e)===String(r);case"!=":return String(e)!==String(r);case">":return o&&l?a>i:String(e)>String(r);case">=":return o&&l?a>=i:String(e)>=String(r);case"<":return o&&l?a<i:String(e)<String(r);case"<=":return o&&l?a<=i:String(e)<=String(r);default:return!1}})(l,e.value,a)})(),l=o}s.push({step:c+1,operation:"Condition TEST",value:l});const a=o?u.then||[]:u.else||[];if(a.length,0===a.length)f=(o||u.elseBehavior,0),s.push({step:c+1,operation:"Condition "+(o?"THEN (vide)":"ELSE (vide)"),value:0});else{const l={id:`${r.id}__cond_${c}`,name:"cond",sequence:a,targetProperty:""},i=e(l,t,{...n,depth:((null==n?void 0:n.depth)||0)+1});if(!i.success)throw new Error(`Erreur sous-séquence condition: ${i.error}`);const u="number"==typeof i.result?i.result:"boolean"==typeof i.result&&i.result?1:0;f=u,s.push({step:c+1,operation:`Condition ${o?"THEN":"ELSE"} (résultat branche)`,value:u})}v=f;break}case"switch":{const o=u.switchFieldId||u.fieldId,l=u.switchPart||"selection",a=null==(p=null==n?void 0:n.rawValues)?void 0:p[o||""];let i=a;if(a&&"object"==typeof a){const e=a;"selection"===l?i=e.selection:"extra"===l?i=e.extra:"nodeId"===l&&(i=e.nodeId)}const d=(u.cases||[]).find(e=>String(e.value)===String(i)),m=d?cDeep(d.seq):u.defaultSeq||[];if(0===m.length){f=0;break}const h={id:`${r.id}__switch_${c}`,name:"switch",sequence:m,targetProperty:""},b=e(h,t,{...n,depth:((null==n?void 0:n.depth)||0)+1});if(!b.success)throw new Error(`Erreur switch: ${b.error}`);const g="number"==typeof b.result?b.result:"boolean"==typeof b.result&&b.result?1:0;f=g,s.push({step:c+1,operation:`Switch valeur=${String(i)}`,value:g}),v=f;break}case"operator":return a=String(u.value),void s.push({step:c+1,operation:`Opérateur: ${a}`,value:null});case"function":{const e=String(u.value||"").trim();e.startsWith("IF(")?(f=1,s.push({step:c+1,operation:"Function IF détectée",value:f})):e.startsWith("ROUND(")?(f=0,s.push({step:c+1,operation:`Function ${e} (non implémentée)`,value:f})):(f=0,s.push({step:c+1,operation:`Function ${e} (ignorée)`,value:f}));break}default:throw new Error(`Type d'élément non supporté: ${u.type}`)}if(i)return o=void 0!==v?v:f,l=v,i=!1,void s.push({step:c+1,operation:"Valeur initiale",value:o});if(null===a)throw new Error(`Opérateur manquant avant la valeur à l'étape ${c+1}`);switch(a){case"+":o=(Number(o)||0)+Number(f);break;case"-":o=(Number(o)||0)-Number(f);break;case"*":o=(Number(o)||0)*Number(f);break;case"/":if(0===f)throw s.push({step:c+1,operation:"Division par 0 (arrêt)",value:null}),new Error("Division par zéro");o=(Number(o)||0)/Number(f);break;case"=":o=String(l??o)===String(v??f);break;case"!=":o=String(l??o)!==String(v??f);break;case">":o=Number(o)>Number(f);break;case"<":o=Number(o)<Number(f);break;case">=":o=Number(o)>=Number(f);break;case"<=":o=Number(o)<=Number(f);break;case"&&":o=Boolean(o)&&Boolean(f);break;case"||":o=Boolean(o)||Boolean(f);break;default:throw new Error(`Opérateur non supporté: ${a}`)}s.push({step:c+1,operation:`${a} ${f}`,value:o}),["+","-","*","/"].includes(a||"")&&(l=o),["=","!="].includes(a||"")&&(l=o),a=null}),{result:o,success:!0,debug:s}}catch(o){return{result:null,success:!1,error:o instanceof Error?o.message:"Erreur inconnue",debug:s}}},r=()=>((r,t)=>{const n=t.map((t,n)=>{const{values:s,expectedResult:o,name:l}=t,a=e(r,s),i=l||`Test #${n+1}`,u=a.success&&a.result===o;return u||a.error,a.debug.forEach(e=>{}),{name:i,success:u,values:s,expectedResult:o,actualResult:a.result,error:a.error,debug:a.debug}}),s=n.filter(e=>e.success).length;return{formulaId:r.id,formulaName:r.name,success:s===t.length,successCount:s,totalTests:t.length,results:n}})({id:"example-formula",name:"Prix Total",targetProperty:"prixTotal",sequence:[{id:"field-prix",type:"field",value:"prix",label:"Prix unitaire",fieldId:"prix"},{id:"op-mult",type:"operator",value:"*",label:"*"},{id:"field-qte",type:"field",value:"quantite",label:"Quantité",fieldId:"quantite"}]},[{name:"Cas standard",values:{prix:10,quantite:5},expectedResult:50},{name:"Prix zéro",values:{prix:0,quantite:5},expectedResult:0},{name:"Quantité décimale",values:{prix:10,quantite:2.5},expectedResult:25}]);export{r as a,e};
