import{u as e}from"./useAuthenticatedApi-BbQI8SDU.js";function t(){if("undefined"==typeof window)return{events:[],push:()=>{},dump:()=>[],clear:()=>{},setLimit:()=>{},limit:0};if(!window.__TBL_BRIDGE__){const e={events:[],limit:500,push(e){e&&"object"==typeof e&&(this.events.push({ts:Date.now(),...e}),this.events.length>this.limit&&this.events.splice(0,this.events.length-this.limit),(()=>{try{return"1"===localStorage.getItem("TBL_SMART_DEBUG")}catch{return!1}})())},dump(e){if(!e)return[...this.events];const t="string"==typeof e?new RegExp(e,"i"):e;return this.events.filter(e=>t.test(e.type))},clear(){this.events.length=0},setLimit(e){this.limit=Math.max(50,0|e),this.events.length>this.limit&&this.events.splice(0,this.events.length-this.limit)}};window.__TBL_BRIDGE__=e}return window.__TBL_BRIDGE__}const n=new Set;let s=null;const i=new Map,r=new Map,a={sent:0,items:0,avoided:0,lastDuration:0},l={current:{}};function o(e,o,u){const h=t(),c=r.get(e);if(c)return h.push({type:"enqueue_join_inflight",elementId:e}),c;const p=new Promise(r=>{i.set(e,r),n.add(e),l.current=o,h.push({type:"enqueue_new",elementId:e}),s||(s=setTimeout(()=>async function(e){if(0===n.size)return;const r=Array.from(n.values());n.clear(),s&&(clearTimeout(s),s=null),a.sent++,a.items+=r.length;const o=t(),u=performance.now();o.push({type:"batch_flush_start",ids:r,size:r.length});try{const t=await e({elementIds:r,contextData:l.current,evalType:"batch"}),n=(null==t?void 0:t.data)||t,s=(null==n?void 0:n.results)||{};r.forEach(e=>{const t=i.get(e);t&&(t(s[e]),i.delete(e)),o.push({type:"batch_resolve",elementId:e,hasResult:e in s})}),a.lastDuration=Math.round(performance.now()-u),o.push({type:"batch_flush_done",size:r.length,duration:a.lastDuration})}catch(h){r.forEach(e=>{const n=i.get(e);n&&(n({success:!1,error:"batch_failed",details:h.message}),i.delete(e)),t().push({type:"batch_resolve_error",elementId:e})})}}(u),15))});return r.set(e,p),p.finally(()=>{r.get(e)===p&&r.delete(e)}),p}function u(){const{api:n}=e(),s=e=>n.post("/api/tbl/evaluate",e,{showErrors:!1}),i=(e,t)=>o(e,t,s);return{enqueue:i,enqueueMany:async(e,t)=>Promise.all(e.map(e=>i(e,t))),getMetrics:()=>({...a,avgSize:a.sent?a.items/a.sent:0}),bridge:t()}}export{u};
