import{j as e,u as n}from"./index-C0S0DpaX.js";import{r,R as t,m as a}from"./react-vendor-Al_k-ZB6.js";import{u as i}from"./useAuthenticatedApi-BbQI8SDU.js";import{$ as s,a as o,R as l,T as c,c as d,Q as m,j as u,aj as p,ak as f,bu as h,a6 as b,a3 as v,ad as T,aC as N,a2 as D,aZ as L,F as x,ab as C,a7 as B,bv as E,an as g,I as y,B as V,aF as w,bw as S,aw as A,ax as R,b1 as _,aX as k,aM as O,ao as I,bx as M,by as j,aL as U,bk as F,bz as $,bA as z,af as q,ag as P,b5 as W,i as G,s as H,a0 as J,h as X,b as Y,aG as K,x as Q,w as Z,L as ee,a_ as ne,bB as re,bo as te,a$ as ae,al as ie}from"./antd-vendor-zFcGztvE.js";import{d as se,i as oe}from"./AppLayout-B5YjWTBr.js";import{u as le}from"./evalBridge-C5EkhzJm.js";import{H as ce}from"./HelpTooltip-MvCLb7sy.js";import{L as de}from"./LeadCreatorModalAdvanced-C3Kd05xY.js";import"./data-vendor-wH_FeJEU.js";import"./Notifications-Bhgc2wzd.js";import"./jsx-runtime-DHbGwwJb.js";const{Text:me}=c,ue=({clientData:n={name:"Dupont Alice",email:"alice.dupont@example.com",phone:"+32 477 12 34 56",address:"Rue des Fleurs 12, 1000 Bruxelles"}})=>{const r=25e3,t=45,a=8.5,i=1250,c=65;return e.jsxDEV(s,{direction:"vertical",size:"large",className:"w-full",children:[e.jsxDEV(o,{title:"Informations Client",className:"shadow-sm",children:e.jsxDEV(s,{direction:"vertical",size:"small",className:"w-full",children:[e.jsxDEV("div",{className:"flex items-center space-x-2",children:[e.jsxDEV(l,{className:"text-blue-500"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:48,columnNumber:13},void 0),e.jsxDEV(me,{strong:!0,className:"text-sm",children:n.name},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:49,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:47,columnNumber:11},void 0),e.jsxDEV("div",{className:"flex items-center space-x-2",children:[e.jsxDEV(d,{className:"text-green-500"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:53,columnNumber:13},void 0),e.jsxDEV(me,{className:"text-xs text-gray-600",children:n.email},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:54,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:52,columnNumber:11},void 0),e.jsxDEV("div",{className:"flex items-center space-x-2",children:[e.jsxDEV(m,{className:"text-orange-500"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:58,columnNumber:13},void 0),e.jsxDEV(me,{className:"text-xs text-gray-600",children:n.phone},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:59,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:57,columnNumber:11},void 0),e.jsxDEV("div",{className:"flex items-start space-x-2",children:[e.jsxDEV(u,{className:"text-purple-500 mt-0.5"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:63,columnNumber:13},void 0),e.jsxDEV(me,{className:"text-xs text-gray-600",children:n.address},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:64,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:62,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:46,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:45,columnNumber:7},void 0),e.jsxDEV(o,{title:"RÃ©sumÃ© du projet",className:"shadow-sm",children:e.jsxDEV(s,{direction:"vertical",size:"middle",className:"w-full",children:[e.jsxDEV(p,{title:"Budget disponible",value:r,prefix:e.jsxDEV(f,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:75,columnNumber:21},void 0),suffix:"â‚¬",valueStyle:{color:"#3f8600",fontSize:"16px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:72,columnNumber:11},void 0),e.jsxDEV(p,{title:"Surface utile",value:t,suffix:"mÂ²",prefix:e.jsxDEV(h,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:84,columnNumber:21},void 0),valueStyle:{fontSize:"16px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:80,columnNumber:11},void 0),e.jsxDEV(p,{title:"Puissance estimÃ©e",value:a,suffix:"kWc",prefix:e.jsxDEV(b,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:92,columnNumber:21},void 0),valueStyle:{color:"#1890ff",fontSize:"16px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:88,columnNumber:11},void 0),e.jsxDEV(p,{title:"Ã‰conomies/an",value:i,suffix:"â‚¬",prefix:e.jsxDEV(v,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:100,columnNumber:21},void 0),valueStyle:{color:"#52c41a",fontSize:"16px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:96,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:71,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:70,columnNumber:7},void 0),e.jsxDEV(o,{title:"Avancement",className:"shadow-sm",children:e.jsxDEV(s,{direction:"vertical",size:"middle",className:"w-full",children:[e.jsxDEV("div",{children:[e.jsxDEV("div",{className:"flex justify-between mb-2",children:[e.jsxDEV(me,{children:"Formulaire complÃ©tÃ©"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:111,columnNumber:15},void 0),e.jsxDEV(me,{strong:!0,children:[c,"%"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:112,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:110,columnNumber:13},void 0),e.jsxDEV(T,{percent:c,strokeColor:"#52c41a",size:"small"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:114,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:109,columnNumber:11},void 0),e.jsxDEV(N,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:121,columnNumber:11},void 0),e.jsxDEV("div",{className:"text-sm text-gray-500",children:[e.jsxDEV("div",{className:"flex justify-between mb-1",children:[e.jsxDEV("span",{children:"Mesures gÃ©nÃ©rales"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:125,columnNumber:15},void 0),e.jsxDEV(v,{className:"text-green-500"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:126,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:124,columnNumber:13},void 0),e.jsxDEV("div",{className:"flex justify-between mb-1",children:[e.jsxDEV("span",{children:"PhotovoltaÃ¯que"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:129,columnNumber:15},void 0),e.jsxDEV(v,{className:"text-green-500"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:130,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:128,columnNumber:13},void 0),e.jsxDEV("div",{className:"flex justify-between mb-1",children:[e.jsxDEV("span",{children:"Toiture"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:133,columnNumber:15},void 0),e.jsxDEV("span",{className:"text-orange-500",children:"En cours"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:134,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:132,columnNumber:13},void 0),e.jsxDEV("div",{className:"flex justify-between",children:[e.jsxDEV("span",{children:"PAC Air-Air"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:137,columnNumber:15},void 0),e.jsxDEV("span",{className:"text-gray-400",children:"Ã€ faire"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:138,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:136,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:123,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:108,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:107,columnNumber:7},void 0),e.jsxDEV(o,{title:"Actions",className:"shadow-sm",children:e.jsxDEV(s,{direction:"vertical",size:"small",className:"w-full",children:[e.jsxDEV("button",{className:"w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors text-sm",children:"GÃ©nÃ©rer devis PDF"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:147,columnNumber:11},void 0),e.jsxDEV("button",{className:"w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded transition-colors text-sm",children:"Valider & Envoyer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:150,columnNumber:11},void 0),e.jsxDEV("button",{className:"w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition-colors text-sm",children:"Sauvegarder brouillon"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:153,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:146,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:145,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/ClientSidebar.tsx",lineNumber:43,columnNumber:5},void 0)},pe=({nodeId:n,treeId:t,formData:a,placeholder:s="---",precision:o=2,unit:l})=>{const{value:c,loading:d}=((e,n,t)=>{const{api:a}=i(),[s,o]=r.useState(void 0),[l,c]=r.useState(!1),d=r.useMemo(()=>JSON.stringify(t),[t]);return r.useEffect(()=>{e&&n&&a?(async()=>{try{c(!0);const r=JSON.parse(d),t=await a.post("/api/tbl/submissions/preview-evaluate",{treeId:n,formData:r,leadId:r.__leadId});if((null==t?void 0:t.success)&&(null==t?void 0:t.results)){const n=t.results.find(n=>n.nodeId===e);if(n){let e=n.value??n.calculatedValue;if(e&&"object"==typeof e&&!Array.isArray(e)){const n=e,r=n.value??n.result??n.calculatedValue??n.text??n.humanText??n.displayValue??e;if(r&&"object"==typeof r&&!Array.isArray(r)){const n=r;e=n.value??n.result??n.calculatedValue??r}else e=r}o(e)}else o(void 0)}else o(void 0)}catch(r){o(void 0)}finally{c(!1)}})():o(void 0)},[e,n,d,a]),{value:s,loading:l}})(n,t,a);if(d)return e.jsxDEV(D,{size:"small"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/BackendValueDisplay.tsx",lineNumber:40,columnNumber:12},void 0);if(null==c||"âˆ…"===c)return e.jsxDEV(e.Fragment,{children:s},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/BackendValueDisplay.tsx",lineNumber:45,columnNumber:12},void 0);let m,u=c;if("object"==typeof c&&null!==c){const e=c;u=e.value??e.result??e.calculatedValue??e.text??e.humanText??c}if("number"==typeof u)m=u.toFixed(o);else if("string"==typeof u){const e=parseFloat(u);m=isNaN(e)?u:e.toFixed(o)}else m="boolean"==typeof u?u?"Oui":"Non":String(u);return l&&m!==s&&(m=`${m} ${l}`),e.jsxDEV(e.Fragment,{children:m},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/BackendValueDisplay.tsx",lineNumber:85,columnNumber:10},void 0)};function fe(e={}){const{enqueueMany:n}=le(),t=e.ttl??5e3,a=r.useRef(new Map),i=()=>{try{return"1"===localStorage.getItem("TBL_DIAG")}catch{return!1}},s=r.useCallback((e,n)=>{const r=[...e].sort(),t=function(e){try{return JSON.stringify(e,Object.keys(e).sort())+"|"+Object.keys(e).length}catch{return"hash-error"}}(n||{});return{key:`${r.join(",")}::${t}`,fieldHash:t}},[]),o=r.useCallback(async(r,o)=>{if(!Array.isArray(r)||0===r.length)return{};const{key:l,fieldHash:c}=s(r,o),d=Date.now(),m=a.current.get(l);if(m&&d-m.timestamp<t)return e.debug||i(),m.results;try{e.debug||i();const t=await n(r,o),s={};if(Array.isArray(t)&&t.length&&"object"==typeof t[0]&&t[0]&&"elementId"in t[0])for(const e of t){const n=e.elementId;s[n]={nodeId:n,calculatedValue:e.value,raw:e.raw??e.value,meta:e.meta||{}}}else for(let e=0;e<r.length;e++){const n=r[e],a=t[e];s[n]={nodeId:n,calculatedValue:a,raw:a,meta:{}}}return a.current.set(l,{key:l,timestamp:Date.now(),results:s,nodeIds:r,fieldHash:c}),i(),s}catch(u){return{}}},[n,s,t,e.debug]),l=r.useCallback(e=>{e&&e.length,a.current.clear()},[]),c=r.useCallback(()=>{const e=Array.from(a.current.values());return{size:e.length,entries:e.map(e=>({key:e.key,ageMs:Date.now()-e.timestamp}))}},[]);return r.useMemo(()=>({evaluateBatch:o,invalidate:l,getStats:c}),[o,l,c])}const he=r.createContext(null),be=({children:n})=>{const[t,a]=r.useState(!1),i={isValidation:t,startValidation:r.useCallback(()=>{a(!0)},[]),stopValidation:r.useCallback(()=>{a(!1)},[])};return e.jsxDEV(he.Provider,{value:i,children:n},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/contexts/TBLValidationContext.tsx",lineNumber:31,columnNumber:5},void 0)},ve=()=>{const e=r.useContext(he);return e||{isValidation:!1,startValidation:()=>{},stopValidation:()=>{}}};function Te(e,n,t=!0){const{api:a}=i(),[s,o]=r.useState([]),[l,c]=r.useState(!1),[d,m]=r.useState(null);return r.useEffect(()=>{if(!t)return o([]),c(!1),void m(null);if(!e||!n)return o([]),c(!1),void m(null);let r=!1;return(async()=>{try{c(!0),m(null);const t=await a.get(`/api/treebranchleaf/nodes/${e}/select-config`,{suppressErrorLogForStatuses:[404]});if(r)return;if(!t)return o([]),void c(!1);if("table"!==t.optionsSource)return o([]),void c(!1);if(!t.tableReference)return o([]),void c(!1);const i=await a.get(`/api/treebranchleaf/nodes/${n}/table/lookup`,{suppressErrorLogForStatuses:[404]});if(!i)return o([]),void c(!1);if(r)return;const s=function(e,n){if(function(e){return Boolean(e&&"object"==typeof e&&Array.isArray(e.options))}(e))return function(e){const n=[];return e.forEach((e,r)=>{if(!e||"object"!=typeof e)return;const t=e,a=t.value??t.key??t.id,i=t.label??t.display??a;null!=a&&n.push({value:"number"==typeof a||"string"==typeof a?a:String(a),label:"string"==typeof i||"number"==typeof i?String(i):`Option ${r+1}`,disabled:"boolean"==typeof t.disabled?t.disabled:void 0})}),n}(e.options);if(function(e){if(!e||"object"!=typeof e)return!1;const n=e;return"string"==typeof n.type&&Array.isArray(n.columns)&&Array.isArray(n.data)}(e))return function(e,n){const{keyColumn:r,valueColumn:t,displayColumn:a}=n,i=[];if("columns"===e.type){const n=r?e.columns.indexOf(r):0,s=t?e.columns.indexOf(t):0,o=a?e.columns.indexOf(a):s;if(-1===n||-1===s)return[];e.data.forEach(e=>{const r=e[n],t=e[s],a=-1!==o?e[o]:t;null!=r&&""!==r&&i.push({value:String(r),label:String(a||t||r)})})}else if("matrix"===e.type)if(n.keyRow){const r=e.rows.indexOf(n.keyRow);if(-1===r)return[];const t=e.data[r]||[];e.columns.forEach((e,r)=>{const a=t[r];null!=a&&""!==a&&i.push({value:String(a),label:n.displayRow?`${e}: ${a}`:String(a)})})}else{const n=t?e.columns.indexOf(t):1;if(-1===n)return[];e.data.forEach((r,s)=>{const o=e.rows[s],l=r[n],c=a&&a!==t?r[e.columns.indexOf(a)]:l;null!=o&&""!==o&&i.push({value:String(o),label:String(c||l||o)})})}return i}(e,n);return[]}(i,t);o(s),c(!1)}catch(t){r||(m(t instanceof Error?t.message:"Erreur inconnue"),o([]),c(!1))}})(),()=>{r=!0}},[e,n,a,t]),{options:s,loading:l,error:d}}const{TextArea:Ne}=y,{Option:De}=g,{Text:Le}=c,{useBreakpoint:xe}=L,Ce={TEXT:{label:"Texte",icon:"ðŸ“",category:"input",variants:["singleline","textarea"],validation:["required","minLength","maxLength","pattern"]},NUMBER:{label:"Nombre",icon:"ðŸ”¢",category:"input",variants:["input","stepper","slider","dial"],validation:["required","min","max","step"]},SELECT:{label:"SÃ©lection",icon:"ðŸ“‹",category:"choice",variants:["dropdown","radio","pills","segmented"],validation:["required"],requiresOptions:!0},CHECKBOX:{label:"Case Ã  cocher",icon:"â˜‘ï¸",category:"choice",variants:["checkbox","switch","segmented"],validation:["required"]},DATE:{label:"Date",icon:"ðŸ“…",category:"temporal",variants:["date","time","datetime","month","range"],validation:["required","dateFormat","minDate","maxDate"]},IMAGE:{label:"Image",icon:"ðŸ–¼ï¸",category:"media",variants:["upload","camera","gallery"],validation:["required","fileSize","fileType"]},FILE:{label:"Fichier",icon:"ðŸ“Ž",category:"media",variants:["upload","dropzone"],validation:["required","fileSize","fileType"]},EMAIL:{label:"Email",icon:"ðŸ“§",category:"input",validation:["required","email"]},TEL:{label:"TÃ©lÃ©phone",icon:"ðŸ“ž",category:"input",validation:["required","phone"]},TEXTAREA:{label:"Texte long",icon:"ðŸ“„",category:"input",validation:["required","minLength","maxLength"]}},Be=(n,r)=>{const t=r.appearanceConfig||{},a=t.helpTooltipType;if(!a||"none"===a)return n;let i=null;return"text"===a&&t.helpTooltipText?i=e.jsxDEV("div",{children:t.helpTooltipText},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:395,columnNumber:22},void 0):"image"===a&&t.helpTooltipImage?i=e.jsxDEV("div",{style:{maxWidth:300},children:e.jsxDEV("img",{src:t.helpTooltipImage,alt:"Aide",style:{maxWidth:"100%",height:"auto"},onError:e=>{e.currentTarget.style.display="none"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:399,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:398,columnNumber:7},void 0):"both"===a&&(t.helpTooltipText||t.helpTooltipImage)&&(i=e.jsxDEV("div",{children:[t.helpTooltipText&&e.jsxDEV("div",{style:{marginBottom:t.helpTooltipImage?8:0},children:t.helpTooltipText},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:413,columnNumber:11},void 0),t.helpTooltipImage&&e.jsxDEV("div",{style:{maxWidth:300},children:e.jsxDEV("img",{src:t.helpTooltipImage,alt:"Aide",style:{maxWidth:"100%",height:"auto"},onError:e=>{e.currentTarget.style.display="none"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:419,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:418,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:411,columnNumber:7},void 0)),i?e.jsxDEV(B,{title:i,placement:"top",children:n},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:435,columnNumber:7},void 0):n},Ee=({field:n,value:a,onChange:i,disabled:s=!1,formData:o={},treeMetadata:l={},treeId:c,allNodes:d=[]})=>{var m,u;const p=!xe().md,[f,h]=r.useState(a),[b,v]=r.useState(null),[T,N]=r.useState(!0),[D,L]=r.useState(null),[$,z]=r.useState(0),q=(e=>r.useMemo(()=>{{null==e||e.appearanceConfig;const n={},r=(e,t="")=>{for(const a in e)(a.includes("tooltip")||a.includes("Tooltip")||a.includes("help"))&&(n[t+a]=e[a]),"object"!=typeof e[a]||null===e[a]||Array.isArray(e[a])||r(e[a],t+a+".")};r(e)}if(!e)return{type:"none",text:null,image:null,hasTooltip:!1};e.text_helpTooltipType;const n=e.text_helpTooltipText,r=e.text_helpTooltipImage,t=n&&n.trim().length>0,a=r&&r.trim().length>0;if(!t&&!a)return{type:"none",text:null,image:null,hasTooltip:!1};let i="text";return i=t&&a?"both":a?"image":"text",{type:i,text:t?n:null,image:a?r:null,hasTooltip:!0}},[e]))(n),{isValidation:P}=ve();r.useEffect(()=>{try{if("undefined"==typeof window)return;if(!a||!Array.isArray(a)||0===a.length)return;if(window.TBL_CASCADER_NODE_IDS&&window.TBL_CASCADER_NODE_IDS[n.id])return;const e=(n,r)=>{if(!r||0===r.length)return null;const[t,...a]=r,i=n.find(e=>e.label===t);if(!i)return null;if(0===a.length)return i;const s=d.filter(e=>e.parentId===i.id);return e(s,a)},r=e(n.options,[...a]);r&&(window.TBL_CASCADER_NODE_IDS=window.TBL_CASCADER_NODE_IDS||{},window.TBL_CASCADER_NODE_IDS[n.id]=r.id)}catch(e){}},[a,d,n.id,n.options]);const W=r.useMemo(()=>{var e;if("boolean"==typeof n.hasTable)return n.hasTable;const r=n.capabilities||{};if(void 0!==(null==(e=r.table)?void 0:e.enabled))return r.table.enabled;return(l||{}).hasTable||!1},[n.hasTable,n.capabilities,l]),G=null==n?void 0:n.repeaterTemplateNodeId,H=null==n?void 0:n.originalFieldId,J=(null==n?void 0:n.metadata)&&(null==(m=n.metadata)?void 0:m.originalNodeId),X=null==n?void 0:n.sourceTemplateId,Y=e=>"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e);let K=G||H||J||X||n.id;if(!Y(K)){const e=[G,H,J,X].filter(Boolean),n=e.find(Y);n?K=n:"string"==typeof(Q=K)&&/^node_\d+_[a-z0-9]+$/i.test(Q)&&e.length>0&&(K=e[0])}var Q;const Z=Te(K,K,W);r.useEffect(()=>{h(a)},[a]);const ee=r.useMemo(()=>{var e,r,t,a,i,s,o,c,d,m,u,p,f,h,b,v;const T=n.config||{},N=l||{},D=n.capabilities||{},L=(null==(e=n.type)?void 0:e.toUpperCase())||"TEXT",x=(null==(r=n.type)?void 0:r.toUpperCase())||N.subType||L,C=(null==(t=D.table)?void 0:t.enabled)||N.hasTable||!1?"SELECT":x,B={size:T.size||(null==(a=N.appearance)?void 0:a.size),width:T.width||(null==(i=N.appearance)?void 0:i.width),variant:T.variant||(null==(s=N.appearance)?void 0:s.variant),...N.appearance||{}};return Object.entries(D).filter(([,e])=>null==e?void 0:e.enabled).map(([e])=>e).length,{fieldType:C,label:n.label||"Champ",description:n.description||N.description,required:n.required||N.isRequired||!1,visible:!1!==n.visible&&!1!==N.isVisible,numberConfig:{min:T.min||N.min,max:T.max||N.max,step:T.step||N.step||1,defaultValue:T.numberDefaultValue||N.numberDefaultValue||T.defaultValue||N.defaultValue,ui:B.variant||T.ui||"input",unit:T.unit||N.unit,...N.numberConfig},textConfig:{placeholder:n.placeholder||T.placeholder||N.placeholder,minLength:T.minLength||N.minLength,maxLength:T.maxLength||N.maxLength,mask:T.mask||N.mask,rows:T.rows||N.rows||3,defaultValue:T.textDefaultValue||N.textDefaultValue||T.defaultValue||N.defaultValue,pattern:T.regex||N.regex,...N.textConfig},selectConfig:{options:n.options||T.options||N.options||[],defaultValue:T.selectDefaultValue||N.selectDefaultValue||T.defaultValue||N.defaultValue,multiple:T.multiple||N.multiple||!1,searchable:T.searchable||!1!==N.searchable,allowClear:!n.required,...N.selectConfig},checkboxConfig:{label:n.label,trueLabel:T.trueLabel||N.trueLabel,falseLabel:T.falseLabel||N.falseLabel,defaultValue:T.boolDefaultValue||N.boolDefaultValue||T.defaultValue||N.defaultValue,...N.checkboxConfig},dateConfig:{format:T.format||N.format||"DD/MM/YYYY",showTime:T.showTime||N.showTime||!1,defaultValue:T.dateDefaultValue||N.dateDefaultValue||T.defaultValue||N.defaultValue,...N.dateConfig},appearance:{variant:B.variant,size:B.size||"middle",width:B.width,style:B.style||{},className:B.className||""},size:B.size,width:B.width,variant:B.variant,minLength:T.minLength,maxLength:T.maxLength,mask:T.mask,regex:T.regex,rows:T.rows,min:T.min,max:T.max,step:T.step,decimals:T.decimals,prefix:T.prefix,suffix:T.suffix,unit:T.unit,hasCondition:(null==(o=D.condition)?void 0:o.enabled)||N.hasCondition||!1,hasFormula:(null==(c=D.formula)?void 0:c.enabled)||N.hasFormula||!1,hasTable:(null==(d=D.table)?void 0:d.enabled)||N.hasTable||!1,hasAPI:(null==(m=D.api)?void 0:m.enabled)||N.hasAPI||!1,hasMarkers:(null==(u=D.markers)?void 0:u.enabled)||N.hasMarkers||!1,conditionConfig:(null==(p=D.condition)?void 0:p.currentConditions)?{branches:D.condition.currentConditions.map(e=>({label:`Condition sur ${e.dependsOn}`,targetField:e.dependsOn,operator:e.operator,value:e.value,action:e.action}))}:N.conditionConfig||{},formulaConfig:(null==(f=D.formula)?void 0:f.currentFormula)||N.formulaConfig||{},tableConfig:(null==(h=D.table)?void 0:h.currentTable)||N.tableConfig||{},apiConfig:(null==(b=D.api)?void 0:b.currentAPI)||N.apiConfig||{},markersConfig:(null==(v=D.markers)?void 0:v.currentMarkers)?{markers:D.markers.currentMarkers}:N.markersConfig||{}}},[n,l]);r.useEffect(()=>{if(!n.conditions||0===n.conditions.length)return void N(!0);let e=!0;for(const r of n.conditions){const n=o[r.dependsOn];let t=!1;switch(r.operator){case"equals":t=n===r.showWhen;break;case"not_equals":t=n!==r.showWhen;break;case"contains":t=String(n||"").includes(String(r.showWhen));break;case"greater_than":t=Number(n)>Number(r.showWhen);break;case"less_than":t=Number(n)<Number(r.showWhen);break;default:t=!0}if(!t){e=!1;break}}N(e)},[n.conditions,o,n.label]),r.useEffect(()=>{var e;if(ee.hasFormula&&(null==(e=ee.formulaConfig)?void 0:e.formula))try{const e=ee.formulaConfig.formula,n=ee.formulaConfig.variables||{};let r=e;if(Object.entries(n).forEach(([e,n])=>{const t=n.sourceField,a=o[t]||0,i="number"===n.type?Number(a):String(a);r=r.replace(new RegExp(`\\$${e}`,"g"),String(i))}),"NUMBER"===ee.fieldType&&r.match(/^[\d+\-*/\s().]+$/)){const e=Function(`"use strict"; return (${r})`)();v(e)}else v(r)}catch(n){v(f)}else v(f)},[ee,o,f]),r.useEffect(()=>{var e,r,t,a,i;if(!Ce[ee.fieldType])return;let s=null;const o=ee.hasFormula?b:f;if(!ee.required||null!=o&&""!==o||(s="Ce champ est obligatoire"),null!=o&&""!==o&&!s)switch(ee.fieldType){case"NUMBER":{const n=Number(o);if(isNaN(n))s="Veuillez saisir un nombre valide";else{const t=null==(e=ee.numberConfig)?void 0:e.min,a=null==(r=ee.numberConfig)?void 0:r.max;void 0!==t&&n<t&&(s=`La valeur doit Ãªtre supÃ©rieure ou Ã©gale Ã  ${t}`),void 0!==a&&n>a&&(s=`La valeur doit Ãªtre infÃ©rieure ou Ã©gale Ã  ${a}`)}break}case"EMAIL":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(o))||(s="Veuillez saisir un email valide");break;case"TEXT":case"TEXTAREA":{const e=String(o),r=(null==(t=ee.textConfig)?void 0:t.minLength)||ee.minLength,l=n.text_maxLength||(null==(a=ee.textConfig)?void 0:a.maxLength)||ee.maxLength,c=(null==(i=ee.textConfig)?void 0:i.pattern)||ee.regex||ee.pattern;r&&e.length<r&&(s=`Le texte doit contenir au moins ${r} caractÃ¨res`),l&&e.length>l&&(s=`Le texte ne peut pas dÃ©passer ${l} caractÃ¨res`),c&&!new RegExp(c).test(e)&&(s="Le format du texte n'est pas valide");break}case"TEL":/^[\d\s+()-]+$/.test(String(o))||(s="Veuillez saisir un numÃ©ro de tÃ©lÃ©phone valide");break}L(s)},[ee,b,f,P,n.text_maxLength]);const ne=e=>{i&&(h(e),i(e))};if(!T||!ee.visible)return null;return e.jsxDEV(x.Item,{className:"mb-4 "+(p?"tbl-form-item-mobile":""),labelCol:{span:24},wrapperCol:{span:24},colon:!1,style:{width:"150px"},label:e.jsxDEV("div",{className:"flex flex-col gap-1 sm:flex-row sm:items-center sm:gap-2",children:[e.jsxDEV("span",{className:"font-medium text-gray-700 whitespace-normal break-words",children:[ee.label,ee.required?e.jsxDEV("span",{className:P?"text-red-500 ml-1":"text-green-600 ml-1",style:{color:P?"#ef4444 !important":"#16a34a !important"},children:"*"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1820,columnNumber:19},void 0):null,q.hasTooltip&&e.jsxDEV("span",{className:"ml-2 inline-flex",children:e.jsxDEV(ce,{type:q.type,text:q.text,image:q.image},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1833,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1832,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1815,columnNumber:11},void 0),e.jsxDEV("div",{className:"flex items-center gap-1",children:ee.description&&e.jsxDEV(B,{title:ee.description,children:e.jsxDEV(E,{className:"text-gray-400"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1844,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1843,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1841,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1814,columnNumber:9},void 0),validateStatus:D&&P?"error":D&&!P?"success":"",help:D?e.jsxDEV("div",{style:{color:P?"#dc2626":"#059669",fontWeight:"400",fontSize:"14px",marginTop:"4px"},children:D},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1852,columnNumber:9},void 0):void 0,required:ee.required,children:[null,(()=>{var r,a,i,l,m,u,p,h,v,T,N,L,C,B,E,q,W,G,H,J,X,Y,K,Q,re,te,ae,ie,se,oe,le,ce,de,me,ue,fe,he,be,ve,Te,Le,xe,Ce,Ee,ge,ye,Ve,we,Se,Ae,Re,_e,ke,Oe,Ie,Me,je,Ue,Fe,$e,ze,qe,Pe,We,Ge,He,Je,Xe,Ye,Ke,Qe,Ze,en,nn,rn,tn,an,sn,on;if(ee.hasTable&&Z.options.length>0)return e.jsxDEV(g,{value:f,onChange:ne,placeholder:`SÃ©lectionnez ${ee.label.toLowerCase()}`,loading:Z.loading,showSearch:!0,allowClear:!0,disabled:s,style:{width:"150px"},filterOption:(e,n)=>((null==n?void 0:n.label)??"").toLowerCase().includes(e.toLowerCase()),children:Z.options.map(n=>e.jsxDEV(De,{value:n.value,label:n.label,children:n.label},n.value,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:930,columnNumber:13},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:916,columnNumber:9},void 0);if(ee.hasTable&&Z.loading)return e.jsxDEV(g,{value:f,onChange:ne,placeholder:"Chargement...",loading:!0,disabled:!0,style:{width:"150px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:941,columnNumber:9},void 0);if(n.isTreeBranchLeafSmart&&(n.hasData||n.hasFormula)){const t=n.capabilities||{},s=(null==(r=null==t?void 0:t.formula)?void 0:r.activeId)||((null==(a=null==t?void 0:t.formula)?void 0:a.instances)&&Object.keys(t.formula.instances).length>0?Object.keys(t.formula.instances)[0]:void 0);if(Boolean(s||(null==(i=null==t?void 0:t.formula)?void 0:i.currentFormula))&&s)return c?e.jsxDEV(pe,{nodeId:s,treeId:c,formData:o,unit:null==(l=n.config)?void 0:l.unit,precision:(null==(m=n.config)?void 0:m.decimals)||2,placeholder:"Calcul automatique..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:967,columnNumber:11},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:962,columnNumber:18},void 0);const d=(null==(u=null==t?void 0:t.data)?void 0:u.activeId)||((null==(p=null==t?void 0:t.data)?void 0:p.instances)&&Object.keys(t.data.instances).length>0?Object.keys(t.data.instances)[0]:void 0);if(d){const r=null==(v=null==(h=null==t?void 0:t.data)?void 0:h.instances)?void 0:v[d],a=null==r?void 0:r.metadata;if("tree"===(null==a?void 0:a.sourceType)&&"string"==typeof a.sourceRef&&a.sourceRef){const r=a.sourceRef.includes(":")?a.sourceRef.split(":")[1]:d;return c&&r?e.jsxDEV(pe,{nodeId:r,treeId:c,formData:o,unit:null==(T=n.config)?void 0:T.unit,precision:(null==(N=n.config)?void 0:N.decimals)||2,placeholder:"Calcul automatique..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:997,columnNumber:13},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:992,columnNumber:20},void 0)}return c?e.jsxDEV(pe,{nodeId:d,treeId:c,formData:o,unit:null==(L=n.config)?void 0:L.unit,precision:(null==(C=n.config)?void 0:C.decimals)||2,placeholder:"Calcul automatique..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1014,columnNumber:11},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1009,columnNumber:18},void 0)}return e.jsxDEV("span",{style:{color:"#999"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1027,columnNumber:9},void 0)}const ln=n.capabilities||{};if((null==(B=ln.data)?void 0:B.enabled)&&(ln.data.activeId||ln.data.instances)){const r=null==(E=ln.data.instances)?void 0:E[ln.data.activeId];if(r&&r.metadata){const{sourceType:t,sourceRef:a,fixedValue:i}=r.metadata;if("tree"===t&&a){const t=ln.data.activeId||(ln.data.instances?Object.keys(ln.data.instances)[0]:void 0)||n.id,a=null==(q=null==ln?void 0:ln.formula)?void 0:q.currentFormula;let i=(null==a?void 0:a.variables)?Object.fromEntries(Object.entries(a.variables).map(([e,n])=>[e,{sourceField:n.sourceField,type:n.type}])):void 0;if(!i&&(null==(W=null==r?void 0:r.metadata)?void 0:W.variables)){const e=(null==(G=r.metadata)?void 0:G.variables)||{};i=Object.fromEntries(Object.entries(e).map(([e,n])=>[e,{sourceField:n.sourceField,type:n.type}]))}return c?e.jsxDEV(pe,{nodeId:t,treeId:c,formData:o,unit:r.unit,precision:r.precision,placeholder:"Calcul en cours..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1070,columnNumber:11},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1065,columnNumber:18},void 0)}if("fixed"===t&&void 0!==i)return e.jsxDEV(y,{value:String(i),disabled:!0,style:{backgroundColor:"#f5f5f5"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1084,columnNumber:13},void 0)}}if((null==(H=ln.formula)?void 0:H.enabled)&&ln.formula.currentFormula&&ln.formula.activeId)return c?e.jsxDEV(pe,{nodeId:ln.formula.activeId,treeId:c,formData:o,unit:ee.unit,precision:ee.decimals||4,placeholder:"Calcul en cours..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1102,columnNumber:9},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1097,columnNumber:16},void 0);const cn=ee.hasFormula?b:f,dn=ee.hasFormula&&!(null==(J=ee.formulaConfig)?void 0:J.allowManualOverride),mn=s||dn,un=(null==(X=ee.appearance)?void 0:X.style)||{},pn={width:"150px"},fn={disabled:mn,placeholder:n.text_placeholder||n.placeholder||(null==(Y=ee.textConfig)?void 0:Y.placeholder)||ee.placeholder||`Saisissez ${ee.label.toLowerCase()}`,status:D&&P?"error":D&&!P?"success":void 0,size:"middle",style:{...un,...pn},className:(null==(K=ee.appearance)?void 0:K.className)||ee.className||""};switch(Object.keys(pn).length,ee.fieldType){case"TEXT":return Be(e.jsxDEV(y,{...fn,value:cn||"",onChange:e=>ne(e.target.value),maxLength:n.text_maxLength||(null==(Q=ee.textConfig)?void 0:Q.maxLength)||ee.maxLength,showCount:!!(n.text_maxLength||(null==(re=ee.textConfig)?void 0:re.maxLength)||ee.maxLength),pattern:(null==(te=ee.textConfig)?void 0:te.pattern)||ee.regex||ee.pattern},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1151,columnNumber:11},void 0),n);case"TEXTAREA":return Be(e.jsxDEV(Ne,{...fn,value:cn||"",onChange:e=>ne(e.target.value),rows:(null==(ae=ee.textConfig)?void 0:ae.rows)||3,maxLength:(null==(ie=ee.textConfig)?void 0:ie.maxLength)||ee.maxLength,showCount:!(!(null==(se=ee.textConfig)?void 0:se.maxLength)&&!ee.maxLength),pattern:(null==(oe=ee.textConfig)?void 0:oe.pattern)||ee.regex||ee.pattern},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1166,columnNumber:11},void 0),n);case"NUMBER":return"slider"===((null==(le=ee.appearance)?void 0:le.variant)||ee.variant)||"slider"===(null==(ce=ee.numberConfig)?void 0:ce.ui)?e.jsxDEV("div",{children:[e.jsxDEV(U,{disabled:mn,value:Number(cn)||(null==(de=ee.numberConfig)?void 0:de.defaultValue)||ee.defaultValue||0,onChange:ne,min:(null==(me=ee.numberConfig)?void 0:me.min)||ee.min,max:(null==(ue=ee.numberConfig)?void 0:ue.max)||ee.max,step:(null==(fe=ee.numberConfig)?void 0:fe.step)||ee.step||1,marks:(null==(he=ee.numberConfig)?void 0:he.marks)||ee.marks,tooltip:{formatter:e=>{var n,r,t;return`${(null==(n=ee.numberConfig)?void 0:n.prefix)||ee.prefix||""}${e}${(null==(r=ee.numberConfig)?void 0:r.suffix)||ee.suffix||(null==(t=ee.numberConfig)?void 0:t.unit)||ee.unit||""}`}}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1185,columnNumber:15},void 0),e.jsxDEV("div",{className:"text-center text-sm text-gray-500 mt-1",children:[(null==(be=ee.numberConfig)?void 0:be.prefix)||ee.prefix||"",cn||(null==(ve=ee.numberConfig)?void 0:ve.defaultValue)||ee.defaultValue||0,(null==(Te=ee.numberConfig)?void 0:Te.suffix)||ee.suffix||(null==(Le=ee.numberConfig)?void 0:Le.unit)||ee.unit||""]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1198,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1184,columnNumber:13},void 0):e.jsxDEV(F,{...fn,value:cn,onChange:e=>{ne(e)},min:(null==(xe=ee.numberConfig)?void 0:xe.min)||ee.min,max:(null==(Ce=ee.numberConfig)?void 0:Ce.max)||ee.max,step:(null==(Ee=ee.numberConfig)?void 0:Ee.step)||ee.step||1,style:fn.style,formatter:(null==(ge=ee.numberConfig)?void 0:ge.formatter)||ee.formatter,parser:(null==(ye=ee.numberConfig)?void 0:ye.parser)||ee.parser,addonBefore:(null==(Ve=ee.numberConfig)?void 0:Ve.prefix)||ee.prefix,addonAfter:(null==(we=ee.numberConfig)?void 0:we.suffix)||ee.suffix||(null==(Se=ee.numberConfig)?void 0:Se.unit)||ee.unit,precision:(null==(Ae=ee.numberConfig)?void 0:Ae.decimals)||ee.decimals},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1206,columnNumber:11},void 0);case"SELECT":{const r=(null==(Re=ee.selectConfig)?void 0:Re.options)||ee.options||[],t=ee.hasTable&&Z.options.length>0?Z.options:r,a=t.map(e=>{if(e&&(e.id||e.nodeId))return e;try{const r=d.filter(r=>!("leaf_option"!==r.type&&"leaf_option_field"!==r.type||r.parentId!==n.id||r.label!==e.label&&r.option_label!==e.label&&r.value!==e.value));if(r.length>0){const n=r.sort((e,n)=>(e.order||0)-(n.order||0))[0];return{...e,id:n.id,nodeId:n.id}}}catch{}return e});n.type;const i=a.map(e=>e.id||e.nodeId||e.value);if(d.length>0&&i.length>0&&d.some(e=>i.includes(e.parentId)&&("leaf_option"===e.type||"leaf_option_field"===e.type))){const r=(e,n=0)=>n>20?[]:d.filter(n=>n.parentId===e&&("leaf_option"===n.type||"leaf_option_field"===n.type)).sort((e,n)=>(e.order||0)-(n.order||0)).map(e=>{const t=r(e.id,n+1);return{value:e.label||e.id,label:e.label||e.id,nodeId:e.id,children:t.length>0?t:void 0}}),t=a.map(e=>{const n=e.id||e.value,t=r(n);return{value:e.value||e.label,label:e.label||e.value,nodeId:n,children:t.length>0?t:void 0}});return e.jsxDEV(M,{...fn,value:cn?[cn]:void 0,onChange:(e,r)=>{const t=e&&e.length>0?e[e.length-1]:null;if("undefined"!=typeof window)if(t&&r&&r.length>0){const e=r[r.length-1];if(null==e?void 0:e.nodeId){window.TBL_CASCADER_NODE_IDS=window.TBL_CASCADER_NODE_IDS||{},window.TBL_CASCADER_NODE_IDS[n.id]=e.nodeId;try{window.TBL_FORM_DATA&&(window.TBL_FORM_DATA[`${n.id}__selectedNodeId`]=e.nodeId)}catch{}}else if(window.TBL_CASCADER_NODE_IDS){delete window.TBL_CASCADER_NODE_IDS[n.id];try{window.TBL_FORM_DATA&&delete window.TBL_FORM_DATA[`${n.id}__selectedNodeId`]}catch{}}}else if(window.TBL_CASCADER_NODE_IDS){delete window.TBL_CASCADER_NODE_IDS[n.id];try{window.TBL_FORM_DATA&&delete window.TBL_FORM_DATA[`${n.id}__selectedNodeId`]}catch{}}ne(t)},options:t,style:fn.style,placeholder:fn.placeholder,disabled:mn,showSearch:{filter:(e,n)=>n.some(n=>n.label.toString().toLowerCase().includes(e.toLowerCase()))},expandTrigger:"hover",changeOnSelect:!1,displayRender:e=>e.join(" > ")},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1330,columnNumber:13},void 0)}return"radio"===((null==(_e=ee.appearance)?void 0:_e.variant)||ee.variant)?e.jsxDEV(j.Group,{disabled:mn,value:cn,onChange:e=>ne(e.target.value),size:null==(ke=ee.appearance)?void 0:ke.size,children:t.map(n=>e.jsxDEV(j,{value:n.value,disabled:n.disabled,children:n.label},n.value,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1397,columnNumber:17},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1390,columnNumber:13},void 0):e.jsxDEV(g,{...fn,value:cn,onChange:ne,style:fn.style,loading:ee.hasTable&&Z.loading,mode:(null==(Oe=ee.selectConfig)?void 0:Oe.multiple)||(null==(Ie=ee.config)?void 0:Ie.multiple)||ee.multiple?"multiple":void 0,showSearch:(null==(Me=ee.selectConfig)?void 0:Me.searchable)??(null==(je=ee.config)?void 0:je.searchable)??ee.searchable??!0,allowClear:(null==(Ue=ee.selectConfig)?void 0:Ue.allowClear)??(null==(Fe=ee.config)?void 0:Fe.allowClear)??ee.allowClear??!0,filterOption:(e,n)=>((null==n?void 0:n.label)??"").toLowerCase().includes(e.toLowerCase()),children:t.map(n=>e.jsxDEV(De,{value:n.value,label:n.label,disabled:n.disabled,children:n.label},n.value,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1426,columnNumber:15},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1411,columnNumber:11},void 0)}case"CHECKBOX":return"switch"===((null==($e=ee.appearance)?void 0:$e.variant)||ee.variant)?e.jsxDEV(O,{disabled:mn,checked:Boolean(cn),onChange:ne,size:null==(ze=ee.appearance)?void 0:ze.size,checkedChildren:(null==(qe=ee.checkboxConfig)?void 0:qe.trueLabel)||ee.trueLabel,unCheckedChildren:(null==(Pe=ee.checkboxConfig)?void 0:Pe.falseLabel)||ee.falseLabel},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1443,columnNumber:13},void 0):e.jsxDEV(I,{disabled:mn,checked:Boolean(cn),onChange:e=>ne(e.target.checked),children:(null==(We=ee.checkboxConfig)?void 0:We.label)||ee.label},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1456,columnNumber:11},void 0);case"DATE":return e.jsxDEV(_,{disabled:mn,value:cn?k(cn):null,onChange:e=>ne(e?e.toISOString():null),style:fn.style,format:(null==(Ge=ee.dateConfig)?void 0:Ge.format)||ee.format||"DD/MM/YYYY",picker:(null==(He=ee.appearance)?void 0:He.variant)||ee.variant,showTime:(null==(Je=ee.dateConfig)?void 0:Je.showTime)||ee.showTime,size:(null==(Xe=ee.appearance)?void 0:Xe.size)||ee.size,disabledDate:e=>{var n,r,t,a,i;const s=(null==(n=ee.dateConfig)?void 0:n.minDate)||ee.minDate,o=(null==(r=ee.dateConfig)?void 0:r.maxDate)||ee.maxDate;return!!(s&&e&&e<k(s))||(!!(o&&e&&e>k(o))||((null==(a=null==(t=ee.dateConfig)?void 0:t.disabledDate)?void 0:a.call(t,e))||(null==(i=ee.disabledDate)?void 0:i.call(ee,e))||!1))}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1467,columnNumber:11},void 0);case"EMAIL":return e.jsxDEV(y,{...fn,type:"email",value:cn||"",onChange:e=>ne(e.target.value),maxLength:(null==(Ye=ee.textConfig)?void 0:Ye.maxLength)||ee.maxLength,showCount:!(!(null==(Ke=ee.textConfig)?void 0:Ke.maxLength)&&!ee.maxLength),pattern:(null==(Qe=ee.textConfig)?void 0:Qe.pattern)||ee.regex||ee.pattern},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1491,columnNumber:11},void 0);case"TEL":return e.jsxDEV(y,{...fn,type:"tel",value:cn||"",onChange:e=>ne(e.target.value),maxLength:(null==(Ze=ee.textConfig)?void 0:Ze.maxLength)||ee.maxLength,showCount:!(!(null==(en=ee.textConfig)?void 0:en.maxLength)&&!ee.maxLength),pattern:(null==(nn=ee.textConfig)?void 0:nn.pattern)||ee.regex||ee.pattern},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1506,columnNumber:11},void 0);case"IMAGE":return e.jsxDEV("div",{children:[e.jsxDEV(A,{accept:"image/*",maxCount:1,beforeUpload:e=>{var n,r,t;const a=(null==(n=ee.config)?void 0:n.maxSize)||ee.maxSize,i=(null==(r=ee.imageConfig)?void 0:r.ratio)||ee.ratio;if((null==(t=ee.imageConfig)?void 0:t.crop)||ee.crop,a&&e.size>a)return!1;if(i&&window.URL){const n=new Image;n.onload=()=>{const[e,r]=i.split(":").map(Number);n.width,n.height,URL.revokeObjectURL(n.src)},n.src=URL.createObjectURL(e)}return!1},onChange:e=>{if(e.fileList.length>0){const n=e.fileList[0];if(n.originFileObj){const e=new FileReader;e.onload=e=>{var n,r,t;const a=(null==(n=ee.imageConfig)?void 0:n.thumbnails)||ee.thumbnails;let i=null==(r=e.target)?void 0:r.result;a&&"object"==typeof a&&(i={original:null==(t=e.target)?void 0:t.result,thumbnails:a}),ne(i)},e.readAsDataURL(n.originFileObj)}}else ne(null)},disabled:mn,showUploadList:!1,children:e.jsxDEV(V,{icon:e.jsxDEV(R,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1593,columnNumber:23},void 0),disabled:mn,size:(null==(rn=ee.appearance)?void 0:rn.size)||"middle",style:fn.style,children:cn?"Modifier l'image":"Charger une image"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1592,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1522,columnNumber:13},void 0),cn&&e.jsxDEV("div",{className:"mt-2",children:e.jsxDEV("img",{src:cn,alt:"preview",style:{width:"100px",height:"100px",objectFit:"cover",border:"1px solid #d9d9d9",borderRadius:"6px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1603,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1602,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1521,columnNumber:11},void 0);case"FILE":return e.jsxDEV(A,{beforeUpload:e=>{var n;const r=(null==(n=ee.config)?void 0:n.maxSize)||ee.maxSize;return r&&e.size,!1},onChange:e=>{if(e.fileList.length>0){const n=e.fileList[0];ne(n.originFileObj)}else ne(null)},disabled:mn,maxCount:1,children:e.jsxDEV(V,{icon:e.jsxDEV(R,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1643,columnNumber:27},void 0),disabled:mn,children:"SÃ©lectionner un fichier"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1643,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1622,columnNumber:11},void 0);case"leaf_repeater":case"LEAF_REPEATER":{const r=null==(tn=n.metadata)?void 0:tn.repeater,a=(null==r?void 0:r.templateNodeIds)||[],i=null==r?void 0:r.maxItems,l=(null==r?void 0:r.addButtonLabel)||"Ajouter une entrÃ©e",c=(null==r?void 0:r.minItems)||0,d=(null==r?void 0:r.buttonSize)||"middle";null==r||r.buttonWidth;const m=Boolean(null==r?void 0:r.iconOnly),u=()=>{switch(d){case"tiny":return m?"28px":"30px";case"small":return"32px";case"large":return"48px";default:return"40px"}},p=()=>{if(m)switch(d){case"tiny":return"28px";case"small":return"32px";case"large":return"48px";default:return"40px"}},f=()=>{if(m)switch(d){case"tiny":return"14px";case"small":return"16px";case"large":return"20px";default:return"18px"}switch(d){case"tiny":return"12px";case"small":return"13px";case"large":return"16px";default:return"14px"}},h=()=>"tiny"===d?"small":d,b=(()=>a.map(e=>({id:e,label:e,type:"text"})))();return e.jsxDEV(e.Fragment,{children:[Array.from({length:$}).map((r,a)=>e.jsxDEV(t.Fragment,{children:b.map(r=>{const t=`${n.id}_${a}_${r.id}`;return e.jsxDEV(x.Item,{label:r.label||r.id,style:{marginBottom:16},children:e.jsxDEV(y,{value:o[t]||"",onChange:e=>{ne({...o,[t]:e.target.value})},placeholder:`${r.label||r.id}...`,disabled:s},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1728,columnNumber:23},void 0)},t,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1723,columnNumber:21},void 0)})},`${n.id}_instance_${a}`,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1718,columnNumber:15},void 0)),(!i||$<i)&&e.jsxDEV(x.Item,{style:{marginBottom:16},children:e.jsxDEV(V,{type:"dashed",block:!m,size:h(),icon:e.jsxDEV(w,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1752,columnNumber:25},void 0),onClick:()=>z($+1),disabled:s,style:{height:u(),width:p(),fontSize:f(),minWidth:m?p():void 0,padding:m?"0":void 0,display:m?"inline-flex":void 0,alignItems:m?"center":void 0,justifyContent:m?"center":void 0},children:!m&&l},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1748,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1747,columnNumber:15},void 0),$>c&&e.jsxDEV(x.Item,{style:{marginBottom:16},children:e.jsxDEV(V,{type:"dashed",block:!0,danger:!0,icon:e.jsxDEV(S,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1778,columnNumber:25},void 0),onClick:()=>z($-1),disabled:s,children:"Supprimer la derniÃ¨re entrÃ©e"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1774,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1773,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1715,columnNumber:11},void 0)}default:return e.jsxDEV(y,{...fn,value:cn||"",onChange:e=>ne(e.target.value),maxLength:(null==(an=ee.textConfig)?void 0:an.maxLength)||ee.maxLength,showCount:!(!(null==(sn=ee.textConfig)?void 0:sn.maxLength)&&!ee.maxLength),pattern:(null==(on=ee.textConfig)?void 0:on.pattern)||ee.regex||ee.pattern},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1792,columnNumber:11},void 0)}})(),ee.hasMarkers&&(null==(u=ee.markersConfig)?void 0:u.markers)&&e.jsxDEV("div",{className:"mt-2",children:[e.jsxDEV(Le,{type:"secondary",style:{fontSize:"12px"},children:"Marqueurs: "},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1872,columnNumber:11},void 0),ee.markersConfig.markers.map(n=>e.jsxDEV(C,{color:n.color,size:"small",className:"ml-1",children:[n.icon," ",n.name]},n.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1874,columnNumber:13},void 0))]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1871,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLFieldRendererAdvanced.tsx",lineNumber:1807,columnNumber:5},void 0)},ge=[/\s*-\s*Champ.*$/i];function ye(e,n={}){const{stripSuffixPatterns:r=ge,minLength:t=2,customNormalizers:a=[]}=n;if(!e)return[];let i=e;r.forEach(e=>{i=i.replace(e,"")});const s=[i],o=new Set;return s.forEach(e=>function(e){const n=[],r=e.trim();n.push(r);const t=r.normalize("NFD").replace(/[\u0300-\u036f]/g,"");n.push(t);const a=t.replace(/[,:;()/\\]/g," ");n.push(a);const i=a.replace(/\s+/g," ");return n.push(i),n.push(i.toLowerCase()),n.push(i.replace(/\s+/g,"")),Array.from(new Set(n)).filter(Boolean)}(e).forEach(e=>o.add(e))),a.length&&[...o].forEach(e=>{a.forEach(n=>{try{const r=n(e);r&&o.add(r)}catch{}})}),[...o].filter(n=>n.length>=t&&n!==e)}function Ve(e,n="__mirror_data_",r){return ye(e,r).map(e=>`${n}${e}`)}const{Text:we}=c,{Panel:Se}=G,{useBreakpoint:Ae}=L,Re=(e,n,r={})=>{var t,a,i;const s=!1!==r.applyLabelPrefix,o=JSON.parse(JSON.stringify(e)),l=e.originalFieldId||(null==(t=e.metadata)?void 0:t.originalFieldId)||e.repeaterTemplateNodeId||e.id;if(o.id=`${n.prefix}${l}`,s&&n.labelPrefix&&(o.label=`${n.labelPrefix} - ${e.label}`,o.sharedReferenceName&&(o.sharedReferenceName=`${n.labelPrefix} - ${o.sharedReferenceName}`)),o.config&&"string"==typeof o.config.sourceRef){const e=o.config.sourceRef;e.startsWith("condition:")||e.startsWith("formula:")||e.startsWith("node-formula:")||e.startsWith("@value.")||e.startsWith("@table.")||e.startsWith("shared-ref-")||/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)||/^node_[0-9]+_[a-z0-9]+$/i.test(e)||(o.config.sourceRef=`${n.prefix}${e}`)}Array.isArray(o.conditions)&&(o.conditions=o.conditions.map(e=>({...e,dependsOn:`${n.prefix}${e.dependsOn}`}))),o.tableLookupConfig&&Array.isArray(o.tableLookupConfig.filterConditions)&&(o.tableLookupConfig.filterConditions=o.tableLookupConfig.filterConditions.map(e=>e.fieldId?{...e,fieldId:`${n.prefix}${e.fieldId}`}:e)),e.selectConfig&&(o.selectConfig=JSON.parse(JSON.stringify(e.selectConfig))),Array.isArray(o.options)&&(o.options=o.options.map((e,r)=>{const t=JSON.parse(JSON.stringify(e));return Array.isArray(e.conditionalFields)?(t.conditionalFields=e.conditionalFields.map(e=>{var r,t;const a=e.sharedReferenceIds||(null==(r=e.metadata)?void 0:r.sharedReferenceIds),i=Re(e,n,{applyLabelPrefix:!0,templateNodeId:e.originalFieldId||e.id}),s=i.sharedReferenceIds||(null==(t=i.metadata)?void 0:t.sharedReferenceIds);return Array.isArray(a)&&a.length>0&&(!Array.isArray(s)||s.length),e.selectConfig&&(i.selectConfig=JSON.parse(JSON.stringify(e.selectConfig))),i}),t):t}));const c=(null==(a=e.metadata)?void 0:a.originalNodeId)||(null==(i=e.metadata)?void 0:i.originalFieldId)||l;o.metadata={...o.metadata||{},originalFieldId:l,originalNodeId:c};const d=r.templateNodeId||e.repeaterTemplateNodeId||l;return o.isRepeaterInstance=!0,o.originalFieldId=l,o.repeaterParentId=n.parentId,o.repeaterInstanceIndex=n.instanceIndex,o.repeaterInstanceLabel=n.labelPrefix,o.repeaterTemplateNodeId=d,o.repeaterNamespace=n,o},_e=(e,n)=>{if(null==e)return null;const{displayFormat:r="number",unit:t,precision:a=2}=n;switch(r){case"currency":{const n="number"==typeof e?e:parseFloat(String(e));if(isNaN(n))return String(e);const r=n.toLocaleString("fr-FR",{minimumFractionDigits:a,maximumFractionDigits:a});return t?`${r} ${t}`:r}case"percentage":{const n="number"==typeof e?e:parseFloat(String(e));return isNaN(n)?String(e):`${n.toFixed(a)}%`}case"number":{const n="number"==typeof e?e:parseFloat(String(e));if(isNaN(n))return String(e);const r=n.toLocaleString("fr-FR",{minimumFractionDigits:a,maximumFractionDigits:a});return"â‚¬"===t?`${r} â‚¬`:t?`${r} ${t}`:r}case"boolean":return Boolean(e);default:return String(e)}},ke=({section:n,formData:t,onChange:a,treeId:s,allNodes:l=[],allSections:c=[],disabled:d=!1,level:m=0,parentConditions:u={},isValidation:p=!1})=>{const{api:f}=i();r.useEffect(()=>{(n.fields||[]).filter(e=>{const n=e.metadata||{};return!!(null==n?void 0:n.sourceTemplateId)}).length},[n.fields,n.title]),r.useEffect(()=>{"undefined"!=typeof window&&(window.TBL_FORM_DATA=t,window.TBL_ALL_NODES=l,window.debugSharedRefs=()=>{})},[t,l]);const h=r.useCallback((e,n,r=new Set)=>{if(r.has(e))return[];r.add(e);const t=n.find(n=>n.id===e);if(!t)return[];const a=[];Array.isArray(t.sharedReferenceIds)&&a.push(...t.sharedReferenceIds),t.sharedReferenceId&&"string"==typeof t.sharedReferenceId&&a.push(t.sharedReferenceId);const i=n.filter(n=>n.parentId===e);for(const s of i){const e=h(s.id,n,r);a.push(...e)}return a},[]),b=!Ae().md,v=r.useMemo(()=>[b?12:24,b?12:24],[b]),T=r.useMemo(()=>[b?12:16,16],[b]),D=r.useMemo(()=>{try{return"1"===localStorage.getItem("TBL_SMART_DEBUG")}catch{return!1}},[]),L=r.useCallback((...e)=>{D&&se("[TBLSectionRenderer]",...e)},[D]),B=r.useCallback(e=>{const n=e.subType||e.fieldType||e.type||"TEXT",r=(e,n)=>{const r=!!e&&Object.keys(e).length>0;return{enabled:r,activeId:r&&n?n:void 0,instances:r?e:void 0}},t=(e,n)=>{if(e&&n)return e[n]},a=e.formula_instances,i=e.condition_instances;let s;const o=l.filter(n=>n.parentId===e.id&&("leaf_option"===n.type||"leaf_option_field"===n.type));return o.length>0&&(s=o.map(e=>({id:e.id,label:e.option_label||e.label,value:e.value||e.option_label||e.label,metadata:e.metadata,conditionalFields:void 0}))),{id:e.id,name:e.field_label||e.name||e.label,label:e.label,type:n,required:Boolean(e.isRequired),visible:!1!==e.isVisible,placeholder:e.text_placeholder??void 0,description:e.description??void 0,order:"number"==typeof e.order?e.order:9999,sharedReferenceName:e.sharedReferenceName||e.label,options:s,config:{size:e.appearance_size??void 0,width:e.appearance_width??void 0,variant:e.appearance_variant??void 0,minLength:e.text_minLength??void 0,maxLength:e.text_maxLength??void 0,rows:e.text_rows??void 0,mask:e.text_mask??void 0,regex:e.text_regex??void 0,textDefaultValue:e.text_defaultValue??void 0,min:e.number_min??void 0,max:e.number_max??void 0,step:e.number_step??void 0,decimals:e.number_decimals??void 0,prefix:e.number_prefix??void 0,suffix:e.number_suffix??void 0,unit:e.number_unit??void 0,numberDefaultValue:e.number_defaultValue??void 0,format:e.date_format??void 0,showTime:e.date_showTime??void 0,dateDefaultValue:e.date_defaultValue??void 0,minDate:e.date_minDate??void 0,maxDate:e.date_max??void 0,multiple:e.select_multiple??void 0,searchable:e.select_searchable??void 0,allowClear:e.select_allowClear??void 0,selectDefaultValue:e.select_defaultValue??void 0,trueLabel:e.bool_trueLabel??void 0,falseLabel:e.bool_falseLabel??void 0,boolDefaultValue:e.bool_defaultValue??void 0},capabilities:{data:r(e.data_instances,e.data_activeId),formula:{...r(a,e.formula_activeId),currentFormula:t(a,e.formula_activeId)},condition:{...r(i,e.condition_activeId),currentConditions:t(i,e.condition_activeId)},table:r(e.table_instances,e.table_activeId),api:r(e.api_instances,e.api_activeId),link:r(e.link_instances,e.link_activeId),markers:r(e.markers_instances,e.markers_activeId)}}},[l]),E=r.useRef(""),g=r.useMemo(()=>{if(!n.conditions)return!0;const{dependsOn:e,showWhen:r,operator:a="equals"}=n.conditions;if(!e)return!0;const i=t[e];switch(a){case"equals":return i===r;case"not_equals":return i!==r;case"contains":return String(i||"").includes(String(r));case"exists":return null!=i&&""!==i;default:return!0}},[n.conditions,t]),y=r.useMemo(()=>{const e=[...n.fields],r=[],a=new Set;let i=0;e.forEach(n=>{var s,o,c,d,m,u,p;if(a.has(n.id))return;if(Boolean(n.parentRepeaterId&&n.sourceTemplateId))return;const f="leaf_repeater"===n.type||"LEAF_REPEATER"===n.type||"leaf_repeater"===n.fieldType||"LEAF_REPEATER"===n.fieldType||n.metadata&&"object"==typeof n.metadata&&"repeater"in n.metadata;if("e207d8bf-6a6f-414c-94ed-ffde47096915"===n.id||n.id,f){n.id;const o=null==(s=n.metadata)?void 0:s.repeater,c=(null==o?void 0:o.templateNodeIds)||[],d=e=>null==l?void 0:l.find(n=>n.id===e),m=e=>!!e&&("string"==typeof e.fieldType&&e.fieldType.length>0||"string"==typeof e.subType&&e.subType.length>0||e.type&&e.type.includes("leaf")),u=e=>(null==l?void 0:l.filter(n=>n.parentId===e))||[],p=e=>{const n=[],r=[e],t=new Set;for(;r.length;){const e=r.pop();if(t.has(e))continue;t.add(e);const a=u(e);for(const i of a)m(i)&&n.push(i),i.id&&!t.has(i.id)&&r.push(i.id)}return n},f=(e=>{if(!l||0===l.length)return e;const r=l.find(e=>e.id===n.id);if(!r||!r.children)return e;const t=[];return r.children.forEach(n=>{var r;(null==(r=n.config)?void 0:r.sourceRef)&&e.includes(n.config.sourceRef)?t.push(n.config.sourceRef):e.includes(n.id)&&t.push(n.id)}),e.forEach(e=>{t.includes(e)||t.push(e)}),t})((e=>{const n=[];return e.forEach(e=>{const r=d(e);if(r)if(m(r))n.push(e);else{p(e).forEach(e=>{n.push(e.id),e.conditionalFields&&e.conditionalFields.forEach(e=>n.push(e.id)),e.sharedReferenceIds&&e.sharedReferenceIds.forEach(e=>n.push(e)),e.sharedReferenceId&&"string"==typeof e.sharedReferenceId&&n.push(e.sharedReferenceId),e.config&&e.config.sourceRef&&n.push(e.config.sourceRef)})}}),Array.from(new Set(n))})(c)),b=n.label||n.name||"EntrÃ©e",v=n.repeater_buttonSize||(null==o?void 0:o.buttonSize)||"middle",T=n.repeater_buttonWidth||(null==o?void 0:o.buttonWidth)||"auto";n.repeater_iconOnly??(null==o||o.iconOnly);const N=n.repeater_maxItems??(null==o?void 0:o.maxItems)??null,D=`${n.id}_instanceCount`;t[D];const L=e.filter(e=>e.parentRepeaterId===n.id&&e.sourceTemplateId),x={},C=e=>{if(!e)return;const n=e.match(/\(Copie\s*(\d+)\)/i);return n?parseInt(n[1],10):void 0};f.forEach(e=>{x[e]=[]}),L.forEach(e=>{const n=e.sourceTemplateId;n&&(x[n]||(x[n]=[]),x[n].push(e))}),Object.keys(x).forEach(e=>{x[e].sort((e,n)=>{var r,t;const a=new Date((null==(r=e.metadata)?void 0:r.duplicatedAt)||0).getTime(),i=new Date((null==(t=n.metadata)?void 0:t.duplicatedAt)||0).getTime();if(a!==i)return a-i;const s=C(e.label),o=C(n.label);return void 0!==s&&void 0!==o&&s!==o?s-o:String(e.label||"").localeCompare(String(n.label||""))})});const E=Math.max(0,...Object.values(x).map(e=>e.length));for(let e=0;e<E;e++){const n=[];for(const r of f){const t=(x[r]||[])[e];t&&(a.add(t.id),n.push(t))}n.forEach((e,a)=>{const s=a===n.length-1;r.push({...e,order:i,isLastInCopyGroup:s}),i++;try{const n=e.isSelect||Array.isArray(e.options),a="cascade"===e.type;if(!n&&!a)return;const s=e=>null==e?e:String(e);let o=t[e.id],c=Array.isArray(e.options)?e.options.find(e=>null==o?void 0===e.value||null===e.value:e.value===o||s(e.value)===s(o)):void 0,d=[];const m=c&&Array.isArray(c.conditionalFields)?c.conditionalFields:[];if(m.length>0)d=m;else{let n;try{if("undefined"!=typeof window&&window.TBL_FORM_DATA){const r=`${e.id}__selectedNodeId`,t=window.TBL_FORM_DATA[r];"string"==typeof t&&t.length>0&&(n=t)}}catch{}if(n){const e=l.find(e=>e.id===n);if(e){const n=l.filter(n=>n.parentId===e.id&&"leaf_option_field"===n.type);for(const e of n)d.push(B(e));const r=h(e.id,l);for(const e of r){const n=l.find(n=>n.id===e);n&&d.push(B(n))}null==o&&(o=e.label)}}}d.length>0&&d.forEach(n=>{if(r.some(r=>r.id===n.id&&r.parentFieldId===e.id&&r.parentOptionValue===o))return;const t=n.sharedReferenceName||n.label||String(o??""),a={...n,label:t,sharedReferenceName:t,order:i,isConditional:!0,parentFieldId:e.id,parentOptionValue:o,mirrorTargetLabel:(null==c?void 0:c.label)||String(o??"")};r.push(a),i++})}catch(o){}})}const g=E,y=!N||g<(Number(N)||1/0),V=n.repeater_addButtonLabel||(null==o?void 0:o.addButtonLabel)||("EntrÃ©e"!==b?`Ajouter ${b}`:"Ajouter une entrÃ©e"),w={...n,id:`${n.id}_addButton`,type:"REPEATER_ADD_BUTTON",label:V,order:i,isRepeaterButton:!0,repeaterParentId:n.id,repeaterCanAdd:y,repeaterInstanceCount:g,repeaterButtonSize:v,repeaterButtonWidth:T,repeaterIconOnly:!1,repeater_buttonSize:"middle",repeater_buttonWidth:"full",repeater_iconOnly:!1};return r.push(w),void i++}if(n.conditions&&n.conditions.length>0){const e=n.conditions[0],a=t[e.dependsOn];let s=!1;switch(e.operator){case"equals":s=a===e.showWhen;break;case"not_equals":s=a!==e.showWhen;break;default:s=!0}s&&(r.push({...n,order:i,...n.isConditional&&{isConditional:n.isConditional},...n.parentFieldId&&{parentFieldId:n.parentFieldId},...n.parentOptionValue&&{parentOptionValue:n.parentOptionValue},...n.namespace&&{namespace:n.namespace}}),i++)}else{r.push({...n,order:i,...n.isConditional&&{isConditional:n.isConditional},...n.parentFieldId&&{parentFieldId:n.parentFieldId},...n.parentOptionValue&&{parentOptionValue:n.parentOptionValue},...n.namespace&&{namespace:n.namespace}}),i++;const a=n.isSelect||Array.isArray(n.options),s="cascade"===n.type&&(!n.options||0===n.options.length);if(a&&n.options||s){let a=t[n.id];if(void 0===a){const e=n.originalFieldId;e&&void 0!==t[e]&&(a=t[e])}if(void 0===a){const e=/^.+?_\d+?_(.+)$/.exec(n.id);e&&e[1]&&void 0!==t[e[1]]&&(a=t[e[1]])}if(void 0===a&&n.id.includes("_0_")){const e=n.id.split("_0_")[1];e&&void 0!==t[e]&&(a=t[e])}if(void 0===a){const e=(()=>{const e=n.id.split("_");if(e.length>=3){return e.slice(2).join("_")||void 0}})();if(e){const n=Object.keys(t).find(n=>n===e||n.endsWith(`_${e}`));n&&void 0!==t[n]&&(a=t[n])}}let s="undefined"===a?void 0:a;(null==(o=n.label)?void 0:o.includes("Versant"))||(null==(c=n.id)?void 0:c.includes("versant"))||(null==(d=n.label)||d.toLowerCase().includes("versant"));n.id,n.id&&n.id.includes("10724c29-a717-4650-adf3-0ea6633f64f1_");const f=e=>null==e?e:String(e),v=f(s);let T,N=n.options.find(e=>null==s?void 0===e.value||null===e.value:e.value===s);if(N||(N=n.options.find(e=>f(e.value)===v),N&&L("ðŸŸ¡ [SECTION RENDERER] Correspondance option niveau 1 trouvÃ©e via comparaison loose (string).")),L(`\n${"=".repeat(80)}`),L(`ðŸš€ðŸš€ðŸš€ [EVERY CASCADE CHECK] field.type="${n.type}", field.label="${n.label}"`),L(`  selectedValue: "${s}"`),L(`  selectedOption exists? ${!!N}`),N&&(L(`    â†’ label: "${N.label}"`),L(`    â†’ Has conditionalFields? ${!!N.conditionalFields}`),L(`    â†’ conditionalFields length: ${(null==(m=null==N?void 0:N.conditionalFields)?void 0:m.length)||0}`)),L(`${"=".repeat(80)}\n`),N&&n.type,!N&&l&&l.length>0){let r,t;if("undefined"!=typeof window&&window.TBL_CASCADER_NODE_IDS&&(t=window.TBL_CASCADER_NODE_IDS[n.id]),!t&&"undefined"!=typeof window&&window.TBL_FORM_DATA)try{const r=window.TBL_FORM_DATA;let a=r[`${n.id}__selectedNodeId`];if((!a||"string"!=typeof a)&&Array.isArray(e)){const t=e.filter(e=>(null==e?void 0:e.originalFieldId)===n.id||(null==e?void 0:e.sourceTemplateId)===n.id);for(const e of t){const n=r[`${e.id}__selectedNodeId`];if("string"==typeof n&&n.length>0){a=n,T=e.id;break}}}"string"==typeof a&&a.length>0&&(t=a)}catch{}t&&(r=l.find(e=>e.id===t)),r||(r=l.find(e=>!("leaf_option"!==e.type&&"leaf_option_field"!==e.type||e.label!==s&&f(e.label)!==v)));const a=null==(u=n.options)?void 0:u.find(e=>f(e.value)===v||e.value===s);if(a&&a.conditionalFields&&a.conditionalFields.length>0)N=a,null==s&&(s=a.value);else if(r){const e={id:r.id,value:r.label,label:r.label,metadata:r.metadata||null},n=[],t=new Set,a=l.filter(e=>e.parentId===r.id&&"leaf_option_field"===e.type);a.length>0&&a.forEach(e=>{const r=B(e);n.push(r),t.add(r.id)});const i=h(r.id,l);i.length>0&&i.forEach(e=>{const r=l.find(n=>n.id===e);if(!r)return;if(t.has(r.id))return;const a=B(r);n.push(a),t.add(a.id)}),n.length>0&&(e.conditionalFields=n),N=e,null==s&&(s=e.value)}else L("ðŸ”´ [SECTION RENDERER] Aucune option match dans field.options ni allNodes. selectedValue=",s,"selectedNorm=",v)}else N||L("ðŸ”´ [SECTION RENDERER] Aucune option match strict ou loose. selectedValue=",s,"selectedNorm=",v,"options=",n.options.map(e=>({value:e.value,norm:f(e.value)})));if(N&&(!Array.isArray(N.conditionalFields)||0===N.conditionalFields.length)&&l&&l.length>0)try{let e;if(N.id&&(e=l.find(e=>e.id===N.id)),e||(e=l.find(e=>!("leaf_option"!==e.type&&"leaf_option_field"!==e.type||e.label!==N.value&&f(e.label)!==v))),e){const n=[],r=new Set;l.filter(n=>n.parentId===e.id&&"leaf_option_field"===n.type).forEach(e=>{const t=B(e);n.push(t),r.add(t.id)});h(e.id,l).forEach(e=>{const t=l.find(n=>n.id===e);if(!t||r.has(t.id))return;const a=B(t);n.push(a),r.add(a.id)}),n.length>0&&(N.conditionalFields=n)}}catch(b){}L("ðŸ” [SECTION RENDERER] Option finale trouvÃ©e:",N);const D=(null==N?void 0:N.conditionalFields)||[];let x=D;if("cascade"===n.type&&s&&N){if("Mesure simple"===N.label&&(null==(p=N.conditionalFields)?void 0:p.length)>0){N.conditionalFields.forEach((e,n)=>{});N.conditionalFields.find(e=>{var n,r;return(null==(n=e.label)?void 0:n.toLowerCase().includes("longueur"))&&(null==(r=e.label)?void 0:r.toLowerCase().includes("faÃ§ade"))}),N.conditionalFields.find(e=>{var n;return null==(n=e.label)?void 0:n.toLowerCase().includes("rampant")})}N.conditionalFields&&N.conditionalFields.length}if(D.length>0){"Mesure simple"===(null==N?void 0:N.label)&&n.isRepeaterInstance;const e=n.repeaterNamespace;e&&n.isRepeaterInstance&&(null==N||N.label,x=D.map((n,r)=>{var t,a,i,s,o;if(n.isRepeaterInstance)return n;const l=!!(n.sharedReferenceId||n.sharedReferenceIds&&n.sharedReferenceIds.length>0),c=!!("tree"===(null==(t=n.metadata)?void 0:t.sourceType)||"tree"===(null==(a=n.config)?void 0:a.sourceType)||n.nodeId||(null==(i=n.metadata)?void 0:i.nodeId)||(null==(s=n.config)?void 0:s.nodeId)||(null==(o=n.metadata)?void 0:o.sourceRef)||n.id&&n.id.startsWith("node_"));if(l||c)return null==N||N.label,{...n,nodeId:n.nodeId||n.id};const d=Re(n,e,{applyLabelPrefix:!1,templateNodeId:n.originalFieldId||n.repeaterTemplateNodeId||n.id});return null==N||N.label,d}))}if(x.length>0){if(T&&T!==n.id)return;const e=n.id;if(null==N||N.label,null==N||N.label,T)L(`[SKIP INJECTION @TEMPLATE] La sÃ©lection appartient Ã  une copie (${T}). L'injection se fera au niveau de la copie.`);else{x!==D&&(N.conditionalFields=x);const t={fieldId:e,optionValue:N.value,conditionalIds:x.map(e=>e.id)},a=JSON.stringify(t);E.current!==a?(E.current=a,L("========== INJECTION CHAMPS CONDITIONNELS =========="),L(`Field: "${n.label}"`),L(`Option: "${N.label}"`),L(`Nombre de champs: ${x.length}`),L("DÃ©tails champs:",x.map(e=>({label:e.label,type:e.type,placeholder:e.placeholder})))):L(`(dÃ©jÃ  loggÃ©) Injection inchangÃ©e pour field=${e} option=${N.value}`),x.forEach((n,t)=>{const a=r.some(r=>r.id===n.id&&r.parentFieldId===e&&r.parentOptionValue===s),o=r.some(r=>r.parentFieldId===e&&r.parentOptionValue===s&&r.label===n.label);if(a||o)return;let l=n.sharedReferenceName||n.label||`${N.label} ${t+1}`;const c=n.repeaterNamespace;(null==c?void 0:c.labelPrefix)&&!l.startsWith(`${c.labelPrefix} -`)&&(l=`${c.labelPrefix} - ${l}`);const d={...n,label:l,sharedReferenceName:l,order:i,isConditional:!0,parentFieldId:e,parentOptionValue:s,mirrorTargetLabel:N.label};L(`CrÃ©ation champ conditionnel #${t+1}`,{label:d.label,order:d.order,parentFieldId:d.parentFieldId,parentOptionValue:d.parentOptionValue}),r.push(d),i++})}}else if(N&&(N.hasData||N.hasFormula)){L("Option avec capacitÃ©s TreeBranchLeaf",{option:N.label,hasData:N.hasData,hasFormula:N.hasFormula});const e={id:`${N.value}_smart_field`,type:"TEXT",label:N.label,order:i,isConditional:!0,parentFieldId:n.id,parentOptionValue:s,hasData:N.hasData,hasFormula:N.hasFormula,capabilities:N.capabilities,metadata:N.metadata,isTreeBranchLeafSmart:!0};L(`GÃ©nÃ©ration automatique du champ intelligent pour ${N.label}`),r.push(e),i++}else L(`Aucun champ conditionnel trouvÃ© pour l'option "${s}"`),L("Liste options avec champs conditionnels",n.options.filter(e=>e.conditionalFields&&e.conditionalFields.length>0).map(e=>{var n;return{label:e.label,value:e.value,count:null==(n=e.conditionalFields)?void 0:n.length}}))}}});return r.reduce((e,n)=>{const r=!0===n.isConditional?`${n.id}::${n.parentFieldId||"no-parent"}::${n.parentOptionValue??""}`:n.id,t=e.findIndex(e=>(!0===e.isConditional?`${e.id}::${e.parentFieldId||"no-parent"}::${e.parentOptionValue??""}`:e.id)===r);if(-1===t)e.push(n);else{const r=e[t];n.order<r.order&&(e[t]=n)}return e},[])},[L,t,n,l,B,h]);if(y.length>0){y.map(e=>({label:e.label,type:e.type,isConditional:e.isConditional,parentFieldId:e.parentFieldId,hasSharedRefId:!(!e.sharedReferenceId&&!e.sharedReferenceIds),order:e.order}));y.filter(e=>e.isConditional).length}const A=r.useMemo(()=>{const e=y.filter(e=>{const n=e.metadata||{},r=!!(null==n?void 0:n.sourceTemplateId);return!r});return y.forEach(e=>{e.isConditional}),e},[y,n.title]),R=()=>{switch(m){case 0:return{marginBottom:"24px",border:"1px solid #d9d9d9",borderRadius:"8px"};case 1:return{marginBottom:"16px",border:"1px solid #f0f0f0",borderRadius:"6px",marginLeft:"16px"};default:return{marginBottom:"12px",border:"1px solid #fafafa",borderRadius:"4px",marginLeft:16*m+"px"}}},{evaluateBatch:_}=fe({debug:!1}),k=r.useRef({}),[O,I]=r.useState(!1),M=n.isDataSection||"DonnÃ©es"===n.title||n.title.includes("DonnÃ©es");r.useEffect(()=>{if(!M)return;const e=[];for(const r of n.fields||[]){const n=r.capabilities&&r.capabilities.data;if((null==n?void 0:n.instances)&&Object.keys(n.instances).length>0){const r=n.activeId||Object.keys(n.instances)[0];r&&e.push(r)}}0!==e.length?(async()=>{const n=await _(e,t),r={};Object.values(n).forEach(e=>{r[e.nodeId]=e.calculatedValue}),k.current=r,I(!0)})():I(!0)},[M,t,n.fields,_]);return g?e.jsxDEV("div",{style:R(),children:e.jsxDEV(o,{size:0===m?"default":"small",className:`tbl-section-level-${m}`,children:[m>0&&e.jsxDEV("div",{className:"mb-4",children:"DonnÃ©es"===n.title||n.title.includes("DonnÃ©es")?e.jsxDEV("div",{style:{background:"linear-gradient(135deg, #14b8a6 0%, #0891b2 100%)",color:"white",padding:"12px 16px",borderRadius:"8px",marginBottom:"16px"},children:e.jsxDEV(we,{strong:!0,style:{color:"white",fontSize:"16px"},children:n.title},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2526,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2517,columnNumber:15},void 0):e.jsxDEV("div",{className:"flex justify-between items-start",children:e.jsxDEV("div",{className:"flex-1",children:[e.jsxDEV("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxDEV(z,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2534,columnNumber:21},void 0),e.jsxDEV(we,{strong:!0,style:{fontSize:"16px"},children:n.title},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2535,columnNumber:21},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2533,columnNumber:19},void 0),n.description&&e.jsxDEV(we,{type:"secondary",className:"block mb-2",children:n.description},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2541,columnNumber:21},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2532,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2531,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2514,columnNumber:11},void 0),(n.isDataSection||"DonnÃ©es"===n.title||n.title.includes("DonnÃ©es")||A.length>0)&&e.jsxDEV(e.Fragment,{children:[n.isDataSection||"DonnÃ©es"===n.title||n.title.includes("DonnÃ©es")?e.jsxDEV("div",{style:{marginBottom:"16px"},children:e.jsxDEV(q,{gutter:T,justify:"center",children:(A.length>0?A:(n.fields||[]).filter(e=>{const n=e.metadata||{},r=!!(null==n?void 0:n.sourceTemplateId);return!r})).map(n=>{var r,i,c,d,m,u,f,h,b,v,T;const N=null==(i=null==(r=n.capabilities)?void 0:r.table)?void 0:i.enabled,D=!0===(null==(m=null==(d=null==(c=n.capabilities)?void 0:c.table)?void 0:d.currentTable)?void 0:m.rowBased)||!0===(null==(h=null==(f=null==(u=n.capabilities)?void 0:u.table)?void 0:f.currentTable)?void 0:h.columnBased),x="matrix"===(null==(T=null==(v=null==(b=n.capabilities)?void 0:b.table)?void 0:v.currentTable)?void 0:T.mode),C="leaf_repeater"===n.type||"LEAF_REPEATER"===n.type||"leaf_repeater"===n.fieldType||"LEAF_REPEATER"===n.fieldType;if(N&&(D||x)||C)return e.jsxDEV(P,{xs:24,sm:12,lg:6,className:"mb-2",children:e.jsxDEV(Ee,{field:n,value:(()=>{var e;const r=t[n.id];return r&&"object"==typeof r&&!Array.isArray(r)?r.value??r.calculatedValue??(null==(e=r.operationResult)?void 0:e.value)??r:r})(),allNodes:l,onChange:e=>{a(n.id,e);try{const r=(n.label||"").toString();if(r){a(`__mirror_data_${r}`,e)}}catch(r){}},isValidation:p,formData:t,treeId:s},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2022,columnNumber:11},void 0)},n.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2015,columnNumber:9},void 0);return e.jsxDEV(P,{xs:24,sm:12,lg:6,children:e.jsxDEV(o,{size:"small",style:(()=>{let e="#0ea5e9",r="#f0f9ff";return"number"===n.type?(e="#059669",r="#ecfdf5"):"select"===n.type?(e="#7c3aed",r="#faf5ff"):"boolean"===n.type&&(e="#dc2626",r="#fef2f2"),{textAlign:"center",border:`2px solid ${e}`,borderRadius:"12px",backgroundColor:r,minHeight:"80px",display:"flex",alignItems:"center",justifyContent:"center"}})(),styles:{body:{padding:"12px 8px"}},children:e.jsxDEV("div",{children:[e.jsxDEV(we,{strong:!0,style:{color:"#0ea5e9",fontSize:"13px",display:"block",marginBottom:"4px"},children:n.label},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2462,columnNumber:13},void 0),(()=>{const r=(()=>{var r,a,i,o,l,c,d,m,u,p,f,h,b,v,T,N,D,x,C,B,E,g,y,V,w;const S=n.capabilities;L(`ðŸ”¬ [TEST CAPABILITIES] Champ "${n.label}" - Capabilities prÃ©sentes:`,!!S);const A=`__mirror_data_${n.label}`,R=t[A],_=Boolean((null==(a=null==(r=n.capabilities)?void 0:r.data)?void 0:a.instances)||(null==(i=n.capabilities)?void 0:i.formula));let I=R;if(null==I||""===I)try{const e=Ve(n.label||"").map(e=>e);let r=null;for(const a of e)if(void 0!==t[a]){I=t[a],L(`ðŸªž [MIRROR][VARIANT] Utilisation variante '${a}' pour champ '${n.label}' ->`,I),r=a;break}r||_||(()=>{try{return"1"===localStorage.getItem("TBL_DIAG")}catch{return!1}})()}catch(U){}if(!_&&null!=I&&""!==I){const e=(null==(o=n.config)?void 0:o.decimals)??2,r=null==(l=n.config)?void 0:l.unit,t="number"==typeof I?I:parseFloat(String(I).replace(",",".")),a=isNaN(t)?String(R):t,i=_e(a,{displayFormat:"number",unit:r,precision:e});return L(`ðŸªž [MIRROR] Affichage via valeur miroir pour "${n.label}" (${A}) (pas de capacitÃ© dynamique):`,i),i??String(a)}null!=I&&""!==I&&_&&L(`ðŸªž [MIRROR] Valeur miroir DÃ‰TECTÃ‰E pour "${n.label}" mais capacitÃ©s dynamiques prÃ©sentes - on laisse les capacitÃ©s s'exÃ©cuter`);try{const r=null==(c=null==S?void 0:S.data)?void 0:c.activeId,a=null==(d=null==S?void 0:S.data)?void 0:d.instances,i=r&&a?a[r]:a?a[Object.keys(a)[0]]:void 0,o=null==(m=null==i?void 0:i.metadata)?void 0:m.sourceType,l=null==(u=null==i?void 0:i.metadata)?void 0:u.sourceRef;if("tree"===o&&"string"==typeof l){const a=l;if(a.startsWith("condition:")||a.startsWith("formula:")||a.startsWith("node-formula:")||a.startsWith("@value.")||a.startsWith("@table.")){L(`Routing data direct sourceRef='${a}'`);const o=i||{};return r&&s?e.jsxDEV(pe,{nodeId:r,treeId:s,formData:t,unit:o.unit,precision:"number"==typeof o.precision?o.precision:(null==(p=n.config)?void 0:p.decimals)||2,placeholder:"Calcul..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2145,columnNumber:15},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2140,columnNumber:22},void 0)}}}catch(U){}if((null==(f=null==S?void 0:S.data)?void 0:f.enabled)||(null==(h=null==S?void 0:S.data)?void 0:h.instances)){L(`ï¿½ [TEST DATA] Champ "${n.label}" a une capacitÃ© Data active:`,S.data.activeId),L("ðŸ”¬ [TEST DATA] Instances disponibles:",S.data.instances);const r=S.data.activeId?null==(b=S.data.instances)?void 0:b[S.data.activeId]:S.data.instances?S.data.instances[Object.keys(S.data.instances)[0]]:void 0;if(L("ðŸ”¬ [TEST DATA] Instance active:",r),r&&r.metadata){const{sourceType:n,sourceRef:a,fixedValue:i}=r.metadata;if(L(`ï¿½ [TEST METADATA] sourceType: "${n}"`),L(`ðŸ”¬ [TEST METADATA] sourceRef: "${a}"`),L("ðŸ”¬ [TEST METADATA] fixedValue:",i),"tree"===n&&a){const n=String(a),i=n.startsWith("condition:"),o=n.startsWith("formula:")||n.startsWith("node-formula:"),l=n.startsWith("@value."),c=n.startsWith("@table.");if(L(`ðŸ”¬ [TEST TREE SOURCE] Router direct: condition=${i}, formula=${o}, value=${l}, table=${c}`),i||o||l||c){if(O&&n.startsWith("condition:")){const n=(null==(v=null==S?void 0:S.data)?void 0:v.activeId)||((null==(T=null==S?void 0:S.data)?void 0:T.instances)?Object.keys(S.data.instances)[0]:void 0);if(n&&null!=k.current[n]){const t=k.current[n];return e.jsxDEV("span",{style:{fontWeight:"bold",color:"#047857"},children:_e(t,r)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2196,columnNumber:26},void 0)}}const a=(null==(N=null==S?void 0:S.data)?void 0:N.activeId)||((null==(D=null==S?void 0:S.data)?void 0:D.instances)?Object.keys(S.data.instances)[0]:void 0);return a&&s?e.jsxDEV(pe,{nodeId:a,treeId:s,formData:t,unit:null==r?void 0:r.unit,precision:null==r?void 0:r.precision,placeholder:O?"---":"Calcul..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2209,columnNumber:17},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2204,columnNumber:24},void 0)}const d=(null==(x=null==S?void 0:S.data)?void 0:x.activeId)||((null==(C=null==S?void 0:S.data)?void 0:C.instances)?Object.keys(S.data.instances)[0]:void 0);if(d){L(`ðŸŽ¯ [DATA VARIABLE] nodeId utilisÃ© pour Ã©valuation: ${d}`);const n=O?k.current[d]:null;return O&&null!=n?e.jsxDEV("span",{style:{fontWeight:"bold",color:"#047857"},children:_e(n,r)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2227,columnNumber:24},void 0):s?e.jsxDEV(pe,{nodeId:d,treeId:s,formData:t,unit:null==r?void 0:r.unit,precision:null==r?void 0:r.precision,placeholder:O?"---":"Calcul..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2236,columnNumber:17},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2231,columnNumber:24},void 0)}return"---"}if("fixed"===n&&void 0!==i)return L(`ï¿½ [TEST FIXED] Valeur fixe dÃ©tectÃ©e: ${i}`),_e(i,r);if(void 0!==r.defaultValue)return L(`ï¿½ [TEST DEFAULT] Valeur par dÃ©faut: ${r.defaultValue}`),_e(r.defaultValue,r)}}const M=(null==(B=null==S?void 0:S.formula)?void 0:B.activeId)||((null==(E=null==S?void 0:S.formula)?void 0:E.instances)&&Object.keys(S.formula.instances).length>0?Object.keys(S.formula.instances)[0]:void 0);if(M&&String(M).trim().length>0||(null==(g=null==S?void 0:S.formula)?void 0:g.currentFormula)){const r=null==(y=null==S?void 0:S.formula)?void 0:y.currentFormula,a=null==r?void 0:r.expression,i=(null==r?void 0:r.variables)?Object.fromEntries(Object.entries(r.variables).map(([e,n])=>[e,{sourceField:n.sourceField,type:n.type}])):void 0;return L(`ðŸ”¬ [TEST FORMULA ENHANCED] Formule avec expression: ${a}`),L("ðŸ”¬ [TEST FORMULA ENHANCED] Variables dÃ©finies:",i),M&&s?e.jsxDEV(pe,{nodeId:M,treeId:s,formData:t,unit:null==(V=n.config)?void 0:V.unit,precision:(null==(w=n.config)?void 0:w.decimals)||4,placeholder:"Calcul en cours..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2282,columnNumber:11},void 0):e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2277,columnNumber:18},void 0)}let j=t[n.id];if(j&&"object"==typeof j&&!Array.isArray(j)){const e=j;if(j=e.value??e.calculatedValue??(e.operationResult&&"object"==typeof e.operationResult?e.operationResult.value:void 0)??j,j&&"object"==typeof j){const e=j;j=e.text??e.result??e.displayValue??e.humanText??e.label??j}L("ðŸ›¡ï¸ [EXTRACTION PRÃ‰COCE] Objet dÃ©tectÃ©, valeur extraite:",j)}L(`ðŸ”¬ [TEST FALLBACK] Aucune capacitÃ© - valeur brute: ${j}`),n.id;try{const r=n.treeMetadata||n.config||{},a=r.sourceRef||r.source_ref;if(a&&"string"==typeof a&&/^(formula:|condition:|variable:|@value\.)/.test(a)){L(`ðŸ§ª [FALLBACK SMART] Utilisation CalculatedFieldDisplay via metaSourceRef='${a}'`),"1"===localStorage.getItem("TBL_DIAG")&&L("[TBL_DIAG][fallback-smart]",{fieldId:n.id,label:n.label,metaSourceRef:a,hasCapabilities:!!n.capabilities});const r=a.includes(":")?a.split(":")[1]:a;if(!r||!s)return e.jsxDEV("span",{style:{color:"#888"},children:"---"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2352,columnNumber:20},void 0);const i=n.config;return e.jsxDEV(pe,{nodeId:r,treeId:s,formData:t,unit:null==i?void 0:i.unit,precision:(null==i?void 0:i.decimals)||2,placeholder:"Calcul..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2358,columnNumber:13},void 0)}}catch{}if(null==j||void 0===j||""===j)return L("ðŸ”¬ [TEST FALLBACK] Pas de valeur - affichage placeholder"),"---";if(L(`ðŸ”¬ [TEST FALLBACK] Retour valeur brute: ${j}`),"object"==typeof j&&null!==j){L("âš ï¸ [FALLBACK OBJECT] DÃ©tection d'un objet dans rawValue:",j);const e=j,n=e.value||e.calculatedValue||e.text||e.result||e.displayValue||e.humanText||e.label;if(null!=n)return L("âœ… [FALLBACK OBJECT] Valeur extraite:",n),String("object"==typeof n&&null!==n&&"value"in n?n.value:n);if(e.operationResult&&"object"==typeof e.operationResult){const n=e.operationResult;if(void 0!==n.value)return L("âœ… [FALLBACK OBJECT] Valeur extraite depuis operationResult:",n.value),String(n.value)}if(Array.isArray(j))return j.join(", ");L("âš ï¸ [FALLBACK OBJECT] Aucune propriÃ©tÃ© exploitable trouvÃ©e, affichage JSON");try{return JSON.stringify(j)}catch{return String(j)}}return String(j)})();return e.jsxDEV(we,{style:{color:"#64748b",fontSize:"12px",fontWeight:"bold"},children:r},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2478,columnNumber:17},void 0)})()]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2461,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2456,columnNumber:9},void 0)},n.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2455,columnNumber:7},void 0)})},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2558,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2557,columnNumber:15},void 0):A.length>0?e.jsxDEV(q,{gutter:v,className:"tbl-form-row",children:A.map(r=>{if(r.isConditional,r.isRepeaterButton){const i="REPEATER_ADD_BUTTON"===r.type,s="REPEATER_REMOVE_INSTANCE_BUTTON"===r.type,o=r.repeaterParentId,l=`${o}_instanceCount`,c=r.repeaterInstanceCount||0,m=r.repeaterInstanceIndex,u=(r.repeater_buttonSize??r.repeaterButtonSize,r.repeater_buttonWidth??r.repeaterButtonWidth,!i&&(r.repeater_iconOnly??r.repeaterIconOnly??!1));return i&&!r.repeaterCanAdd?null:e.jsxDEV(P,{xs:24,sm:12,md:8,lg:6,xl:6,className:"mb-2 tbl-form-col",style:{},children:e.jsxDEV(x.Item,{className:"mb-4 "+(b?"tbl-form-item-mobile":""),labelCol:{span:24},wrapperCol:{span:24},colon:!1,label:e.jsxDEV("span",{style:{visibility:"hidden"},children:"."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2650,columnNumber:34},void 0),style:{width:"150px"},children:e.jsxDEV(V,{type:"dashed",ghost:!1,size:"middle",block:!1,danger:s,icon:i?e.jsxDEV(w,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2659,columnNumber:49},void 0):e.jsxDEV(S,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2659,columnNumber:68},void 0),"aria-label":i?r.label||"Ajouter":"RÃ©pÃ©teur",style:{height:32,width:"150px",fontSize:"14px",borderRadius:"6px",borderStyle:"dashed",backgroundColor:i?"#fff":void 0,borderColor:i?"#d9d9d9":void 0,color:void 0,display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"0 12px"},onClick:async()=>{var e,r,d,u;if(i)try{const t=n.fields.find(e=>e.id===o);let a=(null==t?void 0:t.repeater_templateNodeIds)||[];if(!Array.isArray(a))if("string"==typeof a)try{a=JSON.parse(a)}catch(p){a=[]}else a=[];if(0===a.length&&(a=(null==(r=null==(e=null==t?void 0:t.metadata)?void 0:e.repeater)?void 0:r.templateNodeIds)||[]),0===a.length)return;await f.post(`/api/treebranchleaf/nodes/${o}/duplicate-templates`,{templateNodeIds:a});"undefined"!=typeof window&&window.TBL_FORCE_REFRESH&&window.TBL_FORCE_REFRESH()}catch(h){}else if(s){L(`ðŸ” [REPEATER] Suppression instance #${m+1}:`,{repeaterParentId:o,instanceIndex:m,oldCount:c});a(l,c-1);const e=n.fields.find(e=>e.id===o),r=(null==(u=null==(d=null==e?void 0:e.metadata)?void 0:d.repeater)?void 0:u.templateNodeIds)||[],i=expandTemplateNodeIds(r);for(let n=m+1;n<c;n++)i.forEach(e=>{const r=`${o}_${n-1}_${e}`,i=t[`${o}_${n}_${e}`];a(r,i)});i.forEach(e=>{a(`${o}_${c-1}_${e}`,void 0)})}},disabled:d,children:i?r.label||"Ajouter":!u&&r.label},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2653,columnNumber:27},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2644,columnNumber:25},void 0)},r.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2633,columnNumber:23},void 0)}return!0===r.isConditional?e.jsxDEV(P,{xs:24,sm:12,md:"textarea"===r.type||"TEXTAREA"===r.type?24:8,lg:"textarea"===r.type||"TEXTAREA"===r.type?24:6,xl:"textarea"===r.type||"TEXTAREA"===r.type?24:6,className:"mb-2 tbl-form-col conditional-field-injected","data-parent-field-id":r.parentFieldId||"","data-parent-option-value":String(r.parentOptionValue??""),"data-field-id":r.id,"data-field-label":r.label||"",children:e.jsxDEV(Ee,{field:r,value:(()=>{var e;const n=t[r.id];return n&&"object"==typeof n&&!Array.isArray(n)?n.value??n.calculatedValue??(null==(e=n.operationResult)?void 0:e.value)??n:n})(),allNodes:l,onChange:e=>{a(r.id,e);try{const n=(r.label||"").toString(),t=r.mirrorTargetLabel||n;if(t){a(`__mirror_data_${t}`,e)}}catch(n){}},disabled:d,formData:t,treeMetadata:r.treeMetadata,treeId:s},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2810,columnNumber:25},void 0)},`${r.id}__pf_${r.parentFieldId||"none"}`,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2797,columnNumber:23},void 0):e.jsxDEV(P,{xs:24,sm:12,md:"textarea"===r.type||"TEXTAREA"===r.type?24:8,lg:"textarea"===r.type||"TEXTAREA"===r.type?24:6,xl:"textarea"===r.type||"TEXTAREA"===r.type?24:6,className:"mb-2 tbl-form-col",children:[(r.canAddNewCopy||r.isLastInCopyGroup)&&e.jsxDEV("div",{style:{position:"relative",display:"flex",alignItems:"flex-start",gap:"8px"},children:[e.jsxDEV("div",{style:{flex:1},children:e.jsxDEV(Ee,{field:r,value:(()=>{var e;const n=t[r.id];return n&&"object"==typeof n&&!Array.isArray(n)?n.value??n.calculatedValue??(null==(e=n.operationResult)?void 0:e.value)??n:n})(),allNodes:l,onChange:e=>{L(`ðŸ”„ [SECTION RENDERER] onChange appelÃ© pour ${r.id}:`,e),a(r.id,e);try{const n=(r.label||"").toString(),t=r.repeaterNamespace,i=Boolean(t);let s=n;if(i&&(null==t?void 0:t.labelPrefix)){const e=t.labelPrefix;n.startsWith(e)&&(s=n.substring(e.length).replace(/^\s*-\s*/,"").trim(),L(`ðŸ”§ [MIRROR][NAMESPACE] Label nettoyÃ©: "${n}" -> "${s}"`))}if(s){const n=`__mirror_data_${s}`;L(`ðŸªž [MIRROR][UNIVERSAL] Synchronisation: "${s}" -> ${n} = ${e}`),a(n,e)}}catch(n){}},disabled:d,formData:t,treeMetadata:r.treeMetadata,treeId:s},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3024,columnNumber:29},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3023,columnNumber:27},void 0),e.jsxDEV("div",{style:{display:"flex",gap:"4px"},children:r.isLastInCopyGroup&&r.parentRepeaterId&&e.jsxDEV(V,{type:"text",danger:!0,size:"small",shape:"circle",icon:e.jsxDEV(W,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3080,columnNumber:39},void 0),title:"Supprimer cette copie",style:{marginTop:"4px",minWidth:"24px",height:"24px",padding:"0",display:"flex",alignItems:"center",justifyContent:"center"},onClick:async()=>{var e;try{const t=r.parentRepeaterId,a=String(r.label||""),i=a.match(/\(Copie\s+(\d+)\)/),o=a.match(/-(\d+)\s*$/),c=(null==i?void 0:i[1])||(null==o?void 0:o[1])||null,d=c?` (Copie ${c})`:null,m=c?`-${c}`:null;if(!c)return;const u=n.fields.filter(e=>{const n=e.parentRepeaterId===t,r=String(e.label||""),a=!0===e.isDeletableCopy,i=!!d&&r.endsWith(d),s=!!m&&(/-(\d+)\s*$/.test(r)&&r.endsWith(m));return n&&a&&(i||s)}),p=(l||[]).filter(e=>{const t=String(e.label||""),a=!!d&&t.endsWith(d),i=!!m&&(/-(\d+)\s*$/.test(t)&&t.endsWith(m)),s=!n.fields.some(n=>n.id===e.id)&&(a||i)&&e.id!==r.id;return s}),h=Array.from(new Map([...u,...p].map(e=>[e.id,e])).values());if(0===h.length)return;const b=5,v=3,T=500;let N=0,D=0;const L=[],x=async(e,n=0)=>{var r;try{return await f.delete(`/api/treebranchleaf/trees/${s}/nodes/${e.id}`),{status:"success",label:e.label,id:e.id}}catch(t){const a=(null==(r=null==t?void 0:t.data)?void 0:r.error)||(null==t?void 0:t.message)||"Erreur inconnue",i=(null==t?void 0:t.status)||500;return 500===i&&n<v?(await new Promise(e=>setTimeout(e,T*(n+1))),x(e,n+1)):404===i?{status:"success",label:e.label,id:e.id}:{status:"failed",label:e.label,id:e.id,error:a}}};for(let n=0;n<h.length;n+=b){const r=h.slice(n,n+b),t=await Promise.all(r.map(e=>x(e)));for(const n of t)"success"===n.status?N++:(D++,L.push({label:n.label,id:n.id,lastError:(null==(e=n.error)?void 0:e.toString())||"Erreur inconnue"}));n+b<h.length&&await new Promise(e=>setTimeout(e,T))}"undefined"!=typeof window&&window.TBL_FORCE_REFRESH&&window.TBL_FORCE_REFRESH()}catch(t){}}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3075,columnNumber:31},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3070,columnNumber:27},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3017,columnNumber:25},void 0),!r.canAddNewCopy&&!r.isLastInCopyGroup&&e.jsxDEV(Ee,{field:r,value:(()=>{var e;const n=t[r.id];return n&&"object"==typeof n&&!Array.isArray(n)?n.value??n.calculatedValue??(null==(e=n.operationResult)?void 0:e.value)??n:n})(),allNodes:l,onChange:e=>{L(`ðŸ”„ [SECTION RENDERER] onChange appelÃ© pour ${r.id}:`,e),L("ðŸ”„ [SECTION RENDERER] Ancienne valeur:",t[r.id]),a(r.id,e);try{const n=(r.label||"").toString(),t=r.repeaterNamespace,i=Boolean(t);let s=n;if(i&&(null==t?void 0:t.labelPrefix)){const e=t.labelPrefix;n.startsWith(e)&&(s=n.substring(e.length).replace(/^\s*-\s*/,"").trim(),L(`ðŸ”§ [MIRROR][NAMESPACE] Label nettoyÃ©: "${n}" -> "${s}"`))}if(s){const n=`__mirror_data_${s}`;L(`ðŸªž [MIRROR][UNIVERSAL] Synchronisation: "${s}" -> ${n} = ${e}`),a(n,e),"undefined"!=typeof window&&window.TBL_FORM_DATA&&(window.TBL_FORM_DATA[n]=e,Object.keys(window.TBL_FORM_DATA).forEach(r=>{r.startsWith("__mirror_data_")&&(r.includes(s)||r.includes(s.replace(/[^a-zA-Z0-9]/g,"").toLowerCase())||r===n)&&(window.TBL_FORM_DATA[r]=e,L(`ðŸ”„ [MIRROR][VARIANT] ${r} = ${e}`))}))}if(Boolean(r.isConditional)||/\s-\s/.test(n)){const n=r.mirrorTargetLabel||s.replace(/\s*-\s*Champ.*$/i,"").trim();if(n&&n!==s){const r=`__mirror_data_${n}`;L(`ðŸªž [MIRROR][CONDITIONAL] Mise Ã  jour de la valeur miroir pour "${n}" -> key=${r}:`,e),a(r,e)}}}catch(n){}},disabled:d,formData:t,treeMetadata:r.treeMetadata,treeId:s},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3243,columnNumber:25},void 0)]},r.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3006,columnNumber:21},void 0)})},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2573,columnNumber:15},void 0):null,n.subsections&&n.subsections.length>0&&e.jsxDEV(N,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3332,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2554,columnNumber:11},void 0),n.subsections&&n.subsections.length>0&&e.jsxDEV("div",{className:"mt-4",children:m<2?e.jsxDEV(e.Fragment,{children:n.subsections.map(n=>e.jsxDEV(ke,{section:n,formData:t,onChange:a,treeId:s,allNodes:l,allSections:c,disabled:d,level:m+1,parentConditions:u},n.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3344,columnNumber:19},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3342,columnNumber:15},void 0):e.jsxDEV(G,{size:"small",ghost:!0,children:n.subsections.map(n=>e.jsxDEV(Se,{header:e.jsxDEV("div",{className:"flex items-center gap-2",children:[e.jsxDEV(z,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3366,columnNumber:25},void 0),e.jsxDEV("span",{children:n.title},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3367,columnNumber:25},void 0),e.jsxDEV(C,{size:"small",color:"geekblue",children:[n.fields.length," champs"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3368,columnNumber:25},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3365,columnNumber:23},void 0),children:e.jsxDEV(ke,{section:n,formData:t,onChange:a,treeId:s,allNodes:l,allSections:c,disabled:d,level:m+1,parentConditions:u},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3374,columnNumber:21},void 0)},n.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3362,columnNumber:19},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3360,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:3339,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2508,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2507,columnNumber:5},void 0):e.jsxDEV("div",{style:{...R(),opacity:.3,pointerEvents:"none"},children:e.jsxDEV(o,{size:"small",children:e.jsxDEV("div",{className:"flex items-center gap-2 text-gray-400",children:[e.jsxDEV($,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2498,columnNumber:13},void 0),e.jsxDEV(we,{type:"secondary",children:[n.title," (masquÃ© par condition)"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2499,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2497,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2496,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/TBLSectionRenderer.tsx",lineNumber:2495,columnNumber:7},void 0)},Oe=()=>"undefined"!=typeof window&&!0===window.__TBL_VERBOSE__;Oe()&&(se("ðŸ”„ [FORCE REFRESH] Hook useTBLDataPrismaComplete rechargÃ© Ã ",(new Date).toISOString()),se("ðŸŽ¯ [DEBUG CRITICAL] VÃ©rification des option + champ FORCÃ‰E - systÃ¨me TreeBranchLeaf DYNAMIQUE"));const Ie=new Map,Me=async(e,n,r)=>{var t,a,i,s;if(Oe()&&se(`ðŸ” [RESOLVE_VALUE] RÃ©solution valeur pour "${e.label}" (hasData: ${e.hasData})`),!e.hasData){const n=e.defaultValue||e.value||e.bool_defaultValue||e.text_defaultValue||e.number_defaultValue||e.select_defaultValue||e.date_defaultValue;return Oe()&&se(`ðŸ” [RESOLVE_VALUE] Pas de capacitÃ© donnÃ©es, valeur par dÃ©faut: ${n}`),{value:n}}try{const o=Ie.get(e.id);if(o&&Date.now()-o.timestamp<3e4)return Oe()&&se(`â™»ï¸ [RESOLVE_VALUE] Cache hit pour "${e.label}"`),o.result;const l=await n.get(`/api/treebranchleaf/trees/${r}/nodes/${e.id}/data`);let c;if(Oe()&&se("ðŸ§¾ [RESOLVE_VALUE] Payload brut /data pour",e.label,":",l),l&&"object"==typeof l){const e=l;e.data&&"object"==typeof e.data&&!Array.isArray(e.data)?(c=e.data,Oe()&&se("ðŸ§ª [RESOLVE_VALUE] Forme axios dÃ©tectÃ©e (utilisation de .data)")):(c=e,Oe()&&se("ðŸ§ª [RESOLVE_VALUE] Forme plate dÃ©tectÃ©e (objet direct sans .data)"))}c&&Object.keys(c).length,Oe()&&se("ðŸ” [RESOLVE_VALUE] Configuration variable normalisÃ©e:",c);const d=null==c?void 0:c.sourceType,m=(null==c?void 0:c.sourceRef)||void 0,u=null==c?void 0:c.fixedValue,p=(null==c?void 0:c.selectedNodeId)||void 0,f=null==(t=null==c?void 0:c.metadata)?void 0:t.sourceType,h=null==(a=null==c?void 0:c.metadata)?void 0:a.sourceRef,b=null==(i=null==c?void 0:c.metadata)?void 0:i.fixedValue,v=null==(s=null==c?void 0:c.metadata)?void 0:s.selectedNodeId,T=d||f,N=m??h,D=u??b,L=p||v;if(!c||!T){const n=c&&c.defaultValue||e.defaultValue||e.value;Oe()&&se(`ðŸ” [RESOLVE_VALUE] Pas de sourceType, valeur fallback: ${n}`);const r={value:n,variableConfig:c};return Ie.set(e.id,{timestamp:Date.now(),result:r}),r}if("fixed"===T&&void 0!==D){Oe()&&se(`ðŸ” [RESOLVE_VALUE] Mode fixe, valeur: ${D}`);const n={value:D,variableConfig:c};return Ie.set(e.id,{timestamp:Date.now(),result:n}),n}if("tree"===T){if("string"==typeof N&&N){if(N.startsWith("condition:")||N.startsWith("formula:")||N.startsWith("node-formula:")||N.startsWith("@value.")){Oe()&&se(`ðŸŒ² [RESOLVE_VALUE] RÃ©fÃ©rence dynamique dÃ©tectÃ©e (${N}) â†’ laisser l'Ã©valuation au rendu`);const n={value:null,variableConfig:c};return Ie.set(e.id,{timestamp:Date.now(),result:n}),n}}if(L&&(Oe()&&se(`ðŸ” [RESOLVE_VALUE] Mode arborescence (legacy), selectedNodeId: ${L}`),L.startsWith("node-formula:"))){const n=L.replace("node-formula:","");Oe()&&se(`ðŸ” [RESOLVE_VALUE] (legacy) ID formule extrait: ${n} â†’ Ã©valuation dÃ©lÃ©guÃ©e au rendu`);const r={value:null,variableConfig:c};return Ie.set(e.id,{timestamp:Date.now(),result:r}),r}}const x=c.defaultValue||e.defaultValue||e.value;Oe()&&se(`ðŸ” [RESOLVE_VALUE] Fallback final: ${x}`);const C={value:x,variableConfig:c};return Ie.set(e.id,{timestamp:Date.now(),result:C}),C}catch(o){return{value:e.defaultValue||e.value||null}}},je=(e,n,r,t,a)=>{let i=e;if(e.sharedReferenceId&&!e.isSharedReference){const n=r.get(e.sharedReferenceId);n&&n.isSharedReference&&(Oe()&&se(`ðŸ”— [SHARED REF] RÃ©solution: "${e.label}" â†’ "${n.label}" (${n.id})`),i={...n,id:n.id,label:e.label||n.label,description:e.description||n.description,order:e.order,parentId:e.parentId,treeId:e.treeId,metadata:{...n.metadata,isResolvedReference:!0,referenceSourceId:n.id,referenceSourceLabel:n.label,referenceNodeId:e.id}})}const s=n.get(i.id)||[],o=s.some(e=>"leaf_option"===e.type||"leaf_option_field"===e.type),l=(e,n)=>e&&n&&e[n]||null,c={data:{enabled:!!e.data_instances&&Object.keys(e.data_instances||{}).length>0,activeId:e.data_activeId,instances:e.data_instances},formula:{enabled:!!e.formula_instances&&Object.keys(e.formula_instances||{}).length>0,activeId:e.formula_activeId,instances:e.formula_instances,currentFormula:l(e.formula_instances,e.formula_activeId)},condition:{enabled:!!e.condition_instances&&Object.keys(e.condition_instances||{}).length>0,activeId:e.condition_activeId,instances:e.condition_instances,currentConditions:l(e.condition_instances,e.condition_activeId)},table:{enabled:!!e.table_instances&&Object.keys(e.table_instances||{}).length>0,activeId:e.table_activeId,instances:e.table_instances,currentTable:l(e.table_instances,e.table_activeId)},api:{enabled:!!e.api_instances&&Object.keys(e.api_instances||{}).length>0,activeId:e.api_activeId,instances:e.api_instances,currentAPI:l(e.api_instances,e.api_activeId)},link:{enabled:!!e.link_instances&&Object.keys(e.link_instances||{}).length>0,activeId:e.link_activeId,instances:e.link_instances,currentLinks:l(e.link_instances,e.link_activeId)},markers:{enabled:!!e.markers_instances&&Object.keys(e.markers_instances||{}).length>0,activeId:e.markers_activeId,instances:e.markers_instances,currentMarkers:l(e.markers_instances,e.markers_activeId)}},d=Object.entries(c).filter(([,e])=>e.enabled).map(([e])=>e);if(d.length>0&&Oe()&&se(`ðŸŽ¯ [CAPACITÃ‰S] Champ "${e.label}": ${d.join(", ")}`),o){const a=s.filter(e=>"leaf_option"===e.type||"leaf_option_field"===e.type).sort((e,n)=>e.order-n.order).map(e=>{var a;Oe()&&se(`ðŸ” [DEBUG OPTION] Traitement option "${e.label}" (${e.type})`),Oe()&&se("ðŸŽ¯ [DEBUG OPTION] DÃ©tails option:",{id:e.id,type:e.type,label:e.label,option_label:e.option_label,field_label:e.field_label,fieldType:e.fieldType,isLeafOptionField:"leaf_option_field"===e.type});const i=[];if("leaf_option_field"===e.type){Oe()&&se(`ðŸŽ¯ [OPTION + CHAMP] TrouvÃ© leaf_option_field: "${e.label}" avec field_label: "${e.field_label}"`);const n=e.subType||e.fieldType||e.type||"TEXT";se(`ðŸ” [TYPE DETECTION DYNAMIC] ${e.label}`,{fieldType:e.fieldType,subType:e.subType,type:e.type,final:n}),i.push({id:e.id,name:e.field_label||`${e.label} - Champ`,label:e.field_label||`${e.label} - Champ`,type:n,required:e.isRequired,visible:e.isVisible,placeholder:e.text_placeholder,description:e.description,order:e.order,config:{size:e.appearance_size,width:e.appearance_width,variant:e.appearance_variant,minLength:e.text_minLength,maxLength:e.text_maxLength,rows:e.text_rows,mask:e.text_mask,regex:e.text_regex,textDefaultValue:e.text_defaultValue,min:e.number_min,max:e.number_max,step:e.number_step,decimals:e.number_decimals,prefix:e.number_prefix,suffix:e.number_suffix,unit:e.number_unit,numberDefaultValue:e.number_defaultValue,format:e.date_format,showTime:e.date_showTime,dateDefaultValue:e.date_defaultValue,minDate:e.date_minDate,maxDate:e.date_maxDate,multiple:e.select_multiple,searchable:e.select_searchable,allowClear:e.select_allowClear,selectDefaultValue:e.select_defaultValue,trueLabel:e.bool_trueLabel,falseLabel:e.bool_falseLabel,boolDefaultValue:e.bool_defaultValue},capabilities:{data:{enabled:!!e.data_instances&&Object.keys(e.data_instances||{}).length>0,activeId:e.data_activeId,instances:e.data_instances},formula:{enabled:!!e.formula_instances&&Object.keys(e.formula_instances||{}).length>0,activeId:e.formula_activeId,instances:e.formula_instances,currentFormula:l(e.formula_instances,e.formula_activeId)},condition:{enabled:!!e.condition_instances&&Object.keys(e.condition_instances||{}).length>0,activeId:e.condition_activeId,instances:e.condition_instances,currentConditions:l(e.condition_instances,e.condition_activeId)},table:{enabled:!!e.table_instances&&Object.keys(e.table_instances||{}).length>0,activeId:e.table_activeId,instances:e.table_instances,currentTable:l(e.table_instances,e.table_activeId)},api:{enabled:!!e.api_instances&&Object.keys(e.api_instances||{}).length>0,activeId:e.api_activeId,instances:e.api_instances,currentAPI:l(e.api_instances,e.api_activeId)},link:{enabled:!!e.link_instances&&Object.keys(e.link_instances||{}).length>0,activeId:e.link_activeId,instances:e.link_instances,currentLinks:l(e.link_instances,e.link_activeId)},markers:{enabled:!!e.markers_instances&&Object.keys(e.markers_instances||{}).length>0,activeId:e.markers_activeId,instances:e.markers_instances,currentMarkers:l(e.markers_instances,e.markers_activeId)}}}),Oe()&&se(`  âœ… Champ direct ajoutÃ©: ${e.field_label||e.label}`)}if("leaf_option_field"!==e.type){const r=n.get(e.id)||[];Oe()&&se(`  ðŸ” Enfants de l'option "${e.label}": ${r.length}`),r.filter(e=>e.type.includes("leaf_field")).sort((e,n)=>e.order-n.order).forEach(e=>{Oe()&&se(`    ðŸƒ Enfant trouvÃ©: "${e.label}" (${e.type})`);const n=e.subType||e.fieldType||e.type||"text";se(`ðŸ” [TYPE DETECTION ENFANT] ${e.label}`,{fieldType:e.fieldType,subType:e.subType,type:e.type,final:n}),i.push({id:e.id,name:e.label,label:e.label,type:n,required:e.isRequired,visible:e.isVisible,placeholder:e.text_placeholder,description:e.description,order:e.order,config:{size:e.appearance_size,width:e.appearance_width,variant:e.appearance_variant,minLength:e.text_minLength,maxLength:e.text_maxLength,rows:e.text_rows,mask:e.text_mask,regex:e.text_regex,textDefaultValue:e.text_defaultValue,min:e.number_min,max:e.number_max,step:e.number_step,decimals:e.number_decimals,prefix:e.number_prefix,suffix:e.number_suffix,unit:e.number_unit,numberDefaultValue:e.number_defaultValue,format:e.date_format,showTime:e.date_showTime,dateDefaultValue:e.date_defaultValue,minDate:e.date_minDate,maxDate:e.date_maxDate,multiple:e.select_multiple,searchable:e.select_searchable,allowClear:e.select_allowClear,selectDefaultValue:e.select_defaultValue,trueLabel:e.bool_trueLabel,falseLabel:e.bool_falseLabel,boolDefaultValue:e.bool_defaultValue},capabilities:{data:{enabled:!!e.data_instances&&Object.keys(e.data_instances||{}).length>0,activeId:e.data_activeId,instances:e.data_instances},formula:{enabled:!!e.formula_instances&&Object.keys(e.formula_instances||{}).length>0,activeId:e.formula_activeId,instances:e.formula_instances,currentFormula:l(e.formula_instances,e.formula_activeId)},condition:{enabled:!!e.condition_instances&&Object.keys(e.condition_instances||{}).length>0,activeId:e.condition_activeId,instances:e.condition_instances,currentConditions:l(e.condition_instances,e.condition_activeId)},table:{enabled:!!e.table_instances&&Object.keys(e.table_instances||{}).length>0,activeId:e.table_activeId,instances:e.table_instances,currentTable:l(e.table_instances,e.table_activeId)},api:{enabled:!!e.api_instances&&Object.keys(e.api_instances||{}).length>0,activeId:e.api_activeId,instances:e.api_instances,currentAPI:l(e.api_instances,e.api_activeId)},link:{enabled:!!e.link_instances&&Object.keys(e.link_instances||{}).length>0,activeId:e.link_activeId,instances:e.link_instances,currentLinks:l(e.link_instances,e.link_activeId)},markers:{enabled:!!e.markers_instances&&Object.keys(e.markers_instances||{}).length>0,activeId:e.markers_activeId,instances:e.markers_instances,currentMarkers:l(e.markers_instances,e.markers_activeId)}}})})}const s=t.get(e.id);return s&&s.length>0&&(Oe()&&se(`  ðŸ”— Toujours inclure les ${s.length} rÃ©fÃ©rences partagÃ©es pour l'option "${e.label}" pour un rendu dynamique.`),s.forEach(e=>{const n=r.get(e);if(n){Oe()&&se(`    âž• Ajout rÃ©fÃ©rence partagÃ©e: "${n.label}"`);const e=n.subType||n.fieldType||n.type||"TEXT";i.push({id:n.id,name:n.label,label:n.label,type:e,required:n.isRequired,visible:n.isVisible,placeholder:n.text_placeholder,description:n.description,order:n.order||9999,sharedReferenceName:n.label,config:{size:n.appearance_size,width:n.appearance_width,variant:n.appearance_variant,minLength:n.text_minLength,maxLength:n.text_maxLength,rows:n.text_rows,mask:n.text_mask,regex:n.text_regex,textDefaultValue:n.text_defaultValue,min:n.number_min,max:n.number_max,step:n.number_step,decimals:n.number_decimals,prefix:n.number_prefix,suffix:n.number_suffix,unit:n.number_unit,numberDefaultValue:n.number_defaultValue,format:n.date_format,showTime:n.date_showTime,dateDefaultValue:n.date_defaultValue,minDate:n.date_minDate,maxDate:n.date_maxDate,multiple:n.select_multiple,searchable:n.select_searchable,allowClear:n.select_allowClear,selectDefaultValue:n.select_defaultValue,trueLabel:n.bool_trueLabel,falseLabel:n.bool_falseLabel,boolDefaultValue:n.bool_defaultValue},capabilities:{data:{enabled:!!n.data_instances&&Object.keys(n.data_instances||{}).length>0,activeId:n.data_activeId,instances:n.data_instances},formula:{enabled:!!n.formula_instances&&Object.keys(n.formula_instances||{}).length>0,activeId:n.formula_activeId,instances:n.formula_instances,currentFormula:l(n.formula_instances,n.formula_activeId)},condition:{enabled:!!n.condition_instances&&Object.keys(n.condition_instances||{}).length>0,activeId:n.condition_activeId,instances:n.condition_instances,currentConditions:l(n.condition_instances,n.condition_activeId)},table:{enabled:!!n.table_instances&&Object.keys(n.table_instances||{}).length>0,activeId:n.table_activeId,instances:n.table_instances,currentTable:l(n.table_instances,n.table_activeId)},api:{enabled:!!n.api_instances&&Object.keys(n.api_instances||{}).length>0,activeId:n.api_activeId,instances:n.api_instances,currentAPI:l(n.api_instances,n.api_activeId)},link:{enabled:!!n.link_instances&&Object.keys(n.link_instances||{}).length>0,activeId:n.link_activeId,instances:n.link_instances,currentLinks:l(n.link_instances,n.link_activeId)},markers:{enabled:!!n.markers_instances&&Object.keys(n.markers_instances||{}).length>0,activeId:n.markers_activeId,instances:n.markers_instances,currentMarkers:l(n.markers_instances,n.markers_activeId)}}})}else Oe()&&se(`    âš ï¸ RÃ©fÃ©rence partagÃ©e "${e}" introuvable`)})),Oe()&&se(`  ðŸ“Š Total champs conditionnels pour "${e.label}": ${i.length}`),{id:e.id,label:e.option_label||e.label,value:e.value||e.option_label||e.label,conditionalFields:i.length>0?i:void 0,hasData:e.hasData,hasFormula:e.hasFormula,hasCondition:e.hasCondition,hasTable:e.hasTable,hasAPI:e.hasAPI,hasLink:e.hasLink,capabilities:null==(a=e.metadata)?void 0:a.capabilities,metadata:e.metadata}});return{id:e.id,name:e.label,label:e.label,type:"select",required:e.isRequired,visible:e.isVisible,description:e.description,order:e.order,isSelect:!0,text_helpTooltipType:e.text_helpTooltipType,text_helpTooltipText:e.text_helpTooltipText,text_helpTooltipImage:e.text_helpTooltipImage,appearanceConfig:{...e.appearanceConfig||{},helpTooltipType:e.text_helpTooltipType,helpTooltipText:e.text_helpTooltipText,helpTooltipImage:e.text_helpTooltipImage},options:a,config:{size:e.appearance_size,width:e.appearance_width,variant:e.appearance_variant,multiple:e.select_multiple||e.isMultiple,searchable:e.select_searchable,allowClear:e.select_allowClear,selectDefaultValue:e.select_defaultValue},capabilities:c}}if("leaf_repeater"===e.type){Oe()&&se(`ðŸ” [REPEATER] Transformation rÃ©pÃ©table: "${e.label}"`);let n=e.repeater_templateNodeIds||[];if(!Array.isArray(n))if("string"==typeof n)try{n=JSON.parse(n)}catch(u){n=[]}else n=[];if(0===n.length&&e.metadata&&"object"==typeof e.metadata){const r=e.metadata.repeater;(null==r?void 0:r.templateNodeIds)&&Array.isArray(r.templateNodeIds)&&(n=r.templateNodeIds)}let t=e.repeater_templateNodeLabels||null;if("string"==typeof t)try{t=JSON.parse(t)}catch(u){t=null}if(!t&&e.metadata&&"object"==typeof e.metadata){const n=e.metadata.repeater;(null==n?void 0:n.templateNodeLabels)&&"object"==typeof n.templateNodeLabels&&(t=n.templateNodeLabels)}if(Array.isArray(t)){const e=t;t=n.reduce((n,r,t)=>{const a=null==e?void 0:e[t];return"string"==typeof a&&a.trim().length>0&&(n[r]=a),n},{})}if((!t||0===Object.keys(t).length)&&n.length>0){const e={},a=e=>{const n=r.get(e)||s.find(n=>n.id===e);if(!n)return;const t="object"==typeof n.metadata?n.metadata:void 0,a=t?t.originalLabel??t.label??t.displayName:void 0,i="string"==typeof a?a:void 0;return n.label||n.field_label||n.option_label||i};n.forEach(n=>{const r=a(n);r&&(e[n]=r)}),Object.keys(e).length>0&&(t=e)}const a={templateNodeIds:n,templateNodeLabels:t,minItems:e.repeater_minItems||0,maxItems:e.repeater_maxItems||null,addButtonLabel:e.repeater_addButtonLabel||null,buttonSize:e.repeater_buttonSize||"middle",buttonWidth:e.repeater_buttonWidth||"auto",iconOnly:e.repeater_iconOnly||!1};return Oe()&&se("ðŸ” [REPEATER] Metadata:",a),{id:e.id,name:e.label,label:e.label,type:"leaf_repeater",required:e.isRequired,visible:e.isVisible,description:e.description,order:e.order,appearanceConfig:{...e.appearanceConfig||{},helpTooltipType:e.text_helpTooltipType,helpTooltipText:e.text_helpTooltipText,helpTooltipImage:e.text_helpTooltipImage},metadata:{repeater:a},capabilities:c}}if(e.type.includes("leaf_field")){const n=e.subType||e.fieldType||e.type||"text";return se(`ðŸ” [TYPE DETECTION SIMPLE] ${e.label}`,{fieldType:e.fieldType,subType:e.subType,type:e.type,final:n}),{id:e.id,name:e.label,label:e.label,type:n,required:e.isRequired,value:e.defaultValue||e.value||e.bool_defaultValue||e.text_defaultValue||e.number_defaultValue||e.select_defaultValue||e.date_defaultValue,visible:e.isVisible,placeholder:e.text_placeholder,description:e.description,order:e.order,needsValueResolution:e.hasData,text_helpTooltipType:e.text_helpTooltipType,text_helpTooltipText:e.text_helpTooltipText,text_helpTooltipImage:e.text_helpTooltipImage,appearanceConfig:{...e.appearanceConfig||{},helpTooltipType:e.text_helpTooltipType,helpTooltipText:e.text_helpTooltipText,helpTooltipImage:e.text_helpTooltipImage},config:{size:e.appearance_size,width:e.appearance_width,variant:e.appearance_variant,minLength:e.text_minLength,maxLength:e.text_maxLength,rows:e.text_rows,mask:e.text_mask,regex:e.text_regex,textDefaultValue:e.text_defaultValue,min:e.number_min,max:e.number_max,step:e.number_step,decimals:e.number_decimals,prefix:e.number_prefix,suffix:e.number_suffix,unit:e.number_unit,numberDefaultValue:e.number_defaultValue,format:e.date_format,showTime:e.date_showTime,dateDefaultValue:e.date_defaultValue,minDate:e.date_minDate,maxDate:e.date_maxDate,multiple:e.select_multiple,searchable:e.select_searchable,allowClear:e.select_allowClear,selectDefaultValue:e.select_defaultValue,trueLabel:e.bool_trueLabel,falseLabel:e.bool_falseLabel,boolDefaultValue:e.bool_defaultValue,maxSize:e.image_maxSize,ratio:e.image_ratio,crop:e.image_crop,thumbnails:e.image_thumbnails},capabilities:c}}const m=e.subType||e.fieldType||e.type||"text";return se(`ðŸ” [TYPE DETECTION FALLBACK] ${e.label}`,{fieldType:e.fieldType,subType:e.subType,type:e.type,final:m}),{id:e.id,name:e.label,label:e.label,type:m,required:e.isRequired,visible:e.isVisible,order:e.order,capabilities:c}},Ue=(e,n)=>{Oe()&&se("ðŸŒ³ [TBL-PRISMA] DÃ©but transformation DYNAMIQUE:",{nodesCount:e.length});const r=new Map,t=new Map;e.forEach(e=>{r.set(e.id,e);const n=e.parentId||"root";t.has(n)||t.set(n,[]),t.get(n).push(e)});const a=new Map;e.forEach(e=>{const n=[];Array.isArray(e.sharedReferenceIds)&&n.push(...e.sharedReferenceIds);const r=e.sharedReferenceId;if("string"==typeof r&&r.trim().length>0&&n.push(r),n.length>0){if("leaf_option"===e.type||"leaf_option_field"===e.type){const r=Array.from(new Set(n));a.set(e.id,r),Oe()&&se(`ðŸ”— [TBL-PRISMA] Option "${e.label}" stockÃ©e avec ${r.length} rÃ©fÃ©rences partagÃ©es (single/array)`)}}});const i=t.get("root")||[],s=i.filter(e=>!e.isSharedReference);if(Oe()){const e=i.length-s.length;e>0&&se(`ðŸš« [TBL-PRISMA] ${e} rÃ©fÃ©rences partagÃ©es EXCLUES des onglets:`,i.filter(e=>e.isSharedReference).map(e=>e.label)),se("ðŸ” [TBL-PRISMA] Onglets (Niveau 1):",s.length,s.map(e=>`${e.label} (order: ${e.order})`))}const o=new Set,l=new Map,c=(e,n=2)=>{var i;const s=t.get(e)||[],d=[];return Oe()&&se(`  ðŸŒ¿ Niveau ${n} - NÅ“ud "${null==(i=r.get(e))?void 0:i.label}": ${s.length} enfants`),s.sort((e,n)=>e.order-n.order).forEach(e=>{var i,s,m,u;if(Oe()&&se(`    ðŸ“ Traitement: "${e.label}" (type: ${e.type}, order: ${e.order})`),o.has(e.id))Oe()&&se(`      ðŸš« DOUBLON Ã‰VITÃ‰: "${e.label}" dÃ©jÃ  traitÃ©`);else if("section"===e.type){Oe()&&se(`      ðŸ“¦ Section dÃ©tectÃ©e: "${e.label}" - traitement des champs de la section`);const r=c(e.id,n+1);l.set(e.id,{node:e,fields:r}),Oe()&&se(`      âœ… Section "${e.label}" crÃ©Ã©e avec ${r.length} champs`),d.push(...r),o.add(e.id)}else if("branch"===e.type||!e.type.includes("leaf")&&"root"!==e.type){if((t.get(e.id)||[]).some(e=>"leaf_option"===e.type||"leaf_option_field"===e.type)){const n=je(e,t,r,a);d.push(n),Oe()&&se(`      âœ… Liste dÃ©roulante: "${n.label}" avec ${(null==(i=n.options)?void 0:i.length)||0} options`)}else Oe()&&se(`      ðŸ”„ Branche conteneur: "${e.label}" - traitement des enfants`);const s=c(e.id,n+1);d.push(...s)}else if(e.type.includes("leaf_field")){const i=je(e,t,r,a);d.push(i),o.add(e.id),Oe()&&se(`      ðŸƒ Champ simple: "${i.label}" (${i.type})`);const s=t.get(e.id)||[];if(s.length>0){Oe()&&se(`        ðŸ”— LIENS depuis champ "${e.label}": ${s.length} Ã©lÃ©ments`);const r=c(e.id,n+1);d.push(...r)}}else if("leaf_repeater"===e.type){const n=je(e,t,r,a);d.push(n),o.add(e.id),Oe()&&se(`      ðŸ” RÃ©pÃ©table: "${n.label}" avec metadata.repeater:`,null==(s=n.metadata)?void 0:s.repeater);const i=t.get(e.id)||[],l=(null==(u=null==(m=n.metadata)?void 0:m.repeater)?void 0:u.templateNodeIds)||[],c=i.filter(e=>l.includes(e.id)),p=i.filter(e=>{const n=e.metadata;return(null==n?void 0:n.sourceTemplateId)&&l.includes(n.sourceTemplateId)});if(Oe()&&se(`        ï¿½ Templates: ${c.length}, ðŸ“‹ Copies rÃ©elles: ${p.length}`),c.forEach(e=>{o.add(e.id)}),p.forEach((n,i)=>{var s,l;const c=je(n,t,r,a);c.isDeletableCopy=!0,c.parentRepeaterId=e.id,c.sourceTemplateId=null==(s=n.metadata)?void 0:s.sourceTemplateId,c.isLastInCopyGroup=i===p.length-1,c.canAddNewCopy=c.isLastInCopyGroup,d.push(c),o.add(n.id),Oe()&&se(`        ðŸ“‹ Copie ajoutÃ©e: "${c.label}" (sourceTemplate: ${null==(l=n.metadata)?void 0:l.sourceTemplateId}) ${c.isLastInCopyGroup?"âž•":""}`)}),0===p.length&&c.length>0){const n=c[0],i=je(n,t,r,a);i.canAddNewCopy=!0,i.isLastInCopyGroup=!0,i.parentRepeaterId=e.id,d.push(i),o.add(n.id),Oe()&&se(`        ðŸ“ Template original avec bouton +: "${i.label}"`)}}else if("leaf_option"===e.type||"leaf_option_field"===e.type){Oe()&&se(`      âš ï¸ Option "${e.label}" dÃ©jÃ  traitÃ©e dans liste dÃ©roulante`),o.add(e.id);const r=t.get(e.id)||[];if(r.length>0){Oe()&&se(`        ðŸ”— LIENS depuis option "${e.label}": ${r.length} Ã©lÃ©ments`),r.forEach(e=>{o.add(e.id)});const t=c(e.id,n+1);d.push(...t)}}}),d},d=[],m={},u={};s.sort((e,n)=>e.order-n.order).forEach(e=>{Oe()&&se(`ðŸ“‘ [TBL-PRISMA] === ONGLET: "${e.label}" ===`);const n=c(e.id,2).sort((e,n)=>e.order-n.order),t=[],a=Array.from(l.entries()).filter(([n])=>{const t=r.get(n);return(null==t?void 0:t.parentId)===e.id});if(a.length>0){a.forEach(([e,n],r)=>{const a=n.fields.filter(e=>{const n=e.metadata||{},r=!!(null==n?void 0:n.sourceTemplateId);return!r});t.push({id:`${e}-section`,name:n.node.label,title:n.node.label,description:n.node.description||void 0,fields:a,order:r,isDataSection:!0}),se(`ðŸŽ¯ [TBL] Section TreeBranchLeaf crÃ©Ã©e: "${n.node.label}" -> isDataSection: true (${a.length} champs)`)});const r=a.flatMap(([,e])=>e.fields.map(e=>e.id)),i=n.filter(e=>!r.includes(e.id)).filter(e=>{const n=e.metadata||{},r=!!(null==n?void 0:n.sourceTemplateId);return!r});i.length>0&&t.push({id:`${e.id}-section`,name:e.label,title:e.label,description:e.description||void 0,fields:i,order:a.length})}else{const r=n.filter(e=>{const n=e.metadata||{},r=!!(null==n?void 0:n.sourceTemplateId);return!r});t.push({id:`${e.id}-section`,name:e.label,title:e.label,description:e.description||void 0,fields:r,order:0})}const i={id:e.id,name:e.label,label:e.label,order:e.order,sections:t,allFields:a.length>0?t.flatMap(e=>e.fields):n};d.push(i),m[i.id]=i.allFields,u[i.id]=t,Oe()&&se(`âœ… [TBL-PRISMA] Onglet "${i.label}" crÃ©Ã©: ${n.length} champs dynamiques`)});const p=e.find(e=>null===e.parentId&&"root"===e.type)||e[0],f={id:(null==p?void 0:p.treeId)||"unknown",name:(null==p?void 0:p.label)||(null==p?void 0:p.value)||"Formulaire",tabs:d.sort((e,n)=>e.order-n.order)},h=Object.values(m).flat().length;return Oe()&&se("âœ… [TBL-PRISMA] Transformation DYNAMIQUE terminÃ©e:",{tabs:d.length,totalFields:h,totalSections:Object.values(u).flat().length}),{tree:f,tabs:d,fieldsByTab:m,sectionsByTab:u}},Fe=({tree_id:e,disabled:n=!1})=>{const{api:t}=i(),[a,s]=r.useState(null),[o,l]=r.useState([]),[c,d]=r.useState({}),[m,u]=r.useState({}),[p,f]=r.useState(!0),[h,b]=r.useState(null),[v,T]=r.useState([]),N=r.useRef([]);r.useEffect(()=>{N.current=v},[v]);const D=r.useCallback(async()=>{if(!n)try{f(!0),b(null),Oe()&&se("ðŸ“¡ [TBL-PRISMA] RÃ©cupÃ©ration donnÃ©es:",{tree_id:e});const n=await t.get(`/api/treebranchleaf/trees/${e}/nodes`);if(n&&Array.isArray(n)){T(n);"undefined"!=typeof window&&window.TBL_FORM_DATA;const r=Ue(n);Oe()&&se("ðŸ”„ [TBL-PRISMA] Phase 2: RÃ©solution des valeurs dynamiques...");const a={};for(const[s,l]of Object.entries(r.fieldsByTab)){const r=await Promise.all(l.map(async r=>{var a,i;if(r.needsValueResolution)try{Oe()&&se(`ðŸ” [TBL-PRISMA] RÃ©solution valeur pour "${r.label}"`);const s=n.find(e=>e.id===r.id);if(s){const{value:n,variableConfig:o}=await Me(s,t,e);let l=r.capabilities;const c=s.id;if(o&&(l={...r.capabilities||{},data:{enabled:!0,activeId:c,instances:{...(null==(i=null==(a=r.capabilities)?void 0:a.data)?void 0:i.instances)||{},[c]:{metadata:{...o}}}}}),null!==n)return Oe()&&se(`âœ… [TBL-PRISMA] Valeur rÃ©solue pour "${r.label}": ${n}`),{...r,value:n,capabilities:l};if(o)return Oe()&&se(`â„¹ï¸ [TBL-PRISMA] Valeur non calculÃ©e pour "${r.label}", Ã©valuation dÃ©lÃ©guÃ©e au rendu via sourceRef`),{...r,capabilities:l}}}catch(s){}return r}));a[s]=r}const i={};for(const[e,n]of Object.entries(r.sectionsByTab)){const r=n.map(n=>{var r;return{...n,fields:(null==(r=a[e])?void 0:r.filter(e=>n.fields.some(n=>n.id===e.id)))||n.fields}});i[e]=r}const o=r.tabs.map(e=>({...e,allFields:a[e.id]||e.allFields,sections:i[e.id]||e.sections}));Oe()&&se("âœ… [TBL-PRISMA] RÃ©solution des valeurs terminÃ©e"),((e,n)=>{try{"undefined"!=typeof window&&window.TBL_FORM_DATA||"undefined"!=typeof window&&(window.TBL_FORM_DATA={});let r=0;e.forEach(e=>{var n;null==(n=e.sections)||n.forEach(e=>{e.isDataSection&&e.fields&&e.fields.forEach(e=>{const n=`__mirror_data_${e.label}`;if("undefined"!=typeof window&&window.TBL_FORM_DATA&&!(n in window.TBL_FORM_DATA)){let a=null;"number"===e.type?a=0:"boolean"===e.type?a=!1:"text"===e.type&&(a=""),window.TBL_FORM_DATA[n]=a,r++;try{Ve(e.label).map(e=>e.replace(/^__mirror_data_/,"")).forEach(e=>{const n=`__mirror_data_${e}`;n in window.TBL_FORM_DATA||(window.TBL_FORM_DATA[n]=a)})}catch(t){}}})})}),n.forEach(e=>{if(e.hasFormula&&e.label){const t=`__mirror_formula_${e.id}`,a=`__mirror_formula_${e.label}`;if("undefined"!=typeof window&&window.TBL_FORM_DATA){if(!(t in window.TBL_FORM_DATA)){const e=0;window.TBL_FORM_DATA[t]=e,r++}if(!(a in window.TBL_FORM_DATA)){const t=0;window.TBL_FORM_DATA[a]=t,r++;try{Ve(e.label).forEach(e=>{if(e!==a){const n=e.replace("__mirror_data_","__mirror_formula_");n in window.TBL_FORM_DATA||(window.TBL_FORM_DATA[n]=t,r++)}})}catch(n){}}}}}),n.forEach(e=>{if(e.hasCondition&&e.label){const t=`__mirror_condition_${e.id}`,a=`__mirror_condition_${e.label}`;if("undefined"!=typeof window&&window.TBL_FORM_DATA){if(!(t in window.TBL_FORM_DATA)){const e=!1;window.TBL_FORM_DATA[t]=e,r++}if(!(a in window.TBL_FORM_DATA)){const t=!1;window.TBL_FORM_DATA[a]=t,r++;try{Ve(e.label).forEach(e=>{if(e!==a){const n=e.replace("__mirror_data_","__mirror_condition_");n in window.TBL_FORM_DATA||(window.TBL_FORM_DATA[n]=t,r++)}})}catch(n){}}}}})}catch(h){}})(o,n),s({...r.tree,tabs:o}),l(o),d(a),u(i)}else b("Format de donnÃ©es invalide")}catch(r){b(r instanceof Error?r.message:"Erreur inconnue")}finally{f(!1)}},[t,e,n]);r.useEffect(()=>{n?f(!1):D()},[D,n]);const L=r.useCallback(async()=>{const n=N.current;if(n&&0!==n.length)try{"undefined"!=typeof window&&window.TBL_FORM_DATA;const r=Ue(n),a={};for(const[s,l]of Object.entries(r.fieldsByTab)){const r=await Promise.all(l.map(async r=>{var a,i;if(r.needsValueResolution)try{const s=n.find(e=>e.id===r.id);if(s){const{value:n,variableConfig:o}=await Me(s,t,e);let l=r.capabilities;const c=s.id;if(o&&(l={...r.capabilities||{},data:{enabled:!0,activeId:c,instances:{...(null==(i=null==(a=r.capabilities)?void 0:a.data)?void 0:i.instances)||{},[c]:{metadata:{...o}}}}}),null!==n)return{...r,value:n,capabilities:l};if(o)return{...r,capabilities:l}}}catch(s){}return r}));a[s]=r}const i={};for(const[e,n]of Object.entries(r.sectionsByTab)){const r=n.map(n=>{var r;return{...n,fields:(null==(r=a[e])?void 0:r.filter(e=>n.fields.some(n=>n.id===e.id)))||n.fields}});i[e]=r}const o=r.tabs.map(e=>({...e,allFields:a[e.id]||e.allFields,sections:i[e.id]||e.sections}));s({...r.tree,tabs:o}),l(o),d(a),u(i)}catch(r){}},[t,e]);r.useEffect(()=>{const e=()=>{n||0!==N.current.length&&L()};return window.addEventListener("TBL_FORM_DATA_CHANGED",e),()=>{window.removeEventListener("TBL_FORM_DATA_CHANGED",e)}},[n,e,L]),r.useEffect(()=>{const r=r=>{const t=r,{treeId:a}=t.detail;!n&&a&&String(a)===String(e)&&D()};return window.addEventListener("tbl-capability-updated",r),()=>window.removeEventListener("tbl-capability-updated",r)},[D,n,e]),r.useEffect(()=>{const r=r=>{const t=r,{treeId:a,nodeId:i,source:s,timestamp:o}=t.detail;!n&&a&&String(a)===String(e)&&D()};return window.addEventListener("tbl-repeater-updated",r),()=>{window.removeEventListener("tbl-repeater-updated",r)}},[D,n,e]);return{tree:a,tabs:o,fieldsByTab:c,sectionsByTab:m,loading:p,error:h,refetch:r.useCallback(()=>D(),[D]),rawNodes:v}},$e=(...e)=>{try{localStorage.getItem("TBL_DIAG")}catch{}};function ze(e){const{treeId:n,enabled:t=!0,includeRaw:a=!1,extractDependencies:s=!0,refetchIntervalMs:o}=e,{api:l}=i(),[c,d]=r.useState(!1),[m,u]=r.useState(null),[p,f]=r.useState([]),[h,b]=r.useState(),v=r.useRef(null),T=r.useMemo(()=>async()=>{var e;if(n&&t){d(!0),u(null);try{const r=new URLSearchParams;r.set("treeId",n),a&&r.set("raw","1"),s&&r.set("deps","1");const t=await l.get(`/tbl/capabilities?${r.toString()}`),i=(null==t?void 0:t.data)||t;$e(null==i||i.count),f((null==i?void 0:i.capabilities)||[]),b(null==(e=null==i?void 0:i.meta)?void 0:e.extractedAt)}catch(r){const e=r instanceof Error?r.message:"Erreur inconnue";u(e),$e()}finally{d(!1)}}},[l,n,t,a,s]);r.useEffect(()=>{T()},[T]),r.useEffect(()=>{if(o&&t)return v.current&&window.clearInterval(v.current),v.current=window.setInterval(()=>{T()},o),()=>{v.current&&window.clearInterval(v.current)}},[o,T,t]);const N=r.useMemo(()=>{const e=new Map;for(const n of p)e.set(n.nodeId,n);return e},[p]),{dependencyGraph:D,reverseGraph:L}=r.useMemo(()=>{const e=new Map,n=new Map;for(const r of p){const t=r.dependencies||[];n.has(r.nodeId)||n.set(r.nodeId,new Set);for(const a of t){const t=a.trim();t&&(e.has(t)||e.set(t,new Set),e.get(t).add(r.nodeId),n.get(r.nodeId).add(t))}}return{dependencyGraph:e,reverseGraph:n}},[p]);return{loading:c,error:m,capabilities:p,byNodeId:N,dependencyGraph:D,reverseGraph:L,refetch:T,lastUpdated:h}}const qe={branch:"ðŸ“‚",leaf_field:"ðŸ“",leaf_option:"ðŸ”§",leaf_option_field:"ðŸ§©"},Pe=(...e)=>{(()=>{try{return"1"===localStorage.getItem("TBL_DIAG")}catch{return!1}})()};function We(e){var n,r;if(e.metadata&&"object"==typeof e.metadata){const r=null==(n=e.metadata)?void 0:n.icon;if("string"==typeof r&&r.trim())return r.trim()}if(e.fieldConfig&&"object"==typeof e.fieldConfig){const n=null==(r=e.fieldConfig)?void 0:r.icon;if("string"==typeof n&&n.trim())return n.trim()}return qe[e.type]?qe[e.type]:"ðŸ“‹"}function Ge(e,n,r){var t,a,i;let s="text";if(e.fieldConfig&&"object"==typeof e.fieldConfig){const n=e.fieldConfig.type;"string"==typeof n&&(s=n)}else e.fieldType&&(s=e.fieldType);let o,l=e.value??void 0;if("number"===s&&"string"==typeof e.value){const n=parseFloat(e.value);l=isNaN(n)?void 0:n}else"boolean"===s&&"string"==typeof e.value?l=["true","1","yes"].includes(e.value.toLowerCase()):"select"===s&&e.fieldConfig&&Array.isArray(e.fieldConfig.options)&&(o=e.fieldConfig.options);const c={id:e.id,name:e.label,label:e.label,type:s,required:!!e.isRequired,value:l,options:o,visible:!1!==e.isVisible,placeholder:`Saisir ${e.label}`,description:e.description??void 0,validation:void 0,order:e.order||0,parentId:e.parentId||void 0,shouldDisplay:!1!==e.isActive,config:e.fieldConfig||void 0,treeMetadata:e.metadata||void 0,text_helpTooltipType:e.text_helpTooltipType,text_helpTooltipText:e.text_helpTooltipText,text_helpTooltipImage:e.text_helpTooltipImage,appearanceConfig:{...e.appearanceConfig||{},helpTooltipType:e.text_helpTooltipType,helpTooltipText:e.text_helpTooltipText,helpTooltipImage:e.text_helpTooltipImage}};try{if(r){const e=r,n={};"formula"===e.capacity&&(n.formula={activeId:null==(t=e.sourceRef)?void 0:t.replace("formula:",""),currentFormula:{expression:e.sourceRef}}),"condition"===e.capacity&&(n.condition={activeId:null==(a=e.sourceRef)?void 0:a.replace("condition:","")}),"table"===e.capacity&&(n.table={activeId:null==(i=e.sourceRef)?void 0:i.replace("table:","")}),"fixed"===e.capacity&&(n.data={enabled:!0,fixedValue:e.fixedValue}),"data"!==e.capacity&&"unknown"!==e.capacity||(e.sourceRef||e.fixedValue)&&(n.data={enabled:!0,activeId:e.sourceRef,instances:e.sourceRef?{[e.sourceRef]:{metadata:{sourceType:e.sourceType,sourceRef:e.sourceRef,fixedValue:e.fixedValue}}}:void 0}),Object.keys(n).length&&(c.capabilities=n),Pe((c.id,e.capacity,e.sourceRef))}else{const n=e.metadata||{},r=e.fieldConfig||{},t=n.sourceType||r.sourceType,a=n.sourceRef||r.sourceRef,i=n.fixedValue||r.fixedValue,s="string"==typeof a&&a.startsWith("formula:"),o="string"==typeof a&&a.startsWith("condition:"),l="string"==typeof a&&(a.startsWith("variable:")||"tree"===t),d={};(a||void 0!==i)&&(d.data||(d.data={}),d.data.enabled=!0,d.data.activeId=a||void 0,d.data.instances=a?{[a]:{metadata:{sourceType:t||(l?"tree":"fixed"),sourceRef:a,fixedValue:i}}}:{}),s&&(d.formula={activeId:null==a?void 0:a.replace("formula:",""),currentFormula:{expression:a}}),o&&(d.condition={activeId:null==a?void 0:a.replace("condition:","")}),Object.keys(d).length>0&&(c.capabilities=d),Pe(c.id)}}catch{}if("leaf_option_field"===e.type&&e.parentId){const r=n.get(e.parentId);r&&"leaf_option"===r.type&&(c.shouldDisplay=r.value===e.label)}try{const r=e.metadata||{},t=r.dependsOn,a=r.operator||"equals",i=r.value??r.showWhen;if(t){const e=n.get(t)||Array.from(n.values()).find(e=>e.label===t),r=null==e?void 0:e.value;let s=!0;switch(a){case"equals":s=r===i;break;case"not_equals":s=r!==i;break;case"contains":s="string"==typeof r&&String(r).includes(String(i));break;case"exists":s=null!=r&&""!==r;break;default:s=!0}s||(c.shouldDisplay=!1)}}catch{}return c}function He(e){return e.startsWith("formula:")?"formula":e.startsWith("variable:")?"variable":e.startsWith("condition:")?"condition":e.startsWith("table:")?"table":"ref"}const Je={formula:"purple",variable:"blue",condition:"orange",table:"gold",ref:"default"},Xe=({preload:n,collapsed:a})=>{const[i,s]=t.useState(""),l=n.capabilities,d=r.useMemo(()=>{if(!i.trim())return l;const e=i.toLowerCase();return l.filter(n=>n.nodeId.toLowerCase().includes(e)||(n.sourceRef||"").toLowerCase().includes(e))},[l,i]),m=r.useMemo(()=>d.map(e=>{const r=Array.from(n.reverseGraph.get(e.nodeId)||[]),t=[];return n.dependencyGraph.forEach((n,r)=>{n.has(e.nodeId)&&t.push(r)}),{cap:e,deps:r,dependants:t}}),[d,n.reverseGraph,n.dependencyGraph]);return e.jsxDEV(o,{size:"small",style:{maxHeight:a?120:600,overflow:"auto",fontSize:12},title:`TBL Capabilities (${l.length})`,extra:e.jsxDEV(y,{size:"small",placeholder:"filtre...",value:i,onChange:e=>s(e.target.value),allowClear:!0},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:49,columnNumber:14},void 0),children:m.map(n=>e.jsxDEV("div",{style:{borderBottom:"1px solid #eee",padding:"4px 0"},children:[e.jsxDEV("div",{style:{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"},children:[e.jsxDEV(c.Text,{code:!0,children:n.cap.nodeId},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:54,columnNumber:13},void 0),e.jsxDEV(C,{color:Je[n.cap.capacity]||"default",children:n.cap.capacity},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:55,columnNumber:13},void 0),n.cap.sourceRef&&e.jsxDEV(C,{children:n.cap.sourceRef},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:56,columnNumber:33},void 0),n.cap.fixedValue&&e.jsxDEV(C,{color:"green",children:"fixed"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:57,columnNumber:34},void 0),n.deps.length>0&&e.jsxDEV(B,{title:n.deps.join(", "),children:e.jsxDEV(C,{color:"geekblue",children:["deps:",n.deps.length]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:60,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:59,columnNumber:15},void 0),n.dependants.length>0&&e.jsxDEV(B,{title:n.dependants.join(", "),children:e.jsxDEV(C,{color:"volcano",children:["usedBy:",n.dependants.length]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:65,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:64,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:53,columnNumber:11},void 0),!a&&n.deps.length>0&&e.jsxDEV("div",{style:{marginLeft:8,fontSize:11},children:["â†’ deps: ",n.deps.map(n=>e.jsxDEV(C,{color:Je[He(n)],children:n},n,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:71,columnNumber:40},void 0))]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:70,columnNumber:13},void 0),!a&&n.dependants.length>0&&e.jsxDEV("div",{style:{marginLeft:8,fontSize:11},children:["â† usedBy: ",n.dependants.map(n=>e.jsxDEV(C,{color:Je[He(n)],children:n},n,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:76,columnNumber:48},void 0))]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:75,columnNumber:13},void 0)]},n.cap.nodeId,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:52,columnNumber:9},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/components/Dev/TBLDevCapabilitiesPanel.tsx",lineNumber:48,columnNumber:5},void 0)},{Text:Ye}=c,{Search:Ke}=y,Qe=({open:n,onClose:t,onSelectLead:a,currentLeadId:o})=>{const[c,u]=r.useState([]),[p,f]=r.useState([]),[h,b]=r.useState(!1),[T,N]=r.useState(null),[L,x]=r.useState(""),{api:B}=i();r.useEffect(()=>{n&&E()},[n]),r.useEffect(()=>{if(L.trim()){const e=c.filter(e=>e.name.toLowerCase().includes(L.toLowerCase())||e.email&&e.email.toLowerCase().includes(L.toLowerCase())||e.company&&e.company.toLowerCase().includes(L.toLowerCase())||e.phone&&e.phone.includes(L));f(e)}else f(c)},[c,L]);const E=async()=>{try{b(!0),N(null);const e=await B.get("/api/leads");if(!e.success||!Array.isArray(e.data))throw new Error(e.error||"Erreur lors du chargement des leads");{const n=e.data.map(e=>({id:e.id,name:e.name||`${e.firstName||""} ${e.lastName||""}`.trim()||"Lead sans nom",email:e.email,phone:e.phone,company:e.company,hasSubmission:!1,lastModified:e.updatedAt?new Date(e.updatedAt):void 0}));u(n)}}catch(e){const n=e.message||"Erreur lors du chargement des leads";N(n),H.error(n)}finally{b(!1)}},g=[{title:"Nom",dataIndex:"name",key:"name",render:(n,r)=>e.jsxDEV(s,{children:[e.jsxDEV(l,{style:{color:"#1890ff"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:114,columnNumber:11},void 0),e.jsxDEV("div",{children:[e.jsxDEV(Ye,{strong:!0,children:n},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:116,columnNumber:13},void 0),r.hasSubmission&&e.jsxDEV(C,{color:"green",size:"small",style:{marginLeft:8},children:[e.jsxDEV(Q,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:119,columnNumber:17},void 0)," Devis"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:118,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:115,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:113,columnNumber:9},void 0)},{title:"Contact",key:"contact",render:n=>e.jsxDEV("div",{children:[n.email&&e.jsxDEV("div",{children:[e.jsxDEV(d,{style:{marginRight:4,color:"#8c8c8c"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:133,columnNumber:15},void 0),e.jsxDEV(Ye,{type:"secondary",style:{fontSize:"12px"},children:n.email},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:134,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:132,columnNumber:13},void 0),n.phone&&e.jsxDEV("div",{children:[e.jsxDEV(m,{style:{marginRight:4,color:"#8c8c8c"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:139,columnNumber:15},void 0),e.jsxDEV(Ye,{type:"secondary",style:{fontSize:"12px"},children:n.phone},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:140,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:138,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:130,columnNumber:9},void 0)},{title:"Entreprise",dataIndex:"company",key:"company",render:n=>n?e.jsxDEV(s,{children:[e.jsxDEV(Z,{style:{color:"#8c8c8c"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:152,columnNumber:11},void 0),e.jsxDEV(Ye,{children:n},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:153,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:151,columnNumber:9},void 0):e.jsxDEV(Ye,{type:"secondary",children:"-"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:155,columnNumber:11},void 0)},{title:"Actions",key:"actions",width:120,render:n=>e.jsxDEV(V,{type:n.id===o?"default":"primary",size:"small",icon:n.id===o?e.jsxDEV(v,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:165,columnNumber:47},void 0):void 0,onClick:()=>{return a(e=n),void H.success(`Lead "${e.name}" sÃ©lectionnÃ©`);var e},disabled:n.id===o,children:n.id===o?"SÃ©lectionnÃ©":"SÃ©lectionner"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:162,columnNumber:9},void 0)}];return e.jsxDEV(J,{title:"SÃ©lectionner un lead",open:n,onCancel:t,width:800,footer:[e.jsxDEV(V,{onClick:t,children:"Annuler"},"cancel",!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:182,columnNumber:9},void 0)],children:e.jsxDEV(s,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsxDEV(Ke,{placeholder:"Rechercher par nom, email, entreprise ou tÃ©lÃ©phone...",allowClear:!0,value:L,onChange:e=>x(e.target.value),style:{marginBottom:16},prefix:e.jsxDEV(X,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:195,columnNumber:19},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:189,columnNumber:9},void 0),T&&e.jsxDEV(Y,{message:"Erreur de chargement",description:T,type:"error",showIcon:!0,closable:!0,onClose:()=>N(null)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:200,columnNumber:11},void 0),e.jsxDEV(D,{spinning:h,children:e.jsxDEV(K,{dataSource:p,columns:g,rowKey:"id",pagination:{pageSize:10,showSizeChanger:!1,showQuickJumper:!0,showTotal:(e,n)=>`${n[0]}-${n[1]} sur ${e} leads`},scroll:{y:400},size:"small",locale:{emptyText:L?"Aucun lead trouvÃ© pour cette recherche":"Aucun lead disponible"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:212,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:211,columnNumber:9},void 0),e.jsxDEV(Ye,{type:"secondary",style:{fontSize:"12px"},children:[p.length," lead(s) affichÃ©(s) sur ",c.length," total"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:232,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:187,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/lead-integration/LeadSelectorModal.tsx",lineNumber:176,columnNumber:5},void 0)},{Content:Ze}=ee,{Title:en,Text:nn}=c,{useBreakpoint:rn}=L,tn=({treeId:t})=>{const{leadId:c}=a(),{api:d}=i(),m=rn(),u=!m.lg,p=!m.xl&&m.lg,f=r.useMemo(()=>u?"p-3":p?"p-4":"p-6",[u,p]),h=r.useMemo(()=>[u?16:p?20:24,u?16:32],[u,p]),b=r.useMemo(()=>"mb-6 pb-4 border-b border-gray-200 flex "+(u?"flex-col gap-4 items-start":"items-center justify-between"),[u]),v=u?"vertical":"horizontal",N=u?"start":"center",L=u?"w-full":void 0,C=u,[B,E]=r.useState({id:"",name:"",email:"",phone:"",address:""}),[g,S]=r.useState(c),[A,R]=r.useState(!1),[_,k]=r.useState(!1),[O,I]=r.useState(!1),[M,j]=r.useState([]),[U,F]=r.useState(""),[$,z]=r.useState(!1),[W,G]=r.useState(""),[K]=x.useForm(),[Z,le]=r.useState(null),[ce,me]=r.useState(!1),[pe,fe]=r.useState(null),he=r.useRef(null),Te=r.useRef(null),Ne=r.useRef(null);r.useEffect(()=>{if(g&&d){(async()=>{var e;try{const n=await d.get(`/api/leads/${g}`),r=n.success?n.data:n;if(r&&r.id){const n={id:r.id,name:`${r.firstName||""} ${r.lastName||""}`.trim()||r.company||"Lead sans nom",email:r.email||"",phone:r.phone||"",address:(null==(e=r.data)?void 0:e.address)||""};E(n),ye(e=>({...e,__leadId:r.id}))}}catch(n){H.error("Erreur lors du chargement des donnÃ©es du lead")}})()}},[g,d]);const De=r.useCallback(()=>{R(!0)},[]),Le=r.useCallback(()=>{k(!0)},[]),xe=r.useCallback(e=>{window.location.href=`/tbl/${e.id}`,R(!1)},[]),Ce=r.useCallback(async()=>{},[]);r.useEffect(()=>{{const e=()=>{const e=window.TBL_FORM_DATA||{};return{data:e,mirrorKeys:Object.keys(e).filter(e=>e.startsWith("__mirror_data_"))}};window.runTBLDiagnostic=e,"1"===localStorage.getItem("TBL_AUTO_DIAG")&&setTimeout(e,1e3)}},[]);const[Be,Ee]=r.useState(""),[ge,ye]=r.useState({}),[we]=r.useState(!0),[Se,Ae]=r.useState(!1);r.useEffect(()=>{{const e=setTimeout(()=>{const e=Object.keys(ge),n=e.filter(e=>e.startsWith("__mirror_"));if(e.filter(e=>!e.startsWith("__mirror_")),n.length>0){const e=n.filter(e=>e.startsWith("__mirror_data_")),r=n.filter(e=>e.startsWith("__mirror_formula_")),t=n.filter(e=>e.startsWith("__mirror_condition_"));e.filter(e=>null!=ge[e]&&""!==ge[e]&&0!==ge[e]).map(e=>`${e}=${ge[e]}`),r.filter(e=>null!=ge[e]&&""!==ge[e]&&0!==ge[e]).map(e=>`${e}=${ge[e]}`),t.filter(e=>null!=ge[e]&&""!==ge[e]&&!1!==ge[e]).map(e=>`${e}=${ge[e]}`)}const r=document.querySelectorAll('[data-testid*="smart-calculated-field"]');r.length>0&&(r.forEach(e=>{const n=e.textContent||"";n.includes("Calcul...")||n.includes("(mirror)")||n.trim()}),r.length)},2e3);return()=>clearTimeout(e)}},[ge]);const{config:Re,loading:_e,error:ke}=function(){const{api:e}=i(),[n,t]=r.useState(null),[a,s]=r.useState(!0),[o,l]=r.useState(null),c=r.useCallback(async()=>{try{s(!0),l(null);const[n,r,a]=await Promise.all([e.get("/api/tbl/variables"),e.get("/api/tbl/fields"),e.get("/api/tbl/calculation-modes")]),i=n.data,o=r.data,c=a.data,d=Array.isArray(null==i?void 0:i.variables)?i.variables:Array.isArray(i)?i:[],m=Array.isArray(null==o?void 0:o.fields)?o.fields:Array.isArray(o)?o:[],u=Array.isArray(null==c?void 0:c.modes)?c.modes:Array.isArray(c)?c:[],p=d.map(e=>({id:e.id,name:e.exposedKey||e.id,type:(e.displayFormat||"").startsWith("number")?"number":"text",defaultValue:void 0,description:e.displayName||void 0})),f=m.map(e=>({id:e.id,type:e.type&&["text","number","select","checkbox","date"].includes(e.type)?e.type:"text",label:e.label||e.id,required:Boolean(e.required),defaultValue:null===e.defaultValue?void 0:e.defaultValue})),h=u.map(e=>({id:e.id,code:e.code||e.id,label:e.label||e.code||e.id,capacity:e.capacity||"1",fields:Array.isArray(e.fields)?e.fields.map(n=>({id:n.id,code:n.code||n.id,label:n.label||n.code||n.id,type:n.type||"text",capacity:n.capacity||e.capacity||"1",sourceRef:n.sourceRef??null})):[]}));t({variables:p,fields:f,calculationModes:h,meta:{fetchedAt:(new Date).toISOString(),source:"api"}})}catch(n){l(n instanceof Error?n.message:"Erreur lors du chargement de la configuration")}finally{s(!1)}},[e]);return r.useEffect(()=>{c()},[c]),{config:n,loading:a,error:o,refetch:c}}(),Oe=r.useMemo(()=>{try{return"1"===localStorage.getItem("USE_FIXED_HIERARCHY")}catch{return!1}},[]),Ie=Fe({tree_id:t||"cmf1mwoz10005gooked1j6orn",disabled:Oe}),Me=function(e){const{api:n}=i(),{tree_id:t,disabled:a}=e,[s,o]=r.useState([]),[l,c]=r.useState(!1),[d,m]=r.useState(null),u=r.useRef([]);r.useEffect(()=>{u.current=s},[s]);const p=ze({treeId:t?String(t):void 0,enabled:!a&&!!t,extractDependencies:!0,includeRaw:!1}),f=r.useCallback(async()=>{if(t&&!a){c(!0),m(null);try{se("[TBL] Fetch nodes for tree",t);const e=await n.get(`/api/treebranchleaf/trees/${t}/nodes`);let r=[];if(Array.isArray(e))r=e;else if(e&&"object"==typeof e){const n=e;r=n.data||n.nodes||[]}r[0],o(r)}catch(e){m(e.message)}finally{c(!1)}}},[n,t,a]);r.useEffect(()=>{a||f()},[f,a]),r.useEffect(()=>{const e=e=>{const n=e,{treeId:r}=n.detail;!a&&r&&String(r)===String(t)&&f()};return window.addEventListener("tbl-capability-updated",e),()=>window.removeEventListener("tbl-capability-updated",e)},[f,a,t]),r.useEffect(()=>{const e=e=>{const n=e,{treeId:r}=n.detail;!a&&r&&String(r)===String(t)&&f()};return window.addEventListener("tbl-repeater-updated",e),()=>window.removeEventListener("tbl-repeater-updated",e)},[f,a,t]),r.useEffect(()=>{const e=()=>{a||t&&0!==u.current.length&&f()};return window.addEventListener("TBL_FORM_DATA_CHANGED",e),()=>{window.removeEventListener("TBL_FORM_DATA_CHANGED",e)}},[a,t,f]);const h=r.useCallback(e=>{if(!e.length)return{tree:null,tabs:[],fieldsByTab:{},sectionsByTab:{}};const n=new Map;e.forEach(e=>n.set(e.id,e));const r=new Map;e.forEach(e=>{const n=e.parentId;r.has(n)||r.set(n,[]),r.get(n).push(e)}),r.forEach(e=>e.sort((e,n)=>(e.order||0)-(n.order||0)));const t=(r.get(null)||[]).filter(e=>"branch"===e.type),a=[],i={},s={},o=p.byNodeId,l=e=>{const t=r.get(e.id)||[],a=[],i=[];return t.forEach(e=>{"branch"===e.type?a.push(l(e)):e.type.startsWith("leaf_")&&i.push(Ge(e,n,o.get(e.id)))}),{id:e.id,name:e.label,title:e.label,description:e.description,icon:We(e),fields:i.sort((e,n)=>e.order-n.order),order:e.order||0,parentId:e.parentId||void 0,subsections:a.sort((e,n)=>(e.order||0)-(n.order||0))}};t.forEach(e=>{const t=r.get(e.id)||[],c=[],d=[];t.forEach(e=>{"branch"===e.type?c.push(l(e)):e.type.startsWith("leaf_")&&d.push(Ge(e,n,o.get(e.id)))});const m={id:e.id,name:e.label,label:e.label,order:e.order||0,sections:c.sort((e,n)=>(e.order||0)-(n.order||0))};a.push(m),i[m.id]=[...d].sort((e,n)=>e.order-n.order),s[m.id]=m.sections});const c={id:e[0].treeId,name:"Arbre TreeBranchLeaf",tabs:a.sort((e,n)=>e.order-n.order)};return{tree:c,tabs:c.tabs,fieldsByTab:i,sectionsByTab:s}},[p.byNodeId]),{tree:b,tabs:v,fieldsByTab:T,sectionsByTab:N}=r.useMemo(()=>h(s),[s,h]),D=r.useCallback(async(e,r)=>{try{await n.post(`/api/treebranchleaf/nodes/${e}/value`,{value:r}),await f()}catch(t){}},[n,f]),L=r.useCallback(async e=>{try{await n.put(`/api/treebranchleaf/${e}/visibility`,{}),await f()}catch(r){}},[n,f]),x=r.useCallback(async(e,r)=>{try{await n.post(`/api/treebranchleaf/${e}/options`,{option:r}),await f()}catch(t){}},[n,f]),C=r.useCallback(async(e,r)=>{try{await n.delete(`/api/treebranchleaf/${e}/options/${encodeURIComponent(r)}`),await f()}catch(t){}},[n,f]);return r.useEffect(()=>{const e=()=>{a||t&&0!==u.current.length&&f()};return window.addEventListener("TBL_FORM_DATA_CHANGED",e),()=>{window.removeEventListener("TBL_FORM_DATA_CHANGED",e)}},[a,t,f]),{tree:b,tabs:v,fieldsByTab:T,sectionsByTab:N,loading:l,error:d,refetch:r.useCallback(()=>f(),[f]),updateNodeValue:D,toggleNodeVisibility:L,addOption:x,deleteOption:C,rawNodes:s}}({tree_id:t||"cmf1mwoz10005gooked1j6orn",disabled:!Oe}),je=ze({treeId:t||"cmf1mwoz10005gooked1j6orn",enabled:Oe&&(()=>{try{return"1"===localStorage.getItem("TBL_DIAG")}catch{return!1}})(),extractDependencies:!0,includeRaw:!1}),Ue=Oe?Me.tree:Ie.tree,$e=Oe?Me.tabs:Ie.tabs,qe=Oe?Me.loading:Ie.loading,Pe=Oe?Me.error:Ie.error,He=Oe?Me.rawNodes||[]:Ie.rawNodes||[],{validationState:Je,actions:Ye}=function({tabs:e,fieldValues:n}){const[t,a]=r.useState({isValidating:!1,completedTabs:new Set,incompleteTabs:new Set,requiredFieldsStatus:{}}),i=r.useMemo(()=>{const n={};return e.forEach(e=>{var r;const t=[];null==(r=e.fields)||r.forEach(e=>{var n;e.required&&t.push(e),null==(n=e.options)||n.forEach(e=>{var n;null==(n=e.conditionalFields)||n.forEach(e=>{e.required&&t.push(e)})})}),n[e.id]=t}),n},[e]),s=r.useMemo(()=>{const e=new Set,r=new Set;return Object.entries(i).forEach(([t,a])=>{a.every(e=>{const r=n[e.id];return null!=r&&""!==r})?e.add(t):r.add(t)}),{completed:e,incomplete:r}},[i,n]),o=r.useCallback(()=>{const e={};Object.values(i).flat().forEach(r=>{const t=n[r.id];e[r.id]=null!=t&&""!==t}),a(n=>({...n,completedTabs:s.completed,incompleteTabs:s.incomplete,requiredFieldsStatus:e}))},[i,n,s]),l={startValidation:r.useCallback(()=>{o(),a(e=>({...e,isValidating:!0}))},[o]),stopValidation:r.useCallback(()=>{a(e=>({...e,isValidating:!1}))},[]),updateFieldValue:r.useCallback((e,n)=>{const r=null!=n&&""!==n;a(n=>({...n,requiredFieldsStatus:{...n.requiredFieldsStatus,[e]:r}})),setTimeout(o,0)},[o]),isTabComplete:r.useCallback(e=>t.completedTabs.has(e),[t.completedTabs]),isTabIncomplete:r.useCallback(e=>t.incompleteTabs.has(e),[t.incompleteTabs]),isFieldRequired:r.useCallback(e=>Object.values(i).flat().some(n=>n.id===e&&n.required),[i]),shouldShowRequiredError:r.useCallback(e=>{const n=Object.values(i).flat().some(n=>n.id===e&&n.required);return t.isValidating&&n&&!t.requiredFieldsStatus[e]},[t.isValidating,t.requiredFieldsStatus,i])};return r.useState(()=>{o()}),r.useEffect(()=>{o()},[n,o]),{validationState:t,actions:l,requiredFieldsByTab:i}}({tabs:$e||[],fieldValues:ge}),{isValidation:Ke,startValidation:tn,stopValidation:sn}=ve();r.useEffect(()=>{if(oe()&&Ie.tabs.length&&Me.tabs.length)try{const e=Ie.tabs.map(e=>({id:e.id,sections:e.sections.length,fields:e.sections.reduce((e,n)=>e+n.fields.length,0)})),n=Me.tabs.map(e=>({id:e.id,sections:e.sections.length,fields:e.sections.reduce((e,n)=>e+n.fields.length,0)}));se("[TBL MIGRATION] Diff tabs count old vs new",{old:e.length,new:n.length}),se("[TBL MIGRATION] Details old",e),se("[TBL MIGRATION] Details new",n);const r=new Set;Ie.tabs.forEach(e=>e.sections.forEach(e=>e.fields.forEach(e=>r.add(e.id))));const t=new Set;Me.tabs.forEach(e=>e.sections.forEach(e=>e.fields.forEach(e=>t.add(e.id))));const a=[...r].filter(e=>!t.has(e)),i=[...t].filter(e=>!r.has(e));a.length&&se("[TBL MIGRATION] Champs manquants dans nouveau hook",a.slice(0,50)),i.length&&se("[TBL MIGRATION] Nouveaux champs uniquement dans nouveau hook",i.slice(0,50))}catch(e){se("[TBL MIGRATION] Diff error",e)}},[Ie.tabs,Me.tabs]);const{saving:on,saveAsDevis:ln}=(()=>{const{api:e}=i(),n=r.useCallback(async(n,r,t)=>{var a;try{const i=await e.post("/api/tbl/submissions/create-and-evaluate",{treeId:r,clientId:t,formData:n,status:"draft",providedName:`Devis automatique ${(new Date).toLocaleDateString()}`});return{success:!0,submissionId:null==(a=i.submission)?void 0:a.id,message:"Sauvegarde automatique rÃ©ussie avec TBL Prisma pur",evaluatedCapacities:i.evaluatedCapacities}}catch(i){return{success:!1,error:i instanceof Error?i.message:"Erreur inconnue"}}},[e]);return{lastSave:null,saveAsDevis:r.useCallback(async(n,r,t)=>{var a,i,s;try{const o=await e.post("/api/tbl/submissions/create-and-evaluate",{treeId:r,clientId:t.clientId,formData:n,status:t.isDraft?"draft":"completed",providedName:t.projectName||`Devis ${(new Date).toLocaleDateString()}`}),l=await e.post(`/api/tbl/submissions/${null==(a=o.submission)?void 0:a.id}/evaluate-all`,{forceUpdate:!0,includeIntelligentTranslations:!0}),c=await e.get(`/api/tbl/submissions/${null==(i=o.submission)?void 0:i.id}/verification`);return{success:!0,devisId:null==(s=o.submission)?void 0:s.id,message:"Devis sauvegardÃ© avec succÃ¨s avec TBL Prisma",evaluation:l,verification:c}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Erreur lors de la sauvegarde"}}},[e]),autoSave:n}})(),{isSuperAdmin:cn}=n();r.useEffect(()=>{if("undefined"!=typeof window&&window.TBL_FORM_DATA&&Object.keys(window.TBL_FORM_DATA).length>0){const e=window.TBL_FORM_DATA,n=Object.keys(e).filter(e=>e.startsWith("__mirror_data_"));n.length>0&&ye(r=>{const t={...r};return n.forEach(n=>{n in t||(t[n]=e[n])}),Object.keys(e).forEach(n=>{n.startsWith("__mirror_data_")||n in t||(t[n]=e[n])}),t})}},[Ie.tabs,Me.tabs]),r.useEffect(()=>{$e.length>0&&!Be&&Ee($e[0].id)},[$e,Be]);const dn=r.useMemo(()=>{let e=0,n=0,r=0;const t=a=>{a.forEach(a=>{e+=a.fields.length,n+=a.fields.filter(e=>e.required).length,r+=a.fields.filter(e=>{if(!e.required)return!1;const n=ge[e.id];return null!=n&&""!==n}).length,a.subsections&&t(a.subsections)})};return $e.forEach(e=>{t(e.sections)}),{totalTabs:$e.length,totalFields:e,requiredFields:n,completedRequired:r,completion:n?r/n*100:100}},[$e,ge]),mn=r.useCallback(e=>{const n={};return Object.keys(e||{}).forEach(r=>{if(r.startsWith("__mirror_"))return;const t=e[r];n[r]=null==t?null:String(t)}),n},[]),un=r.useCallback(e=>{const n=Object.keys(e).sort(),r=[];for(const t of n){const n=e[t];r.push(`${t}:${null===n?"null":String(n)}`)}return r.join("|")},[]),pn=r.useCallback(async e=>{try{if(!d||!Ue)return;const n=mn(e);await d.post("/api/tbl/submissions/preview-evaluate",{treeId:Ue.id,formData:n})}catch(n){oe()}},[d,Ue,mn]),fn=r.useCallback(async e=>{if(d&&Ue)try{me(!0);const n=mn(e),r=un(n);if((Te.current===r||Ne.current===r)&&oe())return;Ne.current=r,Z?(await d.post("/api/tbl/submissions/create-and-evaluate",{submissionId:Z,formData:n,status:"draft"}),Te.current=r,fe(new Date)):await pn(e)}catch(n){}finally{Ne.current=null,me(!1)}},[d,Ue,mn,un,Z,pn]),hn=r.useCallback(e=>{he.current&&window.clearTimeout(he.current),he.current=window.setTimeout(()=>{fn(e)},800)},[fn]);r.useEffect(()=>{if(!we||!Ue||0===Object.keys(ge).length)return;const e=setInterval(()=>{hn(ge)},3e4);return()=>clearInterval(e)},[ge,we,Ue,hn]),r.useEffect(()=>{if("undefined"!=typeof window)return window.TBL_FORCE_REFRESH=()=>{Oe&&Me.refetch?Me.refetch():!Oe&&Ie.refetch&&Ie.refetch()},window.TBL_VERIFY_CONDITIONALS=()=>{try{const e=Array.from(document.querySelectorAll(".conditional-field-injected")).map(e=>({parentFieldId:e.dataset.parentFieldId||"unknown",parentOption:e.dataset.parentOptionValue||"",fieldId:e.dataset.fieldId||"",label:e.dataset.fieldLabel||""})),n={};for(const t of e){const e=`${t.parentFieldId}::${t.parentOption}`;n[e]||(n[e]={option:t.parentOption,fields:[]}),n[e].fields.push({fieldId:t.fieldId,label:t.label})}const r=new Set(e.map(e=>e.parentFieldId));Object.entries(n).forEach(([e,n])=>{const[r]=e.split("::");n.fields.forEach(e=>{})});try{H.success(`VÃ©rification: ${e.length} champs conditionnels, ${r.size} parents distincts.`)}catch{}return{count:e.length,parents:Array.from(r),details:n}}catch(e){try{H.error("VÃ©rification Ã©chouÃ©e (voir console)")}catch{}return null}},()=>{window.TBL_FORCE_REFRESH&&delete window.TBL_FORCE_REFRESH;try{window.TBL_VERIFY_CONDITIONALS&&delete window.TBL_VERIFY_CONDITIONALS}catch{}}},[Oe,Me,Ie]);const bn=r.useCallback((e,n)=>{let r=null==Re?void 0:Re.fields.find(n=>n.id===e);if(!r)if(e.startsWith("__mirror_data_")){const n={id:e,code:e,label:e.replace("__mirror_data_",""),type:"text"};r=n}else{const n=(()=>{var n,r;for(const t of $e)for(const a of t.sections){const t=a.fields.find(n=>n.id===e);if(t)return{id:t.id,code:t.id,label:t.label||t.name||t.id,type:(t.type||"text").toLowerCase(),unit:null==(n=t.config)?void 0:n.unit,options:null==(r=t.options)?void 0:r.map(e=>({label:e.label,value:e.value}))}}return null})();if(n&&Re)Re.fields.push(n),r=n;else if(!n){r={id:e,code:e,label:e,type:"text"},localStorage.getItem("TBL_DIAG")}}let t=!0,a="";if(null!=n)switch(r.type){case"number":{const e=Number(n);r.validation&&("number"==typeof r.validation.min&&e<r.validation.min&&(t=!1,a=`La valeur doit Ãªtre supÃ©rieure Ã  ${r.validation.min}`),"number"==typeof r.validation.max&&e>r.validation.max&&(t=!1,a=`La valeur doit Ãªtre infÃ©rieure Ã  ${r.validation.max}`));break}case"text":{const e=String(n);if(r.validation&&(r.validation.minLength&&e.length<r.validation.minLength&&(t=!1,a=`Le texte doit faire au moins ${r.validation.minLength} caractÃ¨res`),r.validation.maxLength&&e.length>r.validation.maxLength&&(t=!1,a=`Le texte ne doit pas dÃ©passer ${r.validation.maxLength} caractÃ¨res`),r.validation.pattern)){new RegExp(r.validation.pattern).test(e)||(t=!1,a="Le format est invalide")}break}case"select":r.options&&!r.options.find(e=>e.value===n)&&(t=!1,a="Valeur non valide pour cette liste")}else r.required&&(t=!1,a="Ce champ est requis");t?ye(t=>{const a={...t,[e]:n};try{let r=null;for(const n of $e){for(const t of n.sections){const n=t.fields.find(n=>n.id===e);if(n){r=n;break}}if(r)break}if(null==r?void 0:r.sharedReferenceId){const e=r.sharedReferenceId;a[e]=n}if(e.startsWith("shared-ref-"))for(const t of $e)for(const r of t.sections){r.fields.filter(n=>n.sharedReferenceId===e).forEach(e=>{a[e.id]=n})}}catch(i){}try{if("undefined"!=typeof window){window.TBL_FORM_DATA=a;const r=new CustomEvent("TBL_FORM_DATA_CHANGED",{detail:{fieldId:e,value:n}});window.dispatchEvent(r)}}catch{}try{const t=(null==r?void 0:r.label)||e;if(localStorage.getItem("TBL_DIAG"),"string"==typeof t&&/ - Champ$/i.test(t)){const e=t.replace(/ - Champ$/i,""),r=`__mirror_data_${e}`;a[r]=n;try{Ve(e).map(e=>e.replace(/^__mirror_data_/,"")).forEach(e=>{const r=`__mirror_data_${e}`;r in a||(a[r]=n)})}catch(s){}}else if(e.startsWith("__mirror_data_"))try{Ve(t).map(e=>e.replace(/^__mirror_data_/,"")).forEach(e=>{const r=`__mirror_data_${e}`;r in a||(a[r]=n)})}catch(s){}}catch{}try{hn(a)}catch{}return a}):H.error(a)},[Re,$e,hn]),vn=r.useCallback(async()=>{const e=t||"cmf1mwoz10005gooked1j6orn",n=g,r=B.id||n;try{const n=`/api/treebranchleaf/submissions/by-leads?treeId=${e}`,t=await d.get(n);let a=t;r&&(a=t.filter(e=>e.id===r)),a&&0!==a.length?j(a):(H.info(`Aucun devis trouvÃ© pour ${B.name||"ce lead"}`),j([])),I(!0)}catch(a){H.error("Erreur lors du chargement des devis"),j([]),I(!0)}},[t,d,B,g]),Tn=async(e,n)=>{try{if(!d)return e;const r=await d.get(`/api/treebranchleaf/submissions?leadId=${n}`),t=(r.data||[]).map(e=>{var n;return(null==(n=e.summary)?void 0:n.name)||e.name||""}).filter(e=>""!==e.trim());if(!t.includes(e))return e;let a=1,i=`${e} (${a})`;for(;t.includes(i)&&a<1e3;)a++,i=`${e} (${a})`;return i}catch(r){return e}},Nn=async()=>{try{const e=B.name||"Client",n=`Devis ${(new Date).toLocaleDateString("fr-FR")} - ${e}`,r=await Tn(n,g||"");G(r),K.setFieldsValue({devisName:r}),z(!0)}catch(e){const n=B.name||"Client",r=`Devis ${(new Date).toLocaleDateString("fr-FR")} - ${n}`;G(r),K.setFieldsValue({devisName:r}),z(!0)}},Dn=async(e,n)=>{try{if(!(await new Promise(e=>{J.confirm({title:"Supprimer le devis",content:`ÃŠtes-vous sÃ»r de vouloir supprimer le devis "${n}" ?`,okText:"Supprimer",okType:"danger",cancelText:"Annuler",onOk:()=>e(!0),onCancel:()=>e(!1)})})))return;await d.delete(`/api/treebranchleaf/submissions/${e}`),g&&await loadExistingSubmissions(),H.success(`Devis "${n}" supprimÃ© avec succÃ¨s`)}catch(r){H.error("Erreur lors de la suppression du devis")}},Ln=e=>{var n,r;const t=(e.type||"").toString().toLowerCase();if("number"===t){const t=(null==(n=e.config)?void 0:n.min)??0,a=(null==(r=e.config)?void 0:r.max)??100,i=Math.round((t+a)/2);return Number.isFinite(i)?i:1}if("boolean"===t)return!0;if("select"===t||e.isSelect||Array.isArray(e.options)){return(e.options&&e.options.length>0?e.options[0].value:void 0)??""}return"date"===t?(new Date).toISOString().slice(0,10):e.placeholder||"Valeur de test"},xn=async e=>{try{if(!$e||0===$e.length)return void H.warning("Aucun onglet TBL Ã  remplir");const r={};$e.forEach(e=>{(e=>{const n=[],r=e=>{e.forEach(e=>{Array.isArray(e.fields)&&n.push(...e.fields),Array.isArray(e.subsections)&&e.subsections.length&&r(e.subsections)})};return r(e),n})(e.sections||[]).forEach(e=>{const n=Ln(e);bn(e.id,n),r[e.id]=n;if((e.isSelect||"select"===(e.type||"").toString().toLowerCase()||Array.isArray(e.options))&&Array.isArray(e.options)&&e.options.length>0){const n=e.options[0];Array.isArray(n.conditionalFields)&&n.conditionalFields.forEach(e=>{const n=Ln(e);bn(e.id,n),r[e.id]=n})}})});const a=Object.keys(r).length;if(!e)return void H.success(`Champs remplis (${a}). Vous pouvez maintenant crÃ©er/charger un devis.`);const i=(null==Ue?void 0:Ue.id)||t||"";if(!i)return void H.warning("Impossible dâ€™enregistrer: ID arbre manquant");const s=B.name||"Client",o=`Devis Auto - ${(new Date).toLocaleDateString("fr-FR")} - ${s}`,l=await Tn(o,g||"");try{await d.post("/api/tbl/submissions/create-and-evaluate",{treeId:i,clientId:g,formData:r,status:"completed",providedName:l}),H.success(`Champs remplis (${a}) et devis enregistrÃ© via TBL Prisma: ${l}`)}catch(n){H.error("Remplissage OK, mais Ã©chec de lâ€™enregistrement automatique")}}catch(n){H.error("Erreur lors du remplissage automatique")}},Cn=r.useCallback(async(e,n)=>{var r;try{if(H.loading("Chargement du devis...",.5),n){const e={id:n.id,name:`${n.firstName||""} ${n.lastName||""}`.trim()||"Lead sans nom",email:n.email||"",phone:"",address:""};E(e),S(n.id)}const t=await d.get(`/api/treebranchleaf/submissions/${e}`);if(t&&t.TreeBranchLeafSubmissionData){const n={};t.TreeBranchLeafSubmissionData.forEach((e,r)=>{void 0!==e.value&&null!==e.value&&""!==e.value&&(n[e.nodeId]=e.value)}),ye(n),le(e);try{const e=mn(n),r=un(e);Te.current=r}catch{}const a=(null==(r=t.summary)?void 0:r.name)||t.name||`Devis ${e.slice(0,8)}`;H.success(`Devis "${a}" chargÃ© avec succÃ¨s (${Object.keys(n).length} champs)`)}else H.warning("Devis trouvÃ© mais aucune donnÃ©e de formulaire");I(!1)}catch(t){H.error("Erreur lors du chargement du devis. VÃ©rifiez la console pour plus de dÃ©tails.")}},[d,mn,un]);return qe||_e?e.jsxDEV("div",{className:"flex justify-center items-center h-96",children:e.jsxDEV(D,{size:"large",children:e.jsxDEV("div",{className:"p-4",children:"Chargement des donnÃ©es TreeBranchLeaf..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1507,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1506,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1505,columnNumber:7},void 0):ke?e.jsxDEV(Y,{message:"Erreur de configuration",description:ke,type:"error",showIcon:!0,action:e.jsxDEV(V,{size:"small",onClick:()=>window.location.reload(),children:"RÃ©essayer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1521,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1515,columnNumber:7},void 0):Pe?e.jsxDEV(Y,{message:"Erreur de chargement",description:Pe,type:"error",showIcon:!0,action:e.jsxDEV(V,{size:"small",onClick:()=>window.location.reload(),children:"RÃ©essayer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1537,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1531,columnNumber:7},void 0):Re?Ue&&0!==$e.length?e.jsxDEV(be,{children:e.jsxDEV(ee,{className:"h-full bg-gray-50 "+(Ke?"tbl-validation-mode":""),children:[e.jsxDEV(Ze,{className:f,children:e.jsxDEV(q,{gutter:h,className:"h-full",children:[e.jsxDEV(P,{xs:24,lg:8,xl:6,className:u?"mb-4":void 0,children:e.jsxDEV(ue,{clientData:B,projectStats:{completion:Math.round(dn.completion),totalTabs:dn.totalTabs,totalFields:dn.totalFields,requiredFields:dn.requiredFields,completedRequired:dn.completedRequired,treeName:Ue.name,lastSave:null==pe?void 0:pe.toLocaleString()}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1579,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1578,columnNumber:11},void 0),e.jsxDEV(P,{xs:24,lg:16,xl:18,children:e.jsxDEV(o,{className:"h-full shadow-sm",bodyStyle:{padding:u?16:p?20:24},children:[Oe&&(()=>{try{return"1"===localStorage.getItem("TBL_DIAG")}catch{return!1}})()&&e.jsxDEV("div",{className:"mb-4",children:[(()=>{try{"undefined"!=typeof window&&(window.TBL_DEP_GRAPH=je.dependencyGraph)}catch{}})(),e.jsxDEV(Xe,{preload:je},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1601,columnNumber:19},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1598,columnNumber:17},void 0),e.jsxDEV("div",{className:b,children:[e.jsxDEV("div",{children:[e.jsxDEV(en,{level:3,className:"mb-1 flex items-center gap-3",children:[e.jsxDEV("span",{children:["TreeBranchLeaf - ",g?B.name:Ue.name]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1608,columnNumber:21},void 0),g&&e.jsxDEV("span",{className:"text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 border border-blue-300",children:["Lead #",g]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1610,columnNumber:23},void 0),!Z&&e.jsxDEV("span",{className:"text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800 border border-yellow-300",children:"Non sauvegardÃ©"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1613,columnNumber:23},void 0),Oe&&e.jsxDEV("span",{className:"text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700 border border-emerald-300",children:"HiÃ©rarchie FIXE (Beta)"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1616,columnNumber:23},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1607,columnNumber:19},void 0),e.jsxDEV(nn,{type:"secondary",children:["Completion: ",Math.round(dn.completion),"% (",dn.completedRequired,"/",dn.requiredFields," requis)"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1619,columnNumber:19},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1606,columnNumber:17},void 0),e.jsxDEV(s,{direction:v,size:u?"middle":"small",className:L,wrap:!u,align:N,children:[e.jsxDEV(V,{icon:e.jsxDEV(l,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1633,columnNumber:27},void 0),onClick:De,block:C,children:"Charger Lead"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1632,columnNumber:19},void 0),e.jsxDEV(V,{icon:e.jsxDEV(w,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1640,columnNumber:27},void 0),onClick:Le,block:C,children:"Nouveau Lead"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1639,columnNumber:19},void 0),e.jsxDEV(V,{icon:e.jsxDEV(ne,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1647,columnNumber:27},void 0),onClick:vn,block:C,children:"Charger Devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1646,columnNumber:19},void 0),e.jsxDEV(V,{icon:e.jsxDEV(re,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1654,columnNumber:27},void 0),onClick:Nn,type:"primary",block:C,children:"Nouveau Devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1653,columnNumber:19},void 0),e.jsxDEV(V,{icon:e.jsxDEV(te,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1662,columnNumber:27},void 0),onClick:()=>{tn(),H.info("GÃ©nÃ©ration PDF - Validation en cours..."),setTimeout(()=>{sn(),H.success("Validation terminÃ©e")},3e3)},block:C,children:"PDF"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1661,columnNumber:19},void 0),cn&&e.jsxDEV(e.Fragment,{children:[e.jsxDEV(V,{onClick:()=>{xn(!1)},block:C,children:"Remplir tout (admin)"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1670,columnNumber:23},void 0),e.jsxDEV(V,{type:"primary",onClick:()=>{xn(!0)},block:C,children:"Remplir + Enregistrer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1671,columnNumber:23},void 0),e.jsxDEV(V,{onClick:()=>{var e;try{null==(e=window.TBL_VERIFY_CONDITIONALS)||e.call(window)}catch{}},block:C,children:"VÃ©rifier injections"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1672,columnNumber:23},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1669,columnNumber:21},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1625,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1605,columnNumber:15},void 0),e.jsxDEV("div",{className:"mb-6",children:e.jsxDEV(T,{percent:Math.round(dn.completion),status:100===dn.completion?"success":"active",strokeColor:{"0%":"#108ee9","100%":"#52c41a"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1683,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1682,columnNumber:15},void 0),e.jsxDEV(ae,{activeKey:Be,onChange:Ee,type:"card",size:u?"small":"large",className:`tbl-tabs ${(null==$e?void 0:$e.map(e=>{const n=e.sections||[],r=[];if(n.forEach(e=>{(e.fields||[]).forEach(e=>{e.required&&r.push({id:e.id,label:e.label||e.name})})}),0===r.length)return`tab-${e.id}-complete`;return r.every(e=>{const n=ge[e.id];return null!=n&&""!==n})?`tab-${e.id}-complete`:`tab-${e.id}-incomplete`}).join(" "))||""}`,tabBarGutter:u?12:24,items:$e?$e.map(n=>{const r=n.sections||[],t=[];r.forEach(e=>{(e.fields||[]).forEach(e=>{e.required&&t.push({id:e.id,label:e.label||e.name})})});let a=!1,i=!1;if(0===t.length)a=!0;else{const e=t.every(e=>{const n=ge[e.id];return null!=n&&""!==n});a=e,i=Je.isValidating&&!e}i||a&&t.length;const s=i&&!a?{backgroundColor:"#fee2e2",borderColor:"#dc2626",color:"#991b1b"}:a?{backgroundColor:"#0f766e",borderColor:"#0f766e",color:"#ffffff"}:{};return{key:n.id,label:e.jsxDEV("div",{className:"flex items-center gap-2",style:{...s,padding:"8px 12px",borderRadius:"6px",transition:"all 0.3s ease"},children:[e.jsxDEV(Q,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1818,columnNumber:23},void 0),e.jsxDEV("span",{children:n.label},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1819,columnNumber:23},void 0),(()=>{let n="text-xs px-2 py-1 rounded-full";n+=Je.isValidating&&!a&&t.length>0?" bg-red-100 text-red-600":a?" bg-green-100 text-green-700":" bg-gray-100 text-gray-600";const i=[];r.forEach(e=>{(e.fields||[]).forEach(e=>{i.push({id:e.id})})});const s=i.filter(e=>{const n=ge[e.id];return null!=n&&""!==n});return e.jsxDEV("span",{className:n,children:[s.length,"/",i.length]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1851,columnNumber:27},void 0)})()]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1809,columnNumber:21},void 0),children:e.jsxDEV("div",{className:u?"p-0":"p-4",children:e.jsxDEV(an,{sections:n.sections||[],fields:n.fields||[],formData:ge,onChange:bn,treeId:null==Ue?void 0:Ue.id,tree:Ue,rawNodes:He,disabled:on,validationState:Je,validationActions:Ye},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1862,columnNumber:23},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1861,columnNumber:21},void 0)}}):[]},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1694,columnNumber:15},void 0),we&&pe&&e.jsxDEV("div",{className:"mt-4 text-center",children:e.jsxDEV(nn,{type:"secondary",className:"text-xs",children:[e.jsxDEV(ie,{className:"mr-1"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1884,columnNumber:21},void 0),"DerniÃ¨re sauvegarde automatique: ",pe.toLocaleTimeString(),ce?" (en cours...)":""]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1883,columnNumber:19},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1882,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1595,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1594,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1576,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1575,columnNumber:9},void 0),e.jsxDEV(J,{title:"Sauvegarder comme devis",open:Se,onCancel:()=>Ae(!1),footer:null,children:e.jsxDEV(x,{layout:"vertical",onFinish:async e=>{try{(()=>{try{return JSON.stringify(ge).length}catch{return"n/a"}})();const n=await ln(ge,Ue.id,{clientId:"temp-client-id",projectName:e.projectName,notes:e.notes,isDraft:!1});n.success?(H.success("Devis sauvegardÃ© avec succÃ¨s !"),Ae(!1)):H.error(n.error||"Erreur de sauvegarde")}catch{H.error("Erreur lors de la sauvegarde")}},initialValues:{projectName:`Projet ${Ue.name} - ${(new Date).toLocaleDateString()}`},children:[e.jsxDEV(x.Item,{label:"Nom du projet",name:"projectName",rules:[{required:!0,message:"Nom du projet requis"}],children:e.jsxDEV(y,{placeholder:"Nom du projet..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1913,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1908,columnNumber:11},void 0),e.jsxDEV(x.Item,{label:"Notes",name:"notes",children:e.jsxDEV(y.TextArea,{rows:3,placeholder:"Notes optionnelles..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1920,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1916,columnNumber:11},void 0),e.jsxDEV(x.Item,{className:"mb-0 text-right",children:e.jsxDEV(s,{children:[e.jsxDEV(V,{onClick:()=>Ae(!1),children:"Annuler"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1928,columnNumber:15},void 0),e.jsxDEV(V,{onClick:()=>{Ye.startValidation()},style:{background:"#f0f0f0"},children:"ðŸ§ª Tester Validation"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1931,columnNumber:15},void 0),e.jsxDEV(V,{type:"primary",htmlType:"submit",loading:on,children:"Sauvegarder"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1945,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1927,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1926,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1901,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1895,columnNumber:7},void 0),e.jsxDEV(Qe,{open:A,onClose:()=>{R(!1)},onSelectLead:xe},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1958,columnNumber:7},void 0),e.jsxDEV(de,{open:_,onClose:()=>{k(!1)},onCreateLead:Ce,onLeadCreated:e=>{k(!1),window.location.href=`/tbl/${e.id}`}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1968,columnNumber:7},void 0),e.jsxDEV(J,{title:"Charger un devis",open:O,onCancel:()=>I(!1),footer:[e.jsxDEV(V,{onClick:()=>I(!1),children:"Annuler"},"cancel",!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1989,columnNumber:11},void 0)],width:u?360:p?640:800,children:e.jsxDEV("div",{className:"space-y-4",children:[e.jsxDEV("div",{className:u?"flex flex-col gap-2":"flex items-center space-x-2",children:[e.jsxDEV(y,{placeholder:"Rechercher dans les devis...",prefix:e.jsxDEV(X,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2e3,columnNumber:23},void 0),value:U,onChange:e=>F(e.target.value),className:u?"w-full":"flex-1"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1998,columnNumber:13},void 0),e.jsxDEV(V,{type:"primary",icon:e.jsxDEV(X,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2007,columnNumber:21},void 0),block:u,children:e.jsxDEV("span",{className:"hidden sm:inline",children:"Rechercher"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2010,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2005,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1997,columnNumber:11},void 0),0===M.length?e.jsxDEV("div",{className:"text-center py-8 text-gray-500",children:[e.jsxDEV(Q,{style:{fontSize:"48px",marginBottom:"16px"}},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2016,columnNumber:15},void 0),e.jsxDEV("p",{children:["Aucun devis trouvÃ© pour ",B.name||"ce lead"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2017,columnNumber:15},void 0),e.jsxDEV(V,{type:"primary",className:"mt-4",icon:e.jsxDEV(Q,{},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2021,columnNumber:23},void 0),onClick:()=>{I(!1),Nn()},children:"CrÃ©er un nouveau devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2018,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2015,columnNumber:13},void 0):e.jsxDEV("div",{children:[!u&&e.jsxDEV("div",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxDEV("div",{className:"grid grid-cols-4 gap-4 px-4 py-3 text-sm font-medium text-gray-600",style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr auto"},children:[e.jsxDEV("div",{children:"Nom"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2035,columnNumber:21},void 0),e.jsxDEV("div",{children:"Contact"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2036,columnNumber:21},void 0),e.jsxDEV("div",{children:"Entreprise"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2037,columnNumber:21},void 0),e.jsxDEV("div",{children:"Actions"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2038,columnNumber:21},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2034,columnNumber:19},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2033,columnNumber:17},void 0),e.jsxDEV("div",{className:u?"space-y-3":"max-h-80 overflow-y-auto",children:(e=>{const n={};return e.forEach(e=>{const r=e.name||"Devis sans nom";n[r]||(n[r]=[]),n[r].push(e)}),e.map(e=>{const r=e.name||"Devis sans nom",t=n[r];if(t.length>1){const n=t.findIndex(n=>n.id===e.id);return{...e,displayName:`${r} (${n+1})`}}return{...e,displayName:r}})})(M.flatMap(e=>{var n;return(null==(n=e.submissions)?void 0:n.map(n=>({...n,leadInfo:{id:e.id,firstName:e.firstName,lastName:e.lastName,email:e.email,company:e.company||"Non renseignÃ©"}})))||[]})).filter(e=>{var n,r,t;if(!U)return!0;const a=U.toLowerCase();return(null==(n=e.displayName)?void 0:n.toLowerCase().includes(a))||(null==(r=e.name)?void 0:r.toLowerCase().includes(a))||(null==(t=e.treeName)?void 0:t.toLowerCase().includes(a))}).map(n=>u?e.jsxDEV(o,{size:"small",className:"shadow-sm border border-gray-100",children:e.jsxDEV(s,{direction:"vertical",size:8,className:"w-full",children:[e.jsxDEV("div",{className:"flex items-center justify-between",children:[e.jsxDEV("div",{className:"flex items-center gap-2",children:[e.jsxDEV("span",{className:"text-blue-500",children:"ðŸ“„"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2084,columnNumber:33},void 0),e.jsxDEV("span",{className:"font-medium text-gray-900",children:n.displayName},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2085,columnNumber:33},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2083,columnNumber:31},void 0),e.jsxDEV("div",{className:"flex items-center gap-2",children:[e.jsxDEV(V,{type:"primary",size:"small",onClick:()=>Cn(n.id,n.leadInfo),className:"bg-blue-600 hover:bg-blue-700",children:"Ouvrir"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2088,columnNumber:33},void 0),e.jsxDEV(V,{type:"text",size:"small",danger:!0,onClick:()=>Dn(n.id,n.displayName),className:"hover:bg-red-50",title:"Supprimer ce devis",children:"ðŸ—‘ï¸"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2096,columnNumber:33},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2087,columnNumber:31},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2082,columnNumber:29},void 0),e.jsxDEV("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsxDEV("div",{className:"flex items-center gap-1",children:[e.jsxDEV("span",{children:"âœ‰ï¸"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2110,columnNumber:33},void 0),e.jsxDEV("span",{children:n.leadInfo.email},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2111,columnNumber:33},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2109,columnNumber:31},void 0),e.jsxDEV("div",{className:"flex items-center gap-1",children:[e.jsxDEV("span",{children:"ðŸ“ž"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2114,columnNumber:33},void 0),e.jsxDEV("span",{children:"+32 477 12 34 56"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2115,columnNumber:33},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2113,columnNumber:31},void 0),e.jsxDEV("div",{className:"flex items-center gap-1",children:[e.jsxDEV("span",{children:"ðŸ¢"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2118,columnNumber:33},void 0),e.jsxDEV("span",{children:n.leadInfo.company},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2119,columnNumber:33},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2117,columnNumber:31},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2108,columnNumber:29},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2081,columnNumber:27},void 0)},n.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2076,columnNumber:25},void 0):e.jsxDEV("div",{className:"grid grid-cols-4 gap-4 px-4 py-3 hover:bg-gray-50 border-b border-gray-100 transition-colors items-center",style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr auto"},children:[e.jsxDEV("div",{className:"flex items-center space-x-2",children:[e.jsxDEV("span",{className:"text-blue-500",children:"ðŸ“„"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2132,columnNumber:29},void 0),e.jsxDEV("span",{className:"font-medium text-gray-900",children:n.displayName},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2133,columnNumber:29},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2131,columnNumber:27},void 0),e.jsxDEV("div",{className:"space-y-1",children:[e.jsxDEV("div",{className:"flex items-center space-x-1 text-sm text-gray-600",children:[e.jsxDEV("span",{children:"âœ‰ï¸"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2139,columnNumber:29},void 0),e.jsxDEV("span",{children:n.leadInfo.email},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2140,columnNumber:29},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2138,columnNumber:27},void 0),e.jsxDEV("div",{className:"flex items-center space-x-1 text-sm text-gray-600",children:[e.jsxDEV("span",{children:"ðŸ“ž"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2143,columnNumber:29},void 0),e.jsxDEV("span",{children:"+32 477 12 34 56"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2144,columnNumber:29},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2142,columnNumber:27},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2137,columnNumber:25},void 0),e.jsxDEV("div",{className:"flex items-center space-x-1 text-sm text-gray-600",children:[e.jsxDEV("span",{children:"ðŸ¢"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2150,columnNumber:27},void 0),e.jsxDEV("span",{children:n.leadInfo.company},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2151,columnNumber:27},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2149,columnNumber:25},void 0),e.jsxDEV("div",{className:"flex items-center justify-center space-x-2",children:[e.jsxDEV(V,{type:"primary",size:"small",onClick:()=>Cn(n.id,n.leadInfo),className:"bg-blue-600 hover:bg-blue-700",children:"SÃ©lectionner"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2156,columnNumber:27},void 0),e.jsxDEV(V,{type:"text",size:"small",danger:!0,onClick:()=>Dn(n.id,n.displayName),className:"hover:bg-red-50",title:"Supprimer ce devis",children:"ðŸ—‘ï¸"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2164,columnNumber:27},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2155,columnNumber:25},void 0)]},n.id,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2125,columnNumber:25},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2044,columnNumber:15},void 0),!u&&e.jsxDEV("div",{className:"flex justify-between items-center mt-4 px-4 py-2 text-sm text-gray-600",children:[e.jsxDEV("div",{children:(()=>{const e=M.flatMap(e=>e.submissions||[]).length;return`${M.flatMap(e=>{var n;return(null==(n=e.submissions)?void 0:n.map(n=>({...n,leadInfo:{firstName:e.firstName,lastName:e.lastName,email:e.email,company:e.company}})))||[]}).filter(e=>{var n,r;if(!U)return!0;const t=U.toLowerCase();return(null==(n=e.name)?void 0:n.toLowerCase().includes(t))||(null==(r=e.treeName)?void 0:r.toLowerCase().includes(t))}).length} sur ${e} devis`})()},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2184,columnNumber:19},void 0),e.jsxDEV("div",{className:"flex items-center space-x-2",children:[e.jsxDEV("span",{children:["1-",Math.min(M.flatMap(e=>e.submissions||[]).length,10)," sur ",M.flatMap(e=>e.submissions||[]).length," devis"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2205,columnNumber:21},void 0),e.jsxDEV(V,{size:"small",disabled:!0,children:"1"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2206,columnNumber:21},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2204,columnNumber:19},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2183,columnNumber:17},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2031,columnNumber:13},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1995,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1984,columnNumber:7},void 0),e.jsxDEV(J,{title:"CrÃ©er un nouveau devis",open:$,onCancel:()=>{z(!1),G(""),K.resetFields()},footer:null,width:u?360:p?440:500,children:e.jsxDEV(x,{form:K,layout:"vertical",onFinish:async()=>{var e,n,r;try{const o=t||"cmf1mwoz10005gooked1j6orn",l=((()=>{try{return JSON.stringify(ge).length}catch{return"n/a"}})(),(await K.validateFields()).devisName||W),c=await Tn(l,g||""),m={treeId:o,name:c,data:ge};let u;g&&(m.leadId=g);try{const e=Array.isArray(m.data)?m.data.reduce((e,n)=>(n.nodeId&&null!=n.value&&(e[n.nodeId]=n.value),e),{}):m.data||{};u=(await d.post("/api/tbl/submissions/create-and-evaluate",{treeId:m.treeId,clientId:m.leadId,formData:e,status:"completed",providedName:m.name})).submission}catch(a){const t=a,s=(null==(e=null==t?void 0:t.response)?void 0:e.status)??(null==t?void 0:t.status);null==(n=null==t?void 0:t.response)||n.statusText,(null==(r=null==t?void 0:t.response)?void 0:r.data)??(null==t||t.message);if(404!==s)throw t;try{const e=await d.get("/api/treebranchleaf/trees");if(!(Array.isArray(e)&&e.length>0))return void H.error("Aucun arbre accessible n'a Ã©tÃ© trouvÃ© pour crÃ©er le devis.");{const n=e[0].id,r=Array.isArray(m.data)?m.data.reduce((e,n)=>(n.nodeId&&null!=n.value&&(e[n.nodeId]=n.value),e),{}):m.data||{};u=(await d.post("/api/tbl/submissions/create-and-evaluate",{treeId:n,clientId:m.leadId,formData:r,status:"completed",providedName:m.name})).submission,H.info(`Arbre par dÃ©faut indisponible, repli sur: ${e[0].name||n}`)}}catch(i){throw i}}H.success(`Nouveau devis "${c}" crÃ©Ã© avec succÃ¨s`);try{const e=u;e&&"object"==typeof e&&e.id&&le(e.id)}catch{}try{const e=mn(ge),n=un(e);Te.current=n}catch{}try{const e=u,n=e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id?e.id:void 0;g&&n&&(await d.post(`/api/leads/${g}/documents`,{id:n,name:c,type:"devis",url:null,meta:{treeId:o}}),await d.post(`/api/leads/${g}/history`,{type:"devis",content:`Devis crÃ©Ã©: ${c}`,author:void 0}))}catch(s){}z(!1),G(""),K.resetFields()}catch(o){try{}catch{}if(o&&"object"==typeof o){const e=o;"errorFields"in e?H.error("Veuillez remplir tous les champs requis"):"response"in e?H.error("Erreur lors de la crÃ©ation du devis. VÃ©rifiez la console pour plus de dÃ©tails."):H.error("Erreur inattendue lors de la crÃ©ation du devis")}else H.error("Erreur lors de la crÃ©ation du devis. VÃ©rifiez la console pour plus de dÃ©tails.")}},children:[e.jsxDEV("div",{className:"mb-4",children:e.jsxDEV("p",{className:"text-gray-600",children:["Lead sÃ©lectionnÃ© : ",e.jsxDEV("strong",{children:B.name},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2234,columnNumber:34},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2233,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2232,columnNumber:11},void 0),e.jsxDEV(x.Item,{label:"Nom du devis",name:"devisName",rules:[{required:!0,message:"Le nom du devis est requis"}],children:e.jsxDEV(y,{placeholder:"Entrez le nom du devis..."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2243,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2238,columnNumber:11},void 0),e.jsxDEV(x.Item,{className:"mb-0 text-right",children:e.jsxDEV(s,{children:[e.jsxDEV(V,{onClick:()=>{z(!1),G(""),K.resetFields()},children:"Annuler"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2250,columnNumber:15},void 0),e.jsxDEV(V,{type:"primary",htmlType:"submit",onClick:()=>{},children:"CrÃ©er le devis"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2257,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2249,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2248,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2227,columnNumber:9},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2216,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1574,columnNumber:7},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1573,columnNumber:5},void 0):e.jsxDEV(Y,{message:"Aucune donnÃ©e disponible",description:"Aucun arbre TreeBranchLeaf configurÃ© ou aucun onglet disponible.",type:"warning",showIcon:!0},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1563,columnNumber:7},void 0):e.jsxDEV(Y,{message:"Configuration manquante",description:"La configuration TreeBranchLeaf n'a pas pu Ãªtre chargÃ©e.",type:"error",showIcon:!0,action:e.jsxDEV(V,{size:"small",onClick:()=>window.location.reload(),children:"RÃ©essayer"},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1553,columnNumber:11},void 0)},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:1547,columnNumber:7},void 0)},an=({sections:n,fields:t,formData:a,onChange:i,treeId:s,tree:o,rawNodes:l=[],validationState:c,validationActions:d,disabled:m=!1})=>{const u=r.useMemo(()=>{let e=0,r=0,i=0;const s=n=>{n.forEach(n=>{n.fields.forEach(n=>{if(e+=1,n.required){r+=1;const e=a[n.id];null!=e&&""!==e&&(i+=1)}}),n.subsections&&n.subsections.length&&s(n.subsections)})};return s(n),!n.length&&t.length&&t.forEach(n=>{if(e+=1,n.required){r+=1;const e=a[n.id];null!=e&&""!==e&&(i+=1)}}),{total:e,required:r,completed:i}},[n,t,a]);return e.jsxDEV("div",{children:[(()=>{if(n.length)return e.jsxDEV("div",{className:"space-y-6",children:n.map(r=>e.jsxDEV(ke,{section:r,formData:a,onChange:(e,n)=>i(e,n),treeId:s,allNodes:l,allSections:n,disabled:m},r.id,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2333,columnNumber:13},void 0))},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2331,columnNumber:9},void 0);if(t.length){const r={id:"__synthetic__",title:"Champs",name:"Champs",fields:t,subsections:[]};return e.jsxDEV(ke,{section:r,formData:a,onChange:(e,n)=>i(e,n),treeId:s,allNodes:l,allSections:n,disabled:m},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2356,columnNumber:9},void 0)}return e.jsxDEV("div",{className:"text-sm text-gray-400",children:"Aucun champ."},void 0,!1,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2367,columnNumber:12},void 0)})(),e.jsxDEV("div",{className:"mt-6 text-xs text-gray-400 text-right",children:[u.completed,"/",u.required," requis complÃ©tÃ©s"]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2373,columnNumber:7},void 0)]},void 0,!0,{fileName:"C:/Users/dethi/OneDrive/Desktop/CRM SAVE/crm/src/components/TreeBranchLeaf/treebranchleaf-new/TBL/TBL.tsx",lineNumber:2371,columnNumber:5},void 0)};export{tn as default};
