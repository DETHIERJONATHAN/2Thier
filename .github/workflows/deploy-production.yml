name: Deploy CRM

on:
  push:
    branches: [ sauvegarde-deploy-final ]
  workflow_dispatch:

permissions:
  contents: read

env:
  PROJECT_ID: thiernew
  REGION: europe-west1
  SERVICE_NAME: crm-api

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - uses: google-github-actions/setup-gcloud@v2
      
      - name: Build and Deploy
        run: |
          gcloud builds submit --tag europe-west1-docker.pkg.dev/thiernew/crm/crm-api:$(git rev-parse --short HEAD)
          gcloud run deploy crm-api --image europe-west1-docker.pkg.dev/thiernew/crm/crm-api:$(git rev-parse --short HEAD) --region europe-west1 --platform managed
