name: Scheduled Redeploy after DB Sync

on:
  schedule:
    # Tous les jours √† 2h30 UTC (apr√®s la sync DB locale √† 2h00)
    - cron: '30 2 * * *'
  workflow_dispatch: # Permet de lancer manuellement

env:
  PROJECT_ID: thiernew
  GAR_LOCATION: europe-west1
  API_SERVICE: crm-api

jobs:
  redeploy:
    name: Redeploy Cloud Run after DB Sync
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/864558991714/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-deployer@thiernew.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Restart Cloud Run service
        run: |
          echo "üîÑ Red√©marrage du service Cloud Run apr√®s synchronisation DB..."
          
          # R√©cup√©rer la derni√®re image d√©ploy√©e
          LATEST_IMAGE=$(gcloud run services describe ${{ env.API_SERVICE }} \
            --region=${{ env.GAR_LOCATION }} \
            --format='value(spec.template.spec.containers[0].image)')
          
          echo "üì¶ Image actuelle: $LATEST_IMAGE"
          
          # Forcer un nouveau d√©ploiement (red√©marre les instances)
          gcloud run services update ${{ env.API_SERVICE }} \
            --region=${{ env.GAR_LOCATION }} \
            --image=$LATEST_IMAGE \
            --no-traffic
          
          # Remettre le trafic
          gcloud run services update-traffic ${{ env.API_SERVICE }} \
            --region=${{ env.GAR_LOCATION }} \
            --to-latest
          
          echo "‚úÖ Service red√©marr√© avec succ√®s!"

      - name: Verify service health
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.API_SERVICE }} \
            --region=${{ env.GAR_LOCATION }} \
            --format='value(status.url)')
          
          echo "üåê URL du service: $SERVICE_URL"
          
          # V√©rifier que le service r√©pond
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/api/health" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Service en bonne sant√© (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è Service status: HTTP $HTTP_STATUS (peut √™tre normal si pas de /api/health)"
          fi
